//Version-19.5.4-19.5.7
import { BaseService } from '../../services/base.service';
import { Util, XmlDocument, Timer, PactFile } from '../../shared/models/Util';
import { Dictionary, DictionaryNumKey } from './../../../util/dictionary';
import { parseBoolean } from 'angular-slickgrid';
import { ViewModelBase } from '../../shared/models/PageBase';
import { VoucherGenerator } from './VoucherGenerator';
import { PactButtonData } from '../../shared/models/controls/PactButtonData';
import { PactTextBoxData, PactTextAreaData, PactGPSData } from '../../shared/models/controls/PactTextBoxData';
import { PactDatePickerData, PactExtraFieldDateData, PactDateTimeData, PactVoucherDateData } from '../../shared/models/controls/PactDatePickerData';
import { PactComboBoxData, CheckedListBoxData, ComboBoxItems, CheckedListBoxItem } from '../../shared/models/controls/PactComboBoxData';
import { PactCheckBoxData } from '../../shared/models/controls/PactCheckBoxData';
import { PactListBoxData, PactHistoryData } from '../../shared/models/controls/PactListBoxData';
import { PactControlData, Delegate, PrinterList } from '../../shared/models/controls/PactControlData';
import { PactCodeNameListBoxData } from '../../shared/models/controls/PactCodeNameListBoxData';
import { PactCurrencyData, PactComboTextData } from '../../shared/models/controls/PactComboTextData';
import { DgColumn } from '../../shared/models/controls/DgColumn';
import { PactSelectionBoxData } from '../../shared/models/controls/PactSelectionBoxData';
import { MimizField } from '../../services/formula.service';
import { AddressViewModel } from '../address-view/AddressViewModel';
import { DataGridPactListBoxColumn } from '../../shared/models/customEditors/DataGridPactListBoxColumn';

import { PactTabData } from '../../shared/models/controls/PactTabControlData';
import { ViewAttachmentViewModel } from '../../shared/models/master-tabs/ViewAttachmentViewModel';
import { QuickViewScreenViewModel } from '../../shared/controls/quick-view/QuickViewScreenViewModel';
import { AddNoteViewModel } from '../../shared/models/master-tabs/AddNoteViewModel';
import { ViewNoteViewModel } from '../../shared/models/master-tabs/ViewNoteViewModel';
import { AddAttachmentViewModel } from '../../shared/models/master-tabs/AddAttachmentViewModel';
import { DocumentAttachmentsComponent } from '../document-attachments/document-attachments.component';
import { DocumentNumberViewModel } from '../document-number/DocumentNumberViewModel';
import { DocumentNumberComponent } from '../document-number/document-number.component';
import { BillWiseViewModel } from '../bill-wise/BillWiseViewModel';
import { BillWiseComponent } from '../bill-wise/bill-wise.component';
import { IPage, PageService } from '../../services/page.service';
import { AddEditDocumentComponent } from './add-edit-document.component';
import { ShowJVViewModel } from '../show-jv/ShowJVViewModel';
import { ShowJVComponent } from '../show-jv/show-jv.component';
import { LinkedVouchersComponent } from '../doc-link/linked-vouchers/linked-vouchers.component';
import { LinkedVouchersViewModel, LinkInfoTab } from '../doc-link/linked-vouchers/LinkedVouchersViewModel';
import { LinkSelectiveComponent } from '../doc-link/link/LinkSelective.component';
import { LinkDocument } from '../doc-link/link/LinkDocument';
import { ReviseReasonComponent } from '../revise-reason/revise-reason.component';
import { ReviseReasonViewModel } from '../revise-reason/ReviseReasonViewModel';
import { GoToLineViewModel } from '../doc-link/go-to-line/GoToLineViewModel';
import { GoToLineComponent } from '../doc-link/go-to-line/go-to-line.component';
import { DocumentDraftsViewModel } from '../document-drafts/DocumentDraftsViewModel';
import { DocumentDraftsComponent } from '../document-drafts/document-drafts.component';
import { ChequeReturnComponent } from '../cheque-return/cheque-return.component';
import { ChequeReturnViewModel } from '../cheque-return/ChequeReturnViewModel';
import { HistoryDialogViewModel } from '../../shared/controls/master-tabs/history-dialog/HistoryDialogViewModel';
import { HistoryDialogComponent } from '../../shared/controls/master-tabs/history-dialog/history-dialog.component';
import { PactGridViewModel } from '../../shared/models/controls/PactGridViewModel';
import { FieldCalculatorViewModel } from '../field-calculator/FieldCalculatorViewModel';
import { FieldCalculatorComponent } from '../field-calculator/field-calculator.component';
import { ViewNotesComponent } from '../../shared/controls/master-tabs/notes/view-notes.component';
import { TemplateRef, ViewChild } from '@angular/core';
import { DocumentNotesComponent } from '../document-notes/document-notes.component';
import { pdcGenerateChequeViewModel } from '../pdcgenerate-cheque/pdcGenerateChequeViewModel';
import { PDCGenerateChequeComponent } from '../pdcgenerate-cheque/pdcgenerate-cheque.component';
import { SubsituteProductsViewModel } from '../subsitute-products/SubsituteProductsViewModel';
import { SubsituteProductsComponent } from '../subsitute-products/subsitute-products.component';
import { LinkProductWiseComponent } from '../link-product-wise/link-product-wise.component';
import { LinkProdWiseViewModel } from '../link-product-wise/LinkProdWiseViewModel';
import { SerialNumberViewModel } from '../serial-number/SerialNumberViewModel';
import { SerialNumberComponent } from '../serial-number/serial-number.component';
import { ProductAttachmentsComponent } from '../product-attachments/product-attachments.component';
import { ProductAttachmentViewModel } from '../product-attachments/ProductAttachmentViewModel';
import { PaymentTermsViewModel } from '../payment-terms/PaymentTermsViewModel';
import { PaymentTermsComponent } from '../payment-terms/payment-terms.component';
import { WFLevelDoc } from '../wflevel-view/WFLevelDoc';
import { DocBinsViewModel } from '../doc-bins/DocBinsViewModel';
import { DocBinsComponent } from '../doc-bins/doc-bins.component';
import { BatchNumberViewModel } from '../batch-number/BatchNumberViewModel';
import { BatchNumberComponent } from '../batch-number/batch-number.component';
import { BounceDocViewModel } from '../bounce-document/BounceDocViewModel';
import { BounceDocumentComponent } from '../bounce-document/bounce-document.component';
import { DocHistoryComponent } from '../doc-history/doc-history.component';
import { DynamicSetComponent } from '../dynamic-set/dynamic-set.component';
import { DynamicSetViewModel } from '../dynamic-set/DynamicSetViewModel';
import { PostVoucherSaveComponent } from '../post-voucher-save/post-voucher-save.component';
import { PostVoucherSaveViewModel } from '../post-voucher-save/PostVoucherSaveViewModel';
import { RecurViewModel } from '../recur/RecurViewModel';
import { RecurComponent } from '../recur/recur.component';
import { UpdateFieldsViewModel } from '../update-field/UpdateFieldsViewModel';
import { UpdateFieldComponent } from '../update-field/update-field.component';
import { ApproveComponent } from '../approve/approve.component';
import { VoucherExportExcel } from '../../reports/vpt/VoucherExportExcel';
import { VPTDialogViewModel } from '../../reports/vptdialog/VPTDialogViewModel';
import { VPTDialogComponent } from '../../reports/vptdialog/vptdialog.component';
import { CopyDocumentComponent } from '../copy-document/copy-document.component';
import { CopyDocumentViewModel } from '../copy-document/CopyDocumentViewModel';
import { ViewActivitiesViewModel } from '../../shared/controls/master-tabs/activity/ViewActivitiesViewModel';
import { ActivitiesViewModel } from '../../shared/controls/master-tabs/activity/ActivitiesViewModel';
import { ActivitiesComponent } from '../../shared/controls/master-tabs/activity/activities.component';
import { ProductSearchCatalogViewModel, PactListSearchViewModel } from '../product-search-catalog/ProductSearchCatalogViewModel';
import { ProductSearchCatalogComponent } from '../product-search-catalog/product-search-catalog.component';
import { HoldComponent } from '../hold/hold.component';
import { BudgetCheck } from '../budget/BudgetCheck';
import { DepreciationSchedule } from '../../assetmanagement/models/DepreciationSchedule';
import { SendEmailSMSViewModel } from '../../reports/send-email-sms/SendEmailSMSViewModel';
import { SendEmailSMSComponent } from '../../reports/send-email-sms/send-email-sms.component';
import { PayDayCheck } from '../ess/PayDayCheck';
import { TimeSpan } from '../../../main';
import { HoldQtyViewModel } from '../hold-qty/HoldQtyViewModel';
import { HoldQtyComponent } from '../hold-qty/hold-qty.component';
import { PactListBoxComponent } from '../../shared/controls/Fields/PactListBox.component';
import { AddDenominationComponent } from '../add-denomination/add-denomination.component';
import { AddDenominationViewModel } from '../add-denomination/AddDenominationViewModel';
import { EvaluatePayrollFormulas, CPFields } from '../../ess/Models/PayrollOtherClasses';
import { EnquiriesComponent } from '../enquiries/enquiries.component';
import { EnquiriesViewModel } from '../enquiries/EnquiriesViewModel';
import { SearchDocumentComponent } from '../search-document/search-document.component';
import { SearchDocumentViewModel } from '../search-document/SearchDocumentViewModel';
import { PreviousTextDialog } from '../previous-text-dialog/PreviousTextDialog';
import { PreviousTextDialogComponent } from '../previous-text-dialog/previous-text-dialog.component';
import { PactListSearchComponent } from '../pact-list-search/pact-list-search.component';
import { DocumentFlowChartComponent } from '../document-flow-chart/document-flow-chart.component';
import { DocumentFlowChartViewModel } from '../document-flow-chart/DocumentFlowChartViewModel';
import { IPrefetchFilter } from '../../reports/report-view/IPrefetchFilter';
import { ImportComponent } from '../import/import.component';
import { AssignReportComponent } from '../assign-report/assign-report.component';
import { AssignReportViewModel } from '../assign-report/AssignReportViewModel';
import * as XLSX from 'xlsx';
import { DocumentNumberWIthTreeComponent } from '../document-number-with-tree/document-number-with-tree.component';
import { AddEditAppraisalViewModel } from '../../ess/add-edit-appraisal/AddEditAppraisalViewModel';
import { PactImageComponent } from '../../shared/controls/Fields/PactImage.component';
import { LoginScreenComponent } from '../../pages/login-screen/login-screen.component';
import { LoginViewModel } from '../../pages/login-screen/LoginScreenViewModel';
import { RowDetailsDialogViewModel } from '../../reports/row-details/RowDetailsDialogViewModel';
import { RowDetailsComponent } from '../../reports/row-details/row-details.component';
import { ContinuousPrintingComponent } from '../continuous-printing/continuous-printing.component';
import { ContinuousPrintViewModel } from '../continuous-printing/ContinuousPrintViewModel';
import { GSTPostingComponent } from '../gstposting/gstposting.component';
import { GSTPostingViewModel } from '../gstposting/GSTPostingViewModel';
import { EmpTreeFilterViewModel } from '../../ess/emp-tree-filter/EmpTreeFilterViewModel';
import { EmpTreeFilterComponent } from '../../ess/emp-tree-filter/emp-tree-filter.component';
import { VacationCreditedDaysDetailViewModel } from '../../ess/vacation-credited-days-detail/VacationCreditedDaysDetailViewModel';
import { VacationCreditedDaysDetailComponent } from '../../ess/vacation-credited-days-detail/vacation-credited-days-detail.component';
import { DataGridPactComboBoxColumn } from '../../shared/controls/Editors/DataGridComboBoxColumneditor';
import { POSPayModesComponent } from '../../pos/pospay-modes/pospay-modes.component';
import { POSPayModesViewModel } from '../../pos/pospay-modes/POSPayModesViewModel';
import { RegisterViewModel } from '../../pos/register/RegisterViewModel';
import { RegisterComponent } from '../../pos/register/register.component';
import { TouchScreenViewModel } from '../../pos/touch-screen/TouchScreenViewModel';
import { NumericPADViewModel } from '../../pos/Numeric-pad/NumericPADViewModel';
import { LinkedProductsViewModel } from '../linked-products/LinkedProductsViewModel';
import { LinkedProductsComponent } from '../linked-products/linked-products.component';
import { Geolocation } from '@capacitor/geolocation';
import { CommonDocumentMethod } from './CommonDocumentMethod';
import { ConfirmationDocument } from './ConfirmationDocument';
import { ContractScheduleViewModel } from '../contract-schedule/ContractScheduleViewModel';
import { ContractScheduleComponent } from '../contract-schedule/contract-schedule.component';
import { Browser } from '@capacitor/browser';
import { BatchPayCopyChequeDataViewModel } from '../batch-pay-copy-cheque-data/BatchPayCopyChequeDataViewModel';
import { BatchPayCopyChequeDataComponent } from '../batch-pay-copy-cheque-data/batch-pay-copy-cheque-data.component';
import { ProductRatePickerViewModel } from '../product-rate-picker/ProductRatePickerViewModel';
import { ProductRatePickerComponent } from '../product-rate-picker/product-rate-picker.component';
import { Camera, CameraResultType } from '@capacitor/camera';
import { ImageCaptureComponent } from '../../shared/controls/image-capture/image-capture.component';
import { Utils } from 'ngx-bootstrap/utils/public_api';
import { Subject } from 'rxjs';
import { ShowActivitiesComponent } from '../../shared/controls/master-tabs/activity/Show-Activities.component';
import { Document } from '../add-edit-document/Document';
import { PListViewComponent } from '../../shared/controls/Fields/PListView.component';
import { ViewOrganizationViewModel } from '../../crm/master-tabs/Viewcampaignorganization/ViewOrganizationViewModel';
import { CasesContactViewModel } from '../../crm/cases/CasesContactViewModel';

export class AddEditDocumentViewModel extends ViewModelBase//IAddEditDocumentViewModel, IActivities, INote, IAttachment, IMessageDialogViewModel, IDeleteBoxViewModel, IOrganizaion
{
    PrevDocID: number = 0; // Holding previous DocID  -- COMMON
    AutoPostDocID: number = 0; // Holding AutoPost DocID  -- INVENTORY
    AutoProduceDocID: number = 0; // 
    PosSessionID: number = 0; // Maintaining Pos Session ID  -- POS
    res: string; // storing dialog result yes or no  -- COMMON
    AutoPOstXML: string = null; // storing AutoPost xml -- INVENTORY
    AutoProduceXML: string = null; // storing AutoProduce xml -- INVENTORY
    parent: AddEditDocumentViewModel = null; // this property is used to access parent object  -- COMMON
    parentRptRefresh: any;
    AutoPostViewModel: AddEditDocumentViewModel = null // automatically posting document while posting other document. -- INVENTORY
    AutoProduce: AddEditDocumentViewModel = null; //

    IsAutoPost = false; // property used to check autopostViewmodel -- INVENTORY
    isAutoProduce = false; // property used to check autoProduce -- INVENTORY
    isSaveXml = false; // property used in MRPII -- INVENTORY
    ScheduleID = 0;
    RecurDocumentVoucherNo: string = ""; SchGUID: string = "";
    IsSuspend = false;
    IsUserLock = false;
    DocumentNumber: DocumentNumberViewModel = null; // this property is used for voucher prefix on loading document.  -- COMMON
    sDSCUserName: string = ""; //to display Digital sign Username VPT Dailog.
    bDSExists: boolean = false; // to check Digital sign User exist or not
    oDSImg: any = null; // VPT Image for Digital sign user

    TempPVSaccid = 0; // Post Voucher Save Account ID
    TempPVSamt = 0;  // Post Voucher Save Amount ... Billwise amount save to this property.
    TempPVSIsBillwise = false; // Post Voucher Save ... IsBillwise store.

    IsMessageBox = false; // 
    IsMessageBoxvalue = 0; //

    //#region ProductImage
    ProductImageVisibility = false; // to set property product image visble on selecting product from grid.  -- INVENTORY
    PhotoTextVisibility = false; // to set product description Text visble on selecting product from grid.  -- INVENTORY
    ProductPhoto: string = ""; // product image visble in right tab(General) on selecting product from grid.  -- INVENTORY
    //#endregion

    Unit_keyOnBeginEditValue: string = ""; // No Use

    AssignAddress: AddressViewModel; // to set property AddressViewModel. -- COMMON.

    LineNo: number = 0; // Hold value of selectedGrid row index +1. -- COMMON.

    _BodyVisible: boolean = false;
    get BodyVisible() {
        return this._BodyVisible;

    }
    set BodyVisible(value) {
        if (value == this._BodyVisible)
            return;
        this._BodyVisible = value;

        if (this.ScreenObject != null && this.ScreenObject.GridDataObj != null)
            this.ScreenObject.GridDataObj.BodyVisible = value;

        if (!value && this.ReportDimension != null)
            this.ReportDimension.Visible = false;
    }

    _ReadOnlyBody: boolean = false;
    get ReadOnlyBody() {
        return this._ReadOnlyBody;
    }
    set ReadOnlyBody(value) {
        if (value == this._ReadOnlyBody)
            return;
        this._ReadOnlyBody = value;

        if (this.ScreenObject != null && this.ScreenObject.GridDataObj != null)
            this.ScreenObject.GridDataObj.ReadOnlyBody = value;
    }

    // to show document body visible or not.  -- COMMON.
    TabBtnVisible: boolean = false; // show extra field(Tabs) as popup.   -- COMMON.
    ColumnNo: number = 0; // Hold value of Gridview columns index of (qtycol) + 1,   -- INVENTORY
    ViewActivities: ViewActivitiesViewModel = null; // View activity object   -- COMMON.
    NodeID: number = 0;

    POSPayModes: any = null;// POSPayModesViewModel; // POS pay modes  -- POS
    ProductSearchVisibility = false; // if the POS visible then ProductSearchVisibility set to true
    Activities: ActivitiesViewModel = null; // hold activity object
    DocHistoryVisibility = false; // set Document history tab visble or not.

    HoldProdSearch: string = null; // Hold search value from ProductsearchCatalog and ContractEnquiry ViewModel.
    HoldDocName = new PactTextBoxData(0); // to set Hold Document name in POS and AddEditDocument -- COMMON.
    HoldDocDate: PactDatePickerData = new PactDatePickerData(0); // to set HoldDocDate in POS and AddEditDocument -- COMMON.

    VacCrDaysVisibility = false;// to display vacation credit days tab -- INVENTORY
    MappedDocsVisibility = false;// to display Mapped Documents tab -- INVENTORY
    ReportInfoVisibility = false;// to display Report Info tab -- INVENTORY
    DocLinkVisibility = false;// to display Document link tab -- INVENTORY
    AddressesVisibility = false;// to display Address tab -- COMMON
    AssignVisibility = false;;// to display Assign Popup -- COMMON
    DependencyVisibility = false;// to display Dependency tab -- COMMON

    AssignFields: any = null;// AssignReportViewModel ..// to set property AssignReportViewModel as popup

    DependantText: string; // this property used in Dependencies popup in Project plan, documenttype-45 -- PROJECT
    Dependflds: CheckedListBoxData = new CheckedListBoxData(0);// this property used in Dependencies popup in Project plan, documenttype-45 -- PROJECT
    SalesManDimension: PactListBoxData = null;

    Unit_keyOnBeginEditText: string; // No use.

    payTermXml = ""; // it is used to save payment term xml.
    LCBillsXml = ""; // it is used to save letter of credit xml.
    ChkRtnXml = ""; // it is used to save check return xml, 
    BillWiseXML: string = ""; // it is used to save Billwise xml.
    ArApBills = ""; // account of recievable and account of payable bills.
    APIAddressXML = ""; // 
    QtyXML = ""; // 
    PaytermDimCol = "";
    POSpayXml = ""; // it is used to save POS payment xml.
    IsReplaced: number = 0; // it is used for displaying Document Status.
    Shortcuts: any[] = []; // Document shotcut keys
    ReportsList: PactButtonData[]; // To display report list in report tab
    DocsList: PactButtonData[];  // To display Document list in Documents tab
    t: Timer = new Timer(); // used for stop and start timer. -- COMMON

    Shortcut: Delegate = new Delegate();
    ccid = 0; // CostCenter id -- COMMON
    PrAccID = 0; // product account ID, which is used is ShowQuickView -- COMMON
    dtActionAssigned: any[] = null; // not in use
    DtPack: any[] = null;
    DtPackColumns: string[] = [];
    ReportDimension: PactListBoxData; // List of report display in right tabs.

    //#region Fields
    donotupInv: PactCheckBoxData = null; // Property used for Do not update inventory.

    // costcenterid of document -- COMMON
    DocumentType: number; // shows the type of document -- COMMON
    DtTempSchemes: any[] = null;
    DtTempSchemesColumns: string[] = null;

    ScreenObject: VoucherGenerator = null; // voucherGenerator class object

    get IsPurchase(): boolean {
        return this.ScreenObject.IsPurchase;
    }

    SKU: PactTextBoxData; // Used for Automatically scaning product.
    IsSales = "1";

    Currency: PactCurrencyData = null;
    ChequeBook: PactComboBoxData = null;
    DonotUpdateInventory = true; // it does not update inventory, ex:- if we post quotation document we do not update inveroty, because goods have not been sold out, just we gave the quotaion of product.
    PDCSCleared = false; // used when Line Wise PDC is checked or not checked in document preferences.
    DonotUpdateSchemeQty = true; // it does not update Scheme Qty

    DocHistory: any[]; // it is a DataTable Property used to show Document history and Revise History
    DocHistoryColumns: string[]; // array used for storing Document history column's name.
    HistCols: DgColumn[]; // its is a Doc History GridView column list

    VoucherType: number = 0; // voucherType is used for differntiating the document, whether the document is purchase(1) or sales(-1)
    DtHistory: any[]; // Not in use
    // set SetFocusongrid(value) {
    //     /*Focus Code Here*/
    // }

    _SetFocusongrid: boolean;
    get SetFocusongrid() { // get property of foucus on slickgrid
        return this._SetFocusongrid;
    }
    set SetFocusongrid(value) {// set property of foucus on slickgrid
        if (this._SetFocusongrid)
            this._SetFocusongrid = false;
        else
            this._SetFocusongrid = true;

        this.ScreenObject.GridDataObj.TosetFocus.Call({ LineNo: this.LineNo, ColumnNo: this.ColumnNo });
        //  base.OnPropertyChanged("SetFocusongrid");
    }

    GridNetTotal = 0;
    FooterGridNetTotal = 0;
    CashDrwerPrintID = 0;
    SaveCallBack: Delegate = null;
    /**
        [JsonIgnore]
        DelegateCommand<string> SearchDocument { get; set; }
        [JsonIgnore]
        DelegateCommand<object> SelectionChanged { get; set; }
    
        [JsonIgnore]
        DelegateCommand<object> BOMProductCheckedChanged { get; set; }
        [JsonIgnore] 
        DelegateCommand<object> onRowDelete { get; set; }
        **/
    fldDict: Dictionary<MimizField>; // this is the Dictionary property which is used in formula calculation -- COMMON
    FooterDics: Dictionary<MimizField> = new Dictionary<MimizField>(); // Footer dictionary is used for final calculation of formula.  -- COMMON
    LEDict: Dictionary<MimizField>; // Leave Enchashment dictionary which is used in payroll. -- PAYROLL
    BillWisedt: any[] = []; // Storing BillWise Data
    BillWisedtColumns: any[] = []; // holding Bilwisedt datatable columns.
    Paytermsdt = null
    PaytermsdtColumns = []
    Bal: number = 0;
    get POSBalanceAmount() { // POS Balance Amount. --POS

        if (this.ScreenObject.Preferences.ContainsKey("DecimalsNetAmount") && this.ScreenObject.Preferences["DecimalsNetAmount"] != "") {
            if (BaseService.SessionManager.Preferences.ContainsKey("Commas") && BaseService.SessionManager.Preferences["Commas"] != "Millions") {
                return this.Bal.ToString("N" + this.ScreenObject.Preferences["DecimalsNetAmount"]);
            }
            return this.Bal.ToString("N" + this.ScreenObject.Preferences["DecimalsNetAmount"]);

        }
        if (BaseService.SessionManager.Preferences.ContainsKey("Commas") && BaseService.SessionManager.Preferences["Commas"] != "Millions") {
            return this.Bal.toString();
        }
        return this.Bal.toString();

    }

    private _NetAmountObs: string;
    get NetAmountObs(): string { // shows the calculated total amount of the document, only for web
        return this._NetAmountObs;
    }
    set NetAmountObs(value) { // set the NetAmount value to NetAmountObs wtih Decimal Point.
        let dbl: number = Util.Double(value)
        if (this.ScreenObject.Preferences.ContainsKey("DecimalsNetAmount") && this.ScreenObject.Preferences["DecimalsNetAmount"] != "")
            this._NetAmountObs = dbl.Commas("N" + this.ScreenObject.Preferences["DecimalsNetAmount"])
        else
            this._NetAmountObs = dbl.Commas("N" + this.ScreenObject.Preferences["DecimalsNetAmount"])
        //if (BaseService.SessionManager.Preferences.ContainsKey("Commas") && BaseService.SessionManager.Preferences["Commas"] != "Millions")
    }
    RefreshNetAmount() { // Refreshing net total on every calcuation 
        this.NetAmountObs = this.NetAmount;
    }

    get NetAmount(): string { // shows the calculated total amount of the document.
        //  alert('Net Amount Called')
        let exrate = 1, Net = 0;
        if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])
            && this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "" &&
            this.ScreenObject.Preferences.ContainsKey("NettotaldocumentCurrency") && this.ScreenObject.Preferences["NettotaldocumentCurrency"] != "" &&
            parseBoolean(this.ScreenObject.Preferences["NettotaldocumentCurrency"]) && Util.IsNum(this.Currency.ExchangeRate.Text))
            exrate = parseFloat(this.Currency.ExchangeRate.Text);
        if (exrate != 0)
            Net = (this.GridNetTotal + this.FooterGridNetTotal) / exrate;
        else
            Net = (this.GridNetTotal + this.FooterGridNetTotal);

        if (this.ScreenObject.Preferences.ContainsKey("DecimalsNetAmount") && this.ScreenObject.Preferences["DecimalsNetAmount"] != "") {
            if (BaseService.SessionManager.Preferences.ContainsKey("Commas") && BaseService.SessionManager.Preferences["Commas"] != "Millions") {
                this.NetAmountObs = Net.ToString("N" + this.ScreenObject.Preferences["DecimalsNetAmount"]);
            }
            return Net.ToString("N" + this.ScreenObject.Preferences["DecimalsNetAmount"]);
        }
        if (BaseService.SessionManager.Preferences.ContainsKey("Commas") && BaseService.SessionManager.Preferences["Commas"] != "Millions") {
            this.NetAmountObs = Net.toString();
        }
        this.NetAmountObs = Net.toString();
        return this.NetAmountObs;
    }

    DivisionID: number = 0; // Division dimentin id store here.
    NetAmtVisibility = true; // Net amount can be set to  visible or not in the document.
    set DynFooter(value: boolean) { // it is used to add dynamically rows to footer grid. --INVENTORY
        this.ScreenObject.FooterGridDataObj.CanUserAddRows = value;
    }
    _Ddate: Date = Date.Today();// Date.Today(); // Getting the Document Date.
    get DocumentDate(): Date {
        return this._Ddate;
    }
    set DocumentDate(value) { // setting the Document Date.
        if (Util.isValidDate(value) && Util.isValidDate(this._Ddate)) {
            // if (value.getDate() === this._Ddate.getDate())
            if (value.getDate() === this._Ddate.getDate() && value.iMonth() === this._Ddate.iMonth() && value.getFullYear() === this._Ddate.getFullYear())
                return;
        }
        // value == this._Ddate)
        if (value.getDate() === this._Ddate.getDate() && value.iMonth() === this._Ddate.iMonth() && value.getFullYear() === this._Ddate.getFullYear())
            return;
        this._Ddate = value;
        this.ScreenObject.ovDate.Date = value;
        if (this.ScreenObject.DocDate)
            this.ScreenObject.DocDate.Date = value;
        if (this.ScreenObject.DocID == 0)
            this.CheckDateInDocNumber(false);
        this.ReEvaluate(true);
        if (this.AutoPostViewModel != null)
            this.AutoPostViewModel.DocumentDate = value;
        if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
            this.FillExchangeRates();
        }
        //#region  "LoadLinkedDocuments based on Preference"
        this.LoadLinkedVouchersBasedOnPrefernce();
        //#endregion
    }
    FooterVisible: boolean = false; // to check whether footer grid is visible or not. -- INVENTORY
    QuickInfoVisibility: boolean = false; // to check where Account Quick Info visible or not.
    DQuickInfoVisibility: boolean = false; // to check Document quick info visible or not
    VoucherDefVisibility = false; // No Use.

    SelectedHistoryRow: any = null; // Document histroy gridview selected row set here.
    SelectedRows: any[]; // Body Grid selected row set here.

    _SelectedRow: any;
    get SelectedRow(): any { // Body Grid selected row get here.
        return this.ScreenObject.GridDataObj.SelectedItem;
    }
    set SelectedRow(value) { // Body Grid selected row set here.
        if (value == this.ScreenObject.GridDataObj.SelectedItem)
            return;
        if (!Util.IsEmpty(this.NUmpadBindingPath))
            this.NUmpadBindingPath = "";
        this.ScreenObject.GridDataObj.SelectedItem = value;
        this.SetReportDim();
    }
    get SelectedRowColumns() { // to fetch Body grid selected column 
        return this.ScreenObject.GridDataColumns;
    }
    StatusColor: string = "#736F6F"; // Document status color set here
    private _DocStatus: string = '';
    get DocStatus(): string { // it is used to display Document status ex:- Posted, approve, reject
        return this._DocStatus;
    }
    set DocStatus(value) {// it is used to display Document status ex:- Posted, approve, reject
        if (value == this._DocStatus)
            return;

        this._DocStatus = value;
        this.setStatusColor();
    }

    private _BtnRejVisible: boolean = true;
    get BtnRejVisible(): boolean {
        return this._BtnRejVisible;
    }
    set BtnRejVisible(value) {
        if (value == this._BtnRejVisible)
            return;

        this._BtnRejVisible = value;
    }


    get DocStatusText(): string {// it is used to display Document status ex:- Posted, approve, reject
        return this._DocStatus.length > 0 && (!this._DocStatus.Contains('[') || !this._DocStatus.Contains('(')) ? this._DocStatus.substring(1, this._DocStatus.length - 1) : this._DocStatus;
    }

    DialogResult: boolean = false; // it is used to show dialog.

    set UpdateFooter(value: boolean) { // No Use
        //update logic here
    }

    set HistoryUpdateFooter(value: boolean) { // No Use
        //update logic here
    }

    set RefreshGridFooter(value: boolean) {// No Use
        //update logic here
    }

    set RefreshGrid(value: boolean) // Rereshing Gridview after calculation.
    {
        //update logic here
        this.ScreenObject.GridDataObj.RefreshGrid = true;
        this.ScreenObject.GridDataObj.RefreshGridView();
    }
    GridRowHeight: number = 25; // setting Grid's Row height.
    IgnoreQuickViews: number[] = []; // Array maintaining to ignore quick views costcenterid. 
    QuickInfoView: QuickViewScreenViewModel = null; // Account or product Quick Info display on right side tab.
    DQuickInfoView: QuickViewScreenViewModel = null; // Document Quick Info display on right side tab.
    IsInventoryVoucher: boolean = false; // show document whether is is inventory or not.
    iprodDics: any = null;
    //#endregion

    //#region Security
    ButtonSave: PactButtonData = new PactButtonData(); // this button used to Post document
    ButtonRevise: PactButtonData = new PactButtonData(); // this button used to Revise document
    ButtonBidRevise: PactButtonData = new PactButtonData(); // this button used to Bid Revise 
    ButtonBidReviseDistribute: PactButtonData = new PactButtonData(); // this button used to Bid Revise 

    RevisePrevVal: boolean = false;
    parentBiddingDocID: number = 0;
    parentMRDocID: number = 0;
    IsReverseBidding: boolean = false;
    ReverseBiddingDocDetailsID = 0;
    ReverseBiddingRate = 0;
    ReversRowNo = 0;
    IsBidVisible = false;
    BidType = 0; // 3 Counter bidding, 4 Reverse Bidding
    BiddingType = 0; // 
    BidRankValue = "";
    BidRankSysColName = "";
    BidProductID_Key = 0;
    BidDocSeqNo = 0;
    isBidding = false; // is Bidding going on (or is bidding started)
    BidStartTime = "";
    BidEndTime = "";
    BidEvaluationType = "";
    BiddingStauts = true;
    BidMessage = "";
    BidPreviousRank = "";


    BiddingDefDS: any;

    ButtonDelete: PactButtonData = new PactButtonData(); // this button used to Delete document
    ButtonSuspendDoc: PactButtonData = new PactButtonData(); // this button used to suspend Revise document
    ButtonApprove: PactButtonData = new PactButtonData(); // this button used to Approve document
    ButtonSuspend: PactButtonData = new PactButtonData(); // this button used to suspend document
    ButtonSaveandPrint: PactButtonData = new PactButtonData(); // this button used to Post document
    ButtonSaveandBarcode: PactButtonData = new PactButtonData(); // this button used to Post document
    ButtonBarcode: PactButtonData = new PactButtonData(); // this button used to Post document
    NumPadText: string = ""; // Numeric pad text, 
    ButtonCloseVisibility: boolean = false; // set button close visibility visible or not
    Remarks: PactTextAreaData = new PactTextAreaData(0); // Approval, Reject remark 
    AppRejDate: PactDatePickerData = new PactDatePickerData(0); // Approval Rejected date
    IsLocked: boolean = false; // sets the document is lock or not

    RecurDocsWithApproval: PactComboBoxData = new PactComboBoxData(0); // Reccur Docs with approval, appear while approval-reject popup
    //    #endregion

    //#region Properties

    AddressViewVisibility = false; // Address Popup visbile or not
    NoteVisibility = false; // Note Popup visbile or not
    CaseVisibility = false; // Cases(CRM) Popup visbile or not
    OKCancelVisibility = false;  // OK and Cancel button visibily.
    SelectedCase: any = null; // No Use
    CaseList: any[] = null;// DataTable // ?
    CaseListColumns: any = [];
    _ApproveVisibility = false;
    set ApproveVisibility(value) { // Approve Popup visbile or not
        if (value != this._ApproveVisibility) {
            if (value)
                BaseService.page.ShowDialog(this, ApproveComponent, { ShowCenter: true, HideClose: true, NoWidth: true, Title: BaseService.GetResource("ApproveReject") });
            else
                BaseService.page.HideDialog(this.PopUpGUID)
            this._ApproveVisibility = value;
        }
        this._SuspendVisiblity = false;
    }
    _SuspendVisiblity = false;
    set SuspendVisiblity(value) {// Suspend Popup visbile or not
        if (value != this._SuspendVisiblity) {
            if (value) {
                //BaseService.page.ShowDialog(this, ApproveComponent, { ShowCenter: true, HideClose: true, NoWidth: true, Title: BaseService.GetResource("ApproveReject") });
            } else
                BaseService.page.HideDialog(this.PopUpGUID)
            this._SuspendVisiblity = value;
        }
    }
    ImportbuttonVisible = false; // Import button visible or not
    ImportVisiblity = false;// Import Popup visbile or not
    get DtImport(): any[] { // Import grid datatable.
        return this.DtImportObj.Table;
    }
    set DtImport(value: any[]) {
        this.DtImportObj.Table = value;
    }

    DtImportObj: PactGridViewModel = new PactGridViewModel();  // Import gridview.
    IsImport = false; // Import is true import functionality work else sort functionality works
    IsImportonSno = false;
    ImportUpdateSnoBased = false;
    IsImportNewRefBillwise = false;
    ImportNewRefBillwise = false;
    ImportFillLocalReferences = false;
    ExcelTable: any; // it is a datatable which maintain excel data // 
    ActualFileName: string; // uploaded file name
    ImportFileName: string; // import file name
    RimFileName: string; // Rim file name.
    RightPanelWidth: number = 300; // Right panel width
    TouchVisibility = false; // Touch visible or not (Product selection in right side panel).
    FooterTouchVisible = false; // No Use
    TouchView: TouchScreenViewModel = null;// TouchScreenViewModel // Pos Touch Screen View.
    NumericPADView: any = null;//NumericPADViewModel // Numeric pad view mode.

    get IsPOs(): boolean { // to check whether the document is POS or not
        if (this.ScreenObject != null && (this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 39))
            return true;
        return false;
    }


    get ImportCols() { // maintain Import columns
        return this.DtImportObj.Columns;
    }
    set ImportCols(value) {// maintain Import columns
        this.DtImportObj.Columns = value;
    }
    ImportIsUpdate: boolean = false;
    ImportIsBarcode: boolean = false;
    ImportCopyLinkFields: boolean = false;
    ImportMissingNames: boolean = false;
    ImportCopyProductdata: boolean = false;
    DoNotUpdateExcelSheet: boolean = false;
    ImportChunkSize: string = "5"; // import chunk size.
    SearchVisibility: boolean = false; // Search Popup visible or not.

    AttachVisibility: boolean = false;
    CaptureVisibility: boolean = false;
    SignVisibility: boolean = false;

    _AttachmentVisibility: boolean = false; // document attachment Popup visible or not.
    get AttachmentVisibility() {
        return this._AttachmentVisibility;
    }
    set AttachmentVisibility(value) {
        if (value == this._AttachmentVisibility)
            return;

        this._AttachmentVisibility = value;

        //base.OnPropertyChanged("AttachmentVisibility");
    }
    PosPayVisiblity: boolean = false;
    ContactsVisibility: boolean = false;
    _PopUpFields: any[] = [];
    get PopUpFields() {
        return this._PopUpFields;
    }
    //private ObservableCollection<CheckedListBoxItem> _ReportItems = new ObservableCollection<CheckedListBoxItem>();
    //ObservableCollection<CheckedListBoxItem> ReportItems
    //{
    //    get
    //    {
    //        return _ReportItems;
    //    }
    //}

    PopupVisibility = false;
    /**
    private PactTextBoxData _SearchText = new PactTextBoxData();
    PactTextBoxData SearchText
    {
        get
        {
            return _SearchText;
        }
        set
        {
            if (value == _SearchText)
                return;
            _SearchText = value;

            base.OnPropertyChanged("SearchText");
        }
    }

    private PactComboBoxData _Options;
    PactComboBoxData Options
    {
        get
        {
            return _Options;
        }
        set
        {
            if (value == _Options)
                return;
            _Options = value;

            base.OnPropertyChanged("Options");
        }
    }
    private PactComboBoxData _SearchCols;
    PactComboBoxData SearchCols
    {
        get
        {
            return _SearchCols;
        }
        set
        {
            if (value == _SearchCols)
                return;
            _SearchCols = value;

            base.OnPropertyChanged("SearchCols");
        }
    }

***/
    AppDisplayMessage = '' // used in Budget check.
    ButtonsEnabled = true; // after save button click ... disabling click event.

    ReviseReason: string; // Revise Reason.

    get DocID(): number { // Document ID.
        if (this.ScreenObject != null)
            return this.ScreenObject.DocID;
        else
            return 0;
    }

    Recur: RecurViewModel = null; // Reccur View Model.
    Bounce: BounceDocViewModel = null; // Dounce Document ViewModel.

    get GRIDTABLE(): any[] { // it fetch data from GridView table. used in Report, Posted Document etc
        if (this.ScreenObject != null)
            return this.ScreenObject.GridData;
        else
            return [];
    }

    get ColumnSource(): DgColumn[] { // GridView Columns set here
        return this.ScreenObject.ColumnSource;
    }

    get DoNotPrintUnApprovedDocuments(): boolean { // Do not print un approved documents
        if (this.ScreenObject.Preferences.ContainsKey("DoNotPrintUn-ApprovedDocuments")) {
            return (this.ScreenObject.Preferences["DoNotPrintUn-ApprovedDocuments"].toUpperCase() == "TRUE") ? true : false;
        }
        else {
            return false;
        }
    }

    get DoNotEmailSMSUnApprovedDocuments(): boolean { // Do not Email, SMS un approved documents
        if (this.ScreenObject.Preferences.ContainsKey("DoNotEmailOrSMSUn-ApprovedDocuments")) {
            return (this.ScreenObject.Preferences["DoNotEmailOrSMSUn-ApprovedDocuments"].toUpperCase() == "TRUE") ? true : false;
        }
        else {
            return false;
        }
        // return (this.ScreenObject.Preferences["DoNotEmailOrSMSUn-ApprovedDocuments"].toUpperCase() == "TRUE") ? true : false;
    }

    WFDocLevelList: WFLevelDoc[] = []; // Work Flow document Level List.
    ButtonsLeft: PactButtonData[] = []; // Hold left side button ex:- post, new, delete etc
    ButtonsPopup: PactButtonData[] = []; // hold popup button ex:- print, copy, suspend, export etc.
    DistributeInstallmentsVisible = false; // Distribute Installments
    LoanGuaranteeVisible = false; // while applying loan, to check Loan Guarantees is Mandatory or not

    FailedRecourdList: FailureMessage[] = []; // Export Failed Record List




    ListVisbility: boolean; // Export Fail record list need to visible or not.


    ButtonsPopUp = false; // button popup visible or not
    //#endregion

    //#region Notes
    Note: AddNoteViewModel = null // Add note as a popup
    ViewNotes: ViewNoteViewModel = null; // View Note after adding in document.

    /// <summary>
    /// Add Note Call Back
    /// </summary>
    OnAddNote() { // clicking on adding note.
        //Creating new Note view model
        this.Note = new AddNoteViewModel();
        this.Note.AddNoteViewModel_2(this)
    }
    //#region Attachments
    _Attachment: AddAttachmentViewModel = null; // Document attachment.
    get Attachment() { // Get attachemnt
        return this._Attachment;
    }
    set Attachment(value) { // Set attachament.
        if (value == this._Attachment)
            return;

        this._Attachment = value;

        //base.OnPropertyChanged("Attachment");
    }
    //#endregion

    //private ICasesContactViewModel _CasesContactViewModel;
    CasesContactViewModel: any = null; // 

    grdLinkTab: LinkInfoTab; // Link list will display as a tab in right section.
    ViewAttachments: ViewAttachmentViewModel; // View Attachment.
    OnAddAttachment() { // Add attachment click.
        Logger.InfoLog("AddProductViewModel::Entering AddAttachment");

        //Creating new Attachment view model

        let col = "";
        if (this.Attachment != null)
            col = this.Attachment.ColID;
        let row = null;
        if (this.Attachment != null)
            row = this.Attachment.RowID;
        this.Attachment = new AddAttachmentViewModel();
        this.Attachment.AddAttachmentViewModel_2(this);

        if (col == "") {
            this.Attachment.ColID = "";
            this.Attachment.RowID = null;
        }
        else {
            this.Attachment.ColID = col;
            this.Attachment.RowID = row;
        }

        //     AttachmentVisibility = Visibility.Collapsed;

        Logger.InfoLog("AddProductViewModel::Entering AddAttachment");
    }
    //#endregion

    //#region Constructor
    DocumentID: number = 0; // Document ID (CostCenterID set here)
    StatusID: number = 0;  // StatusID of document set here
    WorkFlowDocLevel: number = 0; // Work Flow Document level.
    intRecCount: number = 0;
    NotifWorkflowID: number = 0; // Notification Work Flow ID.
    WfID: number = 0; // Work Flow ID.
    LCDueAmt: number = 0; // Letter of Credit Due amount
    dFS_LoanAmt: number = 0;
    RightPanelVisiblity: boolean = true; // Document Right panel visible or not.
    DisableRightPanel: boolean = false; // disable Right Panel.
    LockDims: DictionaryNumKey<boolean>; // maintaining Dimension wise Lock.
    isFromDate: boolean = false; OnRejectEdit: boolean = false; IsLockDimsLineWise: boolean = false;
    IsEdit: boolean = false; // to check document is Edit or not... true or false.
    LineWiseApproval: boolean = false; // Approve document at particular row.
    UserWiseApproval = false; // Approve document based on user.
    linkStatusRemarks: string = null; // write Link status remark.
    timerDraft: Timer = new Timer();
    PoleDisplaytimer = new Timer();
    dsData: any = null; // it is as dataset.
    dtData: any[] = null; // it is datatable used in PAYROLL (apply leave, assign leave etc.) 
    IsFrmFS_LoanBal: boolean = false; // Final Settelment Load Balance ture or false.
    IsMPVParent: boolean = false; // property check that parent is Monthly Payroll Viewmodel or not -- PAYROLL
    ReevaluateFutureVac = false; // ReEvaluate Future vacation  -- true or false
    strADWxml: string; // Attendance Dimension Wise xml sting.  -- PAYROLL
    GenratePrefix: boolean = false; // used for to set document prefix. -- COMMON
    IsDocValid: boolean = false; // whether the document is valid or not. -- COMMON
    savebulk: boolean = false; // used for bulk document posting...  -- INVENTORY
    oVac: any; // its a object of a class EvaluatePayrollFormulas, used for employee vaction.  -- PAYROLL
    oEmpFilter: any; // Employee filter  -- PAYROLL
    pdcGCVM: pdcGenerateChequeViewModel = null; // PDC Generate cheque ViewModel.
    strEmpFilter = ""; // Employee filter string hold here.
    HelpDoc = ""; strValidationMessage = ""; strVacXml = ""; sApprUpdate = "";
    strPMCXml = ""; // preventive maintainance contract activity xml -- PROPERTY(Facility Management 202)
    strEmpIsMgr = ""; // string used to hold's Employee is manager or not.
    NUmpadBindingPath; // Number pad banding path... hold database value ... DisplayMember..
    DocFlowXMl = "";
    ProjDims: number[] = null; // interget type array Project Dimension.
    dtOTTypes: any[] = null; //DataTable overtime types.
    dtPayEmps: any[] = null; // DataTable payroll employee
    dtPayShifts: any[] = null; // DataTable payroll shift
    dtPayLeaveYear: any[] = null;// DataTable Payroll LeaveYear
    sSearchColName: string = ""; // used to filter SearchData
    public iPMCActivity = 0;  // preventive maintainance contract for document activity DocSeqNo -- PROPERTY(Facility Management 202)
    srcDocument: any = null; // source document, which is used in payroll. 
    PosDiscUserName: string = "";
    // AddEdit Document constructor -- COMMON
    constructor(CcID: number, _ScreenName: string, isedit: boolean = false, srcdoc: any = null, className: string = "AddEditDocumentViewModel", RegisterID: number = 0) {
        super()
        this.DtImportObj.Table = []; // DtImport gridview table set to empty.    
        this.ClassName = className; // Assigning class name..
        this.POSRegisterID = RegisterID;  // Assigning POS Register ID..
        if (_ScreenName == "EMPTY_LOAD") { // if the Screenname is "EMPTY_LOAD", addeditdocumentviewmodel object created for PrintVoucher
            this.ScreenObject = new VoucherGenerator(CcID, 0); // Initialzing voucher generator for PrintVoucher.
            return;
        }
        this.Remarks.Label = BaseService.GetResource("Remarks"); // Remark label
        this.AppRejDate.Label = BaseService.GetResource("Date");
        this.RecurDocsWithApproval.Label = BaseService.GetResource("PostRecurDocsWithApproval");
        this.HoldDocName.Label = BaseService.GetResource("DocName");
        this.HoldDocDate.Label = BaseService.GetResource("Doc_Date");
        this.Onload(CcID, _ScreenName, isedit, srcdoc); // Calling Onload function.
        this.RefreshNetAmount(); // Refreshing Net Amount of document.
        this.ScreenObject.IsConstructorCall = false; // used to avoid multiple hit to GetLinkReferenceData
        if (BaseService.IsMobile && BaseService.IsNativeMobile) {
            this.ScreenObject.GridDataObj.GridView = true;
            this.ScreenObject.GridDataObj.CCID = CcID;
            this.ScreenObject.GridDataObj.GridTypeID = 1;
            this.ScreenObject.GridDataObj.LineItemEdit.Subscribe(this, "LineItemEditClick");
            this.ScreenObject.GridDataObj.LineItemDelete.Subscribe(this, "LineItemDeleteClick");
        }

        // Rate visibility column for mobile.
        var rateColumns = this.ScreenObject.ColumnSource.filter(x => x.DisplayMember == 'Rate');
        if (rateColumns.length != 0) {
            this.ScreenObject.RateVisibility = rateColumns[0].IsVisible;
        }


        if (BaseService.SessionManager.RoleType == 2) {
            this.ScreenObject.DocPrefix.NextVisibility = false;
            this.ScreenObject.DocPrefix.PreviousVisibility = false;
            this.ScreenObject.DocPrefix.LoadVisibility = false;
        }

        this.prepareLineItemsToForm(); // preparing line item for mobile.
        this.ButtonBidRevise.Visible = false;
        this.ButtonBidReviseDistribute.Visible = false;
    }
    bProjMgmtConsWH = false
    // Name : Onload
    // Desc : Onload function calling from constructor. which loads documents.
    // Category : COMMOM
    Onload(CcID: number, _ScreenName: string, isedit = false, srcdoc: any = null) {
        Logger.InfoLog("AddEditDocumentViewModel::Entering AddEditDocumentViewModel");
        //#region Timers
        this.timerDraft.Enabled = true;
        try {
            this.timerDraft.Interval = parseInt(BaseService.SessionManager.Preferences["AutoDocumentDraftTime"]) * 1000;//60000;
        }
        catch { this.timerDraft.Interval = 60000; }

        this.timerDraft.Elapsed(this, "timerDraft_Elapsed");
        this.t.Interval = 2000;
        this.t.Tick(this, "t_Tick");

        this.PoleDisplaytimer.Interval = 60000;
        this.PoleDisplaytimer.Elapsed(this, "PoleDisplaytimer_Elapsed");

        //#endregion


        this.IsEdit = isedit; // set the property edit or not(new).
        this.CostCenterID = CcID; // assigning coscenter id of the document.
        this.srcDocument = srcdoc; // assigning source document.

        this.ScreenName = _ScreenName; // 
        this.DocumentID = this.CostCenterID;

        //#region Initialize delegate function.

        this.ScreenObject = new VoucherGenerator(this.CostCenterID, 0);
        this.ScreenObject.BidTimer.Subscribe(this, "BidTimer");
        this.ScreenObject.LoadEditCallBack.Subscribe(this, "LoadEditCallBack");
        this.ScreenObject.ClearCallBack.Subscribe(this, "ClearCallBack");
        this.ScreenObject.ValidateData.Handler(this, "ValidateDataCallBack");
        this.ScreenObject.GridDataObj.BeforeRowDeleting.Subscribe(this, "BeforeRowDeletingEvent");
        this.ScreenObject.FooterGridDataObj.CellEditEnding.Subscribe(this, "OnFooterCellEditEnding");
        this.ScreenObject.FooterGridDataObj.OnPreviewKeyDown.Subscribe(this, "OnFooterKeyDown")
        this.ScreenObject.GridDataObj.RowSelectionChange.Subscribe(this, "OnGridSelectionChanged");// Uncomented because ongridselection was not getting fire, quick view detail was not showing on selection of row. issue no 223103
        this.ScreenObject.GridDataObj.CellEditEnding.Subscribe(this, "OnCellEditCommit");
        this.ScreenObject.GridDataObj.BeginEdit.Subscribe(this, "onBeginEdit");
        this.ScreenObject.GridDataObj.shortcut.Subscribe(this, "Onshortcut");

        this.ScreenObject.FooterGridDataObj.BeginEdit.Subscribe(this, "onFooterBeginEdit");
        this.ScreenObject.GridDataObj.OnPreviewKeyDown.Subscribe(this, "OnKeyDown")
        this.ScreenObject.ReferenceCallBack.Subscribe(this, "ReferenceCallBack");
        this.ScreenObject.ShowQuickViewCallBack.Handler(this, "ShowQuickViewCallBack");
        this.ScreenObject.GridDataObj.callParentObjMethod.Subscribe(this, "CallfromgridObj");
        this.ScreenObject.GridDataObj.OnLinkClick.Subscribe(this, "onGridLinkClick");
        //#endregion
        this.worker_DoWork(srcdoc); //load Document
        if (this.ScreenObject.IsAccessDenied) // Error in document loading... not opening document
            return;
        this.RefreshGridFooter = true;

        // if the DocPrefix not null initializing delegate function.
        if (this.ScreenObject.DocPrefix != null) {
            this.ScreenObject.DocPrefix.onGetData.Subscribe(this, "GetData");
            this.ScreenObject.DocPrefix.NextVisibility = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Next");
            this.ScreenObject.DocPrefix.PreviousVisibility = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Previous");
            this.ScreenObject.DocPrefix.LoadVisibility = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "LoadDocument");
        }
        // if the documents Note preference enable ... creating add notes and view notes object
        if (this.ScreenObject.Preferences.ContainsKey("Notes") && this.ScreenObject.Preferences["Notes"] != "" && parseBoolean(this.ScreenObject.Preferences["Notes"])) {
            this.ViewNotes = new ViewNoteViewModel(this);
            this.Note = new AddNoteViewModel();
            this.Note.AddNoteViewModel_2(this);
            let tab = this.ScreenObject.CustomTab.Pages.find(x => x.Name == "Notes" && x.TabType == 3);
            if (tab) {
                tab.Fields.Clear();
                tab.Visible = true;
                tab.Fields.push(this.ViewNotes)
                let btn = this.GetButton("Notes");
                if (btn) btn.Visible = false;
            }
        }
        // if the documents Activities preference enable ... creating add Activities and view Activities object
        if (this.ScreenObject.Preferences.ContainsKey("Activities") && this.ScreenObject.Preferences["Activities"] == "True") {
            this.ViewActivities = new ViewActivitiesViewModel(this);
            this.ViewActivities.NodeID = this.DocID;
            this.ViewActivities.ViewActivityInSection = true;
            this.NodeID = this.DocID;
            this.Activities = new ActivitiesViewModel(this, false);
            this.Activities.AssignVisiblity = false;
            this.ViewActivities.Activities = this.Activities;
            this.ViewActivities.CloseVisible = true;
            let tab = this.ScreenObject.CustomTab.Pages.find(x => x.Name == "Activities" && x.TabType == 3);
            if (tab) {
                tab.Fields.Clear();
                tab.Visible = true;
                if (this.ScreenObject.Preferences.ContainsKey("OneActivity") && this.ScreenObject.Preferences["OneActivity"] == "True") {
                    this.Activities.ActivityOnScreen = true;
                    this.Activities.IsPopup = true;
                    this.Activities.OneActivity = true;
                    tab.Fields.push(this.Activities)
                }
                else if (this.ScreenObject.Preferences.ContainsKey("ActivityOnScreen") && this.ScreenObject.Preferences["ActivityOnScreen"] == "True") {
                    this.Activities.ActivityOnScreen = true;
                    this.Activities.IsPopup = true;
                    tab.Fields.push(this.Activities)
                    tab.Fields.push(this.ViewActivities)
                }
                else {
                    tab.Fields.push(this.ViewActivities)
                }
                let btn = this.GetButton("Activities");
                if (btn) btn.Visible = false;
            }
        }
        //#region Attachment
        // if the documents Attachments preference enable ... creating view Attachments object        
        if (this.ScreenObject.Preferences.ContainsKey("Attachments") && this.ScreenObject.Preferences["Attachments"] != "" && parseBoolean(this.ScreenObject.Preferences["Attachments"])) {
            //View Attachments User control object intitalization
            this.ViewAttachments = new ViewAttachmentViewModel(this);
            this.ViewAttachments.GridView = this.ScreenObject.Preferences.ContainsKey("AttachementThumbnail") && this.ScreenObject.Preferences["Attachments"] != "" && parseBoolean(this.ScreenObject.Preferences["AttachementThumbnail"])
            let tab = this.ScreenObject.CustomTab.Pages.find(x => x.Name == "Attachments" && x.TabType == 3);
            if (tab) {
                tab.Fields.Clear();
                tab.Visible = true;
                tab.Fields.push(this.ViewAttachments)
                let btn = this.GetButton("Attachments");
                if (btn) btn.Visible = false;
            }
        }

        // assigning gridLinkTab 
        let tab = this.ScreenObject.CustomTab.Pages.find(x => x.Name == "LinkInfo" && x.TabType == 3);
        if (tab) {
            tab.Fields.Clear();
            tab.Visible = false;
            this.grdLinkTab = new LinkInfoTab(this);
        }

        //#endregion

        //#region DocReports
        // Report Dimension initailization
        this.ReportDimension = new PactListBoxData(0);

        if (this.ScreenObject.IsInventory)
            this.ReportDimension.CCID = 3;
        else
            this.ReportDimension.CCID = 2;


        if (!this.ScreenObject.IsInventory) {
            this.ReportDimension.TypeID = 100;
            this.ReportDimension.Label = BaseService.GetResource("DocumentDesigner_Account");
        }
        else {
            this.ReportDimension.TypeID = 10;
            this.ReportDimension.Label = BaseService.GetResource("DocumentDesigner_Product");
            if (this.DocumentType >= 51 && this.DocumentType <= 199 && this.DocumentType != 64)
                this.ReportDimension.Visible = false;
        }
        if (!this.BodyVisible)
            this.ReportDimension.Visible = false;
        this.ReportsList = []; // ReportList shows the list of report
        this.DocsList = []; // Document List Button.
        this.Shortcut.Subscribe(this, "OnShortcutClick");
        let DupCheck: number[] = [];
        // Adding ReportList and DocList values based on "Type
        if (this.ScreenObject.Data != null && this.ScreenObject.Data.Tables.length > 21 && this.ScreenObject.Data.Tables[21].length > 0) {
            this.ScreenObject.Data.Tables[21].forEach(dr => {
                if (Util.String(dr["Type"]) != "2") {
                    let link = new PactButtonData();
                    link.DBColumnID = parseInt(dr["ReportID"]);
                    link.Label = dr["ReportName"].toString();
                    if (this.ScreenObject.Data.Columns[21].Contains("Shortcut"))
                        link.KeyTip = dr["Shortcut"].toString();
                    if (this.ScreenObject.Data.Columns[21].Contains("DisplayAsPopup") && !Util.IsEmpty(dr["DisplayAsPopup"]))
                        link.Dependancy = Util.Int(dr["DisplayAsPopup"]);
                    if (this.ScreenObject.Data.Columns[21].Contains("DisplayInMobileGrid") && !Util.IsEmpty(dr["DisplayInMobileGrid"]))
                        link.Mode = Util.Int(dr["DisplayInMobileGrid"]);
                    if (this.ScreenObject.Data.Columns[21].Contains("Width") && !Util.IsEmpty(dr["Width"]))
                        link.GroupName = dr["Width"].toString();
                    if (this.ScreenObject.Data.Columns[21].Contains("Height") && !Util.IsEmpty(dr["Height"]))
                        link.Length = dr["Height"].toString();
                    if (this.ScreenObject.Data.Columns[21].Contains("DocumentField") && !Util.IsEmpty(dr["DocumentField"]))
                        link.Formula = dr["DocumentField"].toString();
                    if (this.ScreenObject.Data.Columns[21].Contains("mapxml") && !Util.IsEmpty(dr["mapxml"]))
                        link.ToolTipFooterDescription = dr["mapxml"].toString();
                    if (!DupCheck.Contains(parseInt(dr["ReportID"]))) {
                        DupCheck.push(parseInt(dr["ReportID"]));
                        this.ReportsList.push(link);

                        if (this.IsPOs) {
                            if (this.ScreenObject.Data.Columns[1].Contains("ActionHeight")) {
                                if (!Util.IsEmpty(this.ScreenObject.Data.Tables[1][0]["ActionHeight"]))
                                    link.SectionID = this.ScreenObject.Data.Tables[1][0]["ActionHeight"].toString();
                                else
                                    link.SectionID = "60";

                                if (!Util.IsEmpty(this.ScreenObject.Data.Tables[1][0]["ActionWidth"]))
                                    link.Width = this.ScreenObject.Data.Tables[1][0]["ActionWidth"].toString();
                                else
                                    link.Width = "62";
                            }
                            else {
                                link.Width = "62";
                                link.SectionID = "60";
                            }
                            link.ComParam = "Reports " + link.DBColumnID;
                            this.ButtonsLeft.push(link);
                        }
                    }
                }
                else {
                    let link = new PactButtonData();
                    link.DBColumnID = parseInt(dr["ReportID"]);
                    link.Label = dr["ReportName"].toString();
                    if (this.ScreenObject.Data.Columns[21].Contains("Shortcut"))
                        link.KeyTip = dr["Shortcut"].toString();
                    if (this.ScreenObject.Data.Columns[21].Contains("DisplayAsPopup") && !Util.IsEmpty(dr["DisplayAsPopup"]))
                        link.Dependancy = Util.Int(dr["DisplayAsPopup"]);
                    this.DocsList.push(link);

                    if (this.IsPOs) {
                        if (this.ScreenObject.Data.Columns[1].Contains("ActionHeight")) {
                            if (!Util.IsEmpty(this.ScreenObject.Data.Tables[1][0]["ActionHeight"]))
                                link.SectionID = this.ScreenObject.Data.Tables[1][0]["ActionHeight"].toString();
                            else
                                link.SectionID = "60";

                            if (!Util.IsEmpty(this.ScreenObject.Data.Tables[1][0]["ActionWidth"]))
                                link.Width = this.ScreenObject.Data.Tables[1][0]["ActionWidth"].toString();
                            else
                                link.Width = "62";
                        }
                        else {
                            link.Width = "62";
                            link.SectionID = "60";
                        }
                        link.ComParam = "Documents " + link.DBColumnID;
                        this.ButtonsLeft.push(link);
                    }
                }
            });
        }
        if (this.ReportsList.length == 0 && this.ButtonReport != null)
            this.ButtonReport.Visible = false;

        if (this.IsPOs) {
            this.ProductSearchVisibility = true;
            this.ReportInfoVisibility = false;
        }
        else
            this.SetDefaultRightPanel();
        //#endregion

        //#region Registors
        if (BaseService.SessionManager.RegisterCCID > 0 && this.ScreenObject.RegisterNodeID == 0 && this.ScreenObject.Data.Tables.length > 18 && this.ScreenObject.Data.Tables[18].length > 0
            && !this.IsPOs) {
            let ds = BaseService.admin.GetRegisters()
            {
                if (ds.Tables.length > 0 && ds.Columns[0].Contains("NodeID")) {
                    if (ds.Tables[0].length == 1) {
                        this.ScreenObject.RegisterNodeID = parseInt(ds.Tables[0][0]["NodeID"]);
                    }
                    else if (ds.Tables[0].length > 0) {
                        //ShellWindowViewModel.Instance().PopViewModel = new RegisterViewModel(this, ds.Tables[0]);
                        let RegVM: any = new RegisterViewModel(this, ds.Tables[0]);
                        BaseService.page.ShowDialog(RegVM, RegisterComponent, { ShowCenter: true, Title: RegVM.Title });

                    }
                }
            }
        }

        //#endregion

        //#region Disale Auto Load ListView
        if (!this.DocumentNumber || !this.DocumentNumber.DialogOptions || !this.DocumentNumber.DialogOptions.IsOpen) {
            if (BaseService.SessionManager.Preferences.ContainsKey("DisableAutoLoad") && BaseService.SessionManager.Preferences["DisableAutoLoad"].toLowerCase() == "true") {
                this.ScreenObject.FillListViews(true);
                this.ReportDimension.IsAutoLoad = true;
            }
        }
        //#endregion

        this.PoleDisplayMessage(1, null);

        if (this.ScreenObject.DocumentType == 35)//Service Contract
        {
            this.ViewOrganizationViewModel = this.GetViewOrganizationViewModel(this);//RibbonExtCrm.GetViewOrganizationViewModel(this);
            this.CasesContactViewModel = this.GetCasesContactViewModel(this.ViewOrganizationViewModel, this);//RibbonExtCrm.GetCasesContactViewModel(this.ViewOrganizationViewModel, this);

            this.CasesContactViewModel.Contact.Items.Clear();
            if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0) {
                // getting Account detail base on selected value.
                let dstemp = BaseService.accounting.GetAccountDetails(this.ScreenObject.DebitAccount.SelectedValue);
                if (dstemp != null && dstemp.Tables[0].length > 0) {
                    //#region Fill Contacts Based on Account
                    this.CasesContactViewModel.Contact.Items.push(ComboBoxItems.ComboBoxItems_2("New", "0"));
                    this.CasesContactViewModel.Contact.SelectedValue = "0";
                    if (dstemp.Tables.length > 1 && dstemp.Tables[2].length > 0) {
                        for (let i = 0; i < dstemp.Tables[2].length; i++) {
                            this.CasesContactViewModel.Contact.Items.push(ComboBoxItems.ComboBoxItems_2(dstemp.Tables[2][i]["FirstName"].toString(), dstemp.Tables[2][i]["ContactID"].toString()));
                        }
                        this.CasesContactViewModel.dvContacts = dstemp.Tables[2].DefaultView;
                    }
                    //#endregion
                }
            }
        }

        //#region AutoPostDoc

        let AutoDocCCID = 0;
        if (this.ScreenObject.Preferences.ContainsKey("Autopostdocument") && this.ScreenObject.Preferences["Autopostdocument"] != ""
            && parseInt(this.ScreenObject.Preferences["Autopostdocument"]) > 40000
            && !(this.ScreenObject.Preferences.ContainsKey("AutoIssueNextStage") && this.ScreenObject.Preferences["AutoIssueNextStage"] == "True")) {
            AutoDocCCID = Util.Int(this.ScreenObject.Preferences["Autopostdocument"])
            this.AutoPostViewModel = new AddEditDocumentViewModel(AutoDocCCID, "", false, this);
            this.AutoPostViewModel.IsAutoPost = true;
            this.AutoPostViewModel.ScreenObject.GridDataColumns.push("RefSeqNo");
            this.ScreenObject.GridDataColumns.push("RefSeqNo");

            if (this.ScreenObject.Preferences.ContainsKey("NoAutoproduce") && parseBoolean(this.ScreenObject.Preferences["NoAutoproduce"])
                && this.AutoPostViewModel.AutoProduce != null)
                this.AutoPostViewModel.AutoProduce = null;
        }

        if (this.DocumentType == 33 && BaseService.SessionManager.Preferences.ContainsKey("AutoProduceDoc") && BaseService.SessionManager.Preferences["AutoProduceDoc"] != ""
            && Util.Int(BaseService.SessionManager.Preferences["AutoProduceDoc"]) > 40000) {
            AutoDocCCID = Util.Int(this.ScreenObject.Preferences["AutoProduceDoc"])
            this.AutoProduce = new AddEditDocumentViewModel(AutoDocCCID, "", false);
            this.AutoProduce.isAutoProduce = true;
            this.AutoProduce.ScreenObject.GridDataColumns.push("AutoRefSeqNo");
            this.ScreenObject.GridDataColumns.push("AutoRefSeqNo");
        }

        //#endregion

        if (this.DocumentType == 15) // Batch Payment Report
            this.BatchPayment();

        this.SetFocus(); // Set Focus on control.
        this.SetSaveVisibility();// for POS Document setting Save button visibility

        // Linking selection change event calling
        if (!isedit && this.ScreenObject != null && this.ScreenObject.Link != null && this.ScreenObject.Link.LinkCombo != null && !Util.IsEmpty(this.ScreenObject.Link.LinkCombo.SelectedValue))
            this.OLinkSelectionChanged(null);

        this.ConsolidateLeaveMonth();
        this.SetNewDocFields(); // Set All Document fields to new.
        this.CheckListViews(); // Listview loading from config file...

        if (this.ScreenObject.IsPayrollDocument) { // Payroll document functionality, hiding some button and etc.
            this.SetButtonVisibility("Recur", false);
            this.SetButtonVisibility("Hold", false);
            this.SetButtonVisibility("Release", false);
            this.SetButtonVisibility("ShowJV", false);
            this.SetButtonVisibility("ReEvaluate", false);
            this.SetButtonVisibility("PriceChart", false);
            this.SetButtonVisibility("PostBills", false);

            this.dtPayEmps = BaseService.common.GetDataSet("PAY045", "").Tables[0];

            if (this.ScreenObject.DocumentType == 67) {
                this.dtPayShifts = BaseService.common.GetDataSet("PAY046", "").Tables[0];
                this.dtOTTypes = BaseService.common.GetDataSet("PAY047", "").Tables[0];
            }

            if (this.ScreenObject.DocumentType == 81) {
                this.dtPayLeaveYear = BaseService.common.GetDataSet("PAY118", "").Tables[0];
            }


            if (this.ScreenObject.CostCenterID == 40056 || this.ScreenObject.CostCenterID == 40057 || this.ScreenObject.CostCenterID == 40081 ||
                this.ScreenObject.CostCenterID == 40061 || this.ScreenObject.CostCenterID == 40072 || this.ScreenObject.CostCenterID == 40065 ||
                this.ScreenObject.DocumentType == 73 || this.ScreenObject.DocumentType == 94 || this.ScreenObject.DocumentType == 97) {
                this.ScreenObject.GridDataObj.CanUserAddRows = false;
                this.ScreenObject.GridDataObj.CanUserDeleteRows = false;
            }
            if (this.ScreenObject.DocumentType == 99) {
                this.ScreenObject.GridDataObj.Clear();
                this.ScreenObject.GridDataObj.CanUserAddRows = false;
                this.ScreenObject.GridDataObj.CanUserDeleteRows = false;
            }

            if (srcdoc != null && srcdoc.toString() == "IsFrmFS_LoanBal") // Dimension wise Work Sheet or From Final Settlement
            {
                this.DisableRightPanel = true;
                this.OKCancelVisibility = true;
            }
        }

        if (this.DocumentType == 45) { // Project plan document setting Fixed Date Format.
            let fldDat2: any = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha15");
            if (fldDat2 != undefined)
                fldDat2.FixedDateFormat = BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a";

            fldDat2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha16");
            if (fldDat2 != undefined)
                fldDat2.FixedDateFormat = BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a";

            fldDat2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha22");
            if (fldDat2 != undefined)
                fldDat2.FixedDateFormat = BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a";

            fldDat2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha23");
            if (fldDat2 != undefined)
                fldDat2.FixedDateFormat = BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a";
        }

        this.ScreenObject.GridDataObj.IsDocument = true;
        this.ScreenObject.GridDataObj.IsReadOnlyColor = true; // 
        this.ScreenObject.GridDataObj.Height = this.ScreenObject.GridDataObj.Height + 17; // assigning gridview height  --- 17 extra pixcel add why because if only one row is in grid, footer row was overlaping with row.

        if (this.ScreenObject.FooterGridDataObj) { // setting user not to delete footer grid row.
            this.ScreenObject.FooterGridDataObj.CanUserDeleteRows = false;
        }

        Logger.InfoLog("AddEditDocumentViewModel::Exiting AddEditDocumentViewModel");
    }

    // this method copied from RibbonExtCrm.ts
    public GetViewOrganizationViewModel(org: any) {
        return new ViewOrganizationViewModel(org);
    }

    // this method copied from RibbonExtCrm.ts
    public GetCasesContactViewModel(vieworg: any, doc: any)//(IViewOrganizationViewModel vieworg, IAddEditDocumentViewModel doc)
    {
        return new CasesContactViewModel(vieworg, doc);
    }

    // Name : SetReportDim
    // Desc : set Report Dimension if it is autoload is true.
    // Category : COMMOM
    SetReportDim() {
        if (this.ReportDimension != null && this.ReportDimension.Visible && this.SelectedRow != null)//&& this.SelectedRow instanceof DataRowView)
        {
            if (this.SelectedRow == null)
                return;

            let colNmae = this.GetColName();
            if (!Util.IsEmpty(this.SelectedRow[colNmae])) {
                this.ReportDimension.SelectedValue = parseInt(this.SelectedRow[colNmae].toString());
                if (this.ReportDimension.IsAutoLoad) {
                    if (this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("ProductName"))
                        this.ReportDimension.SelectedValueText = this.ReportDimension.Text = Util.String(this.SelectedRow["ProductName"]);
                    else if (this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                        this.ReportDimension.SelectedValueText = this.ReportDimension.Text = Util.String(this.SelectedRow["ProductCode"]);
                    else if (!this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("AccountCode"))
                        this.ReportDimension.SelectedValueText = this.ReportDimension.Text = Util.String(this.SelectedRow["AccountCode"]);
                    else if (!this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("AccountName"))
                        this.ReportDimension.SelectedValueText = this.ReportDimension.Text = Util.String(this.SelectedRow["AccountName"]);
                }
            }
        }
    }

    // Name : BatchPayment
    // Desc : while loading Bank payment document, can open report based on preferences.
    // Category : ACCOUNTING

    async BatchPayment() {
        if (this.ScreenObject.Preferences.ContainsKey("batchpaymentreport") && this.ScreenObject.Preferences["batchpaymentreport"] != "" && this.ScreenObject.Preferences["batchpaymentreport"] != "0") {
            let CurrID = 1; let ExhgRate = 1, Amt = 0;
            if (this.Currency != null && this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue != "")
                CurrID = parseInt(this.Currency.Currency.SelectedValue);
            //else if (ScreenObject.GridDataColumns.Contains("CurrencyID") && datarow["CurrencyID_Key"].toString() != "")
            //    CurrID = parseInt(datarow["CurrencyID_Key"].toString());
            if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
            //else if (ScreenObject.GridDataColumns.Contains("ExchangeRate") && datarow["ExchangeRate"].toString() != "")
            //    ExhgRate = parseFloat(datarow["ExchangeRate"].toString());

            let objBC: BatchPayCopyChequeDataViewModel = new BatchPayCopyChequeDataViewModel();
            objBC.oParent = this;
            BaseService.page.ShowDialog(objBC, BatchPayCopyChequeDataComponent, { ShowCenter: true }).subscribe(async () => {
                if (objBC.DialogResult) {

                }

                // using (ReportViewModel oReport = new ReportViewModel(parseInt(this.ScreenObject.Preferences["batchpaymentreport"])))
                // Initializing ReportViewmodel and Report View Component
                const { ReportViewModel } = await import('../../reports/report-view/ReportViewModel');
                const { ReportViewComponent } = await import('../../reports/report-view/report-view.component');
                let oReport = new ReportViewModel();
                oReport.ReportViewModel_1(parseInt(this.ScreenObject.Preferences["batchpaymentreport"]));
                {
                    /**oReport.RptHeight = System.Windows.SystemParameters.PrimaryScreenHeight - 100;
                    oReport.RptWidth = System.Windows.SystemParameters.PrimaryScreenWidth - 100;**/
                    oReport.DispayAsPopup = true;
                    oReport.CanSelectRows = true;
                    oReport.ButtonSMS.Visible = oReport.ButtonPrint.Visible = oReport.ButtonExport.Visible = oReport.ButtonEmail.Visible = false;
                    oReport.ButtonPost.Visible = true;
                    oReport.ButtonPost.Label = "Ok";

                    // Displaying report as a popup window
                    BaseService.page.ShowDialog(oReport, ReportViewComponent, { HideHeader: true }).subscribe(
                        () => {
                            var rows = oReport.Data.filter(a => a.IsSelected && a.DataRow["AccountName_ID"] != "");//.OrderBy(a => parseInt(a.DataRow["AccountName_ID"].toString())).ToArray();
                            rows.sort((a, b) => a.DataRow["AccountName_ID"] - b.DataRow["AccountName_ID"])
                            if (rows.length > 0) {

                                if (objBC != null && objBC.DialogResult) {
                                    if (!Util.IsEmpty(objBC.sDocDate)) {
                                        this.ScreenObject.HeaderFields.forEach(item => {
                                            if (item instanceof PactVoucherDateData && item.DBColumnName.toLowerCase() == "docdate") {
                                                item.Date = Util.ParseDate(objBC.sDocDate);
                                                this.ScreenObject.DocDate.Date = Util.ParseDate(objBC.sDocDate);
                                                this.DocumentDate = Util.ParseDate(objBC.sDocDate);
                                            }
                                            else if (item instanceof PactDatePickerData && item.DBColumnName.toLowerCase() == "actdocdate") {
                                                item.Date = Util.ParseDate(objBC.sDocDate);
                                            }
                                        });
                                    }
                                }

                                let sPrevChequeNo = "";

                                this.ScreenObject.GridDataObj.Clear();
                                let dr: any = null;
                                let objbill: BillWiseViewModel = null;
                                for (let i = 0; i < rows.length; i++) {
                                    if (i > 0 && parseInt(rows[i].DataRow["AccountName_ID"].toString()) != parseInt(rows[i - 1].DataRow["AccountName_ID"].toString()) && objbill != null) {

                                        objbill.AmtToAdjust.Text = Amt.ToString("N" + objbill.decimalpoints);
                                        objbill.NewReference.Text = "0";
                                        if (this.ScreenObject.GridDataColumns.Contains("Amount"))
                                            dr["Amount"] = Amt.ToString("N" + objbill.decimalpoints);
                                        this.Celleditend(dr, "DocSeqNo", 0);
                                        objbill.OnSave("autosave");
                                        // #$#$#$
                                        this.ScreenObject.GridDataObj.addRow(dr);
                                        dr = null;
                                        objbill = null;
                                    }
                                    if (dr == null) {
                                        Amt = 0;
                                        dr = this.ScreenObject.GridDataObj.NewRow();
                                        //this.ScreenObject.GridData.Rows.push(dr); // this dr adding below #$#$#$
                                        dr["DebitAccount_Key"] = rows[i].DataRow["AccountName_ID"].toString();
                                        this.SelectedRow = this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1];
                                        objbill = new BillWiseViewModel();
                                        objbill.BillWiseViewModel_2(this, 0, parseInt(rows[i].DataRow["AccountName_ID"].toString()), false, CurrID, ExhgRate, true, "");

                                        if (objBC != null && objBC.DialogResult) {
                                            if (objBC.iPayMode > 0) {
                                                var ovar1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "CreditAccount");
                                                if (ovar1 != null && ovar1 != undefined) {
                                                    dr["CreditAccount_Key"] = objBC.iPayMode.toString();
                                                    this.Celleditend(dr, "CreditAccount", 2, 0);
                                                }

                                                if (ovar1 == null || ovar1 == undefined) {
                                                    var ovar2 = this.ScreenObject._StaticFields.find(a => a.DBColumnName == "CreditAccount");
                                                    if (ovar2 != null && ovar2 != undefined) {
                                                        if (ovar2 instanceof PactListBoxData) {
                                                            ovar2.SelectedValue = objBC.iPayMode;
                                                            ovar2.SelectedValueText = objBC.sPaymodeName;
                                                            ovar2.Text = objBC.sPaymodeName;
                                                            this.ScreenObject.OnGetReference(ovar2);
                                                        }
                                                        else if (ovar2 instanceof PactCodeNameListBoxData) {
                                                            ovar2.Code.SelectedValueText = ovar2.Code.Text = objBC.sPaymodeCode;
                                                            ovar2.Name.SelectedValueText = ovar2.Name.Text = objBC.sPaymodeName;
                                                            ovar2.SelectedValue = objBC.iPayMode;
                                                            this.ScreenObject.OnGetReference(ovar2.Name);
                                                        }

                                                    }
                                                }
                                            }
                                            if (objBC.sChequeBook != "") {
                                                var ovar1 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "ChequeBookNo");
                                                if (ovar1 != null && ovar1 != undefined)
                                                    dr["ChequeBookNo"] = objBC.sChequeBook;

                                                if (ovar1 == null || ovar1 == undefined) {
                                                    let ovar2: any = this.ScreenObject._StaticFields.find(a => a.DBColumnName == "ChequeBookNo");
                                                    if (ovar2 != null && ovar2 != undefined)
                                                        ovar2.SelectedValue = objBC.sChequeBook;
                                                }
                                            }
                                            if (objBC.sChequeNo != "") {
                                                if (this.ScreenObject.Preferences.ContainsKey("AutoChequeNo") && this.ScreenObject.Preferences["AutoChequeNo"].toUpperCase() == "TRUE") {
                                                    if (sPrevChequeNo != "") {
                                                        let icn = parseInt(sPrevChequeNo);
                                                        objBC.sChequeNo = sPrevChequeNo.Replace(icn.toString(), "") + (icn + 1);
                                                    }
                                                }
                                                var ovar1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "ChequeNumber");
                                                if (ovar1 != null && ovar1 != undefined)
                                                    dr["ChequeNumber"] = objBC.sChequeNo;

                                                if (ovar1 == null || ovar1 == undefined) {
                                                    let ovar2: any = this.ScreenObject._StaticFields.find(a => a.DBColumnName == "ChequeNumber");
                                                    if (ovar2 != null)
                                                        ovar2.Text = objBC.sChequeNo;
                                                }
                                                sPrevChequeNo = objBC.sChequeNo;
                                            }
                                            if (objBC.sChequeDate != "") {
                                                var ovar1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "ChequeDate");
                                                if (ovar1 != null && ovar1 != undefined) {
                                                    dr["ChequeDate"] = Util.ParseDate(objBC.sChequeDate).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                    dr["ChequeDate_Key"] = Util.ParseDate(objBC.sChequeDate);
                                                }

                                                if (ovar1 == null || ovar1 == undefined) {
                                                    let ovar2: any = this.ScreenObject._StaticFields.find(a => a.DBColumnName == "ChequeDate");
                                                    if (ovar2 != null)
                                                        ovar2.Date = Util.ParseDate(objBC.sChequeDate);
                                                }
                                            }
                                        }

                                    }
                                    if (objbill != null) {

                                        var drbill = objbill.GridData.filter(x => x.DocNo == rows[i].DataRow["DocNo"].toString() && x.DocSeqNo == rows[i].DataRow["DocSeqNo"].toString());
                                        if (drbill.length > 0 && !Util.IsEmpty(drbill[0]["Due"])) {
                                            drbill[0]["AmountPaidLC"] = drbill[0]["Due"];
                                            let egl = 0, totval = 0;
                                            if (!Util.IsEmpty(drbill[0]["CurrID"]) && parseInt(drbill[0]["CurrID"].toString()) == CurrID && drbill[0]["ExchgRate"].toString() != "" && parseFloat(drbill[0]["ExchgRate"].toString()) != ExhgRate) {
                                                totval = (parseFloat(drbill[0]["AmountPaidLC"].toString()) / parseFloat(drbill[0]["ExchgRate"].toString()));
                                                egl = parseFloat(drbill[0]["AmountPaid"].toString()) * (parseFloat(drbill[0]["ExchgRate"].toString()) - ExhgRate);
                                            }
                                            else {
                                                totval = (parseFloat(drbill[0]["AmountPaidLC"].toString()) / ExhgRate);
                                            }
                                            drbill[0]["AmountPaid"] = totval.ToString("N" + objbill.decimalpoints);
                                            drbill[0]["exchgl"] = egl;
                                            objbill.PaidChange("AmountPaid", drbill[0], false);
                                            Amt += totval;
                                        }
                                    }
                                }
                                if (objbill != null) {
                                    objbill.AmtToAdjust.Text = Amt.ToString("N" + objbill.decimalpoints);
                                    objbill.NewReference.Text = "0";
                                    if (this.ScreenObject.GridDataColumns.Contains("Amount"))
                                        dr["Amount"] = Amt.ToString("N" + objbill.decimalpoints);
                                    this.Celleditend(dr, "DocSeqNo", 0);
                                    objbill.OnSave("autosave");
                                    // #$#$#$
                                    this.ScreenObject.GridDataObj.addRow(dr);
                                    this.ScreenObject.UpdateSequence();

                                    this.RefreshGrid = true;
                                }
                            }
                        }
                    );
                }
            });
        }
    }

    // Name : FillGridData
    // Desc : filling griddata, and refereshing it. this method is call from MonthlyPayrollViewmodel.ts.
    // Category : PAYROLL
    FillGridData(dtWorkSheet: any) {
        if (dtWorkSheet != null && dtWorkSheet.length > 0) {
            this.ScreenObject.GridDataObj.Clear();
            let drw;
            for (let r = 0; r < dtWorkSheet.length; r++) {
                drw = this.ScreenObject.GridDataObj.NewRow();
                // for(let c = 0; c < dtWorkSheet.Columns.length; c++)
                //     drw[dtWorkSheet.Columns[c].ColumnName] = dtWorkSheet[r][dtWorkSheet.Columns[c].ColumnName];
                for (let c = 0; c < Object.keys(dtWorkSheet[0]).length; c++)
                    drw[Object.keys(dtWorkSheet[0])[c]] = dtWorkSheet[r][Object.keys(dtWorkSheet[0])[c]];
                this.ScreenObject.GridData.push(drw);
            }
            this.ScreenObject.GridDataObj.refreshDataView();
        }
    }

    // Name : CheckListViews
    // Desc : Holding listview as cache while loading document, listviewid reading from config file
    // Category : COMMON
    CheckListViews() {
        if (!Util.IsEmpty(BaseService.SessionManager.config.ListViewCache)) {
            let ids = BaseService.SessionManager.config.ListViewCache.split(',');
            for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
                if (this.ScreenObject.ColumnSource[i].DataType == "LISTBOX") {
                    if (BaseService.SessionManager.ListViewDef != null) {
                        let typeid;
                        if (this.ScreenObject.ColumnSource[i].TypeID > 0)
                            typeid = this.ScreenObject.ColumnSource[i].TypeID;
                        else
                            typeid = 1;
                        let drlist: any[] = BaseService.SessionManager.ListViewDef.Tables[0].filter(x => x.CostCenterID == this.ScreenObject.ColumnSource[i].CostCenterID && x.ListViewTypeID == typeid);
                        if (drlist.length > 0 && ids.Contains(drlist[0]["ListViewID"].toString())) {
                            if (BaseService.SessionManager.ListViewCache && BaseService.SessionManager.ListViewCache.ContainsKey(parseInt(drlist[0]["ListViewID"])))
                                continue;
                            /***
                            let pcb = new PListViewComponent();
                            pcb.CostCenterID = this.ScreenObject.ColumnSource[i].CostCenterID;
                            pcb.TypeID = this.ScreenObject.ColumnSource[i].TypeID;
                            pcb.DivisionId = this.ScreenObject.ColumnSource[i].DivisionID;
                            pcb.LocationID = this.ScreenObject.ColumnSource[i].LocationID;
                            pcb.PrepareList();
                            pcb.GetData(0, "", false,0); ***/
                        }
                    }
                }
            }
        }
    }

    // Name : DimensionSelectedvalueData
    // Desc : Employee or Grade dimension selected value data changed. validation and execution of code.
    // Category : PAYROLL
    DimensionSelectedvalueData() {
        let SelectedEmpID = 0;
        if (this.ScreenObject.DocumentType == 73) //Leave Adjustment As Vacation
        {
            let DimLTfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (DimLTfld && DimLTfld instanceof PactListBoxData && DimLTfld.SelectedValue > 0)
                SelectedEmpID = DimLTfld.SelectedValue;
            else if (DimLTfld && DimLTfld instanceof PactCodeNameListBoxData && DimLTfld.SelectedValue > 0)
                SelectedEmpID = DimLTfld.SelectedValue;

            if (SelectedEmpID == 0) {
                this.DisplayMessage = "Please select the employee";
                return;
            }
            DimLTfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
            if (DimLTfld && DimLTfld instanceof PactListBoxData && DimLTfld.SelectedValue > 0) {
                this.dsData = this.ScreenObject.GetAdjustmentLeaves(0, SelectedEmpID, DimLTfld.SelectedValue, this.DocID);
                if (this.dsData.Tables.length > 0) {
                    if (this.dsData.Tables[0].length <= 0) {
                        this.ScreenObject.GridDataObj.Clear();
                        this.DisplayMessage = "No record found";

                    }
                    else {
                        if (this.dsData.Tables[0].length > 0) {
                            this.DisplayMessage = "";
                            this.MessageVisibility = false;

                            let drGrid = null;
                            let RowPosition = 0;
                            drGrid = null;
                            this.ScreenObject.GridDataObj.Clear();
                            let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                            for (let k = 0; k < this.dsData.Tables[0].length; k++) {
                                drGrid = this.ScreenObject.GridDataObj.NewRow();
                                this.ScreenObject.GridData.InsertAt(drGrid, RowPosition);
                                RowPosition++;
                                if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"]))
                                    drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];

                                drGrid["dcAlpha1"] = this.dsData.Tables[0][k]["VoucherNo"]; //DOCID
                                drGrid["dcAlpha2"] = Util.ParseDate(this.dsData.Tables[0][k]["FROMDATE"]).ToString("dd-MMM-yyyy");
                                drGrid["dcAlpha2_Key"] = Util.ParseDate(this.dsData.Tables[0][k]["FROMDATE"]).ToString("dd-MMM-yyyy");
                                drGrid["dcAlpha3"] = Util.ParseDate(this.dsData.Tables[0][k]["TODATE"]).ToString("dd-MMM-yyyy");
                                drGrid["dcAlpha3_Key"] = Util.ParseDate(this.dsData.Tables[0][k]["TODATE"]).ToString("dd-MMM-yyyy");
                                drGrid["dcNum1"] = this.dsData.Tables[0][k]["NOOFDAYS"];
                                drGrid["dcAlpha4"] = "No";
                                drGrid["dcAlpha5"] = this.dsData.Tables[0][k]["DocSeqNo"];
                            }
                            if (this.dsData.Tables[0].length > 0)
                                this.ScreenObject.GridDataObj.refreshDataView();
                        }
                    }
                }
            }
            return;
        }
        else if (this.ScreenObject.DocumentType == 94) //Consider LOP to Service Days
        {
            this.ScreenObject.GridDataObj.Clear();

            let DimLTfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (DimLTfld && DimLTfld instanceof PactListBoxData && DimLTfld.SelectedValue > 0)
                SelectedEmpID = DimLTfld.SelectedValue;
            else if (DimLTfld && DimLTfld instanceof PactCodeNameListBoxData && DimLTfld.SelectedValue > 0)
                SelectedEmpID = DimLTfld.SelectedValue;

            if (SelectedEmpID == 0) {
                this.DisplayMessage = "Please select the employee";
                return;
            }
            DimLTfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
            if (DimLTfld && DimLTfld instanceof PactListBoxData && DimLTfld.SelectedValue > 0) {
                let Cnt = 0;
                this.dsData = this.GetLOPLeaveDocuments(SelectedEmpID, DimLTfld.SelectedValue, this.DocumentDate);
                if (this.dsData != null && this.dsData.Tables.length > 0) {
                    if (this.dsData.Tables[0].length > 0 && this.dsData.Columns[0].Contains("ErrorMessage")) {
                        this.DisplayMessage = this.dsData.Tables[0][0]["ErrorMessage"].toString();

                        return;
                    }

                    if (this.dsData.Tables[0].length > 0) {
                        let sLeaveVNo = "";
                        let dLN = 0;
                        let drGrid = null;
                        let RowPosition = 0;
                        drGrid = null;
                        let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');

                        for (let k = 0; k < this.dsData.Tables[0].length; k++) {
                            sLeaveVNo = this.dsData.Tables[0][k]["VoucherNo"].toString();
                            dLN = parseFloat(this.dsData.Tables[0][k]["NoOfDays"]);
                            let dVal = Util.DTComputeSUM(this.dsData.Tables[1].filter(x => x.LOPLeaveDocVoucherNo == sLeaveVNo), "CurAdjDays", false);
                            if (dVal < dLN) {
                                drGrid = this.ScreenObject.GridDataObj.NewRow();
                                this.ScreenObject.GridData.InsertAt(drGrid, RowPosition);
                                RowPosition++;
                                if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"]))
                                    drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];

                                drGrid["dcAlpha1"] = this.dsData.Tables[0][k]["VoucherNo"];
                                drGrid["dcAlpha2"] = Util.ParseDate(this.dsData.Tables[0][k]["FROMDATE"]).ToString("dd-MMM-yyyy");
                                drGrid["dcAlpha2_Key"] = Util.ParseDate(this.dsData.Tables[0][k]["FROMDATE"]).ToString("dd-MMM-yyyy");
                                drGrid["dcAlpha3"] = Util.ParseDate(this.dsData.Tables[0][k]["TODATE"]).ToString("dd-MMM-yyyy");
                                drGrid["dcAlpha3_Key"] = Util.ParseDate(this.dsData.Tables[0][k]["TODATE"]).ToString("dd-MMM-yyyy");
                                drGrid["dcAlpha4"] = this.dsData.Tables[0][k]["NOOFDAYS"];
                                drGrid["dcAlpha5"] = "false";
                                drGrid["dcAlpha6"] = dVal.toString();
                                Cnt++;
                            }
                        }
                        this.ScreenObject.GridDataObj.refreshDataView();
                    }
                }
                if (Cnt == 0) {
                    this.ScreenObject.GridDataObj.Clear();
                    this.DisplayMessage = "No record found";

                }
            }
            return;
        }

        let Dimfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");

        if (this.ScreenObject.DocumentType == 61)
            Dimfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid53");

        if (Dimfld && Dimfld instanceof PactListBoxData && Dimfld.SelectedValue > 0)
            SelectedEmpID = Dimfld.SelectedValue;
        else if (Dimfld && Dimfld instanceof PactCodeNameListBoxData && Dimfld.SelectedValue > 0)
            SelectedEmpID = Dimfld.SelectedValue;

        if (SelectedEmpID > 0) {
            if (this.ScreenObject.DocumentType == 56) //Apply Loan
            {
                if (BaseService.SessionManager.Preferences.ContainsKey("DonotAllowApplyLoanDuringProbationPeriod") && parseBoolean(BaseService.SessionManager.Preferences["DonotAllowApplyLoanDuringProbationPeriod"])) {
                    let dtChk = BaseService.common.GetDataSet3("PAY035", this.ScreenObject.DocDate.Date.ToString("dd/MMM/yyyy"), SelectedEmpID.toString()).Tables[0];
                    if (dtChk != null && dtChk.length > 0 && dtChk[0]["Valid"] != null && dtChk[0]["Valid"] != null && dtChk[0]["Valid"].toString() == "1") {
                        this.DisplayMessage = "Employee is in probation period, can not apply the Loan";
                        return;
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 69) //Apply Resignation
            {
                let dtRes = BaseService.common.GetDataSet3("PAY036", this.DocID.toString(), SelectedEmpID.toString()).Tables[0];
                if (dtRes != null && dtRes.length > 0) {
                    this.DisplayMessage = "Employee Resignation document already exists, Check Document @ " + dtRes[0]["VoucherNo"].toString();
                    return;
                }
            }
            //SelectedEmpID = Dimfld.SelectedValue;
            else if (this.ScreenObject.DocumentType == 58) //Leave Encashment
            {
                this.dsData = this.ScreenObject.GetEmployeePayrollInfo(SelectedEmpID, 0, this.ScreenObject.DocDate.Date, 0);
                if (this.dsData.Tables.length < 0) {
                    this.DisplayMessage = "No Employee record found";

                }
            }

            else if (this.ScreenObject.DocumentType == 61) //Vacation Management
            {
                this.dsData = this.ScreenObject.GetPayrollComponents(4, SelectedEmpID, 0, this.ScreenObject.DocDate.Date);
                if (this.dsData.Tables.length > 0) {
                    if (this.dsData.Tables[0].length <= 0) {
                        this.DisplayMessage = "No record found";
                    }
                    else {
                        if (this.dsData.Tables[0].length > 0) {
                            this.DisplayMessage = "";
                            this.MessageVisibility = false;

                            let drGrid = null;
                            let RowPosition = 0;
                            drGrid = null;
                            this.ScreenObject.GridDataObj.Clear();
                            let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                            for (let k = 0; k < this.dsData.Tables[0].length; k++) {
                                drGrid = this.ScreenObject.GridDataObj.NewRow();
                                this.ScreenObject.GridData.InsertAt(drGrid, RowPosition);
                                RowPosition++;
                                if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"]))
                                    drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];

                                drGrid["dcAlpha17"] = this.dsData.Tables[0][k]["NODEID"];
                                drGrid["dcNum1"] = this.dsData.Tables[0][k]["PERCENTAGE"];
                            }
                            this.ScreenObject.GridDataObj.refreshDataView();
                        }
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 65) //Join From Vacation
            {
                this.ScreenObject.GridDataObj.Clear();

                let iLeaveCompID = 0;
                let fldDat = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
                if (fldDat instanceof PactListBoxData)
                    iLeaveCompID = fldDat.SelectedValue;

                if (SelectedEmpID > 1 && iLeaveCompID > 0) {
                    this.dsData = this.ScreenObject.GetEmployeePayrollInfo(SelectedEmpID, 2, this.ScreenObject.DocDate.Date, iLeaveCompID);
                    if (this.dsData.Tables.length > 0) {
                        if (this.dsData.Tables[0].length <= 0) {
                            this.DisplayMessage = "Employee Vacation/Leave Details Not Found";

                        }
                        else {
                            if (this.dsData.Tables[0].length > 0) {
                                this.DisplayMessage = "";
                                this.MessageVisibility = false;

                                let drGrid = null;
                                let RowPosition = 0;
                                drGrid = null;
                                let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                                for (let k = 0; k < this.dsData.Tables[0].length; k++) {
                                    drGrid = this.ScreenObject.GridDataObj.NewRow();
                                    this.ScreenObject.GridData.InsertAt(drGrid, RowPosition);
                                    RowPosition++;
                                    if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"]))
                                        drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];

                                    drGrid["dcAlpha1"] = Util.ParseDate(this.dsData.Tables[0][k]["FROMDATE"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                    drGrid["dcAlpha1_Key"] = Util.ParseDate(this.dsData.Tables[0][k]["FROMDATE"]);
                                    drGrid["dcAlpha2"] = Util.ParseDate(this.dsData.Tables[0][k]["TODATE"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                    drGrid["dcAlpha2_Key"] = Util.ParseDate(this.dsData.Tables[0][k]["TODATE"]);
                                    drGrid["dcAlpha5"] = parseFloat(this.dsData.Tables[0][k]["DOCID"]);
                                    drGrid["LinkedInvDocDetailsID"] = parseFloat(this.dsData.Tables[0][k]["INVDOCDETAILSID"]);
                                }
                                this.ScreenObject.GridDataObj.refreshDataView();
                            }
                        }
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 71) //Post Past Salary Details
            {
                let fldROD = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha1") as PactExtraFieldDateData;
                if (fldROD)
                    this.dsData = this.ScreenObject.GetEmployeePayrollInfo(SelectedEmpID, 1, Util.ParseDate(fldROD.Date), 0);
                else
                    this.dsData = this.ScreenObject.GetEmployeePayrollInfo(SelectedEmpID, 1, this.ScreenObject.DocDate.Date, 0);

                if (this.dsData.Tables.length > 0) {
                    if (this.dsData.Tables[0].length > 0) {
                        if (parseInt(this.dsData.Tables[0][0]["VALIDEMP"]) <= 0) {
                            this.DisplayMessage = "Employee is not valid for the current fiscal year period";
                            this.ReadOnlyBody = true;

                            this.PostSalaryDocResetColumns();
                            this.FillEarnDeductDetails(1, fldROD ? parseInt(Util.ParseDate(fldROD.Date).ToString("yyyy")) : parseInt(this.ScreenObject.DocDate.Date.ToString("yyyy")));
                        }
                        else {
                            this.DisplayMessage = "";
                            this.MessageVisibility = false;
                            this.ReadOnlyBody = false;
                            this.SetMonthNames(fldROD ? parseInt(Util.ParseDate(fldROD.Date).ToString("yyyy")) : parseInt(this.ScreenObject.DocDate.Date.ToString("yyyy")));
                            this.SetNoofMonths(this.dsData);

                            let drGrid = null;
                            let RowPosition = 0;
                            let dsData2 = this.ScreenObject.GetPayrollComponents(2, 1, SelectedEmpID, this.ScreenObject.DocDate.Date);
                            dsData2.Tables[0].sort((a, b) => a.ParentID - b.ParentID)//asc
                            if (dsData2.Tables.length > 0) {
                                if (dsData2.Tables[0].length > 0) {
                                    drGrid = null;
                                    this.ScreenObject.GridDataObj.Clear();
                                    let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                                    for (let k = 0; k < dsData2.Tables[0].length; k++) {
                                        drGrid = this.ScreenObject.GridDataObj.NewRow();
                                        this.ScreenObject.GridData.InsertAt(drGrid, RowPosition);
                                        RowPosition++;
                                        if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"]))
                                            drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];

                                        drGrid["dcAlpha2"] = dsData2.Tables[0][k]["NODEID"];
                                        drGrid["dcAlpha15"] = parseInt(dsData2.Tables[0][k]["ParentID"]) == 2 ? "Earnings" : "Deductions";
                                    }
                                    this.ScreenObject.GridDataObj.refreshDataView();
                                }
                            }

                        }
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 72) //Apply Vacation
            {
                this.ShowVacationCreditDaysDetail(SelectedEmpID);

                // this.dsData = this.ScreenObject.GetVacationDetails(SelectedEmpID, Util.ParseDate(this.ScreenObject.DocDate.Date));
                // if (this.dsData.Tables.length > 0) {
                //     //CLEAR ALL HEADER TEXT FIELDS
                //     this.ScreenObject._TextFields.forEach(item => {
                //         if (item.DBColumnName.startsWith("dcAlpha") && parseInt(item.DBColumnName.replace("dcAlpha", "")) <= 50) {
                //             if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase().Contains("dcalpha"))
                //                 item.Text = "";
                //             if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase() == "dcalpha14")
                //                 item.IsReadOnly = true;
                //         }
                //     });

                //     this.DisplayMessage = this.ApplyVacationValidationMsg(this.dsData);
                //     if (this.DisplayMessage != "") {
                //         if (this.DisplayMessage.Contains("#FLAG#"))
                //         {
                //             var DimLTfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                //             if (DimLTfld != null && DimLTfld != undefined && DimLTfld instanceof PactListBoxData)
                //             {
                //                 DimLTfld.DefaultValue = "";
                //                 DimLTfld.SelectedValue = 0;
                //             }
                //             else if (DimLTfld != null && DimLTfld != undefined && DimLTfld instanceof PactCodeNameListBoxData)
                //             {
                //                 DimLTfld.DefaultValue = "";
                //                 DimLTfld.SelectedValue = 0;
                //             }
                //             this.ShowVacationCreditDaysDetail(0);
                //             this.DisplayMessage = this.DisplayMessage.Replace("#FLAG# \r\n", " ");
                //         }
                //         this.MessageVisibility = true;
                //         return;
                //     }

                //     //LOADING COMPONENTS
                //     if (this.dsData.Tables[3].length > 0) {
                //         let FieldType1 = [];
                //         this.ScreenObject.GridDataObj.Clear();

                //         let fldPSD2 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha21");
                //         if (fldPSD2) {
                //             for (let i = 0; i <= this.dsData.Tables[3].length - 1; i++) {
                //                 FieldType1.push(ComboBoxItems.ComboBoxItems_2(this.dsData.Tables[3][i]["NAME"].toString(), this.dsData.Tables[3][i]["NODEID"].toString()));
                //             }
                //             fldPSD2.DisplayMember = "Name";
                //             fldPSD2.ValueMember = "Value";
                //             fldPSD2.ComboData = FieldType1;
                //         }
                //     }
                //     if (this.dsData.Tables[4].length > 0) {
                //         let FieldType = [];
                //         let drGrid = null;
                //         let drCL1 = null;
                //         let RowPosition = 0;
                //         let fldPSD1 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha20");
                //         if (fldPSD1) {
                //             for (let i = 0; i <= this.dsData.Tables[4].length - 1; i++) {
                //                 FieldType.push(ComboBoxItems.ComboBoxItems_2(this.dsData.Tables[4][i]["NAME"].toString(), this.dsData.Tables[4][i]["NODEID"].toString()));
                //             }
                //             fldPSD1.DisplayMember = "Name";
                //             fldPSD1.ValueMember = "Value";
                //             fldPSD1.ComboData = FieldType;
                //         }

                //         drGrid = null;
                //         let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                //         for (let k = 0; k < this.dsData.Tables[4].length; k++) {
                //             drGrid = this.ScreenObject.GridDataObj.NewRow();
                //             this.ScreenObject.GridData.InsertAt(drGrid, RowPosition);
                //             RowPosition++;
                //             if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"]))
                //                 drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];

                //             drGrid["dcAlpha20"] = this.dsData.Tables[4][k]["NODEID"];
                //             drCL1 = this.dsData.Tables[4].filter(x => x.NODEID == parseInt(drGrid["dcAlpha20"]));
                //             drGrid["dcAlpha21"] = drCL1[0]["PARENTID"];
                //         }
                //         this.ScreenObject.GridDataObj.refreshDataView();
                //     }

                //     //ASSINGING OPVACATION DAYS AND OPVACATION SALARY
                //     if (this.dsData.Tables[5].length > 0) {

                //         let dtVac:any = BaseService.common.GetDataTable("DOC057", SelectedEmpID.toString());

                //         let dsVacdays:any = null;
                //         let dRemDays = 0;
                //         if (dtVac != null && dtVac.length > 0)
                //         {
                //             if (Util.ParseDate(dtVac[0]["REJOINDATE"]) <= Util.ParseDate(dtVac[0]["TODATE"]))
                //             {
                //                 dsVacdays = this.ScreenObject.GetVacationDays(Util.ParseDate(dtVac[0]["FROMDATE"]), Util.ParseDate(dtVac[0]["REJOINDATE"]).AddDays(-1), SelectedEmpID, parseInt(dtVac[0]["DOCID"]), parseFloat(dtVac[0]["OpeningBalance"]), 0);

                //                 if (dsVacdays != null && dsVacdays.Tables.length > 0)
                //                 {
                //                     dRemDays = parseFloat(dsVacdays.Tables[1][0]["REMAININGDAYS"]);
                //                 }
                //             }
                //         }

                //         let fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha22");
                //         if (fldAPV instanceof PactTextBoxData) {
                //             if (parseFloat(this.dsData.Tables[5][0]["OPVACATIONDAYS"]) < 0 && BaseService.SessionManager.Preferences.ContainsKey("DonotshownegitiveOPvacationdays") && parseBoolean(BaseService.SessionManager.Preferences["DonotshownegitiveOPvacationdays"] == "True"))
                //                 fldAPV.Text = (0).ToString("0.00");
                //             else
                //             {
                //                 if (dRemDays > 0)
                //                 fldAPV.Text = dRemDays.ToString("0.00");
                //                 else
                //                 fldAPV.Text = parseFloat(this.dsData.Tables[5][0]["OPVACATIONDAYS"]).ToString("0.00");
                //             }
                //         }

                //         fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
                //         if (fldAPV instanceof PactTextBoxData)
                //             fldAPV.Text = parseFloat(this.dsData.Tables[5][0]["OPVACATIONSALARY"]).ToString("0.00");

                //         fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                //         if (fldAPV instanceof PactTextBoxData)
                //             fldAPV.IsReadOnly = true;

                //     }
                // }
            }
            else if (this.ScreenObject.DocumentType == 78) //TDS
            {
                let Year = 0;
                let fldTDE = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                if (fldTDE instanceof PactComboBoxData && !Util.IsEmpty(fldTDE.SelectedValue)) {
                    Year = parseInt(fldTDE.SelectedValue);
                }
                else {
                    this.DisplayMessage = "Please select the year";
                    return;
                }
                this.FillTdsMonthlyandQuarterlyDetails(0, this._Ddate, SelectedEmpID, Year);
            }
            else if (this.ScreenObject.DocumentType == 68) //Recording of Data
            {
                let FieldType = [];
                let fldROD = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha2") as PactExtraFieldDateData;
                if (fldROD)
                    this.dsData = this.ScreenObject.GetPayrollComponents(0, 1, SelectedEmpID, Util.ParseDate(fldROD.Date));

                if (this.dsData.Tables.length > 0) {
                    let fldROD1 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha1");
                    if (fldROD1) {
                        if (this.dsData.Tables[0].length > 0) {
                            for (let i = 0; i <= this.dsData.Tables[0].length - 1; i++) {
                                FieldType.push(ComboBoxItems.ComboBoxItems_2(this.dsData.Tables[0][i]["NAME"].toString(), this.dsData.Tables[0][i]["NODEID"].toString()));
                            }
                            fldROD1.DisplayMember = "Name";
                            fldROD1.ValueMember = "Value";
                            fldROD1.ComboData = FieldType;
                        }
                    }

                    let fldROD2 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha3");
                    if (fldROD2) {
                        fldROD2.DisplayMember = "NAME";
                        fldROD2.ValueMember = "NODEID";
                        fldROD2.ComboData = this.dsData.Tables[1];
                        fldROD2.FilterColumn = "dcAlpha1";
                        fldROD2.FilterCondition = "PARENTID={0}";
                      /**  fldROD2.FilteredItems = fldROD2.ComboData.filter(x=>x.PARENTID == 0)
                        fldROD2.setFilteredItems(this.ScreenObject.ColumnSource,fldROD2.FilterCondition,fldROD2.ComboData);
                     **/}
                }
            }
            else if (this.ScreenObject.DocumentType == 80) //Dues Entry
            {
                let FieldType = [];
                this.dsData = this.ScreenObject.GetPayrollComponents(7, 0, SelectedEmpID, this.ScreenObject.DocDate.Date);
                if (this.dsData.Tables.length > 0) {
                    let fldDue1 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha1");
                    if (fldDue1) {
                        if (this.dsData.Tables[0].length > 0) {
                            for (let i = 0; i <= this.dsData.Tables[0].length - 1; i++) {
                                FieldType.push(ComboBoxItems.ComboBoxItems_2(this.dsData.Tables[0][i]["NAME"].toString(), this.dsData.Tables[0][i]["NODEID"].toString()));
                            }
                            fldDue1.DisplayMember = "Name";
                            fldDue1.ValueMember = "Value";
                            fldDue1.ComboData = FieldType;
                        }
                    }

                    let fldDue2 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha2");
                    if (fldDue2) {
                        fldDue2.DisplayMember = "NAME";
                        fldDue2.ValueMember = "NODEID";
                        fldDue2.ComboData = this.dsData.Tables[1];//.AsDataView();
                        fldDue2.FilterColumn = "dcAlpha1";
                        fldDue2.FilterCondition = "PARENTID={0}";
                    }
                }
            }
        }
    }

    // Name : ApplyVacationValidationMsg
    // Desc : Apply Vacation Validation Msg.
    // Category : PAYROLL
    ApplyVacationValidationMsg(dsAPV: any): string {
        let strApplyVacationValidatinMsg = "";
        if (dsAPV.Tables[0].length > 0 && !Util.IsEmpty(dsAPV.Tables[0][0]["VacationdaysMessage"]))
            strApplyVacationValidatinMsg = dsAPV.Tables[0][0]["VacationdaysMessage"].toString() + " \r\n";

        if (dsAPV.Tables[1].length > 0 && !Util.IsEmpty(dsAPV.Tables[1][0]["VacationPreferencesMessage"])) {
            strApplyVacationValidatinMsg = strApplyVacationValidatinMsg + dsAPV.Tables[1][0]["VacationPreferencesMessage"].toString() + " \r\n";
        }
        else if (dsAPV.Tables[1].length > 0 && parseInt(dsAPV.Tables[1][0]["VacationField"]) > 0 && Util.IsEmpty(dsAPV.Tables[1][0]["VacationPreferencesMessage"])) {
            let DimVacfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
            if (DimVacfld && DimVacfld instanceof PactListBoxData) {
                DimVacfld.SelectedValue = parseInt(dsAPV.Tables[1][0]["VacationField"]);
            }
        }

        if (dsAPV.Tables[2].length > 0 && !Util.IsEmpty(dsAPV.Tables[2][0]["VacationMessage"]))
            strApplyVacationValidatinMsg = strApplyVacationValidatinMsg + dsAPV.Tables[2][0]["VacationMessage"].toString() + " \r\n";

        if (dsAPV.Tables[7].length > 0 && !Util.IsEmpty(dsAPV.Tables[7][0]["VacationUnderApprovalMessage"]))
            strApplyVacationValidatinMsg = strApplyVacationValidatinMsg + dsAPV.Tables[7][0]["VacationUnderApprovalMessage"].toString() + " \r\n";

        return strApplyVacationValidatinMsg;
    }

    ConsolidateLeaveMonth() {
        if (this.ScreenObject.DocumentType == 63) {
            let Docfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha1");
            if (Docfld instanceof PactExtraFieldDateData) {
                Docfld.Date = new Date();
                Docfld.CustomFormat = "MMM/yyyy";
            }
        }
        else if (this.ScreenObject.DocumentType == 89 || this.ScreenObject.DocumentType == 90) //Attendance & Time Sheet
        {
            let vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha32");
            if (vFld instanceof PactComboBoxData) {
                if (vFld.SelectedValue == "Manual") {
                    this.ScreenObject._TextFields.forEach(item => {
                        if (item.DBColumnName.toLowerCase() == "dcalpha26")
                            item.IsReadOnly = true;
                        else if (item.DBColumnName.toLowerCase() == "dcalpha27")
                            item.Enable = false;
                    });
                    this.SetButtonVisibility("Save", true);
                    this.SetButtonVisibility("SaveAndPrint", true);
                    this.SetButtonVisibility("Check-in", false);
                    this.SetButtonVisibility("Check-out", false);
                }
                else {
                    this.ScreenObject._TextFields.forEach(item => {
                        if (item.DBColumnName.toLowerCase() == "dcalpha26")
                            item.IsReadOnly = false;
                        else if (item.DBColumnName.toLowerCase() == "dcalpha27")
                            item.Enable = true;
                    });
                    this.SetButtonVisibility("Save", false);
                    this.SetButtonVisibility("SaveAndPrint", false);
                    this.SetButtonVisibility("Check-in", true);
                    this.SetButtonVisibility("Check-out", true);
                }

            }
        }
        else if (this.ScreenObject.DocumentType == 56) {
            let Docfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha5"); //Deduction Month
            if (Docfld instanceof PactExtraFieldDateData) {
                Docfld.Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                Docfld.CustomFormat = "MMM/yyyy";
            }
        }
        else if (this.ScreenObject.DocumentType == 69 || this.ScreenObject.DocumentType == 86 || this.ScreenObject.DocumentType == 91 || this.ScreenObject.DocumentType == 98)
            this.BodyVisible = false;

        else if (this.ScreenObject.DocumentType == 92) //Payroll - Shift Assign
        {
            let vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
            if (vFld) {
                if (this.DocID > 0)
                    vFld.IsReadOnly = true;
                else
                    vFld.IsReadOnly = false;
            }
            this.iDtColFrom = this.iDtColUpto = -1;
            let FromDate = this.ScreenObject.CustomTab.Pages[0].Fields.find(x => x instanceof PactExtraFieldDateData && x.DBColumnName == "dcAlpha1");
            let ToDate = this.ScreenObject.CustomTab.Pages[0].Fields.find(x => x instanceof PactExtraFieldDateData && x.DBColumnName == "dcAlpha2");

            if (this.ScreenObject.DocID > 0)
                FromDate.Enable = ToDate.Enable = false;
            else
                FromDate.Enable = ToDate.Enable = true;

            for (let i = this.ScreenObject.ColumnSource.length - 1; i >= 0; i--) {
                if (this.ScreenObject.ColumnSource[i].DrRefColName != null && this.ScreenObject.ColumnSource[i].DrRefColName != "" && this.ScreenObject.ColumnSource[i].DrRefColName == "Date") {
                    if (this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.ColumnSource[i].DisplayMember))
                        this.ScreenObject.GridDataColumns.Remove(this.ScreenObject.ColumnSource[i].DisplayMember);
                    if (this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.ColumnSource[i].DisplayMember + "_Key"))
                        this.ScreenObject.GridDataColumns.Remove(this.ScreenObject.ColumnSource[i].DisplayMember + "_Key");

                    this.ScreenObject.ColumnSource.RemoveAt(i);
                }

            }

            let shiftAssCols: DgColumn[] = []
            for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
                shiftAssCols.push(this.ScreenObject.ColumnSource[i]);
            }
            this.ScreenObject.ColumnSource = shiftAssCols;
            this.ScreenObject.GridDataObj.RefreshColumns()
        }
        else if (this.ScreenObject.DocumentType == 68) {
            let fldAPV2: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
            if (fldAPV2 != null && fldAPV2 != undefined)
                fldAPV2.IsReadOnly = false;
        }

    }

    // Name : SetNewDocFields
    // Desc : Set All Document fields to new.
    // Category : COMMON
    SetNewDocFields() {
        if (this.ScreenObject.DocumentType == 58 || this.ScreenObject.DocumentType == 65 || this.ScreenObject.DocumentType == 71 || this.ScreenObject.DocumentType == 72 || this.ScreenObject.DocumentType == 78 || this.ScreenObject.DocumentType == 68 || this.ScreenObject.DocumentType == 80) {
            this.ScreenObject._CCFields.forEach(item => {
                if (item instanceof PactListBoxData)
                    item.OnPactListBoxValueChanged.Subscribe(this.ScreenObject, "OnGetReference");

                if (this.ScreenObject.DocumentType == 72) //Apply Vacation
                {
                    if (this.ScreenObject.Preferences.ContainsKey("ShowVacationCreditDaysDetail") && !Util.IsEmpty(this.ScreenObject.Preferences["ShowVacationCreditDaysDetail"]) && parseBoolean(this.ScreenObject.Preferences["ShowVacationCreditDaysDetail"])) {
                        this.ReportInfoVisibility = false;
                    }
                    else {
                        this.ReportInfoVisibility = true;
                    }
                    let fld: PactExtraFieldDateData = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha25") as PactExtraFieldDateData;
                    if (fld) {
                        fld.CustomFormat = "MMM/yyyy";
                        fld.Date = new Date().MonthsFirst();
                    }
                    this.ScreenObject._TextFields.forEach(item1 => {
                        // //FROMDATE
                        // if (item1 instanceof PactExtraFieldDateData && ((PactExtraFieldDateData)item1).DBColumnName.toLowerCase() == "dcalpha2")
                        //     ((PactExtraFieldDateData)item1).SelectedDateChanged = new DelegateCommand<object>(ApplyVacationFrom);

                        // //TODATE
                        // if (item1 instanceof PactExtraFieldDateData && ((PactExtraFieldDateData)item1).DBColumnName.toLowerCase() == "dcalpha3")
                        //     ((PactExtraFieldDateData)item1).SelectedDateChanged = new DelegateCommand<object>(ApplyVacation);

                        // //IS ENCASH LEAVES
                        // if (item1 instanceof PactComboBoxData && item1.DBColumnName.toLowerCase() == "dcalpha16")
                        //     item1.SelectionChangedCommand = new DelegateCommand<string>(ApplyVacationIsEncash);

                        // //EncashRemainingDays
                        // if (item1 instanceof PactComboBoxData && item1.DBColumnName.toLowerCase() == "dcalpha13")
                        //     item1.SelectionChangedCommand = new DelegateCommand<string>(ApplyVacationIsEncash);

                        // //ENCASH REMAINING DAYS
                        // if (item1 instanceof PactTextBoxData && ((PactTextBoxData)item1).DBColumnName.toLowerCase() == "dcalpha14")
                        //     ((PactTextBoxData)item1).LostFocusCommand = new DelegateCommand<object>(ApplyVacationIsTextEncash);

                        // //PAY EXCESS DAYS
                        // if (item1 instanceof PactComboBoxData && item1.DBColumnName.toLowerCase() == "dcalpha15")
                        //     item1.SelectionChangedCommand = new DelegateCommand<string>(ApplyVacationExcessdays);
                        // //  
                    });

                    this.FillEarningsDeductions(0, this.ScreenObject.DocDate.Date);
                    this.ShowVacationCreditDaysDetail(0);
                }
            });
        }

        if (this.ScreenObject.DocumentType == 61) //Vacation Management
        {
            this.ScreenObject._CCFields.forEach(item => {
                if (item instanceof PactListBoxData && item.DBColumnName.toLowerCase() == "dcccnid53")
                    item.OnPactListBoxValueChanged.Subscribe(this.ScreenObject, "OnGetReference");
            });
            this.ScreenObject._TextFields.forEach(item => {
                if (item instanceof PactListBoxData && item.DBColumnName.toLowerCase() == "dcalpha1")
                    item.OnPactListBoxValueChanged.UnSubscribe();

                if (item instanceof PactListBoxData && item.DBColumnName.toLowerCase() == "dcalpha5")
                    item.OnPactListBoxValueChanged.UnSubscribe();
            });
            this.FillVacationManagementComponents();
        }
        else if (this.ScreenObject.DocumentType == 5) //Stock Transfer
        {
            ;
            this.ScreenObject._CCFields.forEach(item => {
                if (item instanceof PactListBoxData && item.CCID > 50000 && item.DBColumnName.Contains("TO")) {
                    var TodependantFields = this.ScreenObject._CCFields.filter(a => a.DependantOn != null && a.DependantOn.toLowerCase() == item.DBColumnName.Replace("TO", "").toLowerCase());
                    TodependantFields.forEach(Titem => {
                        if (Titem instanceof PactListBoxData && Titem.CCID > 50000 && Titem.DBColumnName.Contains("TO"))
                            item.OnPactListBoxValueChanged.Subscribe(this.ScreenObject, "OnGetReference");
                    });
                }
            });
        }
        else if (this.ScreenObject.DocumentType == 67) //Daily Attendance
        {
            let dsDAStr = BaseService.common.GetDataSet("PAY037", this.ScreenObject.CostCenterID.toString());

            if (dsDAStr != null && dsDAStr.Tables[0].length == 0) {
                this.DisplayMessage = "Please Enable Payroll Document Fields from Global Preferences (Payroll Tab)";
                this.ReadOnlyBody = true;
                return;
            }

            let fldDat = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if ((fldDat instanceof PactListBoxData) || (fldDat instanceof PactCodeNameListBoxData)) {
                fldDat.KeyTip = "";
                this.GetButton("All Employees").Visible = false;
                this.GetButton("Get Previous Day").Visible = false;

                this.GetButton("Fill Dates").Visible = true;
                this.GetButton("Fill General Timings").Visible = true;
            }

            let fldDat2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcccnid51");
            if (fldDat2 != null) {
                this.GetButton("All Employees").Visible = true;
                this.GetButton("Get Previous Day").Visible = true;

                this.GetButton("Fill Dates").Visible = false;
                this.GetButton("Fill General Timings").Visible = false;
            }

            fldDat = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
            if (fldDat instanceof PactExtraFieldDateData)
                fldDat.KeyTip = "";

            if (BaseService.SessionManager.Preferences.ContainsKey("BreakHoursImpactToOTS") && parseBoolean(BaseService.SessionManager.Preferences["BreakHoursImpactToOTS"] == "True")) {
                let fldDat1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcNum4");
                if (fldDat1)
                    fldDat1.ReadOnly = false;
            }
            if (BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && parseBoolean(BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True")) {
                let fldDat1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcNum4");
                if (fldDat1)
                    fldDat1.ReadOnly = false;
                let fldDat5 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcNum5");
                if (fldDat5)
                    fldDat5.ReadOnly = false;
                let fldDat7 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcNum7");
                if (fldDat7)
                    fldDat7.ReadOnly = false;
                let fldDat9 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcNum9");
                if (fldDat9)
                    fldDat9.ReadOnly = false;
                let fldDat11 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcNum11");
                if (fldDat11)
                    fldDat11.ReadOnly = false;
                let fldDat13 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcNum13");
                if (fldDat13)
                    fldDat13.ReadOnly = false;
            }
            this.GetButton("Employee Filter").Visible = true;
            this.GetButton("Set Columns").Visible = true;
        }
        else if (this.ScreenObject.DocumentType == 68) //Recording Of Data
        {
            let fldROD = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha2") as PactExtraFieldDateData;
            if (fldROD != undefined) {
                fldROD.Date = Util.ParseDate(BaseService.SessionManager.PayrollMonth);//.ToString(BaseService.SessionManager.Preferences["Date Format"]));
                fldROD.CustomFormat = "MMM/yyyy";
            }

            fldROD = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha4") as PactExtraFieldDateData;
            if (fldROD != undefined) {
                fldROD.Date = Util.ParseDate(BaseService.SessionManager.PayrollMonth);//.ToString(BaseService.SessionManager.Preferences["Date Format"]));
                fldROD.CustomFormat = "MMM/yyyy";
            }

            let FieldType = [];
            this.dsData = this.ScreenObject.GetPayrollComponents(0, 1, 0, Util.ParseDate(BaseService.SessionManager.PayrollMonth));
            if (this.dsData.Tables.length > 0) {
                let fldROD1 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha1");
                if (fldROD1) {
                    if (this.dsData.Tables[0].length > 0) {

                        let dvROD: any = null;
                        dvROD = this.dsData.Tables[0];
                        let drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == fldROD1.ValueBinding);
                        if (drc1 != null && drc1.length > 0 &&
                            !Util.IsEmpty(drc1[0]["UserProbableValues"]) && drc1[0]["UserProbableValues"].toString().Trim() != "") {
                            dvROD = dvROD.filter(x => x.NodeID == drc1[0]["UserProbableValues"]);
                        }

                        if (dvROD.length > 0) {
                            for (let i = 0; i <= dvROD.length - 1; i++) {
                                FieldType.push(ComboBoxItems.ComboBoxItems_2(dvROD[i]["NAME"].toString(), dvROD[i]["NODEID"].toString()));
                            }
                            fldROD1.DisplayMember = "Name";
                            fldROD1.ValueMember = "Value";
                            fldROD1.ComboData = FieldType;
                        }

                    }
                }

                let fldROD2 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha3");
                if (fldROD2) {
                    fldROD2.DisplayMember = "NAME";
                    fldROD2.ValueMember = "NODEID";
                    fldROD2.ComboData = this.dsData.Tables[1];
                    fldROD2.FilterColumn = "dcAlpha1";
                    fldROD2.FilterCondition = "PARENTID={0}";

                    let drc1: any = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == fldROD2.ValueBinding);
                    if (drc1 != null && drc1.length > 0 &&
                        !Util.IsEmpty(drc1[0]["UserProbableValues"]) && drc1[0]["UserProbableValues"].toString().Trim() != "") {
                        fldROD2.FilterCondition += " AND NodeID IN(" + drc1[0]["UserProbableValues"] + ")";
                    }
                }
            }
        }
        else if (this.ScreenObject.DocumentType == 86) //Time off Request
        {
            let fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha2");
            if (fld instanceof PactDateTimeData) {
                fld.CustomFormat = "HH:mm";
                fld.Date = new Date();
            }

            fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha3");
            if (fld instanceof PactDateTimeData) {
                fld.CustomFormat = "HH:mm";
                fld.Date = new Date();
            }

            let per = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha3");
            if (per)
                this.onDateChanged(per);
        }
        else if (this.ScreenObject.DocumentType == 85) // Bulk Appraisals
        {
            let fld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha1");
            if (fld) {
                fld.CustomFormat = "MMM/yyyy";
                fld.Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            }

            fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha2");
            if (fld) {
                fld.CustomFormat = "MMM/yyyy";
                fld.Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            }
            fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha4");
            if (fld) {
                fld.CustomFormat = "MMM/yyyy";
                fld.Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            }
            let btn = this.GetButton("Employee Filter");
            if (btn)
                btn.Visible = true;
        }
        else if (this.ScreenObject.DocumentType == 58) // Leave Encashment
        {
            let fld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha10");
            if (fld) {
                fld.CustomFormat = "MMM/yyyy";
                fld.Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            }
        }
        else if (this.ScreenObject.DocumentType == 79) // Attendance Dimension Wise
        {
            let fld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha1");
            if (fld) {
                fld.Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            }
        }
        else if (this.ScreenObject.DocumentType == 70) //Checklist
        {
            if (BaseService.SessionManager.Preferences.ContainsKey("EmpChecklistDimension") && (BaseService.SessionManager.Preferences["EmpChecklistDimension"].toString() == "0" || BaseService.SessionManager.Preferences["EmpChecklistDimension"].toString() == "")) {
                this.DisplayMessage = "Please set the Checklist Preference";
                return;
            }
            this.ScreenObject.ColumnSource.forEach(item => {
                if (item.DisplayMember != null && item.DisplayMember != "" && item.DisplayMember.toLowerCase().Contains("dcalpha") && item.DataType == "DATE")
                    item.DefaultValue = "today";
            });
            let FieldType = [];
            this.dsData = this.ScreenObject.GetPayrollComponents(1, 0, 0, this.ScreenObject.DocDate.Date);
            if (this.dsData.Tables.length > 0) {
                let fldChklist = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha3");
                if (fldChklist) {
                    if (this.dsData.Tables[0].length > 0) {
                        for (let i = 0; i <= this.dsData.Tables[0].length - 1; i++) {
                            FieldType.push(ComboBoxItems.ComboBoxItems_2(this.dsData.Tables[0][i]["NAME"].toString(), this.dsData.Tables[0][i]["NODEID"].toString()));
                        }
                        fldChklist.DisplayMember = "NAME";
                        fldChklist.ValueMember = "NODEID";
                        fldChklist.ComboData = this.dsData.Tables[0];//.AsDataView();
                    }
                }

                let fldChklist2 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha1");
                if (fldChklist2) {
                    fldChklist2.DisplayMember = "NAME";
                    fldChklist2.ValueMember = "NODEID";
                    fldChklist2.ComboData = this.dsData.Tables[1];//.AsDataView();
                    fldChklist2.FilterColumn = "dcAlpha3";
                    fldChklist2.FilterCondition = "PARENTID={0}";
                }
            }
        }
        else if (this.ScreenObject.DocumentType == 71) //Post Past Salary Details
        {
            let fldROD = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha1") as PactExtraFieldDateData;
            if (fldROD && fldROD instanceof PactExtraFieldDateData)
                fldROD.SelectedDateChanged.Subscribe(this, "FillPostPastSalEarningDeductionDtls");
            this.FillEarnDeductDetails(0, parseInt(Util.ParseDate(this.ScreenObject.DocDate.Date).ToString("yyyy")));
        }
        else if (this.ScreenObject.DocumentType == 73) //Leave Adjustment As Vacation
        {
            this.ScreenObject._CCFields.forEach(item => {
                if (item instanceof PactListBoxData && item.DBColumnName.toLowerCase() == "dcccnid51")
                    item.OnPactListBoxValueChanged.Subscribe(this.ScreenObject, "OnGetReference");

                if (item instanceof PactListBoxData && item.DBColumnName.toLowerCase() == "dcccnid52")
                    item.OnPactListBoxValueChanged.Subscribe(this.ScreenObject, "OnGetReference");
            });
        }
        else if (this.ScreenObject.DocumentType == 94) //Consider LOP to Service Days
        {
            this.ScreenObject._CCFields.forEach(item => {
                if (item instanceof PactListBoxData && item.DBColumnName.toLowerCase() == "dcccnid51")
                    item.OnPactListBoxValueChanged.Subscribe(this.ScreenObject, "OnGetReference");

                if (item instanceof PactListBoxData && item.DBColumnName.toLowerCase() == "dcccnid52")
                    item.OnPactListBoxValueChanged.Subscribe(this.ScreenObject, "OnGetReference");
            });
        }

        else if (this.ScreenObject.DocumentType == 75) //Gratuity Settings
            this.FillGratuitySettingsExpDetails();

        else if (this.ScreenObject.DocumentType == 76) //Form12BA
            this.FillForm12BALookupDetails();

        else if (this.ScreenObject.DocumentType == 77) //PAYROLL - LOCK/UNLOCK
            this.FillPayrollLockUnlockDetails(false);

        else if (this.ScreenObject.DocumentType == 81 || this.IsNewAssignLeave)//Assign Leaves
        {
            this.ScreenObject._TextFields.forEach(item => {
                if (item instanceof PactComboBoxData && item.DBColumnName.toLowerCase() == "dcalpha1")
                    item.SelectionChangedCommand.Subscribe(this, "LeavesBasedon");
            });
            //btnCopyLeaves = true;
        }
        else if (this.ScreenObject.DocumentType == 59)//Compensatory Leaves
        {
            if (BaseService.SessionManager.Preferences.ContainsKey("CompensatoryLeaveType") && BaseService.SessionManager.Preferences["CompensatoryLeaveType"].toString() == "") {
                this.DisplayMessage = "Please set the compensatory leave type preference";
            }
        }
        else if (this.ScreenObject.DocumentType == 80) {
            let FieldType = [];
            this.dsData = this.ScreenObject.GetPayrollComponents(7, 1, 0, this.ScreenObject.DocDate.Date);
            if (this.dsData.Tables.length > 0) {
                let fldDue1 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha1");
                if (fldDue1) {
                    if (this.dsData.Tables[0].length > 0) {
                        for (let i = 0; i <= this.dsData.Tables[0].length - 1; i++) {
                            FieldType.push(ComboBoxItems.ComboBoxItems_2(this.dsData.Tables[0][i]["NAME"].toString(), this.dsData.Tables[0][i]["NODEID"].toString()));
                        }
                        fldDue1.DisplayMember = "Name";
                        fldDue1.ValueMember = "Value";
                        fldDue1.ComboData = FieldType;
                    }
                }

                let fldDue2 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha2");
                if (fldDue2) {
                    fldDue2.DisplayMember = "NAME";
                    fldDue2.ValueMember = "NODEID";
                    fldDue2.ComboData = this.dsData.Tables[1];//.AsDataView();
                    fldDue2.FilterColumn = "dcAlpha1";
                    fldDue2.FilterCondition = "PARENTID={0}";
                }
            }
        }

        //For Employee and Leave Type Filter
        if (this.DialogResult && (this.ScreenObject.DocumentType == 51 || this.ScreenObject.DocumentType == 52 || this.ScreenObject.DocumentType == 53 || this.ScreenObject.DocumentType == 55 ||
            this.ScreenObject.DocumentType == 56 || this.ScreenObject.DocumentType == 57 || this.ScreenObject.DocumentType == 58 || this.ScreenObject.DocumentType == 59 ||
            this.ScreenObject.DocumentType == 60 || this.ScreenObject.DocumentType == 61 || this.ScreenObject.DocumentType == 62 || this.ScreenObject.DocumentType == 63 ||
            this.ScreenObject.DocumentType == 65 || this.ScreenObject.DocumentType == 66 || this.ScreenObject.DocumentType == 67 || this.ScreenObject.DocumentType == 68 ||
            this.ScreenObject.DocumentType == 69 || this.ScreenObject.DocumentType == 70 || this.ScreenObject.DocumentType == 71 || this.ScreenObject.DocumentType == 72 ||
            this.ScreenObject.DocumentType == 73 || this.ScreenObject.DocumentType == 74 || this.ScreenObject.DocumentType == 75 || this.ScreenObject.DocumentType == 76 ||
            this.ScreenObject.DocumentType == 77 || this.ScreenObject.DocumentType == 78 || this.ScreenObject.DocumentType == 80 || this.ScreenObject.DocumentType == 85 ||
            this.ScreenObject.DocumentType == 86 || this.ScreenObject.DocumentType == 97 || this.ScreenObject.DocumentType == 79 || this.ScreenObject.DocumentType == 91 ||
            this.ScreenObject.DocumentType == 92)) {
            let strWhr = "";
            //ReportInfoVisibility = false;

            //FILTER EMPLOYEES
            if (this.ScreenObject.DocumentType == 67) //Daily Attendance
            {
                let bSF = true;
                if (this.srcDocument && this.srcDocument.toString() == "PostAttTimeSheet")
                    bSF = false;

                if (bSF)
                    this.strEmpFilter = strWhr = this.PopupEmployeesFilter("", "SetNewDocFields");
                else {
                    if (Util.IsEmpty(strWhr))
                        strWhr = this.FilterEmployees();
                }

                //strEmpFilter = strWhr = PopupEmployeesFilter("");
                // if (Util.IsEmpty(strWhr))
                //     strWhr = this.FilterEmployees();

                let dtCols = BaseService.common.GetDataSet("PAY038", this.ScreenObject.CostCenterID.toString()).Tables[0];
                let drcc1;

                if (BaseService.SessionManager.Preferences.ContainsKey("UseDailyAttRates")) {
                    for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
                        drcc1 = dtCols.filter(x => x.SysColumnName == this.ScreenObject.ColumnSource[i].DisplayMember);
                        if (drcc1 && drcc1.length > 0) {
                            this.ScreenObject.ColumnSource[i].IsVisible = (BaseService.SessionManager.Preferences["UseDailyAttRates"].toString() == "True") ? true : false;
                        }
                    }
                }

                //#region "Set Columns"
                let dsStructure = null;
                let dsRole = BaseService.common.GetDataSet3("PAY039", this.ScreenObject.CostCenterID.toString(), BaseService.SessionManager.RoleID);
                if (dsRole != null && dsRole.Tables[0].length > 0) {
                    dsStructure = BaseService.common.GetDataSet3("PAY040", this.ScreenObject.CostCenterID.toString(), BaseService.SessionManager.RoleID);
                }

                if (dsStructure != null && dsStructure.Tables.length > 0) {
                    for (let j = 0; j < dsStructure.Tables[0].length; j++) {
                        for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
                            if (this.ScreenObject.ColumnSource[i].DisplayMember.toString() == dsStructure.Tables[0][j]["SysColumnName"]) {
                                if (dsStructure.Tables[0][j]["ReadOnly"].toString() == "1")
                                    this.ScreenObject.ColumnSource[i].ReadOnly = true;
                                else
                                    this.ScreenObject.ColumnSource[i].ReadOnly = false;

                                this.ScreenObject.ColumnSource[i].Width = parseInt(dsStructure.Tables[0][j]["Width"]);

                                if (dsStructure.Tables[0][j]["Mandatory"].toString() == "1")
                                    this.ScreenObject.ColumnSource[i].Mandatory = true;
                                else
                                    this.ScreenObject.ColumnSource[i].Mandatory = false;

                                //if (dsStructure.Tables[0][j]["Visible"].toString() == "1")
                                //    this.ScreenObject.ColumnSource[i].IsVisible = true;
                                //else
                                //    this.ScreenObject.ColumnSource[i].IsVisible = false;

                                drcc1 = dtCols.filter(x => x.SysColumnName == this.ScreenObject.ColumnSource[i].DisplayMember);
                                if (drcc1 && drcc1.length > 0) {
                                    if (BaseService.SessionManager.Preferences["UseDailyAttRates"].toString() == "True") {
                                        if (dsStructure.Tables[0][j]["Visible"].toString() == "1")
                                            this.ScreenObject.ColumnSource[i].IsVisible = true;
                                        else
                                            this.ScreenObject.ColumnSource[i].IsVisible = false;
                                    }
                                    else {
                                        this.ScreenObject.ColumnSource[i].IsVisible = false;
                                    }
                                }
                                else {
                                    if (dsStructure.Tables[0][j]["Visible"].toString() == "1")
                                        this.ScreenObject.ColumnSource[i].IsVisible = true;
                                    else
                                        this.ScreenObject.ColumnSource[i].IsVisible = false;
                                }

                                this.ScreenObject.ColumnSource[i].DisplayIndex = parseInt(dsStructure.Tables[0][j]["IndexValue"]);
                            }
                        }
                    }
                    this.ScreenObject.ColumnSource.sort((a, b) => a.DisplayIndex - b.DisplayIndex);
                    this.ScreenObject.GridDataObj.RefreshColumns()
                }
                //#endregion
            }
            //else if (this.ScreenObject.DocumentType == 85) //Bulk Appraisals
            //{
            //    strEmpFilter = strWhr = PopupEmployeesFilter("");
            //    if (strWhr.toString() == "")
            //        strWhr = FilterEmployees();
            //}
            else
                strWhr = this.FilterEmployees();

            this.SetNewDocFieldsTemp(strWhr)

            //FILTER LEAVE TYPES
            if (this.ScreenObject.DocumentType == 58 || this.ScreenObject.DocumentType == 60 || this.ScreenObject.DocumentType == 61 || this.ScreenObject.DocumentType == 62 || this.ScreenObject.DocumentType == 73) {
                strWhr = "";
                if (this.ScreenObject.DocumentType == 61) //Vacation Management
                    strWhr = this.FilterLeaveTypes(1);
                else
                    strWhr = this.FilterLeaveTypes(0);

                let DimLTfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
                if (DimLTfld && DimLTfld instanceof PactListBoxData)
                    DimLTfld.CustomWhere = strWhr;
                else {
                    DimLTfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                    if (DimLTfld && DimLTfld instanceof PactListBoxData && DimLTfld.CCID == 50052)
                        DimLTfld.CustomWhere = strWhr;
                    else {
                        let DimLTBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50052);
                        if (DimLTBodyfld && DimLTBodyfld instanceof DgColumn)
                            DimLTBodyfld.FilterCondition = strWhr;
                    }
                }
            }

            if (this.ScreenObject.DocumentType == 56) //Apply Loan
            {
                let dsEmpStr = BaseService.common.GetDataSet("PAY041", BaseService.SessionManager.UserID);
                if (dsEmpStr && dsEmpStr.Tables[0].length > 0) {
                    this.strEmpIsMgr = dsEmpStr.Tables[0][0]["IsManager"].toString();
                    this.EmployeewiseDocumentView(40056, this.strEmpIsMgr, "False");
                }
            }

            if (this.ScreenObject.DocumentType == 92) //Payroll - Shift Assign
            {
                let FromDate = this.ScreenObject.CustomTab.Pages[0].Fields.find(x => x instanceof PactExtraFieldDateData && x.DBColumnName == "dcAlpha1") as PactExtraFieldDateData;
                let ToDate = this.ScreenObject.CustomTab.Pages[0].Fields.find(x => x instanceof PactExtraFieldDateData && x.DBColumnName == "dcAlpha2") as PactExtraFieldDateData;

                if (this.ScreenObject.DocID > 0)
                    FromDate.Enable = ToDate.Enable = false;
                else
                    FromDate.Enable = ToDate.Enable = true;

                let btn = this.GetButton("Fill Dates");
                if (btn) {
                    if (this.DocID == 0)
                        btn.Visible = true;
                    else
                        btn.Visible = false;
                }
            }
            if (this.ScreenObject.DocumentType == 97) //Lates Processing
            {
                let fld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha16");
                if (fld) {
                    fld.CustomFormat = "01/MMM/yyyy";
                    (fld as PactExtraFieldDateData).Date = BaseService.SessionManager.PayrollMonth;
                }
                fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha33");
                if (fld != undefined) {
                    fld.CustomFormat = "01/MMM/yyyy";
                    fld.Date = BaseService.SessionManager.PayrollMonth;
                }
                this.ScreenObject.GridDataObj.Clear();
                this.dtPayMon = BaseService.SessionManager.PayrollMonth;
            }
            if (this.DocumentType == 99)//this.ScreenObject.DocumentType == 99) //Regularization of Attendance
            {
                this.ScreenObject.GridDataObj.Clear();
            }
        }
    }


    // public OnToListViewSelectionChanged(sender: PactListBoxData) {
    //     ;
    //     if (this.ScreenObject.DocumentType == 5 && sender != null && sender.SelectedValue > 0) {
    //         let cWhere = "";
    //         var dependantFields = this.ScreenObject._CCFields.filter(a => a.DependantOn != null && a.DependantOn.toLowerCase() == sender.DBColumnName.Replace("TO", "").toLowerCase());
    //         dependantFields.forEach(item => {
    //             if (item instanceof PactListBoxData && item.CCID > 50000 && item.Dependancy == 3 && item.DBColumnName.Contains("TO")) {
    //                 cWhere = "";
    //                 cWhere = "  JOIN COM_CostCenterCostCenterMap CM with(nolock) on CM.ParentCostCenterID=" + item.CCID + ` and a.NodeID=CM.ParentNodeID 
    //                                    JOIN ` + this.ScreenObject.GetTableName(item.CCID) + " CMJ with(nolock) ON CM.CostCenterID= " + sender.CCID + "   and CM.NodeID=CMJ." + this.ScreenObject.GetPrimaryKey(item.CCID) + ` 
    //                                    JOIN ` + this.ScreenObject.GetTableName(item.CCID) + " CMJG with(nolock) ON CMJG.lft between  CMJ.lft and CMJ.rgt and CMJG." + this.ScreenObject.GetPrimaryKey(item.CCID) + " =" + sender.SelectedValue;
    //                 item.CustomWhere = cWhere;
    //                 item.RefreshData = true;
    //             }
    //         });
    //     }
    // }

    // Name : SetNewDocFieldsTemp
    // Desc : Set All Document fields to new based on employee filter. Some SetNewDocFields code refacter to this method.
    // Category : PAYROLL
    SetNewDocFieldsTemp(strWhr) {
        let DimEmpfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
        if (DimEmpfld && DimEmpfld instanceof PactListBoxData)
            DimEmpfld.CustomWhere = strWhr;
        else if (DimEmpfld && DimEmpfld instanceof PactCodeNameListBoxData)
            DimEmpfld.Name.CustomWhere = DimEmpfld.Code.CustomWhere = strWhr;
        else {
            DimEmpfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
            if (DimEmpfld && DimEmpfld instanceof PactListBoxData && DimEmpfld.CCID == 50051)
                DimEmpfld.CustomWhere = strWhr;
            else if (DimEmpfld && DimEmpfld instanceof PactCodeNameListBoxData && DimEmpfld.CCID == 50051)
                DimEmpfld.Name.CustomWhere = DimEmpfld.Code.CustomWhere = strWhr;
            else {
                let DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50051 && a.DisplayMember == "dcCCNID51");
                if (DimEmpBodyfld && DimEmpBodyfld instanceof DgColumn)
                    DimEmpBodyfld.FilterCondition = strWhr;

                if (this.ScreenObject.GridDataColumns.Contains("dcCCNID51Code")) {
                    DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcccnid51code");
                    if (DimEmpBodyfld && DimEmpBodyfld instanceof DgColumn)
                        DimEmpBodyfld.FilterCondition = strWhr;
                }
            }
        }
        this.ScreenObject.GridDataObj.RefreshColumns();
    }

    // Name : EmployeewiseDocumentView
    // Desc : Employee wise document view. this method used in apply loan. it shows the employee wise document data..
    // Category : PAYROLL
    private EmployeewiseDocumentView(intCCID: number, strIsManager: string, strEdit: string) {
        if (intCCID == 40056 && strIsManager == "No") {
            let btndist = this.GetButton("Distribute");
            if (btndist)
                btndist.Visible = false;

            let btn = this.GetButton("Generate");
            if (btn)
                btn.Visible = false;
            this.ReadOnlyBody = true;
            let fldAPL = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
            if (fldAPL && ((strEdit == "False" && Util.IsEmpty((fldAPL as PactTextBoxData).Text)) || (strEdit == "True" && Util.IsEmpty((fldAPL as PactTextBoxData).Text)))) {
                this.BodyVisible = false;
                this.ButtonSave.Visible = true;
                this.ScreenObject._TextFields.forEach(item => {
                    if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase() == "dcalpha1") {
                        item.IsReadOnly = false;
                        item.Text = "0";
                    }
                    else if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase() == "dcalpha2") {
                        item.IsReadOnly = true;
                        item.Text = "0";
                    }
                    else if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase() == "dcalpha3") {
                        item.IsReadOnly = true;
                        item.Text = "0";
                    }
                    else if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase() == "dcalpha4") {
                        item.IsReadOnly = true;
                        item.Text = "0";
                    }
                    else if (item instanceof PactExtraFieldDateData && item.DBColumnName.toLowerCase() == "dcalpha5") {
                        item.Visible = false;
                    }
                });

                fldAPL = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if ((fldAPL && fldAPL instanceof PactListBoxData) || (fldAPL && fldAPL instanceof PactCodeNameListBoxData))
                    fldAPL.IsReadOnly = false;

                fldAPL = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
                if (fldAPL && fldAPL instanceof PactListBoxData)
                    fldAPL.IsReadOnly = false;
            }
            else {
                fldAPL = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                if (fldAPL && fldAPL instanceof PactTextBoxData && parseFloat(fldAPL.Text) > 0) {
                    this.BodyVisible = true;
                    fldAPL.IsReadOnly = true;
                    this.ScreenObject._TextFields.forEach(item => {
                        if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase() == "dcalpha1")
                            item.IsReadOnly = true;
                        else if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase() == "dcalpha3")
                            item.IsReadOnly = true;
                        else if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase() == "dcalpha4")
                            item.IsReadOnly = true;
                        else if (item instanceof PactExtraFieldDateData && item.DBColumnName.toLowerCase() == "dcalpha5") {
                            item.Visible = true;
                            item.IsReadOnly = true;
                        }
                    });
                    fldAPL = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if ((fldAPL && fldAPL instanceof PactListBoxData) || (fldAPL && fldAPL instanceof PactCodeNameListBoxData))
                        fldAPL.IsReadOnly = true;

                    fldAPL = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
                    if (fldAPL && fldAPL instanceof PactListBoxData)
                        fldAPL.IsReadOnly = true;
                }
            }
        }
    }

    // Name : FillPayrollLockUnlockDetails
    // Desc : filling Payroll Lock/Unlock Details in gridview.
    // Category : PAYROLL
    private FillPayrollLockUnlockDetails(IsOnEdit: boolean) {
        try {
            let dsPayStr = BaseService.common.GetDataSet("PAY034", "");
            if (dsPayStr && dsPayStr.Tables.length > 0) {
                if (dsPayStr.Tables[0].length > 0) {
                    let drw = null;
                    let drc;

                    if (!IsOnEdit)
                        this.ScreenObject.GridDataObj.Clear();
                    let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                    let RowPosition = 0;
                    for (let k = 0; k < dsPayStr.Tables[0].length; k++) {
                        // drc = this.ScreenObject.GridData.filter(x => x.dcAlpha1 == Util.ParseDate(dsPayStr.Tables[0][k]["PayrollMonth"]).ToString("dd/MMM/yyyy"));
                        drc = this.ScreenObject.GridData.filter(x => x.dcAlpha1_Key == Util.ParseDate(dsPayStr.Tables[0][k]["PayrollMonth"]));
                        if (drc && drc.length > 0) {

                        }
                        else {
                            drw = this.ScreenObject.GridDataObj.NewRow();
                            this.ScreenObject.GridData.InsertAt(drw, RowPosition);
                            RowPosition++;
                            if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"])) {
                                drw["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                            }
                            drw["dcAlpha1_Key"] = Util.ParseDate(dsPayStr.Tables[0][k]["PayrollMonth"]);
                            drw["dcAlpha1"] = Util.ParseDate(dsPayStr.Tables[0][k]["PayrollMonth"]).ToString("dd/MMM/yyyy");

                            drw["dcAlpha2_Key"] = Util.ParseDate(dsPayStr.Tables[0][k]["PayrollMonthStart"]);
                            drw["dcAlpha2"] = Util.ParseDate(dsPayStr.Tables[0][k]["PayrollMonthStart"]).ToString("dd/MMM/yyyy");

                            drw["dcAlpha3_Key"] = Util.ParseDate(dsPayStr.Tables[0][k]["PayrollMonthEnd"]);
                            drw["dcAlpha3"] = Util.ParseDate(dsPayStr.Tables[0][k]["PayrollMonthEnd"]).ToString("dd/MMM/yyyy");
                        }
                    }
                    this.ScreenObject.GridData.SortBy([{ name: "dcAlpha1_Key", desc: true }]);
                    this.ScreenObject.GridDataObj.refreshDataView();
                    this.ScreenObject.UpdateSequence();
                }
            }
            this.ScreenObject.GridDataObj.CanUserAddRows = false;
            this.ScreenObject.GridDataObj.CanUserDeleteRows = false;

            Logger.InfoLog("AddEditDocumentViewModel::Exiting FillPayrollLockUnlockDetails()");
        }
        catch (error) {
            Logger.ErrorLog("AddEditDocumentViewModel::EXCEPTION FillPayrollLockUnlockDetails()" + error.stack);
        }
    }

    // Name : FillPayrollLockUnlockDetails
    // Desc : for POS Document setting Save button visibility.
    // Category : POS
    SetSaveVisibility() {
        if (this.IsPOs) {
            this.ButtonSave.Visible = false;
            this.ButtonSaveandBarcode.Visible = false;
            this.ButtonSaveandPrint.Visible = false;
            this.ButtonRevise.Visible = false;
            if (this.ButtonsLeft.Contains(this.ButtonSaveandPrint))
                this.ButtonsLeft.Remove(this.ButtonSaveandPrint);
        }
    }

    ErrorMessage = "Missing Report Parameter ' ";

    // Name : OnShortcutClick
    // Desc : Document shortcuts.
    // Category : COMMON
    OnShortcutClick(ColID: any) {
        try {
            for (let i = 0; i < this.Shortcuts.length; i++) {
                if (this.Shortcuts[i] instanceof PactControlData && this.Shortcuts[i].DBColumnID.toString() == ColID.toString())
                    this.ScreenObject.GetExternalFuncData(this.Shortcuts[i].Mode, this.Shortcuts[i].ToolTipFooterTitle, this.Shortcuts[i].ToolTipFooterDescription, this.Shortcuts[i].ToolTipDescription, null);
                else if (this.Shortcuts[i] instanceof DgColumn && this.Shortcuts[i].ID == ColID.toString() && this.SelectedRow != null)
                    this.ScreenObject.GetExternalFuncData(this.Shortcuts[i].Mode, this.Shortcuts[i].SPName, this.Shortcuts[i].IPParams, this.Shortcuts[i].OPParams, this.SelectedRow);
            }
        }
        catch (error) {
            this.DisplayMessage = "Problem processing request try again";
            Logger.ErrorLog("AddEditDocumentViewModel", "OnShortcutClick", error);
        }
    }

    IsColumnExists(sColName: string): boolean {
        var srccol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toUpperCase() == sColName.toUpperCase());
        if (srccol == null)
            return false;
        return true;
    }

    // Name : OnDocLinkClick
    // Desc : On Document link click, based on DBColumnId new document or new POS document will display in new tab.
    // Category : COMMON
    async OnDocLinkClick(CCID: any) {
        let Doc = this.DocsList.find(a => a.DBColumnID == parseInt(CCID));
        if (Doc) {
            if (Doc.Dependancy == 1) {
                try {
                    if (this.ScreenObject.Preferences.ContainsKey("MapDocsFilterDim") && !Util.IsEmpty(this.ScreenObject.Preferences["MapDocsFilterDim"]) && this.IsColumnExists("DCCCNID" + (parseInt(this.ScreenObject.Preferences["MapDocsFilterDim"]) - 50000))
                        && this.ScreenObject.Preferences.ContainsKey("OpenDocsFilterDim") && !Util.IsEmpty(this.ScreenObject.Preferences["OpenDocsFilterDim"]) && this.IsColumnExists("DCCCNID" + (parseInt(this.ScreenObject.Preferences["OpenDocsFilterDim"]) - 50000))
                    ) {

                        let p2 = (parseInt(this.ScreenObject.Preferences["MapDocsFilterDim"]) - 50000) + "= " + Util.String(this.SelectedRow["dcCCNID" + (parseInt(this.ScreenObject.Preferences["MapDocsFilterDim"]) - 50000) + "_Key"]);
                        let p3 = (parseInt(this.ScreenObject.Preferences["OpenDocsFilterDim"]) - 50000) + "= " + Util.String(this.SelectedRow["dcCCNID" + (parseInt(this.ScreenObject.Preferences["OpenDocsFilterDim"]) - 50000) + "_Key"]);

                        let dtDE: any = BaseService.report.GetDataTable("ADMDOC301", Util.String(Doc.DBColumnID), p2, p3);
                        if (dtDE != null && dtDE.length > 0) {
                            let oDocument2 = new AddEditDocumentViewModel(Doc.DBColumnID, Doc.Label, true);
                            oDocument2.ScreenObject.DocPrefix.TextBox.Text = Util.String(dtDE[0]["DocNumber"]);
                            oDocument2.ScreenObject.DocPrefix.ComboBox.SelectedValue = Util.String(dtDE[0]["DocPrefix"]);
                            oDocument2.OnDocPrefixChanged("lostFocus");
                            oDocument2.ScreenObject.FillDocumentPrefix(true);
                            //added to fill prefix
                            oDocument2.ScreenObject.DocPrefix.ComboBox.SelectedValue = Util.String(dtDE[0]["DocPrefix"]);
                            oDocument2.ScreenObject.DocPrefix.ComboBox.SelectedItem = oDocument2.ScreenObject.DocPrefix.ComboBox.GetselectedItem();
                            if (oDocument2.IsInventoryVoucher && !oDocument2.RefreshGridFooter)
                                oDocument2.RefreshGridFooter = true;
                            let pageObj: IPage = { component: AddEditDocumentComponent, params: { obj: oDocument2 } }
                            BaseService.page.addNewTab(pageObj)
                        }
                        else {
                            let oDocument1 = new AddEditDocumentViewModel(Doc.DBColumnID, Doc.Label, false, this);
                            //Copy Dimensions to Child Document based on Parent Document
                            if (oDocument1.ScreenObject._CCFields.length > 0) {
                                for (let d = 0; d < oDocument1.ScreenObject._CCFields.length; d++) {
                                    for (let c = 0; c < this.ScreenObject.GridDataColumns.length; c++) {
                                        if (oDocument1.ScreenObject._CCFields[d].DBColumnName == this.ScreenObject.GridDataColumns[c] && oDocument1.ScreenObject._CCFields[d] instanceof PactListBoxData) {
                                            (oDocument1.ScreenObject._CCFields[d] as PactListBoxData).SelectedValue = parseInt(this.SelectedRow[this.ScreenObject.GridDataColumns[c] + "_Key"]);
                                        }
                                    }
                                }

                                for (let d = 0; d < oDocument1.ScreenObject._CCFields.length; d++) {
                                    for (let c = 0; c < this.ScreenObject._CCFields.length; c++) {
                                        if (oDocument1.ScreenObject._CCFields[d].DBColumnName == this.ScreenObject._CCFields[c].DBColumnName) {
                                            let iVal: number = 1;
                                            if (this.ScreenObject._CCFields[c] instanceof PactListBoxData)
                                                iVal = (this.ScreenObject._CCFields[c] as PactListBoxData).SelectedValue;
                                            else if (this.ScreenObject._CCFields[c] instanceof PactCodeNameListBoxData)
                                                iVal = (this.ScreenObject._CCFields[c] as PactCodeNameListBoxData).SelectedValue;

                                            if (oDocument1.ScreenObject._CCFields[d] instanceof PactListBoxData)
                                                (oDocument1.ScreenObject._CCFields[d] as PactListBoxData).SelectedValue = iVal;
                                            else if (oDocument1.ScreenObject._CCFields[d] instanceof PactCodeNameListBoxData)
                                                (oDocument1.ScreenObject._CCFields[d] as PactListBoxData).SelectedValue = iVal;
                                        }
                                    }
                                }
                            }
                            let pageObj: IPage = { component: AddEditDocumentComponent, params: { obj: oDocument1 } }
                            BaseService.page.addNewTab(pageObj)
                        }
                    }
                    else {
                        let oDocument1 = new AddEditDocumentViewModel(Doc.DBColumnID, Doc.Label, false, this);
                        let pageObj: IPage = { component: AddEditDocumentComponent, params: { obj: oDocument1 } }
                        BaseService.page.addNewTab(pageObj)
                    }
                }
                catch (error) {
                    Logger.ErrorLog("Error occurred while opening the Document : \r\n", error);
                }
                // ////////////////
                // let oDocument = new AddEditDocumentViewModel(Doc.DBColumnID, Doc.Label, false, this);
                // let pageObj: IPage = { component: AddEditDocumentComponent, params: { obj: oDocument } }
                // BaseService.page.addNewTab(pageObj)
            }
            else {
                let ind = BaseService.page.indexOf(this);
                let templist = this.DocsList;
                if (this.ClassName == "POSDocumentViewModel") {
                    const { POSDocumentViewModel } = await import('../../pos/pos-screen/POSDocumentViewModel');
                    const { PosScreenComponent } = await import('../../pos/pos-screen/pos-screen.component');

                    let oDocument = new POSDocumentViewModel(Doc.DBColumnID, Doc.Label, false, this);

                    if (oDocument.DocsList.length > 0) {
                        oDocument.DocsList.Clear();
                        let toremove = oDocument.ButtonsLeft.filter(a => a.ComParam.startsWith("Documents "));
                        for (let i = 0; i < toremove.length; i++) {
                            oDocument.ButtonsLeft.Remove(toremove[i]);
                        }
                    }
                    for (let i = 0; i < templist.length; i++) {
                        if (templist[i].DBColumnID == oDocument.CostCenterID) {
                            templist[i].DBColumnID = this.CostCenterID;
                            templist[i].Label = this.DisplayName;
                            templist[i].ComParam = "Documents " + this.CostCenterID;
                        }
                        oDocument.DocsList.push(templist[i]);
                        oDocument.ButtonsLeft.push(templist[i]);
                    }
                    let retObj: IPage = {}
                    retObj.title = "POS Screen";
                    Object.assign(retObj, {
                        component: PosScreenComponent,
                        params: { obj: oDocument }
                    });
                    BaseService.page.tabs.Insert(ind, retObj);
                    BaseService.page.setActiveTab(ind);
                    //  ShellWindowViewModel.SetActiveWorkspace(oDocument);
                }
                else {
                    let oDocument = new AddEditDocumentViewModel(Doc.DBColumnID, Doc.Label, false, this);
                    oDocument.DocsList.Clear();
                    for (let i = 0; i < templist.length; i++) {
                        if (templist[i].DBColumnID == oDocument.CostCenterID) {
                            templist[i].DBColumnID = this.CostCenterID;
                            templist[i].Label = this.DisplayName;
                        }
                        oDocument.DocsList.push(templist[i]);
                    }
                    oDocument.onButtonClick("Documents");
                    let pageObj: IPage = { component: AddEditDocumentComponent, params: { obj: oDocument }, position: ind }
                    BaseService.page.addNewTab(pageObj)
                }
                BaseService.page.removeTab(this);
                //this.Dispose();
            }
        }
    }

    // Name : OnReportsLinkClick
    // Desc : On Report Link click, based on reportid report data will display as popup or in new tab.
    // Category : COMMON
    async OnReportsLinkClick(oReportID: any) {
        let dv12 = this.ScreenObject.Data.Tables[21].filter(x => x.SysColumnName == 'ProductID');
        if (dv12.length > 0) {
            dv12.forEach(dr => {
                dr["SysColumnName"] = "ProductID_Key";
            });
        }

        var rpt = this.ReportsList.find(a => a.DBColumnID == parseInt(oReportID));
        let outObj = { strXML: "" };
        if (!(rpt && rpt.Dependancy == 2))
            this.DisplayMessage = this.GetReportFilterXML(oReportID, outObj);

        if ((rpt && rpt.Dependancy == 2) || (this.DisplayMessage.length == 0)) {
            const { ReportViewModel } = await import('../../reports/report-view/ReportViewModel');
            const { ReportViewComponent } = await import('../../reports/report-view/report-view.component');
            if (rpt && rpt.Dependancy == 1)//Display as popup
            {
                let oReport = new ReportViewModel()
                oReport.ReportViewModel_Document(this.CostCenterID, outObj.strXML, parseInt(oReportID), true, null, null, this)
                {
                    //oReport.DocumentObject = this;
                    if (Util.Double(rpt.GroupName) > 0)
                        oReport.RptWidth = parseFloat(rpt.GroupName);
                    if (Util.Double(rpt.Length) > 0)
                        oReport.RptHeight = parseFloat(rpt.Length);
                    oReport.RegenerateVisibility=  BaseService.SessionManager.IsActionAssigned(43, "EnableRegenerateBtn");
                    BaseService.page.ShowDialog(oReport, ReportViewComponent, { HideHeader: true }).subscribe(
                        () => {
                            if (oReport.SelectedRow != null && oReport.SelectedRow.DataRow != null)
                                this.FillReportData(oReport.ReportID, oReport.SelectedRow.DataRow, oReport._ReportData);
                            this.LineNo = this.ScreenObject.SelectedGridRowIndex + 1;
                            this.SetFocusongrid = true;
                        }
                    );
                }
            }
            else if (rpt != null && rpt.Dependancy == 2)//Display as popup
            {
                let isFCall = false;
                if (rpt.GroupName == "-1")
                    isFCall = true;
                let oReport = new ReportViewModel()
                oReport.ReportViewModel_Query((this.IsInventoryVoucher) ? 3 : 2, 0, (this.IsInventoryVoucher) ? "Products" : "Accounts", 0, null, true, isFCall)
                {
                    oReport.DocumentObject = this;
                    if (Util.Double(rpt.GroupName) > 0)
                        oReport.RptWidth = parseFloat(rpt.GroupName);
                    if (Util.Double(rpt.Length) > 0)
                        oReport.RptHeight = parseFloat(rpt.Length);
                    oReport.RegenerateVisibility=  BaseService.SessionManager.IsActionAssigned(43, "EnableRegenerateBtn");
                    BaseService.page.ShowDialog(oReport, ReportViewComponent, { HideHeader: true }).subscribe(() => {
                        if (oReport.SelectedRow)
                            this.FillReportData(oReport.ReportID, oReport.SelectedRow.DataRow, oReport._ReportData);
                        this.LineNo = this.ScreenObject.SelectedGridRowIndex + 1;
                        this.SetFocusongrid = true;
                    });
                }
            }
            else {
                let oReport = new ReportViewModel();
                oReport.ReportViewModel_Document(this.CostCenterID, outObj.strXML, parseInt(oReportID), false, null, null)
                {
                    oReport.RegenerateVisibility=  BaseService.SessionManager.IsActionAssigned(43, "EnableRegenerateBtn");
                    oReport.DocumentObject = this;
                    BaseService.page.addNewTab({ component: ReportViewComponent, params: { obj: oReport } });
                }
            }
        }
    }

    // Name : FillReportData
    // Desc : On Report Link click, based on reportid filling report data.
    // Category : COMMON
    FillReportData(RID: number, reportrow: any, oRptData: any) {
        let rpt = this.ReportsList.find(a => a.DBColumnID == RID);
        if (rpt && !Util.IsEmpty(rpt.ToolTipFooterDescription)) {
            let dsr = new XmlDocument();
            dsr.ReadXml(rpt.ToolTipFooterDescription);
            if (dsr.Tables.length > 0 && dsr.Columns[0].Contains("ColID") && dsr.Tables[0].length > 0) {
                let dvRPT = this.ScreenObject.Data.Tables[21].filter(x => x.ReportID == RID);
                let isComplete = false;
                let prodcalled = false;
                dvRPT.forEach(dr => {
                    if (parseBoolean(dr["MapType"]))
                        isComplete = true;
                });

                for (let i = 0; i < dsr.Tables[0].length; i++) {

                    let datacol = this.ScreenObject.ColumnSource.find(a => a.ID == dsr.Tables[0][i]["ColID"].toString());
                    if (datacol && this.SelectedRow == null)
                        this.Setselectedrow(this.GetEmptyRowPosition(this.ScreenObject.GridDataObj, this.GetPrimaryColName()));

                    if (!Util.IsEmpty(reportrow[dsr.Tables[0][i]["ReportCol"].toString()])) {
                        if (isComplete) {
                            if (!Util.IsEmpty(reportrow[dsr.Tables[0][i]["ReportCol"].toString() + "_ID"])) {
                            }
                            else {
                                for (let j = 0; j < this.ScreenObject.GridData.length; j++) {
                                    let drr: any = oRptData;
                                    for (let p = 0; p < dvRPT.length; p++) {
                                        let dr = dvRPT[p]
                                        if (!Util.IsEmpty(dr["ReportFieldName"]) && !Util.IsEmpty(dr["SysColumnName"])
                                            && this.ScreenObject.GridDataColumns.Contains(dr["SysColumnName"]) && !Util.IsEmpty(this.ScreenObject.GridData[j][dr["SysColumnName"]])) {
                                            drr = drr.filter(x => x[dr["ReportFieldName"].toString()] == this.ScreenObject.GridData[j][dr["SysColumnName"]].toString());
                                        }
                                        else {
                                            drr = [];
                                            break;
                                        }
                                    }
                                    if (drr.length > 0)
                                        this.ScreenObject.SetValueBYCOLID(dsr.Tables[0][i]["ColID"].toString(), drr[0][dsr.Tables[0][i]["ReportCol"].toString()].toString(), "", this.ScreenObject.GridData[j]);
                                }
                            }
                        }
                        else {
                            if (!Util.IsEmpty(reportrow[dsr.Tables[0][i]["ReportCol"].toString() + "_ID"])) {
                                if (this.SelectedRow != null)
                                    this.ScreenObject.SetValueBYCOLID(dsr.Tables[0][i]["ColID"].toString(), reportrow[dsr.Tables[0][i]["ReportCol"].toString()].toString(), reportrow[dsr.Tables[0][i]["ReportCol"].toString() + "_ID"].toString(), this.SelectedRow);
                                else
                                    this.ScreenObject.SetValueBYCOLID(dsr.Tables[0][i]["ColID"].toString(), reportrow[dsr.Tables[0][i]["ReportCol"].toString()].toString(), reportrow[dsr.Tables[0][i]["ReportCol"].toString() + "_ID"].toString(), null);
                            }
                            else {
                                if (this.SelectedRow != null)
                                    this.ScreenObject.SetValueBYCOLID(dsr.Tables[0][i]["ColID"].toString(), reportrow[dsr.Tables[0][i]["ReportCol"].toString()].toString(), "", this.SelectedRow);
                                else
                                    this.ScreenObject.SetValueBYCOLID(dsr.Tables[0][i]["ColID"].toString(), reportrow[dsr.Tables[0][i]["ReportCol"].toString()].toString(), "", null);
                            }
                        }
                        if (!Util.IsEmpty(dsr.Tables[0][i]["SysColName"]) && dsr.Tables[0][i]["SysColName"].toString().toUpperCase().startsWith("DCCCNID")) {
                            if (this.IsInventoryVoucher && datacol.CostCenterID > 50000 && this.ScreenObject.PriceTaxcc.ContainsKey(datacol.CostCenterID) && Object.keys(this.SelectedRow).Contains(dsr.Tables[0][i]["SysColName"].toString() + "_Key") && this.SelectedRow[dsr.Tables[0][i]["SysColName"].toString() + "_Key"].toString() != this.PrevValue
                                && !Util.IsEmpty(this.SelectedRow["ProductID_Key"]) && parseInt(this.SelectedRow["ProductID_Key"].toString()) > 0) {
                                this.ReEvaluatePriceTax_3(this.SelectedRow, datacol.CostCenterID);
                            }
                        }
                    }

                    if (!prodcalled && this.IsPOs && datacol != null && BaseService.SessionManager.Preferences.ContainsKey("POSItemCodeDimension") && BaseService.SessionManager.Preferences["POSItemCodeDimension"] != "" && parseInt(BaseService.SessionManager.Preferences["POSItemCodeDimension"]) > 50000
                        && !Util.IsEmpty(reportrow[dsr.Tables[0][i]["ReportCol"].toString()]) && datacol.CostCenterID == parseInt(BaseService.SessionManager.Preferences["POSItemCodeDimension"])) {
                        prodcalled = true;
                        this.onSKUSearch(reportrow[dsr.Tables[0][i]["ReportCol"].toString()].toString());
                    }
                    else if (!prodcalled && datacol != null && datacol.CostCenterID == 3 && this.IsInventoryVoucher) {
                        prodcalled = true;
                        let dr = this.SelectedRow;
                        this.AddProductData(dr, false, false);
                    }
                    else if (this.ScreenObject.DocumentType == 30 && this.ScreenObject.Preferences.ContainsKey("AssembleProduct") && this.ScreenObject.Preferences["AssembleProduct"] == dsr.Tables[0][i]["ColID"].toString()) {
                        let fld = this.ScreenObject._TextFields.find(a => a.DBColumnID == parseInt(dsr.Tables[0][i]["ColID"]));
                        if (fld)
                            this.OnKitProductChange(fld);
                    }

                    if (datacol && datacol.CostCenterID > 0)
                        for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                            if (this.ScreenObject.ColumnSource[j].DataType == "LINK" && !this.ScreenObject.ColumnSource[j].Dependantinuse && this.ScreenObject.ColumnSource[j].Mandatory && !Util.IsEmpty(this.ScreenObject.ColumnSource[j].FilterCondition) && this.ScreenObject.ColumnSource[j].FilterCondition.split(',').Contains(datacol.CostCenterID.toString())) {
                                if (this.SelectedRow != null)
                                    this.RowAttachments(this.ScreenObject.ColumnSource[j].DisplayMember, true, this.SelectedRow);
                            }
                        }
                }
            }
        }
    }

    // Name : GetReportFilterXML
    // Desc : Get Report XML base on report id and return as output obj.
    // Category : COMMON
    GetReportFilterXML(oReportID: any, outObj: any): string {
        //out string strXML
        let sb = "";
        outObj.strXML = "";

        let dvRPT = this.ScreenObject.Data.Tables[21];
        dvRPT = dvRPT.filter(x => x.ReportID == oReportID);
        let strValue = "", strValueText = "", strLinkedInvDocDetailsIDs = "";
        let GroupLevel = false, isComplete = false, exists = false;
        dvRPT.forEach(dr => {
            if (parseBoolean(dr["GroupLevel"]))
                GroupLevel = true;
            if (dr["MapType"] != null && parseBoolean(dr["MapType"]))
                isComplete = true;
        });

        sb += "<XML";
        if (GroupLevel)
            sb += " GroupLevel=\"1\"";
        sb += " >";

        let ind = this.ScreenObject.SelectedGridRowIndex;
        let DocumentField;
        let CheckData = "";
        let sysColumn = "";

        let dv = this.ScreenObject.GridData;
        let dvColumns = this.ScreenObject.GridDataColumns;
        if (this.ReportDimension.SelectedValue > 0) {
            if (this.ReportDimension.CCID == 2) {
                if (dvColumns.Contains("CreditAccount_Key"))
                    dv = this.ScreenObject.GridData.filter(x => x.CreditAccount_Key == this.ReportDimension.SelectedValue);
                else if (dvColumns.Contains("DebitAccount_Key"))
                    dv = this.ScreenObject.GridData.filter(x => x.DebitAccount_Key == this.ReportDimension.SelectedValue);
                else if (dvColumns.Contains("AccountID_Key"))
                    dv = this.ScreenObject.GridData.filter(x => x.AccountID_Key == this.ReportDimension.SelectedValue);
            }
            else if (this.ReportDimension.CCID == 3)
                dv = this.ScreenObject.GridData.filter(x => x.ProductID_Key == this.ReportDimension.SelectedValue);
        }
        else if (!isComplete && this.SelectedRow)
            dv = this.ScreenObject.GridData.filter(x => x.DocSeqNo == this.SelectedRow["DocSeqNo"]);


        let ReportColID: string;
        for (let j = 0; j < dvRPT.length; j++) {
            ReportColID = dvRPT[j]["ReportField"].toString();
            sb += "<Row ";
            sb += "ColID =\"" + ReportColID + "\" ";
            exists = false;
            sysColumn = dvRPT[j]["SysColumnName"];
            DocumentField = parseInt(dvRPT[j]["DocumentField"]);
            isComplete = parseBoolean(dvRPT[j]["MapType"]);

            if (dvColumns.Contains(sysColumn) || dvColumns.Contains(sysColumn + "_Key")) {
                if (isComplete) {
                    strValue = "";
                    strValueText = "";
                    for (let k = 0; k < dv.length; k++) {
                        if (dvColumns.Contains(sysColumn + "_Key")) {
                            if (!Util.IsEmpty(dv[k][sysColumn + "_Key"]) && dv[k][sysColumn + "_Key"].toString() != "0") {
                                if (ReportColID == "23148" && dv[k][sysColumn].toString().length > 0) {
                                    strValueText = strValueText + "'" + dv[k][sysColumn].toString() + "',";
                                    if (dvColumns.Contains("LinkedInvDocDetailsID") && !Util.IsEmpty(dv[k]["LinkedInvDocDetailsID"]) && dv[k]["LinkedInvDocDetailsID"].toString() != "0")
                                        strLinkedInvDocDetailsIDs = strLinkedInvDocDetailsIDs + dv[k]["LinkedInvDocDetailsID"].toString() + ",";
                                }
                                strValue = strValue + "'" + dv[k][sysColumn + "_Key"].toString() + "',";
                            }
                        }
                        else {
                            if (!Util.IsEmpty(dv[k][sysColumn]))
                                strValue = strValue + "'" + dv[k][sysColumn].toString() + "',";
                        }
                    }

                    if (strValue == "") {
                        alert(this.ErrorMessage + dvRPT[j]["DocumentFieldName"].toString() + " '");
                        this.LineNo = ind + 1;
                        this.SetFocusongrid = true;
                        return "Empty Value";
                    }
                    else {
                        if (ReportColID == "23148" && strValueText.length > 0) {
                            sb += "ValueText=\"" + strValueText.TrimEnd(',').TrimEnd('\'').TrimStart('\'') + "\" ";
                            sb += "LinkedInvDocDetailsIDs=\"" + strLinkedInvDocDetailsIDs.TrimEnd(',') + "\" ";
                        }
                        sb += "Value =\"" + strValue.TrimEnd(',') + "\" ";
                    }
                }
                else {

                    if (dv.length == 0) {
                        if (this.ReportDimension.CCID == parseInt(ReportColID))
                            sb += "Value =\"" + this.ReportDimension.SelectedValue + "\" ";
                    }
                    else {
                        if (dvColumns.Contains(sysColumn + "_Key")) {
                            if (Util.Int(dv[0][sysColumn + "_Key"]) == 0) {
                                alert(this.ErrorMessage + dvRPT[j]["DocumentFieldName"].toString() + " '");
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                if (ReportColID == "23148" && dv[0][sysColumn].toString().length > 0) {
                                    sb += "ValueText=\"" + dv[0][sysColumn] + "\" ";
                                    for (let k = 0; k < dv.length; k++) {
                                        if (dvColumns.Contains("ProductID_Key") && dvColumns.Contains("LinkedInvDocDetailsID")) {
                                            if (!Util.IsEmpty(dv[k]["ProductID_Key"]) && dv[k]["ProductID_Key"].toString() != "0"
                                                && !Util.IsEmpty(dv[k]["LinkedInvDocDetailsID"]) && dv[k]["LinkedInvDocDetailsID"].toString() != "0")
                                                strLinkedInvDocDetailsIDs = strLinkedInvDocDetailsIDs + dv[k]["LinkedInvDocDetailsID"].toString() + ",";
                                        }
                                    }
                                    sb += "LinkedInvDocDetailsIDs=\"" + strLinkedInvDocDetailsIDs.TrimEnd(',') + "\" ";

                                }
                                sb += "Value=\"" + dv[0][sysColumn + "_Key"].toString() + "\" ";
                            }
                        }
                        else {
                            if (Util.IsEmpty(dv[0][sysColumn])) {
                                alert(this.ErrorMessage + dvRPT[j]["DocumentFieldName"].toString() + " '");
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                if (sysColumn == "ProductID_Key" && ReportColID != "3") {
                                    let TempTable0: any = this.ScreenObject.Data.Tables[0].filter(x => x.CostCenterColID == DocumentField);
                                    //if (this.ScreenObject.Data.Tables[0].DefaultView.length > 0)
                                    if (TempTable0.length > 0) {
                                        let colname = TempTable0[0] = Util.String(["parentccdefaultcolid"]);//this.ScreenObject.Data.Tables[0].DefaultView[0]["parentccdefaultcolid"].toString();
                                        if (colname == "261") {
                                            sb += "Value =\"" + dv[0]["ProductCode"].toString() + "\" />";
                                            continue;
                                        }
                                        else if (colname == "262") {
                                            sb += "Value =\"" + dv[0]["ProductName"].toString() + "\" />";
                                            continue;
                                        }
                                    }
                                }

                                sb += "Value =\"" + dv[0][sysColumn].toString() + "\" ";
                            }
                        }
                    }


                }
                exists = true;
            }
            if (!exists) {
                for (let i = 0; i < this.ScreenObject.HeaderFields.length; i++) {
                    if ((this.ScreenObject.HeaderFields[i] as PactControlData).DBColumnID == DocumentField) {
                        if (this.ScreenObject.HeaderFields[i] instanceof PactTextBoxData) {
                            if (this.ScreenObject.HeaderFields[i].Text == "") {
                                alert(this.ErrorMessage + this.ScreenObject.HeaderFields[i].Label + " '")
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + this.ScreenObject.HeaderFields[i].Text + "\" ";
                            }
                        }
                        else if (this.ScreenObject.HeaderFields[i] instanceof PactComboTextData) {
                            let oCombo = this.ScreenObject.HeaderFields[i];
                            if (oCombo.DBColumnName == "VoucherNo") {
                                sb += "Value =\"" + this.ScreenObject.VoucherNo + "\" ";
                            }
                            else {
                                if (oCombo.TextBox.Text == "" || oCombo.ComboBox.SelectedValue == "") {
                                    alert(this.ErrorMessage + this.ScreenObject.HeaderFields[i].Label + " '")
                                    this.LineNo = ind + 1;
                                    this.SetFocusongrid = true;
                                    return "Empty Value";
                                }
                                else {
                                    sb += "Value =\"" + oCombo.ComboBox.SelectedValue + "\" ";
                                }
                            }
                        }
                        else if (this.ScreenObject.HeaderFields[i] instanceof PactTextAreaData) {
                            if (this.ScreenObject.HeaderFields[i].Text == "") {
                                alert(this.ErrorMessage + this.ScreenObject.HeaderFields[i].Label + " '")
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + this.ScreenObject.HeaderFields[i].Text + "\" ";
                            }
                        }
                        else if (this.ScreenObject.HeaderFields[i] instanceof PactDatePickerData || this.ScreenObject.HeaderFields[i] instanceof PactVoucherDateData || this.ScreenObject.HeaderFields[i] instanceof PactExtraFieldDateData) {
                            if (this.ScreenObject.HeaderFields[i] instanceof PactDatePickerData)
                                sb += "Value =\"" + this.ScreenObject.HeaderFields[i].Date.ToString("dd/MMM/yyyy") + "\" ";
                            else if (this.ScreenObject.HeaderFields[i] instanceof PactVoucherDateData)
                                sb += "Value =\"" + this.DocumentDate.ToString("dd/MMM/yyyy") + "\" ";
                            else if (this.ScreenObject.HeaderFields[i] instanceof PactExtraFieldDateData) {
                                if (!this.ScreenObject.HeaderFields[i].Date) {
                                    alert(this.ErrorMessage + this.ScreenObject.HeaderFields[i].Label + " '")
                                    this.LineNo = ind + 1;
                                    this.SetFocusongrid = true;
                                    return "Empty Value";
                                }
                                sb += "Value =\"" + this.ScreenObject.HeaderFields[i].Date.ToString("dd/MMM/yyyy") + "\" ";
                            }
                        }
                        else if (this.ScreenObject.HeaderFields[i] instanceof PactListBoxData) {
                            let ov1 = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == this.ScreenObject.HeaderFields[i].DBColumnName.toLowerCase());
                            if (ov1 != undefined)
                                continue;
                            if (this.ScreenObject.HeaderFields[i].Text == "") {
                                alert(this.ErrorMessage + this.ScreenObject.HeaderFields[i].Label + " '")
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + this.ScreenObject.HeaderFields[i].SelectedValue + "\" ";
                            }
                        }
                        else if (this.ScreenObject.HeaderFields[i] instanceof PactCodeNameListBoxData) {
                            let ov1 = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == this.ScreenObject.HeaderFields[i].DBColumnName.toLowerCase());
                            if (ov1 != undefined)
                                continue;
                            if (this.ScreenObject.HeaderFields[i].Text == "") {
                                alert(this.ErrorMessage + this.ScreenObject.HeaderFields[i].Label + " '")
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + this.ScreenObject.HeaderFields[i].SelectedValue + "\" ";
                            }
                        }
                    }
                }
                for (let i = 0; i < this.ScreenObject._CCFields.length; i++) {
                    if ((this.ScreenObject._CCFields[i] as PactControlData).DBColumnID == Math.abs(DocumentField)) {
                        if (this.ScreenObject._CCFields[i] instanceof PactListBoxData) {
                            if (DocumentField < 0 && !this.ScreenObject._CCFields[i].DBColumnName.startsWith("TO"))
                                continue;
                            if ((this.ScreenObject._CCFields[i] as PactListBoxData).Text == "") {
                                alert(this.ErrorMessage + this.ScreenObject._CCFields[i].Label + " '");
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + (this.ScreenObject._CCFields[i] as PactListBoxData).SelectedValue + "\" ";
                            }
                            break;
                        }
                        else if (this.ScreenObject._CCFields[i] instanceof PactCodeNameListBoxData) {
                            if (DocumentField < 0 && !this.ScreenObject._CCFields[i].DBColumnName.startsWith("TO"))
                                continue;
                            if ((this.ScreenObject._CCFields[i] as PactCodeNameListBoxData).Text == "") {
                                alert(this.ErrorMessage + this.ScreenObject._CCFields[i].Label + " '");
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + (this.ScreenObject._CCFields[i] as PactCodeNameListBoxData).SelectedValue + "\" ";
                            }
                            break;
                        }
                    }
                }
                for (let i = 0; i < this.ScreenObject._TextFields.length; i++) {
                    if ((this.ScreenObject._TextFields[i] as PactControlData).DBColumnID == parseInt(dvRPT[j]["DocumentField"])) {
                        if (this.ScreenObject._TextFields[i] instanceof PactTextBoxData) {
                            if ((this.ScreenObject._TextFields[i] as PactTextBoxData).Text == "") {
                                alert(this.ErrorMessage + this.ScreenObject._TextFields[i].Label);
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + (this.ScreenObject._TextFields[i] as PactTextBoxData).Text + "\" ";
                            }
                        }
                        else if (this.ScreenObject._TextFields[i] instanceof PactComboTextData) {
                            if ((this.ScreenObject._TextFields[i] as PactComboTextData).TextBox.Text == "" || (this.ScreenObject._TextFields[i] as PactComboTextData).ComboBox.SelectedValue == "") {
                                alert(this.ErrorMessage + this.ScreenObject._TextFields[i].Label);
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + (this.ScreenObject._TextFields[i] as PactComboTextData).TextBox.Text + "\" ";
                            }
                        }
                        else if (this.ScreenObject._TextFields[i] instanceof PactTextAreaData) {
                            if ((this.ScreenObject._TextFields[i] as PactTextAreaData).Text == "") {
                                alert(this.ErrorMessage + this.ScreenObject._TextFields[i].Label);
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + (this.ScreenObject._TextFields[i] as PactTextAreaData).Text + "\" ";
                            }
                        }
                        else if (this.ScreenObject._TextFields[i] instanceof PactDatePickerData || this.ScreenObject._TextFields[i] instanceof PactVoucherDateData) {
                            if (!(this.ScreenObject._TextFields[i] as any).Date) {
                                alert(this.ErrorMessage + this.ScreenObject._TextFields[i].Label);
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + (this.ScreenObject._TextFields[i] as any).Date.ToString("dd/MMM/yyyy") + "\" ";
                            }
                        }
                        else if (this.ScreenObject._TextFields[i] instanceof PactListBoxData) {
                            if ((this.ScreenObject._TextFields[i] as PactListBoxData).Text == "") {
                                alert(this.ErrorMessage + this.ScreenObject._TextFields[i].Label);
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + (this.ScreenObject._TextFields[i] as PactListBoxData).SelectedValue + "\" ";
                            }
                        }
                        else if (this.ScreenObject._TextFields[i] instanceof PactCodeNameListBoxData) {
                            if ((this.ScreenObject._TextFields[i] as PactCodeNameListBoxData).Text == "") {
                                alert(this.ErrorMessage + this.ScreenObject._TextFields[i].Label);
                                this.LineNo = ind + 1;
                                this.SetFocusongrid = true;
                                return "Empty Value";
                            }
                            else {
                                sb += "Value =\"" + (this.ScreenObject._TextFields[i] as PactCodeNameListBoxData).SelectedValue + "\" ";
                            }
                        }
                    }
                }
            }
            sb += " />";
        }
        sb += "</XML>";

        outObj.strXML = sb;
        return "";
    }

    // Name : BeforeRowDeletingEvent
    // Desc : event will fire before gridview row deleting.
    // Category : COMMON
    BeforeRowDeletingEvent(sender: any) {
        if (this.SelectedRow) {
            if (this.SelectedRows && this.SelectedRows.length > 1) {
                let lst = new Array<any>();
                let candelete = true;
                for (let p = 0; p < this.SelectedRows.length; p++) {
                    let item = this.SelectedRows[p]
                    if (item) {
                        candelete = this.CanDeleteRow(item);
                        if (!candelete)
                            break;
                        lst.push(item);
                    }
                }
                if (candelete) {
                    if (confirm("Are you sure you want to delete " + this.SelectedRows.length.toString() + " Rows?")) {
                        this.IsSelectAll = true;
                        for (let i = 0; i < lst.length; i++) {
                            this.OnBeforeRowDeleting(lst[i], false);
                        }
                        this.IsSelectAll = false;
                        this.ScreenObject.UpdateSequence();
                        this.CalculateTotals(null, false);
                        this.CheckVendorWiseLinkingPref();
                        sender.CanExecute = false;
                    }
                }
                else
                    sender.CanExecute = false;
            }
            else {
                if (this.CanDeleteRow(this.SelectedRow)) {
                    this.IsSelectAll = false;
                    sender.CanExecute = this.OnBeforeRowDeleting(this.SelectedRow, true);
                }
                else
                    sender.CanExecute = false;
            }
        }
    }

    // Name : CanInsertDeleteRow
    // Desc : Based on document type 38 and 39 (POS && POS Retrun document) Login Screen will appear as Authentication.
    // Category : POS
    CanInsertDeleteRow(): boolean {
        if ((this.DocumentType == 38 || this.DocumentType == 39) && BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Do Not Allow Row Insert and Delete")) {
            let UserLgn = new LoginViewModel(BaseService.router)
            UserLgn.IsPosMangr = true;
            UserLgn.ShowRememberMe = false;
            UserLgn.ShowDefaultCompany = false;
            UserLgn.LoginText = BaseService.GetResource("Com_OK");
            UserLgn.FeatureID = this.CostCenterID;
            UserLgn.FeatureName = "Do Not Allow Row Insert and Delete";
            UserLgn.Mode = (parseBoolean(this.IsEdit) ? 2 : 1);
            UserLgn.Title = "Authentication";
            BaseService.page.ShowDialog(UserLgn, LoginScreenComponent).subscribe(() => {
                return UserLgn.IsLoggedIn;
            })
        }
        return true;
    }

    // Name : CanDeleteRow
    // Desc : Validation before row deleting from gridview.
    // Category : COMMON
    CanDeleteRow(dr) {
        if (dr != null && this.ScreenObject.IsInventory) {
            if (Util.String(dr["IsScheme"]) == "Y" && Util.String(dr["SchemeID"]) == "2") {
                alert("Can't Delete Promotional Products");
                return false;
            }
            if (!Util.IsEmpty(dr["LinkType"]) && dr["LinkType"].toString() == "2") {
                alert("Can't Delete Mandatory linked Products");
                return false;
            }
            if (!Util.IsEmpty(dr["MaxSchemeID"]) && dr["IsScheme"].toString() == "Y" && dr["SchemeID"].toString() != "1") {
                alert("Can't Delete Scheme Product");
                return false;
            }

            if (this.ScreenObject.GridDataColumns.Contains("RemQty") && !Util.IsEmpty(dr["RemQty"])) {
                alert("Can't Delete first row");
                return false;
            }

            if (dr["LinkedQuantity"] != null && dr["LinkedQuantity"] != null && parseFloat(dr["LinkedQuantity"]) > 0) {
                alert("Cannot Delete Linked Product");
                return false;
            }

            if (!Util.IsEmpty(dr["ExecutedQty"]) && parseFloat(dr["ExecutedQty"]) > 0) {
                alert("Cannot Delete Executed Product");
                return false;
            }

            if (this.IsInventoryVoucher && !Util.IsEmpty(dr["LinkedInvDocDetailsID"]) && parseInt(dr["LinkedInvDocDetailsID"]) > 0
                && this.ScreenObject.Preferences.ContainsKey("LockLinkedRows") && this.ScreenObject.Preferences["LockLinkedRows"] != "" && parseBoolean(this.ScreenObject.Preferences["LockLinkedRows"])) {
                alert("Cannot Delete Linked Product");
                return false;
            }

            if (this.ScreenObject.GridDataColumns.Contains("IsKit") && dr != null && Util.String(dr["IsKit"]) == "2") {
                if (!(this.ScreenObject.GridDataColumns.Contains("landingType") && (Util.String(dr["landingType"]) == "1" || Util.String(dr["landingType"]) == "2")
                    && this.ScreenObject.GridData.filter(x => x.IsKit == 2 && x.ProductID_Key == Util.String(dr["ProductID_Key"])).length > 1)) {
                    alert("Can't Delete Kit sub Products");
                    return false;
                }
            }
        }

        if (this.ScreenObject.Preferences.ContainsKey("LineWisePDC") && parseBoolean(this.ScreenObject.Preferences["LineWisePDC"])
            && this.ScreenObject.GridDataColumns.Contains("RefStatusID") && !Util.IsEmpty(dr["RefStatusID"]) && parseInt(dr["RefStatusID"]) != 370
            && !Util.IsEmpty(dr["DocDetailsID"]) && parseInt(dr["DocDetailsID"]) > 0) {
            alert("Cannot Delete Converted PDC");
            return false;
        }

        return this.CanInsertDeleteRow();
    }

    // Name : OnBeforeRowDeleting
    // Desc : Row deleting from gridview.
    // Category : COMMON
    OnBeforeRowDeleting(dr, Validate) {
        if (Validate) {
            this.res = "NO";
            if (this.IsAutoPost && this.IsInventoryVoucher) {
                this.res = confirm("Are you sure you want to delete?") ? "Yes" : "No";
            }
            else {
                let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 55489);
                if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])
                    && !Util.IsEmpty(dr[dvCnt[0]["SysColumnName"]]) && !Util.IsEmpty(dr["DocDetailsID"]) && parseInt(dr["DocDetailsID"]) > 0) {
                    this.res = confirm("Are you sure you want to delete?\n Barcode will also be removed.") ? "Yes" : "No";
                }
                else {
                    this.res = confirm("Are you sure you want to delete?") ? "Yes" : "No";
                }
            }
        }
        else
            this.res = "Yes";

        if (this.res == "Yes") {
            if (dr != null && this.ScreenObject.IsInventory && !Util.IsEmpty(dr["LinkType"]) && dr["LinkType"].toString() == "0" && !Util.IsEmpty(dr["LinkID"])) {
                let drr: any = this.ScreenObject.GridData.filter(x => x.LinkID == dr["LinkID"].toString() && x.DocSeqNo != dr["DocSeqNo"]);
                drr.forEach(drtoDelete => {
                    this.ScreenObject.GridDataObj.removeRow(drtoDelete);
                })

                this.ScreenObject.GridDataObj.removeRow(dr);
                return false;
            }
            if (this.ScreenObject.GridDataColumns.Contains("IsKit") && dr != null && dr["IsKit"].toString() == "1") {
                let drr: any = this.ScreenObject.GridData.filter(x => x.IsKit == 2);
                drr.forEach(drtoDelete => {
                    this.ScreenObject.GridDataObj.removeRow(drtoDelete);
                })
                this.ScreenObject.GridDataObj.removeRow(dr);
                return false;
            }

            if (this.IsInventoryVoucher && !Util.IsEmpty(dr["MaxSchemeID"]) && this.ScreenObject.GridData.filter(x => x.MaxSchemeID == dr["MaxSchemeID"] && x.IsScheme == 'Y').length > 0) {
                if (this.ScreenObject.GridData.filter(x => x.MaxSchemeID == dr["MaxSchemeID"] && x.IsScheme == 'N').length > 1) {
                    let drrrows = this.ScreenObject.GridData.filter(x => x.MaxSchemeID == dr["MaxSchemeID"] && x.IsScheme == 'N');
                    if (drrrows[0] != dr) {
                        let ds = this.ScreenObject.GetSchemes(this.DocumentDate, drrrows[0]);
                        if (ds.Tables.length > 0 && ds.Columns[0].Contains("SchemeID"))
                            this.fillSchemevalues(ds.Tables[0], ds.Columns[0], drrrows[0]);

                        this.ApplySchemes(drrrows[0]);
                    }
                    else {
                        let ds = this.ScreenObject.GetSchemes(this.DocumentDate, drrrows[1]);
                        if (ds.Tables.length > 0 && ds.Columns[0].Contains("SchemeID"))
                            this.fillSchemevalues(ds.Tables[0], ds.Columns[0], drrrows[1]);

                        this.ApplySchemes(drrrows[1]);
                    }
                }
                else {
                    let drschemes = this.ScreenObject.GridData.filter(x => x.MaxSchemeID == dr["MaxSchemeID"] && x.IsScheme == 'Y');
                    drschemes.forEach(ddel => {
                        this.ScreenObject.GridDataObj.removeRow(ddel);
                    });
                }
            }
            if (this.AutoPostViewModel != null) {
                let roremove = this.AutoPostViewModel.ScreenObject.GridData.filter(x => x.RefSeqNo == dr["RefSeqNo"]);
                roremove.forEach(citem => {
                    this.AutoPostViewModel.ScreenObject.GridDataObj.removeRow(citem);
                });
                this.AutoPostViewModel.CalculateTotals(null, false);
            }
            this.CheckPackingWtVol(dr);
            this.ScreenObject.GridDataObj.removeRow(dr);
            return false;
        }
        return false;
    }

    // Name : onRoundOff
    // Desc : "f2" --- Gridview shortcut event will fire, Round off the column value.
    // if the column type is DataGridPactListBoxColumn substitute product pop will appear
    // if the column name is quantity && datatable contains the columnname "PackType" product Packing popup will appear
    // Category : COMMON
    onRoundOff(objEditCell: any) {
        if (objEditCell.column.className == "DataGridPactListBoxColumn") {
            let datarow = objEditCell.item;
            if (objEditCell.column.DgCol.CostCenterID == 3 && !Util.IsEmpty(datarow["ProductID_Key"]) && parseInt(datarow["ProductID_Key"]) > 0) {
                let dssubdata = this.ScreenObject.GetSubtituteProducts(parseInt(datarow["ProductID_Key"]), this.DocumentDate, datarow["DocDetailsID"].toString(), datarow);
                if (dssubdata.Tables.length > 0 && !dssubdata.Columns[0].Contains("ErrorMessage") && dssubdata.Tables[0].length > 0) {
                    let sb = new SubsituteProductsViewModel(this, dssubdata.Tables[0], dssubdata.Columns[0], dssubdata.Tables[1], datarow["ProductName"].toString(), datarow["ProductCode"].toString(), datarow["ProductID_Key"].toString())
                    if (sb.GridData.length > 0)
                        BaseService.page.ShowDialog(sb, SubsituteProductsComponent, { ShowCenter: true }).subscribe(() => this.SetFocusongrid = true);
                }
            }
            return;
        }
        else if (!this.IsInventoryVoucher || (objEditCell.Column != null && objEditCell.Column.GetType().toString() != "PactTextBoxEditor"))
            return;
        if (objEditCell.column) {
            let COlName = objEditCell.column.field;
            let dr = objEditCell.item;
            if (COlName.toLowerCase() == "quantity" && this.ScreenObject.GridDataColumns.Contains("PackType") && dr["PackType"].toString().toLowerCase() == "true")
                BaseService.page.ShowDialog(new FieldCalculatorViewModel(this, 6), FieldCalculatorComponent, { ShowCenter: true }).subscribe(() => {
                    let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == COlName);
                    this.RoundOffValue(dr, col);
                });
            else {
                let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == COlName);
                this.RoundOffValue(dr, col);
            }
        }
    }

    // Name : onFooterRoundOff
    // Desc : "f2" --- footer Gridview shortcut event will fire, Round off the column "Amount, CalcAmount" value.
    // Category : INVENTORY
    onFooterRoundOff(objEditCell: any) {
        if (!this.IsInventoryVoucher || objEditCell.Column.GetType().toString() != "PactTextBoxEditor")
            return;
        let dr = objEditCell.item;

        let COlName = objEditCell.column.field;
        if ((COlName == "Amount" || COlName == "CalcAmount") && !Util.IsEmpty(dr["ColumnName"])) {
            let ceil = this.GetCeilValue();
            if (ceil != 0) {
                if (Util.IsEmpty(dr[COlName]) || parseFloat(dr[COlName]) == 0)
                    this.SetFooterRoundoffValue(dr, ceil);
                else {
                    this.SetFooterRoundoffValue(dr, 0);
                    this.CalculateTotals(null, false);
                    ceil = this.GetCeilValue();
                    this.SetFooterRoundoffValue(dr, ceil);
                }
                this.CalculateTotals(null, false);
                this.ScreenObject.FooterGridDataObj.updateRow(dr);
            }

        }
    }

    // Name : SetFooterRoundoffValue
    // Desc : this function is being called from onFooterRoundOff method.
    // Category : INVENTORY
    SetFooterRoundoffValue(dr: any, Value: number) {
        dr["Amount"] = Value;
        dr["CalcAmount"] = Value;
    }

    // Name : GetCeilValue
    // Desc : return the Ceil value of the number.
    // Category : COMMON
    GetCeilValue(): number {
        let total = 0, exrate = 0;
        if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])
            && this.Currency != null && !Util.IsEmpty(this.Currency.ExchangeRate.Text) &&
            this.ScreenObject.Preferences.ContainsKey("NettotaldocumentCurrency") && this.ScreenObject.Preferences["NettotaldocumentCurrency"] != "" &&
            parseBoolean(this.ScreenObject.Preferences["NettotaldocumentCurrency"]) && Util.IsNum(this.Currency.ExchangeRate.Text))
            exrate = parseFloat(this.Currency.ExchangeRate.Text);
        if (exrate != 0)
            total = (this.GridNetTotal + this.FooterGridNetTotal) / exrate;
        else
            total = (this.GridNetTotal + this.FooterGridNetTotal);

        let dblCeill = total % 1;
        if (dblCeill < 0.5)
            dblCeill = -dblCeill;
        else
            dblCeill = 1 - dblCeill;
        return dblCeill;
    }

    // Name : RoundOffValue
    // Desc : this function is being called from onRoundOff method.
    // Category : INVENTORY
    RoundOffValue(dr: any, col: DgColumn) {
        if (col && col.DisplayMember.toLowerCase().Contains("dcnum")) {
            let ceil: number = this.GetCeilValue();
            if (ceil != 0) {
                if (Util.IsEmpty(dr[col.DisplayMember]) || parseFloat(dr[col.DisplayMember]) == 0)
                    this.SetRoundoffValue(dr, col, ceil);
                else {
                    this.SetRoundoffValue(dr, col, 0);
                    this.CalculateTotals(null, false);
                    ceil = this.GetCeilValue();
                    this.SetRoundoffValue(dr, col, ceil);
                }
                this.CalculateTotals(dr, false);
                this.ScreenObject.GridDataObj.updateRow(dr);
            }
        }
    }

    // Name : SetRoundoffValue
    // Desc : this function is being called from RoundOffValue method.
    // Category : INVENTORY
    SetRoundoffValue(dr: any, col: DgColumn, Value: number) {
        dr[col.DisplayMember] = Value.ToString("N" + col.DecimalPoints);
        dr["dcCalc" + col.DisplayMember] = Value.ToString("N" + col.DecimalPoints);
    }

    // Name : onEidtQuantity
    // Desc : this function is being called from shortcut key ex - Ctrl+f5("Distribute"), Ctrl+f3("DistributeQty"), Ctrl+f6("Copy"), Ctrl+f7("DistributeGen") etc.
    // Category : INVENTORY
    onEidtQuantity(sender: any) {

        if (sender != null && sender.toString() == "Quantity" && this.ScreenObject.SelectedGridRowIndex > 0) {
            let cno = this.ColumnNo;
            let qtycol = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.DisplayMember) && a.DisplayMember.toLowerCase() == "quantity");
            if (qtycol)
                this.ColumnNo = this.ScreenObject.ColumnSource.indexOf(qtycol) + 1;
            this.LineNo = this.ScreenObject.SelectedGridRowIndex;
            this.SetFocusongrid = true;

            this.ColumnNo = cno;
        }
        else if (sender != null && sender.toString() == "MovetoQty") {
            let RowPos = this.GetEmptyRowPosition(this.ScreenObject.GridDataObj, "ProductID_Key");
            if (RowPos < 0)
                return;
            let cno = this.ColumnNo;
            let qtycol = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.DisplayMember) && a.DisplayMember.toLowerCase() == "quantity");
            if (qtycol)
                this.ColumnNo = this.ScreenObject.ColumnSource.indexOf(qtycol) + 1;
            this.LineNo = RowPos;
            this.SetFocusongrid = true;
            this.ColumnNo = cno;
        }
        else if (sender != null && sender.toString() == "MovetoSKU" && this.SKU.Visible) {
            this.SKU.SetFocus = true;
        }
        else if (sender != null && sender.toString() == "Attachments") {
            if (this.SelectedRow) {
                let dr = this.SelectedRow;
                if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(dr["ProductID_Key"]) && parseInt(dr["ProductID_Key"]) > 0) {
                    let dsfiles = this.ScreenObject.GetAttachments(3, parseInt(dr["ProductID_Key"]));
                    if (dsfiles != null && dsfiles.Tables.length > 0 && dsfiles.Tables[0].length > 0 && dsfiles.Columns[0].Contains("FileID"))
                        BaseService.page.ShowDialog(new ProductAttachmentViewModel(this, dsfiles.Tables[0], "")
                            , ProductAttachmentsComponent, { ShowCenter: true });
                }
                else if (!this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(dr["AccountID_Key"]) && parseInt(dr["AccountID_Key"]) > 0) {
                    let accname = "";
                    if (this.ScreenObject.GridDataColumns.Contains("accountName") && !Util.IsEmpty(dr["accountName"]))
                        accname = dr["accountName"].toString();
                    else if (this.ScreenObject.GridDataColumns.Contains("accountcode") && !Util.IsEmpty(dr["accountcode"]))
                        accname = dr["accountcode"].toString();
                    let dsfiles = this.ScreenObject.GetAttachments(2, parseInt(dr["AccountID_Key"]));
                    if (dsfiles != null && dsfiles.Tables.length > 0 && dsfiles.Tables[0].length > 0 && dsfiles.Columns[0].Contains("FileID"))
                        BaseService.page.ShowDialog(new ProductAttachmentViewModel(this, dsfiles.Tables[0], accname)
                            , ProductAttachmentsComponent, { ShowCenter: true });

                }
                else if (!this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(dr["CreditAccount_Key"]) && parseInt(dr["CreditAccount_Key"]) > 0) {
                    let accname = "";
                    if (this.ScreenObject.GridDataColumns.Contains("accountName") && !Util.IsEmpty(dr["accountName"]))
                        accname = dr["accountName"].toString();
                    else if (this.ScreenObject.GridDataColumns.Contains("accountcode") && !Util.IsEmpty(dr["accountcode"]))
                        accname = dr["accountcode"].toString();
                    let dsfiles = this.ScreenObject.GetAttachments(2, parseInt(dr["CreditAccount_Key"]));
                    if (dsfiles != null && dsfiles.Tables.length > 0 && dsfiles.Tables[0].length > 0 && dsfiles.Columns[0].Contains("FileID"))
                        BaseService.page.ShowDialog(new ProductAttachmentViewModel(this, dsfiles.Tables[0], accname)
                            , ProductAttachmentsComponent, { ShowCenter: true });
                }
                else if (!this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(dr["DebitAccount_Key"]) && parseInt(dr["DebitAccount_Key"]) > 0) {
                    let accname = "";
                    if (this.ScreenObject.GridDataColumns.Contains("accountName") && !Util.IsEmpty(dr["accountName"]))
                        accname = dr["accountName"].toString();
                    else if (this.ScreenObject.GridDataColumns.Contains("accountcode") && !Util.IsEmpty(dr["accountcode"]))
                        accname = dr["accountcode"].toString();
                    let dsfiles = this.ScreenObject.GetAttachments(2, parseInt(dr["DebitAccount_Key"]));
                    if (dsfiles != null && dsfiles.Tables.length > 0 && dsfiles.Tables[0].length > 0 && dsfiles.Columns[0].Contains("FileID"))
                        BaseService.page.ShowDialog(new ProductAttachmentViewModel(this, dsfiles.Tables[0], accname)
                            , ProductAttachmentsComponent, { ShowCenter: true });
                }
            }
        }
        else if (sender != null && sender.toString() == "FreeProds") {
            if (this.SelectedRow != null && this.ScreenObject.Preferences.ContainsKey("EnablePromotions")
                && this.ScreenObject.Preferences["EnablePromotions"] != "" && parseBoolean(this.ScreenObject.Preferences["EnablePromotions"])) {
                BaseService.page.ShowDialog(new DynamicSetViewModel(this, this.SelectedRow, null, 1), DynamicSetComponent);
            }
        }
        else if (sender != null && (sender.toString() == "Distribute" || sender.toString() == "DistributeQty")) {
            BaseService.page.ShowDialog(new DynamicSetViewModel(this, this.SelectedRow, null, (sender.toString() == "Distribute") ? 2 : 3)
                , DynamicSetComponent);
        }
        else if (sender != null && (sender.toString() == "DistributeGen")) {
            BaseService.page.ShowDialog(new DynamicSetViewModel(this, this.SelectedRow, null, 4)
                , DynamicSetComponent, { ShowCenter: true });
        }
        else if (sender != null && sender.toString() == "Copy") {
            if (this.IsPOs)
                this.onCopy(sender);
            else if (this.DocumentType == 5 && this.ScreenObject.GridDataColumns.Contains("RecievedQty")) {
                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"])
                        && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) > 0) {
                        this.ScreenObject.GridData[i]["RecievedQty"] = this.ScreenObject.GridData[i]["Quantity"];
                    }
                }
            }
        }
    }

    // Name : onShowImage
    // Desc : show product image as popup on columns change event in grid.
    // Category : INVENTORY
    onShowImage(objEditCell: any) {
        if (objEditCell && objEditCell.item) {
            let drcurrentrow = objEditCell.item;
            if (this.ScreenObject.GridDataColumns.Contains("FileExtension"))
                this.ShowProductImage(drcurrentrow);
        }
    }

    // Name : onFieldCalc
    // Desc : Field Calculater pop up. fire when the F7 key press in grid, field calculator display one grid row to popup form, where we can calculate fields value and return calculated value to gridview row.
    // Category : INVENTORY
    onFieldCalc(objEditCell: any) {
        //commmented POPUP
        // if (!this.IsInventoryVoucher)
        // {
        //     let datarow = objEditCell.item;
        //     if (this.ScreenObject.DocumentType == 18 || this.ScreenObject.DocumentType == 19 || this.ScreenObject.DocumentType == 21 || this.ScreenObject.DocumentType == 22)
        //     {
        //         if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(datarow["CreditAccount_Key"])
        //         && this.ScreenObject.GridDataColumns.Contains("Amount") && !Util.IsEmpty(datarow["Amount"]))
        //         {
        //             this.CheckDistCosts(parseInt(datarow["CreditAccount_Key"]), datarow, parseFloat(datarow["Amount"]), "Amount", true);
        //         }
        //     }
        //     else if (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 15 || this.ScreenObject.DocumentType == 20 || this.ScreenObject.DocumentType == 23)
        //     {
        //         if (!Util.IsEmpty(datarow["DebitAccount_Key"]))
        //         {
        //             if (!Util.IsEmpty(datarow["Amount"]))
        //             {
        //                 this.CheckDistCosts(parseInt(datarow["DebitAccount_Key"]), datarow, parseFloat(datarow["Amount"]), "Amount", true);
        //             }
        //         }
        //     }
        //     else if (!Util.IsEmpty(datarow["AccountID_Key"]) && !Util.IsEmpty(datarow["DebitAmount"]))
        //     {
        //         this.CheckDistCosts(parseInt(datarow["AccountID_Key"]), datarow, parseFloat(datarow["DebitAmount"]), "DebitAmount", true);
        //     }
        //     else if (Util.Int(datarow["CreditAmount"]) != 0 && !Util.IsEmpty(datarow["AccountID_Key"]))
        //     {
        //         this.CheckDistCosts(parseInt(datarow["AccountID_Key"]), datarow, parseFloat(datarow["CreditAmount"]), "CreditAmount", true);
        //     }
        // }

        if (BaseService.SessionManager.IsActionAssigned(43, "EnableFieldCalculator") && this.ScreenObject.Preferences.ContainsKey("FieldCalculator") && this.ScreenObject.Preferences["FieldCalculator"] != "" && parseBoolean(this.ScreenObject.Preferences["FieldCalculator"])
            && objEditCell != null && objEditCell.item != null) {
            BaseService.page.ShowDialog(new FieldCalculatorViewModel(this, 0), FieldCalculatorComponent, { ShowCenter: true, Title: "Field calculator" });
        }
    }

    // Name : onSearchProduct
    // Desc : Multiple pop up appear here like(Product search, hold quantity, bins, batches and billwise). fire when the F3 key press in grid.
    // Category : INVENTORY
    onSearchProduct(objEditCell: any) {
        let column = objEditCell.column
        let ind = this.ScreenObject.SelectedGridRowIndex;
        if (objEditCell.column == null)
            return;
        if (column.className == "DataGridPactListBoxColumn") { //  we can search different product and select it.
            let srccol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == objEditCell.column.field);
            let GRIDVIEWID = 0;
            if (srccol)
                GRIDVIEWID = srccol.GridViewID;
            if (column.DgCol.CostCenterID == 3 || GRIDVIEWID > 0) {
                if (GRIDVIEWID == 0)
                    GRIDVIEWID = 268;
                BaseService.page.ShowDialog(new ProductSearchCatalogViewModel(this, GRIDVIEWID, column.DgCol.CostCenterID, srccol, null), ProductSearchCatalogComponent);
            }
        }
        else if (column.className == "PactTextBoxEditor") { // column type PactTextBox
            let VarFldName = "";
            if (this.DocumentType == 32) {
                var fld = this.ScreenObject.Preferences.ContainsKey("VarienceField") ? this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["VarienceField"]) : null;
                if (fld != undefined)
                    VarFldName = fld.DisplayMember;
            }
            //Below condition show Hold Quantity Pop up, document should be in edit mode.
            if (objEditCell.column.field.toLowerCase() == "holdquantity") {
                if (this.SelectedRow && !Util.IsEmpty(this.SelectedRow["DocDetailsID"]) && parseInt(this.SelectedRow["DocDetailsID"]) > 0)
                    BaseService.page.ShowDialog(new HoldQtyViewModel(this), HoldQtyComponent);
            }
            // Batch popup will appear... 
            else if (((objEditCell.column.field.toLowerCase() == "quantity" && !Util.IsEmpty(this.SelectedRow["Quantity"]))
                || (objEditCell.column.field == "FreeQTY" && !Util.IsEmpty(this.SelectedRow["FreeQTY"]))
                || (this.DocumentType == 31 && objEditCell.column.field.toLowerCase().startsWith("dcnum") && !Util.IsEmpty(this.SelectedRow[objEditCell.column.field]))
                || (this.DocumentType == 32 && VarFldName != '' && objEditCell.Column.field == VarFldName && this.SelectedRow[objEditCell.Column.field].toString() != ""))
                && this.SelectedRow != null && Util.Int(this.SelectedRow["Type"]) == 5) {

                //#region show Bateches
                if ((this.ScreenObject.Preferences.ContainsKey("ShowBatches") && this.ScreenObject.Preferences["ShowBatches"] != "" && parseBoolean(this.ScreenObject.Preferences["ShowBatches"]))
                    || !this.DonotUpdateInventory || this.DocumentType == 31) {
                    /***if (objEditCell.Owner.CurrentCellContainer.IsEditing == true && this.DocumentType != 31) {
                        objEditCell.Owner.OnTabKeyDown(null);

                        if (this.VoucherType == -1 && this.ScreenObject.Preferences.ContainsKey("AutoBatches") && this.ScreenObject.Preferences["AutoBatches"] != "" && parseBoolean(this.ScreenObject.Preferences["AutoBatches"])) {
                            this.fillbatches(this.SelectedRow, objEditCell.column.field);
                            let cno = this.ColumnNo;
                            this.ColumnNo = objEditCell.Column.DisplayIndex + 2;
                            this.LineNo = ind + 1;
                            this.SetFocusongrid = true;
                            this.ColumnNo = cno;
                        }
                        return;
                    }
                    else {
                        if (objEditCell.Owner.CurrentCellContainer.IsEditing == true)
                            objEditCell.Owner.OnTabKeyDown(null);***/
                    this.fillbatches(this.SelectedRow, objEditCell.column.field);// Calling fillbatches method
                    let cno = this.ColumnNo;
                    this.ColumnNo = objEditCell.column.DisplayIndex + 2;
                    this.LineNo = ind + 1;
                    this.SetFocusongrid = true;
                    this.ColumnNo = cno;
                    return;
                    /***} ***/
                }
                //#endregion
            }
            // Bin popup will appear... 
            else if (objEditCell.column.field.toLowerCase() == "quantity" && this.SelectedRow["Type"].toString() != "2" && this.SelectedRow["Type"].toString() != "5" && !Util.IsEmpty(this.SelectedRow["BinWise"])
                && this.SelectedRow["BinWise"].toString() == "True" && !Util.IsEmpty(this.SelectedRow["Quantity"])) {
                this.AddBins(this.SelectedRow, false, false, null);
            }
            // Serial Number popup will appear... 
            else if (((!this.DonotUpdateInventory && (objEditCell.column.field.toLowerCase() == "quantity" || objEditCell.column.field.toLowerCase() == "recievedqty" || objEditCell.column.field.toLowerCase() == "freeqty"))
                || (this.DocumentType == 31 && objEditCell.Column.field.toLowerCase().startsWith("dcnum") && !Util.IsEmpty(this.SelectedRow[objEditCell.Column.field]))
                || (this.DocumentType == 32 && VarFldName != "" && objEditCell.Column.field == VarFldName && !Util.IsEmpty(this.SelectedRow[objEditCell.Column.field])))
                && !Util.IsEmpty(this.SelectedRow["Type"]) && parseInt(this.SelectedRow["Type"]) == 2) {
                if (this.ScreenObject.DocumentType == 30) {
                    if (this.ScreenObject.GridDataColumns.Contains("VoucherType") && !Util.IsEmpty(this.SelectedRow["VoucherType"]))
                        this.VoucherType = parseInt(this.SelectedRow["VoucherType"]);
                    else
                        this.VoucherType = 0;
                }

                if (!Util.IsEmpty(this.SelectedRow[objEditCell.column.field.toLowerCase()]) && (parseFloat(this.SelectedRow[objEditCell.column.field.toLowerCase()]) > 0
                    || (this.ScreenObject.DocumentType == 32 && parseFloat(this.SelectedRow[objEditCell.column.field.toLowerCase()].toString()) < 0))) {
                    let ObjSerialNumber = new SerialNumberViewModel(this, objEditCell.column.field.toLowerCase(), this.VoucherType, 0, this.SelectedRow);
                    BaseService.page.ShowDialog(ObjSerialNumber, SerialNumberComponent, { NoWidth: true });
                }
            }
            // BillWisepopup will appear, based on amount or creditamount or debitamount.
            else if (objEditCell.column.field.toLowerCase() == "amount" || objEditCell.column.field.toLowerCase() == "debitamount" || objEditCell.column.field.toLowerCase() == "creditamount") {
                let datarow = objEditCell.item;
                let strBindingPaths = column.field;
                let CurrID = 1; let ExhgRate = 1;
                if (this.Currency != null && this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue != "")
                    CurrID = parseInt(this.Currency.Currency.SelectedValue);
                else if (this.ScreenObject.GridDataColumns.Contains("CurrencyID") && !Util.IsEmpty(datarow["CurrencyID_Key"]))
                    CurrID = parseInt(datarow["CurrencyID_Key"]);
                if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                    ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
                else if (this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && !Util.IsEmpty(datarow["ExchangeRate"]))
                    ExhgRate = parseFloat(datarow["ExchangeRate"]);

                if (strBindingPaths == "Amount") {
                    if (datarow[strBindingPaths] != null && parseFloat(datarow[strBindingPaths]) != 0) {
                        if (this.ScreenObject.DocumentType == 18 || this.ScreenObject.DocumentType == 19 || this.ScreenObject.DocumentType == 21 || this.ScreenObject.DocumentType == 22) {
                            if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(datarow["CreditAccount_Key"])) {
                                if (!Util.IsEmpty(datarow[strBindingPaths])) {
                                    this.CheckIsBillWise(parseInt(datarow["CreditAccount_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), true, CurrID, ExhgRate);
                                }
                            }
                        }
                        else if (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 15 || this.ScreenObject.DocumentType == 20 || this.ScreenObject.DocumentType == 23) {
                            if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(datarow["DebitAccount_Key"])) {
                                if (!Util.IsEmpty(datarow[strBindingPaths])) {
                                    this.CheckIsBillWise(parseInt(datarow["DebitAccount_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), false, CurrID, ExhgRate);
                                }
                            }
                        }
                    }
                }
                else if (strBindingPaths == "DebitAmount") {
                    if (datarow[strBindingPaths] != null && parseFloat(datarow[strBindingPaths]) != 0 && !Util.IsEmpty(datarow["AccountID_Key"])) {
                        if (!Util.IsEmpty(datarow[strBindingPaths])) {
                            this.CheckIsBillWise(parseInt(datarow["AccountID_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), false, CurrID, ExhgRate);

                        }
                    }
                }
                else if (strBindingPaths == "CreditAmount") {
                    if (Util.Double(datarow[strBindingPaths]) != 0 && !Util.IsEmpty(datarow["AccountID_Key"])) {
                        this.CheckIsBillWise(parseInt(datarow["AccountID_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), true, CurrID, ExhgRate);
                    }
                }
            }
        }

        this.LineNo = ind + 1;
        this.SetFocusongrid = true;
    }

    // Name : onDistDim
    // Desc : Distribute cost with dimension pop up, need to configure in globle preference. fire when the ctrl+F2 key press in grid.
    // Category : COMMON
    public onDistDim(objEditCell: any) {
        if (objEditCell.column.className == "PactTextBoxEditor") {
            let COlName = objEditCell.column.field;
            let col: any = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == COlName);
            if (col == undefined)
                col = this.ScreenObject.ColumnSource.find(a => a.distDim > 50000 && a.DefaultValueText.toLowerCase() == COlName.toLowerCase());
            if (col.distDim > 50000) {
                this.ONDisDim(COlName);
            }
        }
    }
    // Name : onDistDim
    // Desc : Distribute cost with dimension pop up, need to configure in globle preference. fire when the ctrl+F2 key press in grid.
    // Category : COMMON
    public ONDisDim(COlName: string) {
        let showjv = new ShowJVViewModel();
        showjv.ShowJVViewModel_2(this, COlName, 7);
        BaseService.page.ShowDialog(showjv, ShowJVComponent, { ShowCenter: true, Title: showjv.Title });

    }

    // Name : onDistribute
    // Desc : Distribute value in rows & Bill of Entry popup . fire when the F5 key press in grid.
    // Category : COMMON
    async onDistribute(objEditCell: any) {

        let datarow: any = objEditCell.item;
        let Column: DgColumn = objEditCell.column.DgCol;
        let strBindingPaths: string = objEditCell.column.field;
        if (objEditCell.column.className == "DataGridComboBoxColumn")
            strBindingPaths = Column.ValueMember;
        else
            strBindingPaths = Column.DisplayMember;

        if (objEditCell.column.className == "DataGridPactListBoxColumn") {
            if (Column.CostCenterID == 3) {
                if (this.ScreenObject.Preferences.ContainsKey("UseQtyAdjustment") && this.ScreenObject.Preferences["UseQtyAdjustment"] != "" && parseBoolean(this.ScreenObject.Preferences["UseQtyAdjustment"])
                    && this.ScreenObject.GridDataColumns.Contains("QtyType") && !Util.IsEmpty(objEditCell.item["QtyType"]) && (objEditCell.item["QtyType"].toString() == "1" || objEditCell.item["QtyType"].toString() == "2")) {
                    BaseService.page.ShowDialog(new FieldCalculatorViewModel(this, 1), FieldCalculatorComponent, { ShowCenter: true });
                }
                else if (this.ScreenObject.Preferences.ContainsKey("TempInfo") && this.ScreenObject.Preferences["TempInfo"] != "" && parseBoolean(this.ScreenObject.Preferences["TempInfo"])) {
                    const { TempProductInfoViewModel } = await import('../temp-product-info/TempProductInfoViewModel')
                    const { TempProductInfoComponent } = await import('../temp-product-info/temp-product-info.component')
                    let obj = new TempProductInfoViewModel(this);
                    await BaseService.page.openDialog(obj, TempProductInfoComponent, {});
                }
            }
            return;
        }

        let COlName = objEditCell.column.field;
        //#region Bill Of Entry
        if (COlName.toLowerCase() == "quantity") {
            if (this.ScreenObject.GridDataColumns.Contains("landingType")
                && (objEditCell.item["landingType"].toString() == "1" || objEditCell.item["landingType"].toString() == "2")
                && (!this.ScreenObject.GridDataColumns.Contains("VoucherType") || objEditCell.item["VoucherType"].toString() == "-1")) {
                //objEditCell.Column.DataGridOwner.CommitEdit();
                if (this.ScreenObject.GridDataObj.angularGrid)
                    this.ScreenObject.GridDataObj.angularGrid.slickGrid.getEditorLock().commitCurrentEdit();
                BaseService.page.ShowDialog(new FieldCalculatorViewModel(this, 2), FieldCalculatorComponent)
            }
            if (this.ScreenObject.GridDataColumns.Contains("IsTestCase")) {
                this.res = "YES";
                let fld = new FieldCalculatorViewModel(this, 4)
                if (this.res != "NO")
                    BaseService.page.ShowDialog(fld, FieldCalculatorComponent)
            }
        }
        //#endregion

        //#region Distribute Value
        let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == COlName);
        if (col && col.DisplayMember.toLowerCase().Contains("dcnum") && col.DistributeColName != null
            && col.DistributeColName != "" && this.ScreenObject.GridDataColumns.Contains(col.DistributeColName)) {
            //objEditCell.Column.DataGridOwner.CommitEdit();
            if (this.ScreenObject.GridDataObj.angularGrid)
                this.ScreenObject.GridDataObj.angularGrid.slickGrid.getEditorLock().commitCurrentEdit();
            if (Util.IsNum(objEditCell.item[COlName])) {
                if (confirm(BaseService.GetResource("Doyouwanttodistribute"))) {
                    //objEditCell.Column.DataGridOwner.CommitEdit();
                    if (this.ScreenObject.GridDataObj.angularGrid)
                        this.ScreenObject.GridDataObj.angularGrid.slickGrid.getEditorLock().commitCurrentEdit();

                    let depon = "", depval = "";
                    if (!Util.IsEmpty(col.DependantOn) && this.ScreenObject.GridDataColumns.Contains(col.DependantOn + "_Key")) {
                        depon = col.DependantOn + "_Key";
                        if (!Util.IsEmpty(objEditCell.item[depon]))
                            depval = objEditCell.item[depon].toString();
                    }
                    this.DistributeValues(COlName, parseFloat(objEditCell.item[COlName]), col.DistributeColName, true, depon, depval);
                }
            }
        }
        //#endregion
    }

    // Name : GetColName
    // Desc : Returning column name.
    // Category : COMMON
    GetColName(): string { // Returning column name
        if (this.ScreenObject == null)
            return '';
        if (this.IsInventoryVoucher)
            return "ProductID_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key"))
            return "CreditAccount_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key"))
            return "DebitAccount_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key"))
            return "AccountID_Key";
        return '';
    }

    // Name : DistributeValues
    // Desc : Distribute value based on quantiy in other column of grid . this method calls from onDistribute.
    // Category : COMMON
    DistributeValues(ColumnName: string, Value: number, BaseColName: string, CalcTotal: boolean, depon: string = "", depval: string = "") {
        let colName = '';
        if (this.IsInventoryVoucher)
            colName = "ProductID_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key"))
            colName = "CreditAccount_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key"))
            colName = "DebitAccount_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key"))
            colName = "AccountID_Key";
        let TotValu = 0;
        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName]) && !Util.IsEmpty(this.ScreenObject.GridData[i][BaseColName]) && Util.IsNum(this.ScreenObject.GridData[i][BaseColName])) {
                if (depon != "" && this.ScreenObject.GridData[i][depon].toString() != depval)
                    continue;

                TotValu += parseFloat(this.ScreenObject.GridData[i][BaseColName]);
            }
        }
        let lastRow = 0;
        let ValueUsed = 0;
        let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == ColumnName);
        if (!col && ColumnName.toLowerCase().Contains("dccalc"))
            col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == ColumnName.replace("dcCalc", ""));
        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName])) {
                if (depon != "" && this.ScreenObject.GridData[i][depon].toString() != depval)
                    continue;
                if (TotValu > 0 && !Util.IsEmpty(this.ScreenObject.GridData[i][BaseColName]) && Util.IsNum(this.ScreenObject.GridData[i][BaseColName])) {
                    let val = (parseFloat(this.ScreenObject.GridData[i][BaseColName]) / TotValu) * Value;

                    if (col && col.DecimalPoints != null && col.DecimalPoints != "")
                        this.ScreenObject.GridData[i][ColumnName] = val.ToString("N" + col.DecimalPoints);
                    else
                        this.ScreenObject.GridData[i][ColumnName] = val;

                    ValueUsed += parseFloat(this.ScreenObject.GridData[i][ColumnName]);
                    lastRow = i;
                }
                else
                    this.ScreenObject.GridData[i][ColumnName] = 0;
                if (CalcTotal)
                    this.CalculateTotals(this.ScreenObject.GridData[i], false, ColumnName, false);
            }
        }
        if (lastRow > 0 && Value - ValueUsed != 0) {
            let val = parseFloat(this.ScreenObject.GridData[lastRow][ColumnName]) + Value - ValueUsed;

            if (col && col.DecimalPoints != null && col.DecimalPoints != "")
                this.ScreenObject.GridData[lastRow][ColumnName] = val.ToString("N" + col.DecimalPoints);
            else
                this.ScreenObject.GridData[lastRow][ColumnName] = val;
            if (CalcTotal)
                this.CalculateTotals(this.ScreenObject.GridData[lastRow], false, ColumnName, false);
        }
        if (CalcTotal)
            this.CalculateTotals(null, false);
    }

    TempGridDataCopy = [];
    isGridDataCopy = false;
    // Name : Bidding_DistributeValues
    // Desc : Distribute value based on column which is  of grid . this method calls from onDistribute.
    // Category : COMMON
    Bidding_DistributeValues(ColumnName: string, BaseColName: string, CalcTotal: boolean, DecByValue: number = 0) {

        if (!this.isGridDataCopy) {
            this.TempGridDataCopy = this.ScreenObject.GridData.map(u => Object.assign({}, u, {}));
            this.isGridDataCopy = true;
        }
        let colName = '';
        if (this.IsInventoryVoucher)
            colName = "ProductID_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key"))
            colName = "CreditAccount_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key"))
            colName = "DebitAccount_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key"))
            colName = "AccountID_Key";
        let TotValu = 0;
        // for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
        //     if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName]) && !Util.IsEmpty(this.ScreenObject.GridData[i][BaseColName]) && Util.IsNum(this.ScreenObject.GridData[i][BaseColName])) {
        //         TotValu += parseFloat(this.ScreenObject.GridData[i][ColumnName]);
        //     }
        // }
        for (let i = 0; i < this.TempGridDataCopy.length; i++) {
            if (!Util.IsEmpty(this.TempGridDataCopy[i][colName]) && !Util.IsEmpty(this.TempGridDataCopy[i][BaseColName]) && Util.IsNum(this.TempGridDataCopy[i][BaseColName])) {
                TotValu += parseFloat(this.TempGridDataCopy[i][ColumnName]);
            }
        }


        let resWord: any = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 7809);
        if (resWord.length > 0) {
            if (this.ScreenObject.GridDataColumns.Contains(resWord[0]["SysColumnName"])) {

                let DecreasedList = [];

                let lastRow = 0;
                let ValueUsed = 0;
                let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == resWord[0]["SysColumnName"]);

                // for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                //     if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName])) {
                //         if (TotValu > 0 && !Util.IsEmpty(this.ScreenObject.GridData[i][BaseColName]) && Util.IsNum(this.ScreenObject.GridData[i][BaseColName])) {
                //             let val = (parseFloat(this.ScreenObject.GridData[i][ColumnName]) / TotValu ) * DecByValue;
                //             let drVal = {};
                //             drVal["DocDetailsID"] = this.ScreenObject.GridData[i]["DocDetailsID"];
                //             drVal["Gross"] = this.ScreenObject.GridData[i][ColumnName];
                //             drVal["Quantity"] = this.ScreenObject.GridData[i]["Quantity"];

                //             drVal["DecreaseVal"] = val;

                //             ValueUsed += (val);
                //             lastRow = i;
                //             let NewGrorss =  drVal["NewGross"] = (this.ScreenObject.GridData[i][ColumnName] - val)
                //             let RateVal = NewGrorss / this.ScreenObject.GridData[i]["Quantity"];

                //             if (col && col.DecimalPoints != null && col.DecimalPoints != "")
                //                 drVal["NewRate"] = RateVal.ToString("N" + col.DecimalPoints);
                //             else
                //                 drVal["NewRate"] = RateVal;

                //             DecreasedList.push(drVal);
                //         }
                //     }
                // }

                for (let i = 0; i < this.TempGridDataCopy.length; i++) {
                    if (!Util.IsEmpty(this.TempGridDataCopy[i][colName])) {
                        if (TotValu > 0 && !Util.IsEmpty(this.TempGridDataCopy[i][BaseColName]) && Util.IsNum(this.TempGridDataCopy[i][BaseColName])) {
                            let val = (parseFloat(this.TempGridDataCopy[i][ColumnName]) / TotValu) * DecByValue;
                            let drVal = {};
                            drVal["DocDetailsID"] = this.TempGridDataCopy[i]["DocDetailsID"];
                            drVal["Gross"] = this.TempGridDataCopy[i][ColumnName];
                            drVal["Quantity"] = this.TempGridDataCopy[i]["Quantity"];
                            drVal["Rate"] = this.TempGridDataCopy[i]["Rate"];

                            drVal["DecreaseVal"] = val;

                            ValueUsed += (val);
                            lastRow = i;
                            let NewGrorss = drVal["NewGross"] = (this.TempGridDataCopy[i][ColumnName] - val)
                            let RateVal = NewGrorss / this.TempGridDataCopy[i]["Quantity"];

                            if (col && col.DecimalPoints != null && col.DecimalPoints != "")
                                drVal["NewRate"] = RateVal.ToString("N" + col.DecimalPoints);
                            else
                                drVal["NewRate"] = RateVal;

                            DecreasedList.push(drVal);
                        }
                    }
                }

                if (lastRow > 0 && DecByValue - ValueUsed != 0) {
                    let val = parseFloat(DecreasedList[lastRow]["DecreaseVal"]) + DecByValue - ValueUsed;

                    let NewGrorss = DecreasedList[lastRow]["NewGross"] = (DecreasedList[lastRow]["Gross"] - val)
                    let RateVal = NewGrorss / DecreasedList[lastRow]["Quantity"];

                    if (col && col.DecimalPoints != null && col.DecimalPoints != "")
                        DecreasedList[lastRow]["NewRate"] = RateVal.ToString("N" + col.DecimalPoints);
                    else
                        DecreasedList[lastRow]["NewRate"] = RateVal;

                }
                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName])) {
                        for (let j = 0; j < DecreasedList.length; j++) {
                            const element = DecreasedList[j];

                            if (this.ScreenObject.GridData[i]["DocDetailsID"] == DecreasedList[j]["DocDetailsID"]) {
                                this.ScreenObject.GridData[i][resWord[0]["SysColumnName"]] = parseFloat(DecreasedList[j]["Rate"]) - parseFloat(DecreasedList[j]["NewRate"]);
                                this.Celleditend(this.ScreenObject.GridData[i], resWord[0]["SysColumnName"], 0);
                                //this.ScreenObject.GridDataObj.updateRow(this.ScreenObject.GridData[i]);
                                this.Celleditend(this.ScreenObject.GridData[i], "Rate", 0);
                                //this.ScreenObject.GridDataObj.updateRow(this.ScreenObject.GridData[i]);
                                //this.CalculateTotals(this.ScreenObject.GridData[i], false, resWord[0]["SysColumnName"], true);
                            }
                        }

                    }
                }
                this.DisplayMessage = "Decreased Successfully";
            }
        }

        //#region Old Code
        // let DecreasedList = [];

        // let lastRow = 0;
        // let ValueUsed = 0;
        // let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Rate");

        // for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
        //     if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName])) {
        //         if (TotValu > 0 && !Util.IsEmpty(this.ScreenObject.GridData[i][BaseColName]) && Util.IsNum(this.ScreenObject.GridData[i][BaseColName])) {
        //             let val = (parseFloat(this.ScreenObject.GridData[i][ColumnName]) / TotValu ) * DecByValue;
        //             let drVal = {};
        //             drVal["DocDetailsID"] = this.ScreenObject.GridData[i]["DocDetailsID"];
        //             drVal["Gross"] = this.ScreenObject.GridData[i][ColumnName];
        //             drVal["Quantity"] = this.ScreenObject.GridData[i]["Quantity"];

        //             drVal["DecreaseVal"] = val;

        //             ValueUsed += (val);
        //             lastRow = i;
        //             let NewGrorss =  drVal["NewGross"] = (this.ScreenObject.GridData[i][ColumnName] - val)
        //             let RateVal = NewGrorss / this.ScreenObject.GridData[i]["Quantity"];

        //             if (col && col.DecimalPoints != null && col.DecimalPoints != "")
        //                 drVal["NewRate"] = RateVal.ToString("N" + col.DecimalPoints);
        //             else
        //                 drVal["NewRate"] = RateVal;

        //             DecreasedList.push(drVal);
        //         }
        //     }
        // }

        // if (lastRow > 0 && DecByValue - ValueUsed != 0) {
        //     let val = parseFloat(DecreasedList[lastRow]["DecreaseVal"]) + DecByValue - ValueUsed;

        //     let NewGrorss = DecreasedList[lastRow]["NewGross"] = (DecreasedList[lastRow]["Gross"] - val)
        //     let RateVal = NewGrorss / DecreasedList[lastRow]["Quantity"];

        //     if (col && col.DecimalPoints != null && col.DecimalPoints != "")
        //         DecreasedList[lastRow]["NewRate"] = RateVal.ToString("N" + col.DecimalPoints);
        //     else
        //         DecreasedList[lastRow]["NewRate"] = RateVal;

        // }
        // for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
        //     if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName])) {
        //         for (let j = 0; j < DecreasedList.length; j++) {
        //             const element = DecreasedList[j];

        //             if (this.ScreenObject.GridData[i]["DocDetailsID"] == DecreasedList[j]["DocDetailsID"]) {
        //                 this.ScreenObject.GridData[i]["Rate"] = DecreasedList[j]["NewRate"];
        //                 this.CalculateTotals(this.ScreenObject.GridData[i], false, "Rate", true);
        //             }
        //         }

        //     }
        // }
        //#endregion

    }

    // Name : onCopy
    // Desc : fire when the F6 key press in grid. it copy current cell value to other rows of current column in grid, ex:- first row quantity column value is 10 then press F6, second & third row quantity column value sets to 10 by default.
    // Category : COMMON
    onCopy(objEditCell: any) {
        let ColtoCheck = this.GetPrimaryColName();
        if (ColtoCheck == "")
            return;
        let ename = objEditCell.column.className;
        if (ename != "DataGridPactListBoxColumn")
            objEditCell.grid.getEditorLock().commitCurrentEdit();

        let COlName = "";

        if (ename == "DataGridPactComboBoxColumn")
            COlName = objEditCell.column.field;
        else
            COlName = objEditCell.column.field;


        //let Dr = confirm(BaseService.GetResource("overrideallNotocopyblank"))//, "Info", MessageBoxButton.YesNoCancel);

        let mesres = confirm(BaseService.GetResource("overrideallNotocopyblank"));

        if (!mesres)
            return;

        let dv = this.ScreenObject.GridData;
        let drsel = objEditCell.item;
        for (let i = 0; i < dv.length; i++) {
            if (ename == "DataGridPactListBoxColumn")
                objEditCell.grid.getEditorLock().commitCurrentEdit();
            if (!Util.IsEmpty(dv[i][ColtoCheck])) {

                if (!mesres && (!Util.IsEmpty(dv[i][COlName]) && !(this.ScreenObject.GridDataObj.DataTypes.Double.Contains(COlName) && parseFloat(dv[i][COlName].toString()) == 0)))
                    continue;

                dv[i][COlName] = drsel[COlName].toString();
                if (this.DocumentType == 45 && COlName.toLowerCase() == "dcalpha13" && this.ScreenObject.GridDataColumns.Contains("AssignXML"))
                    dv[i]["AssignXML"] = drsel["AssignXML"].toString();
                if ((ename == "DataGridDateTimeColumn" || ename == "DataGridDateColumn") && this.ScreenObject.GridDataColumns.Contains(COlName + "_Key")) {
                    if (Util.String(drsel[COlName + "_Key"]) == "")
                        dv[i][COlName + "_Key"] = null;
                    else
                        dv[i][COlName + "_Key"] = drsel[COlName + "_Key"].toString();
                }
                else if (ename == "DataGridPactListBoxColumn") {
                    let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == COlName);

                    if (col) {
                        this.PrevValue = "";
                        if (Util.String(drsel[col.ValueMember]) == "")
                            dv[i][col.ValueMember] = null;
                        else {
                            dv[i][col.ValueMember] = drsel[col.ValueMember].toString();
                            let drAdv = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == col.ID);
                            if (drAdv.length > 0) {
                                for (let j = 0; j < drAdv.length; j++) {
                                    {
                                        if (Util.String(drAdv[j]["SysColumnName"]) == '' || Util.String(drAdv[j]["CostCenterColID"]) == '')
                                            continue;

                                        var datacol = this.ColumnSource.find(a => a.ID == drAdv[j]["CostCenterColID"].toString());
                                        if (datacol != undefined) {

                                            let tempdt;
                                            let tmplng;
                                            let tmpdbl;
                                            if (datacol.DataType == "DATE" || datacol.DataType == "Time2" || datacol.DataType == "DATETIME" || datacol.DataType == "TIME") {
                                                if (Util.isValidDate(Util.String(drsel[datacol.DisplayMember + "_Key"]))) {
                                                    dv[i][datacol.DisplayMember + "_Key"] = Util.ParseDate(drsel[datacol.DisplayMember + "_Key"].toString());
                                                    if (datacol.DataType == "DATE")
                                                        dv[i][datacol.DisplayMember] = Util.ParseDate(drsel[datacol.DisplayMember + "_Key"].toString()).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                    else if (datacol.DataType == "Time2")
                                                        dv[i][datacol.DisplayMember] = Util.ParseDate(drsel[datacol.DisplayMember + "_Key"].toString()).ToString("HH:mm");
                                                    else if (datacol.DataType == "DATETIME")
                                                        dv[i][datacol.DisplayMember] = Util.ParseDate(drsel[datacol.DisplayMember + "_Key"].toString()).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                                                    else if (datacol.DataType == "TIME")
                                                        dv[i][datacol.DisplayMember] = Util.ParseDate(drsel[datacol.DisplayMember + "_Key"].toString()).ToString("hh:mm:ss tt");
                                                }
                                            }
                                            else if (datacol.DataType == "ComboBox")
                                                dv[i][datacol.ValueBinding] = drsel[datacol.ValueBinding].toString();
                                            else if (datacol.DataType == "PactComboBox")
                                                dv[i][datacol.ValueBinding + "_Key"] = drsel[datacol.ValueBinding + "_Key"].toString();
                                            else if (datacol.DataType == "LISTBOX" && datacol.CostCenterID != 0) {
                                                tmplng = Util.Int(drsel[datacol.ValueMember]);
                                                if (tmplng > 0) {
                                                    dv[i][datacol.ValueMember] = drsel[datacol.ValueMember].toString();
                                                    dv[i][datacol.DisplayMember] = drsel[datacol.DisplayMember].toString();
                                                }
                                            }
                                            else {
                                                if (this.ScreenObject.GridDataColumns[datacol.DisplayMember].DataType == "Double")//typeof(double))
                                                {
                                                    tmpdbl = Util.Double(drsel[datacol.DisplayMember]);
                                                    if (tmpdbl > 0)
                                                        dv[i][datacol.DisplayMember] = drsel[datacol.DisplayMember].toString();
                                                }
                                                else
                                                    dv[i][datacol.DisplayMember] = drsel[datacol.DisplayMember].toString();
                                            }
                                        }
                                    }
                                    // col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == drAdv[j]["SysColumnName"].toString());
                                    // if (col != undefined) {
                                    //     this.ScreenObject.GridData[i][col.ValueMember] = objEditCell.item[col.ValueMember].toString();
                                    //     if (col.ValueMember.Contains("_Key"))
                                    //         this.ScreenObject.GridData[i][col.DisplayMember] = objEditCell.item[col.DisplayMember].toString();
                                    // }
                                }
                            }
                        }
                    }
                    this.Celleditend(dv[i], COlName, col.CostCenterID);
                }
                if (COlName.toLowerCase() == "quantity") {
                    let Vldbl = 1;
                    if (Util.IsNum(dv[i]["UOMConversion"]))
                        Vldbl = parseFloat(dv[i]["UOMConversion"]);
                    if (!Util.IsEmpty(dv[i]["Quantity"]))
                        dv[i]["UOMConvertedQty"] = Vldbl * parseFloat(this.ScreenObject.GridData[i]["Quantity"]);
                }
                this.CalculateTotals(dv[i], false, COlName);
            }
        }

        if ((this.DocumentType == 31 || this.DocumentType == 32) && COlName.toLowerCase() == "duedate") {
            if (this.ScreenObject.GridDataColumns.Contains(COlName + "_key") && !Util.IsEmpty(drsel[COlName + "_key"]))
                this.CalcQOH(Util.ParseDate(drsel[COlName + "_key"]));
            else
                this.CalcQOH(this.DocumentDate);
        }
    }

    // Name : LineItemEditClick
    // Desc : Bodygrid row Editing in Mobile.
    // Category : COMMON
    LineItemEditClick(dr: any) {
        this.ScreenObject.GridDataObj.SelectedItem = dr;
        this.ScreenObject.GridDataObj.MobileAddLine.ShowMobileAddLineItem_1(dr, 0, this.DocumentType, this.IsInventoryVoucher, 1);
    }

    // Name : LineItemFooterEditClick
    // Desc : footergrid row Editing  in Mobile.
    // Category : INVENTORY
    LineItemFooterEditClick(dr: any) {
        this.ScreenObject.FooterGridDataObj.SelectedItem = dr;
        this.ScreenObject.FooterGridDataObj.MobileAddLine.ShowMobileAddLineItem_1(dr, 0, this.DocumentType, this.IsInventoryVoucher, 1);
    }

    // Name : LineItemDeleteClick
    // Desc : footergrid row Deleting  in Mobile.
    // Category : COMMON
    LineItemDeleteClick(dr: any) {
        if (this.ScreenObject.GridDataObj.CanUserDeleteRows) {
            if (this.CanDeleteRow(this.SelectedRow)) {
                let ind = this.ScreenObject.GridData.indexOf(this.SelectedRow)
                this.OnBeforeRowDeleting(this.SelectedRow, true);
                if (this.res == "Yes") {
                    if (this.ScreenObject.GridDataObj.Table.Contains(dr))
                        this.ScreenObject.GridDataObj.removeRow(dr);
                    if (ind != -1) {
                        for (let i = ind; i < this.ScreenObject.GridData.length; i++)
                            this.ScreenObject.GridDataObj.updateRow(this.ScreenObject.GridData[i]);
                    }
                }
            }
        }
    }

    // Name : onGridLinkClick
    // Desc : footergrid or Bodygrid row Editing or deleting in Mobile.
    // Category : COMMON
    onGridLinkClick(datarow: any, c: any) {
        if (c == "drEdit" && datarow["drEdit"] != "N") {
            this.LineItemEditClick(datarow)
        }
        else if (c == "drDelete" && datarow["drEdit"] != "N") {
            this.LineItemDeleteClick(datarow)
        }
        else if (c == "drViewBid") {
            this.ReversRowNo = this.ScreenObject.GridDataObj.angularGrid.dataView.getRowByItem(this.ScreenObject.GridDataObj.SelectedItem)
            if (this.BidEvaluationType == "Line item wise")
                this.onButtonClick("BidRevise")
        }
    }

    itemSourceFilter: any = []; // Local variable to filter item source of combobox

    // Name : onBeginEdit
    // Desc : to perform functionality of gridview before editing, this event fire, based on control of grid functionality work.
    // Category : COMMON
    public async onBeginEdit(objEditCell: any) {
        let args = objEditCell.args;
        let CurrentRow: any = objEditCell.args.item;
        let column = objEditCell.args.column
        let col: DgColumn = column.DgCol
        let bindingpath: string = !Util.IsEmpty(col.ValueBinding) ? col.ValueBinding : col.DisplayMember;
        let valbindingpath: string = !Util.IsEmpty(col.ValueBinding) ? col.ValueBinding : col.ValueMember;
        let ename = column.className

        //
        //console.log('editor: '+column.editor?.name);
        //console.log(bindingpath+' '+SortMemberPath+' '+valbindingpath);
        // alert('editor: '+column.editor?.name+' :: '+bindingpath)
        //PactTextBoxEditor
        if (ename == "DataGridPactComboBoxColumn") {
            if (col && col.ReadOnly) {
                args.Cancel = true;
                return;
            }
            else if (col)
                this.PrevValue = Util.String(CurrentRow[col.ValueBinding]);
        }
        else {
            if (col != null && col != undefined) {
                if (col != null && col != undefined && (col.ReadOnly || col.DisplayMember.toLowerCase() == "refno")) {
                    args.Cancel = true;
                    return;
                }

                if (this.ClassName == "POSDocumentViewModel" && col.DataType == "FLOAT") {
                    this.NUmpadBindingPath = col.DisplayMember;
                    if (!Util.IsEmpty(objEditCell.args.item[col.DisplayMember]))
                        this.NumPadText = objEditCell.args.item[col.DisplayMember].toString();
                    else
                        this.NumPadText = '';
                }
            }
        }

        if (this.ScreenObject.Preferences.ContainsKey("ControlAccountFilterField") && this.ScreenObject.Preferences["ControlAccountFilterField"] != "" && this.ScreenObject.Preferences["ControlAccountFilterField"] != "0") {
            let CGflcol = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["ControlAccountFilterField"]);
            if (CGflcol && !Util.IsEmpty(CGflcol.DefaultValue) && Util.IsEmpty(CurrentRow[CGflcol.ValueMember])) {
                if (!Util.IsEmpty(CGflcol.DefaultValueText) && Util.IsNum(CGflcol.DefaultValue)) {
                    let namecode = CGflcol.DefaultValueText.split('\u0011');
                    if (namecode.length > 0)
                        CurrentRow[CGflcol.DisplayMember] = namecode[0];
                    CurrentRow[CGflcol.ValueMember] = CGflcol.DefaultValue;
                }
            }
        }

        if ((this.ScreenObject.GridDataColumns.Contains("FieldType") && Util.IsEmpty(CurrentRow["FieldType"])) || this.DocumentType == 100) {
            args.Cancel = true;
            return;
        }

        if (this.NumericPADView != null) {
            if (col != null && col != undefined && col.DataType.toUpperCase() == "FLOAT") {
                this.NumericPADView.DisplayMember = col.DisplayMember;
                if (!Util.IsEmpty(CurrentRow[col.DisplayMember]))
                    this.NumericPADView.txt.Text = CurrentRow[col.DisplayMember].toString();
            }
            else {
                this.NumericPADView.DisplayMember = "";
                this.NumericPADView.txt.Text = "0";
            }
        }

        if (col && col.DataType == "DATE" && this.ScreenObject.GridDataColumns.Contains(col.DisplayMember + "_Key"))
            this.PrevValue = Util.String(CurrentRow[col.DisplayMember + "_Key"]);
        if (col && col.DataType == "Time2" && this.ScreenObject.GridDataColumns.Contains(col.DisplayMember + "_Key"))
            this.PrevValue = Util.String(CurrentRow[col.DisplayMember + "_Key"]);

        if (this.ScreenObject.GridDataColumns.Contains("IsKit") && (Util.String(CurrentRow["IsKit"]) == "1" || Util.String(CurrentRow["IsKit"]) == "2")
            && (col.DisplayMember == "Quantity"
                || (column.className == "DataGridPactListBoxColumn" && (col.CostCenterID == 3 || col.CostCenterID == 11))
                || (column.className == "DataGridPactComboBoxColumn" && bindingpath == "VoucherType"))) {
            args.Cancel = true;
            return;
        }

        // if (!Util.IsEmpty(CurrentRow["ExecutedQty"]) && parseFloat(CurrentRow["ExecutedQty"]) > 0) {
        //     args.Cancel = true;
        //     return;
        // }
        if (this.ScreenObject.GridDataColumns.Contains("ExecutedQty")) {
            if ((this.ScreenObject.Preferences.ContainsKey("LockExecutedCols") && !Util.IsEmpty(this.ScreenObject.Preferences["LockExecutedCols"]) && this.ScreenObject.Preferences["LockExecutedCols"].split(',').Contains(args.model.Binding))) {
                args.Cancel = false;
                return;
            }

            if (!Util.IsEmpty(CurrentRow["ExecutedQty"]) && parseFloat(CurrentRow["ExecutedQty"]) > 0) {
                args.Cancel = true;
                return;
            }
        }

        if (this.DocumentType == 45 && col) {
            if (this.ProjDims == null) {
                let tmpint = 0;
                this.ProjDims = [];
                tmpint = Util.Int(BaseService.SessionManager.Preferences["PMLevel1Dimension"])
                if (tmpint > 0)
                    this.ProjDims.push(tmpint);
                tmpint = Util.Int(BaseService.SessionManager.Preferences["PMLevel2Dimension"])
                if (tmpint > 0)
                    this.ProjDims.push(tmpint);
                tmpint = Util.Int(BaseService.SessionManager.Preferences["PMLevel3Dimension"])
                if (tmpint > 0)
                    this.ProjDims.push(tmpint);
                tmpint = Util.Int(BaseService.SessionManager.Preferences["PMTaskDimension"])
                if (tmpint > 0)
                    this.ProjDims.push(tmpint);
            }
            if (col.DisplayMember.toLowerCase() == "dcalpha12")
                this.Dependencies();
            else if (col.DisplayMember.toLowerCase() == "dcalpha13")
                this.AssignUsers();
            else if ((col.DisplayMember.toLowerCase() == "dcalpha18" && this.ScreenObject.GridDataColumns.Contains("dcAlpha20") && Util.String(CurrentRow["dcAlpha20"]) == "Close")
                || (!Util.IsEmpty(CurrentRow["DocDetailsID"]) && parseInt(CurrentRow["DocDetailsID"]) > 0 && this.ProjDims.Contains(col.CostCenterID))) {
                args.Cancel = true;
                return;
            }
        }

        if (this.ScreenObject.GridDataColumns.Contains("CanEdit") && Util.String(CurrentRow["CanEdit"]) == "0") {
            args.Cancel = true;
            return;
        }

        if (this.IsInventoryVoucher && Util.String(CurrentRow["IsScheme"]) == "Y" && Util.String(CurrentRow["SchemeID"]) == "2") {
            args.Cancel = true;
            return;
        }
        if (this.DocumentType == 92) {
            let sAssgnType = "DayWise";
            let vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
            if (vFld)
                sAssgnType = (vFld as PactComboBoxData).SelectedValue;

            if (sAssgnType == "DayWise") {
                if (args.model.SortMemberPath.toLowerCase() == "dcalpha5_key" || args.model.SortMemberPath.toLowerCase() == "dcalpha6_key" || args.model.SortMemberPath.toLowerCase() == "dcccnid73") {
                    args.Cancel = true;
                    return;
                }
            }
        }

        if (this.DocumentType == 89 || this.DocumentType == 90) //Attendance & Time Sheet
        {
            let vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha32");
            if (vFld instanceof PactComboBoxData) {
                let _AttTimeBinding = "";
                if (args.model.Binding == undefined) {
                    _AttTimeBinding = args.model.SelectedValueBinding;
                }
                else {
                    _AttTimeBinding = args.model.Binding;
                }
                if (_AttTimeBinding == undefined) {
                    _AttTimeBinding = "";
                }

                if (vFld.SelectedValue != null && vFld.SelectedValue == "Manual") {
                    if (_AttTimeBinding.toLowerCase() == "dcalpha1_key" || _AttTimeBinding.toLowerCase() == "dcalpha2" || _AttTimeBinding.toLowerCase() == "dcalpha3_key" || _AttTimeBinding.toLowerCase() == "dcalpha4") {
                        args.Cancel = false;
                        return;
                    }
                }
                else {
                    if (_AttTimeBinding.toLowerCase() == "dcalpha1_key" || _AttTimeBinding.toLowerCase() == "dcalpha2" || _AttTimeBinding.toLowerCase() == "dcalpha3_key" || _AttTimeBinding.toLowerCase() == "dcalpha4") {
                        args.Cancel = true;
                        return;
                    }
                }
            }
        }

        if (this.DocumentType == 94) //Consider LOP to Service Days
        {
            if (args.model.Binding.toLowerCase() == "dcalpha7" && !parseBoolean(CurrentRow["dcAlpha5"])) {
                args.Cancel = true;
                return;
            }
        }

        if (this.CostCenterID == 62 && this.ScreenObject.GridDataColumns.Contains("dcccnid52_Key") && this.ScreenObject.GridDataColumns.Contains("dcAlpha10") && !Util.IsEmpty(CurrentRow["dcAlpha10"]) && !Util.IsEmpty(CurrentRow["DocDetailsID"]) && parseFloat(CurrentRow["DocDetailsID"]) > 0) {
            if (args.model.Binding.toLowerCase() == "dcccnid52") {
                args.Cancel = true;
                return;
            }
        }

        if (this.CostCenterID == 40058 && this.ScreenObject.GridDataColumns.Contains("dcccnid52_Key") && this.ScreenObject.GridDataColumns.Contains("dcAlpha6") && !Util.IsEmpty(CurrentRow["dcAlpha6"]) && !Util.IsEmpty(CurrentRow["DocDetailsID"]) && parseFloat(CurrentRow["DocDetailsID"]) > 0) {
            if (column.className == "DataGridPactComboBoxColumn" && col.CostCenterID == 50052 && (Util.String(CurrentRow["dcAlpha6"]) == "1" || Util.String(CurrentRow["dcAlpha6"]) == "2")) {
                args.Cancel = true;
                return;
            }
        }

        if (this.CostCenterID == 40072 && this.ScreenObject.GridDataColumns.Contains("dcAlpha21") && !Util.IsEmpty(CurrentRow["dcAlpha21"])) {
            let IsEncashLeaves = false;
            let vfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha16");
            if (vfld && (vfld as PactComboBoxData).SelectedValue == "Yes")
                IsEncashLeaves = true;

            //if (args.model.SortMemberPath == "dcNum2" || args.model.SortMemberPath == "dcNum3")
            //{
            //    args.Cancel = true;
            //    return;
            //}

            if (!IsEncashLeaves) {
                if (args.model.Binding == "dcNum2") {
                    args.Cancel = true;
                    return;
                }
            }

            if (args.model.Binding == "dcNum3") {
                args.Cancel = true;
                return;
            }

            if (Util.String(CurrentRow["dcAlpha21"]) == "2") //Earnings
            {
                if (args.model.Binding == "dcNum1" && this.ScreenObject.GridDataColumns.Contains("dcAlpha23") && !Util.IsEmpty(CurrentRow["dcAlpha23"]) && parseFloat(CurrentRow["dcAlpha23"]) > 0) {
                    args.Cancel = true;
                    return;
                }
                if (args.model.Binding == "dcNum2" && this.ScreenObject.GridDataColumns.Contains("dcAlpha23") && !Util.IsEmpty(CurrentRow["dcAlpha23"]) && parseFloat(CurrentRow["dcAlpha23"]) > 0) {
                    args.Cancel = true;
                    return;
                }
                if ((args.model.Binding == "dcNum1" || args.model.Binding == "dcNum2") && this.ScreenObject.GridDataColumns.Contains("dcAlpha23") && !Util.IsEmpty(CurrentRow["dcAlpha23"]) && (CurrentRow["dcAlpha23"].toString() == "-1" || CurrentRow["dcAlpha23"].toString() == "-3")) {
                    args.Cancel = false;
                    return;
                }
                //if ((args.model.SortMemberPath == "dcNum2" || args.model.SortMemberPath == "dcNum3") && this.ScreenObject.GridDataColumns.Contains("dcAlpha23") && !Util.IsEmpty(CurrentRow["dcAlpha23"]) && (CurrentRow["dcAlpha23"].toString() == "-2" || CurrentRow["dcAlpha23"].toString() == "-4"))
                //{
                //    args.Cancel = true;
                //    return;
                //}
            }
            else if (Util.String(CurrentRow["dcAlpha21"]) == "3" || Util.String(CurrentRow["dcAlpha21"]) == "4") //Deductions
            {
                if (args.model.Binding == "dcNum2" || args.model.Binding == "dcNum3") {
                    args.Cancel = true;
                    return;
                }
            }

        }

        //Form12BA
        if (this.CostCenterID == 40076 && this.ScreenObject.GridDataColumns.Contains("dcAlpha2") && this.ScreenObject.GridDataColumns.Contains("dcAlpha3") && !Util.IsEmpty(CurrentRow["dcAlpha3"]) && CurrentRow["dcAlpha3"].toString() == "-1") {
            args.Cancel = true;
            return;
        }

        //TDE
        if (this.CostCenterID == 40078 && this.ScreenObject.GridDataColumns.Contains("dcAlpha2") && !Util.IsEmpty(CurrentRow["dcAlpha2"])) {
            if (CurrentRow["dcAlpha2"] == "Quarterly") {
                if ((args.model.Binding == "dcAlpha4" || args.model.Binding == "dcAlpha5" || args.model.Binding == "dcAlpha6_Key" || args.model.Binding == "dcAlpha7")) {
                    args.Cancel = true;
                    return;
                }
            }
            else if (CurrentRow["dcAlpha2"] == "Monthly") {
                if ((args.model.Binding == "dcAlpha8" || args.model.Binding == "dcNum7")) {
                    args.Cancel = true;
                    return;
                }
            }
        }

        if (this.ScreenObject.DocumentType == 96) {
            if (args.model.Binding == "dcAlpha6") {
                if (Util.String(CurrentRow["dcAlpha5"]) == "Hours") {
                    args.Cancel = true;
                    return;
                }
            }
            else if (args.model.Binding == "dcAlpha10") {
                if (Util.String(CurrentRow["dcAlpha9"]) == "Hours") {
                    args.Cancel = true;
                    return;
                }
            }
        }

        if (this.ScreenObject.DocumentType == 67) {
            let drc1 = null, drc2 = null;
            if (column.className == "DataGridPactListBoxColumn" && args.model.Binding.toLowerCase() == "dcccnid51" && !Util.IsEmpty(this.strEmpFilter)) {
                col.FilterCondition = this.strEmpFilter;
                // strEmpFilter = "";
            }

            if (args.model.Binding == "dcNum2" || args.model.Binding == "dcNum3" ||
                args.model.Binding == "dcNum6" || args.model.Binding == "dcNum8" ||
                args.model.Binding == "dcNum10" || args.model.Binding == "dcNum12" ||
                args.model.Binding == "dcNum14" || args.model.Binding == "dcNum15") {
                if (args.model.Binding == "dcNum2") {
                    if (!Util.IsEmpty(CurrentRow["PayrollType"]) &&
                        (CurrentRow["PayrollType"] == "WeeklyOff") || (CurrentRow["PayrollType"] == "Holiday")) {

                    }
                    else {
                        args.Cancel = true;
                        return;
                    }
                }
                else {
                    args.Cancel = true;
                    return;
                }

                //if (args.model.SortMemberPath == "dcNum2")
                //{
                //    if ((CurrentRow["PayrollType"] != null && CurrentRow["PayrollType"] != null) &&
                //        (CurrentRow["PayrollType"] == "WeeklyOff")) //|| CurrentRow["PayrollType"] == "Holiday"
                //    {

                //    }
                //    else
                //    {
                //        args.Cancel = true;
                //        return;
                //    }
                //}
                //else
                //{
                //    args.Cancel = true;
                //    return;
                //}
            }

            if (args.model.Binding == "dcNum4") {
                if (BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {

                }
                else {
                    if ((!Util.IsEmpty(CurrentRow["PayrollType"]) &&
                        ((CurrentRow["PayrollType"] == "WeeklyOff" || CurrentRow["PayrollType"] == "Holiday"))) ||
                        (BaseService.SessionManager.Preferences.ContainsKey("BreakHoursImpactToOTS") && BaseService.SessionManager.Preferences["BreakHoursImpactToOTS"] == "False")
                    ) {
                        args.Cancel = true;
                        return;
                    }
                }
            }

            // // For Normal Hours and Break Hours restriction 
            // if (args.model.SortMemberPath == "dcNum2" || args.model.SortMemberPath == "dcNum4")
            // {
            //     if (CurrentRow["PayrollType"] != null && CurrentRow["PayrollType"] != null)
            //     {
            //         if (CurrentRow["PayrollType"] == "WeeklyOff" || CurrentRow["PayrollType"] == "Holiday")
            //         {
            //             args.Cancel = true;
            //             return;
            //         }
            //     }
            // }


            //For OT Hours restriction
            if (args.model.Binding == "dcNum5" || args.model.Binding == "dcNum7" || args.model.Binding == "dcNum9" || args.model.Binding == "dcNum11" || args.model.Binding == "dcNum13") {
                if (BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                    let sCol = args.model.Binding;

                    if (!Util.IsEmpty(CurrentRow["PayrollType"])) {
                        if (CurrentRow["PayrollType"] == "WeeklyOff") {
                            drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == sCol);
                            if (drc1.length > 0) {
                                drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"]);
                                if (drc2.length > 0) {
                                    if (drc2[0]["SysColumnName"] != "PayWeeklyOffOT" && drc2[0]["SysColumnName"] != "PayHolidayOT" && drc2[0]["SysColumnName"] != "PayEveryDayOT") {
                                        args.Cancel = true;
                                        return;
                                    }
                                }
                            }
                        }
                        else if (CurrentRow["PayrollType"] == "Holiday") {
                            drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == sCol);
                            if (drc1.length > 0) {
                                drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"]);
                                if (drc2.length > 0) {
                                    if (drc2[0]["SysColumnName"] != "PayHolidayMastOT" && drc2[0]["SysColumnName"] != "PayHolidayOT" && drc2[0]["SysColumnName"] != "PayEveryDayOT") {
                                        args.Cancel = true;
                                        return;
                                    }
                                }
                            }
                        }
                        else //Normal OT
                        {
                            drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == sCol);
                            if (drc1.length > 0) {
                                drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"]);
                                if (drc2.length > 0) {
                                    if (drc2[0]["SysColumnName"] != "PayNormalOT" && drc2[0]["SysColumnName"] != "PayEveryDayOT") {
                                        args.Cancel = true;
                                        return;
                                    }
                                }
                            }
                        }
                    }
                }
                else {
                    args.Cancel = true;
                    return;
                }
            }

            //if (IsDocValid == false)
            //{
            //    if ((args.model.SortMemberPath == "dcAlpha2" || args.model.SortMemberPath == "dcAlpha3" || args.model.SortMemberPath == "dcNum1" || args.model.SortMemberPath == "dcNum2"))
            //    {
            //        args.Cancel = true;
            //        return;
            //    }
            //    if (this.ScreenObject.GridDataColumns.Contains("dcCCNID2_Key"))
            //    {
            //        if (ename == "DataGridPactListBoxColumn" && ((PACT.COMMON.DataGridPactListBoxColumn)args.Column).CostCenterID == 50002)
            //        {
            //            args.Cancel = true;
            //            return;
            //        }
            //    }
            //}
        }

        if (this.CostCenterID == 40056 && this.ScreenObject.GridDataColumns.Contains("dcNum2") && !Util.IsEmpty(CurrentRow["dcNum2"])) {
            if (this.dsData != null && args.model.Binding == "dcNum2") {
                let dvApplyLoan = this.dsData.Tables[1].filter(x => x.LinkedInvDocDetailsID == CurrentRow["DocDetailsID"]);
                if (dvApplyLoan.length > 0 || parseInt(CurrentRow["dcNum2"]) == 0) {
                    args.Cancel = true;
                    return;
                }
            }
        }

        if (this.IsInventoryVoucher && Util.String(CurrentRow["IsScheme"]) == "Y" && !Util.IsEmpty(CurrentRow["SchemeID"])
            && parseInt(CurrentRow["SchemeID"]) > 2) {
            if ((col.DisplayMember == "Quantity" || col.DisplayMember == "Gross")
                || (column.className == "DataGridPactListBoxColumn" && (col.CostCenterID == 3 || col.CostCenterID == 11))) {
                args.Cancel = true;
                return;
            }
        }

        if (this.ScreenObject.GridDataColumns.Contains("RemQty") && !Util.IsEmpty(CurrentRow["RemQty"])
            && column.className == "DataGridPactListBoxColumn" && col.CostCenterID == 3) {
            args.Cancel = true;
            return;
        }

        if (bindingpath == "Quantity" && this.ScreenObject.Preferences.ContainsKey("EnableWieghingPopupOnQty") && this.ScreenObject.Preferences["EnableWieghingPopupOnQty"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableWieghingPopupOnQty"]) && Util.String(CurrentRow["IsWeightable"]).toLowerCase() == "true") {
            let Quantity = this.QtyReader(Util.String(CurrentRow["Quantity"]));
            CurrentRow["Quantity"] = Util.IsEmpty(Quantity) ? "0" : Quantity;
        }

        let n = this.ScreenObject.GridData.indexOf(CurrentRow);
        if (n == -1)
            n = 3;
        else {
            if (this.ScreenObject.GridData.length - n < 3)
                n = 3;
            else
                n = 0;
            //n = this.ScreenObject.GridData.length - this.ScreenObject.GridData.indexOf(CurrentRow) + 2;
        }

        if (this.ScreenObject.GridDataObj.CanUserAddRows) {
            for (let l = 0; l < n; l++) {
                let drnew = this.ScreenObject.GridDataObj.NewRow();
                drnew["DocSeqNo"] = this.ScreenObject.GridData.length + 1;
                drnew["DocDetailsID"] = 0;
                this.ScreenObject.GridDataObj.addRow(drnew);
            }
        }
        if (this.IsInventoryVoucher && !Util.IsEmpty(CurrentRow["LinkedInvDocDetailsID"]) && parseInt(CurrentRow["LinkedInvDocDetailsID"]) > 0
            && ((this.ScreenObject.Preferences.ContainsKey("LockLinkedRows") && this.ScreenObject.Preferences["LockLinkedRows"] != "" && parseBoolean(this.ScreenObject.Preferences["LockLinkedRows"])
                && !(this.ScreenObject.Preferences.ContainsKey("LockLinkedCols") && this.ScreenObject.Preferences["LockLinkedCols"].split(',').Contains(bindingpath)))
                || (this.ScreenObject.Preferences.ContainsKey("DontSavePartiallyLinkedItem") && this.ScreenObject.Preferences["DontSavePartiallyLinkedItem"] != "" && parseBoolean(this.ScreenObject.Preferences["DontSavePartiallyLinkedItem"])
                    && ename == "PactTextBoxEditor" && CurrentRow["LinkedFieldName"] == bindingpath))) {
            args.Cancel = true;
            return;
        }

        if (this.ScreenObject.Preferences.ContainsKey("LineWisePDC") && parseBoolean(this.ScreenObject.Preferences["LineWisePDC"])
            && this.ScreenObject.GridDataColumns.Contains("RefStatusID") && !Util.IsEmpty(CurrentRow["RefStatusID"])
            && !(parseInt(CurrentRow["RefStatusID"].toString()) == 370 || parseInt(CurrentRow["RefStatusID"].toString()) == 371 || parseInt(CurrentRow["RefStatusID"].toString()) == 372 || parseInt(CurrentRow["RefStatusID"].toString()) == 441)
            && !Util.IsEmpty(CurrentRow["DocDetailsID"]) && parseInt(CurrentRow["DocDetailsID"]) > 0) {
            args.Cancel = true;
            return;
        }

        //if (IsInventoryVoucher && !Util.IsEmpty(CurrentRow["MaxSchemeID"]) && Util.String(CurrentRow["IsScheme"]) == "Y")
        //{
        //    args.Cancel = true;
        //    return;
        //}
        //  let datarow = objEditCell.OriginalSource.RowDataItem.Row;

        if (ename == "PactTextBoxEditor") {
            let path = bindingpath;
            this.PrevValue = Util.String(CurrentRow[path]);
        }
        if ((this.ScreenObject.DocumentType == 35 || this.ScreenObject.DocumentType == 202) && ename == "PactTextBoxEditor")//typeof(PactTextBoxColumnEx)
        {
            if (col.DisplayMember == "dcAlpha20") {

                let freq = 0;
                let sdate = new Date(), edate = new Date();
                if (this.ScreenObject.DocumentType == 35) {
                    if (this.ScreenObject.GridDataColumns.Contains("dcNum2") && CurrentRow["dcNum2"].toString() != "" && parseFloat(CurrentRow["dcNum2"].toString()) > 0)
                        freq = parseFloat(CurrentRow["dcNum2"].toString());
                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha3") && this.ScreenObject.GridDataObj.DataTypes.Date.Contains("dcAlpha3")) {
                        if (!Util.String(CurrentRow["dcAlpha3"]))
                            sdate = Util.ParseDate(CurrentRow["dcAlpha3"].toString());
                    }
                    else {
                        let sd = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                        if (sd != undefined && sd instanceof PactExtraFieldDateData && sd.Date)
                            sdate = sd.Date;
                    }
                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha4") && this.ScreenObject.GridDataObj.DataTypes.Date.Contains("dcAlpha4")) {
                        if (!Util.String(CurrentRow["dcAlpha4"]))
                            edate = Util.ParseDate(CurrentRow["dcAlpha4"].toString());
                    }
                    else {
                        let ed = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                        if (ed != undefined && ed instanceof PactExtraFieldDateData && ed.Date)
                            edate = ed.Date;
                    }
                }
                else if (this.ScreenObject.DocumentType == 202) {
                    if (this.ScreenObject.GridDataColumns.Contains("dcalpha12") && this.ScreenObject.GridDataObj.DataTypes.Date.Contains("dcAlpha12")) {
                        if (!Util.String(CurrentRow["dcalpha12"]))
                            sdate = Util.ParseDate(CurrentRow["dcalpha12"].toString());
                    }
                    else {
                        let sd = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha12");
                        if (sd != undefined && sd instanceof PactExtraFieldDateData && sd.Date)
                            sdate = sd.Date;
                    }
                    if (this.ScreenObject.GridDataColumns.Contains("dcalpha13") && this.ScreenObject.GridDataObj.DataTypes.Date.Contains("dcAlpha13")) {
                        if (!Util.String(CurrentRow["dcalpha13"]))
                            edate = Util.ParseDate(CurrentRow["dcalpha13"].toString());
                    }
                    else {
                        let ed = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha13");
                        if (ed != undefined && ed instanceof PactExtraFieldDateData && ed.Date)
                            edate = ed.Date;
                    }
                    freq = AddEditDocumentViewModel.GetTotalMonthsFrom(sdate, edate);
                }
                let cntrSch = new ContractScheduleViewModel();
                cntrSch.ContractScheduleViewModel_1(this, sdate, edate, freq, this.CostCenterID);
                BaseService.page.ShowDialog(cntrSch, ContractScheduleComponent, { ShowCenter: true, Title: cntrSch.DisplayName });
                args.Cancel = true;
                return;
            }
            else if (col.DisplayMember == "dcAlpha21") {
                const { PickProductsViewModel } = await import('../../document/pick-products-view-model/PickProductsViewModel')
                const { PickProductsViewModelComponent } = await import('../../document/pick-products-view-model/pick-products-view-model.component')
                let objPickProduct = new PickProductsViewModel(this);
                await BaseService.page.openDialog(objPickProduct, PickProductsViewModelComponent, { ShowCenter: true })
                args.Cancel = true;
                return;
            }
        }

        if (ename == "DataGridPactComboBoxColumn")//typeof(DataGridPactComboBoxColumn)
        {
            let path = args.model.SelectedValueBinding;
            let drr = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == path);
            if (drr.length > 0 && !Util.IsEmpty(drr[0]["LinkData"]) && parseInt(drr[0]["LinkData"]) == 22803) {

                let combocol: any = args.column.editor as DataGridPactComboBoxColumn;
                if (this.ScreenObject.GridDataColumns.Contains("EndYear") && this.ScreenObject.GridDataColumns.Contains("StartYear") && !Util.IsEmpty(CurrentRow["StartYear"])) {
                    if (this.itemSourceFilter.length > 0) {
                        combocol.ItemsSource = this.itemSourceFilter;
                    } else {
                        this.itemSourceFilter = combocol.ItemsSource;
                    }
                    // combocol.ItemsSource.RowFilter = "Year>=" + Util.String(CurrentRow["StartYear"]);
                    // if (!Util.IsEmpty(CurrentRow["EndYear"]) && parseInt(CurrentRow["EndYear"]) > 0)
                    //     ((DataView)combocol.ItemsSource).RowFilter += " and Year<=" + Util.String(CurrentRow["EndYear"]);
                    // else
                    //     ((DataView)combocol.ItemsSource).RowFilter += " and Year<=" + new Date().getFullYear().toString();
                    combocol.ItemsSource = this.itemSourceFilter.filter(x => x.Year >= Util.String(CurrentRow["StartYear"]));
                    if (!Util.IsEmpty(CurrentRow["EndYear"]) && parseInt(CurrentRow["EndYear"]) > 0)
                        combocol.ItemsSource = combocol.ItemsSource.filter(x => x.Year <= Util.String(CurrentRow["EndYear"]));
                    else
                        combocol.ItemsSource = combocol.ItemsSource.filter(x => x.Year <= new Date().getFullYear().toString());
                }
                else {
                    //((DataView)combocol.ItemsSource).RowFilter = " Year=1";
                    combocol.ItemsSource = this.itemSourceFilter.filter(x => x.Year == 1);
                }

            }
        }
        else if (ename == "DataGridPactListBoxColumn") {
            let Col = args.model as DataGridPactListBoxColumn;
            let path = valbindingpath;
            this.PrevValue = Util.String(CurrentRow[path]);

            if (Col.CostCenterID == 3) {
                if (this.PrevValue == "" && this.ScreenObject.Preferences.ContainsKey("AutoSearchcatalog")
                    && this.ScreenObject.Preferences["AutoSearchcatalog"] != "" && parseBoolean(this.ScreenObject.Preferences["AutoSearchcatalog"])) {
                    this.ProdID = 0;

                    let srccol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == Col.CostCenterID);
                    let GRIDVIEWID = 0;
                    if (srccol)
                        GRIDVIEWID = srccol.GridViewID;
                    if (GRIDVIEWID == 0)
                        GRIDVIEWID = 268;

                    BaseService.page.ShowDialog(new ProductSearchCatalogViewModel(this, GRIDVIEWID, 3, null, null), ProductSearchCatalogComponent);
                    return;
                }
                if (CurrentRow["LinkedQuantity"] != null && CurrentRow["LinkedQuantity"] != null && parseFloat(CurrentRow["LinkedQuantity"]) > 0) {
                    alert("Cannot Edit Linked Product");
                    args.Cancel = true;
                    return;
                }
            }
            if (Col.CostCenterID == 50051 && this.ScreenObject.DocumentType == 60) {
                if (CurrentRow["dcAlpha3_Key"] != null) {
                    let strWhere = " ( a.StatusID in (250,302,303,304,305) AND DATEDIFF(DAY,'" + new Date(CurrentRow["dcAlpha3_Key"]).ToString("dd MMM yyyy") + "',ISNULL(CONVERT(DATETIME,a.DORelieve),'01-Jan-9000'))>=0) ";

                    if (BaseService.SessionManager.LocationID > 0 && BaseService.SessionManager.Preferences.ContainsKey("LocationWiseDimension") && BaseService.SessionManager.Preferences["LocationWiseDimension"].split(',').Contains("50051"))
                        strWhere = strWhere + " AND a.NodeID IN ( Select NodeID From Com_CCCCData with(nolock) where CostCenterID=50051 and CCNID2=" + BaseService.SessionManager.LocationID + ")";

                    Col.FilterCondition = strWhere;
                }
            }
            if (Col.CostCenterID == 11) {
                let ProductID = "";
                if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key"))
                    ProductID = Util.String(CurrentRow["ProductID_Key"]);

                this.Unit_keyOnBeginEditText = Util.String(CurrentRow["Unit"]);
                let FilterCondition = " (BaseID IN ";
                FilterCondition = FilterCondition + " (SELECT     BaseID ";
                FilterCondition = FilterCondition + " FROM          COM_UOM AS COM_UOM_1 with(nolock) ";
                FilterCondition = FilterCondition + " WHERE      (UOMID =(select UOMID from inv_product with(nolock) where productid=" + ProductID + ") ))) ";
                if (ProductID == "") {
                    Col.ProductID = 0;
                    FilterCondition = " (BaseID IN ";
                    FilterCondition = FilterCondition + " (SELECT     BaseID ";
                    FilterCondition = FilterCondition + " FROM          COM_UOM AS COM_UOM_1 with(nolock) ";
                    FilterCondition = FilterCondition + " WHERE      (UOMID =" + "-1" + " ))) ";
                }
                else
                    Col.ProductID = parseInt(ProductID);
                Col.FilterCondition = FilterCondition;
                Col.ShowMutipleOption = true;
                Col.QtyWhere = this.ScreenObject.GetQtyWhere(CurrentRow, "");
            }
            else if (Col.CostCenterID == 2) {
                let jj = 1;
                let srccol = this.ScreenObject.ColumnSource.find(a => a.ValueMember == path);
                if (srccol && srccol.IsRepeat && (Util.IsEmpty(CurrentRow[srccol.ValueMember])
                    || (!Util.IsEmpty(CurrentRow[srccol.ValueMember]) && parseInt(CurrentRow[srccol.ValueMember]) == 0))) {
                    let index = this.ScreenObject.GridData.indexOf(CurrentRow);
                    if (index > 0) {
                        CurrentRow[srccol.DisplayMember] = this.ScreenObject.GridData[index - 1][srccol.DisplayMember];
                        CurrentRow[srccol.ValueMember] = this.ScreenObject.GridData[index - 1][srccol.ValueMember];
                    }
                }
                if (this.ScreenObject.DivisionID > 0)
                    Col.DivisionID = this.ScreenObject.DivisionID;
                if (this.ScreenObject.LocationID > 0)
                    Col.LocationID = this.ScreenObject.LocationID;

                let Where = "";
                Col.Join = "";
                let CrFields = this.ScreenObject._CCFields.filter(a => a.CrFilter > 0);
                if (path.toLowerCase() == "debitaccount_key")
                    CrFields = this.ScreenObject._CCFields.filter(a => a.DbFilter > 0);
                else if (path.toLowerCase() != "creditaccount_key" && path.toLowerCase() != "accountid_key")
                    CrFields = null;

                if (CrFields != null)
                    CrFields.forEach(item => {
                        if (item instanceof PactListBoxData && item.SelectedValue > 0) {
                            if (Where != "")
                                Where += " and ";

                            if (item.AccDimInUse) {
                                Where = "(" + item.DBColumnName.replace("dc", "") + "=" + item.SelectedValue.toString();
                                if (item.CrFilter == 1)
                                    Where += " OR " + item.DBColumnName.replace("dc", "") + "=1 ";
                                Where += ")";
                            }
                            else {
                                Col.Join += " join COM_CostCenterCostCenterMap DCCM" + jj + " with(nolock) on a.AccountID=DCCM" + jj + ".ParentNodeID and DCCM" + jj + ".ParentCostCenterID=2 ";
                                Col.Join += " join " + this.ScreenObject.GetTableName(item.CCID) + " DCCMj" + jj + " with(nolock) on DCCM" + jj + ".CostCenterID=" + item.CCID + " and DCCM" + jj + ".NodeID= DCCMj" + jj + ".NodeID ";
                                Col.Join += " join " + this.ScreenObject.GetTableName(item.CCID) + " DCG" + jj + " with(nolock) on  DCG" + jj + ".lft between   DCCMj" + jj + ".lft and  DCCMj" + jj + ".rgt";
                                Where += "  DCG" + jj + ".NodeID=" + item.SelectedValue.toString();
                                jj++;
                            }
                        }
                    });

                let filFields = this.ScreenObject.ColumnSource.filter(a => a.DisplayMember.toLowerCase().Contains("dcccnid") && a.CrRefColID > 0);
                if (path.toLowerCase() == "debitaccount_key")
                    filFields = this.ScreenObject.ColumnSource.filter(a => a.DisplayMember.toLowerCase().Contains("dcccnid") && a.DrRefColID > 0);
                else if (path.toLowerCase() != "creditaccount_key" && path.toLowerCase() != "accountid_key")
                    filFields = null;

                if (filFields != null)
                    for (let j = 0; j < filFields.length; j++) {
                        let item = filFields[j]
                        if (Util.IsEmpty(CurrentRow[item.ValueMember]))
                            continue;

                        if (item.isUpdate) {
                            Where += "(CC." + item.DisplayMember.replace("dc", "") + "=" + CurrentRow[item.ValueMember].toString();
                            if (path.toLowerCase() == "debitaccount_key") {
                                if (item.DrRefColID == 1 || item.DrRefColID == 2)
                                    Where += " OR CC." + item.DisplayMember.replace("dc", "") + "=1 ";
                            }
                            else if (path.toLowerCase() == "creditaccount_key") {
                                if (item.CrRefColID == 1 || item.CrRefColID == 2)
                                    Where += " OR CC." + item.DisplayMember.replace("dc", "") + "=1 ";
                            }
                            Where += ")";
                        }
                        else {

                            Col.Join += " join COM_CostCenterCostCenterMap DCCM" + jj + " with(nolock) on a.AccountID=DCCM" + jj + ".ParentNodeID and DCCM" + jj + ".ParentCostCenterID=2 ";
                            Col.Join += " join " + this.ScreenObject.GetTableName(item.CostCenterID) + " DCCMj" + jj + " with(nolock) on DCCM" + jj + ".CostCenterID=" + item.CostCenterID + " and DCCM" + jj + ".NodeID= DCCMj" + jj + ".NodeID ";
                            Col.Join += " join " + this.ScreenObject.GetTableName(item.CostCenterID) + " DCG" + jj + " with(nolock) on  DCG" + jj + ".lft between   DCCMj" + jj + ".lft and  DCCMj" + jj + ".rgt";
                            Where += "  DCG" + jj + ".NodeID=" + CurrentRow[item.ValueMember].toString();
                            jj++;
                        }
                    }

                if (this.ScreenObject.Preferences.ContainsKey("ControlAccountFilterField") && this.ScreenObject.Preferences["ControlAccountFilterField"] != "" && this.ScreenObject.Preferences["ControlAccountFilterField"] != "0") {
                    let CGflcol = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["ControlAccountFilterField"]);
                    if (CGflcol && !Util.IsEmpty(CGflcol.ValueMember)) {
                        if (CGflcol.ValueMember == path) {
                            if (BaseService.SessionManager.Preferences.ContainsKey("IsControlAccounts") && BaseService.SessionManager.Preferences["IsControlAccounts"].toUpperCase() == "TRUE") {
                                if (Where != "")
                                    Where += " and ";
                                Where += " a.AccountID in (1";
                                if (BaseService.SessionManager.Preferences.ContainsKey("DebtorsControlGroup") && BaseService.SessionManager.Preferences["DebtorsControlGroup"].toUpperCase() != "")
                                    Where += "," + BaseService.SessionManager.Preferences["DebtorsControlGroup"];
                                if (BaseService.SessionManager.Preferences.ContainsKey("CreditorsControlGroup") && BaseService.SessionManager.Preferences["CreditorsControlGroup"].toUpperCase() != "")
                                    Where += "," + BaseService.SessionManager.Preferences["CreditorsControlGroup"];
                                Where += ")";
                            }
                        }
                        else if (!(this.ScreenObject.Preferences.ContainsKey("AccountFilterField") && this.ScreenObject.Preferences["AccountFilterField"] != "" && this.ScreenObject.Preferences["AccountFilterField"] != "0")) {
                            if (CGflcol.DataType == "LISTBOX" && this.ScreenObject.GridDataColumns.Contains(CGflcol.ValueMember) && !Util.IsEmpty(CurrentRow[CGflcol.ValueMember])) {
                                Col.Join += " join Acc_accounts g with(nolock) on a.lft between g.lft and g.rgt  and g.AccountID=" + CurrentRow[CGflcol.ValueMember].toString() + " or a.IsDrCr=1 ";
                                if (Util.String(CurrentRow[CGflcol.ValueMember]) == "1") {
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DebtorsControlGroup") && BaseService.SessionManager.Preferences["DebtorsControlGroup"].toUpperCase() != "")
                                        Col.Join += " join Acc_accounts dacg with(nolock) on a.lft not between dacg.lft and dacg.rgt  and dacg.AccountID=" + BaseService.SessionManager.Preferences["DebtorsControlGroup"];
                                    if (BaseService.SessionManager.Preferences.ContainsKey("CreditorsControlGroup") && BaseService.SessionManager.Preferences["CreditorsControlGroup"].toUpperCase() != "")
                                        Col.Join += " join Acc_accounts cacg with(nolock) on a.lft not between cacg.lft and cacg.rgt  and cacg.AccountID=" + BaseService.SessionManager.Preferences["CreditorsControlGroup"];
                                }
                            }
                        }
                    }
                }

                if ((this.DocumentType == 5 || this.DocumentType == 8 || this.DocumentType == 13) && this.ScreenObject.Preferences.ContainsKey("BudgetFeild") && this.ScreenObject.Preferences["BudgetFeild"] != "") {
                    var txt = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == this.ScreenObject.Preferences["BudgetFeild"].toLowerCase()) as PactListBoxData;
                    if (txt && txt.SelectedValue > 0) {
                        Col.Join += " join COM_BudgetAlloc budg WITH(NOLOCK) on budg.AccountID=a.Accountid ";
                        if (Where != "")
                            Where += " and ";

                        Where += " budg.BudgetDefID=" + txt.SelectedValue;
                    }
                }

                if (this.ScreenObject.Preferences.ContainsKey("AccountFilterField") && this.ScreenObject.Preferences["AccountFilterField"] != "" && this.ScreenObject.Preferences["AccountFilterField"] != "0") {
                    let Gflcol = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["AccountFilterField"]);
                    if (Gflcol && !Util.IsEmpty(Gflcol.ValueMember)) {
                        if (Gflcol.ValueMember == path && this.ScreenObject.Preferences.ContainsKey("ControlAccountFilterField") && this.ScreenObject.Preferences["ControlAccountFilterField"] != "") {
                            let CGflcol = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["ControlAccountFilterField"]);
                            if (CGflcol && !Util.IsEmpty(CGflcol.ValueMember) && CGflcol.DataType == "LISTBOX" && this.ScreenObject.GridDataColumns.Contains(CGflcol.ValueMember) && !Util.IsEmpty(CurrentRow[CGflcol.ValueMember])) {
                                Col.Join += " join Acc_accounts g with(nolock) on a.lft between g.lft and g.rgt  and g.AccountID=" + CurrentRow[CGflcol.ValueMember].toString();
                                if (Util.String(CurrentRow[CGflcol.ValueMember]) == "1") {
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DebtorsControlGroup") && BaseService.SessionManager.Preferences["DebtorsControlGroup"].toUpperCase() != "")
                                        Col.Join += " join Acc_accounts dacg with(nolock) on a.lft not between dacg.lft and dacg.rgt  and dacg.AccountID=" + BaseService.SessionManager.Preferences["DebtorsControlGroup"];
                                    if (BaseService.SessionManager.Preferences.ContainsKey("CreditorsControlGroup") && BaseService.SessionManager.Preferences["CreditorsControlGroup"].toUpperCase() != "")
                                        Col.Join += " join Acc_accounts cacg with(nolock) on a.lft not between cacg.lft and cacg.rgt  and cacg.AccountID=" + BaseService.SessionManager.Preferences["CreditorsControlGroup"];
                                }
                            }
                        }

                        if (Gflcol.DataType == "LISTBOX" && this.ScreenObject.GridDataColumns.Contains(Gflcol.ValueMember) && !Util.IsEmpty(CurrentRow[Gflcol.ValueMember])) {
                            Col.Join += " join Acc_accounts g with(nolock) on a.lft between g.lft and g.rgt  and g.AccountID=" + CurrentRow[Gflcol.ValueMember].toString();
                        }
                    }
                }

                if (path.toLowerCase() == "creditaccount_key" && this.ScreenObject.Preferences.ContainsKey("onlyProductvendors") && this.ScreenObject.Preferences["onlyProductvendors"] == "True" && !Util.IsEmpty(CurrentRow["ProductID_Key"])) {
                    let dsaccs: any = this.ScreenObject.GetProductVendors(Util.String(CurrentRow["ProductID_Key"]));
                    let accids = "";
                    if (dsaccs != null && dsaccs.Tables.length > 0 && dsaccs.Tables[0].length > 0 && dsaccs.Columns[0].Contains("AccountID")) {
                        for (let l = 0; l < dsaccs.Tables[0].length; l++) {
                            if (accids != "")
                                accids += ",";
                            accids += Util.String(dsaccs.Tables[0][l]["AccountID"]);
                        }

                    }
                    if (accids != "") {
                        if (Where != "")
                            Where += " and ";
                        Where += " a.AccountID in (" + accids + ")";
                    }
                    //Where += " join INV_ProductVendors ProdVend on a.AccountID=ProdVend.AccountID and ProdVend.ProductID=" + CurrentRow["ProductID_Key"].toString();
                }

                if (Where != null) {
                    if (Where != "") {
                        if (Col.FilterCondition != null && Col.FilterCondition != "")
                            Col.Where = " and " + Where;
                        else
                            Col.Where = Where;
                    }
                    else
                        Col.Where = "";
                }
            }
            else if (Col.CostCenterID == 3) {
                if (this.ScreenObject.DivisionID > 0)
                    Col.DivisionID = this.ScreenObject.DivisionID;
                if (this.ScreenObject.LocationID > 0)
                    Col.LocationID = this.ScreenObject.LocationID;
                Col.ExcludeSelected = 0;
                Col.Join = "";
                let jj = 0;

                //#region CustomFilter

                let Where = "";
                let TotWhere = "";
                for (let j = 0; j < this.ScreenObject.FilterFields.length; j++) {
                    let item = this.ScreenObject.FilterFields[j]
                    if (item.Key.SelectedValue > 1) {
                        if (item.Key.CCID == 65 || item.Key.CCID == 83)
                            continue;
                        if (item.Key.CCID == 50006 || item.Key.CCID == 50004) {
                            if (TotWhere != "")
                                TotWhere += " and ";
                        }
                        else if (Where != "")
                            Where += " and ";

                        if (item.Key.CCID == 50006) {
                            TotWhere += "( a.CategoryID=" + item.Key.SelectedValue.toString() + " ";
                            if (item.Value == 1 || item.Value == 2)
                                TotWhere += " OR a.CategoryID=1";
                            TotWhere += ")";
                        }
                        else if (item.Key.CCID == 50004) {
                            TotWhere += "(a.DepartmentID=" + item.Key.SelectedValue.toString() + " ";
                            if (item.Value == 1 || item.Value == 2)
                                TotWhere += " OR a.DepartmentID=1";
                            TotWhere += ")";
                        }
                        else {
                            if (!this.ScreenObject.ProdFilterinuse.ContainsKey(item.Key.CCID) || parseBoolean(this.ScreenObject.ProdFilterinuse[item.Key.CCID])) {
                                Where += "(CC." + item.Key.DBColumnName.replace("dc", "") + "=" + item.Key.SelectedValue.toString() + " ";
                                if (item.Value == 1 || item.Value == 2)
                                    Where += " OR CC." + item.Key.DBColumnName.replace("dc", "") + "=1 ";
                                Where += ")";
                            }
                            else {
                                Col.Join += " join COM_CostCenterCostCenterMap DCCM" + jj + " with(nolock) on a.ProductID=DCCM" + jj + ".ParentNodeID and DCCM" + jj + ".ParentCostCenterID=3 ";
                                Col.Join += " join " + this.ScreenObject.GetTableName(item.Key.CCID) + " DCCMj" + jj + " with(nolock) on DCCM" + jj + ".CostCenterID=" + item.Key.CCID + " and DCCM" + jj + ".NodeID= DCCMj" + jj + ".NodeID ";
                                Col.Join += " join " + this.ScreenObject.GetTableName(item.Key.CCID) + " DCG" + jj + " with(nolock) on  DCG" + jj + ".lft between   DCCMj" + jj + ".lft and  DCCMj" + jj + ".rgt";
                                Where += "  DCG" + jj + ".NodeID=" + item.Key.SelectedValue.toString();
                                jj++;
                            }
                        }
                    }
                }

                for (let j = 0; j < this.ScreenObject.FilterColumns.keys.length; j++) {
                    let item = { Key: this.ScreenObject.FilterColumns.keys[j], Value: this.ScreenObject.FilterColumns.values[j] }
                    if (!Util.IsEmpty(CurrentRow[item.Key]) && parseInt(CurrentRow[item.Key]) > 0) {
                        let tempcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember == item.Key);
                        if (tempcol) {
                            if (tempcol.CostCenterID == 65 || tempcol.CostCenterID == 83)
                                continue;
                            if (tempcol.CostCenterID == 50006 || tempcol.CostCenterID == 50004) {
                                if (TotWhere != "")
                                    TotWhere += " and ";
                            }
                            else if (Where != "")
                                Where += " and ";


                            if (tempcol.CostCenterID == 50006) {
                                TotWhere += "(a.CategoryID=" + CurrentRow[item.Key];
                                if (item.Value == 1 || item.Value == 2)
                                    TotWhere += " OR a.CategoryID=1";
                                TotWhere += ")";
                            }
                            else if (tempcol.CostCenterID == 50004) {
                                TotWhere += "(a.DepartmentID=" + CurrentRow[item.Key];
                                if (item.Value == 1 || item.Value == 2)
                                    TotWhere += " OR a.DepartmentID=1";
                                TotWhere += ")";
                            }
                            else {
                                if (!this.ScreenObject.ProdFilterinuse.ContainsKey(tempcol.CostCenterID) || parseBoolean(this.ScreenObject.ProdFilterinuse[tempcol.CostCenterID])) {
                                    Where += "(CC." + tempcol.DisplayMember.replace("dc", "") + "=" +
                                        CurrentRow[item.Key];
                                    if (item.Value == 1 || item.Value == 2)
                                        Where += " OR CC." + tempcol.DisplayMember.replace("dc", "") + "=1 ";
                                    Where += ")";
                                }
                                else {
                                    Col.Join += " join COM_CostCenterCostCenterMap DCCM" + jj + " with(nolock) on a.ProductID=DCCM" + jj + ".ParentNodeID and DCCM" + jj + ".ParentCostCenterID=3 ";
                                    Col.Join += " join " + this.ScreenObject.GetTableName(tempcol.CostCenterID) + " DCCMj" + jj + " with(nolock) on DCCM" + jj + ".CostCenterID=" + tempcol.CostCenterID + " and DCCM" + jj + ".NodeID= DCCMj" + jj + ".NodeID ";
                                    Col.Join += " join " + this.ScreenObject.GetTableName(tempcol.CostCenterID) + " DCG" + jj + " with(nolock) on  DCG" + jj + ".lft between   DCCMj" + jj + ".lft and  DCCMj" + jj + ".rgt";
                                    Where += "  DCG" + jj + ".NodeID=" + CurrentRow[item.Key];
                                    jj++;
                                }
                            }
                        }
                    }
                }
                if (Where != "") {
                    if (TotWhere != "")
                        TotWhere += "and " + Where;
                    else
                        TotWhere += Where;
                }
                let vendorwise = parseBoolean(this.ScreenObject.Preferences["Showvendorwiseproducts"]);
                if (vendorwise && this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0) {
                    if (TotWhere != "")
                        TotWhere = TotWhere + " and ";

                    Col.Join += " join INV_ProductVendors IPV with(nolock) on a.ProductID=IPV.ProductID";
                    TotWhere += " IPV.AccountID=" + this.ScreenObject.CreditAccount.SelectedValue;
                }
                else if (this.ScreenObject.Preferences.ContainsKey("Showcustomerwiseproducts") && this.ScreenObject.Preferences["Showcustomerwiseproducts"] != ""
                    && parseBoolean(this.ScreenObject.Preferences["Showcustomerwiseproducts"])
                    && this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0) {
                    if (TotWhere != "")
                        TotWhere = TotWhere + " and ";

                    Col.Join += " join INV_ProductVendors IPV with(nolock) on a.ProductID=IPV.ProductID";
                    TotWhere += " IPV.AccountID=" + this.ScreenObject.DebitAccount.SelectedValue;
                }
                let ExcludeTempPro = parseBoolean(this.ScreenObject.Preferences["ExcludeTemproducts"]);

                if (Col.FilterCondition != null && Col.FilterCondition != "") {
                    if (this.ScreenObject.TempProductID > 0 && TotWhere != "") {
                        if (ExcludeTempPro)
                            Col.Where = "and (" + TotWhere + " and a.ProductID!=" + this.ScreenObject.TempProductID + ")";
                        else
                            Col.Where = "and (" + TotWhere + " or a.ProductID=" + this.ScreenObject.TempProductID + ")";
                    }
                    else
                        Col.Where = "and " + TotWhere;
                    Col.ExcludeSelected = 1;
                }
                else {
                    Col.ExcludeSelected = 1;
                    if (this.ScreenObject.TempProductID > 0 && TotWhere != "") {
                        if (ExcludeTempPro)
                            Col.Where = "(" + TotWhere + " and a.ProductID!=" + this.ScreenObject.TempProductID + ")";
                        else
                            Col.Where = "(" + TotWhere + " or a.ProductID=" + this.ScreenObject.TempProductID + ")";
                    }
                    else if (this.ScreenObject.TempProductID > 0 && TotWhere == "") {
                        if (ExcludeTempPro)
                            Col.Where = "a.ProductID!=" + this.ScreenObject.TempProductID;
                        else
                            Col.Where = "";
                    }
                    else if (TotWhere != "")
                        Col.Where = TotWhere;
                    else
                        Col.Where = "";
                }
                //#endregion

                Col.QtyWhere = this.ScreenObject.GetQtyWhere(CurrentRow, "");

                if (this.ScreenObject.Preferences.ContainsKey("ProductFilterField") && this.ScreenObject.Preferences["ProductFilterField"] != "") {
                    let Gflcol = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["ProductFilterField"]);
                    if (Gflcol && !Util.IsEmpty(Gflcol.ValueMember) && Gflcol.DataType == "LISTBOX" && this.ScreenObject.GridDataColumns.Contains(Gflcol.ValueMember) && !Util.IsEmpty(CurrentRow[Gflcol.ValueMember])) {
                        Col.Join += " join inv_Product g with(nolock) on a.lft between g.lft and g.rgt  and g.ProductID=" + CurrentRow[Gflcol.ValueMember];
                    }
                }

                if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(CurrentRow["ProductID_Key"]))
                    this.ProdID = parseInt(CurrentRow["ProductID_Key"]);
                else
                    this.ProdID = 0;

                let srccol = this.ScreenObject.ColumnSource.find(a => a.ValueMember == path);
                if (srccol && srccol.IsRepeat && (Util.IsEmpty(CurrentRow[srccol.ValueMember])
                    || (!Util.IsEmpty(CurrentRow[srccol.ValueMember]) && parseInt(CurrentRow[srccol.ValueMember]) == 0))) {
                    let index = this.ScreenObject.GridData.indexOf(CurrentRow);
                    if (index > 0) {
                        CurrentRow[srccol.DisplayMember] = this.ScreenObject.GridData[index - 1][srccol.DisplayMember];
                        CurrentRow[srccol.ValueMember] = this.ScreenObject.GridData[index - 1][srccol.ValueMember];
                    }
                }
            }
            else if (Col.CostCenterID > 50000) {
                Col.Join = "";
                let colDetails = col;
                //let colDetails = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != null && a.DisplayMember.toLowerCase() == Col.Binding.toLowerCase());
                if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(CurrentRow["ProductID_Key"])) {
                    if (colDetails != null && (colDetails.Filter == 2 || colDetails.Filter == 4))
                        Col.ProductID = parseInt(CurrentRow["ProductID_Key"]);
                    else
                        Col.ProductID = 0;
                }
                else
                    Col.ProductID = 0;
                let cWhere = "";
                if (colDetails.DependantOn != "") {

                    if (this.DocumentType == 5 && colDetails.DependantOn == "-94" && this.ScreenObject.Preferences.ContainsKey("BudgetFeild") && !Util.IsEmpty(this.ScreenObject.Preferences["BudgetFeild"])) {
                        let accid = "0";
                        if (col.DisplayMember.startsWith("TO") && this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(CurrentRow["CreditAccount_Key"]))
                            accid = CurrentRow["CreditAccount_Key"].toString();
                        else if (!col.DisplayMember.startsWith("TO") && this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(CurrentRow["DebitAccount_Key"]))
                            accid = CurrentRow["DebitAccount_Key"].toString();

                        var txt = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == this.ScreenObject.Preferences["BudgetFeild"].toLowerCase()) as PactListBoxData;
                        if (txt && txt.SelectedValue > 0) {
                            Col.Join = " join COM_BudgetAlloc budg WITH(NOLOCK) on budg.CCNID" + (col.CostCenterID - 50000) + "=a.NodeID ";

                            cWhere = " budg.BudgetDefID=" + txt.SelectedValue;
                            cWhere += " and budg.AccountID=" + accid;
                        }
                    }
                    else if (this.DocumentType == 5 && col.CostCenterID > 50000 && colDetails.DependantOn.toLowerCase().Contains("dcccnid") && colDetails.DisplayMember.toLowerCase().Contains("todcccnid")) {
                        let NDID = 0; let Ncid = 0;
                        ;
                        this.ScreenObject._CCFields.forEach(item => {
                            if (item instanceof PactListBoxData && item.CCID > 50000
                                && item.DBColumnName.Contains("TO") && item.SelectedValue > 0 && item.DBColumnName.Contains("TO")
                                && colDetails.DependantOn.toLowerCase() == item.DBColumnName.Replace("TO", "").toLowerCase()) {
                                NDID = item.SelectedValue;
                                Ncid = item.CCID;
                                if (NDID > 0) {
                                    cWhere = "  JOIN COM_CostCenterCostCenterMap CM with(nolock) on CM.ParentCostCenterID=" + col.CostCenterID + ` and a.NodeID=CM.ParentNodeID 
                                    JOIN ` + this.ScreenObject.GetTableName(Col.CostCenterID) + " CMJ with(nolock) ON CM.CostCenterID= " + Ncid + "   and CM.NodeID=CMJ." + this.ScreenObject.GetPrimaryKey(Col.CostCenterID) + ` 
                                    JOIN ` + this.ScreenObject.GetTableName(Col.CostCenterID) + " CMJG with(nolock) ON CMJG.lft between  CMJ.lft and CMJ.rgt and CMJG." + this.ScreenObject.GetPrimaryKey(Col.CostCenterID) + " =" + NDID;
                                }
                            }
                        });
                    }
                    else if (!Util.IsEmpty(colDetails.FilterColumn)) {
                        if (this.ScreenObject.GridDataColumns.Contains(colDetails.DependantOn + "_Key") && !Util.IsEmpty(CurrentRow[colDetails.DependantOn + "_Key"]) && parseInt(CurrentRow[colDetails.DependantOn + "_Key"]) > 1)
                            cWhere = colDetails.FilterColumn + "=" + CurrentRow[colDetails.DependantOn + "_Key"].toString();
                        else {
                            let cc = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == colDetails.DependantOn.toLowerCase());
                            let NID = 0; let cid = 0;
                            if (cc && cc instanceof PactListBoxData && cc.SelectedValue > 0) {
                                NID = cc.SelectedValue;
                                cid = cc.CCID;
                            }
                            else if (cc && cc instanceof PactCodeNameListBoxData && cc.SelectedValue > 0) {
                                NID = cc.SelectedValue;
                                cid = cc.CCID;
                            }
                            else if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0 && colDetails.DependantOn.toLowerCase() == "creditaccount") {
                                NID = this.ScreenObject.CreditAccount.SelectedValue;
                                cid = 2;
                            }
                            else if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0 && colDetails.DependantOn.toLowerCase() == "debitaccount") {
                                NID = this.ScreenObject.DebitAccount.SelectedValue;
                                cid = 2;
                            }
                            if (NID > 0) {
                                cWhere = colDetails.FilterColumn + "=" + NID.toString();
                            }
                        }
                    }
                    else if (colDetails.Dependantinuse) {
                        if (this.ScreenObject.GridDataColumns.Contains(colDetails.DependantOn + "_Key")) {

                            if (colDetails.DisplayMember.startsWith("TO") && this.ScreenObject.GridDataColumns.Contains("TO" + colDetails.DependantOn + "_Key")) {
                                if (!Util.IsEmpty(CurrentRow["TO" + colDetails.DependantOn + "_Key"]) && parseInt(CurrentRow["TO" + colDetails.DependantOn + "_Key"].toString()) > 1) {
                                    cWhere = "(" + this.GetDbColName(colDetails.DependantOn.Replace("dc", "")) + "=" + CurrentRow["TO" + colDetails.DependantOn + "_Key"].toString();
                                    if (colDetails.Dependancy == 1)
                                        cWhere += " OR " + this.GetDbColName(colDetails.DependantOn.Replace("dc", "")) + "=1 ";
                                    cWhere += ")";
                                }
                            }
                            else if (!Util.IsEmpty(CurrentRow[colDetails.DependantOn + "_Key"]) && parseInt(CurrentRow[colDetails.DependantOn + "_Key"]) > 1) {
                                cWhere = "(" + this.GetDbColName(colDetails.DependantOn.Replace("dc", "")) + "=" + CurrentRow[colDetails.DependantOn + "_Key"].toString();
                                if (colDetails.Dependancy == 1)
                                    cWhere += " OR " + this.GetDbColName(colDetails.DependantOn.Replace("dc", "")) + "=1 ";
                                cWhere += ")";
                            }
                        }
                        else {
                            let cc = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == colDetails.DependantOn.toLowerCase());
                            if (cc && cc instanceof PactListBoxData && cc.SelectedValue > 0) {
                                cWhere = "(" + this.GetDbColName(cc.DBColumnName.Replace("dc", "")) + "=" + cc.SelectedValue.toString();
                                if (colDetails.Dependancy == 1)
                                    cWhere += " OR " + this.GetDbColName(cc.DBColumnName.Replace("dc", "")) + "=1 ";
                                cWhere += ")";
                            }
                            else if (cc != null && cc instanceof PactCodeNameListBoxData && cc.SelectedValue > 0) {
                                cWhere = "(" + this.GetDbColName(cc.DBColumnName.Replace("dc", "")) + "=" + cc.SelectedValue.toString();
                                if (colDetails.Dependancy == 1)
                                    cWhere += " OR " + this.GetDbColName(cc.DBColumnName.Replace("dc", "")) + "=1 ";
                                cWhere += ")";
                            }
                        }
                    }
                    else {
                        if (this.ScreenObject.GridDataColumns.Contains(colDetails.DependantOn + "_Key") && !Util.IsEmpty(CurrentRow[colDetails.DependantOn + "_Key"]) && parseInt(CurrentRow[colDetails.DependantOn + "_Key"]) > 1) {
                            let cc = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == colDetails.DependantOn.toLowerCase() + "_key");
                            if (cc) {
                                if (colDetails.Dependancy == 5)
                                    Col.Join = "  JOIN " + this.ScreenObject.GetTableName(colDetails.CostCenterID) + " CMJ with(nolock) ON a.lft between  CMJ.lft and CMJ.rgt JOIN COM_CostCenterCostCenterMap CM with(nolock) on CM.CostCenterID=" + colDetails.CostCenterID + " and CM.ParentCostCenterID=" + cc.CostCenterID + " and CM.ParentNodeID=" + CurrentRow[colDetails.DependantOn + "_Key"].toString() + " and CMJ.NodeID=CM.NodeID ";
                                else
                                    Col.Join = "  JOIN COM_CostCenterCostCenterMap CM with(nolock) on CM.ParentCostCenterID=" + colDetails.CostCenterID + ` and a.NodeID=CM.ParentNodeID 
                                    JOIN ` + this.ScreenObject.GetTableName(cc.CostCenterID) + " CMJ with(nolock) ON CM.CostCenterID= " + cc.CostCenterID + `  and CM.NodeID=CMJ.NodeID 
                                    JOIN ` + this.ScreenObject.GetTableName(cc.CostCenterID) + " CMJG with(nolock) ON CMJG.lft between  CMJ.lft and CMJ.rgt and CMJG.NodeID=" + CurrentRow[colDetails.DependantOn + "_Key"].toString();
                            }
                        }
                        else {
                            let cc = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == colDetails.DependantOn.toLowerCase());
                            let NID = 0; let cid = 0;
                            if (cc && cc instanceof PactListBoxData && cc.SelectedValue > 0) {
                                NID = cc.SelectedValue;
                                cid = cc.CCID;
                            }
                            else if (cc != null && cc instanceof PactCodeNameListBoxData && cc.SelectedValue > 0) {
                                NID = cc.SelectedValue;
                                cid = cc.CCID;
                            }
                            else if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0 && colDetails.DependantOn.toLowerCase() == "creditaccount") {
                                NID = this.ScreenObject.CreditAccount.SelectedValue;
                                cid = 2;
                            }
                            else if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0 && colDetails.DependantOn.toLowerCase() == "debitaccount") {
                                NID = this.ScreenObject.DebitAccount.SelectedValue;
                                cid = 2;
                            }
                            if (NID > 0) {
                                if (colDetails.Dependancy == 5)
                                    Col.Join = "  JOIN " + this.ScreenObject.GetTableName(colDetails.CostCenterID) + " CMJ with(nolock) ON a.lft between  CMJ.lft and CMJ.rgt JOIN COM_CostCenterCostCenterMap CM with(nolock) on CM.CostCenterID=" + colDetails.CostCenterID + " and CM.ParentCostCenterID=" + cid + " and CM.ParentNodeID=" + NID.toString() + " and CMJ.NodeID=CM.NodeID ";
                                else
                                    Col.Join = "  JOIN COM_CostCenterCostCenterMap CM with(nolock) on CM.ParentCostCenterID=" + colDetails.CostCenterID + ` and a.NodeID=CM.ParentNodeID 
                                    JOIN ` + this.ScreenObject.GetTableName(cid) + " CMJ with(nolock) ON CM.CostCenterID= " + cid + `  and CM.NodeID=CMJ.NodeID 
                                    JOIN ` + this.ScreenObject.GetTableName(cid) + " CMJG with(nolock) ON CMJG.lft between  CMJ.lft and CMJ.rgt and CMJG.NodeID=" + NID.toString();
                            }
                        }
                    }
                }
                if (cWhere.Trim() != "") {
                    if (Col.FilterCondition != null && Col.FilterCondition != "")
                        Col.Where = "and " + cWhere;
                    else
                        Col.Where = cWhere;

                    //alert(Col.Join)
                    //alert(Col.Where)
                }
                //Set Where Condition For Budget Dimension ListBox
                if (BaseService.SessionManager.Preferences["BudgetAccount"].length > 0 && BaseService.SessionManager.Preferences["BudgetDimension"].length > 0 && Col.CostCenterID == this.BudgetObj.iBudgetDimension) {
                    this.BudgetObj.AutoLoadBudgetDimension(CurrentRow, Col);
                }

                if (this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(CurrentRow["ProductID_Key"]) && this.ScreenObject.Preferences.ContainsKey("ProductWiseBins") && parseBoolean(this.ScreenObject.Preferences["ProductWiseBins"])
                    && this.ScreenObject.Preferences.ContainsKey("BinsDimension") && parseInt(this.ScreenObject.Preferences["BinsDimension"]) == Col.CostCenterID) {
                    let BinsWhere = " join INV_ProductBins Bin with(nolock) on a.NodeID=Bin.BinNodeID and Bin.NodeID=" + Util.String(CurrentRow["ProductID_Key"]) + " and ";

                    if (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True" &&
                        BaseService.SessionManager.Preferences.ContainsKey("LW Bins") && BaseService.SessionManager.Preferences["LW Bins"] != "" && parseBoolean(BaseService.SessionManager.Preferences["LW Bins"])) {
                        if (this.ScreenObject.GridDataColumns.Contains("dcCCNID2_Key")) {
                            if (!Util.IsEmpty(CurrentRow["dcCCNID2_Key"]))
                                BinsWhere += " Bin.Location=" + CurrentRow["dcCCNID2_Key"].toString() + " and ";
                        }
                        else {
                            let cc = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
                            if (cc && cc instanceof PactListBoxData) {
                                if (cc.SelectedValue > 0)
                                    BinsWhere += " Bin.Location=" + cc.SelectedValue + " and ";
                            }
                            else if (cc != null && cc instanceof PactCodeNameListBoxData) {
                                if (cc.SelectedValue > 0)
                                    BinsWhere += " Bin.Location=" + cc.SelectedValue + " and ";
                            }
                            else if (this.ScreenObject.LocationID > 0)
                                BinsWhere += " Bin.Location=" + this.ScreenObject.LocationID + " and ";
                            else if (BaseService.SessionManager.LocationID > 0)
                                BinsWhere += " Bin.Location=" + BaseService.SessionManager.LocationID + " and ";
                        }
                    }

                    if (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True" &&
                        BaseService.SessionManager.Preferences.ContainsKey("DW Bins") && BaseService.SessionManager.Preferences["DW Bins"] != "" && parseBoolean(BaseService.SessionManager.Preferences["DW Bins"])) {
                        if (this.ScreenObject.GridDataColumns.Contains("dcCCNID1_Key")) {
                            if (!Util.IsEmpty(CurrentRow["dcCCNID1_Key"]))
                                BinsWhere += " Bin.Division=" + CurrentRow["dcCCNID1_Key"].toString() + " and ";
                        }
                        else {
                            let cc = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid1");
                            if (cc && cc instanceof PactListBoxData) {
                                if (cc.SelectedValue > 0)
                                    BinsWhere += " Bin.Division=" + cc.SelectedValue + " and ";
                            }
                            else if (cc != null && cc instanceof PactCodeNameListBoxData) {
                                if (cc.SelectedValue > 0)
                                    BinsWhere += " Bin.Division=" + cc.SelectedValue + " and ";
                            }
                            else if (this.ScreenObject.DivisionID > 0)
                                BinsWhere += " Bin.Division=" + this.ScreenObject.DivisionID + " and ";
                            else if (BaseService.SessionManager.DivisionID > 0)
                                BinsWhere += " Bin.Division=" + BaseService.SessionManager.DivisionID + " and ";
                        }
                    }

                    let DimCCID;
                    if (BaseService.SessionManager.Preferences.ContainsKey("DimensionwiseBins") && BaseService.SessionManager.Preferences["DimensionwiseBins"] != "" &&
                        Util.IsNum(BaseService.SessionManager.Preferences["DimensionwiseBins"]) && parseInt(BaseService.SessionManager.Preferences["DimensionwiseBins"]) > 50000) {
                        DimCCID = parseInt(BaseService.SessionManager.Preferences["DimensionwiseBins"]);

                        if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (DimCCID - 50000) + "_Key")) {
                            if (!Util.IsEmpty(CurrentRow["dcCCNID" + (DimCCID - 50000) + "_Key"]))
                                BinsWhere += " Bin.DimNodeID=" + CurrentRow["dcCCNID" + (DimCCID - 50000) + "_Key"].toString() + " and ";
                        }
                        else {
                            let cc = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid" + (DimCCID - 50000));
                            if (cc && cc instanceof PactListBoxData) {
                                if (cc.SelectedValue > 0)
                                    BinsWhere += " Bin.DimNodeID=" + cc.SelectedValue + " and ";
                            }
                            else if (cc && cc instanceof PactCodeNameListBoxData) {
                                if (cc.SelectedValue > 0)
                                    BinsWhere += " Bin.DimNodeID=" + cc.SelectedValue + " and ";
                            }
                        }
                    }

                    BinsWhere += " Bin.BinDimension=" + Col.CostCenterID.toString();
                    Col.Join += BinsWhere;
                }
            }
            else if (Col.CostCenterID == 65) {
                let colDetails = col;
                //let colDetails = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != null && a.DisplayMember == ((System.Windows.Data.Binding)Col.Binding).Path.Path);
                if (colDetails.DependantOn != "") {
                    let cWhere = "";
                    if (this.ScreenObject.GridDataColumns.Contains(colDetails.DependantOn + "_Key") && !Util.IsEmpty(CurrentRow[colDetails.DependantOn + "_Key"]) && parseInt(CurrentRow[colDetails.DependantOn + "_Key"]) > 1) {
                        cWhere = "(FeatureID=" + colDetails.CostCenterID + " and  FeaturePK=" + CurrentRow[colDetails.DependantOn + "_Key"].toString();
                        cWhere += ")";
                    }
                    else {
                        let cc = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == colDetails.DependantOn.toLowerCase());
                        if (cc && cc instanceof PactListBoxData && cc.SelectedValue > 0) {
                            cWhere = "(FeatureID=" + cc.CCID + " and  FeaturePK=" + cc.SelectedValue.toString();
                            cWhere += ")";
                        }
                        else if (cc != null && cc instanceof PactCodeNameListBoxData && cc.SelectedValue > 0) {
                            cWhere = "(FeatureID=" + cc.CCID + " and  FeaturePK=" + cc.SelectedValue.toString();
                            cWhere += ")";
                        }
                        else {
                            if (colDetails.DependantOn.toLowerCase() == "debitaccount" && this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0) {
                                cWhere = "(FeatureID=2 and  FeaturePK=" + this.ScreenObject.DebitAccount.SelectedValue.toString();
                                cWhere += ")";

                            }
                            else if (colDetails.DependantOn.toLowerCase() == "creditaccount" && this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0) {
                                cWhere = "(FeatureID=2 and  FeaturePK=" + this.ScreenObject.CreditAccount.SelectedValue.toString();
                                cWhere += ")";

                            }
                        }
                    }
                    if (Col.FilterCondition != null && Col.FilterCondition != "")
                        Col.Where = "and " + cWhere;
                    else
                        Col.Where = cWhere;
                }
            }
            else if (Col.CostCenterID == 7) {
                let NID = 0; let cid = 0;
                let colDetails = col;
                //let colDetails = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != null && a.DisplayMember == ((System.Windows.Data.Binding)Col.Binding).Path.Path);
                if (this.ScreenObject.GridDataColumns.Contains(colDetails.DependantOn + "_Key") && !Util.IsEmpty(CurrentRow[colDetails.DependantOn + "_Key"]) && parseInt(CurrentRow[colDetails.DependantOn + "_Key"]) > 1) {
                    let cc = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == colDetails.DependantOn.toLowerCase() + "_key");
                    if (cc && !Util.IsEmpty(CurrentRow[colDetails.DependantOn + "_Key"])) {
                        cid = cc.CostCenterID;
                        NID = parseInt(CurrentRow[colDetails.DependantOn + "_Key"]);
                    }
                }
                else {
                    let cccol = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == colDetails.DependantOn.toLowerCase());

                    if (cccol && cccol instanceof PactListBoxData && cccol.SelectedValue > 0) {
                        NID = cccol.SelectedValue;
                        cid = cccol.CCID;
                    }
                }
                if (NID > 0) {
                    Col.Join = ` JOIN COM_CostCenterCostCenterMap CM with(nolock) on CM.ParentCostCenterID=7 and a.UserID=CM.ParentNodeID 
                                    and CM.CostCenterID=` + cid + " and CM.NodeID=" + NID;
                }
            }
            else
                Col.ProductID = 0;
        }
    }


    // Name : OnKeyDown
    // Desc : Short cut keys of gridview in document.
    // Category : COMMON
    OnKeyDown(args, e) {
        if (!e.ctrlKey && e.which == 112) {//e.key == "F1"
            e.preventDefault();
            BaseService.page.ShowDialog(new RowDetailsDialogViewModel(this), RowDetailsComponent);
            //this.onEidtQuantity("Attachments")
            //alert(e.key + " -- > Code == " + e.which + " ctrlKey click == " + e.ctrlKey);
        }
        else if (!e.ctrlKey && e.which == 113) {//e.key == "F2"
            e.preventDefault();
            this.onRoundOff(this.ScreenObject.GridDataObj.getArgsObj(args))
        }
        else if (!e.ctrlKey && e.which == 114) {//e.key == "F3"
            e.preventDefault();
            //args.grid.getEditorLock().commitCurrentEdit();
            this.ScreenObject.GridDataObj.commitEdit();
            this.onSearchProduct(this.ScreenObject.GridDataObj.getArgsObj(args));
        }
        else if (!e.ctrlKey && e.which == 116) {//e.key == "F5"
            e.preventDefault();
            this.onDistribute(this.ScreenObject.GridDataObj.getArgsObj(args));
        }
        else if (!e.ctrlKey && e.which == 117) {//e.key == "F6"
            e.preventDefault();
            this.onCopy(this.ScreenObject.GridDataObj.getArgsObj(args))
            this.ScreenObject.GridDataObj.refreshDatawithIDs();
        }
        else if (!e.ctrlKey && e.which == 118) {//e.key == "F7"
            e.preventDefault();
            this.onFieldCalc(this.ScreenObject.GridDataObj.getArgsObj(args));
        }
        else if (!e.ctrlKey && e.which == 119) {//e.key == "F8"

            e.preventDefault();
            this.onShowImage(this.ScreenObject.GridDataObj.getArgsObj(args));
        }
        else if (!e.ctrlKey && e.which == 121) {//e.key == "F10"

            e.preventDefault();
            this.onEidtQuantity("Quantity");
        }
        else if (e.ctrlKey) {
            if (e.which == 112) {//e.key == "F1"
                e.preventDefault();
                //this.onEidtQuantity("FreeProds")
                let dr = this.SelectedRow;
                if (this.SelectedRow != null && (this.IsInventoryVoucher && !Util.IsEmpty(dr["DocDetailsID"]) && parseInt(dr["DocDetailsID"]) != 0)) {
                    BaseService.page.ShowDialog(new DocumentFlowChartViewModel(true, "LINEID:" + dr["DocDetailsID"].toString() + "~" + this.ScreenObject.VoucherNo), DocumentFlowChartComponent);
                }
                else if (!Util.IsEmpty(this.ScreenObject.VoucherNo) && this.ScreenObject.VoucherNo.length > 0) {
                    BaseService.page.ShowDialog(new DocumentFlowChartViewModel(true, this.ScreenObject.VoucherNo), DocumentFlowChartComponent);
                }
                //alert(e.key + " -- > Code == " + e.which + " ctrlKey click == " + e.ctrlKey);
            }
            else if (e.which == 114) {//e.key == "F3"
                e.preventDefault();
                this.onEidtQuantity("DistributeQty");
            }
            else if (e.which == 116) {//e.key == "F5"
                e.preventDefault();
                this.onEidtQuantity("Distribute");
            }
            else if (e.which == 117) {//e.key == "F6"
                e.preventDefault();
                this.onEidtQuantity("Copy");
            }
            else if (e.which == 118) {//e.key == "F7"
                e.preventDefault();
                this.onEidtQuantity("DistributeGen");
            }
            else if (e.which == 113) {//Ctrl+F2 
                e.preventDefault();
                this.onDistDim(this.ScreenObject.GridDataObj.getArgsObj(args));
            }
        }
    }

    // Name : Onshortcut
    // Desc : Short cut keys of gridview in document.
    // Category : COMMON
    Onshortcut(sender, objCell) {

        switch (sender) {
            case "Ctrl+f5":
                this.onEidtQuantity("Distribute");
                break;
            case "Ctrl+f3":
                this.onEidtQuantity("DistributeQty");
                break;
            case "Ctrl+f6":
                this.onEidtQuantity("Copy");
                break;
            case "Ctrl+f7":
                this.onEidtQuantity("DistributeGen");
                break;
            case "f5":
                this.onDistribute(objCell);
                break;
            case "Ctrl+f2":
                this.onDistDim(objCell);
                break;
            case "f6":
                this.onCopy(objCell);
                this.ScreenObject.GridDataObj.refreshDatawithIDs();
                break;
            case "f2":
                this.onRoundOff(objCell);
                break;
            case "f3":
                this.ScreenObject.GridDataObj.commitEdit();
                this.onSearchProduct(objCell);
                break;
            case "f8":
                this.onShowImage(objCell);
                break;
            case "f7":
                this.onFieldCalc(objCell);
                break;
            case "f1":
                BaseService.page.ShowDialog(new RowDetailsDialogViewModel(this), RowDetailsComponent);
                break;
            case "Ctrl+f1":
                let dr = this.SelectedRow;
                if (this.SelectedRow != null && (this.IsInventoryVoucher && !Util.IsEmpty(dr["DocDetailsID"]) && parseInt(dr["DocDetailsID"]) != 0)) {
                    BaseService.page.ShowDialog(new DocumentFlowChartViewModel(true, "LINEID:" + dr["DocDetailsID"].toString() + "~" + this.ScreenObject.VoucherNo), DocumentFlowChartComponent);
                }
                else if (!Util.IsEmpty(this.ScreenObject.VoucherNo) && this.ScreenObject.VoucherNo.length > 0) {
                    BaseService.page.ShowDialog(new DocumentFlowChartViewModel(true, this.ScreenObject.VoucherNo), DocumentFlowChartComponent);
                }
                break;

        }
        //    <KeyBinding Gesture="Ctrl+f5" Command="{Binding EidtQuantity}" CommandParameter="Distribute"></KeyBinding>
        //        <KeyBinding Gesture="Ctrl+f3" Command="{Binding EidtQuantity}" CommandParameter="DistributeQty"></KeyBinding>
        //        <KeyBinding Gesture="Ctrl+f6" Command="{Binding EidtQuantity}" CommandParameter="Copy"></KeyBinding>
        //        <KeyBinding Gesture="f5" Command="{Binding Distribute}" CommandParameter="{Binding CurrentCell,ElementName=GrdBody}"></KeyBinding>
        //        <KeyBinding Gesture="Ctrl+f2" Command="{Binding DistDim}" CommandParameter="{Binding CurrentCell,ElementName=GrdBody}"></KeyBinding>
        //        <KeyBinding Gesture="f6" Command="{Binding Copy}" CommandParameter="{Binding CurrentCell,ElementName=GrdBody}"></KeyBinding>
        //        <KeyBinding Gesture="f2" Command="{Binding RoundOff}" CommandParameter="{Binding CurrentCell,ElementName=GrdBody}"></KeyBinding>
        //        <KeyBinding Gesture="f3" Command="{Binding SearchProduct}" CommandParameter="{Binding CurrentCell,ElementName=GrdBody}"></KeyBinding>
        //        <KeyBinding Gesture="f8" Command="{Binding ShowImage}" CommandParameter="{Binding CurrentCell,ElementName=GrdBody}"></KeyBinding>
        //        <KeyBinding Gesture="f10" Command="{Binding EidtQuantity}" CommandParameter="Quantity"  ></KeyBinding>
        //        <KeyBinding Gesture="f7" Command="{Binding FieldCalc}" CommandParameter="{Binding CurrentCell,ElementName=GrdBody}"></KeyBinding>
        //        <KeyBinding Gesture="f1" Command="{Binding EidtQuantity}" CommandParameter="Attachments"></KeyBinding>
        //        <KeyBinding Gesture="Ctrl+f1" Command="{Binding EidtQuantity}" CommandParameter="FreeProds"></KeyBinding> 
    }

    // Name : OnFooterKeyDown
    // Desc : Short cut keys of footer gridview in document.
    // Category : INVENTORY
    OnFooterKeyDown(args, e) {
        if (!e.ctrlKey && e.which == 113)//e.key == "F2"
            this.onFooterRoundOff(this.ScreenObject.GridDataObj.getArgsObj(args))
        else if (!e.ctrlKey && e.which == 116)//e.key == "F5"
            this.DistributeFooter(false, true);
    }

    GetDbColName(ColName: string): string {
        if (ColName.toLowerCase().Contains("ccnid"))
            return "CC." + ColName;
        return ColName;
    }

    // Name : FillDt
    // Desc : this method used in PrepareJV, filling datatable.
    // Category : COMMON
    FillDt(dt: any[], Account: string, IsRef: boolean, Amt: string, IsCredit: boolean, CurrID: number, ExhgRate: number) {
        let temp = Util.Double(Amt);
        if (temp < 0) {
            IsCredit = !IsCredit;
            temp = temp * -1;
        }

        if (BaseService.SessionManager.Preferences.ContainsKey("DecimalsinAmount") && !Util.IsEmpty(BaseService.SessionManager.Preferences["DecimalsinAmount"].toString()))
            temp = parseFloat(temp.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"].toString()));
        
            let Dr: any = dt.find(x => x.AccountID_Key == Account && x.IsRef == IsRef);
        if (Dr) {
            if (parseInt(Dr["CurrencyID"]) != CurrID) {
                Dr["CRAmt"] = parseFloat(Dr["CRAmt"]) * parseFloat(Dr["ExchangeRate"]);
                Dr["DBAmt"] = parseFloat(Dr["DBAmt"]) * parseFloat(Dr["ExchangeRate"]);
                Dr["CurrencyID"] = 1;
                Dr["ExchangeRate"] = 1;
                temp = temp * ExhgRate;
            }
            if (IsCredit)
                Dr["CRAmt"] = parseFloat(Dr["CRAmt"]) + temp;
            else
                Dr["DBAmt"] = parseFloat(Dr["DBAmt"]) + temp;
        }
        else {
            Dr = {};
            Dr["AccountID_Key"] = Account;
            Dr["IsRef"] = IsRef;
            Dr["CurrencyID"] = CurrID;
            Dr["ExchangeRate"] = ExhgRate;
            if (IsCredit) {
                Dr["CRAmt"] = temp;
                Dr["DBAmt"] = 0;
            }
            else {
                Dr["DBAmt"] = temp;
                Dr["CRAmt"] = 0;
            }
            dt.push(Dr);
        }

    }

    genLinkResolve: any; // Local variable used in Generate link method.
    ToLinkParent: AddEditDocumentViewModel; // Local variable used in GenerateLinkDocument method.

    // Name : GenerateLinkClick
    // Desc : this method used for document linking concept.
    // Category : INVENTORY
    GenerateLinkClick() {
        if (this.ScreenObject.Data.Tables.length > 20) {
            let drtolink = this.ScreenObject.Data.Tables[20].filter(x => x.CostCenterIDBase > 40000);
            if (drtolink.length == 1) {
                new Promise((genLinkResolve, reject) => {
                    this.genLinkResolve = genLinkResolve;
                    this.GenerateLinkDocument(parseInt(drtolink[0]["CostCenterIDBase"]))
                }).then((retValue) => {
                    if (!retValue) {
                        BaseService.page.ShowDialog(new LinkedVouchersViewModel(this), LinkedVouchersComponent)
                    }
                });

            }
            else if (drtolink.length > 1) {
                let gt = new GoToLineViewModel();
                gt.GoToLineViewModel_3(this, drtolink, 0);
                BaseService.page.ShowDialog(gt, GoToLineComponent, { ShowCenter: true, NoWidth: true });
            }
        }
    }

    // Name : GenerateLinkDocument
    // Desc : this method used for document linking concept.
    // Category : INVENTORY
    GenerateLinkDocument(cid: number) {
        let Tolink: AddEditDocumentViewModel;
        if (this.ScreenObject.Preferences.ContainsKey("PromptDim") && parseBoolean(this.ScreenObject.Preferences["PromptDim"]))
            Tolink = new AddEditDocumentViewModel(cid, "", false);
        else
            Tolink = new AddEditDocumentViewModel(cid, "", false, this);

        if (!Tolink.DocumentNumber || !Tolink.DocumentNumber.DialogOptions)
            this.GenerateLinkDocument_Sub1(Tolink);
        else
            Tolink.ToLinkParent = this;
    }

    // Name : GenerateLinkDocument_Sub1
    // Desc : this method used for document linking concept.
    // Category : INVENTORY
    GenerateLinkDocument_Sub1(Tolink: AddEditDocumentViewModel) {
        if (!Tolink.DialogResult) {
            if (this.genLinkResolve)
                this.genLinkResolve(false);
            return false;
        }
        if ((Tolink.ScreenObject.Preferences.ContainsKey("Debit Account") && parseBoolean(Tolink.ScreenObject.Preferences["Debit Account"]))
            || (Tolink.ScreenObject.Preferences.ContainsKey("LinkVendorProducts") && parseBoolean(Tolink.ScreenObject.Preferences["LinkVendorProducts"]))) {
            if (Tolink.ScreenObject.DebitAccount != null) {
                if (Tolink.DocumentType == 10 && this.ScreenObject.CreditAccount != null)
                    Tolink.ScreenObject.DebitAccount.SelectedValue = this.ScreenObject.CreditAccount.SelectedValue;
                else if (this.ScreenObject.DebitAccount != null)
                    Tolink.ScreenObject.DebitAccount.SelectedValue = this.ScreenObject.DebitAccount.SelectedValue;
                else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key")) {
                    let col = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.ValueMember) && a.ValueMember.toLowerCase() == "debitaccount_key");
                    let accid = "";
                    let DocDetailsIds = "";
                    for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[k]["DebitAccount_Key"])) {
                            if (accid.length > 0)
                                accid += ",";
                            accid += this.ScreenObject.GridData[k]["DebitAccount_Key"].toString();
                        }
                        if (!Util.IsEmpty(this.ScreenObject.GridData[k]["DocDetailsID"]) && parseInt(this.ScreenObject.GridData[k]["DocDetailsID"].toString()) > 0) {
                            if (DocDetailsIds.length > 0)
                                DocDetailsIds += ",";
                            DocDetailsIds += this.ScreenObject.GridData[k]["DocDetailsID"].toString();
                        }
                    }
                    //#region Avoiding Executed vendor on selection list
                    let _accList = new Array<number>();
                    if (accid.length > 0) {
                        let lstacc: any = accid.split(',');
                        let mDt = this.ScreenObject.Get_AvoidMultiplePostedAccount(DocDetailsIds);
                        if (mDt != null && mDt.length > 0) {

                            for (let i = 0; i < mDt.length; i++) {
                                if (!Util.IsEmpty(mDt[i]["DebitAccount"])) {
                                    if (lstacc.Contains(mDt[i]["DebitAccount"].toString())) {
                                        lstacc.Remove(mDt[i]["DebitAccount"].toString());
                                    }
                                }
                            }
                            accid = "";
                            for (let i = 0; i < lstacc.length; i++) {
                                if (accid.length > 0)
                                    accid += ",";
                                accid += lstacc[i].toString();
                            }
                        }
                        for (let i = 0; i < lstacc.length; i++) {
                            if (!_accList.Contains(parseInt(lstacc[i].toString()))) {
                                _accList.push(parseInt(lstacc[i].toString()));
                            }
                        }
                    }
                    //#endregion
                    if (_accList.length > 1) // if the account list is greater than one then selection popup is populating otherwise direcectly setting value to DebitAccount.SelecetedValue.
                    {
                        if (accid.length > 0)
                            accid = " a.accountid in(" + accid + ")";
                        let gtm = new GoToLineViewModel();
                        gtm.GoToLineViewModel_4(this, 2, 2);
                        if (col) {
                            gtm.Title = "Select " + col.Header;
                            gtm.Label = col.Header;
                        }
                        gtm.Dimension.CustomWhere = accid;
                        BaseService.page.ShowDialog(gtm, GoToLineComponent, { ShowCenter: true }, () => {

                            if (gtm.Dimension.SelectedValue > 0)
                                Tolink.ScreenObject.DebitAccount.SelectedValue = gtm.Dimension.SelectedValue;

                            this.Callback_GenerateLinkDocument_Sub1(Tolink);
                        });
                        return false;
                    }
                    else if (_accList.length == 1) {
                        Tolink.ScreenObject.DebitAccount.SelectedValue = _accList[0];
                        //this.Callback_GenerateLinkDocument_Sub1(Tolink);
                    }
                }
            }
        }
        if (((Tolink.ScreenObject.Preferences.ContainsKey("Credit Account") && parseBoolean(Tolink.ScreenObject.Preferences["Credit Account"]))
            || (Tolink.ScreenObject.Preferences.ContainsKey("LinkVendorProducts") && parseBoolean(Tolink.ScreenObject.Preferences["LinkVendorProducts"])))
            && Tolink.ScreenObject.CreditAccount != null) {
            if (Tolink.DocumentType == 6 && this.ScreenObject.DebitAccount != null)
                Tolink.ScreenObject.CreditAccount.SelectedValue = this.ScreenObject.DebitAccount.SelectedValue;
            else if (this.ScreenObject.CreditAccount != null)
                Tolink.ScreenObject.CreditAccount.SelectedValue = this.ScreenObject.CreditAccount.SelectedValue;
            else if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")) {
                let col = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.ValueMember) && a.ValueMember.toLowerCase() == "creditaccount_key");
                let accid = "";
                let DocDetailsIds = "";
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["CreditAccount_Key"])) {
                        if (accid.length > 0)
                            accid += ",";
                        accid += this.ScreenObject.GridData[k]["CreditAccount_Key"].toString();
                    }
                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["DocDetailsID"]) && parseInt(this.ScreenObject.GridData[k]["DocDetailsID"].toString()) > 0) {
                        if (DocDetailsIds.length > 0)
                            DocDetailsIds += ",";
                        DocDetailsIds += this.ScreenObject.GridData[k]["DocDetailsID"].toString();
                    }
                }
                //#region Avoiding Executed vendor on selection list
                let _accList = new Array<number>();
                if (accid.length > 0) {
                    let lstacc: any = accid.split(',');
                    let mDt = this.ScreenObject.Get_AvoidMultiplePostedAccount(DocDetailsIds);
                    if (mDt != null && mDt.length > 0) {

                        for (let i = 0; i < mDt.length; i++) {
                            if (!Util.IsEmpty(mDt[i]["CreditAccount"])) {
                                if (lstacc.Contains(mDt[i]["CreditAccount"].toString())) {
                                    lstacc.Remove(mDt[i]["CreditAccount"].toString());
                                }
                            }
                        }
                        accid = "";
                        for (let i = 0; i < lstacc.length; i++) {
                            if (accid.length > 0)
                                accid += ",";
                            accid += lstacc[i].toString();
                        }
                    }
                    for (let i = 0; i < lstacc.length; i++) {
                        if (!_accList.Contains(parseInt(lstacc[i].toString()))) {
                            _accList.push(parseInt(lstacc[i].toString()));
                        }
                    }
                }
                //#endregion
                if (_accList.length > 1) // if the account list is greater than one then selection popup is populating otherwise direcectly setting value to CreditAccount.SelecetedValue.
                {
                    if (accid.length > 0)
                        accid = " a.accountid in(" + accid + ")";
                    let gtm = new GoToLineViewModel()
                    gtm.GoToLineViewModel_4(this, 2, 2);
                    if (col) {
                        gtm.Title = "Select " + col.Header;
                        gtm.Label = col.Header;
                    }
                    gtm.Dimension.CustomWhere = accid;
                    BaseService.page.ShowDialog(gtm, GoToLineComponent, { ShowCenter: true }, () => {

                        if (gtm.Dimension.SelectedValue > 0)
                            Tolink.ScreenObject.CreditAccount.SelectedValue = gtm.Dimension.SelectedValue;
                        this.Callback_GenerateLinkDocument_Sub1(Tolink);
                    });
                    return false;
                }
                else if (_accList.length == 1) {
                    Tolink.ScreenObject.CreditAccount.SelectedValue = _accList[0];
                    //this.Callback_GenerateLinkDocument_Sub1(Tolink);
                }
            }
        }
        this.Callback_GenerateLinkDocument_Sub1(Tolink);
        return true
    }
    Callback_GenerateLinkDocument_Sub1(Tolink) {
        if (Tolink.ScreenObject.Preferences.ContainsKey("DimensionWise") && Tolink.ScreenObject.Preferences["DimensionWise"] != "") {
            let Dimccids = Tolink.ScreenObject.Preferences["DimensionWise"].split(',');
            Dimccids.forEach(item => {
                if (item != "") {
                    let ccid = parseInt(item);
                    if (ccid == 3) {
                        let dimt = Tolink.ScreenObject._TextFields.find(a => a instanceof PactListBoxData && a.CCID == 3) as PactListBoxData;
                        if (dimt) {
                            let dimf = this.ScreenObject._TextFields.find(a => a instanceof PactListBoxData && a.CCID == 3) as PactListBoxData;
                            if (dimf && dimf.SelectedValue > 0)
                                dimt.SelectedValue = dimf.SelectedValue;
                        }
                    }
                    else if (ccid > 50000) {
                        let dimt = Tolink.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == ccid) as PactListBoxData;
                        if (dimt) {
                            let dimf = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == ccid) as PactListBoxData;
                            if (dimf != null && dimf.SelectedValue > 0)
                                dimt.SelectedValue = dimf.SelectedValue;
                        }
                    }
                }
            });
        }

        if (Tolink.ScreenObject.Link != null && Tolink.ScreenObject.Link.LinkCombo != null) {
            if (Tolink.ScreenObject.Link.LinkCombo.Items.length == 1) {
                Tolink.ScreenObject.Link.LinkCombo.SelectedValue = Tolink.ScreenObject.Link.LinkCombo.Items[0].Value;
                Tolink.OLinkSelectionChanged(null);
            }
            else {
                let selectlink = Tolink.ScreenObject.Link.LinkCombo.Items.find(a => a.Parent != null && a.Parent == this.CostCenterID.toString());
                if (selectlink) {
                    Tolink.ScreenObject.Link.LinkCombo.SelectedValue = selectlink.Value;
                    Tolink.OLinkSelectionChanged(null);
                }
            }
            let linkdoc = Tolink.ScreenObject.Link.DocumentList.Items.find(a => a.Value == this.ScreenObject.DocID.toString());
            if (linkdoc) {
                linkdoc.IsChecked = true;
                Tolink.IsFirstCallSelective = true;// if selective linking cancel button click, then whole tab should be close.
                Tolink.OnLinkDocumentCheckedChanged(linkdoc);
                if (!Tolink.DialogResult) {
                    if (this.genLinkResolve)
                        this.genLinkResolve(false);
                    return false;
                }
            }
            else {
                if (this.genLinkResolve)
                    this.genLinkResolve(false);
                return false;
            }
        }
        if (!Tolink.RefreshGridFooter)
            Tolink.RefreshGridFooter = true;
        BaseService.page.addNewTab({ component: AddEditDocumentComponent, params: { obj: Tolink } })
        {
            if (this.genLinkResolve)
                this.genLinkResolve(true);
            return true;
        }
    }
    IsFirstCallSelective = false; // Local variable used for selective linking cancel button click

    // Name : PrepareJV
    // Desc : to display Journal Voucher Popup on button click.
    // Category : INVENTORY
    PrepareJV() {
        let JvDt = [];// new DataTable()
        let JvDtColumns: string[] = []
        JvDtColumns.push("AccountCode");
        JvDtColumns.push("AccountID");
        JvDtColumns.push("AccountID_Key");//, typeof(long));
        JvDtColumns.push("CRAmt");//, typeof(double));
        JvDtColumns.push("DBAmt");//, typeof(double));
        JvDtColumns.push("IsRef");//, typeof(bool));
        JvDtColumns.push("CurrencyID");//, typeof(long));
        JvDtColumns.push("ExchangeRate");//, typeof(double));
        JvDtColumns.push("CRAmtFC");//, typeof(double));
        JvDtColumns.push("DBAmtFC");//, typeof(double));
        let DonotUpdateAccounts = true;
        if (this.ScreenObject.Preferences.ContainsKey("DonotupdateAccounts")) {
            if (this.ScreenObject.Preferences["DonotupdateAccounts"] != "")
                DonotUpdateAccounts = parseBoolean(this.ScreenObject.Preferences["DonotupdateAccounts"]);
        }

        let CurrencyID: number = 1, ExchangeRate: number = 1;

        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {

            for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                let TempVal;
                CurrencyID = this.GetCurrencyID(i);
                ExchangeRate = this.GetExchRate(i);
                if (this.ScreenObject.ColumnSource[j].SectionID == 3 && (!DonotUpdateAccounts && (this.ScreenObject.ColumnSource[j].PostingType == 3 || this.ScreenObject.ColumnSource[j].PostingType == 4))
                    || (!this.IsInventoryVoucher && ((this.ScreenObject.ColumnSource[j].PostingType == 3 || this.ScreenObject.ColumnSource[j].PostingType == 4)
                        || this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "amount"
                        || this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "debitamount"
                        || this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "creditamount"))) {
                    let Amount = Util.String(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]);
                    if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcnum")) {
                        Amount = Util.String(this.ScreenObject.GridData[i]["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember]);
                        if (this.ScreenObject.GridDataColumns.Contains("dcExchRT" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "").toString()) && this.ScreenObject.GridDataColumns.Contains("dcCurrID" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "").toString() + "_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCurrID" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "").toString() + "_Key"])) {
                            CurrencyID = parseInt(this.ScreenObject.GridData[i]["dcCurrID" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "").toString() + "_Key"]);
                            ExchangeRate = parseFloat(this.ScreenObject.GridData[i]["dcExchRT" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "").toString()]);
                        }
                    }

                    if (Amount != "" && Util.Double(Amount) != 0) {
                        let DBAcc = 0, CrACC = 0; let IsCredRef = false, IsDebRef = false;

                        if (this.ScreenObject.ColumnSource[j].DrRefColID > 0) {
                            DBAcc = this.ScreenObject.ColumnSource[j].DrRefColID;
                            IsDebRef = true;
                        }
                        else if (this.ScreenObject.ColumnSource[j].DebitAccount > 0)
                            DBAcc = this.ScreenObject.ColumnSource[j].DebitAccount;
                        else if (this.ScreenObject.DebitAccount != null)
                            DBAcc = this.ScreenObject.DebitAccount.SelectedValue;
                        else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                            DBAcc = parseInt(this.ScreenObject.GridData[i]["DebitAccount_Key"]);

                        if (this.ScreenObject.ColumnSource[j].CrRefColID > 0) {
                            CrACC = this.ScreenObject.ColumnSource[j].CrRefColID;
                            IsCredRef = true;
                        }
                        else if (this.ScreenObject.ColumnSource[j].CreditAcount > 0)
                            CrACC = this.ScreenObject.ColumnSource[j].CreditAcount;
                        else if (this.ScreenObject.CreditAccount != null)
                            CrACC = this.ScreenObject.CreditAccount.SelectedValue;
                        else if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                            CrACC = parseInt(this.ScreenObject.GridData[i]["CreditAccount_Key"]);

                        if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"])
                            && this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "debitamount"
                            && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAmount"]) && parseFloat(this.ScreenObject.GridData[i]["DebitAmount"]) > 0)
                            DBAcc = parseInt(this.ScreenObject.GridData[i]["AccountID_Key"]);

                        if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"])
                            && this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "creditamount"
                            && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAmount"]) && parseFloat(this.ScreenObject.GridData[i]["CreditAmount"]) > 0)
                            CrACC = parseInt(this.ScreenObject.GridData[i]["AccountID_Key"]);

                        if (CrACC > 0)
                            this.FillDt(JvDt, CrACC.toString(), IsCredRef, Amount, true, CurrencyID, ExchangeRate);
                        if (DBAcc > 0)
                            this.FillDt(JvDt, DBAcc.toString(), IsDebRef, Amount, false, CurrencyID, ExchangeRate);
                    }
                }
            }
        }

        for (let k = 0; k < this.ScreenObject.FooterGridData.length; k++) {
            let FooterVal = 0;
            let FCol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == Util.String(this.ScreenObject.FooterGridData[k]["ColumnName"]));
            FooterVal = Util.Double(this.ScreenObject.FooterGridData[k]["CalcAmount"]);
            if (FCol && FooterVal != 0 && !DonotUpdateAccounts && (FCol.PostingType == 3 || FCol.PostingType == 4)) {
                if (this.ScreenObject.FooterColumnSource.length > 4 && this.ScreenObject.FooterColumnSource[4].IsVisible &&
                    !Util.IsEmpty(this.ScreenObject.FooterGridData[k]["CreditAccount"]) && parseInt(this.ScreenObject.FooterGridData[k]["CreditAccount"]) > 0)
                    FCol.CreditAcount = parseInt(this.ScreenObject.FooterGridData[k]["CreditAccount"]);

                let DBAcc = 0, CrACC = 0; let IsCredRef = false, IsDebRef = false;

                if (FCol.DrRefColID > 0) {
                    DBAcc = FCol.DrRefColID;
                    IsDebRef = true;
                }
                else if (this.ScreenObject.FooterColumnSource.length > 3 && this.ScreenObject.FooterColumnSource[3].IsVisible &&
                    !Util.IsEmpty(this.ScreenObject.FooterGridData[k]["DebitAccount"]) && parseInt(this.ScreenObject.FooterGridData[k]["DebitAccount"]) > 0)
                    DBAcc = parseInt(this.ScreenObject.FooterGridData[k]["DebitAccount"]);
                else if (FCol.DebitAccount > 0)
                    DBAcc = FCol.DebitAccount;
                else if (this.ScreenObject.DebitAccount != null)
                    DBAcc = this.ScreenObject.DebitAccount.SelectedValue;
                else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key")) {
                    this.DistributeValues("dcCalc" + FCol.DisplayMember, FooterVal, (FCol.DistributeColName != "") ? FCol.DistributeColName : "Gross", false);
                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCalc" + FCol.DisplayMember])) {
                                if (this.ScreenObject.GridDataColumns.Contains("dcExchRT" + FCol.DisplayMember.toLowerCase().replace("dcnum", "").toString()) && this.ScreenObject.GridDataColumns.Contains("dcCurrID" + FCol.DisplayMember.toLowerCase().replace("dcnum", "").toString() + "_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCurrID" + FCol.DisplayMember.toLowerCase().replace("dcnum", "").toString() + "_Key"])) {
                                    CurrencyID = parseInt(this.ScreenObject.GridData[i]["dcCurrID" + FCol.DisplayMember.toLowerCase().replace("dcnum", "").toString() + "_Key"].toString());
                                    ExchangeRate = parseFloat(this.ScreenObject.GridData[i]["dcExchRT" + FCol.DisplayMember.toLowerCase().replace("dcnum", "").toString()].toString());
                                }
                                this.FillDt(JvDt, this.ScreenObject.GridData[i]["DebitAccount_Key"].toString(), false, this.ScreenObject.GridData[i]["dcCalc" + FCol.DisplayMember].toString(), false, CurrencyID, ExchangeRate);
                            }
                        }
                    }
                }

                if (FCol.CrRefColID > 0) {
                    CrACC = FCol.CrRefColID;
                    IsCredRef = true;
                }
                else if (this.ScreenObject.FooterColumnSource.length > 4 && this.ScreenObject.FooterColumnSource[4].IsVisible &&
                    !Util.IsEmpty(this.ScreenObject.FooterGridData[k]["CreditAccount"]) && parseInt(this.ScreenObject.FooterGridData[k]["CreditAccount"]) > 0)
                    CrACC = parseInt(this.ScreenObject.FooterGridData[k]["CreditAccount"]);
                else if (FCol.CreditAcount > 0)
                    CrACC = FCol.CreditAcount;
                else if (this.ScreenObject.CreditAccount != null)
                    CrACC = this.ScreenObject.CreditAccount.SelectedValue;
                else if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")) {
                    this.DistributeValues("dcCalc" + FCol.DisplayMember, FooterVal, (FCol.DistributeColName != "") ? FCol.DistributeColName : "Gross", false);
                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCalc" + FCol.DisplayMember])) {
                                if (this.ScreenObject.GridDataColumns.Contains("dcExchRT" + FCol.DisplayMember.toLowerCase().replace("dcnum", "").toString()) && this.ScreenObject.GridDataColumns.Contains("dcCurrID" + FCol.DisplayMember.toLowerCase().replace("dcnum", "").toString() + "_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCurrID" + FCol.DisplayMember.toLowerCase().replace("dcnum", "").toString() + "_Key"])) {
                                    CurrencyID = parseInt(this.ScreenObject.GridData[i]["dcCurrID" + FCol.DisplayMember.toLowerCase().replace("dcnum", "").toString() + "_Key"].toString());
                                    ExchangeRate = parseFloat(this.ScreenObject.GridData[i]["dcExchRT" + FCol.DisplayMember.toLowerCase().replace("dcnum", "").toString()].toString());
                                }
                                this.FillDt(JvDt, this.ScreenObject.GridData[i]["CreditAccount_Key"].toString(), false, this.ScreenObject.GridData[i]["dcCalc" + FCol.DisplayMember].toString(), true, CurrencyID, ExchangeRate);
                            }
                        }
                    }
                }

                if (this.ScreenObject.FooterGridDataColumns.Contains("dcCurrID_Key")) {
                    if (Util.String(this.ScreenObject.FooterGridData[k]["dcCurrID_Key"]) == "-3") {
                        CurrencyID = FCol.CurrID;
                        ExchangeRate = FCol.ExhcgRt;
                    }
                    else if (Util.String(this.ScreenObject.FooterGridData[k]["dcCurrID_Key"]) == "-1" && this.Currency != null && !Util.IsEmpty(this.Currency.Currency.SelectedValue)) {
                        CurrencyID = parseInt(this.Currency.Currency.SelectedValue);
                        ExchangeRate = parseFloat(this.Currency.ExchangeRate.Text);
                    }
                    else if (Util.String(this.ScreenObject.FooterGridData[k]["dcCurrID_Key"]) != "") {
                        CurrencyID = parseInt(this.ScreenObject.FooterGridData[k]["dcCurrID_Key"].toString());
                        ExchangeRate = parseFloat(this.ScreenObject.FooterGridData[k]["dcExchRT"].toString());
                    }
                }
                if (CrACC > 0)
                    this.FillDt(JvDt, CrACC.toString(), IsCredRef, FooterVal.toString(), true, CurrencyID, ExchangeRate);
                if (DBAcc > 0)
                    this.FillDt(JvDt, DBAcc.toString(), IsDebRef, FooterVal.toString(), false, CurrencyID, ExchangeRate);
            }
        }

        if (this.POSPayModes != null && this.POSPayModes.GridData.length > 0) {
            let tempval;
            let dtpay = []//this.POSPayModes.GridData.Clone();
            let drrow;
            for (let k = 0; k < this.POSPayModes.GridData.length; k++) {
                if (Util.IsEmpty(this.POSPayModes.GridData[k]["ColumnName"]))
                    continue;

                if (this.POSPayModes.GridData[k]["Type"].toString() == "13")
                    this.POSPayModes.RedeemPoints = parseFloat(this.POSPayModes.GridData[k]["Amount"]);

                let drpayrows = dtpay.filter(x => x.ColumnName == this.POSPayModes.GridData[k]["ColumnName"]);
                if (drpayrows.length == 0) {
                    drrow = {};//dtpay.NewRow();
                    drrow["Name"] = this.POSPayModes.GridData[k]["Name"].toString();
                    drrow["ColumnName"] = this.POSPayModes.GridData[k]["ColumnName"].toString();
                    drrow["Amount"] = this.POSPayModes.GridData[k]["Amount"].toString();
                    drrow["Description"] = this.POSPayModes.GridData[k]["Description"].toString();
                    drrow["Details"] = this.POSPayModes.GridData[k]["Details"].toString();
                    drrow["Denomination"] = Util.StringValue(this.POSPayModes.GridData[k]["Denomination"]);
                    dtpay.push(drrow);
                }
                else {
                    drrow = drpayrows[0];
                    drrow["Amount"] = parseFloat(drrow["Amount"]) + parseFloat(this.POSPayModes.GridData[k]["Amount"]);
                    drrow["Details"] = drrow["Details"].toString() + this.POSPayModes.GridData[k]["Details"].toString();
                    drrow["Denomination"] = Util.StringValue(drrow["Denomination"]) + Util.StringValue(this.POSPayModes.GridData[k]["Denomination"]);
                }
            }
            if (!Util.IsEmpty(this.POSPayModes.Return) && Util.IsNum(this.POSPayModes.Return)
                && !Util.IsEmpty(this.POSPayModes.Returnfld)) {
                drrow = {};// dtpay.NewRow();
                drrow["Name"] = this.POSPayModes.ReturnLabel;
                drrow["ColumnName"] = this.POSPayModes.Returnfld;
                drrow["Amount"] = this.POSPayModes.Return.replace("-", "");
                this.POSpayXml = "<XML Amount=\"" + drrow["Amount"].toString() + "\" DBColumnName=\"" + this.POSPayModes.Returnfld + "\" ";
                this.POSpayXml += " RegisterID=\"" + this.ScreenObject.RegisterNodeID + "\" ";
                this.POSpayXml += " ShiftID=\"" + this.ScreenObject.ShiftNodeID + "\" ";
                this.POSpayXml += " DocDate=\"" + this.DocumentDate.ToString("dd/MMM/yyyy") + "\" ";
                this.POSpayXml += " Type=\"12\" />";
                drrow["Details"] = this.POSpayXml;
                dtpay.push(drrow);
                this.POSpayXml = "";
            }

            for (let k = 0; k < dtpay.length; k++) {
                let drsyscol = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == dtpay[k]["ColumnName"]);

                if (!DonotUpdateAccounts && (drsyscol[0]["PostingType"].toString() == "3" || drsyscol[0]["PostingType"].toString() == "4") && !Util.IsEmpty(dtpay[k]["Amount"]) && parseFloat(dtpay[k]["Amount"]) != 0) {
                    let DBAcc = 0, CrACC = 0; let IsCredRef = false, IsDebRef = false;

                    if (!Util.IsEmpty(drsyscol[0]["DrRefColID"])) {
                        DBAcc = parseInt(drsyscol[0]["DrRefColID"]);
                        IsDebRef = true;
                    }
                    else if (!Util.IsEmpty(drsyscol[0]["DebitAccount"]))
                        DBAcc = parseInt(drsyscol[0]["DebitAccount"]);
                    else if (this.ScreenObject.DebitAccount != null)
                        DBAcc = this.ScreenObject.DebitAccount.SelectedValue;

                    if (!Util.IsEmpty(drsyscol[0]["CrRefColID"])) {
                        CrACC = parseInt(drsyscol[0]["CrRefColID"]);
                        IsCredRef = true;
                    }
                    else if (!Util.IsEmpty(drsyscol[0]["CreditAccount"]))
                        CrACC = parseInt(drsyscol[0]["CreditAccount"]);

                    else if (this.ScreenObject.CreditAccount != null)
                        CrACC = this.ScreenObject.CreditAccount.SelectedValue;

                    if (CrACC > 0)
                        this.FillDt(JvDt, CrACC.toString(), IsCredRef, dtpay[k]["Amount"].toString(), true, CurrencyID, ExchangeRate);
                    if (DBAcc > 0)
                        this.FillDt(JvDt, DBAcc.toString(), IsDebRef, dtpay[k]["Amount"].toString(), false, CurrencyID, ExchangeRate);
                }
            }
        }

        let decimals = "2";
        if (BaseService.SessionManager.Preferences.ContainsKey("DecimalsinAmount"))
            decimals = BaseService.SessionManager.Preferences["DecimalsinAmount"];
        let lstRows: any[] = []
        let Accountids = "", ColIDs = "";
        for (let j = 0; j < JvDt.length; j++) {
            let dr = JvDt[j]
            if (parseFloat(dr["CRAmt"]) > 0 && parseFloat(dr["DBAmt"]) > 0) {
                if (parseFloat(dr["CRAmt"]) > parseFloat(dr["DBAmt"])) {
                    if (parseFloat((parseFloat(dr["CRAmt"]) - parseFloat(dr["DBAmt"])).ToString("N2")) == 0) {
                        lstRows.push(dr);
                        continue;
                    }
                    dr["CRAmt"] = parseFloat(dr["CRAmt"]) - parseFloat(dr["DBAmt"]);
                    dr["DBAmt"] = 0;
                }
                else if (parseFloat(dr["DBAmt"]) > parseFloat(dr["CRAmt"])) {
                    if (parseFloat((parseFloat(dr["DBAmt"]) - parseFloat(dr["CRAmt"])).ToString("N2")) == 0) {
                        lstRows.push(dr);
                        continue;
                    }
                    dr["DBAmt"] = parseFloat(dr["DBAmt"]) - parseFloat(dr["CRAmt"]);
                    dr["CRAmt"] = 0;
                }
                else if (parseFloat(dr["DBAmt"]) == parseFloat(dr["CRAmt"])) {
                    lstRows.push(dr);
                    continue;
                }
            }

            if (parseFloat(dr["CRAmt"]) > 0)
                dr["CRAmt"] = parseFloat(dr["CRAmt"]).ToString("N" + decimals);

            if (parseFloat(dr["DBAmt"]) > 0)
                dr["DBAmt"] = parseFloat(dr["DBAmt"]).ToString("N" + decimals);

            if (parseFloat(dr["DBAmt"]) == parseFloat(dr["CRAmt"])) {
                lstRows.push(dr);
                continue;
            }


            if (!Util.IsEmpty(dr["IsRef"]) && parseBoolean(dr["IsRef"])) {
                if (ColIDs != "")
                    ColIDs += ",";
                ColIDs += dr["AccountID_Key"].toString();
            }
            else {
                if (Accountids != "")
                    Accountids += ",";
                Accountids += dr["AccountID_Key"].toString();
            }
        }
        if (Accountids == "")
            Accountids = "0";
        let ds = this.ScreenObject.GetNames(Accountids, ColIDs);
        if (ds != null && ds.Tables.length > 0 && !ds.Columns[0].Contains("ErrorMessage")) {
            let Drr;
            JvDt.forEach(dr => {
                if (parseBoolean(dr["IsRef"]) && ds.Tables.length > 1) {
                    Drr = ds.Tables[1].filter(x => x.CostCenterColID == dr["AccountID_Key"]);
                    if (Drr.length > 0) {
                        dr["AccountID"] = Drr[0][Object.keys(Drr[0])[1]].toString();
                        dr["AccountCode"] = Drr[0][Object.keys(Drr[0])[1]].toString();
                    }
                }
                else {
                    Drr = ds.Tables[0].filter(x => x.AccountId == dr["AccountID_Key"]);

                    if (Drr.length > 0) {
                        dr["AccountID"] = Drr[0][Object.keys(Drr[0])[1]].toString();
                        dr["AccountCode"] = Drr[0][Object.keys(Drr[0])[2]].toString();
                    }
                }
            });
        }
        lstRows.forEach(dr => {
            JvDt.Remove(dr);
        });
        let objJV = new ShowJVViewModel();
        objJV.ShowJVViewModel_3(JvDt)
        BaseService.page.ShowDialog(objJV, ShowJVComponent, { ShowCenter: true, Title: objJV.Title });
    }

    IsDocAttachment = false;
    dtLoanGuarantees: any[] = null; dtVacDefineDays: any[] = null; dtShiftAssRot: any[] = null; dtVacContract: any[] = null; dtVacContractColumns: any = [];
    isCheckIn = false; isCheckOut = false; isDAValidate = false;

    public PrevCustWhere = new Dictionary<any>();

    // Name : onButtonClick
    // Desc : this method fire when any button click event, ex:- New, Post, Delete, Print, Post&Print etc.
    // Category : COMMON
    async onButtonClick(sender: any) {
        ;
        this.isCheckIn = this.isCheckOut = false;
        if (this.ScreenObject.GridDataObj.angularGrid?.slickGrid && this.ScreenObject.GridDataObj.angularGrid?.slickGrid.getActiveCellNode()) {
            let _ActiveCell = this.ScreenObject.GridDataObj.angularGrid.slickGrid.getActiveCell();
            if (_ActiveCell && _ActiveCell.cell === 0 && _ActiveCell.row === 0) { }
            else {
                /*  here Below code commented for it destroying Components Data because we are initializing new editor for Cell 
                 * this.ScreenObject.GridDataObj.angularGrid.slickGrid.gotoCell(0, 0) */
            }
            this.ScreenObject.GridDataObj.angularGrid.slickGrid.getEditorLock().commitCurrentEdit();
        }

        this.ButtonsPopUp = false;
        if (sender instanceof PactListBoxData || sender instanceof PactCodeNameListBoxData) {
            let lst: PactListBoxData = null;
            if (sender instanceof PactListBoxData)
                lst = sender as PactListBoxData;
            else if (sender instanceof PactCodeNameListBoxData) {
                lst = sender.Name;
                lst.Label = sender.Label;
            }
            let prevVal: number = lst.SelectedValue;
            let lstObj = new PactListBoxData();
            lstObj.CCID = lst.CCID;
            lstObj.TypeID = lst.TypeID;
            lstObj.CustomWhere = lst.CustomWhere;
            lst.IsReadOnly = false;
            let Plsvlist: any = new PactListSearchViewModel(lst);


            if (!Util.IsEmpty(Plsvlist.CustomWhere)) {
                if (!this.PrevCustWhere.ContainsKey(Plsvlist.CCID)) {
                    this.PrevCustWhere.push(Plsvlist.CCID, Plsvlist.CustomWhere);
                }
            }
            if (this.PrevCustWhere.ContainsKey(Plsvlist.CCID) && !Util.IsEmpty(this.PrevCustWhere[Plsvlist.CCID]) && Util.IsEmpty(lst.CustomWhere)) {
                lst.CustomWhere = this.PrevCustWhere[Plsvlist.CCID];
            }
            //Plsvlist.Title = sender.Label;
            //BaseService.page.ShowDialog(Plsvlist, PactListSearchComponent, { ShowCenter: true });
            BaseService.page.ShowDialog(Plsvlist, PactListSearchComponent, { ShowCenter: true }).subscribe(() => {
                if (prevVal != Plsvlist.ToSearch.SelectedValue) {
                    this.ScreenObject.OnGetReference(Plsvlist);
                }
                return;
            });
            // BaseService.page.ShowDialog(new PactListSearchViewModel(lst), PactListBoxComponent);
            return;
        }

        let btn: PactButtonData;
        if (sender.toString() == "CancelDialog") {
            BaseService.page.HideDialog(this.PopUpGUID);
        }
        else if (sender.toString() == "Cancel") {
            this.SetVisibiltiFalse();
            if (this.IsPOs)
                this.ProductSearchVisibility = true;
            else
                this.SetDefaultRightPanel();
        }
        else {
            this.Unit_keyOnBeginEditValue = "";
            this.Unit_keyOnBeginEditText = "";
            if (sender.toString().startsWith("Documents ")) {
                sender = sender.toString().replace("Documents ", "");
                this.OnDocLinkClick(sender);
                return;
            }
            else if (sender.toString().startsWith("Reports ")) {
                sender = sender.toString().replace("Reports ", "");
                this.OnReportsLinkClick(sender);
                return;
            }

            if (this.DocumentType == 85) //Bulk Appraisal
            {
                if (BaseService.SessionManager.Preferences.ContainsKey("ConsiderGradeWiseSalarySlabs") && BaseService.SessionManager.Preferences["ConsiderGradeWiseSalarySlabs"] == "True") {
                    if (sender.toString() == "PickMin" || sender.toString() == "PickMax") {
                        let iEmpSeqNo = 0;
                        let fld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51"); //Employee
                        if (fld != undefined && fld != null) {
                            if (fld instanceof PactCodeNameListBoxData) {
                                if (fld.SelectedValue == 0) {
                                    this.DisplayMessage = "Select Employee First, and Employee should be in Header";
                                    this.MessageVisibility = true;
                                    return;
                                }
                            }
                            iEmpSeqNo = fld.SelectedValue;
                        }

                        if (iEmpSeqNo > 0) {
                            this.ScreenObject.GridDataObj.Clear();
                            this.FillComponentsBasedOnGradeSlabs(iEmpSeqNo, sender.toString());
                        }
                    }
                }
            }

            if (this.DocumentType == 68 && sender.toString() == "Save") //Recording of Data
            {
                let dtFPM = new Date(), dtTPM = new Date();
                let fld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2"); //From Payroll Month
                dtFPM = fld.Date;

                fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4"); //To Payroll Month
                dtTPM = fld.Date;

                if (dtFPM > dtTPM) {
                    this.DisplayMessage = "'From Payroll Month' should be less than or equal to 'To Payroll Month'";
                    this.MessageVisibility = true;
                    return;
                }

            }

            this.attendancePunchInfo = ''
            const { DocOptionsComponent } = await import('../doc-options/doc-options.component')
            const { DocOptionsViewModel } = await import('../doc-options/DocOptionsViewModel')

            let objcolumn: any;
            let temp: any;
            let aa: any;
            switch (sender.toString()) {
                case "next":
                    this.GetData("Next");
                    break;
                case "prev":
                    this.GetData("Previous");
                    break;
                case "ReleaseJob":
                    this.ReleaseJob();
                    break;
                case "LineDisc":

                    let Dovm1 = new DocOptionsViewModel(this, 3);
                    BaseService.page.ShowDialog(Dovm1, DocOptionsComponent, { ShowCenter: true, NoWidth: true });

                    //ShellWindowViewModel.Instance().PopViewModel = new DocOptionsViewModel(this, 3);
                    break;
                case "Disc":
                    let Dovm4 = new DocOptionsViewModel(this, 4);
                    BaseService.page.ShowDialog(Dovm4, DocOptionsComponent, { ShowCenter: true, NoWidth: true });
                    //ShellWindowViewModel.Instance().PopViewModel = new DocOptionsViewModel(this, 4);
                    break;
                case "SearchPrice":
                    BaseService.page.ShowDialog(new DynamicSetViewModel(this, null, null, 5), DynamicSetComponent);
                    break;
                case "BluetoothPrint":
                    this.StartBluetoothPrint(this.DocID);
                    break;
                case "Load":
                    {
                        this.LoadDailyAttendanceDocuments();
                    }
                    break;
                case "Check-in":
                    {
                        this.DisplayMessage = 'Saving'
                        if (Util.IsEmpty(BaseService.SessionManager.ESS_Timezone)) {
                            alert('Please select Employee TimeZone!');
                            this.DisplayMessage = 'Please select Employee TimeZone!'
                            return
                        }
                        this.attendancePunchInfo = " IOType=\"" + 'CheckIn' + "\" TZ=\"" + BaseService.SessionManager.ESS_Timezone + "\" ";

                        let objResEmpAccess = { Flag: "", Msg: "" };
                        let coordinates: any;
                        this.isCheckIn = true;
                        console.log("BaseService.SessionManager.EnableGOLOC =>", BaseService.SessionManager.EnableGOLOC);
                        if (BaseService.SessionManager.EnableGOLOC == "Yes") {
                            try {
                                coordinates = await Geolocation.getCurrentPosition();
                            } catch (error) {
                                this.DisplayMessage = error.message
                            }
                            if (Util.IsEmpty(coordinates)) {
                                this.DisplayMessage = 'No Location Found!'
                                return
                            }
                        }
                        if (this.DocumentType == 89 || this.DocumentType == 90) {
                            let sDate = "", sTime = "";
                            let fld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha26"); //Date
                            if (fld) {
                                if (!(fld as PactExtraFieldDateData).Date) {
                                    this.DisplayMessage = "Select Date then Check-in";
                                    return;
                                }
                            }
                            if (BaseService.IsMac) {
                                sDate = (fld as PactExtraFieldDateData).Date.ToString("dd-MMM-yyyy");
                            } else {
                                sDate = (fld as PactExtraFieldDateData).Date.ToString("dd/MMM/yyyy");
                            }


                            if (Util.ParseDate(sDate).Date() > Date.Today()) {
                                this.DisplayMessage = "Can not allow future dates";
                                return;
                            }

                            fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha27") as PactDateTimeData; //Time
                            if (fld) {
                                if (!fld.Date) {
                                    this.DisplayMessage = "Select Time then Check-in";
                                    return;
                                }
                            }
                            sTime = fld.Date.ToString("HH:mm");

                            let iR = -1;
                            if (this.DocumentType == 89)
                                iR = 0;
                            else {
                                if (this.ScreenObject.SelectedGridRowIndex >= 0) {
                                    if (!confirm("Are you sure want to update the selected row.?"))
                                        return;
                                    iR = this.ScreenObject.SelectedGridRowIndex;
                                }
                                else {
                                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                                        if (Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha1_Key"]) && Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha3_Key"])) {
                                            iR = i;
                                            break;
                                        }
                                    }
                                }
                            }

                            let colName = "ProductID_Key";
                            let prodcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == colName.toLowerCase());
                            let tlong;
                            if (prodcol && colName && !Util.IsEmpty(prodcol.DefaultValue) && prodcol.DefaultValueText != null && (Util.Int(prodcol.DefaultValue) > 0 || Util.Int(prodcol.DefaultValue) == -100))
                                this.ScreenObject.GridData[iR]["ProductID_Key"] = prodcol.DefaultValue;

                            this.ScreenObject.GridData[iR]["Type"] = 1;
                            this.ScreenObject.GridData[iR]["dcAlpha1"] = Util.ParseDate(sDate).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            this.ScreenObject.GridData[iR]["dcAlpha1_Key"] = Util.ParseDate(sDate);

                            this.ScreenObject.GridData[iR]["dcAlpha2"] = sTime;
                            this.ScreenObject.GridData[iR]["dcAlpha2_Key"] = Util.ParseDate(sDate + " " + sTime);

                            this.ScreenObject.GridData[iR]["dcAlpha14"] = Util.CurrentTimeZoneName();

                            if (Util.IsEmpty(this.ScreenObject.GridData[iR]["dcAlpha8"]))
                                this.ScreenObject.GridData[iR]["dcAlpha8"] = this.IsMobile ? "Mobile" : "Web";

                            //UTC Date and Time

                            let dtU = BaseService.common.GetDataSet("PAY042", "").Tables[0];

                            this.ScreenObject.GridData[iR]["dcAlpha28"] = Util.ParseDate(dtU[0]["UTCDateTime"]).ToLocalTime().ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            this.ScreenObject.GridData[iR]["dcAlpha28_Key"] = Util.ParseDate(dtU[0]["UTCDateTime"]).ToLocalTime();

                            this.ScreenObject.GridData[iR]["dcAlpha29"] = Util.ParseDate(dtU[0]["UTCDateTime"]).ToLocalTime().ToString("HH:mm");
                            this.ScreenObject.GridData[iR]["dcAlpha29_Key"] = Util.ParseDate(dtU[0]["UTCDateTime"]).ToLocalTime();
                            this.ScreenObject.GridDataObj.updateRow(this.ScreenObject.GridData[iR]);
                            this.Celleditend(this.ScreenObject.GridData[iR], "dcAlpha1", 0);

                            if (BaseService.SessionManager.EnableGOLOC.toLowerCase() == "no") {
                                this.SaveInventoryDocument("Save", true);
                                return;
                            }
                            else {
                                console.log("coordinates.coords.latitude (Check In)" + coordinates.coords.latitude);
                                console.log("coordinates.coords.longitude (Check In)" + coordinates.coords.longitude);
                            }
                            console.log("EmpAccessibility In ");
                            try {
                                let blnEmpAccess: any = this.EmpAccessibility(BaseService.SessionManager.iEmployee, coordinates.coords.latitude, coordinates.coords.longitude, objResEmpAccess);
                            } catch (error) {
                                console.log("Check in Exception:EmpAccessibility" + error);
                            }
                            console.log("EmpAccessibility out ");
                            if (objResEmpAccess.Flag != "200") {
                                this.DisplayMessage = objResEmpAccess.Msg;
                                alert(objResEmpAccess.Msg);
                                return;
                            }

                            if (objResEmpAccess.Flag == "200") {
                                if (BaseService.IsNativeMobile) {

                                    let locationobj: any = await Util.UserCurrentLocation();
                                    console.log('Response GetUsersCurrentAddress Response Obj = ' + locationobj);
                                    console.log('Response locationobj.coords.latitude = ' + locationobj.coords.latitude);
                                    if (!Util.IsEmpty(locationobj)) {
                                        // let arr = locationobj.split(',');
                                        this.ScreenObject.GridData[iR]["dcAlpha6"] = locationobj.coords.latitude;
                                        this.ScreenObject.GridData[iR]["dcAlpha7"] = locationobj.coords.longitude;

                                        if (locationobj.address != undefined) {
                                            this.ScreenObject.GridData[iR]["dcAlpha10"] = locationobj.address.Address1;
                                            this.ScreenObject.GridData[iR]["dcAlpha11"] = locationobj.address.Address2;
                                            this.ScreenObject.GridData[iR]["dcAlpha12"] = locationobj.address.City;
                                            this.ScreenObject.GridData[iR]["dcAlpha13"] = locationobj.address.State;
                                            this.ScreenObject.GridData[iR]["dcAlpha14"] = locationobj.address.Country;
                                            this.ScreenObject.GridData[iR]["dcAlpha15"] = locationobj.address.PinCode;
                                        }
                                    }
                                } else {

                                    let locationobj: any = await Util.GetUsersCurrentAddress(coordinates);
                                    console.log('GetUsersCurrentAddress Response Address = ' + locationobj.results[0].formatted);
                                    if (!Util.IsEmpty(locationobj)) {
                                        this.ScreenObject.GridData[iR]["dcAlpha6"] = coordinates.coords.latitude;
                                        this.ScreenObject.GridData[iR]["dcAlpha7"] = coordinates.coords.longitude;
                                        if (!Util.IsEmpty(locationobj.status) && locationobj.status.code == 200) {
                                            this.ScreenObject.GridData[iR]["dcAlpha10"] = locationobj.results[0].formatted;
                                            this.ScreenObject.GridData[iR]["dcAlpha11"] = locationobj.results[0].formatted;
                                            this.ScreenObject.GridData[iR]["dcAlpha12"] = locationobj.results[0].components.city;
                                            this.ScreenObject.GridData[iR]["dcAlpha13"] = locationobj.results[0].components.state
                                            this.ScreenObject.GridData[iR]["dcAlpha14"] = locationobj.results[0].components.country;
                                            this.ScreenObject.GridData[iR]["dcAlpha15"] = locationobj.results[0].components.postcode;

                                        }
                                    }
                                    else
                                        console.log("location not detected")

                                }
                            }
                        }
                        if (objResEmpAccess.Flag == "200") {
                            this.SaveInventoryDocument("Save", true);
                            console.log("this.SaveInventoryDocument('Save', true); ");
                        }
                        break;
                    }
                case "Check-out":
                    {
                        this.DisplayMessage = 'Saving'
                        if (Util.IsEmpty(BaseService.SessionManager.ESS_Timezone)) {
                            alert('Please select Employee TimeZone!');
                            this.DisplayMessage = 'Please select Employee TimeZone!'
                            return
                        }
                        this.attendancePunchInfo = " IOType=\"" + 'CheckOut' + "\" TZ=\"" + BaseService.SessionManager.ESS_Timezone + "\" ";

                        this.isCheckOut = true;
                        let objResEmpAccess = { Flag: "", Msg: "" };
                        let coordinates: any;
                        console.log("BaseService.SessionManager.EnableGOLOC =>", BaseService.SessionManager.EnableGOLOC);
                        if (BaseService.SessionManager.EnableGOLOC == "Yes") {
                            try {
                                coordinates = await Geolocation.getCurrentPosition();
                            } catch (error) {
                                this.DisplayMessage = error
                            }
                            if (Util.IsEmpty(coordinates)) {
                                this.DisplayMessage = 'No Location Found!'
                                return
                            }
                        }

                        if (this.DocumentType == 89 || this.DocumentType == 90) {
                            let sDate = "", sTime = "";
                            let fld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha26"); //Date
                            if (fld) {
                                if (!(fld as PactExtraFieldDateData).Date) {
                                    this.DisplayMessage = "Select Date then Check-out";
                                    return;
                                }
                            }
                            if (BaseService.IsMac) {
                                sDate = (fld as PactExtraFieldDateData).Date.ToString("dd-MMM-yyyy");
                            } else {
                                sDate = (fld as PactExtraFieldDateData).Date.ToString("dd/MMM/yyyy");
                            }

                            if (Util.ParseDate(sDate).Date() > Date.Today()) {
                                this.DisplayMessage = "Can not allow future dates";
                                return;
                            }

                            fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha27") as PactDateTimeData; //Time
                            if (fld) {
                                if (!fld.Date) {
                                    this.DisplayMessage = "Select Time then Check-out";
                                    return;
                                }
                            }
                            sTime = fld.Date.ToString("HH:mm");

                            let iR = -1;
                            if (this.DocumentType == 89)
                                iR = 0;
                            else {
                                if (this.ScreenObject.SelectedGridRowIndex >= 0) {
                                    if (!confirm("Are you sure want to update the selected row.?"))
                                        return;

                                    if (Util.IsEmpty(this.ScreenObject.GridData[this.ScreenObject.SelectedGridRowIndex]["dcAlpha1_Key"])) {
                                        this.DisplayMessage = "Enter Check-in Date and Time first for the selected row.";
                                        return;
                                    }
                                    iR = this.ScreenObject.SelectedGridRowIndex;
                                }
                                else {
                                    for (let i = this.ScreenObject.GridData.length - 1; i >= 0; i--) {
                                        if (Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha1_Key"]) && Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha3_Key"])) {
                                        }
                                        else {
                                            if (Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha3_Key"])) {
                                                iR = i;
                                            }
                                            else {
                                                iR = i + 1;
                                            }
                                            break;
                                        }
                                    }
                                }
                            }

                            let colName = "ProductID_Key";
                            let prodcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == colName.toLowerCase());
                            if (prodcol && colName && !Util.IsEmpty(prodcol.DefaultValue) && !Util.IsEmpty(prodcol.DefaultValueText) && (Util.Int(prodcol.DefaultValue) > 0 || Util.Int(prodcol.DefaultValue) == -100))
                                this.ScreenObject.GridData[iR]["ProductID_Key"] = prodcol.DefaultValue;

                            this.ScreenObject.GridData[iR]["Type"] = 1;
                            this.ScreenObject.GridData[iR]["dcAlpha3"] = Util.ParseDate(sDate).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            this.ScreenObject.GridData[iR]["dcAlpha3_Key"] = Util.ParseDate(sDate);

                            this.ScreenObject.GridData[iR]["dcAlpha4"] = Util.ParseDate(sDate + " " + sTime).ToString("HH:mm");
                            this.ScreenObject.GridData[iR]["dcAlpha4_Key"] = Util.ParseDate(sDate + " " + sTime);

                            this.ScreenObject.GridData[iR]["dcAlpha24"] = Util.CurrentTimeZoneName();

                            if (this.ScreenObject.GridData[iR]["dcAlpha18"] == null || this.ScreenObject.GridData[iR]["dcAlpha18"] == null || Util.IsEmpty(this.ScreenObject.GridData[iR]["dcAlpha18"]))
                                this.ScreenObject.GridData[iR]["dcAlpha18"] = this.IsMobile ? "Mobile" : "Web";

                            //UTC Date and Time

                            let dtU = BaseService.common.GetDataSet("PAY042", "").Tables[0];

                            this.ScreenObject.GridData[iR]["dcAlpha30"] = Util.ParseDate(dtU[0]["UTCDateTime"]).ToLocalTime().ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            this.ScreenObject.GridData[iR]["dcAlpha30_Key"] = Util.ParseDate(dtU[0]["UTCDateTime"]).ToLocalTime();

                            this.ScreenObject.GridData[iR]["dcAlpha31"] = Util.ParseDate(dtU[0]["UTCDateTime"]).ToLocalTime().ToString("HH:mm");
                            this.ScreenObject.GridData[iR]["dcAlpha31_Key"] = Util.ParseDate(dtU[0]["UTCDateTime"]).ToLocalTime();

                            this.ScreenObject.GridDataObj.updateRow(this.ScreenObject.GridData[iR]);
                            this.Celleditend(this.ScreenObject.GridData[iR], "dcAlpha3", 0);

                            if (BaseService.SessionManager.EnableGOLOC.toLowerCase() == "no") {
                                this.SaveInventoryDocument("Save", true);
                                return;
                            }
                            else {
                                console.log("coordinates.coords.latitude (Check In)" + coordinates.coords.latitude);
                                console.log("coordinates.coords.longitude (Check In)" + coordinates.coords.longitude);
                            }
                            console.log("EmpAccessibility In ")
                            try {
                                let blnEmpAccess: any = this.EmpAccessibility(BaseService.SessionManager.iEmployee, coordinates.coords.latitude, coordinates.coords.longitude, objResEmpAccess);
                            } catch (error) {
                                console.log("Check Out Exception:EmpAccessibility" + error);
                            }

                            console.log("EmpAccessibility out ")
                            if (objResEmpAccess.Flag != "200") {
                                this.DisplayMessage = objResEmpAccess.Msg;
                                alert(objResEmpAccess.Msg);
                                return;
                            }
                            if (objResEmpAccess.Flag == "200") {
                                if (BaseService.IsNativeMobile) {

                                    let locationobj: any = await Util.UserCurrentLocation();
                                    console.log('Response GetUsersCurrentAddress Response Obj = ' + locationobj);
                                    console.log('Response locationobj.coords.latitude = ' + locationobj.coords.latitude);
                                    if (!Util.IsEmpty(locationobj)) {
                                        this.ScreenObject.GridData[iR]["dcAlpha16"] = locationobj.coords.latitude;
                                        this.ScreenObject.GridData[iR]["dcAlpha17"] = locationobj.coords.longitude;
                                        if (locationobj.address != undefined) {
                                            this.ScreenObject.GridData[iR]["dcAlpha20"] = locationobj.address.Address1;
                                            this.ScreenObject.GridData[iR]["dcAlpha21"] = locationobj.address.Address2;
                                            this.ScreenObject.GridData[iR]["dcAlpha22"] = locationobj.address.City;
                                            this.ScreenObject.GridData[iR]["dcAlpha23"] = locationobj.address.State;
                                            this.ScreenObject.GridData[iR]["dcAlpha24"] = locationobj.address.Country;
                                            this.ScreenObject.GridData[iR]["dcAlpha25"] = locationobj.address.PinCode;
                                        }
                                    }
                                } else {
                                    let locationobj: any = await Util.GetUsersCurrentAddress(coordinates);
                                    console.log('GetUsersCurrentAddress Response Address = ' + locationobj.results[0].formatted);
                                    if (!Util.IsEmpty(locationobj)) {
                                        this.ScreenObject.GridData[iR]["dcAlpha6"] = coordinates.coords.latitude;
                                        this.ScreenObject.GridData[iR]["dcAlpha7"] = coordinates.coords.longitude;
                                        if (!Util.IsEmpty(locationobj.status) && locationobj.status.code == 200) {

                                            this.ScreenObject.GridData[iR]["dcAlpha10"] = locationobj.results[0].formatted;
                                            this.ScreenObject.GridData[iR]["dcAlpha11"] = locationobj.results[0].formatted;
                                            this.ScreenObject.GridData[iR]["dcAlpha12"] = locationobj.results[0].components.city;
                                            this.ScreenObject.GridData[iR]["dcAlpha13"] = locationobj.results[0].components.state
                                            this.ScreenObject.GridData[iR]["dcAlpha14"] = locationobj.results[0].components.country;
                                            this.ScreenObject.GridData[iR]["dcAlpha15"] = locationobj.results[0].components.postcode;

                                        }
                                    }
                                    else
                                        console.log("location Address not detected");
                                }
                            }

                        }

                        if (objResEmpAccess.Flag == "200") {
                            console.log("SaveInventoryDocument");
                            this.SaveInventoryDocument("Save", true);
                        }
                        break;
                    }
                case "New":
                    if (this.ConfirmDirtyRead()) {
                        if ((BaseService.SessionManager.Preferences.ContainsKey("ConfirmonNewDocument") && BaseService.SessionManager.Preferences["ConfirmonNewDocument"].toUpperCase() == "TRUE") ||
                            (this.ScreenObject.Preferences.ContainsKey("ConfirmonNewDocument") && this.ScreenObject.Preferences["ConfirmonNewDocument"].toUpperCase() == "TRUE")) {
                            this.res = "No";
                            if (!confirm("Do you want New Document?"))
                                return;
                        }
                        if (this.ScreenObject.DocID == 0 && !this.CanInsertDeleteRow())
                            return;
                        let ref_Ddate = { value: this._Ddate }
                        this.ScreenObject.OnDocPrefixChanged(this.ScreenObject.Prefix, 0, 0, ref_Ddate, false);
                        this._Ddate = ref_Ddate.value
                        this.clear(1);
                        this.ScreenObject.GridDataObj.UpdateFooter();
                        const { POSDocumentViewModel } = await import('../../pos/pos-screen/POSDocumentViewModel');
                        if (this instanceof POSDocumentViewModel) {
                            if (BaseService.SessionManager.Preferences.ContainsKey("DisableAutoLoad") && BaseService.SessionManager.Preferences["DisableAutoLoad"].toLowerCase() == "true")
                                this.ScreenObject.FillListViews(false);
                            this.FillUserWiseDimensions();
                        }
                        if (this.DocumentType == 15) // Batch Payment Report.
                            this.BatchPayment();
                    }
                    break;
                case "Renew":
                    try {
                        this._Ddate = Date.Today();
                        let HoldDocID = this.DocID;
                        let dtStart: Date = null, dtEnd = null;
                        let TDays: string = "";
                        let StartDt = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                        if (StartDt != null && StartDt instanceof PactExtraFieldDateData && StartDt.Date.ToString() != "")
                            dtStart = StartDt.Date;
                        let EndDt = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                        if (EndDt != null && EndDt instanceof PactExtraFieldDateData && EndDt.Date.ToString() != "")
                            dtEnd = EndDt.Date;
                        if (dtStart == null || dtEnd == null) {
                            this.DisplayMessage = "Please Enter start Date and End Date";
                            return;
                        }
                        if (EndDt instanceof PactExtraFieldDateData && EndDt.Date)
                            TDays = (EndDt.Date.Subtract((StartDt as PactExtraFieldDateData).Date).Days).toString() + 1;
                        else
                            TDays = ((EndDt as PactExtraFieldDateData).Date.Subtract(Date.Today())).Days.toString() + 1;

                        if (Util.IsLeapYear((EndDt as PactExtraFieldDateData).Date.getFullYear())) {
                            let dt: Date = new Date((EndDt as PactExtraFieldDateData).Date.getFullYear(), 2, 29);
                            if (dt > (StartDt as PactExtraFieldDateData).Date && dt < (EndDt as PactExtraFieldDateData).Date)
                                TDays = (parseInt(TDays) - 1).toString();
                        }
                        else if (Util.IsLeapYear((StartDt as PactExtraFieldDateData).Date.getFullYear())) {
                            let dt: Date = new Date((StartDt as PactExtraFieldDateData).Date.getFullYear(), 2, 29);
                            if (dt > (StartDt as PactExtraFieldDateData).Date && dt < (StartDt as PactExtraFieldDateData).Date)
                                TDays = (parseInt(TDays) - 1).toString();
                        }
                        this.CheckDateInDocNumber(false);
                        let ref_Ddate1 = { value: this._Ddate }
                        //this.OnPropertyChanged("DocumentDate");
                        this.ScreenObject.OnDocPrefixChanged(this.ScreenObject.Prefix, 0, 0, ref_Ddate1, false);
                        this.clear(5);
                        // ScreenObject.LoadEditData(dsRenew, true);
                        this.LinkDoc(this.CostCenterID, HoldDocID);
                        let DimCCID = 0;

                        if (this.ScreenObject.Preferences.ContainsKey("DimensionStatusOnRenew") && Util.DoubleTryParse(this.ScreenObject.Preferences["DimensionStatusOnRenew"]) > 0) {
                            var frmfld = this.ScreenObject._CCFields.find(x => (x as PactListBoxData).CCID == DimCCID);
                            if (frmfld instanceof PactListBoxData && (frmfld as PactListBoxData).CCID == DimCCID && frmfld != null && frmfld instanceof PactListBoxData) {
                                if (this.ScreenObject.Preferences.ContainsKey("CurrentDocStatusOnRenew") && this.ScreenObject.Preferences["CurrentDocStatusOnRenew"] != "" && this.ScreenObject.Preferences["CurrentDocStatusOnRenew"] != "0") {
                                    frmfld.SelectedValue = parseInt(this.ScreenObject.Preferences["CurrentDocStatusOnRenew"]);
                                }
                            }
                        }
                        var Start = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                        var End = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                        if (Start != null && Start instanceof PactExtraFieldDateData && End != null && End instanceof PactExtraFieldDateData) {
                            if (dtEnd != null)
                                Start.Date = dtEnd.AddDays(1);

                            if (TDays != "" && Start.Date)
                                End.Date = Start.Date.AddDays(parseInt(TDays) - 1);
                        }
                        this.WfID = 0;
                        this.WorkFlowDocLevel = 0;
                        this.WFDocLevelList.Clear();
                        this.StatusID = 0;
                        this.CalculateTotals(null, false);
                        this.RefreshGrid = true;
                    }
                    catch {
                        this.DisplayMessage = "Problem in processing your request ,please contact administrator";
                        this.MessageVisibility = true;
                        return;
                    }
                    finally {
                    }
                    break;
                case "Duplicate":
                    let dsCopy = this.ScreenObject.GetEditDataCopy(this.ScreenObject.Prefix, this.ScreenObject.DocPrefix.TextBox.Text, this.CostCenterID.toString());
                    this._Ddate = new Date().Date();
                    this.CheckDateInDocNumber(false);
                    let ref_Ddate1 = { value: this._Ddate }
                    this.ScreenObject.OnDocPrefixChanged(this.ScreenObject.Prefix, 0, 0, ref_Ddate1, false);
                    this._Ddate = ref_Ddate1.value
                    this.clear(5);
                    this.ScreenObject.LoadEditData(dsCopy, true);

                    if (this.ViewAttachments != null && dsCopy.Tables.length > 8) {
                        /***dsCopy.Tables[8].Columns["FileID"].Expression = "0";***/
                        this.ViewAttachments.LoadAttachments(dsCopy.Tables[8]);
                    }

                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        if (this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                            if (this.ScreenObject.GridDataColumns.Contains("LinkedInvDocDetailsID"))
                                this.ScreenObject.GridData[i]["LinkedInvDocDetailsID"] = null;
                            if (this.ScreenObject.GridDataColumns.Contains("LinkedFieldName"))
                                this.ScreenObject.GridData[i]["LinkedFieldName"] = null;
                            if (this.ScreenObject.GridDataColumns.Contains("RefNo"))
                                this.ScreenObject.GridData[i]["RefNo"] = null;
                        }
                    }
                    this.WfID = 0;
                    this.WorkFlowDocLevel = 0;
                    this.WFDocLevelList.Clear();
                    this.StatusID = 0;
                    this.CalculateTotals(null, false);
                    this.RefreshGrid = true;
                    break;
                case "ReverseJV":
                    let dsJVCopy = this.ScreenObject.GetEditDataCopy(this.ScreenObject.Prefix, this.ScreenObject.DocPrefix.TextBox.Text, this.CostCenterID.toString());
                    this._Ddate = new Date().Date();
                    let DrAmt: number = 0;
                    let CrAmt: number = 0;
                    this.CheckDateInDocNumber(false);
                    let ref_Ddate2 = { value: this._Ddate }
                    this.ScreenObject.OnDocPrefixChanged(this.ScreenObject.Prefix, 0, 0, ref_Ddate2, false);
                    this._Ddate = ref_Ddate2.value
                    this.clear(5);
                    this.ScreenObject.LoadEditData(dsJVCopy, true);

                    if (this.ViewAttachments != null && dsJVCopy.Tables.length > 8) {
                        /***dsCopy.Tables[8].Columns["FileID"].Expression = "0";***/
                        this.ViewAttachments.LoadAttachments(dsJVCopy.Tables[8]);
                    }

                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        DrAmt = 0;
                        CrAmt = 0;
                        if (!this.IsInventoryVoucher && this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"])) {
                            if (this.ScreenObject.GridDataColumns.Contains("CreditAmount") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAmount"]))
                                CrAmt = parseFloat(this.ScreenObject.GridData[i]["CreditAmount"]);
                            if (this.ScreenObject.GridDataColumns.Contains("DebitAmount") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAmount"]))
                                DrAmt = parseFloat(this.ScreenObject.GridData[i]["DebitAmount"]);

                            if (this.ScreenObject.GridDataColumns.Contains("CreditAmount"))
                                this.ScreenObject.GridData[i]["CreditAmount"] = DrAmt;
                            if (this.ScreenObject.GridDataColumns.Contains("DebitAmount"))
                                this.ScreenObject.GridData[i]["DebitAmount"] = CrAmt;
                        }
                    }
                    this.WfID = 0;
                    this.WorkFlowDocLevel = 0;
                    this.WFDocLevelList.Clear();
                    this.StatusID = 0;
                    this.CalculateTotals(null, false);
                    this.RefreshGrid = true;
                    break;      
                case "Redeposit":
                    if (this.ScreenObject.Preferences.ContainsKey("ReDepositDocuments") && !Util.IsEmpty(this.ScreenObject.Preferences["ReDepositDocuments"])) {
                        let strQuery = this.ScreenObject.Preferences["ReDepositDocuments"].toString() + "," + this.CostCenterID;
                        let dtdocs = BaseService.common.GetDataTable("ADED001", strQuery);
                        if (dtdocs.length > 0) {
                            let drtolink = dtdocs;
                            let gt = new GoToLineViewModel();
                            gt.GoToLineViewModel_3(this, drtolink, 6);
                            BaseService.page.ShowDialog(gt, GoToLineComponent, { ShowCenter: true, NoWidth: true });
                        }
                    }
                    else
                        this.Redeposit();
                    break;/**
                case "Innoviti":
                    if (File.Exists("innovEFT.dll"))
                    {
                        let fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha25");
                        let tempdbl;
                        string CardAmt = "";
                        if (fld && fld instanceof PactTextBoxData && !Util.IsEmpty(fld.Text) && Util.Double(fld.Text, out tempdbl))
                            CardAmt = (parseFloat(tempdbl.ToString("N2")) * 100).ToString("N0").Replace(",", "");

                        if (CardAmt != "")
                        {
                            ShellWindowViewModel.Instance().PopViewModel = new AddTypeofServiceViewModel(CardAmt);
                        }
                    }
                    else
                    {
                        DisplayMessage = "Dll Not found";
                        
                    }
                    break;***/
                case "QtyAdjustment":
                    if (!this.ScreenObject.GridDataColumns.Contains("QtyXML")) {
                        this.ScreenObject.GridDataColumns.push("QtyType");
                        this.ScreenObject.GridDataColumns.push("QtyXML");
                    }
                    this.Setselectedrow(0);
                    BaseService.page.ShowDialog(new FieldCalculatorViewModel(this, 1), FieldCalculatorComponent, { ShowCenter: true });
                    break;
                case "Print":
                    let btnpnrt = this.GetButton("Print");
                    if (btnpnrt == null || !btnpnrt.Visible)
                        return;
                    this.DisplayMessage = "";
                    if (!BaseService.SessionManager.IsActionAssigned(43, "Allow Re-Print")) {
                        let ds = VoucherExportExcel.AllowRePrint(this.DocumentID, 0, this.DocID);
                        if (parseInt(ds.Tables[0][0]["PrintCount"]) > 0) {
                            this.DisplayMessage = "Re-Print Not Allowed";
                            return;
                        }
                    }

                    let iVersionNo = -1;
                    if (this.ScreenObject.DocPrefix.RevisionCombo.Visible && this.ScreenObject.DocPrefix.RevisionCombo.Items.length > 1) {
                        if (this.ScreenObject.DocPrefix.RevisionCombo.SelectedValue != this.ScreenObject.DocPrefix.RevisionCombo.Items[this.ScreenObject.DocPrefix.RevisionCombo.Items.length - 1].Value)
                            iVersionNo = parseInt(this.ScreenObject.DocPrefix.RevisionCombo.SelectedValue);
                    }
                    this.DisplayMessage = this.PrintVoucher(false, this.ScreenObject.DocID.toString(), true, null, iVersionNo);
                    if (this.IsPOs && this.SKU != null && this.SKU.Visible && this.SKU.IsTabStop)
                        this.SKU.SetFocus = true;
                    break;
                case "PrintPreview":
                    let iVersionNo2 = -1;
                    if (this.ScreenObject.DocPrefix.RevisionCombo.Visible && this.ScreenObject.DocPrefix.RevisionCombo.Items.length > 1) {
                        if (this.ScreenObject.DocPrefix.RevisionCombo.SelectedValue != this.ScreenObject.DocPrefix.RevisionCombo.Items[this.ScreenObject.DocPrefix.RevisionCombo.Items.length - 1].Value)
                            iVersionNo2 = parseInt(this.ScreenObject.DocPrefix.RevisionCombo.SelectedValue);
                    }
                    this.DisplayMessage = this.PrintVoucher(true, this.ScreenObject.DocID.toString(), true, null, iVersionNo2);
                    break;
                case "Save":
                case "SaveonHold":
                case "SaveAndPrint":
                case "SaveAndBarcode":
                    if (this.ScreenObject.Preferences.ContainsKey("AlertMessageOnPost") && this.ScreenObject.Preferences["AlertMessageOnPost"] == "True") {
                        if (!confirm("Do you want to post document?"))
                            return;
                    }
                    if (this.IsInventoryVoucher)
                        this.SaveInventoryDocument_1(sender);
                    else
                        this.SaveAccountingDocument(sender);
                    break;
                /**case "HelpDoc":

                    try
                    {
                        System.Diagnostics.Process.Start(PactFile.GetLogPath(HelpDoc));
                    }
                    catch(error)
                    {
                        Logger.ErrorLog("Open File ERROR::" + ex.Message);
                        Logger.ErrorLog("Open File Fileath:" + HelpDoc);
                    }

                    break;***/
                case "AdjustDownPay":
                    let drmat = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 26425);
                    if (drmat.length > 0) {
                        let objJV = new ShowJVViewModel();//
                        objJV.ShowJVViewModel_2(this, drmat[0]["SysColumnName"], 2);
                        BaseService.page.ShowDialog(objJV, ShowJVComponent, { ShowCenter: true, Title: objJV.Title });
                    }
                    else {
                        this.DisplayMessage = "Define Advance AR/AP field.";
                        return;
                    }
                    break;
                case "PostBills":
                    if (BaseService.SessionManager.Preferences.ContainsKey("On") && BaseService.SessionManager.Preferences["On"].toLocaleLowerCase() == "true") {
                        let accid = 0;
                        let IsCredit = false;
                        if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 39 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 6 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 13) {
                            IsCredit = true;
                            if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0)
                                accid = this.ScreenObject.CreditAccount.SelectedValue;
                        }
                        else if (this.ScreenObject.DocumentType == 11 || this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 5 || this.ScreenObject.DocumentType == 7 || this.ScreenObject.DocumentType == 9 || this.ScreenObject.DocumentType == 24 || this.ScreenObject.DocumentType == 33 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 8 || this.ScreenObject.DocumentType == 12) {
                            IsCredit = false;
                            if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0)
                                accid = this.ScreenObject.DebitAccount.SelectedValue;
                        }

                        if (accid > 0) {
                            this.DialogResult = false;
                            this.BillWisedt.Clear();
                            let objbill: BillWiseViewModel = new BillWiseViewModel();
                            objbill.BillWiseViewModel_2(this, 0, accid, IsCredit, 1, 1, true, "");
                            if (!this.DialogResult)
                                BaseService.page.ShowDialog(objbill, BillWiseComponent, { ShowCenter: true });
                        }
                    }
                    break;
                case "Lock":
                    btn = this.GetButton("Lock");
                    // Is locked
                    if (btn.Mandatory) {
                        btn.Mandatory = false;
                        btn.Label = "Unlock";
                        this.DisplayMessage = this.ScreenObject.lockDocument(true);
                        return;
                    }
                    else {
                        btn.Mandatory = true;
                        btn.Label = "lock";
                        this.DisplayMessage = this.ScreenObject.lockDocument(false);
                        return;
                    }
                case "Advance":
                    if (this.ScreenObject.Preferences.ContainsKey("DonotupdateAccounts") && this.ScreenObject.Preferences["DonotupdateAccounts"] != "" &&
                        parseBoolean(this.ScreenObject.Preferences["DonotupdateAccounts"])) {
                        if (!(this.ScreenObject.Preferences.ContainsKey("PostVoucherDocument") && Util.Int(this.ScreenObject.Preferences["PostVoucherDocument"]) > 40000))
                            return;

                        let accid = 0; let amt = this.GridNetTotal + this.FooterGridNetTotal;
                        if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 39 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 6 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 13) {
                            if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0)
                                accid = this.ScreenObject.CreditAccount.SelectedValue;
                        }
                        else if (this.ScreenObject.DocumentType == 11 || this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 5 || this.ScreenObject.DocumentType == 7 || this.ScreenObject.DocumentType == 9 || this.ScreenObject.DocumentType == 24 || this.ScreenObject.DocumentType == 33 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 8 || this.ScreenObject.DocumentType == 12) {
                            if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0)
                                accid = this.ScreenObject.DebitAccount.SelectedValue;
                        }

                        let CurrID = 1; let ExhgRate = 1; let IsBillwise = this.IsAccBillWise(accid);
                        if (this.Currency != null && this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue != "")
                            CurrID = parseInt(this.Currency.Currency.SelectedValue);
                        if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                            ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
                        let pvs = new PostVoucherSaveViewModel(this, parseInt(this.ScreenObject.Preferences["PostVoucherDocument"]), amt, accid, CurrID, ExhgRate, IsBillwise, false)
                        BaseService.page.ShowDialog(pvs, PostVoucherSaveComponent);
                    }
                    break;
                case "Post Billwise":
                    if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Post Billwise")) { }
                    break;
                case "DependantOK":
                    if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Define Dependencies")) {
                        this.DisplayMessage = "Access denied.";
                        return;
                    }

                    if (!Util.IsEmpty(this.SelectedRow["Docdetailsid"]) && this.ScreenObject.GridDataColumns.Contains("dcAlpha20") &&
                        this.SelectedRow["dcAlpha20"].toString().toLowerCase() != "open") {
                        this.DisplayMessage = "Can not change dependencies as activity is " + this.SelectedRow["dcAlpha20"].toString();
                        return;
                    }
                    let sbdep = "";
                    for (let i = 0; i < this.Dependflds.Items.length; i++) {
                        if (this.Dependflds.Items[i].IsChecked) {
                            if (sbdep.length > 0)
                                sbdep += ",";
                            sbdep += this.Dependflds.Items[i].Value;
                        }
                    }
                    this.SelectedRow["dcAlpha12"] = sbdep.toString();
                    this.SelectedRow["Dependencies"] = sbdep.toString();
                    break;
                case "Exit":
                    const { POSExitComponent } = await import('../../pos/posexit/posexit.component')
                    const { POSExitViewModel } = await import('../../pos/posexit/POSExitViewModel')
                    let POSExit = new POSExitViewModel();
                    POSExit.POSExitViewModel_1(this, false, false, false);
                    BaseService.page.ShowDialog(POSExit, POSExitComponent, { ShowCenter: true });
                    break;
                case "Options":
                    if (this.IsPOs) {
                        const { POSExitComponent } = await import('../../pos/posexit/posexit.component')
                        const { POSExitViewModel } = await import('../../pos/posexit/POSExitViewModel')
                        let POSExit = new POSExitViewModel();
                        POSExit.POSExitViewModel_1(this, true, false, false);
                        BaseService.page.ShowDialog(POSExit, POSExitComponent, { ShowCenter: true });
                    }
                    break;
                case "SearchSKU":
                    if (this.SKU != null) {
                        let skucol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID.toString() == BaseService.SessionManager.Preferences["POSItemCodeDimension"]);
                        if (skucol && skucol.GridViewID > 0) {
                            BaseService.page.ShowDialog(new ProductSearchCatalogViewModel(this, skucol.GridViewID, skucol.CostCenterID, skucol, null), ProductSearchCatalogComponent);
                        }
                        else {
                            skucol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID.toString() == "3");
                            if (skucol && skucol.GridViewID > 0) {
                                BaseService.page.ShowDialog(new ProductSearchCatalogViewModel(this, skucol.GridViewID, skucol.CostCenterID, skucol, null), ProductSearchCatalogComponent);
                            }
                            else {
                                this.DisplayMessage = "";
                            }
                        }
                    }
                    break;
                case "OK":
                    if (this.IsPOs && this.ScreenObject.CCguid == "")
                        this.OnRequestClose(this);
                    this.SaveInventoryDocument_1("Save");
                    break;
                case "Checkout":
                    if (this.Bal > 0) {
                        this.DisplayMessage = "Pay Balance to check out";
                        return;
                    }
                    this.SaveInventoryDocument_1("Checkout");
                    break;
                case "Pack":
                    if (this.ScreenObject.GridDataColumns.Contains("PackType") &&
                        !(this.SelectedRow == null && !((this.ScreenObject.Preferences.ContainsKey("PackWiseProds") && this.ScreenObject.Preferences["PackWiseProds"].toLowerCase() == "true")
                            || (this.ScreenObject.Preferences.ContainsKey("LineWisePacking") && this.ScreenObject.Preferences["LineWisePacking"].toLowerCase() == "true"))))
                        BaseService.page.ShowDialog(new FieldCalculatorViewModel(this, 3), FieldCalculatorComponent, { ShowCenter: true });
                    break;
                case "Revise":

                    if (this.ScreenObject.DocID > 0) {
                        if (this.IsUserLock) {
                            this.DisplayMessage = "Document is Locked";
                            this.MessageVisibility = true;
                            return;
                        }

                        if (this.ScreenObject.Preferences.ContainsKey("DontAllowRevisionAfter") && !Util.IsEmpty(this.ScreenObject.Preferences["DontAllowRevisionAfter"].toString())) {
                            let datefield = this.ScreenObject.Preferences["DontAllowRevisionAfter"];

                            for (let i = 0; i < this.ScreenObject.HeaderFields.length; i++) {
                                const oControl = this.ScreenObject.HeaderFields[i];
                                if (oControl instanceof PactExtraFieldDateData) {
                                    if (oControl.DBColumnName.toLowerCase() == datefield.toLowerCase()) {
                                        if (oControl.Date && oControl.Date < new Date().Date()) {
                                            this.DisplayMessage = "Revision not allowed after " + oControl.Label;
                                            this.MessageVisibility = true;
                                            return;
                                        }
                                        break;
                                    }
                                }
                            }

                            for (let i = 0; i < this.ScreenObject._TextFields.length; i++) {
                                const oControl = this.ScreenObject._TextFields[i];
                                if (oControl instanceof PactExtraFieldDateData) {
                                    if (oControl.DBColumnName.toLowerCase() == datefield.toLowerCase()) {
                                        if (oControl.Date && oControl.Date < new Date().Date()) {
                                            this.DisplayMessage = "Revision not allowed after " + oControl.Label;
                                            this.MessageVisibility = true;
                                            return;
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                    }
                    BaseService.page.ShowDialog(new ReviseReasonViewModel(this, 0), ReviseReasonComponent, { ShowCenter: true });
                    break;
                case "BidRevise":
                    this.IsBidVisible = true;
                    if (this.IsReverseBidding && this.BidEvaluationType == "Line item wise") {

                        if (this.SelectedRow && Util.Int(this.SelectedRow["DocDetailsID"]) > 0) {
                            let BidRev = "Yes";

                            if (this.BiddingType == 3) {
                                if (confirm("Are you sure, want to Participate in Reverse Bidding.?")) {
                                    BidRev = "Yes";
                                }
                                else {
                                    BidRev = "No";
                                }
                            }
                            if (BidRev == "Yes") {
                                let dsBid = BaseService.common.GetDataSet3("DOC080", this.parentBiddingDocID.toString(), "", "");
                                if (dsBid != null && dsBid.Tables.length > 0 && dsBid.Tables[0].length > 0) {

                                    let bidDrr = dsBid.Tables[0].filter(x => x.ProductID == this.SelectedRow["ProductID_Key"]);
                                    if (bidDrr != null && bidDrr.length == 0) {
                                        this.DisplayMessage = "Bid is not enabled for selected item"
                                        return;
                                    }
                                }

                                const { ReversalBiddingComponent } = await import('../reversal-bidding/reversal-bidding.component')
                                const { ReversBiddingViewModel } = await import('../reversal-bidding/ReversBiddingViewModel')
                                BaseService.page.ShowDialog(new ReversBiddingViewModel(this), ReversalBiddingComponent, { ShowCenter: true, HideHeader: true });
                                //BaseService.page.ShowDialog(new RowDetailsDialogViewModel(this), ReversalBiddingComponent, { ShowCenter: true });
                            }
                        }
                        else {
                            this.DisplayMessage = "Please select line item"
                        }
                    }
                    else {

                        let BreakIloop = false;

                        if (this.BiddingDefDS != null && this.BiddingDefDS.Tables.length > 1 && this.BiddingDefDS.Tables[1].length > 0) {

                            for (let i = 0; i < this.BiddingDefDS.Tables[1].length; i++) {

                                for (let j = 0; j < this.ScreenObject.GridData.length; j++) {
                                    if (this.BiddingDefDS.Tables[1][i]["EnableBid"] == 'True'
                                        && Util.String(this.BiddingDefDS.Tables[1][i]["ProductID"]) == Util.String(this.ScreenObject.GridData[j]["ProductID_Key"])) {
                                        let iRate = 0;
                                        let priceDef = 0;
                                        let StartPrice = 0

                                        iRate = Util.Double(this.ScreenObject.GridData[j]["Rate"]);
                                        priceDef = Util.Int(this.BiddingDefDS.Tables[1][i]["PriceDef"]);
                                        StartPrice = Util.Int(this.BiddingDefDS.Tables[1][i]["StartPrice"]);
                                        if (StartPrice === 0 || (iRate <= StartPrice)) {
                                            if (iRate > 0) {
                                                if (priceDef > 0) {
                                                    if ((iRate % priceDef) == 0) {

                                                    }
                                                    else {
                                                        BreakIloop = true;
                                                        //jLoopVal = j;
                                                        this.DisplayMessage = "Rate should be multiples of " + priceDef + " ,  miss match at row no " + j;
                                                        break;
                                                    }
                                                }
                                            }
                                            else {
                                                BreakIloop = true;
                                                //jLoopVal = j;
                                                this.DisplayMessage = "Rate should be multiples of " + priceDef + " ,  miss match at row no " + j;
                                                break;
                                            }
                                        }
                                        else {
                                            BreakIloop = true;
                                            this.DisplayMessage = "Rate should be less than or equal to Start price '" + StartPrice + "' at row no " + j;
                                            break;
                                        }

                                    }
                                }
                                if (BreakIloop) {
                                    break;
                                }

                            }
                        }
                        if (BreakIloop) {
                            //this.DisplayMessage ="Price Defination miss match at row no " + jLoopVal;
                            return;
                        }
                        if (this.ScreenObject.DocID > 0 && this.IsUserLock) {
                            this.DisplayMessage = "Document is Locked";
                            return;
                        }
                        this.ReviseReason = "";

                        if (this.IsReverseBidding) {
                            
                            this.IncreaseBidTime();

                            if (this.IsInventoryVoucher)
                                this.SaveInventoryDocument_1("Save");
                            else
                                this.SaveAccountingDocument("Save");
                        }
                        else {
                            if (this.IsInventoryVoucher)
                                this.SaveInventoryDocument_1("Revise");
                            else
                                this.SaveAccountingDocument("Revise");
                        }
                    }
                    break;
                case "BidReviseDistribute":
                    let txtList: any = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 7808);
                    if (txtList.length > 0) {
                        let DecreasedbyValue: any = this.ScreenObject._TextFields.filter(x => x.DBColumnName == txtList[0]["SysColumnName"]);
                        if (DecreasedbyValue.length > 0) {

                            this.Bidding_DistributeValues("Gross", "Rate", true, Util.Double(DecreasedbyValue[0].Text));
                        }
                    }
                    break;
                case "GST":
                    btn = this.GetButton("GST");
                    if (btn == null || !btn.Visible)
                        return;
                    BaseService.page.ShowDialog(new GSTPostingViewModel(this), GSTPostingComponent, { ShowCenter: true });
                    break;
                case "API":
                    btn = this.GetButton("API");
                    if (btn == null || !btn.Visible)
                        return;
                    /***ShellWindowViewModel.Instance().PopViewModel = new APIPostingViewModel(this);***/
                    break;
                case "ExternalFun":
                    let drExternalFun = this.ScreenObject.Data.Tables[0].Select("Mode=4");
                    if (drExternalFun.length == 0)
                        return;
                    if (BaseService.SessionManager.IsWebApplication) {
                        btn.ImgData = "btn_ExternalFun";
                    }
                    else {
                        btn.ImgData = "M9.9419943,7.7950812 L17.319393,7.7950812 C17.319393,7.7950811 20.702308,11.262615 20.702308,11.262615 L20.702308,20.725418 C20.702308,20.886499 20.571715,21.01708 20.410621,21.01708 L9.9419943,21.01708 C9.7809002,21.01708 9.6503077,20.886499 9.6503076,20.725418 L9.6503076,15.698177 13.261873,15.698177 13.261873,17.116214 15.884822,14.723853 13.271032,12.368079 13.234406,13.758669 9.6503076,13.758669 9.6503076,8.0867429 C9.6503077,7.9256625 9.7809002,7.7950811 9.9419943,7.7950812 z M15,1.8750005 C7.7512621,1.8750005 1.8749995,7.7512631 1.8749995,15 1.8749995,22.248737 7.7512621,28.125001 15,28.125001 22.248738,28.125001 28.125001,22.248737 28.125001,15 28.125001,7.7512631 22.248738,1.8750005 15,1.8750005 z M15,0 C23.284271,0 30.000001,6.7157292 30.000001,15 30.000001,23.28427 23.284271,30.000001 15,30.000001 6.715728,30.000001 0,23.28427 0,15 0,6.7157292 6.715728,0 15,0 z";
                    }
                    btn.ControlDataXML = drExternalFun[0]["SysColumnName"].toString();
                    btn.Label = drExternalFun[0]["Shortcut"].toString();
                    btn.ComParam = "ExternalFun";
                    btn.Mode = parseInt(drExternalFun[0]["Mode"].toString());
                    btn.ToolTipFooterTitle = drExternalFun[0]["SpName"].toString();
                    btn.ToolTipFooterDescription = drExternalFun[0]["IpParams"].toString();
                    btn.ToolTipDescription = drExternalFun[0]["OpParams"].toString();
                    if (!Util.IsEmpty(btn.ToolTipDescription) && btn.ToolTipDescription.split(',')[0] == "-501")
                        this.ReEvaluate(true, false);
                    break;
                case "Pay":
                    if (this.DocID == 0 && BaseService.SessionManager.Preferences.ContainsKey("PosShifts") && BaseService.SessionManager.Preferences["PosShifts"] != "" && parseInt(BaseService.SessionManager.Preferences["PosShifts"]) > 50000 && BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "DonotAllowbillingoutofSessionTime")) {
                        let dr = this.ScreenObject.Data.Tables[1].filter(x => x.ShiftID == this.ScreenObject.ShiftNodeID);
                        if (dr.length > 0) {
                            if (!(new Date().toTimeString().slice(0, 8) > dr[0]["StartTime"].toString()) && (new Date().toTimeString().slice(0, 8) > dr[0]["EndTime"].toString())) {
                                this.DisplayMessage = "Session Timed out";

                                return;
                            }
                        }
                    }

                    if (this.POSPayModes.PayModes.length == 0) {
                        this.SaveInventoryDocument_1("CheckoutPrint");
                        return;
                    }

                    if (!Util.IsEmpty(this.ScreenObject.GridData[0]["ProductID_Key"])) {
                        let col = this.ScreenObject.ColumnSource.find(a => a.DistributionColID == -1);
                        if (col && (col.PostingType == 3 || col.PostingType == 4))
                            this.RoundOffValue(this.ScreenObject.GridData[0], col);
                    }
                    for (let k = 0; k < this.ScreenObject.FooterGridData.length; k++) {
                        // if (ScreenObject.FooterGridData[k].RowState == DataRowState.Deleted || ScreenObject.FooterGridData[k].RowState == DataRowState.Detached)
                        //     continue;
                        if (this.ScreenObject.FooterGridData[k]["IsCalculated"].toString() == "3") {
                            let FooterVal = 0;
                            var FCol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == this.ScreenObject.FooterGridData[k]["ColumnName"].toString());
                            FooterVal = Util.Double(this.ScreenObject.FooterGridData[k]["Amount"]);
                            if (FCol != null) {
                                for (let h = 0; h < this.ScreenObject.GridData.length; h++) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[h]["ProductID_Key"])) {
                                        this.ScreenObject.GridData[h][FCol.DisplayMember] = FooterVal;
                                    }
                                }
                                this.DistributeValues("dcCalc" + FCol.DisplayMember, FooterVal, (!Util.IsEmpty(FCol.DistributeColName)) ? FCol.DistributeColName : "Gross", true);
                            }
                        }
                    }

                    let Amt = 0;
                    this.POSPayModes.BillValue = 0;
                    this.POSPayModes.points = 0;
                    this.POSPayModes.AvailablePoints = 0;

                    if (!(this.ScreenObject.Preferences.ContainsKey("UseAsOrder") && this.ScreenObject.Preferences["UseAsOrder"] == "True")) {
                        let ds = this.ScreenObject.GetPosPoints(this.DocumentDate);
                        {
                            if (ds != null && ds.Tables.length > 0) {
                                if (ds.Tables[0].length > 0 && ds.Columns[0].Contains("ccAlpha49")
                                    && Util.Double(ds.Tables[0][0]["ccAlpha49"].toString()) > 0 && Util.Double(ds.Tables[0][0]["ccAlpha50"].toString()) > 0) {
                                    this.POSPayModes.BillValue = parseFloat(ds.Tables[0][0]["ccAlpha49"]);
                                    this.POSPayModes.points = parseFloat(ds.Tables[0][0]["ccAlpha50"]);
                                }
                                if (ds.Tables.length > 1 && ds.Tables[1].length > 0 && ds.Columns[1].Contains("points") &&
                                    !Util.IsEmpty(ds.Tables[1][0]["points"]))
                                    this.POSPayModes.AvailablePoints = parseFloat(ds.Tables[1][0]["points"]);
                            }
                        }
                    }

                    Amt = 0;
                    if (this.POSPayModes.ReturnDecimalPoints != "")
                        this.POSPayModes.Return = (0).ToString("N" + this.POSPayModes.ReturnDecimalPoints).replace("-", "");
                    else
                        this.POSPayModes.Return = "0".toString();

                    let drAdv = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 26425);
                    if (drAdv.length > 0) {
                        if (!this.ScreenObject.IsDocEdit) {
                            let dsadv = this.ScreenObject.GetArApDetails(0, this.DocumentDate, false);
                            if (dsadv != null && dsadv.Tables.length > 0 && dsadv.Columns[0].Contains("DocNo") && dsadv.Tables[0].length > 0) {
                                let dr;
                                let drrows = this.POSPayModes.GridData.filter(x => x.ColumnName == drAdv[0]["SysColumnName"]);
                                if (drrows.length > 0)
                                    dr = drrows[0];
                                else {
                                    dr = this.POSPayModes.GridDataObj.NewRow();
                                    if (this.POSPayModes.GridData.length > 0)
                                        this.POSPayModes.GridData.InsertAt(dr, 0);
                                    else
                                        this.POSPayModes.GridData.push(dr);
                                }

                                let sbadv = "";
                                let amt = 0;
                                for (let i = 0; i < dsadv.Tables[0].length; i++) {
                                    if (!Util.IsEmpty(dsadv.Tables[0][i]["Amount"]) && parseFloat(dsadv.Tables[0][i]["Amount"]) > 0
                                        && amt + parseFloat(dsadv.Tables[0][i]["Amount"]) <= this.GridNetTotal + this.FooterGridNetTotal) {
                                        amt += parseFloat(dsadv.Tables[0][i]["Amount"]);
                                        sbadv += "<NonAccRows  RefDocNo=\"" + dsadv.Tables[0][i]["DocNo"].toString() + "\" Amount=\"";
                                        sbadv += dsadv.Tables[0][i]["Amount"].toString() + "\"  />";
                                    }
                                }
                                this.ArApBills = sbadv.toString();

                                dr["Name"] = drAdv[0]["ResourceData"].toString();
                                if (!Util.IsEmpty(drAdv[0]["Decimal"]) && parseFloat(drAdv[0]["Decimal"]) >= 0)
                                    dr["Amount"] = amt.ToString("N" + drAdv[0]["Decimal"].toString());
                                else if (BaseService.SessionManager.Preferences.ContainsKey("DecimalsinExtraFields") && BaseService.SessionManager.Preferences["DecimalsinExtraFields"] != "")
                                    dr["Amount"] = amt.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinExtraFields"]);
                                else
                                    dr["Amount"] = amt;
                                dr["ColumnName"] = drAdv[0]["SysColumnName"];
                                dr["Type"] = "1";

                            }
                        }
                    }
                    for (let i = 0; i < this.POSPayModes.GridData.length; i++) {
                        if (!Util.IsEmpty(this.POSPayModes.GridData[i]["ColumnName"]) && !Util.IsEmpty(this.POSPayModes.GridData[i]["Amount"]))
                            Amt += parseFloat(this.POSPayModes.GridData[i]["Amount"]);
                    }

                    this.Bal = this.GridNetTotal + this.FooterGridNetTotal - Amt;
                    if (this.Bal < 0) {
                        if (this.POSPayModes.ReturnDecimalPoints != "")
                            this.POSPayModes.Return = (this.GridNetTotal + this.FooterGridNetTotal - Amt).ToString("N" + this.POSPayModes.ReturnDecimalPoints).replace("-", "");
                        else
                            this.POSPayModes.Return = (this.GridNetTotal + this.FooterGridNetTotal - Amt).toString().replace("-", "");

                        this.Bal = 0;
                    }


                    this.POSPayModes.DisplayMessage = "";

                    if (this.POSPayModes.PayModes.length > 0)
                        this.POSPayModes.onClick(this.POSPayModes.PayModes[0].DBColumnName, false);

                    this.PoleDisplayMessage(3, null);
                    if (this.ScreenObject.DocumentType == 39 && (this.ScreenObject.Preferences.ContainsKey("DonotShowPayModesinReturn") && this.ScreenObject.Preferences["DonotShowPayModesinReturn"].toUpperCase() == "TRUE")) {
                        this.POSPayModes.Selectedbtn = this.POSPayModes.PayModes.find(a => a.SectionID == "9");
                        if (this.POSPayModes.Selectedbtn == null) {
                            this.DisplayMessage = "Difine PayMode";

                            return;
                        }
                        this.POSPayModes.OnButtonClick("OK");
                        if (this.POSPayModes.DisplayMessage != "") {
                            this.DisplayMessage = this.POSPayModes.DisplayMessage;

                            return;
                        }
                        this.SaveInventoryDocument_1("CheckoutPrint");
                    }
                    else {
                        //ShellWindowViewModel.Instance().PopViewModel = this.POSPayModes;
                        BaseService.page.ShowDialog(this.POSPayModes, POSPayModesComponent, { ShowCenter: true });
                    }

                    break;
                case "PostStock":
                    if ((this.ScreenObject.Preferences.ContainsKey("PostingDOC") && this.ScreenObject.Preferences["PostingDOC"] != "" && parseInt(this.ScreenObject.Preferences["PostingDOC"]) > 40000)) {
                        BaseService.document.GetDocumentDrafts(0, parseInt(this.ScreenObject.Preferences["PostingDOC"]), 1, false).subscribe(
                            (response) => {
                                let dt = response.Tables[0];
                                if (dt.length > 0) {
                                    this.res = "";
                                    BaseService.page.ShowDialog(new DocumentDraftsViewModel(this, parseInt(this.ScreenObject.Preferences["PostingDOC"]), 1), DocumentDraftsComponent).subscribe(() => {
                                        if (this.res == "No") {
                                            let gt = new GoToLineViewModel()
                                            gt.GoToLineViewModel_4(this, 0, 0);
                                            BaseService.page.ShowDialog(gt, GoToLineComponent, { ShowCenter: true, NoWidth: true });
                                        }
                                    });
                                }
                                else {
                                    let gt = new GoToLineViewModel()
                                    gt.GoToLineViewModel_4(this, 0, 0);
                                    BaseService.page.ShowDialog(gt, GoToLineComponent, { ShowCenter: true, NoWidth: true });
                                }
                            }
                        );
                    }
                    else {
                        this.DisplayMessage = "Define stock posting document";
                        return;
                    }
                    break;
                case "ShowJV":
                    this.PrepareJV();
                    break;
                case "GenerateLink":
                    this.GenerateLinkClick();
                    break;
                case "UBL":
                    this.GetEInv();
                    break;

                case "UBLNEW":
                    let btnUBLNEW = this.GetButton("UBLNEW");
                    if (btnUBLNEW == null || !btnUBLNEW.Visible)
                        return;
                    let ObjEInvoice = new GSTPostingViewModel(this);
                    const { Document } = await import('../add-edit-document/Document')
                    ObjEInvoice.dsGSTDetails = null;// Document.GetUBLDetail(this.DocID, this.CostCenterID);
                    ObjEInvoice.dsGSTDetails = Document.GetUBLDetail(this.DocID, this.CostCenterID);
                    if (ObjEInvoice.dsGSTDetails.Columns[0].Contains("InvoiceType") && Util.String(ObjEInvoice.dsGSTDetails.Tables[0][0]["InvoiceType"]) == "B2C") {
                        ObjEInvoice.Actions.SelectedItem = ObjEInvoice.Actions.Items[0];
                        ObjEInvoice.Actions.SelectedValue = ObjEInvoice.Actions.Items[0].Value;
                        ObjEInvoice.GetDsGST(this.DocID, true);
                    }
                    else if (ObjEInvoice.dsGSTDetails.Columns[0].Contains("InvoiceType") && Util.String(ObjEInvoice.dsGSTDetails.Tables[0][0]["InvoiceType"]) == "B2B") {
                        ObjEInvoice.Actions.SelectedItem = ObjEInvoice.Actions.Items[1];
                        ObjEInvoice.Actions.SelectedValue = ObjEInvoice.Actions.Items[1].Value;
                        ObjEInvoice.GetDsGST(this.DocID, true);
                    }
                    ObjEInvoice.OnButtonClick("Upload");
                    this.DisplayMessage = ObjEInvoice.DisplayMessage;
                    break;
                case "SearchData":
                    this.SearchData();
                    break;
                case "Activities":
                    this.SetVisibiltiFalse();
                    if (this.ViewActivities == null) {
                        this.ViewActivities = new ViewActivitiesViewModel(this);
                        this.ViewActivities.NodeID = (this.DocID);
                        this.NodeID = (this.DocID);
                        this.Activities = new ActivitiesViewModel(this, false);
                        this.Activities.AssignVisiblity = false;
                        this.ViewActivities.Activities = this.Activities;
                        this.ViewActivities.CloseVisible = true;
                        this.ViewActivities.SetColumnsVisibility(this.Activities);
                    }
                    else
                        this.NodeID = this.ViewActivities.NodeID = (this.DocID)

                    let dvrws;
                    if (this.NodeID > 0)
                        dvrws = this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -10 && (x.Mode == 2 || x.Mode == 3));
                    else
                        dvrws = this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -10 && (x.Mode == 1 || x.Mode == 3));
                    if (dvrws.length > 0) {
                        if (!parseBoolean(dvrws[0]["IsVisible"].toString()))
                            return;

                        this.Activities.Enabled = parseBoolean(dvrws[0]["IsEditable"].toString());
                    }
                    else
                        this.Activities.Enabled = true;


                    if (this.ScreenObject.IsPurchase) {
                        if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.Name.Visible)
                            this.Activities.CRMCustomer.Text = this.ScreenObject.CreditAccount.Name.Text;
                    }
                    else {
                        if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.Name.Visible)
                            this.Activities.CRMCustomer.Text = this.ScreenObject.DebitAccount.Name.Text;
                    }
                    if (this.ScreenObject.Preferences.ContainsKey("ActivityAsPopUp") && Util.String(this.ScreenObject.Preferences["ActivityAsPopUp"]).toLowerCase() == "true") {
                        BaseService.page.ShowDialog(new ShowActivityViewModel(this), ShowActivitiesComponent, { ShowCenter: true });
                    }
                    else {
                        //this.ActVisibility = true;
                        BaseService.page.ShowDialog(this.Activities, ActivitiesComponent);
                    }
                    break;
                case "LoadDraft":
                    BaseService.page.ShowDialog(new DocumentDraftsViewModel(this, 1), DocumentDraftsComponent);
                    break;
                case "GoToLine":
                    let gt = new GoToLineViewModel()
                    gt.GoToLineViewModel_2(this);
                    BaseService.page.ShowDialog(gt, GoToLineComponent, { ShowCenter: true, NoWidth: true });
                    this.SetFocusongrid = true;
                    break;
                case "Cheque":
                    btn = this.GetButton("Pre Payments");
                    if (btn != null && btn.Visible && this.ScreenObject.GridData.length > 0 && !Util.IsEmpty(this.ScreenObject.GridData[0]["Amount"]))
                        this.pdcGCVM.Amount.Text = this.ScreenObject.GridData[0]["Amount"].toString();

                    if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && this.ScreenObject.GridData.length > 0 && !Util.IsEmpty(this.ScreenObject.GridData[0]["CreditAccount_Key"])
                        && this.pdcGCVM.DebitAcc.Visible)
                        this.pdcGCVM.DebitAcc.SelectedValue = parseInt(this.ScreenObject.GridData[0]["CreditAccount_Key"]);

                    if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && this.ScreenObject.GridData.length > 0 && !Util.IsEmpty(this.ScreenObject.GridData[0]["DebitAccount_Key"])
                        && this.pdcGCVM.CredAcc.Visible)
                        this.pdcGCVM.CredAcc.SelectedValue = parseInt(this.ScreenObject.GridData[0]["DebitAccount_Key"]);

                    BaseService.page.ShowDialog(this.pdcGCVM, PDCGenerateChequeComponent).subscribe(() => { this.SetFocusongrid = true; });
                    break;

                case "ReEvaluate":
                    if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReEvaluate"))
                        this.ReEvaluate(true);
                    break;
                case "ReEvaluateTax":
                    if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReEvaluate") || BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReEvaluateTaxChart"))
                        this.ReEvaluatePriceTax(0, "t");
                    break;
                case "ReEvaluatePrice":
                    if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReEvaluate") || BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReEvaluatePriceChart"))
                        this.ReEvaluatePriceTax(0, "p");
                    break;
                case "Next":
                case "Previous":
                    if ((!this.ScreenObject.DocPrefix.NextVisibility && sender.toString() == "Next") || (!this.ScreenObject.DocPrefix.PreviousVisibility && sender.toString() == "Previous"))
                        return;
                    this.GetData(sender.toString());
                    break;
                case "ChequeDate":
                case "BillDate":
                case "DueDate":
                case "DocDate":
                case "ChequeMaturityDate":
                    {
                        let fld = this.ScreenObject.HeaderFields.find(a => a instanceof PactControlData && a.DBColumnName == sender.toString());
                        if (fld)
                            fld.SetFocus = true;
                    }
                    break;
                case "Hold":
                    if (this.DocID == 0) {
                        this.HoldDocDate.Date = this.DocumentDate;
                        if (this.DocumentType == 38) {
                            const { POSExitComponent } = await import('../../pos/posexit/posexit.component')
                            const { POSExitViewModel } = await import('../../pos/posexit/POSExitViewModel')
                            let POSExit = new POSExitViewModel();
                            POSExit.POSExitViewModel_1(this, false, true, false);
                            BaseService.page.ShowDialog(POSExit, POSExitComponent, { ShowCenter: true });
                        }
                        else {
                            BaseService.page.ShowDialog(this, HoldComponent, { Title: BaseService.GetResource("Com_SaveAsHold"), ShowCenter: true, NoWidth: true })
                        }
                        if (this.IsPOs && this.SKU != null && this.SKU.Visible && this.SKU.IsTabStop)
                            this.SKU.SetFocus = true;
                    }
                    else {
                        if (this.IsPOs && this.SKU != null && this.SKU.Visible && this.SKU.IsTabStop)
                            this.SKU.SetFocus = true;
                        this.DisplayMessage = BaseService.GetResource("Documentalreadysaved");
                        return;
                    }
                    break;
                case "HoldDoc":
                    if (this.DocID == 0) {
                        if (Util.IsEmptySpace(this.HoldDocName.Text)) {
                            this.DisplayMessage = "Enter Name";
                            return;
                        }
                        this.SaveDraft(false, false);
                    }
                    else {
                        this.DisplayMessage = BaseService.GetResource("Documentalreadysaved");
                        return;
                    }
                    break;
                case "Release":
                    BaseService.page.ShowDialog(new DocumentDraftsViewModel(this, 2), DocumentDraftsComponent).subscribe(() => {
                        if (this.IsPOs && this.SKU != null && this.SKU.Visible && this.SKU.IsTabStop)
                            this.SKU.SetFocus = true;
                    });
                    break;
                case "ChangeLocation":
                    this.ChangeLocation(true, false, BaseService.SessionManager.LocationID);
                    break;
                case "Copy":
                    BaseService.page.ShowDialog(new CopyDocumentViewModel(this, true, this.CostCenterID.toString()), CopyDocumentComponent, { ShowCenter: true, NoWidth: true }).subscribe(() => {
                        if (this.DialogResult) {
                            this.CalculateTotals(null, false);
                            this.RefreshGrid = true;
                        }
                    });
                    break;
                case "LoadDocument":
                    if (!this.ScreenObject.DocPrefix.LoadVisibility)
                        return;
                    this.LoadDOcument();
                    break;
                case "SaveDraft":
                    if (this.DocID == 0) {
                        if ((this.ScreenObject.Preferences.ContainsKey("RemarksWhileSavingDrafts") && this.ScreenObject.Preferences["RemarksWhileSavingDrafts"].toUpperCase() == "TRUE")) {
                            const { POSExitComponent } = await import('../../pos/posexit/posexit.component')
                            const { POSExitViewModel } = await import('../../pos/posexit/POSExitViewModel')
                            let POSExit = new POSExitViewModel();
                            POSExit.POSExitViewModel_1(this, false, false, true);
                            BaseService.page.ShowDialog(POSExit, POSExitComponent, { ShowCenter: true }).subscribe(() => {
                                this.SaveDraft(false, true);
                            });
                        }
                        else {
                            this.SaveDraft(false, true);
                        }
                    }
                    else {
                        this.DisplayMessage = BaseService.GetResource("Documentalreadysaved");
                        return;
                    }
                    break;
                case "Notes":
                    btn = this.GetButton("Notes");
                    if (btn == null || !btn.Visible)
                        return;
                    this.OnAddNote();
                    this.SetVisibiltiFalse();
                    BaseService.page.ShowDialog(this, DocumentNotesComponent, { Title: "Notes" }) //NoteVisibility = true;
                    break;
                case "Attachment":

                    btn = this.GetButton("Attachments");

                    if (btn == null || !btn.Visible)
                        return;
                    this.OnAddAttachment();
                    this.SetVisibiltiFalse();
                    this.AttachmentVisibility = true;
                    this.ViewAttachments.AttachmentsList.forEach(item => {
                        if (item.RowID == null && Util.IsEmpty(item.ColID) && item.AttachmentType == 0)
                            item.Height = 20;
                        else
                            item.Height = 0;
                    });
                    this.SignVisibility = false; this.CaptureVisibility = false; this.AttachVisibility = true;
                    this.Attachment.RowID = null;
                    this.Attachment.ColID = "";
                    this.IsDocAttachment = true;
                    BaseService.page.ShowDialog(this, DocumentAttachmentsComponent, { Title: "Attachment", ShowCenter: true });
                    //ViewAttachments.RowID = Attachment.RowID;
                    //ViewAttachments.ColID = Attachment.ColID;
                    //ViewAttachments.Refresh = true;
                    break;
                case "Capture":

                    btn = this.GetButton("Capture");

                    if (btn == null || !btn.Visible)
                        return;
                    this.OnAddAttachment();
                    this.SetVisibiltiFalse();
                    this.AttachmentVisibility = true;
                    this.ViewAttachments.AttachmentsList.forEach(item => {
                        if (item.AttachmentType == 1)
                            item.Height = 20;
                        else
                            item.Height = 0;
                    });
                    this.SignVisibility = false; this.CaptureVisibility = true; this.AttachVisibility = false;
                    this.Attachment.RowID = null;
                    this.Attachment.ColID = "";
                    this.IsDocAttachment = true;
                    BaseService.page.ShowDialog(this, DocumentAttachmentsComponent, { Title: "Capture", ShowCenter: true });
                    //ViewAttachments.RowID = Attachment.RowID;
                    //ViewAttachments.ColID = Attachment.ColID;
                    //ViewAttachments.Refresh = true;
                    break;
                case "Sign":

                    btn = this.GetButton("Sign");

                    if (btn == null || !btn.Visible)
                        return;
                    this.OnAddAttachment();
                    this.SetVisibiltiFalse();
                    this.AttachmentVisibility = true;
                    this.ViewAttachments.AttachmentsList.forEach(item => {
                        if (item.IsSign || item.AttachmentType == 2)
                            item.Height = 20;
                        else
                            item.Height = 0;
                    });

                    this.SignVisibility = true; this.CaptureVisibility = false; this.AttachVisibility = false;
                    this.Attachment.RowID = null;
                    this.Attachment.ColID = "";
                    this.IsDocAttachment = true;
                    BaseService.page.ShowDialog(this, DocumentAttachmentsComponent, { Title: "Sign", ShowCenter: true });
                    //ViewAttachments.RowID = Attachment.RowID;
                    //ViewAttachments.ColID = Attachment.ColID;
                    //ViewAttachments.Refresh = true;
                    break;
                case "Contacts":
                    btn = this.GetButton("Contacts");

                    if (btn == null || !btn.Visible)
                        return;
                    // OnAddAttachment();
                    this.SetVisibiltiFalse();
                    this.ContactsVisibility = true;
                    break;
                case "CancelAction":
                    this.ApproveVisibility = false;
                    break;
                case "ApproveVisiblity":
                    if (!this.ButtonApprove.Visible || !this.ButtonApprove.Enable)
                        return;
                    if (this.IsInventoryVoucher && this.LineWiseApproval) {
                        //alert('check-approve linewise')

                        let gtApp = new UpdateFieldsViewModel();
                        gtApp.UpdateFieldsViewModel_1(this);
                        {
                            BaseService.page.ShowDialog(gtApp, UpdateFieldComponent, { ShowCenter: true, HideHeader: true, HideClose: true }).subscribe(() => {

                                let col = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.ValueBinding) && a.ValueBinding == "IsSelected");
                                if (col)
                                    col.IsVisible = false;
                                col = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.DisplayMember) && a.DisplayMember == "AppRemarks");
                                if (col)
                                    col.IsVisible = false;

                            });
                            return;
                        }
                    }
                    if ((this.ScreenObject.Preferences.ContainsKey("UseAsLC") && this.ScreenObject.Preferences["UseAsLC"] != "" && parseBoolean(this.ScreenObject.Preferences["UseAsLC"]))
                        || (this.ScreenObject.Preferences.ContainsKey("UseAsTR") && this.ScreenObject.Preferences["UseAsTR"] != "" && parseBoolean(this.ScreenObject.Preferences["UseAsTR"]))) {
                        this.SaveAccountingDocument("Approve");
                    }
                    else {
                        this.SetVisibiltiFalse();
                        this.ApproveVisibility = true;
                        this.RightTabSelectedIndex = 0;
                        if (this.IsPOs)
                            this.ButtonSaveandPrint.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");
                        this.RecurDocsWithApproval.Visible = false;
                        if (!this.IsInventoryVoucher && this.ScreenObject.IsRecurDocumet()) {
                            if (this.RecurDocsWithApproval.Items.length == 0) {
                                this.RecurDocsWithApproval.Items.push(ComboBoxItems.ComboBoxItems_2("Auto post", "2"));
                                this.RecurDocsWithApproval.Items.push(ComboBoxItems.ComboBoxItems_2("With Approval", "1"));
                                this.RecurDocsWithApproval.Items.push(ComboBoxItems.ComboBoxItems_2("Without Approval", "0"));
                                this.RecurDocsWithApproval.SelectedValue = "2";
                            }
                            this.RecurDocsWithApproval.Visible = true;
                        }
                    }
                    break;
                case "SuspendVisiblity":
                    if (!this.ButtonSuspend.Visible || !this.ButtonSuspend.Enable)
                        return;
                    this.SuspendVisiblity = true;
                    if (this.ScreenObject.IsDocEdit)
                        this.Remarks.Text = this.linkStatusRemarks;
                    BaseService.page.ShowDialog(this, ApproveComponent, { ShowCenter: true, NoWidth: true, Title: BaseService.GetResource('LinkStatusLabel') });
                    break;
                case "PriceChart":
                    btn = this.GetButton("PriceChart");

                    if (btn == null || !btn.Visible)
                        return;
                    if (this.ScreenObject.Preferences.ContainsKey("PriceChartMapping") && this.ScreenObject.Preferences["PriceChartMapping"].length > 0) {
                        // using (AddPriceChartNewViewModel oPriceChartViewModel = new AddPriceChartNewViewModel("DOCUMENT", 0, 0))
                        // {
                        //     oPriceChartViewModel.LoadFromDocument(this);
                        //     ShellWindowViewModel.Workspaces.push(oPriceChartViewModel);
                        //     ShellWindowViewModel.SetActiveWorkspace(oPriceChartViewModel);
                        // }
                        this.LoadPriceChart();

                    }
                    else
                        this.DisplayMessage = "Please Configure Price Chart Mappings";
                    break;
                case "LinkStatus_Open":
                    this.SaveLinkStatus(369);
                    break;
                case "LinkStatus_Suspend":
                    this.SaveLinkStatus(445);
                    break;
                case "Recur":
                    btn = this.GetButton("Recur");
                    if (btn == null || !btn.Visible)
                        return;
                    if (this.ScreenObject.IsDocEdit) {
                        this.SetVisibiltiFalse();
                        this.Recur = new RecurViewModel(this);
                        this.Recur.LoadData();
                        BaseService.page.ShowDialog(this.Recur, RecurComponent);
                    }
                    break;
                case "Delete":
                    if (!this.ButtonDelete.Visible || !this.ButtonDelete.Enable)
                        return;
                    if (this.ScreenObject.DocID == 0) {
                        this.DisplayMessage = "Cannot Delete Empty Document";
                        this.MessageVisibility = true;
                        return;
                    }
                    if (this.ScreenObject.DocID > 0 && this.IsUserLock) {
                        this.DisplayMessage = "Document is Locked";
                        return;
                    }

                    if (this.ScreenObject.RefNodeID != 0 && !(this.ScreenObject.RefCCId == 86 || this.ScreenObject.RefCCId == 73 || this.ScreenObject.RefCCId == 89 || this.ScreenObject.IsRefLCTR)) {
                        this.DisplayMessage = BaseService.GetResource("RefDeleteDocument");
                        return;
                    }

                    if (!this.IsInventoryVoucher && this.ScreenObject.IsBouncedorPdcPosted && !(this.ScreenObject.Preferences.ContainsKey("LineWisePDC") && this.ScreenObject.Preferences["LineWisePDC"] != "" && parseBoolean(this.ScreenObject.Preferences["LineWisePDC"]))) {
                        this.DisplayMessage = this.ScreenObject.BouncedorPdcMessage;
                        return;
                    }

                    if (this.StatusID == 439) {
                        this.DisplayMessage = "Discounted PDC can not be deleted";
                        return;
                    }

                    if (this.ScreenObject.DocumentType == 75) {

                        let dt = BaseService.common.GetDataSet("PAY052", this.ScreenObject.DocID.toString()).Tables[0];
                        if (dt != null && dt.length > 0) {
                            this.DisplayMessage = "Final Settlement already Posted for this Grade can not be deleted";
                            this.MessageVisibility = true;
                            return;
                        }
                    }
                    if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "API"))
                        this.GenerateAPIRequest(8);
                    this.DeleteDocument();
                    break;
                case "Suspend":
                    if (this.ScreenObject.DocID == 0) {
                        this.DisplayMessage = "Cannot Suspend Empty Document";
                        this.MessageVisibility = true;
                        return;
                    }
                    if (this.ScreenObject.DocID > 0 && this.IsUserLock) {
                        this.DisplayMessage = "Document is Locked";
                        return;
                    }
                    if (!this.ButtonSuspendDoc.Visible || !this.ButtonSuspendDoc.Enable)
                        return;
                    if (this.ScreenObject.RefNodeID != 0 && !(this.ScreenObject.RefCCId == 86 || this.ScreenObject.RefCCId == 73 || this.ScreenObject.RefCCId == 89 || this.ScreenObject.IsRefLCTR)) {
                        this.DisplayMessage = "Can not suspend reference document";
                        return;
                    }
                    if (!this.IsInventoryVoucher && this.ScreenObject.IsBouncedorPdcPosted) {
                        this.DisplayMessage = this.ScreenObject.BouncedorPdcMessage;
                        return;
                    }
                    if (this.StatusID == 439) {
                        this.DisplayMessage = "Discounted PDC can not be suspended";
                        return;
                    }
                    if (this.ScreenObject.DocumentType == 75) {
                        let sGrade = "";
                        let fld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid53");
                        if (fld != undefined && fld != null) {
                            if (fld instanceof PactListBoxData)
                                sGrade = fld.SelectedValue.toString();
                            else if (fld instanceof PactCodeNameListBoxData)
                                sGrade = fld.SelectedValue.toString();
                        }
                        let dt = BaseService.common.GetDataSet("PAY104", sGrade).Tables[0];
                        if (dt != null && dt.length > 0) {
                            this.DisplayMessage = "Final Settlement already Posted for this Grade can not be suspended";
                            this.MessageVisibility = true;
                            return;
                        }
                    }
                    if (this.ScreenObject.DocumentType == 202) {
                        let sd: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha29");
                        if (sd != undefined && sd instanceof PactExtraFieldDateData && !sd.Date) {
                            this.DisplayMessage = "Please enter the contract termination date";
                            this.MessageVisibility = true;
                            return;
                        }
                        else {
                            let sdate = sd.Date;
                            let sResp = this.UpdateContractTerminationDate(sdate);
                            if (sResp.Trim().length > 0) {
                                this.DisplayMessage = "Error : " + sResp;
                                this.MessageVisibility = true;
                                return;
                            }
                        }
                    }
                    if (this.ScreenObject.Preferences.ContainsKey("SuspendRemarksMandatory") && this.ScreenObject.Preferences["SuspendRemarksMandatory"] != "" && parseBoolean(this.ScreenObject.Preferences["SuspendRemarksMandatory"]))
                        BaseService.page.ShowDialog(new ReviseReasonViewModel(this, 1), ReviseReasonComponent);
                    else {
                        if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "API"))
                            this.GenerateAPIRequest(11);
                        this.IsSuspend = true;
                        if (confirm("Are you sure you want to suspend?"))
                            this.OnDeleteCallBack();
                    }
                    break;
                case "CancelAppReject":
                    //BaseService.page.HideDialog(this.PopUpGUID);
                    this.ApproveVisibility = false;
                    break;
                case "Approve":
                case "ApproveandPrint":
                    if (this.ScreenObject.DocID > 0 && this.IsUserLock) {
                        this.DisplayMessage = "Document is Locked";
                        return;
                    }

                    if ((this.ScreenObject.Preferences.ContainsKey("CommentsMandatoryforApprove") && this.ScreenObject.Preferences["CommentsMandatoryforApprove"] != "" && parseBoolean(this.ScreenObject.Preferences["CommentsMandatoryforApprove"]))) {
                        if (this.Remarks.Text == null || this.Remarks.Text == "") {
                            this.DisplayMessage = "Remarks Mandatory For Approval";
                            return;
                        }
                    }
                    if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit")) {
                        this.SaveStatus(369, this.GetWorkFlow(false, null), "");
                        if (sender.toString() == "ApproveandPrint")
                            this.DisplayMessage = this.DisplayMessage + "\r\n " + this.PrintVoucher(false, this.ScreenObject.DocID.toString(), true, null);
                    }
                    else {
                        //if (GetWorkFlow() > 0)
                        //    SaveStatus(441);
                        //else if (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 19)
                        //    SaveStatus(370);
                        //else
                        //    SaveStatus(369);
                        this.ApproveVisibility = false;
                        if (this.IsInventoryVoucher)
                            this.SaveInventoryDocument_1(sender.toString());
                        else
                            this.SaveAccountingDocument(sender.toString());
                    }
                    if (this.IsPOs)
                        this.ButtonSaveandPrint.Visible = false;
                    break;
                case "NoWorkFlow":
                case "NoWorkFlowprint":
                    if (this.ScreenObject.DocID > 0 && this.IsUserLock) {
                        this.DisplayMessage = "Document is Locked";
                        return;
                    }
                    if (this.IsInventoryVoucher)
                        this.SaveInventoryDocument_1(sender);
                    else
                        this.SaveAccountingDocument(sender);
                    break;
                case "DocLink":
                    this.SetVisibiltiFalse();
                    this.DocLinkVisibility = true;
                    break;
                case "Addresses":
                    this.SetVisibiltiFalse();
                    this.AddressesVisibility = true;
                    break;
                case "Report":
                    this.SetVisibiltiFalse();
                    this.ReportInfoVisibility = true;
                    break;
                case "Documents":
                    this.SetVisibiltiFalse();
                    this.MappedDocsVisibility = true;
                    break;
                case "VacCrDaysDetail":
                    if (this.DocumentType == 72) {
                        let iEmpSeqNo = 0;
                        let field = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (field && (field instanceof PactListBoxData || field instanceof PactCodeNameListBoxData)) {
                            if (field instanceof PactListBoxData) {
                                if (field.SelectedValue > 0)
                                    iEmpSeqNo = field.SelectedValue;
                            }
                            else if (field instanceof PactCodeNameListBoxData) {
                                if (field.SelectedValue > 0)
                                    iEmpSeqNo = field.SelectedValue;
                            }
                        }
                        this.ShowVacationCreditDaysDetail(iEmpSeqNo);
                    }
                    break;
                case "Reject":
                    if ((this.ScreenObject.Preferences.ContainsKey("CommentsMandatoryforReject") && this.ScreenObject.Preferences["CommentsMandatoryforReject"] != "" && parseBoolean(this.ScreenObject.Preferences["CommentsMandatoryforReject"]))) {
                        if (this.Remarks.Text == null || this.Remarks.Text == "") {
                            this.DisplayMessage = "Remarks Mandatory For Reject";
                            return;
                        }
                    }
                    if (this.LineWiseApproval) {
                        let gtApp = new UpdateFieldsViewModel();
                        gtApp.UpdateFieldsViewModel_1(this);
                        BaseService.page.ShowDialog(gtApp, UpdateFieldComponent, { ShowCenter: true, HideHeader: true, HideClose: true });
                    }
                    else {
                        this.ApproveVisibility = false;
                        this.SaveStatus(372, 0, "");
                    }
                    if (this.IsPOs)
                        this.ButtonSaveandPrint.Visible = false;
                    break;
                case "ViewHistory":
                    if (this.ScreenObject.IsDocEdit)
                        BaseService.page.ShowDialog(new DocumentDraftsViewModel(this, 3), DocumentDraftsComponent);
                    break;
                case "ContinuousPrint":
                    btn = this.GetButton("Print");
                    if (btn == null || !btn.Visible)
                        return;
                    BaseService.page.ShowDialog(new ContinuousPrintViewModel(this), ContinuousPrintingComponent, { HideHeader: true, ShowCenter: true });
                    break;
                case "Bounce":
                    if (this.ScreenObject.IsDocEdit) {
                        this.SetVisibiltiFalse();
                        this.Bounce = new BounceDocViewModel(this);
                        BaseService.page.ShowDialog(this.Bounce, BounceDocumentComponent)
                    }
                    break;
                case "Enquiries":
                    BaseService.page.ShowDialog(new EnquiriesViewModel(this), EnquiriesComponent).subscribe(() => {
                        var Selcol = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.DisplayMember) && a.DisplayMember == "EnqSel");
                        if (Selcol != null)
                            Selcol.IsVisible = false;
                    });
                    break;
                case "Search":
                    this.ScreenObject.GridDataObj.SearchVisible = !this.ScreenObject.GridDataObj.SearchVisible;
                    break;
                case "ReviseHistory":
                    this.SetVisibiltiFalse();
                    this.DocHistoryVisibility = true;
                    this.DocHistory.Clear();
                    this.HistCols[0].IsVisible = true;
                    this.HistCols[1].IsVisible = true;
                    this.HistoryUpdateFooter = true;
                    let dsRevisehistory = this.ScreenObject.GetReviseHistory();
                    if (dsRevisehistory != null && dsRevisehistory.Tables.length > 0 && dsRevisehistory.Columns[0].Contains("ModifiedBy")) {
                        for (let i = 0; i < dsRevisehistory.Tables[0].length; i++) {
                            let dr = BaseService.slick.emptyObj();
                            dr["VersionNo"] = dsRevisehistory.Tables[0][i]["VersionNo"];
                            dr["ReviseReason"] = dsRevisehistory.Tables[0][i]["ReviseReason"];
                            dr["ModifiedBy"] = dsRevisehistory.Tables[0][i]["ModifiedBy"];
                            if (!Util.IsEmpty(dsRevisehistory.Tables[0][i]["ModifiedDate"])) {
                                dr["ModifiedDate"] = Util.ParseDate(dsRevisehistory.Tables[0][i]["ModifiedDate"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            }
                            this.DocHistory.push(dr);
                        }
                    }
                    BaseService.page.ShowDialog(this, DocHistoryComponent, { Title: "History" })
                    break;
                case "DocumentHistory":
                    this.SetVisibiltiFalse();
                    this.DocHistoryVisibility = true;
                    this.DocHistory.Clear();
                    this.RightTabSelectedIndex = 0;
                    this.HistCols[0].IsVisible = false;
                    this.HistCols[1].IsVisible = false;
                    this.HistoryUpdateFooter = true;
                    let dshistory = this.ScreenObject.GetDocumentHistory();
                    if (dshistory != null && dshistory.Tables.length > 0 && dshistory.Columns[0].Contains("ModifiedBy")) {
                        let maxid = 0;
                        for (let i = 0; i < dshistory.Tables[0].length; i++) {
                            let dr = BaseService.slick.emptyObj();
                            dr["ModifiedBy"] = dshistory.Tables[0][i]["ModifiedBy"];
                            if (!Util.IsEmpty(dshistory.Tables[0][i]["ModifiedDate"])) {
                                dr["ModifiedDate"] = Util.ParseDate(dshistory.Tables[0][i]["ModifiedDate"]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                            }
                            if (!Util.IsEmpty(dshistory.Tables[0][i]["maxid"])) {
                                if (maxid < parseInt(dshistory.Tables[0][i]["maxid"]))
                                    maxid = parseInt(dshistory.Tables[0][i]["maxid"]);
                                dr["maxid"] = dshistory.Tables[0][i]["maxid"].toString();
                            }
                            this.DocHistory.push(dr);
                        }
                        let drmx = this.DocHistory.filter(x => x.maxid == maxid);
                        if (drmx.length > 0)
                            drmx[0]["IsCurrent"] = "YES";
                    }
                    BaseService.page.ShowDialog(this, DocHistoryComponent, { Title: "History" })
                    break;
                case "LINK":
                    BaseService.page.ShowDialog(new LinkedVouchersViewModel(this), LinkedVouchersComponent)
                    break;
                case "LINKMAP":
                    if (!Util.IsEmpty(this.ScreenObject.VoucherNo))
                        BaseService.page.ShowDialog(new DocumentFlowChartViewModel(true, this.ScreenObject.VoucherNo, this.ScreenObject.CostCenterID, this.ScreenObject.IsInventory), DocumentFlowChartComponent);
                    break;
                case "CashDrawer":
                    if (this.ScreenObject.Data.Tables.length > 18 && this.ScreenObject.Data.Tables[18].length > 0) {
                        let drRow = this.ScreenObject.Data.Tables[18][0];
                        if (this.ScreenObject.RegisterNodeID > 0) {
                            let drRows = this.ScreenObject.Data.Tables[18].filter(x => x.NodeID == this.ScreenObject.RegisterNodeID);
                            if (drRows.length > 0 && drRows[0]["CashDrawPrintID"] != null && parseInt(drRows[0]["CashDrawPrintID"]) > 0) {
                                this.CashDrwerPrintID = parseInt(drRows[0]["CashDrawPrintID"]);
                                this.PrintVoucher(false, "-1", false, null);
                                this.CashDrwerPrintID = 0;
                            }
                            else if (drRows.length > 0 && !Util.IsEmpty(drRows[0]["CashDrawerName"]) && !Util.IsEmpty(drRows[0]["CashDrawerCommand"]))
                                this.OpenCashDrawer(drRows[0]["CashDrawerName"].toString(), drRows[0]["CashDrawerCommand"].toString());
                            else
                                return;
                        }
                        else if (drRow != null) {
                            this.OpenCashDrawer(drRow["CashDrawerName"].toString(), drRow["CashDrawerCommand"].toString());
                        }
                    }
                    break;
                case "ViewPaymentTerms":
                    let pay = new PaymentTermsViewModel();
                    pay.PaymentTermsViewModel_1(this, this.payTermXml)
                    BaseService.page.ShowDialog(pay, PaymentTermsComponent, { NoWidth: true });
                    break;
                case "TermsConditions":
                    BaseService.page.ShowDialog(new FieldCalculatorViewModel(this, -1), FieldCalculatorComponent, { ShowCenter: true });
                    break;
                case "Email":
                    this.ShowEmailSMS(true)
                    break;
                case "SMS":
                    this.ShowEmailSMS(false);
                    break;
                case "Close":
                    if (this.IsAutoPost && this.parent != null) {
                        this.DisplayMessage = "close";
                        BaseService.page.HideDialog(this.PopUpGUID);
                        return;
                    }
                    if ((this.ScreenObject.Preferences.ContainsKey("LcCloseDocument") && this.ScreenObject.Preferences["LcCloseDocument"] != "" && parseInt(this.ScreenObject.Preferences["LcCloseDocument"]) > 40000)) {
                        let DueAmt = 0;
                        let resu = this.ScreenObject.GetLCUsedAmt(parseInt(this.ScreenObject.GridData[0]["DocDetailsID"]));
                        if (resu != null && resu.Tables.length > 0) {
                            if (resu.Columns[0].Contains("amt") && resu.Tables[0].length > 0 && !Util.IsEmpty(resu.Tables[0][0]["amt"])) {
                                if (resu.Tables.length > 2) {
                                    if (resu.Columns[2].Contains("CLoseAmount") && resu.Tables[2].length > 0 && !Util.IsEmpty(resu.Tables[2][0]["CLoseAmount"])) {
                                        DueAmt = parseFloat(resu.Tables[0][0]["amt"]) - parseFloat(resu.Tables[2][0]["CLoseAmount"]);
                                    }
                                    else
                                        DueAmt = parseFloat(resu.Tables[0][0]["amt"]);
                                }
                                else
                                    DueAmt = parseFloat(resu.Tables[0][0]["amt"]);
                            }
                        }

                        if (DueAmt > 0) {
                            let AddEditVoucherViewModelWorkspace = new AddEditDocumentViewModel(parseInt(this.ScreenObject.Preferences["LcCloseDocument"]), "", false);

                            AddEditVoucherViewModelWorkspace.LCDueAmt = DueAmt;
                            if (AddEditVoucherViewModelWorkspace.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount != null) {
                                AddEditVoucherViewModelWorkspace.ScreenObject.CreditAccount.SelectedValue = this.ScreenObject.CreditAccount.SelectedValue;
                                if (this.ScreenObject.CreditAccount.Code != null)
                                    AddEditVoucherViewModelWorkspace.ScreenObject.CreditAccount.Code.SelectedValueText = this.ScreenObject.CreditAccount.Code.Text;
                                if (this.ScreenObject.CreditAccount.Name != null)
                                    AddEditVoucherViewModelWorkspace.ScreenObject.CreditAccount.Name.SelectedValueText = this.ScreenObject.CreditAccount.Name.Text;
                                if (resu != null && resu.Tables.length > 1 && resu.Tables[1].length > 0) {
                                    AddEditVoucherViewModelWorkspace.ScreenObject.CreditAccount.Code.CustomWhere =
                                        AddEditVoucherViewModelWorkspace.ScreenObject.CreditAccount.Name.CustomWhere = " a.AccountID in (" + resu.Tables[1][0]["account"].toString() + "," + resu.Tables[1][0]["MarginAccount"].toString() + "," + resu.Tables[1][0]["Traccount"].toString() + ") ";
                                }
                            }
                            else if (AddEditVoucherViewModelWorkspace.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")) {
                                let col = AddEditVoucherViewModelWorkspace.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "creditaccount_key");
                                if (col)
                                    col.FilterCondition = " a.AccountID in (" + resu.Tables[1][0]["account"].toString() + "," + resu.Tables[1][0]["MarginAccount"].toString() + "," + resu.Tables[1][0]["Traccount"].toString() + ") ";

                            }
                            AddEditVoucherViewModelWorkspace.ScreenObject.IsRefLCTR = true;
                            AddEditVoucherViewModelWorkspace.ScreenObject.RefCCId = 400;
                            if (this.ScreenObject.GridData.length > 0 && !Util.IsEmpty(this.ScreenObject.GridData[0]["DocDetailsID"]) && parseInt(this.ScreenObject.GridData[0]["DocDetailsID"]) > 0)
                                AddEditVoucherViewModelWorkspace.ScreenObject.RefNodeID = parseInt(this.ScreenObject.GridData[0]["DocDetailsID"]);

                            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"]) && parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) > 0) {
                                    if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"])) {
                                        if (AddEditVoucherViewModelWorkspace.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")) {
                                            AddEditVoucherViewModelWorkspace.ScreenObject.GridData[i]["CreditAccount_Key"] = this.ScreenObject.GridData[i]["CreditAccount_Key"].toString();
                                            let cols = AddEditVoucherViewModelWorkspace.ScreenObject.ColumnSource.filter(a => a.ValueMember != null && a.ValueMember != "" && a.ValueMember.toLowerCase() == "creditaccount_key");
                                            if (cols) {
                                                cols.forEach(item => {
                                                    if (AddEditVoucherViewModelWorkspace.ScreenObject.GridDataColumns.Contains(item.DisplayMember) && this.ScreenObject.GridDataColumns.Contains(item.DisplayMember))
                                                        AddEditVoucherViewModelWorkspace.ScreenObject.GridData[i][item.DisplayMember] = this.ScreenObject.GridData[i][item.DisplayMember].toString();
                                                });
                                            }
                                        }
                                        else if (AddEditVoucherViewModelWorkspace.ScreenObject.CreditAccount != null) {
                                            AddEditVoucherViewModelWorkspace.ScreenObject.CreditAccount.SelectedValue = parseInt(this.ScreenObject.GridData[i]["CreditAccount_Key"]);
                                        }
                                    }
                                    else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"])) {

                                        if (AddEditVoucherViewModelWorkspace.ScreenObject.GridDataColumns.Contains("DebitAccount_Key")) {
                                            AddEditVoucherViewModelWorkspace.ScreenObject.GridData[i]["DebitAccount_Key"] = this.ScreenObject.GridData[i]["DebitAccount_Key"].toString();
                                            let cols = AddEditVoucherViewModelWorkspace.ScreenObject.ColumnSource.filter(a => a.ValueMember != null && a.ValueMember != "" && a.ValueMember.toLowerCase() == "debitaccount_key");
                                            if (cols) {
                                                cols.forEach(item => {
                                                    if (AddEditVoucherViewModelWorkspace.ScreenObject.GridDataColumns.Contains(item.DisplayMember) && this.ScreenObject.GridDataColumns.Contains(item.DisplayMember))
                                                        AddEditVoucherViewModelWorkspace.ScreenObject.GridData[i][item.DisplayMember] = this.ScreenObject.GridData[i][item.DisplayMember].toString();
                                                });
                                            }
                                        }
                                        else if (AddEditVoucherViewModelWorkspace.ScreenObject.DebitAccount != null) {
                                            AddEditVoucherViewModelWorkspace.ScreenObject.DebitAccount.SelectedValue = parseInt(this.ScreenObject.GridData[i]["DebitAccount_Key"]);
                                        }
                                    }

                                    if (AddEditVoucherViewModelWorkspace.ScreenObject.GridDataColumns.Contains("Amount")) {
                                        AddEditVoucherViewModelWorkspace.ScreenObject.GridData[i]["Amount"] = DueAmt;
                                    }
                                    if (AddEditVoucherViewModelWorkspace.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && this.ScreenObject.CreditAccount != null) {
                                        AddEditVoucherViewModelWorkspace.ScreenObject.GridData[i]["CreditAccount"] = this.ScreenObject.CreditAccount.Text;
                                        AddEditVoucherViewModelWorkspace.ScreenObject.GridData[i]["CreditAccount_Key"] = this.ScreenObject.CreditAccount.SelectedValue;
                                    }
                                }
                            }
                            let retObj: IPage = { component: AddEditDocumentComponent, params: { obj: AddEditVoucherViewModelWorkspace } }
                            BaseService.page.addNewTab(retObj)
                        }
                        else {
                            this.DisplayMessage = "lc is already closed";
                            return;
                        }
                    }
                    else {
                        this.DialogResult = false;
                        BaseService.page.HideDialog(this.PopUpGUID);
                        return;
                    }
                    break;
                case "Convert":
                    this.SetVisibiltiFalse();
                    this.CaseVisibility = true;
                    if (this.ScreenObject.IsDocEdit) {
                        if (this.CaseList == null) {
                            this.CaseList = [];
                            this.CaseListColumns.push("CaseID");
                            this.CaseListColumns.push("CaseNumber");
                            this.CaseListColumns.push("CaseDate");
                            this.CaseListColumns.push("CaseDate_Key")//, typeof(Date));
                        }
                        else
                            this.CaseList.Clear();
                        let ds = this.ScreenObject.GetDocCases()
                        {
                            if (ds != null && ds.Tables.length > 16 && ds.Columns[16].Contains("CaseDate") && ds.Tables[16].length > 0) {

                                for (let i = 0; i < ds.Tables[16].length; i++) {
                                    if (this.CaseList.filter(x => x.CaseID == ds.Tables[16][i]["CaseID"]).length == 0) {
                                        let dr: any = {};
                                        dr["CaseID"] = Util.String(ds.Tables[16][i]["CaseID"]);
                                        dr["CaseNumber"] = Util.String(ds.Tables[16][i]["CaseNumber"]);
                                        if (!Util.IsEmpty(ds.Tables[16][i]["CaseDate"])) {
                                            dr["CaseDate_Key"] = Util.ParseDate(ds.Tables[16][i]["CaseDate"]);
                                            dr["CaseDate"] = Util.ParseDate(ds.Tables[16][i]["CaseDate"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                        }
                                        this.CaseList.push(dr);
                                    }
                                }
                            }
                        }
                    }
                    break;
                case "ConvertCase":
                    this.ConvertCase();
                    break;
                case "Export":
                    if (this.ScreenObject.IsDocEdit) {
                        if (this.StatusID == 376 && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Print/Export Cancelled")) {
                            this.DisplayMessage = "Documents is cancelled";
                            return;
                        }
                        if (this.StatusID == 371 && this.DoNotPrintUnApprovedDocuments) {
                            this.DisplayMessage = "Un-Approved Documents not allowed to export";
                            return;
                        }

                        let iVersionNo3 = -1;
                        if (this.ScreenObject.DocPrefix.RevisionCombo.Visible && this.ScreenObject.DocPrefix.RevisionCombo.Items.length > 1) {
                            if (this.ScreenObject.DocPrefix.RevisionCombo.SelectedValue != this.ScreenObject.DocPrefix.RevisionCombo.Items[this.ScreenObject.DocPrefix.RevisionCombo.Items.length - 1].Value)
                                iVersionNo3 = parseInt(this.ScreenObject.DocPrefix.RevisionCombo.SelectedValue);
                        }
                        this.Export(this.DocID, null, false, iVersionNo3);
                    }
                    break;/**
                case "Open":

                    System.Windows.Forms.OpenFileDialog oDlg = new System.Windows.Forms.OpenFileDialog();
                    oDlg.Filter = "Import files (*.rim)|*.rim";
                    if (oDlg.ShowDialog() == System.Windows.Forms.DialogResult.OK)
                    {
                        RimFileName = oDlg.SafeFileName;
                        try
                        {
                            XmlDocument xmlDoc = new XmlDocument();
                            xmlDoc.LoadXml(File.ReadAllText(oDlg.FileName));
                            if (xmlDoc != null)
                            {
                                foreach (XmlNode XNode in xmlDoc.DocumentElement.children[0].ChildNodes)
                                {
                                    for(let i = 0; i < DtImport.length; i++)
                                    {
                                        if ((i + 1).toString() == XNode.attributes.Item(0).value.toString())
                                            DtImport[i]["FeatureFieldName"] = XNode.attributes.Item(2).value.toString();
                                    }
                                }
                            }
                        }
                        catch(error)
                        {
                            DisplayMessage = ex.Message;
                            
                            return;
                        }
                    }
                    break;
                    ***/
                case "Import":
                    if (!this.IsImport) {
                        this.SortGrid(false);
                        BaseService.page.HideDialog(this.PopUpGUID);
                    }
                    else if (this.ExcelTable != null && this.ExcelTable.length > 0) {
                        // BackgroundWorker importWorker = new BackgroundWorker();
                        // importWorker.DoWork += new DoWorkEventHandler(importWorker_DoWork);
                        // importWorker.RunWorkerAsync();                      
                        if (this.DocumentType == 90 || this.DocumentType == 89) {
                            this.SetButtonVisibility("Save", true);
                        }
                        Util.SetPersonalize("ImportChunkSize", this.ImportChunkSize);
                        this.importWorker_DoWork(null, null);
                    }

                    break;
                case "SortVisiblity":
                    temp = new Array<DgColumn>();
                    this.DtImportObj.Clear();
                    objcolumn = new DgColumn();
                    objcolumn.DisplayMember = "Name";
                    objcolumn.ValueMember = "Value";
                    objcolumn.ValueBinding = "FieldName";
                    objcolumn.Header = "Column Name";
                    objcolumn.DataType = "ComboBox";
                    objcolumn.Width = 150;
                    aa = new Array<ComboBoxItems>();
                    aa.push(ComboBoxItems.ComboBoxItems_2("", ""));
                    this.ScreenObject.ColumnSource.forEach(item => {
                        if (!Util.IsEmpty(item.ValueBinding) && item.IsVisible) {
                            aa.push(ComboBoxItems.ComboBoxItems_2(item.Header, item.ValueBinding));
                        }
                        else if (!Util.IsEmpty(item.DisplayMember) && item.DisplayMember != "DocSeqNo" && item.IsVisible) {
                            if (this.ScreenObject.GridDataColumns.Contains(item.DisplayMember + "_Key") && (item.DataType == "DATE" || item.DataType == "DATETIME" || item.DataType == "TIME" || item.DataType == "Time2"))
                                aa.push(ComboBoxItems.ComboBoxItems_2(item.Header, item.DisplayMember + "_Key"));
                            else
                                aa.push(ComboBoxItems.ComboBoxItems_2(item.Header, item.DisplayMember));
                        }
                    });

                    objcolumn.ComboData = aa;
                    temp.push(objcolumn);
                    this.DtImportObj.TableColumns.push("FieldName");

                    objcolumn = new DgColumn();
                    objcolumn.DisplayMember = "Name";
                    objcolumn.ValueMember = "Value";
                    objcolumn.ValueBinding = "Order";
                    objcolumn.Header = "Order";
                    objcolumn.DataType = "ComboBox";
                    objcolumn.Width = 80;
                    aa = new Array<ComboBoxItems>();
                    aa.push(ComboBoxItems.ComboBoxItems_2("Ascending", "Asc"));
                    aa.push(ComboBoxItems.ComboBoxItems_2("Descending", "Desc"));
                    aa.push(ComboBoxItems.ComboBoxItems_2("Numeric Ascending", "NUM"));
                    aa.push(ComboBoxItems.ComboBoxItems_2("Numeric Descending", "NUMDesc"));

                    objcolumn.ComboData = aa;
                    temp.push(objcolumn);
                    this.DtImportObj.TableColumns.push("Order");

                    this.IsImport = false;
                    this.ImportCols = temp;
                    this.SetVisibiltiFalse();
                    this.ImportVisiblity = true;
                    this.RightTabSelectedIndex = 0;
                    this.DtImportObj.addEmptyRow();
                    this.DtImportObj.addEmptyRow();
                    this.DtImportObj.addEmptyRow();
                    this.DtImportObj.addEmptyRow();
                    this.DtImportObj.Height = 200;
                    BaseService.page.ShowDialog(this, ImportComponent, { ShowCenter: true && !BaseService.IsMobile, NoWidth: true, Title: "Sort" });
                    break;
                case "ImportVisiblity":
                    temp = [];
                    this.DtImportObj.Clear();
                    this.DtImportObj.Columns = [];
                    objcolumn = new DgColumn();
                    objcolumn.DisplayMember = "FieldName";
                    objcolumn.Header = BaseService.GetResource("Import_FieldName");
                    objcolumn.DataType = "TextBlock";
                    objcolumn.Width = 100;
                    objcolumn.ReadOnly = true;
                    temp.push(objcolumn);
                    this.DtImportObj.TableColumns.push("FieldName");

                    objcolumn = new DgColumn();
                    objcolumn.DisplayMember = "Name";
                    objcolumn.ValueMember = "Value";
                    objcolumn.ValueBinding = "FeatureFieldName";
                    objcolumn.Header = BaseService.GetResource("Import_FeatureFieldName");
                    objcolumn.DataType = "ComboBox";
                    objcolumn.Width = 120;
                    aa = [];
                    aa.push(ComboBoxItems.ComboBoxItems_2("", ""));
                    let tmpint;
                    if (this.DocumentType == 81) {
                        let fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                        if (fldAPV2 && fldAPV2 instanceof PactComboBoxData && Util.IsEmpty(fldAPV2.SelectedValue)) {
                            this.DisplayMessage = "Please select Year";

                            return;
                        }
                        fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                        if (fldAPV2 && fldAPV2 instanceof PactComboBoxData && Util.IsEmpty(fldAPV2.SelectedValue)) {
                            this.DisplayMessage = "Please select BasedOn";

                            return;
                        }
                    }
                    if (this.ScreenObject.IsPayrollDocument)
                        this.ImportCopyProductdata = true;

                    tmpint = Util.Int(this.ScreenObject.Preferences["ImpPrf"]);
                    if (this.ScreenObject.Preferences.ContainsKey("ImpPrf") && tmpint > 0) {
                        let dsimp = BaseService.admin.GetImportDetails(tmpint, true);
                        if (dsimp != null && dsimp.Tables.length > 0 && dsimp.Tables[0].length > 0) {
                            objcolumn.DefaultValue = dsimp.Tables[0][0]["FileName"].toString();
                            objcolumn.DefaultValueText = dsimp.Tables[0][0]["Structure"].toString();
                        }
                    }
                    this.ScreenObject.ColumnSource.forEach(item => {
                        if (!Util.IsEmpty(item.DisplayMember) && item.IsVisible) {
                            //CC
                            if (item.DisplayMember == "DocSeqNo")
                                aa.push(ComboBoxItems.ComboBoxItems_2(item.Header, "100"));
                            else if (item.CostCenterID > 50000 && item.DisplayMember.endsWith("Code"))
                                aa.push(ComboBoxItems.ComboBoxItems_5(item.Header, "-" + item.ID, true, !Util.IsEmpty(item.ValueMember) ? item.ValueMember.Replace("_Key", "") : ""));
                            else if (item.CostCenterID == 3)
                                aa.push(ComboBoxItems.ComboBoxItems_6(item.Header, "-" + item.ID, true, !Util.IsEmpty(item.ValueMember) ? item.ValueMember.Replace("_Key", "") : "", !Util.IsEmpty(item.DefaultValue) ? item.DefaultValue.toString() : "0"));
                            else
                                aa.push(ComboBoxItems.ComboBoxItems_5(item.Header, item.ID, true, !Util.IsEmpty(item.ValueMember) ? item.ValueMember.Replace("_Key", "") : ""));
                            //CC
                        }
                        else if (!Util.IsEmpty(item.DisplayMember) && item.CostCenterID == 3) {
                            aa.push(ComboBoxItems.ComboBoxItems_6(item.Header, item.ID, true, !Util.IsEmpty(item.ValueMember) ? item.ValueMember.Replace("_Key", "") : "", !Util.IsEmpty(item.DefaultValue) ? item.DefaultValue.toString() : "0"));
                        }
                    });

                    this.ScreenObject._StaticFields.forEach(item => {
                        if (!Util.IsEmpty(item.DBColumnName)) {
                            aa.push(ComboBoxItems.ComboBoxItems_2(item.Label, item.DBColumnID.toString()));
                        }
                    });


                    this.ScreenObject._TextFields.forEach(item => {

                        if (!Util.IsEmpty(item.DBColumnName)) {
                            aa.push(ComboBoxItems.ComboBoxItems_2(item.Label, item.DBColumnID.toString()));
                        }
                    });

                    this.ScreenObject._CCFields.forEach(item => {
                        if (!Util.IsEmpty(item.DBColumnName)) {
                            //CC
                            if (item instanceof PactCodeNameListBoxData)
                                aa.push(ComboBoxItems.ComboBoxItems_2(item.Label.replace("*", "") + "Code", "-" + item.DBColumnID.toString()));
                            //CC

                            aa.push(ComboBoxItems.ComboBoxItems_2(item.Label, item.DBColumnID.toString()));
                        }
                    })


                    aa.push(ComboBoxItems.ComboBoxItems_2("BatchNumber", "-500"));
                    //
                    if (this.ScreenObject.Preferences.ContainsKey("SnoBasedLinking") && this.ScreenObject.Preferences["SnoBasedLinking"] != "" && parseBoolean(this.ScreenObject.Preferences["SnoBasedLinking"]))
                        aa.push(ComboBoxItems.ComboBoxItems_2("RefSNo", "-501"));
                    //
                    objcolumn.ComboData = aa;
                    temp.push(objcolumn);
                    this.DtImportObj.TableColumns.push("FeatureFieldName");
                    this.IsImport = true;
                    this.ImportCols = temp;
                    this.ImportChunkSize = BaseService.SessionManager.PersonalSettings.ContainsKey("ImportChunkSize") ? BaseService.SessionManager.PersonalSettings["ImportChunkSize"] : "5";
                    this.SetVisibiltiFalse();
                    this.ImportVisiblity = true;
                    this.RightTabSelectedIndex = 0;
                    let titleDisplay = !this.IsImport ? "Sort" : "Import";
                    this.DtImportObj.Height = 300;
                    BaseService.page.ShowDialog(this, ImportComponent, { NoWidth: true, Title: titleDisplay });
                    break;
                /**
            case "openfile":
                Microsoft.Win32.OpenFileDialog fileDialog = new Microsoft.Win32.OpenFileDialog();
                fileDialog.CheckFileExists = true;
                fileDialog.Filter = "Excel files (*.xls, *.xlsx)|*.xls;*.xlsx|All files (*.*)|*.*";
                if ((bool)fileDialog.ShowDialog())
                {
                    if (!Util.IsEmpty(ImportCols[1].DefaultValue) && fileDialog.SafeFileName != ImportCols[1].DefaultValue)
                    {
                        DisplayMessage = "File name mismatch, select file name (" + ImportCols[1].DefaultValue + ") ";
                        
                        return;
                    }

                    try
                    {
                        let dsexcel = new DataSet();
                        ActualFileName = fileDialog.SafeFileName;
                        ImportFileName = fileDialog.FileName.ToString();
                        string str = "Provider=Microsoft.ACE.OLEDB.12.0; Data Source=" + fileDialog.FileName.toString() + "; Extended Properties='Excel 12.0;HDR=YES;IMEX=1'";
                        string DBAdapterAccess = System.Configuration.ConfigurationManager.AppSettings["DBAdapterAccess"];
                        System.Data.OleDb.OleDbConnection oCon = new System.Data.OleDb.OleDbConnection(str);
                        oCon.Open();
                        System.Data.OleDb.OleDbDataAdapter da = new System.Data.OleDb.OleDbDataAdapter("SELECT * FROM [" + ActualFileName.split('.')[0] + "$]", oCon);
                        da.Fill(dsexcel);
                        ExcelTable = dsexcel.Tables[0];
                        oCon.Close();
                        DtImport.Clear();
                        for(let i = 0; i < ExcelDataColumn.length; i++)
                        {
                            let dr = DtImport.NewRow();
                            dr[0] = ExcelTable.Columns[i].ColumnName;
                            DtImport.Rows.push(dr);
                        }

                        if (!Util.IsEmpty(ImportCols[1].DefaultValueText))
                        {
                            XmlDocument xmlDoc = new XmlDocument();
                            xmlDoc.LoadXml(ImportCols[1].DefaultValueText);
                            if (xmlDoc != null)
                            {
                                foreach (XmlNode XNode in xmlDoc.DocumentElement.children[0].ChildNodes)
                                {
                                    for(let i = 0; i < DtImport.length; i++)
                                    {
                                        if ((i + 1).toString() == XNode.attributes.Item(0).value.toString())
                                            DtImport[i]["FeatureFieldName"] = XNode.attributes.Item(2).value.toString();
                                    }
                                }
                            }
                        }
                    }
                    catch(error)
                    {
                        DisplayMessage = ex.Message;
                        
                        return;
                    }
                }
                break;***/
                case "BarcodePrint":
                    if (this.ScreenObject.DocID > 0 && this.ButtonBarcode.Visible && this.ButtonBarcode.Enable)
                        this.ExportBarcode(this.ScreenObject.DocID.toString(), null);
                    break;
                /*** case "BarcodePrintLine":
                     if (this.ScreenObject.DocID > 0 && ButtonBarcode.Visible && ButtonBarcode.Enable)
                     {
                         DisplayMessage = "";
                         if (this.ScreenObject.SelectedGridRowIndex <= -1)
                         {
                             DisplayMessage = "Select Row";
                         }
                         else
                         {
                             let LineID;
                             Util.Int(this.ScreenObject.GridData[this.ScreenObject.SelectedGridRowIndex]["DocDetailsID"].toString(), out LineID);
                             if (LineID <= 0)
                                 DisplayMessage = "Select Row";
                             else
                                 PrintBarcode(this.ScreenObject.DocID.toString(), LineID.toString());
                         }
                     }
                     break;
                 case "BarcodePrintMultiple":
                     if (this.ScreenObject.DocID > 0 && ButtonBarcode.Visible && ButtonBarcode.Enable)
                     {
                         DisplayMessage = "";
                         BarcodeDialogViewModel oBar = new BarcodeDialogViewModel(this);
                         ShellWindowViewModel.Instance().PopViewModel = oBar;
                         if (oBar.sb.length != 0)
                             PrintBarcode(this.ScreenObject.DocID.toString(), oBar.sb.toString());
                     }
                     break;
                 case "GenerateForecast":
                     DisplayMessage = this.ScreenObject.ForecastObj.Generate();
                     if (DisplayMessage == "")
                         OnPropertyChanged("ColumnSource");
                     break;
     ***/
                case "DistributeInstallments":
                    let Basedon = "";
                    if (this.ScreenObject.Preferences.ContainsKey("Distributebasedon") && !Util.IsEmpty(this.ScreenObject.Preferences["Distributebasedon"])) {
                        let bsedonfld = this.ScreenObject._TextFields.find(a => a.DBColumnID.toString() == this.ScreenObject.Preferences["Distributebasedon"]);
                        if (bsedonfld && bsedonfld instanceof PactComboBoxData && !Util.IsEmpty(bsedonfld.SelectedValue))
                            Basedon = bsedonfld.SelectedValue.toLowerCase();
                    }
                    if (Basedon == "") {
                        this.DisplayMessage = this.IsDateValid(null, "");
                        if (this.DisplayMessage != "") {
                            return;
                        }
                    }
                    this.DistributeInstallments(Basedon);
                    break;
                case "FillDates":
                    this.FillDates_Click();
                    break;
                case "FillGeneralTimings":
                    this.FillGeneralTimings_Click();
                    break;

                case "GetAllEmployees":
                    let txtDatefldEmp = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1") as PactExtraFieldDateData;
                    if (txtDatefldEmp && txtDatefldEmp instanceof PactExtraFieldDateData && !txtDatefldEmp.Date) {
                        this.DisplayMessage = "Select the daily attendance date";
                        txtDatefldEmp.SetFocus = true;
                        return;
                    }
                    if (txtDatefldEmp != null) {
                        let CurrentdateEmp = txtDatefldEmp.Date;
                        this.GetAllEmployees(CurrentdateEmp, this.DocID, this.strEmpFilter);
                    }
                    break;
                case "GetPreviousDay":
                    let txtDatefld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1") as PactExtraFieldDateData;
                    if (txtDatefld && txtDatefld instanceof PactExtraFieldDateData && !txtDatefld.Date) {
                        this.DisplayMessage = "Select the daily attendance date";
                        txtDatefld.SetFocus = true;
                        return;
                    }
                    let Currentdate = txtDatefld.Date;
                    this.GetPreviousDay(Currentdate);
                    break;
                case "DailyAttendanceFilter":
                    if (this.CostCenterID == 40097) {
                        let txtDatefld1 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha16") as PactExtraFieldDateData;
                        if (txtDatefld1 != null && txtDatefld1 instanceof PactExtraFieldDateData && !txtDatefld1.Date) {
                            this.DisplayMessage = "Select Payroll Month";

                            txtDatefld1.SetFocus = true;
                            return;
                        }
                        let dtPM = new Date(txtDatefld1.Date.getFullYear(), txtDatefld1.Date.getMonth(), 1);

                        let sEmpSeqNos = await this.EmpFilter_Click(dtPM);
                        if (sEmpSeqNos.length > 0) {
                            this.ScreenObject.GridDataObj.Clear();
                            this.DoLateConsiderations(sEmpSeqNos);
                            this.IsLatesProcessTimingsUpdated = false;
                        }
                        return;
                    }
                    this.strEmpFilter = "";
                    this.strEmpFilter = this.PopupEmployeesFilter("", "DailyAttendanceFilter");
                    // this code will work if emp filter popup didn't appear;
                    this.DailyAttendanceFilterTemp();
                    break;
                case "Rotation":
                    const { ShiftAssignRotationViewModel } = await import('../../ess/shift-assign-rotation/ShiftAssignRotationViewModel')
                    const { ShiftAssignRotationComponent } = await import('../../ess/shift-assign-rotation/shift-assign-rotation.component')
                    let objSAR = new ShiftAssignRotationViewModel();
                    BaseService.page.ShowDialog(objSAR, ShiftAssignRotationComponent, { ShowCenter: true }).subscribe(x => {

                        if (objSAR.DialogResult) {
                            this.dtShiftAssRot = objSAR.dtRotData;
                            this.LoadShiftAssignRotationData();
                        }
                    })
                    break;
                case "GenerateOnDuty":
                    if (this.DocumentType == 103) {
                        let SelectedEmpID = 0;

                        let DimLTfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (DimLTfld != undefined && DimLTfld instanceof PactListBoxData && DimLTfld.SelectedValue > 0)
                            SelectedEmpID = DimLTfld.SelectedValue;
                        else if (DimLTfld != undefined && DimLTfld instanceof PactCodeNameListBoxData && DimLTfld.SelectedValue > 0)
                            SelectedEmpID = DimLTfld.SelectedValue;

                        if (SelectedEmpID == 0) {
                            this.DisplayMessage = "Please select the employee";
                            this.MessageVisibility = true;
                            return;
                        }

                        this.LoadODData(SelectedEmpID.toString());
                    }
                    break;
                case "Validate":
                    if (this.DocumentType == 67) {
                        this.isDAValidate = true;
                        this.sDAErrLogs = "";
                        this.DisplayMessage = this.CheckDocumentValidations("");
                        this.isDAValidate = false;
                        if (this.sDAErrLogs != "") {
                            this.DisplayMessage = this.sDAErrLogs;
                            this.MessageVisibility = true;
                            return;
                        }
                        else {
                            this.DisplayMessage = "Validated Succesfully";
                            this.MessageVisibility = true;
                            return;
                        }
                    }
                    break;
                case "DefineDays":
                    const { VacationDefineDaysComponent } = await import('../../ess/vacation-define-days/vacation-define-days.component')
                    const { VacationDefineDaysViewModel } = await import('../../ess/vacation-define-days/VacationDefineDaysViewModel')
                    let objVDD = new VacationDefineDaysViewModel(this.DocID, this.dtVacDefineDays);
                    BaseService.page.ShowDialog(objVDD, VacationDefineDaysComponent, { ShowCenter: true }).subscribe(x => {
                        if (objVDD.DialogResult) {
                            this.dtVacDefineDays = objVDD.dtVacDefineDays;
                        }
                    });
                    break;
                case "LoanGuarantees":
                    const { LoanGuaranteesViewModel } = await import('../../ess/loan-guarantees/LoanGuaranteesViewModel')
                    const { LoanGuaranteesComponent } = await import('../../ess/loan-guarantees/loan-guarantees.component')
                    let objLG = new LoanGuaranteesViewModel(this.DocID, this.dtLoanGuarantees);
                    BaseService.page.ShowDialog(objLG, LoanGuaranteesComponent, { ShowCenter: true }).subscribe(x => {
                        if (objLG.DialogResult) {
                            this.dtLoanGuarantees = objLG.dtLoanGuarantees;
                        }
                    });
                    break;
                case "VacationContract":
                    if (this.DocumentType == 72 && this.ScreenObject.DocID > 0) {
                        if (this.dtVacContract == null) {
                            let dtVC: any = BaseService.common.GetDataTable("DOC064", this.ScreenObject.DocID.toString());
                            if (dtVC != null && dtVC.length > 0) {
                                this.dtVacContract = [];//new DataTable();
                                this.dtVacContractColumns.push("Select")//, typeof(bool));
                                this.dtVacContractColumns.push("Sno");
                                this.dtVacContractColumns.push("ContractNodeID");
                                this.dtVacContractColumns.push("ContractCode");
                                this.dtVacContractColumns.push("ContractName");
                                this.dtVacContractColumns.push("ContractFrom");
                                this.dtVacContractColumns.push("ContractTo");
                                this.dtVacContractColumns.push("CreditedDays")//, typeof(double));
                                this.dtVacContractColumns.push("PrevTakenDays")//, typeof(double));
                                this.dtVacContractColumns.push("BalanceDays")//, typeof(double));
                                this.dtVacContractColumns.push("CanAvail")//, typeof(double));***/

                                let drw: any;
                                for (let i = 0; i < dtVC.length; i++) {
                                    drw = {};//this.dtVacContract.NewRow();
                                    drw["Select"] = true;
                                    drw["SNo"] = dtVC[i]["Sno"].toString();
                                    drw["ContractNodeID"] = dtVC[i]["ContractNodeID"].toString();
                                    drw["ContractCode"] = dtVC[i]["ContractCode"].toString();
                                    drw["ContractName"] = dtVC[i]["ContractName"].toString();
                                    drw["ContractFrom"] = dtVC[i]["ContractFrom"].toString();
                                    drw["ContractTo"] = dtVC[i]["ContractTo"].toString();
                                    drw["CreditedDays"] = parseFloat(dtVC[i]["CreditedDays"]);
                                    drw["PrevTakenDays"] = parseFloat(dtVC[i]["PrevTakenDays"]);
                                    drw["BalanceDays"] = parseFloat(dtVC[i]["BalanceDays"]);
                                    drw["CanAvail"] = parseFloat(dtVC[i]["CanAvail"]);
                                    this.dtVacContract.push(drw);
                                }

                            }
                        }
                        this.isVacPopup = true;
                        this.ApplyVacationContract();
                        this.isVacPopup = false;
                    }

                    break;
                /**case "DATCustomize":
                    ShellWindowViewModel.Instance().PopViewModel = ShellWindowViewModel.RibbonExtViewModel.GetPAY_ConsolidatedMonthlyCustomizationViewModel(this);
                    break;
                   **/
                case "TabsPopUp":
                    // const { DocOptionsComponent } = await import('../doc-options/doc-options.component')
                    // const { DocOptionsViewModel } = await import('../doc-options/DocOptionsViewModel')
                    let Dovm = new DocOptionsViewModel(this, 1);
                    for (let i = 0; i < Dovm.Parent.ScreenObject.HeaderFields.length; i++) {
                        if (Dovm.Parent.ScreenObject.HeaderFields[i] instanceof PactComboTextData || Dovm.Parent.ScreenObject.HeaderFields[i] instanceof PactVoucherDateData || Dovm.Parent.ScreenObject.HeaderFields[i] instanceof PactDatePickerData || Dovm.Parent.ScreenObject.HeaderFields[i] instanceof PactListBoxData || Dovm.Parent.ScreenObject.HeaderFields[i] instanceof PactCodeNameListBoxData)
                            Dovm.Parent.ScreenObject.HeaderFields[i].IsReadOnly = false;
                    }
                    BaseService.page.ShowDialog(Dovm, DocOptionsComponent, { ShowCenter: true, NoWidth: true }).subscribe(() => {
                        for (let i = 0; i < Dovm.Parent.ScreenObject.HeaderFields.length; i++) {
                            if (Dovm.Parent.ScreenObject.HeaderFields[i] instanceof PactComboTextData || Dovm.Parent.ScreenObject.HeaderFields[i] instanceof PactVoucherDateData || Dovm.Parent.ScreenObject.HeaderFields[i] instanceof PactDatePickerData || Dovm.Parent.ScreenObject.HeaderFields[i] instanceof PactListBoxData || Dovm.Parent.ScreenObject.HeaderFields[i] instanceof PactCodeNameListBoxData)
                                Dovm.Parent.ScreenObject.HeaderFields[i].IsReadOnly = true;
                        }
                    });

                    break;

                case "LinkInfo":
                    this.OLinkSelectionChanged(null);
                    let Dovm2 = new DocOptionsViewModel(this, 2);
                    BaseService.page.ShowDialog(Dovm2, DocOptionsComponent, { ShowCenter: true, NoWidth: true });
                    //ShellWindowViewModel.Instance().PopViewModel = new DocOptionsViewModel(this, 2);
                    break;
                case "SkuSearch":
                    let lst = new PactListBoxData();
                    if (BaseService.SessionManager.Preferences.ContainsKey("POSItemCodeDimension") && Util.Int(BaseService.SessionManager.Preferences["POSItemCodeDimension"]) > 50000) {
                        var stkcol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID.toString() == BaseService.SessionManager.Preferences["POSItemCodeDimension"]);
                        if (stkcol && this.ScreenObject.GridDataColumns.Contains(stkcol.DisplayMember)) {
                            lst.CCID = parseInt(BaseService.SessionManager.Preferences["POSItemCodeDimension"]);
                            if (stkcol) {
                                lst.TypeID = stkcol.TypeID;
                                lst.Label = stkcol.Header;
                            }
                            else {
                                lst.TypeID = 1; lst.Label = "Stock Code";
                            }
                        }
                    }
                    else {
                        let Prodcol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 3 && a.DisplayMember == "ProductCode");
                        let lst = new PactListBoxData();
                        lst.CCID = 3;
                        if (Prodcol) {
                            lst.TypeID = Prodcol.TypeID;
                            lst.Label = Prodcol.Header;
                        }
                        else {
                            lst.TypeID = 1; lst.Label = "product";
                        }
                        lst.SelectedValue = -1;
                    }
                    let searchlist = new PactListSearchViewModel(lst);
                    BaseService.page.ShowDialog(searchlist, PactListBoxComponent);

                    if (lst.SelectedValue > 0 && lst.SelectedValue > 0) {
                        let RowPos = this.GetEmptyRowPosition(this.ScreenObject.GridDataObj, "ProductID_Key");
                        let dr = this.ScreenObject.GridData[RowPos];

                        dr["ProductID_Key"] = lst.SelectedValue;
                        if (this.IsSales == "0") {
                            dr["Quantity"] = -1;
                            this.RowForegroundChange(dr);
                        }
                        else
                            dr["Quantity"] = 1;
                        this.ProdID = 0;
                        this.Celleditend(dr, "ProductCode", 3);
                        this.PoleDisplayMessage(2, dr);
                    }
                    else {
                        if (!Util.IsEmpty(lst.Text))
                            this.onSKUSearch(lst.Text);
                    }

                    break;
                case "ReturnLine":
                    if (this.SelectedRow != null && !Util.IsEmpty(this.SelectedRow["Quantity"])) {
                        this.SelectedRow["Quantity"] = parseFloat(this.SelectedRow["Quantity"]) * -1;
                        this.CalculateTotals(this.SelectedRow, false, "Quantity");
                        this.RowForegroundChange(this.SelectedRow, (parseFloat(this.SelectedRow["Quantity"]) > 0) ? true : false);
                    }
                    break;
                case "DeleteLine":
                    if (this.SelectedRow != null) {
                        if (this.CanDeleteRow(this.SelectedRow))
                            this.OnBeforeRowDeleting(this.SelectedRow, true);
                    }
                    break;
                case "Docs":
                    let doclst = new PactListBoxData();
                    doclst.CCID = 400;
                    doclst.TypeID = 2;
                    doclst.CustomWhere = " a.CostCenterID=" + this.CostCenterID + " and dcCCNID" + (BaseService.SessionManager.RegisterCCID - 50000).toString() + "=" + this.ScreenObject.RegisterNodeID;
                    let docsearchlist = new PactListSearchViewModel(doclst);
                    //docsearchlist.Title = BaseService.GetResource("SelectDocument");
                    BaseService.page.ShowDialog(docsearchlist, PactListSearchComponent, { ShowCenter: true, Title: BaseService.GetResource("SelectDocument") }).subscribe(() => {
                        if (Util.IsValidID(doclst.SelectedValue)) {
                            let ref_Ddate = { value: this._Ddate }
                            this.ScreenObject.OnDocPrefixChanged("lostFocus", 0, doclst.SelectedValue, ref_Ddate, true);
                            this._Ddate = ref_Ddate.value
                        }
                    });
                    break;
                case "SalesReturn":
                    let rtnbtn = this.ButtonsLeft.find(a => a.ComParam == "SalesReturn");
                    if (rtnbtn) {
                        if (Util.IsEmpty(rtnbtn.ToolTipFooterDescription))
                            rtnbtn.ToolTipFooterDescription = rtnbtn.ToolTipDescription;
                        if (rtnbtn.ToolTipFooterDescription == rtnbtn.ToolTipDescription) {
                            rtnbtn.ToolTipDescription = "#df4b33";
                            this.IsSales = "0";
                        }
                        else {
                            rtnbtn.ToolTipDescription = rtnbtn.ToolTipFooterDescription;
                            this.IsSales = "1";
                        }
                    }
                    break;
                case "ALCopy":
                    if (this.DocID > 0) {
                        let ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                        if (ALfld && ALfld instanceof PactExtraFieldDateData && ALfld.Date) {
                            let ALfld1 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                            if (ALfld1 && ALfld1 instanceof PactComboBoxData) {
                                if (ALfld1.SelectedValue.toString() == "GradeWise") {
                                    const { CopyLeavesFromViewModel } = await import('../../ess/copy-leaves-from/CopyLeavesFromViewModel')
                                    const { CopyLeavesFromComponent } = await import('../../ess/copy-leaves-from/copy-leaves-from.component')
                                    let ObjCopyLeaves = new CopyLeavesFromViewModel(this);
                                    BaseService.page.ShowDialog(ObjCopyLeaves, CopyLeavesFromComponent, { ShowCenter: true }).subscribe(x => {
                                        this.LeavesBasedon("GradeWise");
                                    });
                                }
                            }
                        }
                    }
                    break;
                /**case "ExportFailedRecords":
                    string sb = "";
                    sb+="<html><body style='color:blac;background-color:white;'>");
                    sb+="<style>";
                    sb+=".hdr{text-align:cente; padding:5px; background-color:#4F81BD;color:white;font-family:Arial;font-size:11pt} ");
                    sb+=".alt{background-color:whitesmok; color:black; font-family:arial; font-size:9pt; align:left;}");
                    sb+="</style>";

                    sb+="<table border=1 width='450' style='border-collapse:collaps;  font-family:arial; font-size:9pt;' >");
                    sb+="<tr><td class='hdr'><b>Sno<b></td>";
                    sb+="<td class='hdr' width='150'><b>Failed Records<b></td>";
                    sb+="<td class='hdr' width='250'><b>Message<b></td></tr>";

                    for(let i = 0; i < FailedRecourdList.length; i++)
                    {
                        sb+="<tr";
                        sb+=">";
                        sb+="<td align='left' >"+i + 1+"</td>";
                        sb+="<td align='left' >"+Util.IsEmpty(FailedRecourdList[i].Name) ? "" : FailedRecourdList[i].Name+"</td>";
                        sb+="<td align='left' >"+Util.IsEmpty(FailedRecourdList[i].Message) ? "" : FailedRecourdList[i].Message+"</td>";
                        sb+="</tr>";
                    }
                    sb+="</table>";
                    sb+="</body>";
                    sb+="</html>";

                    System.Windows.Forms.SaveFileDialog sDlg = new System.Windows.Forms.SaveFileDialog();
                    sDlg.Filter = "(*.xls)|*.xls";
                    if (sDlg.ShowDialog() == System.Windows.Forms.DialogResult.OK)
                    {
                        try
                        {
                            System.IO.File.WriteAllText(sDlg.FileName, sb.toString());
                            DisplayMessage = "Exported Successfully";
                            
                        }
                        catch
                        {
                            DisplayMessage = "Error in Exporting";
                            
                        }
                    }
                    break;
                    **/
                case "AssignVPT":
                    let oAssign = new AssignReportViewModel(0, "AssignVPTFromDocument", this);
                    BaseService.page.ShowDialog(oAssign, AssignReportComponent, { HideClose: false, ShowCenter: true, Title: BaseService.GetResource("Assign") })
                    break;
                case "Assign":
                    if (this.ScreenObject.DocID > 0) {
                        let tempassing = new AssignReportViewModel(0, this.ScreenObject.VoucherNo, this, 1)
                        BaseService.page.ShowDialog(tempassing, AssignReportComponent, { HideClose: false, ShowCenter: true, Title: BaseService.GetResource("Assign") })
                    }

                    break;
                default:
                    let templong = Util.IntegerValue(sender.toString());
                    if (sender != null && parseInt(sender) > 0) {
                        const { AddEditCaseComponent } = await import('../../crm/add-edit-case/add-edit-case.component')
                        const { AddEditCasesViewModel } = await import('../../crm/add-edit-case/AddEditCasesViewModel')

                        let Cases = new AddEditCasesViewModel(parseInt(sender), 1, true);

                        let retObj: IPage = { component: AddEditCaseComponent, params: { obj: Cases } }
                        BaseService.page.addNewTab(retObj);
                    }
                    break;
            }
        }
    }

    private StartBluetoothPrint(nDocID: number) {
        let docAbbr = this.ScreenObject.Data.Tables[3][0]["DocumentAbbr"]
        if (docAbbr.toLowerCase() == 'bfi') {

            this.DisplayMessage = "";
            if (!BaseService.SessionManager.IsActionAssigned(43, "Allow Re-Print")) {
                let ds = VoucherExportExcel.AllowRePrint(this.DocumentID, 0, nDocID);
                if (parseInt(ds.Tables[0][0]["PrintCount"]) > 0) {
                    this.DisplayMessage = "Re-Print Not Allowed";
                    return;
                }
            }

            let iVersionNo = -1;
            if (this.ScreenObject.DocPrefix.RevisionCombo.Visible && this.ScreenObject.DocPrefix.RevisionCombo.Items.length > 1) {
                if (this.ScreenObject.DocPrefix.RevisionCombo.SelectedValue != this.ScreenObject.DocPrefix.RevisionCombo.Items[this.ScreenObject.DocPrefix.RevisionCombo.Items.length - 1].Value)
                    iVersionNo = parseInt(this.ScreenObject.DocPrefix.RevisionCombo.SelectedValue);
            }

            this.DisplayMessage = this.PrintVoucher(false, nDocID.toString(), true, null, iVersionNo, null, false, "", false, null, true);
            if (this.IsPOs && this.SKU != null && this.SKU.Visible && this.SKU.IsTabStop)
                this.SKU.SetFocus = true;

        } else {
            BaseService.SessionManager.DocCCID = this.CostCenterID
            let document = new ConfirmationDocument(this.CostCenterID, nDocID + '', docAbbr, '', '', this);
            let dm = document.PrintSI();
            if (dm.length > 0) {
                this.DisplayMessage = dm;
                this.MessageVisibility = true;
            }
        }
    }

    // Name : LoadPriceChart
    // Desc : Add price chart document open in new tab on button click.
    // Category : COMMON
    async LoadPriceChart() {
        const { AddPriceChartComponent } = await import('../../inventory/master-tabs/add-price-chart/add-price-chart.component')
        const { AddPriceChartNewViewModel } = await import('../../inventory/master-tabs/add-price-chart/AddPriceChartNewViewModel')

        let oPriceChartViewModel = new AddPriceChartNewViewModel("DOCUMENT", 0, 0);
        let retObj: IPage = { component: AddPriceChartNewViewModel, params: { obj: oPriceChartViewModel } }
        BaseService.page.addNewTab(retObj);
    }

    // Name : ShowEmailSMS
    // Desc : Email or SMS popup open on button click.
    // Category : COMMON
    ShowEmailSMS(IsEmail) {
        if (this.ScreenObject.IsDocEdit) {
            if (this.StatusID != 369 && this.DoNotEmailSMSUnApprovedDocuments)
                this.DisplayMessage = "Un-Approved Documents not allowed to Email/SMS";
            else {
                BaseService.page.ShowDialog(new SendEmailSMSViewModel(IsEmail, this.CostCenterID, this.DocID, this), SendEmailSMSComponent);
            }
        }
    }

    // Name : ReleaseJob
    // Desc : ?
    // Category : COMMON
    ReleaseJob() {
        let linkdoc = new LinkDocument(this, this.ScreenObject.VoucherNo, 0, 0, false);
        //ShellWindowViewModel.Instance().PopViewModel = linkdoc;

        BaseService.page.ShowDialog(linkdoc, LinkSelectiveComponent, { ShowCenter: true && !BaseService.IsMobile });

    }

    // Name : SearchData
    // Desc : populating Voucher List of document in a grid.
    // Category : COMMON
    public async SearchData() {
        try {
            let fld: any = this.ScreenObject.HeaderFields.find(a => a instanceof PactTextBoxData && a.DBColumnName == this.sSearchColName);
            if (fld == null)
                fld = this.ScreenObject._TextFields.find(a => a instanceof PactTextBoxData && a.DBColumnName == this.sSearchColName);
            if (fld == null)
                fld = this.ScreenObject._StaticFields.find(a => a instanceof PactTextBoxData && a.DBColumnName == this.sSearchColName);

            if (fld != null && !Util.IsEmpty(fld.Text)) {
                const { VouchersListViewModel } = await import('../../document/vouchers-list-view-model/VouchersListViewModel')
                const { VouchersListViewModelComponent } = await import('../../document/vouchers-list-view-model/vouchers-list-view-model.component')
                let objVouchList = new VouchersListViewModel(this.CostCenterID, fld.DBColumnName, fld.Text, this.ScreenObject.IsInventory ? 1 : 0, this);
                BaseService.page.ShowDialog(objVouchList, VouchersListViewModelComponent, { ShowCenter: true })
            }
        }
        catch (Exception) {

        }
    }

    // Name : SearchData
    // Desc : confirmation Alert massage on event click (ex new etc).
    // Category : COMMON
    ConfirmDirtyRead(): boolean {
        if (this.ScreenObject.IsDocEdit && this.ScreenObject.IsDirty) {
            //var res = Microsoft.Windows.Controls.MessageBox.Show(Application.Current.MainWindow, "Do you want to discard changes?", "Alert", MessageBoxButton.YesNo);
            if (!confirm("Do you want to discard changes?"))
                return false;
        }
        return true;
    }

    // Name : Redeposit
    // Desc : if the check is bounce, then we can redepost voucher (redeposit button will visible).
    // Category : COMMON
    Redeposit() {
        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            let CurrID = 1; let ExhgRate = 1;
            if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                if (this.Currency && !Util.IsEmpty(this.Currency.Currency.SelectedValue))
                    CurrID = parseInt(this.Currency.Currency.SelectedValue);
                else if (this.ScreenObject.GridDataColumns.Contains("CurrencyID") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CurrencyID_Key"]))
                    CurrID = parseInt(this.ScreenObject.GridData[i]["CurrencyID_Key"]);

                if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                    ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
                else if (this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ExchangeRate"]))
                    ExhgRate = parseFloat(this.ScreenObject.GridData[i]["ExchangeRate"]);
            }

            let sb = "";
            let sbbills = "";

            sbbills += "<BillWise><Row  ";
            sb += "<XML><Row  ";

            sb += "DocSeqNo=\"" + this.ScreenObject.GridData[i]["DocSeqNo"].toString() + "\" ";
            sbbills += "DocSeqNo=\"" + this.ScreenObject.GridData[i]["DocSeqNo"].toString() + "\" ";

            if (this.DocumentType == 14 || this.DocumentType == 15) {
                if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"])
                    && !Util.IsEmpty(this.ScreenObject.GridData[i]["Amount"])) {
                    sb += "AccountID=\"" + this.ScreenObject.GridData[i]["DebitAccount_Key"].toString() + "\" ";
                    sbbills += "AccountID=\"" + this.ScreenObject.GridData[i]["DebitAccount_Key"].toString() + "\" ";
                }
                else {
                    this.ScreenObject.GridData[i]["ReturnXML"] = "";
                    this.ScreenObject.GridData[i]["ExtraXML"] = "";
                    continue;
                }

                sb += "AmountFC=\"" + "-" + this.ScreenObject.GridData[i]["Amount"].toString() + "\" ";
                sb += "AdjAmount=\"" + "-" + (parseFloat(this.ScreenObject.GridData[i]["Amount"]) * ExhgRate) + "\" ";
                sb += "AdjExchRT=\"" + ExhgRate.toString() + "\" ";

                sbbills += "AmountFC=\"" + this.ScreenObject.GridData[i]["Amount"].toString() + "\" ";
                sbbills += "AdjAmount=\"" + (parseFloat(this.ScreenObject.GridData[i]["Amount"]) * ExhgRate) + "\" ";
            }
            else {
                if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"])
                    && !Util.IsEmpty(this.ScreenObject.GridData[i]["Amount"])) {
                    sb += "AccountID=\"" + this.ScreenObject.GridData[i]["CreditAccount_Key"].toString() + "\" ";
                    sbbills += "AccountID=\"" + this.ScreenObject.GridData[i]["CreditAccount_Key"].toString() + "\" ";
                }
                else {
                    this.ScreenObject.GridData[i]["ReturnXML"] = "";
                    this.ScreenObject.GridData[i]["ExtraXML"] = "";
                    continue;
                }

                sb += "AmountFC=\"" + this.ScreenObject.GridData[i]["Amount"].toString() + "\" ";
                sb += "AdjAmount=\"" + parseFloat(this.ScreenObject.GridData[i]["Amount"]) * ExhgRate + "\" ";
                sb += "AdjExchRT=\"" + ExhgRate.toString() + "\" ";

                sbbills += "AmountFC=\"" + "-" + this.ScreenObject.GridData[i]["Amount"].toString() + "\" ";
                sbbills += "AdjAmount=\"" + "-" + (parseFloat(this.ScreenObject.GridData[i]["Amount"]) * ExhgRate) + "\" ";
            }

            sb += "AdjCurrID=\"" + CurrID.toString() + "\" ";

            sb += "IsNewReference=\"" + "0" + "\" ";
            sb += "RefDocNo=\"" + this.ScreenObject.VoucherNo + "\" ";
            sb += "RefDocSeqNo=\"" + this.ScreenObject.GridData[i]["DocSeqNo"].toString() + "\" ";
            sb += "RefDocDate=\"" + this.DocumentDate.ToString("dd/MMM/yyyy") + "\" ";
            if (this.ScreenObject.DueDate != null && this.ScreenObject.DueDate.Date)
                sb += "RefDocDueDate=\"" + this.ScreenObject.DueDate.Date.ToString("dd/MMM/yyyy") + "\" ";
            sb += "Narration=\"\" ";
            sb += "IsDocPDC=\"" + "0" + "\" >";
            sb += " </Row>";

            sb += " </XML>";

            sbbills += "AdjCurrID=\"" + ExhgRate.toString() + "\" ";
            sbbills += "AdjExchRT=\"" + ExhgRate.toString() + "\" ";
            sbbills += "IsNewReference=\"" + "1" + "\" ";
            sbbills += "Narration=\"" + "" + "\" ";
            sbbills += "IsDocPDC=\"" + "0" + "\" ";
            sbbills += " ></Row>";
            sbbills += " </BillWise>";

            this.ScreenObject.GridData[i]["DocDetailsID"] = 0;
            this.ScreenObject.GridData[i]["ReturnXML"] = sb;
            if (parseBoolean(this.ScreenObject.GridData[i]["Type"]) == true)
                this.ScreenObject.GridData[i]["ExtraXML"] = sbbills.toString();
        }
        this.DocStatus = "[" + BaseService.GetResource("Doc_Draft") + "]";
        this.ScreenObject.DocID = 0;
        this.ScreenObject.RefCCId = 0;
        this.ScreenObject.RefNodeID = 0;
        this.DocumentDate = Date.Today();
        this.SetNewDocButtonVisibility();
        let DS: any = BaseService.document.getcurrentcode(this.ScreenObject.CostCenterID, this.ScreenObject.Prefix);
        if (DS != null && DS.Tables.length > 0 && DS.Tables[0].length > 0 && !DS.Columns[0].Contains("ErrorMessage") && DS.Columns[0].Contains("CurrentCodeNumber") && DS.Tables[0][0]["CurrentCodeNumber"].toString().trim() != "") {
            this.ScreenObject.DocPrefix.TextBox.Text = DS.Tables[0][0]["CurrentCodeNumber"].toString();
        }
    }

    // Name : FillPickDimensionofHistoryControls
    // Desc : fill pick dimension of history controls.
    // Category : COMMON
    FillPickDimensionofHistoryControls() {
        if (this.ScreenObject != null && this.ScreenObject.Data.Columns[0].Contains("IsHistory")) {
            let Lrefs: string[] = [];
            let histDims = this.ScreenObject.Data.Tables[0].filter(x => x.IsHistory == 1);
            if (histDims.length > 0) {
                let colName: string = this.GetPrimaryColName();

                for (let i = 0; i < histDims.length; i++) {
                    if (!Lrefs.Contains(histDims[i]["LocalReference"].toString())) {
                        Lrefs.push(histDims[i]["LocalReference"].toString());
                        let col = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.ID) && a.ID == histDims[i]["LocalReference"].toString());
                        if (col && this.ScreenObject.GridDataColumns.Contains(col.ValueMember)) {
                            for (let j = 0; j < this.ScreenObject.GridData.length; j++) {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[j][colName]) && !Util.IsEmpty(this.ScreenObject.GridData[j][col.ValueMember])) {
                                    this.ScreenObject.GetLinkReferenceData(parseInt(col.ID), this.CostCenterID, parseInt(this.ScreenObject.GridData[j][col.ValueMember]), Date.Today(), col.DisplayMember, col.CostCenterID, this.ScreenObject.GridData[j], null, false);
                                }
                            }
                        }
                        else {
                            let fld: any = this.ScreenObject._CCFields.find(a => a.DBColumnID.toString() == histDims[i]["LocalReference"].toString());
                            if (!fld)
                                fld = this.ScreenObject.HeaderFields.find(a => a instanceof PactControlData && a.DBColumnID == histDims[i]["LocalReference"]);
                            if (fld instanceof PactListBoxData)
                                this.ScreenObject.GetLinkReferenceData(fld.DBColumnID, this.CostCenterID, fld.SelectedValue, this.DocumentDate, (fld).DBColumnName, fld.CCID, null, null, false);
                            else if (fld instanceof PactCodeNameListBoxData)
                                this.ScreenObject.GetLinkReferenceData(fld.DBColumnID, this.CostCenterID, fld.SelectedValue, this.DocumentDate, (fld).DBColumnName, fld.CCID, null, null, false);
                        }
                    }
                }
            }
        }
    }

    // Name : ReEvaluate
    // Desc : it Reevaluate the formula.
    // Category : COMMON
    ReEvaluate(FillRef: boolean, Propmt: boolean = true) {

        let rowcnt = 0;
        let FillRates = true;

        if (FillRef)
            this.FillPickDimensionofHistoryControls();

        if (this.IsInventoryVoucher && !this.ScreenObject.IsPayrollDocument) {
            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                    if (Propmt && rowcnt == 0 && BaseService.SessionManager.Preferences.ContainsKey("PromptRatechange") && parseBoolean(BaseService.SessionManager.Preferences["PromptRatechange"])) {
                        if (!confirm("Do you want to ReEvaluate price Chart?"))
                            FillRates = false;
                    }
                    rowcnt++;
                    this.ReEvaluate_dr(this.ScreenObject.GridData[i], FillRates);
                }
            }
        }
        if (rowcnt == 0) {
            this.FillDictionary(null, false);
            this.CalcTextFields();
        }
    }

    // Name : ReEvaluatePriceTax
    // Desc : Re Evaluate price or Tax chart based of requirment.
    // Category : INVENTORY
    ReEvaluatePriceTax(cc: number, modes: string = "") {
        let rowcnt = 0;
        if (this.IsInventoryVoucher && !this.ScreenObject.IsPayrollDocument) {
            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                    rowcnt++;
                    this.ReEvaluatePriceTax_3(this.ScreenObject.GridData[i], cc, modes);
                }
            }
        }
        if (rowcnt == 0) {
            this.FillDictionary(null, false);
            this.CalcTextFields();
        }
    }

    // Name : ReEvaluatePriceTax_3
    // Desc : it is a sub method of ReEvaluatePriceTax, .
    // Category : INVENTORY
    ReEvaluatePriceTax_3(dr: any, cc: number, modes: string = "") {
        if (this.ScreenObject.PriceTaxcc.ContainsKey(cc))
            modes = this.ScreenObject.PriceTaxcc[cc];
        let qqty: number = 1;
        qqty = Util.Double(dr["Quantity"]);
        if (qqty == 0)
            qqty = 1;
        let Unit = 0;
        if (!Util.IsEmpty(dr["Unit_Key"]))
            Unit = parseInt(dr["Unit_Key"]);

        let ds: any = {};
        if (!Util.IsEmpty(dr["ProductID_Key"]))
            ds = this.ScreenObject.GetPriceTax(dr["ProductID_Key"].toString(), this.DocumentDate, Unit, qqty, dr["DocDetailsID"].toString(), dr, modes, this.Currency);

        if (modes.split(',').Contains("p") && ds.Tables.length > 1)//prices
        {
            if (ds.Tables[1].length > 0) {
                let RateCol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Rate");
                if (!Util.IsEmpty(RateCol.Formula) && ds.Columns[1].Contains(RateCol.Formula) && !Util.IsEmpty(ds.Tables[1][0][RateCol.Formula])) {
                    dr["Rate"] = ds.Tables[1][0][RateCol.Formula].toString();
                    dr["default" + "Rate"] = ds.Tables[1][0][RateCol.Formula].toString();
                }
                else {
                    if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                        if (!Util.IsEmpty(ds.Tables[1][0]["PurchaseRate"])) {
                            dr["Rate"] = ds.Tables[1][0]["PurchaseRate"].toString();
                            dr["default" + "Rate"] = ds.Tables[1][0]["PurchaseRate"].toString();
                        }
                    }
                    else {
                        if (!Util.IsEmpty(ds.Tables[1][0]["SellingRate"])) {
                            dr["Rate"] = ds.Tables[1][0]["SellingRate"].toString();
                            dr["default" + "Rate"] = ds.Tables[1][0]["SellingRate"].toString();
                        }
                    }
                }
                this.FillSalesPurchase(dr, ds.Tables[1], ds.Tables[1][0]);
            }
            else
                this.FillSalesPurchase(dr, ds.Tables[1], null);
        }

        if (!Util.IsEmpty(dr["ProductID_Key"]) && parseInt(dr["ProductID_Key"]) != this.ScreenObject.TempProductID) {
            if (modes.split(',').Contains("a")) {
                this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 23819 }, "AvgRate");
                if (ds.Columns[0].Contains("AvgRate") && !Util.IsEmpty(ds.Tables[0][0]["AvgRate"]))
                    dr["AVGRATE"] = ds.Tables[0][0]["AvgRate"].toString();
                else
                    dr["AVGRATE"] = 0;
            }
            if (modes.split(',').Contains("s")) {
                this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 25398 }, "QOH");
                this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 52638 }, "QOH");
                this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 52637 }, "BalQOH");
                this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 26421 }, "HOLDQTY");
                this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 50454 }, "CommittedQty");
                this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 26422 }, "RESERVEQTY");
                this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 499943 }, "TotalReserve");

                if (ds.Columns[0].Contains("QOH") && !Util.IsEmpty(ds.Tables[0][0]["QOH"]))
                    dr["QOH"] = ds.Tables[0][0]["QOH"].toString();
                else
                    dr["QOH"] = 0;

                if (ds.Columns[0].Contains("BalQOH") && !Util.IsEmpty(ds.Tables[0][0]["BalQOH"]))
                    dr["BalQOH"] = ds.Tables[0][0]["BalQOH"].toString();
                else
                    dr["BalQOH"] = 0;

                if (ds.Columns[0].Contains("HOLDQTY") && !Util.IsEmpty(ds.Tables[0][0]["HOLDQTY"]))
                    dr["HOLDQTY"] = ds.Tables[0][0]["HOLDQTY"].toString();
                else
                    dr["HOLDQTY"] = 0;

                if (ds.Columns[0].Contains("CommittedQty") && !Util.IsEmpty(ds.Tables[0][0]["CommittedQty"]))
                    dr["CommittedQty"] = ds.Tables[0][0]["CommittedQty"].toString();
                else
                    dr["CommittedQty"] = 0;

                if (ds.Columns[0].Contains("RESERVEQTY") && !Util.IsEmpty(ds.Tables[0][0]["RESERVEQTY"]))
                    dr["RESERVEQTY"] = ds.Tables[0][0]["RESERVEQTY"].toString();
                else
                    dr["RESERVEQTY"] = 0;

                if (ds.Columns[0].Contains("TotalReserve") && !Util.IsEmpty(ds.Tables[0][0]["TotalReserve"]))
                    dr["TotalReserve"] = ds.Tables[0][0]["TotalReserve"].toString();
                else
                    dr["TotalReserve"] = 0;

            }
        }

        if (modes.split(',').Contains("t") && ds.Tables.length > 2)//prices
        {
            let NumColt = this.ScreenObject.ColumnSource.filter(a => a.DisplayMember.Contains("dcNum") && a.SectionID != 4);
            NumColt.forEach(item => {
                if (!(item.linkData > 0)) {
                    let drr = ds.Tables[2].filter(x => x.SysColumnName == item.DisplayMember);
                    if (drr.length > 0) {
                        dr[item.DisplayMember] = drr[0]["Value"].toString();
                        dr["default" + item.DisplayMember] = drr[0]["Value"].toString();
                    }
                    else if (item.IsReEvaluate) {
                        dr[item.DisplayMember] = 0;
                        dr["default" + item.DisplayMember] = 0;
                    }
                }
            });
        }

        if (this.AutoPostViewModel != null) {
            let cfld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == cc) as PactListBoxData;
            let acfld = this.AutoPostViewModel.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == cc) as PactListBoxData;
            if (cfld && acfld) {
                acfld.SelectedValue = cfld.SelectedValue;
                acfld.SelectedValueText = cfld.Text;
            }

            let drbomd = this.AutoPostViewModel.ScreenObject.GridData.find(x => x.RefSeqNo == dr["RefSeqNo"]);
            drbomd.forEach(sr => {
                if (!Util.IsEmpty(sr["defaultQuantity"]) && (parseFloat(dr["Quantity"]) * parseFloat(sr["defaultQuantity"])) != parseFloat(sr["Quantity"])) {
                    sr["Quantity"] = parseFloat(dr["Quantity"]) * parseFloat(sr["defaultQuantity"]);
                    if (!Util.IsEmpty(sr["Quantity"]) && !Util.IsEmpty(sr["UOMConversion"]) && Util.IsNum(sr["UOMConversion"])) {
                        sr["UOMConvertedQty"] = Util.Double(sr["UOMConversion"]) * parseFloat(sr["Quantity"]);
                    }
                    else if (!Util.IsEmpty(sr["Quantity"]))
                        sr["UOMConvertedQty"] = sr["Quantity"].toString();
                }
                this.AutoPostViewModel.ReEvaluatePriceTax_3(dr, cc);
            });
            let gr = 0;
            drbomd.forEach(dd => {
                if (!Util.IsEmpty(dd["Gross"]))
                    gr += parseFloat(dd["Gross"]);
            });

            if (!Util.IsEmpty(dr["Quantity"]))
                dr["Rate"] = gr / parseFloat(dr["Quantity"]);
        }
        this.CalculateTotals(dr, false);
    }

    // Name : ReEvaluate_dr
    // Desc : it is a sub method of ReEvaluate.
    // Category : INVENTORY
    ReEvaluate_dr(dr: any, FillPricechart: boolean = true) {
        let Unit = 0;
        if (!Util.IsEmpty(dr["Unit_Key"]))
            Unit = parseInt(dr["Unit_Key"]);
        let ds: any = this.GetProductValues(dr, Unit, false, null, true);
        if (FillPricechart)
            this.FillRates(ds, dr);
        let NumColt = this.ScreenObject.ColumnSource.filter(a => a.DisplayMember.Contains("dcNum") && a.SectionID != 4);
        NumColt.forEach(item => {
            if (ds.Tables.length > 4 && !(item.linkData > 0))//Extra Fields
            {
                let drr = ds.Tables[4].filter(x => x.SysColumnName == item.DisplayMember);
                if (drr.length > 0) {
                    dr[item.DisplayMember] = drr[0]["Value"].toString();
                    dr["default" + item.DisplayMember] = drr[0]["Value"].toString();
                }
                else if (item.IsReEvaluate) {
                    dr[item.DisplayMember] = 0;
                    dr["default" + item.DisplayMember] = 0;
                }
                //else if (ds.Tables.length > 5)
                //{
                //    drr = ds.Tables[5].filter(x=>x.SysColumnName==item.DisplayMember);
                //    if (drr.length > 0)
                //    {
                //        dr[item.DisplayMember] = drr[0]["Value"].toString();
                //        dr["default" + item.DisplayMember] = drr[0]["Value"].toString();
                //    }
                //}
            }
        });

        if (this.AutoPostViewModel != null) {
            this.AutoPostViewModel.ScreenObject._CCFields.forEach(item => {
                let cfld = this.ScreenObject._CCFields.find(a => a.DBColumnName == item.DBColumnName);
                if (cfld && item instanceof PactListBoxData && cfld instanceof PactListBoxData) {
                    item.SelectedValue = cfld.SelectedValue;
                    item.SelectedValueText = cfld.Text;
                }
            });
            let drbomd = this.AutoPostViewModel.ScreenObject.GridData.find(x => x.RefSeqNo == dr["RefSeqNo"]);
            drbomd.forEach(sr => {
                if (!Util.IsEmpty(sr["defaultQuantity"]) && (parseFloat(dr["Quantity"]) * parseFloat(sr["defaultQuantity"])) != parseFloat(sr["Quantity"])) {
                    sr["Quantity"] = parseFloat(dr["Quantity"]) * parseFloat(sr["defaultQuantity"]);
                    if (!Util.IsEmpty(sr["Quantity"]) && !Util.IsEmpty(sr["UOMConversion"]) && Util.IsNum(sr["UOMConversion"])) {
                        sr["UOMConvertedQty"] = Util.Double(sr["UOMConversion"]) * parseFloat(sr["Quantity"]);
                    }
                    else if (!Util.IsEmpty(sr["Quantity"]))
                        sr["UOMConvertedQty"] = sr["Quantity"].toString();
                }
                Unit = 0;
                if (!Util.IsEmpty(dr["Unit_Key"]))
                    Unit = parseInt(dr["Unit_Key"]);
                let dsauto = this.AutoPostViewModel.GetProductValues(dr, Unit, false, null, true);
                this.AutoPostViewModel.FillRates(dsauto, sr);
                this.AutoPostViewModel.CalculateTotals(sr, false);
            });
            let gr = 0;
            drbomd.forEach(dd => {
                if (!Util.IsEmpty(dd["Gross"]))
                    gr += parseFloat(dd["Gross"]);
            });

            if (!Util.IsEmpty(dr["Quantity"]))
                dr["Rate"] = gr / parseFloat(dr["Quantity"]);
        }
        if (!Util.IsEmpty(dr["Type"]) && Util.String(dr["Type"]) == "8" || Util.String(dr["Type"]) == "3") {
            let dynsvm = new DynamicSetViewModel(this, dr, null);
            for (let k = 0; k < dynsvm.GridData.length; k++) {
                if (Util.StringValue(dynsvm.GridData[k]["ProductID_Key"]).toString() != "") {
                    this.ReEvaluate_dr(dynsvm.GridData[k], FillPricechart);
                }
            }
            dynsvm.OnButtonClick("AutoSave");
        }
        this.CalculateTotals(dr, false);
    }

    async ConvertCase() {
        //using (AddEditCasesViewModel Cases = new AddEditCasesViewModel(0, 1, true))
        {
            const { AddEditCaseComponent } = await import('../../crm/add-edit-case/add-edit-case.component')
            const { AddEditCasesViewModel } = await import('../../crm/add-edit-case/AddEditCasesViewModel')

            let Cases = new AddEditCasesViewModel(0, 1, true);

            Cases.RefCCID = this.CostCenterID;
            Cases.RefNodeID = this.ScreenObject.DocID;

            if (this.ScreenObject.Data.Tables.length > 20 && this.ScreenObject.Data.Columns[20].Contains("DocumentLinkDefID")) {
                let drcases = this.ScreenObject.Data.Tables[20].filter(x => x.Mode == 2 && x.CostCenterIDBase == 73);
                if (drcases.length > 0) {
                    let ds = this.ScreenObject.GetCaseLinkDetails(drcases[0]["DocumentLinkDefID"].toString());
                    if (ds != null && ds.Tables.length > 0 && ds.Columns[0].Contains("BASECOL")) {
                        let tempdate;
                        let templng;
                        for (let i = 0; i < ds.Tables[0].length; i++) {
                            if (!Util.IsEmpty(ds.Tables[0][i]["LINKCOL"])) {
                                let Value = "";
                                let SelectedText = "";
                                let descol = ds.Tables[0][i]["LINKCOL"].toString();
                                let bCol = ds.Tables[0][i]["BASECOL"].toString();
                                if (this.ScreenObject.GridDataColumns.Contains(descol) || bCol.toLowerCase() == "productid") {
                                    let descc = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != "Name" && a.DisplayMember == descol);
                                    if (!descc)
                                        descc = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Name" && a.ValueBinding == descol);
                                    if (!descc)
                                        descc = this.ScreenObject.ColumnSource.find(a => a.ValueMember != "" && a.ValueMember == descol + "_Key");

                                    if (descc) {
                                        if (descc.CostCenterID > 0 && this.ScreenObject.GridDataColumns.Contains(descc.ValueMember) && !Util.IsEmpty(this.ScreenObject.GridData[0][descc.ValueMember]))
                                            Value = this.ScreenObject.GridData[0][descc.ValueMember].toString();
                                        else if ((descc.DataType == "DATE" || descc.DataType == "DateTime" || Util.stringCompare(descc.DataType, "Time", true) == 0) && this.ScreenObject.GridDataColumns.Contains(descc.DisplayMember + "_Key") && !Util.IsEmpty(this.ScreenObject.GridData[0][descc.DisplayMember + "_Key"])) {
                                            if (Util.isValidDate(this.ScreenObject.GridData[0][descc.DisplayMember + "_Key"].toString())) {
                                                Value = Util.ParseDate(this.ScreenObject.GridData[0][descc.DisplayMember + "_Key"]).toString();
                                            }
                                        }
                                        else if (descc.DisplayMember == "Name" && this.ScreenObject.GridDataColumns.Contains(descc.ValueBinding) && !Util.IsEmpty(this.ScreenObject.GridData[0][descc.ValueBinding]))
                                            Value = this.ScreenObject.GridData[0][descc.ValueBinding].toString();
                                        else if (this.ScreenObject.GridDataColumns.Contains(descc.DisplayMember) && !Util.IsEmpty(this.ScreenObject.GridData[0][descc.DisplayMember]))
                                            Value = this.ScreenObject.GridData[0][descc.DisplayMember].toString();


                                        if (bCol.toLowerCase() == "productid" || bCol.toLowerCase() == "uomid" || bCol.toLowerCase() == "quantity"
                                            || bCol.toLowerCase() == "description" || (bCol.Contains("Alpha") && !bCol.Contains("acAlpha"))) {
                                            if (Cases.ProductGrid != null && Cases.ProductGrid.ProductGrid != null && this.ScreenObject.GridDataColumns.Contains("ProductID_Key")) {
                                                for (let t = 0; t < this.ScreenObject.GridData.length; t++) {
                                                    if (!Util.IsEmpty(this.ScreenObject.GridData[t]["ProductID_Key"]) && parseInt(this.ScreenObject.GridData[t]["ProductID_Key"]) > 0) {
                                                        if (Cases.ProductGrid.ProductGrid.length < t + 1)
                                                            Cases.ProductGrid.ProductGrid.push();
                                                        if (bCol.toLowerCase() == "productid" &&
                                                            Cases.ProductGrid.ProductGridObj.TableColumns.Contains("Product_Key")) {
                                                            if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                                                                Cases.ProductGrid.ProductGrid[t]["ProductName"] = this.ScreenObject.GridData[t]["ProductName"].toString();
                                                            if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                                                Cases.ProductGrid.ProductGrid[t]["ProductCode"] = this.ScreenObject.GridData[t]["ProductCode"].toString();
                                                            Cases.ProductGrid.ProductGrid[t]["Product_Key"] = this.ScreenObject.GridData[t]["ProductID_Key"].toString();
                                                        }
                                                        else if (bCol.toLowerCase() == "uomid" &&
                                                            Cases.ProductGrid.ProductGridObj.TableColumns.Contains("UOM_Key")) {

                                                            Cases.ProductGrid.ProductGrid[t]["UOM"] = this.ScreenObject.GridData[t]["Unit"].toString();
                                                            Cases.ProductGrid.ProductGrid[t]["UOM_Key"] = this.ScreenObject.GridData[t]["Unit_Key"].toString();
                                                        }
                                                        else if (bCol.toLowerCase() == "quantity" &&
                                                            Cases.ProductGrid.ProductGridObj.TableColumns.Contains("QTY")) {
                                                            Cases.ProductGrid.ProductGrid[t]["QTY"] = this.ScreenObject.GridData[t][descc.DisplayMember].toString();
                                                        }
                                                        else if (Cases.ProductGrid.ProductGridObj.TableColumns.Contains(bCol)) {
                                                            Cases.ProductGrid.ProductGrid[t][bCol] = this.ScreenObject.GridData[t][descc.DisplayMember].toString();
                                                        }
                                                    }
                                                }
                                                Value = "";
                                            }

                                        }
                                    }
                                }
                                else {
                                    let fld = this.ScreenObject._TextFields.find(a => a.DBColumnName == descol);
                                    if (!fld)
                                        fld = this.ScreenObject._CCFields.find(a => a.DBColumnName == descol);
                                    if (!fld)
                                        fld = this.ScreenObject._StaticFields.find(a => a.DBColumnName == descol);
                                    if (!fld) {
                                        for (let g = 0; g < this.ScreenObject.HeaderFields.length; g++) {
                                            const item = this.ScreenObject.HeaderFields[g];
                                            if (descol.toLowerCase() == "docdate" && item instanceof PactVoucherDateData) {
                                                Value = this.DocumentDate.toString();
                                                break;
                                            }
                                            else if (item instanceof PactControlData && item.DBColumnName.toLowerCase() == descol.toLowerCase()) {
                                                fld = item as PactControlData;
                                            }
                                        }
                                    }
                                    if (fld) {
                                        SelectedText = "";
                                        if (fld instanceof PactExtraFieldDateData) {
                                            if (fld.Date)
                                                Value = fld.Date.toString();
                                        }
                                        else if (fld instanceof PactDatePickerData) {
                                            Value = fld.Date.toString();
                                        }
                                        else if (fld instanceof PactListBoxData) {
                                            if (fld.SelectedValue > 0) {
                                                Value = fld.SelectedValue.toString();
                                                SelectedText = fld.Text.toString();
                                            }
                                        }
                                        else if (fld instanceof PactCodeNameListBoxData) {
                                            if (fld.SelectedValue > 0)
                                                Value = fld.SelectedValue.toString();
                                        }
                                        else if (fld instanceof PactTextBoxData) {
                                            Value = fld.Text;
                                        }
                                        else if (fld instanceof PactTextAreaData) {
                                            Value = fld.Text;
                                        }
                                        else if (fld instanceof PactSelectionBoxData) {
                                            Value = fld.Text;
                                        }
                                        else if (fld instanceof PactComboBoxData) {
                                            Value = fld.SelectedValue;
                                        }
                                    }

                                }

                                if (Value != "" && !Util.IsEmpty(ds.Tables[0][i]["BASECOL"])) {

                                    if (bCol == "CreateDate") {

                                        if (Util.isValidDate(Value))
                                            Cases.CaseDate.Date = Util.ParseDate(Value);
                                    }
                                    else if (bCol == "CaseNumber") {
                                        if (SelectedText.length > 0 && SelectedText != "")
                                            Cases.CName.Text = SelectedText;
                                        else
                                            Cases.CName.Text = Value;
                                    }
                                    else if (bCol == "CustomerID") {
                                        templng = Util.Int(Value);
                                        //if (Util.Int(Value, out templng))
                                        if (templng > 0)
                                            Cases.Customer.SelectedValue = templng;
                                    }
                                    else if (bCol == "ServiceLvlLookupID") {
                                        templng = Util.Int(Value);
                                        //if (Util.Int(Value, out templng))
                                        if (templng > 0)
                                            Cases.ServiceLevel.SelectedValue = templng;
                                    }
                                    else if (bCol == "Remarks") {
                                        Cases.Comments.Text = Value;
                                    }
                                    else if (bCol.toLowerCase().Contains("acalpha") || bCol.toLowerCase().Contains("ccnid")) {
                                        Cases.ScreenObject.CustomTab.Pages.forEach(page => {
                                            page.Fields.forEach(item => {
                                                if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase() == bCol.toLowerCase()) {
                                                    item.Text = Value;
                                                }
                                                if (item instanceof PactComboBoxData && item.DBColumnName.toLowerCase() == bCol.toLowerCase()) {
                                                    item.SelectedValue = Value;
                                                }
                                                else if (item instanceof PactListBoxData && item.DBColumnName.toLowerCase() == bCol.toLowerCase()) {
                                                    if (Util.Int(Value) > 0)
                                                        item.SelectedValue = parseInt(Value);
                                                }
                                            });
                                        });
                                    }
                                }

                            }
                        }
                    }
                }
            }
            // ShellWindowViewModel.Workspaces.push(Cases);
            // ShellWindowViewModel.SetActiveWorkspace(Cases);
            let retObj: IPage = { component: AddEditCaseComponent, params: { obj: Cases } }
            BaseService.page.addNewTab(retObj);
        }
    }

    // Name : setStatusColor
    // Desc : Set Document Status Color.
    // Category : COMMON
    setStatusColor() {
        if (this.DocStatus.startsWith("[" + BaseService.GetResource("Doc_Draft") + "]"))
            this.StatusColor = BaseService.SessionManager.Preferences["DraftColor"];
        else if (this.DocStatus.startsWith("[Partial]"))
            this.StatusColor = BaseService.SessionManager.Preferences["partialColor"];
        else if (this.StatusID == 369)
            this.StatusColor = BaseService.SessionManager.Preferences["PostedColor"];
        else if (this.StatusID == 370)
            this.StatusColor = BaseService.SessionManager.Preferences["PDCColor"];
        else if (this.StatusID == 371)
            this.StatusColor = BaseService.SessionManager.Preferences["UnApprovedColor"];
        else if (this.StatusID == 372)
            this.StatusColor = BaseService.SessionManager.Preferences["RejectedColor"];
        else if (this.StatusID == 376)
            this.StatusColor = BaseService.SessionManager.Preferences["CancelledColor"];
        else if (this.StatusID == 429)
            this.StatusColor = BaseService.SessionManager.Preferences["BouncedColor"];
        else if (this.StatusID == 441)
            this.StatusColor = BaseService.SessionManager.Preferences["ApprovedColor"];
        else
            this.StatusColor = "#FF736F6F";
        if (this.StatusColor.length == 9 && (this.StatusColor.startsWith("#FF") || this.StatusColor.startsWith("#ff")))
            this.StatusColor = "#" + this.StatusColor.substr(3)
    }

    // Name : getStatusColor
    // Desc : get Document Status Color.
    // Category : COMMON
    static getStatusColor(StatusID: number) {
        let StatusColor = "#fff";
        if (StatusID == 369)
            StatusColor = BaseService.SessionManager.Preferences["PostedColor"];
        else if (StatusID == 370)
            StatusColor = BaseService.SessionManager.Preferences["PDCColor"];
        else if (StatusID == 371)
            StatusColor = BaseService.SessionManager.Preferences["UnApprovedColor"];
        else if (StatusID == 372)
            StatusColor = BaseService.SessionManager.Preferences["RejectedColor"];
        else if (StatusID == 376)
            StatusColor = BaseService.SessionManager.Preferences["CancelledColor"];
        else if (StatusID == 429)
            StatusColor = BaseService.SessionManager.Preferences["BouncedColor"];
        else if (StatusID == 441)
            StatusColor = BaseService.SessionManager.Preferences["ApprovedColor"];
        else
            StatusColor = "#FF736F6F";
        if (StatusColor.length == 9 && (StatusColor.startsWith("#FF") || StatusColor.startsWith("#ff")))
            StatusColor = "#" + StatusColor.substr(3)
        return StatusColor;
    }

    // Name : SaveStatus
    // Desc : Save Approve or Reject status of document.
    // Category : COMMON
    SaveStatus(StatusID: number, WorkflowID: number, ids: string, CheckGuid: boolean = true) {
        let dsAppRej: any = this.ScreenObject.SetDocStatus(StatusID, WorkflowID, ids, this.AppRejDate.Date, this.Remarks.Text, true, (CheckGuid) ? this.ScreenObject.guid : "");
        if (dsAppRej != null && dsAppRej.Tables.length > 0 && dsAppRej.Tables[0].length > 0 && dsAppRej.Columns[0].Contains("status")) {
            BaseService.SessionManager.RefreshNotification();
            this.DocStatus = "[" + dsAppRej.Tables[0][0]["status"].toString() + "]";
            this.AppRejDate.Date = new Date();
            this.Remarks.Text = "";
            this.ButtonApprove.Visible = false;
            this.SetVisibiltiFalse();
            if (!this.IsPOs)
                this.SetDefaultRightPanel();
        }
        if (dsAppRej != null && dsAppRej.Tables.length > 0 && dsAppRej.Tables[dsAppRej.Tables.length - 1].length > 0 && dsAppRej.Columns[dsAppRej.Columns.length - 1].Contains("ErrorMessage"))
            this.DisplayMessage = dsAppRej.Tables[dsAppRej.Tables.length - 1][0]["ErrorMessage"].toString();
        this.clear(2);
    }

    // Name : SetDefaultRightPanel
    // Desc : sets the visiblity of right panel in document.
    // Category : COMMON
    SetDefaultRightPanel() {
        if (this.DocumentType == 72) {
            this.onButtonClick("VacCrDaysDetail");
        }
        else {
            if (this.ScreenObject.Preferences.ContainsKey("DefaultRightView") && this.ScreenObject.Preferences["DefaultRightView"] != "") {
                switch (this.ScreenObject.Preferences["DefaultRightView"]) {
                    case "Notes":
                        this.onButtonClick("Notes");
                        break;
                    case "Import":
                        this.onButtonClick("ImportVisiblity");
                        break;
                    case "Sort":
                        this.onButtonClick("SortVisiblity");
                        break;
                    case "Attachments":
                        //this.onButtonClick("Attachment");
                        this.RightTabSelectedIndex = 5;
                        break;
                    case "Search":
                        this.onButtonClick("Search");
                        break;
                    case "Documents":
                        this.onButtonClick("Documents");
                        break;
                    case "reports":
                    default:
                        this.ReportInfoVisibility = true && !this.IsMobile;
                        this.RightTabSelectedIndex = 1;
                        break;
                }
            }
            else
                this.ReportInfoVisibility = false && !this.IsMobile;
        }
    }

    // Name : SaveLinkStatus
    // Desc : ? .
    // Category : COMMON
    SaveLinkStatus(StatusID: number) {
        if (Util.IsEmpty(this.Remarks.Text) && this.ScreenObject.Preferences.ContainsKey("LinkStatusRemarksMandatory") && this.ScreenObject.Preferences["LinkStatusRemarksMandatory"] != ""
            && parseBoolean(this.ScreenObject.Preferences["LinkStatusRemarksMandatory"])) {
            this.DisplayMessage = "Enter remarks";
            return;
        }
        let dsAppRej = this.ScreenObject.SetDocLinkStatus(StatusID, this.AppRejDate.Date, this.Remarks.Text);
        if (dsAppRej != null && dsAppRej.Tables.length > 0 && dsAppRej.Tables[0].length > 0 && dsAppRej.Columns[0].Contains("status")) {
            this.DocStatus = "[" + dsAppRej.Tables[0][0]["status"].toString() + "]";
            this.DocStatus = "[" + BaseService.GetResource(Util.String(dsAppRej.Tables[0][0]["status"]).Replace("-", "_").Replace(" ", "")) + "]";
            this.AppRejDate.Date = new Date();
            this.Remarks.Text = "";
            this.SuspendVisiblity = false;
            this.SetVisibiltiFalse();
            if (!this.IsPOs)
                this.SetDefaultRightPanel();
        }
        if (dsAppRej != null && dsAppRej.Tables.length > 0 && dsAppRej.Tables[dsAppRej.Tables.length - 1].length > 0 && dsAppRej.Columns[dsAppRej.Columns.length - 1].Contains("ErrorMessage"))
            this.DisplayMessage = dsAppRej.Tables[dsAppRej.Tables.length - 1][0]["ErrorMessage"].toString();

    }

    // Name : DeleteDocument
    // Desc : Deleting document.
    // Category : COMMON
    DeleteDocument() {
        Logger.InfoLog("AddEditDocumentViewModel::Entering DeleteDocument");
        this.IsSuspend = false;
        if (confirm(BaseService.GetResource("DeleteMessage")))
            this.OnDeleteCallBack();
        Logger.InfoLog("AddEditDocumentViewModel::Exiting DeleteDocument");
    }

    //#endregion // Constructor

    //#region Background Thread

    // Name : ConstructFormulaFields
    // Desc : preparing formula field for execution.
    // Category : COMMON
    ConstructFormulaFields() {
        this.fldDict = new Dictionary<MimizField>();
        this.FooterDics = new Dictionary<MimizField>();

        let fldObj: MimizField = new MimizField();
        fldObj.setFieldDetails("RATE", 1, 1, "", 1, false, false);
        this.fldDict.push("RATE", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("NET", 2, 1, "", 1, false, false);
        this.fldDict.push("NET", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("AVGRT", 3, 1, "", 1, false, false);
        this.fldDict.push("AVGRT", fldObj);


        fldObj = new MimizField();
        fldObj.setFieldDetails("QTY", 4, 1, "", 1, false, false);
        this.fldDict.push("QTY", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("GROSS", 5, 1, "", 1, false, false);
        this.fldDict.push("GROSS", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("LSTPRCHSRT", 6, 1, "", 1, false, false);
        this.fldDict.push("LSTPRCHSRT", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("LSTLNDGRT", 7, 1, "", 1, false, false);
        this.fldDict.push("LSTLNDGRT", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("CONVQTY", 8, 1, "", 1, false, false);
        this.fldDict.push("CONVQTY", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("UNITS", 9, 1, "", 1, false, false);
        this.fldDict.push("UNITS", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("BASEQTY", 10, 1, "", 1, false, false);
        this.fldDict.push("BASEQTY", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("EXCHRT", 11, 1, "", 1, false, false);
        this.fldDict.push("EXCHRT", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("HOLDQTY", 16, 1, "", 1, false, false);
        this.fldDict.push("HOLDQTY", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("CommittedQty", 18, 1, "", 1, false, false);
        this.fldDict.push("CommittedQty", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("RESERVEQTY", 17, 1, "", 1, false, false);
        this.fldDict.push("RESERVEQTY", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("TotalReserve", 19, 1, "", 1, false, false);
        this.fldDict.push("TotalReserve", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("QOH", 12, 1, "", 1, false, false);
        this.fldDict.push("QOH", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("BalQOH", 19, 1, "", 1, false, false);
        this.fldDict.push("BalQOH", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("MRate", 13, 1, "", 1, false, false);
        this.fldDict.push("MRate", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("RRate", 14, 1, "", 1, false, false);
        this.fldDict.push("RRate", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("SRate", 15, 1, "", 1, false, false);
        this.fldDict.push("SRate", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("DOCDATE", 20, 1, "", 1, false, false);
        this.fldDict.push("DOCDATE", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("ServerDate", 23, 1, "", 1, false, false);
        this.fldDict.push("ServerDate", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("DUEDATE", 21, 1, "", 1, false, false);
        this.fldDict.push("DUEDATE", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("BILLDATE", 22, 1, "", 1, false, false);
        this.fldDict.push("BILLDATE", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("UOMCONVERSION", 23, 1, "", 1, false, false);
        this.fldDict.push("UOMCONVERSION", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("MaturityDate", 24, 1, "", 1, false, false);
        this.fldDict.push("MaturityDate", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("DocPrefix", 25, 1, "", "", false, false);
        this.fldDict.push("DocPrefix", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("FreeQTY", 26, 1, "", 1, false, false);
        this.fldDict.push("FreeQTY", fldObj);

        fldObj = new MimizField();
        fldObj.setFieldDetails("Currency", 27, 1, "", 0, false, false);
        this.fldDict.push("Currency", fldObj);

        this.ScreenObject.ColumnSource.forEach(BodyCOl => {
            let fldname = BodyCOl.lbl;
            if (!Util.IsEmpty(fldname) && BodyCOl.IsColumnUserDefined && BodyCOl.DisplayMember.Contains("dcNum") && !this.fldDict.ContainsKey(fldname)) {
                fldObj = new MimizField();
                fldObj.setFieldDetails(fldname, 3, 1, "", 0, false, false);
                this.fldDict.push(fldname, fldObj);

                fldObj = new MimizField();
                fldObj.setFieldDetails("Calc" + fldname, 3, 1, "", 0, false, false);
                this.fldDict.push("Calc" + fldname, fldObj);

                fldObj = new MimizField();
                fldObj.setFieldDetails(fldname + "EXRT", 3, 1, "", 0, false, false);
                this.fldDict.push(fldname + "EXRT", fldObj);

                fldObj = new MimizField();
                fldObj.setFieldDetails(fldname + "Curr", 3, 1, "", 0, false, false);
                this.fldDict.push(fldname + "Curr", fldObj);

                this.CheckMaxMinFormula_1(fldname);
            }
            else if (!Util.IsEmpty(fldname) && !this.fldDict.ContainsKey(fldname) && !BodyCOl.DisplayMember.Contains("ExchRT") && !BodyCOl.DisplayMember.Contains("Curr")) {
                fldObj = new MimizField();
                fldObj.setFieldDetails(fldname, 3, 1, "", 0, false, false);
                this.fldDict.push(fldname, fldObj);
            }
        });

        this.ScreenObject._CCFields.forEach(item => {
            if (!this.fldDict.ContainsKey(item.Lbl)) {
                fldObj = new MimizField();
                fldObj.setFieldDetails(item.Lbl, 3, 1, "", 0, false, false);
                this.fldDict.push(item.Lbl, fldObj);
            }
        });

        this.ScreenObject.HeaderFields.forEach(item => {
            if (item instanceof PactControlData && !Util.IsEmpty(item.Lbl) && !this.fldDict.ContainsKey(item.Lbl)) {
                fldObj = new MimizField();
                fldObj.setFieldDetails(item.Lbl, 3, 1, "", 0, false, false);
                this.fldDict.push(item.Lbl, fldObj);
            }
        });
        this.ScreenObject._TextFields.forEach(item => {
            if (!this.fldDict.ContainsKey(item.Lbl)) {
                fldObj = new MimizField();
                fldObj.setFieldDetails(item.Lbl, 3, 1, "", 0, false, false);
                this.fldDict.push(item.Lbl, fldObj);
            }
        });
        if (this.ScreenObject.CreditAccount != null && !this.fldDict.ContainsKey(this.ScreenObject.CreditAccount.Lbl)) {
            fldObj = new MimizField();
            fldObj.setFieldDetails(this.ScreenObject.CreditAccount.Lbl, 3, 1, "", 0, false, false);
            this.fldDict.push(this.ScreenObject.CreditAccount.Lbl, fldObj);
        }
        if (this.ScreenObject.DebitAccount != null && !this.fldDict.ContainsKey(this.ScreenObject.DebitAccount.Lbl)) {
            fldObj = new MimizField();
            fldObj.setFieldDetails(this.ScreenObject.DebitAccount.Lbl, 3, 1, "", 0, false, false);
            this.fldDict.push(this.ScreenObject.DebitAccount.Lbl, fldObj);
        }
        if (this.POSPayModes != null && this.POSPayModes.PayModes != null) {
            for (let k = 0; k < this.POSPayModes.PayModes.length; k++) {
                fldObj = new MimizField();
                fldObj.setFieldDetails(this.POSPayModes.PayModes[k].Lbl, 3, 1, "", 0, false, false);
                this.fldDict.push(this.POSPayModes.PayModes[k].Lbl, fldObj);
            }
        }
        for (let i = 0; i < this.fldDict.keys.length; i++) {
            // this.FooterDics.push(this.fldDict.keys[i], new MimizField(this.fldDict.keys[i], this.fldDict.values[i]));
            this.FooterDics.push(this.fldDict.keys[i], this.fldDict.values[i].Clone());
            // let item:MimizField = new MimizField(this.fldDict.keys[i],this.fldDict.values[i]);
            // this.FooterDics.push(item.fieldName,item);
        }
    }

    // Name : CheckMaxMinFormula
    // Desc : sub method of CheckMaxMinFormula_1.
    // Category : COMMON
    CheckMaxMinFormula(Header: string, Formula: string) {
        let fldObj = new MimizField();
        if (Formula != null && Formula.Contains("Max" + Header) && !this.fldDict.ContainsKey("Max" + Header)) {
            fldObj = new MimizField();
            fldObj.setFieldDetails("Max" + Header, 3, 1, "", 0, false, false);
            this.fldDict.push("Max" + Header, fldObj);
        }
        if (Formula != null && Formula.Contains("MaxCalc" + Header) && !this.fldDict.ContainsKey("MaxCalc" + Header)) {
            fldObj = new MimizField();
            fldObj.setFieldDetails("MaxCalc" + Header, 3, 1, "", 0, false, false);
            this.fldDict.push("MaxCalc" + Header, fldObj);
        }
        if (Formula != null && Formula.Contains("Min" + Header) && !this.fldDict.ContainsKey("Min" + Header)) {
            fldObj = new MimizField();
            fldObj.setFieldDetails("Min" + Header, 3, 1, "", 0, false, false);
            this.fldDict.push("Min" + Header, fldObj);
        }
        if (Formula != null && Formula.Contains("MinCalc" + Header) && !this.fldDict.ContainsKey("MinCalc" + Header)) {
            fldObj = new MimizField();
            fldObj.setFieldDetails("MinCalc" + Header, 3, 1, "", 0, false, false);
            this.fldDict.push("MinCalc" + Header, fldObj);
        }
    }

    // Name : IsExpressionAvailable
    // Desc : checking formula is available or not.
    // Category : COMMON
    IsExpressionAvailable(Expression: string): boolean {
        let isavail = false;
        for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
            let item = this.ScreenObject.ColumnSource[i]
            if (item.Formula != null && item.Formula.Contains(Expression))
                return true;
        }
        if (this.ScreenObject.FooterDataBind != null && this.ScreenObject.FooterDataBindColumns.Contains("Formula"))
            for (let f = 0; f < this.ScreenObject.FooterDataBind.length; f++) {
                let item = this.ScreenObject.FooterDataBind[f]
                if (Util.String(item["Formula"]).Contains(Expression))
                    return true;
            }

        if (this.ScreenObject.Data.Tables.length > 10) {
            if (this.ScreenObject.Data.Columns[10].Contains("Expression"))
                for (let i = 0; i < this.ScreenObject.Data.Tables[10].length; i++) {
                    if (Util.String(this.ScreenObject.Data.Tables[10][i]["Expression"]).Contains(Expression))
                        return true;
                }
            if (this.ScreenObject.Data.Columns[9].Contains("Expression"))
                for (let i = 0; i < this.ScreenObject.Data.Tables[9].length; i++) {
                    if (Util.String(this.ScreenObject.Data.Tables[9][i]["Expression"]).Contains(Expression))
                        return true;
                }
        }
        return isavail;
    }

    // Name : CheckMaxMinFormula_1
    // Desc : sub method of ConstructFormulaFields.
    // Category : COMMON
    CheckMaxMinFormula_1(Header: string) {
        this.ScreenObject.ColumnSource.forEach(item => {
            this.CheckMaxMinFormula(Header, item.Formula);
        });
        if (this.ScreenObject.FooterDataBind != null && this.ScreenObject.FooterDataBindColumns.Contains("Formula"))
            for (let f = 0; f < this.ScreenObject.FooterDataBind.length; f++) {
                let item = this.ScreenObject.FooterDataBind[f]
                this.CheckMaxMinFormula(Header, Util.String(item["Formula"]));
            }

        if (this.ScreenObject.Data.Tables.length > 10) {
            if (this.ScreenObject.Data.Columns[10].Contains("Expression"))
                for (let i = 0; i < this.ScreenObject.Data.Tables[10].length; i++) {
                    this.CheckMaxMinFormula(Header, Util.String(this.ScreenObject.Data.Tables[10][i]["Expression"]));
                }
            if (this.ScreenObject.Data.Columns[9].Contains("Expression"))
                for (let i = 0; i < this.ScreenObject.Data.Tables[9].length; i++) {
                    this.CheckMaxMinFormula(Header, Util.String(this.ScreenObject.Data.Tables[9][i]["Expression"]));
                }
        }
    }

    // Name : CheckMaxMinFormula_1
    // Desc : sub method of ConstructFormulaFields.
    // Category : COMMON
    ChangeDateIfDateExists(Prefix: string) {
        try {
            let IsDateExists = false;
            let drprf = this.ScreenObject.Data.Tables[8].filter(x => x.SeriesNo == 0);
            drprf.sort((a, b) => a.PrefixOrder - b.PrefixOrder)

            let ind = 0, tmpind = 0, y = 0, m = 0, d = 0, tmpint = 0;
            for (let i = 0; i < drprf.length; i++) {
                if (parseInt(drprf[i]["CCID"]) == 51 || parseInt(drprf[i]["CCID"]) == 52 || parseInt(drprf[i]["CCID"]) == 53) {
                    IsDateExists = true;
                    if (!Util.IsEmpty(drprf[i]["Delimiter"])) {
                        tmpind = Prefix.indexOf(drprf[i]["Delimiter"].toString(), ind);
                        if (tmpind > 0) {
                            if (Util.IsNum(Prefix.substr(ind, (tmpind - ind)))) {
                                tmpint = Util.Int(Prefix.substr(ind, (tmpind - ind)))
                                if (parseInt(drprf[i]["CCID"]) == 51)
                                    d = parseInt(Prefix.substr(ind, (tmpind - ind)));
                                else if (parseInt(drprf[i]["CCID"]) == 52)
                                    m = parseInt(Prefix.substr(ind, (tmpind - ind)));
                                else if (parseInt(drprf[i]["CCID"]) == 53) {
                                    if (drprf[i]["Length"].toString() == "YY" && (tmpind - ind) == 2)
                                        y = parseInt(Prefix.substr(ind, (tmpind - ind))) + 2000;
                                    else
                                        y = parseInt(Prefix.substr(ind, (tmpind - ind)));
                                }
                                ind = tmpind + 1;
                            }
                            else if (drprf[i]["Length"].toString() == "YY-YY") {
                                if (ind >= 0 && Prefix.length >= ind + 5 && Util.IsNum(Prefix.substr(ind, 2))
                                    && Util.IsNum(Prefix.substr(ind + 3, 2))) {
                                    if (m == 0) {
                                        if (BaseService.SessionManager.AccountingToMonth < new Date().iMonth())
                                            y = parseInt(Prefix.substr(ind, 2)) + 2000;
                                        else
                                            y = parseInt(Prefix.substr(ind + 3, 2)) + 2000;
                                    }
                                    else {
                                        if (BaseService.SessionManager.AccountingToMonth < m)
                                            y = parseInt(Prefix.substr(ind, 2)) + 2000;
                                        else
                                            y = parseInt(Prefix.substr(ind + 3, 2)) + 2000;
                                    }
                                }
                                ind = tmpind + 1;
                            }
                        }
                    }
                    else {
                        if (drprf[i]["Length"].toString() == "D") {
                            if (ind >= 0 && Prefix.length >= ind + 2 && Util.IsNum(Prefix.substr(ind, 2))
                                && parseInt(Prefix.substr(ind, 2)) < 31) {
                                d = parseInt(Prefix.substr(ind, 2));
                                ind += 2;
                            }
                            else if (Util.IsNum(Prefix.substr(ind, 1))) {
                                d = parseInt(Prefix.substr(ind, 1));
                                ind++;
                            }
                        }
                        else if (drprf[i]["Length"].toString() == "DD") {
                            if (ind >= 0 && Prefix.length >= ind + 2 && Util.IsNum(Prefix.substr(ind, 2))
                                && parseInt(Prefix.substr(ind, 2)) < 31) {
                                d = parseInt(Prefix.substr(ind, 2));
                                ind += 2;
                            }
                        }
                        else if (drprf[i]["Length"].toString() == "MM") {
                            if (ind >= 0 && Prefix.length >= ind + 2 && Util.IsNum(Prefix.substr(ind, 2))
                                && parseInt(Prefix.substr(ind, 2)) < 13) {
                                m = parseInt(Prefix.substr(ind, 2));
                                ind += 2;
                            }
                        }
                        else if (drprf[i]["Length"].toString() == "M") {
                            if (ind >= 0 && Prefix.length >= ind + 2 && Util.IsNum(Prefix.substr(ind, 2))
                                && parseInt(Prefix.substr(ind, 2)) < 13) {
                                m = parseInt(Prefix.substr(ind, 2));
                                ind += 2;
                            }
                            else if (Util.IsNum(Prefix.substr(ind, 1))) {
                                m = parseInt(Prefix.substr(ind, 1));
                                ind++;
                            }
                        }
                        else if (drprf[i]["Length"].toString() == "MMM") {
                            if (ind >= 0 && Prefix.length >= ind + 3) {
                                m = this.ScreenObject.GetMonthNo(Prefix.substr(ind, 3));
                                ind += 3;
                            }
                        }
                        else if (drprf[i]["Length"].toString() == "YY") {
                            if (ind >= 0 && Prefix.length >= ind + 2 && Util.IsNum(Prefix.substr(ind, 2))) {
                                y = parseInt(Prefix.substr(ind, 2)) + 2000;
                                ind += 2;
                            }
                        }
                        else if (drprf[i]["Length"].toString() == "YYYY") {
                            if (ind >= 0 && Prefix.length >= ind + 4 && Util.IsNum(Prefix.substr(ind, 4))) {
                                y = parseInt(Prefix.substr(ind, 4));
                                ind += 4;
                            }
                        }
                        else if (drprf[i]["Length"].toString() == "YY-YY") {
                            if (ind >= 0 && Prefix.length > ind + 5 && Util.IsNum(Prefix.substr(ind, 2))
                                && Util.IsNum(Prefix.substr(ind + 3, 2))) {
                                if (m == 0) {
                                    if (BaseService.SessionManager.AccountingToMonth < new Date().iMonth())
                                        y = parseInt(Prefix.substr(ind, 2)) + 2000;
                                    else
                                        y = parseInt(Prefix.substr(ind + 3, 2)) + 2000;
                                }
                                else {
                                    if (BaseService.SessionManager.AccountingToMonth < m)
                                        y = parseInt(Prefix.substr(ind, 2)) + 2000;
                                    else
                                        y = parseInt(Prefix.substr(ind + 3, 2)) + 2000;
                                }
                                ind += 5;
                            }
                        }
                    }
                }
                else {
                    if (!Util.IsEmpty(drprf[i]["Delimiter"])) {
                        tmpind = Prefix.indexOf(drprf[i]["Delimiter"].toString(), ind);
                        if (tmpind > 0)
                            ind = tmpind + 1;
                    }
                    else if (Util.IsNum(drprf[i]["Length"])) {
                        ind += parseInt(drprf[i]["Length"]);
                    }
                }
            }

            if (IsDateExists && (y > 0 || m > 0 || d > 0)) {
                if ((y > 0 && this.DocumentDate.getFullYear() == y)
                    || (m > 0 && this.DocumentDate.iMonth() == m)
                    || (d > 0 && this.DocumentDate.getDate() == d)) {
                    return;
                }
                if (y == 0)
                    y = new Date().getFullYear();

                if (m == 0) {
                    m = BaseService.SessionManager.AccountingToMonth;
                    if (BaseService.SessionManager.AccountingFromMonth > BaseService.SessionManager.AccountingToMonth) {
                        if (y == 0)
                            if (new Date().iMonth() < BaseService.SessionManager.AccountingFromMonth)
                                y = new Date().getFullYear();
                            else
                                y = new Date().getFullYear() + 1;
                    }
                }
                if (d == 0)
                    d = new Date(y, m, 1).DaysInMonth();
                this._Ddate = new Date(y, m, d);
                //OnPropertyChanged("DocumentDate");
            }
        }
        catch (error) {
            Logger.ErrorLog("addeditdocument", "ChangeDateifDateExists", "CheckDateinPrefix", error);
        }
    }

    // Name : CheckDateInDocNumber
    // Desc : ?.
    // Category : COMMON
    CheckDateInDocNumber(IsNotDate: boolean, ClearMessage: boolean = true) {
        let IsDateExists = false;
        let DocNum = "";
        if (this.ScreenObject.DocPrefix == null)
            return;

        let NewAdded: Dictionary<boolean> = new Dictionary<boolean>();

        this.ScreenObject.DocPrefix.Prefixes.keys.forEach(key => {
            if (key != null)
                DocNum = key;
            let val = this.ScreenObject.DocPrefix.Prefixes[key]

            if (DocNum.Contains("'DD'")) {
                IsDateExists = true;
                if (this.DocumentDate.getDate() > 9)
                    DocNum = DocNum.replace("'DD'", this.DocumentDate.getDate().toString());
                else
                    DocNum = DocNum.replace("'DD'", "0" + this.DocumentDate.getDate().toString());
            }
            else if (DocNum.Contains("'D'")) {
                IsDateExists = true;
                DocNum = DocNum.replace("'D'", this.DocumentDate.getDate().toString());
            }

            if (DocNum.Contains("'MMM'")) {
                IsDateExists = true;
                DocNum = DocNum.replace("'MMM'", this.ScreenObject.GetMonthName(this.DocumentDate.iMonth(), false));
            }
            else if (DocNum.Contains("'MM'")) {
                IsDateExists = true;
                if (this.DocumentDate.iMonth() > 9)
                    DocNum = DocNum.replace("'MM'", this.DocumentDate.iMonth().toString());
                else
                    DocNum = DocNum.replace("'MM'", "0" + this.DocumentDate.iMonth().toString());
            }
            else if (DocNum.Contains("'M'")) {
                IsDateExists = true;
                DocNum = DocNum.replace("'M'", this.DocumentDate.iMonth().toString());
            }
            else if (DocNum.Contains("'Name'")) {
                IsDateExists = true;
                DocNum = DocNum.replace("'Name'", this.ScreenObject.GetMonthName(this.DocumentDate.iMonth(), true));
            }

            if (DocNum.Contains("'YYYY'")) {
                IsDateExists = true;
                DocNum = DocNum.replace("'YYYY'", this.DocumentDate.getFullYear().toString());
            }
            else if (DocNum.Contains("'YY'")) {
                IsDateExists = true;
                DocNum = DocNum.replace("'YY'", this.DocumentDate.getFullYear().toString().substr(2));
            }
            else if (DocNum.Contains("'YY-YY'")) {
                IsDateExists = true;
                if (this.DocumentDate.iMonth() < BaseService.SessionManager.AccountingFromMonth)
                    DocNum = DocNum.replace("'YY-YY'", (this.DocumentDate.getFullYear() - 1).toString().substr(2) + "-" + this.DocumentDate.getFullYear().toString().substr(2));
                else
                    DocNum = DocNum.replace("'YY-YY'", this.DocumentDate.getFullYear().toString().substr(2) + "-" + (this.DocumentDate.getFullYear() + 1).toString().substr(2));
            }

            if (IsDateExists || val) {
                let numb = this.ScreenObject.DocPrefix.ComboBox.Items.find(a => a.Value == DocNum);
                if (numb) {
                    if (!NewAdded.ContainsKey(DocNum))
                        NewAdded.push(DocNum, val);
                    //if (ClearMessage)
                    //{
                    //    isFromDate = true;
                    //    this.ScreenObject.DocPrefix.ComboBox.SelectedItem = numb;
                    //    this.ScreenObject.DocPrefix.ComboBox.SelectedValue = numb.Value;
                    //    isFromDate = false;
                    //}
                }
                else {
                    if (this.ScreenObject.Preferences.ContainsKey("StartNoForNewPrefix") && !Util.IsEmpty(this.ScreenObject.Preferences["StartNoForNewPrefix"]) && this.ScreenObject.Preferences["StartNoForNewPrefix"] != "0")
                        this.ScreenObject.DocPrefix.ComboBox.Items.push(ComboBoxItems.ComboBoxItems_4(DocNum, DocNum, "", this.ScreenObject.Preferences["StartNoForNewPrefix"].length.toString()));
                    else
                        this.ScreenObject.DocPrefix.ComboBox.Items.push(ComboBoxItems.ComboBoxItems_4(DocNum, DocNum, "", "1"));
                    if (!NewAdded.ContainsKey(DocNum))
                        NewAdded.push(DocNum, val);
                    if (ClearMessage && (val || this.ScreenObject.DocPrefix.Prefixes.length == 1)) {
                        this.isFromDate = true;
                        this.ScreenObject.DocPrefix.ComboBox.SelectedItem = this.ScreenObject.DocPrefix.ComboBox.Items[this.ScreenObject.DocPrefix.ComboBox.Items.length - 1];
                        this.ScreenObject.DocPrefix.ComboBox.SelectedValue = DocNum;
                        this.isFromDate = false;
                    }
                }
            }
            else {
                let numb = this.ScreenObject.DocPrefix.ComboBox.Items.find(a => a.Value == DocNum);
                if (numb == undefined) {
                    if (this.ScreenObject.Preferences.ContainsKey("StartNoForNewPrefix") && !Util.IsEmpty(this.ScreenObject.Preferences["StartNoForNewPrefix"]) && this.ScreenObject.Preferences["StartNoForNewPrefix"] != "0")
                        this.ScreenObject.DocPrefix.ComboBox.Items.push(ComboBoxItems.ComboBoxItems_4(DocNum, DocNum, "", this.ScreenObject.Preferences["StartNoForNewPrefix"].length.toString()));
                    else
                        this.ScreenObject.DocPrefix.ComboBox.Items.push(ComboBoxItems.ComboBoxItems_4(DocNum, DocNum, "", "1"));
                }
                if (!NewAdded.ContainsKey(DocNum))
                    NewAdded.push(DocNum, val);
            }
        });

        if (IsDateExists && NewAdded.length > 0 && !IsNotDate && ClearMessage && !Util.IsEmpty(this.ScreenObject.DocPrefix.ComboBox.SelectedValue) && !NewAdded.ContainsKey(this.ScreenObject.DocPrefix.ComboBox.SelectedValue)) {
            this.isFromDate = true;
            let Val = NewAdded.GetItemByValue(true);
            if (Val == null && NewAdded.length > 0)
                this.ScreenObject.DocPrefix.ComboBox.SelectedValue = NewAdded.keys[0];
            else
                this.ScreenObject.DocPrefix.ComboBox.SelectedValue = Val.Key;
            this.isFromDate = false;
        }
        else if (IsDateExists && NewAdded.length > 0 && IsNotDate && ClearMessage &&
            (Util.IsEmpty(this.ScreenObject.DocPrefix.ComboBox.SelectedValue) || !NewAdded.ContainsKey(this.ScreenObject.DocPrefix.ComboBox.SelectedValue))) {
            this.isFromDate = true;
            let Val = NewAdded.GetItemByValue(true);
            if (Val == null && NewAdded.length > 0)
                this.ScreenObject.DocPrefix.ComboBox.SelectedValue = NewAdded.keys[0];
            else
                this.ScreenObject.DocPrefix.ComboBox.SelectedValue = Val.Key;
            this.isFromDate = false;
        }
        else if (!IsDateExists && IsNotDate) {
            this.isFromDate = true;
            let indVal = this.ScreenObject.DocPrefix.Prefixes.values.indexOf(true);
            if (indVal == -1 && this.ScreenObject.DocPrefix.Prefixes.length > 0)
                DocNum = this.ScreenObject.DocPrefix.Prefixes.keys[0];
            else
                DocNum = this.ScreenObject.DocPrefix.Prefixes.keys[indVal];

            if (DocNum != null) {
                let numb = this.ScreenObject.DocPrefix.ComboBox.Items.find(a => a.Value == DocNum);
                if (Util.IsEmpty(numb)) {
                    if (this.ScreenObject.Preferences.ContainsKey("StartNoForNewPrefix") && !Util.IsEmpty(this.ScreenObject.Preferences["StartNoForNewPrefix"]) && this.ScreenObject.Preferences["StartNoForNewPrefix"] != "0")
                        this.ScreenObject.DocPrefix.ComboBox.Items.push(ComboBoxItems.ComboBoxItems_4(DocNum, DocNum, "", this.ScreenObject.Preferences["StartNoForNewPrefix"].length.toString()));
                    else
                        this.ScreenObject.DocPrefix.ComboBox.Items.push(ComboBoxItems.ComboBoxItems_4(DocNum, DocNum, "", "1"));
                }
                this.ScreenObject.DocPrefix.ComboBox.SelectedValue = DocNum;
            }

            this.isFromDate = false;
        }

        if (this.IsInventoryVoucher) {
            if (this.ScreenObject.IsPurchase && this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0)
                this.ScreenObject.GetDueDate(this.ScreenObject.CreditAccount.SelectedValue, this.DocumentDate, this.ScreenObject.IsPurchase);
            else if (!this.ScreenObject.IsPurchase && this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0)
                this.ScreenObject.GetDueDate(this.ScreenObject.DebitAccount.SelectedValue, this.DocumentDate, this.ScreenObject.IsPurchase);
        }
        if (!IsNotDate) {
            if (ClearMessage) {
                this.DisplayMessage = "";
            }
            //CheckLockDate();
        }
        // code added. wajid.
        if (this.ScreenObject.DocPrefix.ComboBox.Items.length > 0) {
            if (this.ScreenObject.DocPrefix.ComboBox.SelectedValue != null) {
                let item = this.ScreenObject.DocPrefix.ComboBox.Items.find(x => x.Value == this.ScreenObject.DocPrefix.ComboBox.SelectedValue);
                if (item) {
                    this.ScreenObject.DocPrefix.ComboBox.SelectedItem = item;
                    this.ScreenObject.DocPrefix.ComboBox.Text = item.Name;
                }

            }
        }
    }

    // Name : FillExchangeRates
    // Desc : currency exchange rate calculation.
    // Category : COMMON
    FillExchangeRates() {
        if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
            let tempint = Util.Int(BaseService.SessionManager.Preferences["DimensionwiseCurrency"]);
            if (this.Currency) {
                if (this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue != "") {
                    if (this.Currency.Currency.SelectedValue == "1") {
                        if (tempint > 5000)
                            this.Currency.ExchangeRate.Text = this.ScreenObject.GetExchangeRate(parseInt(this.Currency.Currency.SelectedValue), this.DocumentDate).toString();
                        else
                            this.Currency.ExchangeRate.Text = "1.0";
                    }
                    else
                        this.Currency.ExchangeRate.Text = this.ScreenObject.GetExchangeRate(parseInt(this.Currency.Currency.SelectedValue), this.DocumentDate).toString();
                }
            }

            this.ScreenObject.ColumnSource.forEach(col => {
                if (col.CurrID > 0) {
                    if (col.CurrID == 1) {
                        if (tempint > 5000)
                            col.ExhcgRt = this.ScreenObject.GetExchangeRate(col.CurrID, this.DocumentDate);
                        else
                            col.ExhcgRt = 1;
                    }
                    else
                        col.ExhcgRt = this.ScreenObject.GetExchangeRate(col.CurrID, this.DocumentDate);
                }
            });

            let drmat: any[] = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 55847);

            if (drmat.length > 0 && BaseService.SessionManager.Preferences["BaseCurrency"] != "" && Util.IsNum(BaseService.SessionManager.Preferences["BaseCurrency"]) && Util.Double((BaseService.SessionManager.Preferences["BaseCurrency"])) > 0) {
                let fld = this.ScreenObject._TextFields.find(a => a.DBColumnID.toString() == drmat[0]["CostcenterColid"].toString());
                if (fld && fld instanceof PactTextBoxData) {
                    fld.Text = this.ScreenObject.GetExchangeRate(parseInt(BaseService.SessionManager.Preferences["BaseCurrency"]), this.DocumentDate).toString();
                }
            }
        }
        let Current = "1";
        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (this.IsInventoryVoucher) {
                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]))
                    continue;
            }
            else {
                if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                    continue;
                else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                    continue;
                else if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"]))
                    continue;
            }
            for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcnum")) {
                    Current = this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "").toString();
                    if (this.ScreenObject.GridDataColumns.Contains("dcExchRT" + Current) && this.ScreenObject.GridDataColumns.Contains("dcCurrID" + Current + "_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCurrID" + Current + "_Key"])) {
                        if (parseInt(this.ScreenObject.GridData[i]["dcCurrID" + Current + "_Key"]) == 1)
                            this.ScreenObject.GridData[i]["dcExchRT" + Current] = "1";
                        else
                            this.ScreenObject.GridData[i]["dcExchRT" + Current] = this.ScreenObject.GetExchangeRate(parseInt(this.ScreenObject.GridData[i]["dcCurrID" + Current + "_Key"]), this.DocumentDate);
                    }
                }
            }
            this.CalculateTotals(this.ScreenObject.GridData[i], false);
        }
        if (this.IsInventoryVoucher) {
            for (let i = 0; i < this.ScreenObject.FooterGridData.length; i++) {
                if (!Util.IsEmpty(this.ScreenObject.FooterGridData[i]["Amount"]) && !Util.IsEmpty(this.ScreenObject.FooterGridData[i]["dcCurrID_Key"])) {
                    if (parseInt(this.ScreenObject.FooterGridData[i]["dcCurrID_Key"]) == 1)
                        this.ScreenObject.FooterGridData[i]["dcExchRT"] = "1";
                    else
                        this.ScreenObject.FooterGridData[i]["dcExchRT"] = this.ScreenObject.GetExchangeRate(parseInt(this.ScreenObject.FooterGridData[i]["dcCurrID_Key"]), this.DocumentDate);
                }
            }
        }
    }

    LoadLinkedVouchersBasedOnPrefernce() {
        if (this.ScreenObject.DocID == 0 && this.ScreenObject.Preferences.ContainsKey("ShowLinkedDocsBasedon") && this.ScreenObject.Preferences["ShowLinkedDocsBasedon"].toString() != "") {
            let f = this.ScreenObject.HeaderFields.find(x => x instanceof PactDatePickerData && x.DBColumnID == parseInt(this.ScreenObject.Preferences["ShowLinkedDocsBasedon"]))
            if (f && f.Date) {
                return this.OLinkSelectionChanged("");
            }
        }
    }
    // Name : GetTrimString
    // Desc : Triming the given string.
    // Category : COMMON
    GetTrimString(s: string, length: number): string {
        if (s != null && length >= 0 && s.length > length)
            return s.substr(0, length);
        else
            return s;
    }

    // Name : ChangeLocation
    // Desc : Location change on shortcut key and button click.
    // Category : COMMON
    ChangeLocation(Change: boolean, IsEdit: boolean, LocID: number, srcdoc: any = null) {
        if (this.ScreenObject.DocumentType == 31) {
            this.CheckStockDimensions();
            this.DocumentNumber = new DocumentNumberViewModel(this, this.ScreenObject.Data.Tables[8], true, srcdoc);
            //BaseService.page.ShowDialog(this.DocumentNumber, DocumentNumberWIthTreeComponent, { HideClose: true, ShowCenter: true, Title: BaseService.GetResource("DocumentNumberTitle") })
            BaseService.page.ShowDialog(this.DocumentNumber, DocumentNumberWIthTreeComponent
                , {
                    HideClose: true, ShowCenter: true, Title: BaseService.GetResource("DocumentNumberTitle")
                    , CallBack: [this, "DocNumberCallBack"], MobileLeftZero: true
                });
        }
        else if ((this.ScreenObject.Data.Tables.length > 8 && this.ScreenObject.Data.Tables[8].length > 0)
            || (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True"
                && !(this.ScreenObject.Preferences.ContainsKey("Donotusedivision") && this.ScreenObject.Preferences["Donotusedivision"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotusedivision"]))
                && BaseService.SessionManager.DivisionID == 0)
            || (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True"
                && !(this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])) && LocID == 0) || Change) {
            let dvprefix = this.ScreenObject.Data.Tables[8].filter(x => x.CCID > 50000);
            if (dvprefix.length > 0 || (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True"
                && !(this.ScreenObject.Preferences.ContainsKey("Donotusedivision") && this.ScreenObject.Preferences["Donotusedivision"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotusedivision"]))
                && BaseService.SessionManager.DivisionID == 0)
                || (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True"
                    && !(this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"]))
                    && LocID == 0) || Change) {
                dvprefix = this.ScreenObject.Data.Tables[8].filter(x => x.CCID > 50000 && x.CCID != 50002);
                let dvdiv = this.ScreenObject.Data.Tables[8].filter(x => x.CCID > 50000 && x.CCID != 50002 && x.CCID != 50001);
                if (!Change && LocID > 0 && dvprefix.length == 0
                    && !(BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True"
                        && !(this.ScreenObject.Preferences.ContainsKey("Donotusedivision") && this.ScreenObject.Preferences["Donotusedivision"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotusedivision"]))
                        && BaseService.SessionManager.DivisionID == 0)) {
                    let DocNumber = "";
                    let series: number = 0;
                    for (let i = 0; i < this.ScreenObject.Data.Tables[8].length; i++) {
                        if (i == 0)
                            series = parseInt(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]);

                        if (!Util.IsEmpty(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]) && parseInt(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]) != series) {
                            if (this.ScreenObject.DocPrefix != null && !this.ScreenObject.DocPrefix.Prefixes.ContainsKey(DocNumber))
                                this.ScreenObject.DocPrefix.Prefixes.push(DocNumber, parseBoolean(this.ScreenObject.Data.Tables[8][i - 1]["Isdefault"]));

                            series = parseInt(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]);
                            DocNumber = "";
                        }

                        if (parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 50002) {
                            DocNumber += this.GetTrimString(this.ScreenObject.GetDocNumberString(this.ScreenObject.Data.Tables[8][i]["SysColumnName"], 50002, LocID), parseInt(this.ScreenObject.Data.Tables[8][i]["Length"])) + this.ScreenObject.Data.Tables[8][i]["Delimiter"].toString();
                        }
                        else if (parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 51 || parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 52 || parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 53) {
                            DocNumber += "'" + this.ScreenObject.Data.Tables[8][i]["Length"].toString() + "'" + this.ScreenObject.Data.Tables[8][i]["Delimiter"].toString();
                        }
                        else if (parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 54) {
                            DocNumber += this.ScreenObject.Data.Tables[8][i]["Length"].toString() + this.ScreenObject.Data.Tables[8][i]["Delimiter"].toString();
                        }
                    }
                    if (this.ScreenObject.Data.Tables[8].length > 0 && this.ScreenObject.DocPrefix != null && !this.ScreenObject.DocPrefix.Prefixes.ContainsKey(DocNumber))
                        this.ScreenObject.DocPrefix.Prefixes.push(DocNumber, parseBoolean(this.ScreenObject.Data.Tables[8][this.ScreenObject.Data.Tables[8].length - 1]["Isdefault"]));
                    this.DialogResult = true;
                }
                else if (!Change && LocID > 0 && BaseService.SessionManager.DivisionID > 0 && dvdiv.length == 0) {
                    let DocNumber = "";
                    let series = 0;
                    for (let i = 0; i < this.ScreenObject.Data.Tables[8].length; i++) {
                        if (i == 0)
                            series = parseInt(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]);

                        if (!Util.IsEmpty(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]) && parseInt(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]) != series) {
                            if (this.ScreenObject.DocPrefix != null && !this.ScreenObject.DocPrefix.Prefixes.ContainsKey(DocNumber))
                                this.ScreenObject.DocPrefix.Prefixes.push(DocNumber, parseBoolean(this.ScreenObject.Data.Tables[8][i - 1]["Isdefault"]));

                            series = parseInt(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]);
                            DocNumber = "";
                        }
                        if (parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 50002) {
                            DocNumber += this.GetTrimString(this.ScreenObject.GetDocNumberString(this.ScreenObject.Data.Tables[8][i]["SysColumnName"], 50002, LocID), parseInt(this.ScreenObject.Data.Tables[8][i]["Length"])) + this.ScreenObject.Data.Tables[8][i]["Delimiter"].toString();
                        }
                        else if (parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 50001) {
                            DocNumber += this.GetTrimString(this.ScreenObject.GetDocNumberString(this.ScreenObject.Data.Tables[8][i]["SysColumnName"], 50001, BaseService.SessionManager.DivisionID), parseInt(this.ScreenObject.Data.Tables[8][i]["Length"])) + this.ScreenObject.Data.Tables[8][i]["Delimiter"].toString();
                        }
                        else if (parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 51 || parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 52 || parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 53) {
                            DocNumber += "'" + this.ScreenObject.Data.Tables[8][i]["Length"].toString() + "'" + this.ScreenObject.Data.Tables[8][i]["Delimiter"].toString();
                        }
                        else if (parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 54) {
                            DocNumber += this.ScreenObject.Data.Tables[8][i]["Length"].toString() + this.ScreenObject.Data.Tables[8][i]["Delimiter"].toString();
                        }
                    }
                    if (this.ScreenObject.Data.Tables[8].length > 0 && this.ScreenObject.DocPrefix != null && !this.ScreenObject.DocPrefix.Prefixes.ContainsKey(DocNumber))
                        this.ScreenObject.DocPrefix.Prefixes.push(DocNumber, parseBoolean(this.ScreenObject.Data.Tables[8][this.ScreenObject.Data.Tables[8].length - 1]["Isdefault"]));
                    this.DialogResult = true;
                }
                else if (!IsEdit) {
                    this.DocumentNumber = new DocumentNumberViewModel(this, this.ScreenObject.Data.Tables[8], false, srcdoc)
                    this.DocumentNumber.IsFirstCall = !Change;
                    if (!Util.IsEmpty(this.DocumentNumber.DisplayMessage)) {
                        if (!IsEdit) {

                            var fields = Object.assign([], this.DocumentNumber.DocNumberFields)
                            for (let index = 0; index < fields.length; index++) {
                                const element: any = fields[index];

                                let compo = new PListViewComponent(BaseService.SessionManager, null, null, null, BaseService.common)
                                var item = Object.assign({}, element)
                                compo.oPactListBox = item;
                                try {
                                    compo.ngOnInit()
                                    compo.PrepareList()
                                    try {
                                        compo.CustomWhere = element.CustomWhere
                                    } catch (error) {
                                        console.log(error)
                                    }


                                    // compo.instance.FillListBox(true)

                                    if (!Util.IsEmpty(element.SelectedValue) || element.SelectedValue == 0) {
                                        if (compo.Items.length == 1) {
                                            if (!Util.IsEmpty(compo.Items[0].NodeID)) {
                                                element.SelectedValue = compo.Items[0].NodeID

                                                // var item = this.DocumentNumber.DocNumberFields.find(x=>x.CCID == element.CCID)
                                                // if (!Util.IsEmpty(item)) {
                                                //     item.SelectedValue = element.SelectedValue
                                                // }
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.log(error)
                                }
                                // let comp = new PListViewComponent(BaseService.SessionManager,null,null,null,BaseService.common)
                                // comp.SessionManager = BaseService.SessionManager
                                // comp.oPactListBox = element;
                                // 
                                // comp.ngOnInit()
                                // comp.PrepareList()
                                // comp.FillListBox(true)
                                //comp.GetData(8,'',false,0)
                            }

                            if (!this.DocumentNumber.ISTree) {
                                this.DocumentNumber.OnSave("Save");
                            }


                            if (!Util.IsEmpty(this.DocumentNumber.DisplayMessage)) {
                                BaseService.page.ShowDialog(this.DocumentNumber, DocumentNumberComponent
                                    , {
                                        HideClose: true, ShowCenter: true, Title: BaseService.GetResource("DocumentNumberTitle")
                                        , CallBack: [this, "DocNumberCallBack"]
                                    });
                            }
                            //this.DialogResult = true;// temporary setting DialogResult to true, actually it set in Document number viewmodel.

                            //.subscribe(()=>{alert('CallBakc')})
                        }
                    }
                }
            }
            else {
                let DocNumber = "";
                let series = 0;
                for (let i = 0; i < this.ScreenObject.Data.Tables[8].length; i++) {
                    if (i == 0)
                        series = parseInt(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]);

                    if (!Util.IsEmpty(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]) && parseInt(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]) != series) {
                        if (this.ScreenObject.DocPrefix && !this.ScreenObject.DocPrefix.Prefixes.ContainsKey(DocNumber)) {
                            if (i > 0)
                                this.ScreenObject.DocPrefix.Prefixes.push(DocNumber, parseBoolean(this.ScreenObject.Data.Tables[8][i - 1]["Isdefault"]));
                            else
                                this.ScreenObject.DocPrefix.Prefixes.push(DocNumber, parseBoolean(this.ScreenObject.Data.Tables[8][i]["Isdefault"]));
                        }
                        series = parseInt(this.ScreenObject.Data.Tables[8][i]["SeriesNo"]);
                        DocNumber = "";
                    }
                    if (parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 51 || parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 52 || parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 53) {
                        DocNumber += "'" + this.ScreenObject.Data.Tables[8][i]["Length"].toString() + "'" + this.ScreenObject.Data.Tables[8][i]["Delimiter"].toString();
                    }
                    else if (parseInt(this.ScreenObject.Data.Tables[8][i]["CCID"]) == 54) {
                        DocNumber += this.ScreenObject.Data.Tables[8][i]["Length"].toString() + this.ScreenObject.Data.Tables[8][i]["Delimiter"].toString();
                    }
                }
                if (this.ScreenObject.Data.Tables[8].length > 0 && this.ScreenObject.DocPrefix != null && !this.ScreenObject.DocPrefix.Prefixes.ContainsKey(DocNumber))
                    this.ScreenObject.DocPrefix.Prefixes.push(DocNumber, parseBoolean(this.ScreenObject.Data.Tables[8][this.ScreenObject.Data.Tables[8].length - 1]["Isdefault"]));
                this.DialogResult = true;
            }
        }
        else
            this.DialogResult = true;

        if (!this.DocumentNumber || !this.DocumentNumber.DialogOptions || !this.DocumentNumber.DialogOptions.IsOpen) {
            this.DocNumberCallBack(Change);
        }
    }

    DocNumberDelegate = new Delegate() // DocNumber Delegate declare.

    // Name : DocNumberCallBack
    // Desc : DocNumber CallBack.
    // Category : COMMON
    DocNumberCallBack(Change) {
        this.CheckDateInDocNumber(true);
        if (Change)
            this.OnDocPrefixChanged_2(this.ScreenObject.Prefix, true);
        else
            this.OnDocPrefixChanged_2(this.ScreenObject.Prefix, false);

        this.ScreenObject.SetDefaultValuesforCostCenters(0);
        this.ScreenObject.FillListViews(false);

        // Below code added By Khasim for calling callback function on Voucher Prefix */
        if (this.IsPOs && this.DialogResult) {
            let CCCondition = "";
            let cid = 0;

            if (this.DocumentNumber != null && this.DocumentNumber.DocNumberFields.length > 0) {
                for (let i = 0; i < this.DocumentNumber.DocNumberFields.length; i++) {
                    if (this.DocumentNumber.DocNumberFields[i].CCID > 50000)
                        CCCondition = CCCondition + " AND CCD.dcCCNID" + (this.DocumentNumber.DocNumberFields[i].CCID - 50000) + "=" + this.DocumentNumber.DocNumberFields[i].SelectedValue;
                }
            }

            let iRes: any = BaseService.admin.POSLogin(this.ScreenObject.RegisterNodeID, this.ScreenObject.ShiftNodeID, this.DocumentDate, 100, "", "", CCCondition);//, out this.PosSessionID);
            let dsPosLogin = iRes;
            this.PosSessionID = iRes.obj;
            if (this.PosSessionID == -11) {
                //let mesres = Microsoft.Windows.Controls.MessageBox.Show(Application.Current.MainWindow, "Shift is closed.Do you want to open another shift?", "Alert", MessageBoxButton.YesNo);
                let mesres = confirm("Shift is closed.Do you want to open another shift?")
                if (mesres == true)//MessageBoxResult.Yes)
                {

                    let dsnode: any = BaseService.common.GetDataSet3("POS001", BaseService.SessionManager.Preferences["PosShifts"], this.ScreenObject.GetTableName(parseInt(BaseService.SessionManager.Preferences["PosShifts"])), this.DocumentDate.ToString("dd/MMM/yyyy"));
                    if (dsnode != null && dsnode.Tables.length > 0 && dsnode.Tables[0].length > 0 && dsnode.Columns[0].Contains("NodeID")) {
                        this.ScreenObject.ShiftNodeID = parseInt(dsnode.Tables[0][0]["NodeID"]);
                        iRes = BaseService.admin.POSLogin(this.ScreenObject.RegisterNodeID, this.ScreenObject.ShiftNodeID, this.DocumentDate, 100, "", "", CCCondition);//, out this.PosSessionID);
                        dsPosLogin = iRes;
                        this.PosSessionID = iRes.obj;
                        let fld: any = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == parseInt(BaseService.SessionManager.Preferences["PosShifts"]));
                        if (fld) {
                            fld.SelectedValue = this.ScreenObject.ShiftNodeID;
                            fld.DefaultValue = this.ScreenObject.ShiftNodeID.toString();
                        }
                    }
                    else {
                        //Microsoft.Windows.Controls.MessageBox.Show(Application.Current.MainWindow, "All Shifts are closed.", "Alert", MessageBoxButton.OK);
                        alert("All Shifts are closed.");
                        this.DialogResult = false;
                        return;
                    }
                }
                else {
                    this.DialogResult = false;
                    return;
                }
            }

            if (this.PosSessionID == -9) {
                //Microsoft.Windows.Controls.MessageBox.Show(Application.Current.MainWindow, "Invalid user for this Register", "Alert", MessageBoxButton.OK);
                alert("Invalid user for this Register");
                this.DialogResult = false;
                return;
            }
            if (this.PosSessionID == -10) {
                //Microsoft.Windows.Controls.MessageBox.Show(Application.Current.MainWindow, "POS session locked by user '" + dsPosLogin.Tables[0][0]["UserName"].toString() + "'", "Alert", MessageBoxButton.OK);
                alert("POS session locked by user '" + dsPosLogin.Tables[0][0]["UserName"].toString() + "'");
                this.DialogResult = false;
                return;
            }

            if (!Util.IsEmpty(this.DocumentDate) && this.DocumentDate.ToString('ddMMMyyyy') != Date.Today().ToString('ddMMMyyyy')) {
                if (this.DocumentDate > Date.Today()) {
                    if (BaseService.SessionManager.Preferences.ContainsKey("NoFuturetransaction") && BaseService.SessionManager.Preferences["NoFuturetransaction"] == "True") {
                        if (BaseService.SessionManager.IsActionAssigned(43, "Re-Open Pos Closed Shift")) {
                            //let res = Microsoft.Windows.Controls.MessageBox.Show(Application.Current.MainWindow, "Day is closed.Do you want to open last shift?", "Alert", MessageBoxButton.YesNo);
                            let res = confirm("Day is closed.Do you want to open last shift?");
                            if (res == true)//MessageBoxResult.Yes)
                            {
                                let objParam = [];
                                objParam.push(this.PosSessionID);//0
                                objParam.push(this.ScreenObject.RegisterNodeID);//1

                                if (this.ScreenObject.Preferences.ContainsKey("PosJVOn") && (this.ScreenObject.Preferences["PosJVOn"] == "2" || this.ScreenObject.Preferences["PosJVOn"] == "1")) {
                                    objParam.push(this.ScreenObject.Preferences["PosJVOn"]);//2
                                    objParam.push(BaseService.SessionManager.RegisterCCID);//3
                                    objParam.push(BaseService.SessionManager.Preferences["PosShifts"]);//4
                                    objParam.push(BaseService.SessionManager.UserID);//5
                                    objParam.push(BaseService.SessionManager.UserName);//6
                                    objParam.push(BaseService.SessionManager.RoleID);//7
                                    objParam.push(BaseService.SessionManager.LanguageID);//8


                                }

                                let resDs: any = BaseService.document.ReOpenClosedShift(objParam);

                                this.DialogResult = false;
                                return;
                            }
                        }
                        else {
                            //Microsoft.Windows.Controls.MessageBox.Show(Application.Current.MainWindow, "Day is closed.", "Alert", MessageBoxButton.OK);
                            alert("Day is closed.");
                            //this.ScreenObject.ExecuteQuery("delete from POS_loginHistory where POSLoginHistoryID=" + this.PosSessionID);
                            let resDs: any = BaseService.common.GetDataSet("POS002", this.PosSessionID.toString());
                            this.DialogResult = false;
                            return;
                        }
                    }
                    else
                        if (BaseService.SessionManager.IsWebApplication) {
                            alert("Document date and system date are not same.");
                            if (BaseService.SessionManager.Preferences.ContainsKey("DonotopenPOSScreenwhenSystemDateismismatch") && BaseService.SessionManager.Preferences["DonotopenPOSScreenwhenSystemDateismismatch"] == "True") {
                                this.DialogResult = false;
                                return;
                            }
                        }
                }
                else {
                    if (BaseService.SessionManager.IsWebApplication) {
                        alert("Document date and system date are not same.");
                        if (BaseService.SessionManager.Preferences.ContainsKey("DonotopenPOSScreenwhenSystemDateismismatch") && BaseService.SessionManager.Preferences["DonotopenPOSScreenwhenSystemDateismismatch"] == "True") {
                            this.DialogResult = false;
                            return;
                        }
                    }
                }
            }

            let tempdouble;
            if (this.ScreenObject.Preferences.ContainsKey("RowHeight") && !Util.IsEmpty(this.ScreenObject.Preferences["RowHeight"]) &&
                Util.Double(this.ScreenObject.Preferences["RowHeight"]) > 0)
                this.GridRowHeight = parseFloat(this.ScreenObject.Preferences["RowHeight"]);

            if (this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 39) {
                if (this.ScreenObject.Preferences.ContainsKey("right panel width") && !Util.IsEmpty(this.ScreenObject.Preferences["right panel width"]) &&
                    Util.Double(this.ScreenObject.Preferences["right panel width"]) > 0)
                    this.RightPanelWidth = parseFloat(this.ScreenObject.Preferences["right panel width"]);

                if (this.ScreenObject.Data.Columns[1].Contains("RightPanelWidth") && !Util.IsEmpty(this.ScreenObject.Data.Tables[1][0]["RightPanelWidth"])
                    && Util.Double(this.ScreenObject.Data.Tables[1][0]["RightPanelWidth"]) > 0)
                    this.RightPanelWidth = parseFloat(this.ScreenObject.Data.Tables[1][0]["RightPanelWidth"]);

                if (this.ScreenObject.Data.Columns[1].Contains("RowSize") && !Util.IsEmpty(this.ScreenObject.Data.Tables[1][0]["RowSize"])
                    && Util.Double(this.ScreenObject.Data.Tables[1][0]["RowSize"]) > 0)
                    this.GridRowHeight = parseFloat(this.ScreenObject.Data.Tables[1][0]["RowSize"]);

                if (this.ScreenObject.Data.Columns[1].Contains("TouchScreen") && !Util.IsEmpty(this.ScreenObject.Data.Tables[1][0]["TouchScreen"])
                    && parseBoolean(this.ScreenObject.Data.Tables[1][0]["TouchScreen"])) {
                    this.TouchVisibility = true;
                    if ((this.ClassName == "POSDocumentViewModel")) {
                        this.TouchView = new TouchScreenViewModel(this);
                        this.NumericPADView = new NumericPADViewModel(this);
                    }
                    // if (this.ScreenObject.Data.Columns[1].Contains("Display") && this.ScreenObject.Data.Tables[1][0]["Display"].toString() != ""
                    //&& parseBoolean(this.ScreenObject.Data.Tables[1][0]["Display"]))
                    // {
                    //     FooterTouchVisible = true;
                    //     TouchVisibility = false;

                    //if (this.ScreenObject.Preferences.ContainsKey("right panel width") && this.ScreenObject.Preferences["right panel width"] != "" &&
                    //    Util.Double(this.ScreenObject.Preferences["right panel width"], out tempdouble))
                    //    RightPanelWidth = parseFloat(this.ScreenObject.Preferences["right panel width"]);
                    //}
                }
            }

            if (dsPosLogin.Tables.length > 0 && dsPosLogin.Columns[0].Contains("IsOpening") && dsPosLogin.Tables[0][0]["IsOpening"].toString() == "1") {
                if (this.ScreenObject.Preferences.ContainsKey("DonotConsiderOpeningInPaymode") && this.ScreenObject.Preferences["DonotConsiderOpeningInPaymode"] != "" && parseBoolean(this.ScreenObject.Preferences["DonotConsiderOpeningInPaymode"])) {

                    //ShellWindowViewModel.Instance().PopViewModel = new AddDenominationViewModel(this, null);
                    let AddDenom = new AddDenominationViewModel(this, null);
                    AddDenom.Currency.Label = "Imprest Opening Balance";
                    BaseService.page.ShowDialog(AddDenom, AddDenominationComponent, { ShowCenter: true }).subscribe(sender => {
                        if (!this.DialogResult) {
                            //this.ScreenObject.ExecuteQuery("delete from POS_loginHistory where POSLoginHistoryID=" + this.PosSessionID);
                            let resDs: any = BaseService.common.GetDataSet("POS002", this.PosSessionID.toString());
                            return;
                        }
                    });


                }
                else if (BaseService.SessionManager.Preferences.ContainsKey("OpeningCashDOc") && BaseService.SessionManager.Preferences["OpeningCashDOc"] != "" && BaseService.SessionManager.Preferences["OpeningCashDOc"] != "0") {
                    try {
                        //ShellWindowViewModel.Instance().PopViewModel = new PostVoucherSaveViewModel(this, parseInt(BaseService.SessionManager.Preferences["OpeningCashDOc"]), 0, 0, 1, 1, false, true);
                        let PostVoucherS = new PostVoucherSaveViewModel(this, parseInt(BaseService.SessionManager.Preferences["OpeningCashDOc"]), 0, 0, 1, 1, false, true);
                        // BaseService.page.ShowDialog(PostVoucherS, AddDenominationComponent, { ShowCenter: true }).subscribe(sender => {
                        BaseService.page.ShowDialog(PostVoucherS, PostVoucherSaveComponent, { ShowCenter: true }).subscribe(sender => {
                            if (!this.DialogResult) {
                                //this.ScreenObject.ExecuteQuery("delete from POS_loginHistory where POSLoginHistoryID=" + this.PosSessionID);
                                let resDs: any = BaseService.common.GetDataSet("POS002", this.PosSessionID.toString());
                                BaseService.page.removeActiveTab();
                                return;
                            }
                        });

                    }
                    catch (error) {
                        this.DisplayMessage = "Error In Loading Cash Receipt Document";
                        Logger.ErrorLog("POS CashIn:", error.message);
                    }
                }
            }

            if (dsPosLogin.Tables.length > 1 && dsPosLogin.Columns[1].Contains("EPOSDim") && dsPosLogin.Tables[1][0]["EPOSDim"].toString() != "1" && BaseService.SessionManager.Preferences.ContainsKey("EPOS") && Util.Int(BaseService.SessionManager.Preferences["EPOS"]) > 0) {
                let EPOSDim: any = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == cid);
                if (EPOSDim != undefined) {
                    EPOSDim.CustomWhere = " a.NodeID IN (" + dsPosLogin.Tables[1][0]["EPOSDim"].toString() + ")";
                    if (!dsPosLogin.Tables[1][0]["EPOSDim"].toString().Contains(','))
                        EPOSDim.SelectedValue = parseInt(dsPosLogin.Tables[1][0]["EPOSDim"]);
                }
            }

            if (dsPosLogin.Tables.length > 1 && dsPosLogin.Columns[1].Contains("SmartCardDim") && dsPosLogin.Tables[1][0]["SmartCardDim"].toString() != "1" && BaseService.SessionManager.Preferences.ContainsKey("SmartCard") && Util.Int(BaseService.SessionManager.Preferences["SmartCard"]) > 0) {
                let SmartCardDim: any = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == cid);
                if (SmartCardDim != undefined) {
                    SmartCardDim.CustomWhere = " a.NodeID IN (" + dsPosLogin.Tables[1][0]["SmartCardDim"].toString() + ")";
                    if (!dsPosLogin.Tables[1][0]["SmartCardDim"].toString().Contains(','))
                        SmartCardDim.SelectedValue = parseInt(dsPosLogin.Tables[1][0]["SmartCardDim"]);
                }
            }
        }
        else if (this.ScreenObject.Preferences.ContainsKey("EnableTouch") && parseBoolean(this.ScreenObject.Preferences["EnableTouch"])) {
            this.TouchVisibility = true;
            this.TouchView = new TouchScreenViewModel(this);
        }

        // below code added wajid, this code was in constructor
        if (BaseService.SessionManager.Preferences.ContainsKey("DisableAutoLoad") && BaseService.SessionManager.Preferences["DisableAutoLoad"].toLowerCase() == "true") {
            this.ScreenObject.FillListViews(true);
            if (this.ReportDimension)
                this.ReportDimension.IsAutoLoad = true;
        }

        if (this.ToLinkParent) {
            this.ToLinkParent.GenerateLinkDocument_Sub1(this);
            this.ToLinkParent = null;
        }
        if (this.DocNumberDelegate.IsSubscribed) {
            setTimeout(() => { this.DocNumberDelegate.Call(); }, 50);
        }

    }

    // Name : onDeleteRow
    // Desc : Delete grid view.
    // Category : COMMON
    onDeleteRow(sender) {
        if (this.IsSelectAll)
            return;
        this.ScreenObject.UpdateSequence();
        this.CalculateTotals(null, false);
        this.CheckVendorWiseLinkingPref();
    }
    lastCurr: string;// local variable to hold currency selected value.

    // Name : onCurrencyChanged
    // Desc : on Currency changed event fired.
    // Category : COMMON
    onCurrencyChanged(sender: any) {
        if (this.ScreenObject == null || (this.lastCurr != null && this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue == this.lastCurr))
            return;
        this.lastCurr = this.Currency.Currency.SelectedValue;
        if (this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue != "")
            this.Currency.ExchangeRate.Text = this.ScreenObject.GetExchangeRate(parseInt(this.Currency.Currency.SelectedValue), this.DocumentDate).toString();
        else
            this.Currency.ExchangeRate.Text = "1";

        if (this.ScreenObject.PriceTaxcc.ContainsKey(12))
            this.ReEvaluatePriceTax(12);
    }

    // Name : onExchangeRateChanged
    // Desc : on Exchange Rate change event fired.
    // Category : COMMON
    onExchangeRateChanged(sender: any) {
        this.ScreenObject.GridData.forEach(dr => {
            if (this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(dr["ProductID_Key"])
                && parseInt(dr["ProductID_Key"]) > 0) {
                this.CalculateTotals(dr, false);
            }
            else if (!this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(dr["DebitAccount_Key"])
                && parseInt(dr["DebitAccount_Key"]) > 0) {
                this.CalculateTotals(dr, false);
            }
            else if (!this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(dr["CreditAccount_Key"])
                && parseInt(dr["CreditAccount_Key"]) > 0) {
                this.CalculateTotals(dr, false);
            }
            else if (!this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(dr["AccountID_Key"])
                && parseInt(dr["AccountID_Key"]) > 0) {
                this.CalculateTotals(dr, false);
            }
        });
    }

    public bTimer:any
    BidTimer() {
        

        this.bTimer = setInterval(() => {
            // First Date
            let firstDate: Date = new Date(this.BidEndTime);

            // Current Date
            let secondDate: Date = new Date();

            // Time Difference in Milliseconds
            let milliDiff: number = firstDate.getTime() - secondDate.getTime();

            this._Biddifference = milliDiff / (1000 * 60 * 60 * 24);

            // Converting time into hh:mm:ss fromat

            // Total number of seconds in the difference
            let totalSeconds = Math.floor(milliDiff / 1000);

            // Total number of minutes in the difference
            let totalMinutes = Math.floor(totalSeconds / 60);

            // Total number of hours in the difference
            let totalHours = Math.floor(totalMinutes / 60);

            // Getting the number of seconds left in one minutes
            let remSeconds = totalSeconds % 60;

            // Getting the number of minutes left in one hours
            let remMinutes = totalMinutes % 60;

            if (totalHours >= 24) {
                let temhrs = Math.floor(totalHours / 24)
                totalHours = totalHours - (temhrs * 24)
            }
            this._Bidhours = totalHours.toString();
            this._Bidminutes = remMinutes.toString();
            this._Bidseconds = remSeconds.toString();

            let bdays = Util.Int(this._Biddays)


            if (bdays == 0 && this._Bidhours == "0" && this._Bidminutes == "0" && this._Bidseconds == "0") {
                this.BiddingCloseFunctionality();
                clearInterval(this.bTimer);
            }
            else {
                !isNaN(bdays) ? (this._Biddays = Math.floor(this._Biddifference).toString()) : (this._Biddays = "");
            }



        }, 1000);

        //#region Reserved word - Bidding Rank in body.
        // Reserved word - Bidding Rank in body.
        let drrLD: any = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && (x.LinkData == 7807));
        if (drrLD.length > 0) {
            this.GetBidRankSysColName(drrLD);
        }
        //#endregion

        this.InitBidRankGrid();
        this.OnRankRefresh();
        let RankTimer = setInterval(() => {
            this.OnRankRefresh();
            if (this.BiddingStauts == false) {
                this.BidMessage = "Bidding stopped by the Auctioneer"
                this.BiddingCloseFunctionality()
                clearInterval(this.bTimer);
                clearInterval(RankTimer);
            }

        }, 10000);

    }
    _Biddays: string = "";
    _Bidhours: string = "";
    _Bidminutes: string = "";
    _Bidseconds: string = "";
    _Biddate: any;

    _Biddifference: number;
    _BidOverallRank = "";
    BidRankDisplayType = "overview";
    AutoExtendBeforeMin: number = 0 // to check time, if the bid time is about to end. ex. if bid is about to finish in 5 min,
    MinToExtend: number = 0 // this proprerty show how much time is extended in bidding. for ex 15 min extended.
    MaxExtensions: number = 0;
    MaxExtensionCount: number = 0;
    ShowOverAllRank : boolean = true;
    CheckMinutsBeforeTime = 0;
    
    
    public IncreaseBidTime() {
        if (this.AutoExtendBeforeMin != 0 && this.MinToExtend != 0 && this.MaxExtensions != 0) {
            let dsBid = BaseService.common.GetDataSet3("DOC091", this.parentBiddingDocID.toString(), "", "");
            if (dsBid != null && dsBid.Tables.length > 0 && dsBid.Tables[0].length > 0) {
                this.MaxExtensionCount = Util.Int(dsBid.Tables[0][0]["NoOfOccurence"]);
                if (this.MaxExtensionCount < this.MaxExtensions) {
                    let firstDate: Date = new Date(this.BidEndTime);
                    // Current Date
                    let secondDate: Date = new Date();
                    // Time Difference in Milliseconds
                    let Diff: number = firstDate.getTime() - secondDate.getTime();
                    let days1 = Math.floor(Diff / (1000 * 3600 * 24));
                    let hours1 = Math.floor(Diff / (1000 * 3600)) - (days1 * 24);
                    let minutes1 = Math.floor(Diff / (1000 * 60)) - (days1 * 24 * 60) + (hours1 * 60);
                    this.CheckMinutsBeforeTime = minutes1
                    if (this.CheckMinutsBeforeTime <= this.AutoExtendBeforeMin) {
                        let IncreasedTime = Util.ParseDate(this.BidEndTime).AddMinutes(this.MinToExtend).ToString("dd/MMM/yyyy hh:mm tt");
                        clearInterval(this.bTimer);
                        this.BidEndTime = IncreasedTime;
                        this.BidTimer();
                    }
                }
            }
        }
    }
    private BiddingCloseFunctionality() {
        this.ButtonBidRevise.Visible = false;
        this.ButtonBidReviseDistribute.Visible = false;
        if (this.RevisePrevVal) {
            this.ButtonRevise.Visible = true;
            this.ButtonSave.Visible = true;
            this.ButtonSaveandPrint.Visible = true;
            this.ButtonSaveandBarcode.Visible = true;
        }
        // this._Bidseconds = "0";
        // this._Bidminutes = "0";
        let oCl = this.ScreenObject.ColumnSource.find(x => x.DisplayMember == "drViewBid");
        if (oCl) {
            oCl.IsVisible = false;
            if (this.ScreenObject.GridDataObj.angularGrid)
                this.ScreenObject.GridDataObj.RefreshGridColumns.Call();
        }
    }

    OnRankRefresh() {
        //this.InitBidRankGrid();
        let dsBid = BaseService.common.GetDataSet3("DOC088", this.parentBiddingDocID.toString(), "", "");

        //#region Overall Rank Calculation.
        if (dsBid != null && dsBid.Tables.length > 0 && dsBid.Tables[0].length > 0) {
            let CurrentRank = 1;
            let PreviousAmount = "";
            for (let i = 0; i < dsBid.Tables[0].length; i++) {
                if (PreviousAmount == "" || PreviousAmount != Util.String(dsBid.Tables[0][i]["NetAmount"])) {
                    PreviousAmount = Util.String(dsBid.Tables[0][i]["NetAmount"]);
                    if (i !== 0)
                        CurrentRank++;
                }
                let iRateCount = dsBid.Tables[0].filter(x => x.NetAmount == Util.String(dsBid.Tables[0][i]["NetAmount"]));
                if (iRateCount.length == 1) {
                    dsBid.Tables[0][i]["Rank"] = "L" + CurrentRank;//+ " (" + 1 + ")";
                }
                else
                    dsBid.Tables[0][i]["Rank"] = "L" + CurrentRank + " (" + iRateCount.length + ")";
            }

            let RankData = dsBid.Tables[0].filter(x => x.DocID == this.DocID.toString()); //this.RetValue is nothing but DocID
            if (RankData.length > 0) {
                this._BidOverallRank = RankData[0]["Rank"];
            }
        }
        //#endregion

        //#region body grid rank Calculation.
        if (dsBid != null && dsBid.Tables.length > 1 && dsBid.Tables[1].length > 0) {

            for (let j = 0; j < this.BidRankGrid.Table.length; j++) {
                const dr = this.BidRankGrid.Table[j];
                let CurrentRank = 1;
                let PreviousAmount = "";
                let dv = dsBid.Tables[1].filter(x => x.ProductID == dr["ProductID_Key"] && x.DocSeqNo == dr["DocSeqNo"]);
                for (let i = 0; i < dv.length; i++) {
                    if (PreviousAmount == "" || PreviousAmount != Util.String(dv[i]["Rate"])) {
                        PreviousAmount = Util.String(dv[i]["Rate"]);
                        if (i !== 0)
                            CurrentRank++;
                    }
                    let iRateCount = dv.filter(x => x.Rate == Util.String(dv[i]["Rate"]));
                    if (iRateCount.length == 1) {
                        dv[i]["Rank"] = "L" + CurrentRank;// + " (" + 1 + ")";
                    }
                    else
                        dv[i]["Rank"] = "L" + CurrentRank + " (" + iRateCount.length + ")";
                }
                let RankData = dv.filter(x => x.DocID == this.DocID.toString());
                if (RankData.length > 0) {
                    dr[this.BidRankSysColName] = RankData[0]["Rank"];
                    this.BidRankGrid.updateRow(dr);

                }

            }
        }
        //#endregion

        //#region body grid rank Calculation.
        if (dsBid != null && dsBid.Tables.length > 2 && dsBid.Tables[2].length == 0) {
            this.BiddingStauts = false;
        }
        //#endregion
    }
    public BidRankGrid: PactGridViewModel
    InitBidRankGrid() {


        this.BidRankGrid = new PactGridViewModel();
        this.BidRankGrid.Columns = [];

        this.BidRankGrid.Table = [];

        this.BidRankGrid.BeginEdit.Subscribe(this, "onBeginEditBid");

        this.BidRankGrid.TableColumns = this.ScreenObject.GridDataColumns;

        let dgCol: DgColumn;
        if (this.BidRankDisplayType == "details") {
            this.BidRankGrid.Height = 500;
            this.BidRankGrid.Width = "500";
        }
        if (this.BidRankDisplayType == "overview") {
            dgCol = new DgColumn();
            dgCol.Header = "Sno";
            dgCol.Width = 30;
            dgCol.DisplayMember = "DocSeqNo";
            dgCol.ReadOnly = true;
            this.BidRankGrid.Columns.push(dgCol);

            dgCol = new DgColumn();
            dgCol.Header = "Product Code";
            dgCol.DataType = "LISTVIEW";
            dgCol.DisplayMember = "ProductCode";
            dgCol.Width = 100;
            dgCol.ReadOnly = true;
            this.BidRankGrid.Columns.push(dgCol);
        }
        if (this.BidRankDisplayType == "details") {
            dgCol = new DgColumn();
            dgCol.Header = "Sno";
            dgCol.Width = 50;
            dgCol.DisplayMember = "DocSeqNo";
            dgCol.ReadOnly = true;
            this.BidRankGrid.Columns.push(dgCol);


            let dsHideColumns = BaseService.common.GetDataSet3("DOC086", "40220", this.CostCenterID.toString(), "");
            if (dsHideColumns != null && dsHideColumns.Tables.length > 0 && dsHideColumns.Tables[0].length > 0) {
                for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
                    for (let j = 0; j < dsHideColumns.Tables[0].length; j++) {
                        const element = dsHideColumns.Tables[0][j];

                        if (Util.String(element["ColumnDataType"]) == "LISTBOX" && this.ScreenObject.ColumnSource[i].ValueMember == element["SysColumnName"] + "_Key") {
                            dgCol = new DgColumn();
                            dgCol = this.ScreenObject.ColumnSource[i];
                            //dgCol.ReadOnly = true;
                            if (!this.BidRankGrid.Columns.Contains(dgCol))
                                this.BidRankGrid.Columns.push(dgCol);
                        }
                        else if (Util.String(element["ColumnDataType"]) == "DATE" && this.ScreenObject.ColumnSource[i].ValueMember == element["SysColumnName"] + "_Key") {
                            dgCol = new DgColumn();
                            dgCol = this.ScreenObject.ColumnSource[i];
                            //dgCol.ReadOnly = true;
                            this.BidRankGrid.Columns.push(dgCol);
                        }
                        else if (this.ScreenObject.ColumnSource[i].DisplayMember == element["SysColumnName"]) {
                            dgCol = new DgColumn();
                            dgCol = this.ScreenObject.ColumnSource[i];
                            //dgCol.ReadOnly = true;
                            this.BidRankGrid.Columns.push(dgCol);
                        }

                    }
                }
            }


        }

        dgCol = new DgColumn();
        dgCol.Header = "Rank";
        dgCol.DisplayMember = this.BidRankSysColName;
        dgCol.ReadOnly = true;
        dgCol.Width = 100;
        dgCol.ID = this.BidRankSysColName;
        this.BidRankGrid.Columns.push(dgCol);


        this.BidRankGrid.ShowFooterTotals = 1;

        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {

            let dr: any;
            dr = this.BidRankGrid.NewRow();;
            for (let j = 0; j < this.ScreenObject.GridDataColumns.length; j++) {
                const oColumnName = this.ScreenObject.GridDataColumns[j];
                dr[oColumnName] = Util.String(this.ScreenObject.GridData[i][oColumnName]);
            }
            this.BidRankGrid.addRow(dr);
        }

    }

    async onRankExpand(sender) {
        if (sender == "Expand") {
            this.BidRankDisplayType = "details";
            this.InitBidRankGrid()
            this.OnRankRefresh();
            const { ReverseCounterBiddingRankComponent } = await import('../reverse-counter-bidding-rank/reverse-counter-bidding-rank.component')

            BaseService.page.ShowDialog(this, ReverseCounterBiddingRankComponent, { ShowCenter: true, HideHeader: true });
        }
        else if (sender == "Cancel") {
            BaseService.page.HideDialog(this.PopUpGUID);
        }
    }

    public async onBeginEditBid(objEditCell: any) {
        let args = objEditCell.args;
        let column = objEditCell.args.column
        args.Cancel = true;
        return;
    }

    public GetBidRankSysColName(dvRow: any[]) {
        for (let j = 0; j < dvRow.length; j++) {
            if (Util.String(dvRow[j]["LocalReference"]) == "79" && Util.String(dvRow[j]["LinkData"]) == "7807") {
                if (this.ScreenObject.GridDataColumns.Contains(dvRow[j]["SysColumnName"].toString())) {
                    var item = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == Util.String(dvRow[j]["SysColumnName"]));
                    if (item != null) {
                        this.BidRankSysColName = item.DisplayMember
                    }
                }
                else {
                    let item = this.ScreenObject._TextFields.find(a => a.DBColumnName == Util.String(dvRow[j]["SysColumnName"]));
                    if (item != undefined) {
                        this.BidRankSysColName = item.DBColumnName;
                    }
                }
            }
        }
    }

    // Name : onHistoryClick
    // Desc : on history button click from history popup, document can load based on maxid.
    // Category : COMMON
    onHistoryClick(sender: string) {
        let btnsave = this.GetButton("Save");
        if (this.SelectedHistoryRow != null && !Util.IsEmpty(this.SelectedHistoryRow["maxid"])) {
            let Ishist = false;
            let ds: any = null;
            if (this.SelectedHistoryRow["IsCurrent"].toString() == "YES") {
                ds = this.ScreenObject.GetEditDataByDOCID();
                Ishist = false;
            }
            else {
                ds = this.ScreenObject.GetEditDataByVersion(-1, this.SelectedHistoryRow["maxid"].toString());
                Ishist = true;
            }
            if (ds != null && this.ScreenObject.IsDocEdit && ds.Tables.length > 0 && ds.Tables[0].length > 0) {
                this.ScreenObject.LoadEditData(ds, false);
                this.RefreshGrid = true;
            }
            if (Ishist) {
                this.ButtonSave.Visible = false;
                this.ButtonSaveandPrint.Visible = false;
                if (btnsave != null)
                    btnsave.Visible = false;
                this.ButtonRevise.Visible = false;
                this.ButtonDelete.Visible = false;
                this.ButtonSuspendDoc.Visible = false;
            }
            else {
                if (BaseService.SessionManager.HideUnathorizedAccess)
                    this.ButtonSave.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit");
                else
                    this.ButtonSave.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit");

                if (BaseService.SessionManager.HideUnathorizedAccess)
                    this.ButtonSaveandPrint.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit");
                else
                    this.ButtonSaveandPrint.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit");

                if (this.ScreenObject.Preferences.ContainsKey("enebleSaveonhold") && this.ScreenObject.Preferences["enebleSaveonhold"] != "" && parseBoolean(this.ScreenObject.Preferences["enebleSaveonhold"])
                    && this.StatusID == 438 && btnsave != null) {
                    btnsave.Enable = this.ButtonSave.Enable;
                    btnsave.Visible = this.ButtonSave.Visible;
                }
                else if (btnsave != null)
                    btnsave.Visible = false;

                if (this.ScreenObject.Preferences.ContainsKey("EnableRevision") && this.ScreenObject.Preferences["EnableRevision"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableRevision"])) {
                    if (BaseService.SessionManager.HideUnathorizedAccess)
                        this.ButtonRevise.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Revise");
                    else {
                        this.ButtonRevise.Visible = true;
                        this.ButtonRevise.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Revise");
                    }
                }
                else
                    this.ButtonRevise.Visible = false;

                if (BaseService.SessionManager.HideUnathorizedAccess)
                    this.ButtonDelete.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");
                else
                    this.ButtonDelete.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");

                if (BaseService.SessionManager.HideUnathorizedAccess)
                    this.ButtonSuspendDoc.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");
                else
                    this.ButtonSuspendDoc.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");


            }
        }
    }
    // Name : onAttachLinkClick
    // Desc : on attachment link from grid, add attachment popup will appear (DocumentAttachmentsComponent) .
    // Category : COMMON
    onAttachLinkClick(args) {
        if (args.grid == undefined) {//For Mobile
            this.SelectedRow = args.selectedRow;
            if (this.SelectedRow != null)//&& SelectedRow instanceof DataRowView)
                this.RowAttachments(args.sender.DisplayMember, false, this.SelectedRow);
            else
                this.RowAttachments(args.sender.DisplayMember, false, null);
        } else {//For Web
            this.SelectedRow = args.grid.getDataItem(args.row);
            if (this.SelectedRow != null)//&& SelectedRow instanceof DataRowView)
                this.RowAttachments(args.sender.DisplayMember, false, this.SelectedRow);
            else
                this.RowAttachments(args.sender.DisplayMember, false, null);
        }
    }


    async CaptureImage() {
        try {
            const image = await Camera.getPhoto({
                quality: 100,
                width: 400,
                allowEditing: false, isMultiple: true,
                preview: this.IsNativeMobile ? null : document.body,
                parent: this.IsNativeMobile ? null : this,
                resultType: CameraResultType.DataUrl,
            });
        }
        catch (error) {
            console.log("CaptureImage Error: " + (JSON.stringify(error)));
        }
    }
    // Name : RowAttachments
    // Desc : its a sub method of onAttachLinkClick, it will attach file in row on click ().
    // Category : COMMON
    RowAttachments(sender, selectsingle, SRow, SRowIndex = 0, ColIndex = 0) {
        this.OnAddAttachment();
        this.SetVisibiltiFalse();
        this.AttachmentVisibility = true;
        this.SignVisibility = false; this.CaptureVisibility = false; this.AttachVisibility = true;
        this.IsDocAttachment = true;
        /***  BaseService.page.ShowDialog(this, DocumentAttachmentsComponent, { Title: "Attachment" }); ***/
        this.RightTabSelectedIndex = 5;
        let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == sender);
        let tempatt: AddAttachmentViewModel = null;
        Logger.InfoLog("attachclick", col.toString(), "col");
        if (this.ViewAttachments != null) {
            this.ViewAttachments.AttachmentsList.forEach(item => {
                if (item.RowID == SRow && item.ColID == sender) {
                    item.Height = 20;
                    if (col != null && !Util.IsEmpty(col.FilterCondition) && item.FileExtension.toLowerCase() == "jpg" || item.FileExtension.toLowerCase() == "jpeg" || item.FileExtension.toLowerCase() == "png")
                        tempatt = item;
                }
                else
                    item.Height = 0;
            });
        }
        this.Attachment.RowID = SRow;
        this.Attachment.ColID = sender;
        if (this.Attachment.SaveVisible) {
            this.Attachment.SaveVisible = false;
            this.Attachment.OkVisible = true;
        }
        if (col && col.Dependantinuse) {
            if (tempatt != null) {
                let fileName: string = "";
                if (!Util.IsEmpty(tempatt.FilePath))
                    fileName = tempatt.FilePath;
                else
                    fileName = PactFile.GetLogPath(tempatt.guid + "." + tempatt.FileExtension);

                tempatt.DialoguePreviewImage = fileName;
                this.SignVisibility = false; this.CaptureVisibility = true; this.AttachVisibility = false;
                this.Attachment.DialoguePreviewImage = this.Attachment.FilePath = fileName;
                this.Attachment.rdoCamera
                this.Attachment.rdoImage
                if (fileName != '') {
                    this.Attachment.rdoCamera = false;
                    this.Attachment.rdoImage = true;
                }
                else {
                    this.Attachment.rdoCamera = true;
                    this.Attachment.rdoImage = false;
                }

                BaseService.page.ShowDialog(this, DocumentAttachmentsComponent, { ShowCenter: true, Title: 'Images' })
                /***BaseService.page.ShowDialog(tempatt, ImageCaptureComponent, { ShowCenter: true ,Title:'Images'})***/

                // BaseService.page.ShowDialog({ guid: tempatt.guid, FileExtension: tempatt.FileExtension } , PactImageComponent, { ShowCenter: true && !BaseService.IsMobile, Title: "Preview Image" })

                //  ImageCaptureDialog dlg = new ImageCaptureDialog(tempatt, fileName);
                //  dlg.Owner = Application.Current.MainWindow;
                //  dlg.ShowDialog();
            }
            else {
                this.SignVisibility = false; this.CaptureVisibility = true; this.AttachVisibility = false;
                this.Attachment.DialoguePreviewImage = this.Attachment.FilePath;
                BaseService.page.ShowDialog(this, DocumentAttachmentsComponent, { ShowCenter: true, Title: 'Images' })
                //this.CaptureImage();
                /**ImageCaptureDialog dlg = new ImageCaptureDialog(Attachment, Attachment.FilePath);
                dlg.Owner = Application.Current.MainWindow;
                dlg.ShowDialog();**/
            }
            // return;
        }
        else if (col && !Util.IsEmpty(col.FilterCondition) && SRow != null) {
            let StrDocs: string[] = col.FilterCondition.split(',');
            let where: string = "";
            for (let i = 0; i < StrDocs.length; i++) {
                col = this.ScreenObject.ColumnSource.find(a => a.CostCenterID.toString() == StrDocs[i]);
                if (col && !Util.IsEmpty(SRow[col.ValueMember])) {
                    if (where != "")
                        where += " OR ";
                    where += "(FeatureID=" + col.CostCenterID.toString() + " and FeaturePK=" + SRow[col.ValueMember].toString() + ")";
                }
            }
            if (!Util.IsEmpty(where)) {
                let ds: any = this.ScreenObject.GetFiles(0, 0, where)
                {
                    if (ds != null && ds.Columns[0].Contains("GUID")) {
                        let filepaths: string = "";
                        if (ds != null && ds.Tables.length > 0) {
                            for (let i = 0; i < ds.Tables[0].length; i++) {
                                filepaths += PactFile.GetLogPath(ds.Tables[0][i]["GUID"].toString() + "." + ds.Tables[0][i]["FileExtension"].toString()) + ";";
                            }
                        }
                        let ImgPath: string = "";
                        if (tempatt != null)
                            ImgPath = PactFile.GetLogPath(tempatt.guid + "." + tempatt.FileExtension);

                        if (selectsingle) {
                            if (ds.Tables[0].length == 1) {
                                if (tempatt != null) {
                                    tempatt.FileExtension = ds.Tables[0][0]["FileExtension"].toString();
                                    tempatt.Guid = ds.Tables[0][0]["GUID"].toString();
                                    tempatt.AllowInPrintVisible = true;
                                    tempatt.isfrmProduct = true;
                                }
                                else {
                                    tempatt = new AddAttachmentViewModel();
                                    //tempatt.AddAttachmentViewModel_2()
                                    tempatt.FileExtension = ds.Tables[0][0]["FileExtension"].toString();
                                    tempatt.Guid = ds.Tables[0][0]["GUID"].toString();
                                    tempatt.AllowInPrintVisible = true;
                                    tempatt.isfrmProduct = true;
                                    tempatt.RowID = SRow;
                                    tempatt.ColID = sender;
                                    this.ViewAttachments.AttachmentsListObj.addRow(tempatt);
                                }
                            }
                            return;
                        }

                        /***let img:PopupImageViewModel = new PopupImageViewModel("Popup Image", "OK", true, ImgPath, filepaths);
                        {
                            this.DialogResult = false;
                           img.OkVisibility = true;
                           img.prnt = this;
                           BaseService.page.openDialog(img,pop)
                           ShellWindowViewModel.Instance().PopViewModel = img;
                           if (DialogResult)
                           {
                               for(let i = 0; i < ds.Tables[0].length; i++)
                               {
                                   if (img.AccountPhoto.Contains(ds.Tables[0][i]["GUID"].toString()))
                                   {
                                       if (tempatt != null)
                                       {
                                           tempatt.FileExtension = ds.Tables[0][i]["FileExtension"].toString();
                                           tempatt.guid = ds.Tables[0][i]["GUID"].toString();
                                           tempatt.AllowInPrintVisible = true;
                                           tempatt.isfrmProduct = true;
                                       }
                                       else
                                       {
                                           tempatt = new AddAttachmentViewModel();
                                           tempatt.FileExtension = ds.Tables[0][i]["FileExtension"].toString();
                                           tempatt.guid = ds.Tables[0][i]["GUID"].toString();
                                           tempatt.AllowInPrintVisible = true;
                                           tempatt.isfrmProduct = true;
                                           tempatt.RowID = SRow;
                                           tempatt.ColID = sender;
                                           ViewAttachments.AttachmentsListObj.addRow(tempatt);
                                       }
                                       break;
                                   }
                               }
                           }
                       }***/
                    }
                }
            }
        }


        if (!(col != undefined && col.Dependantinuse)) {
            BaseService.page.ShowDialog(this, DocumentAttachmentsComponent, { Title: "Attachment" });
        }

        /*** 
         **  below code commented by khasim preview showing in image capture No need to show it on separate
        if (col && col.Dependantinuse) {
            if (tempatt != null) {
                let fileName: string = "";
                if (!Util.IsEmpty(tempatt.FilePath))
                    fileName = tempatt.FilePath;
                else
                    fileName = PactFile.GetLogPath(tempatt.guid + "." + tempatt.FileExtension);
                BaseService.page.ShowDialog({ guid: tempatt.guid, FileExtension: tempatt.FileExtension }, PactImageComponent, { ShowCenter: true && !BaseService.IsMobile, Title: "Preview Image" })

                //  ImageCaptureDialog dlg = new ImageCaptureDialog(tempatt, fileName);
                //  dlg.Owner = Application.Current.MainWindow;
                //  dlg.ShowDialog();
            }
            else {
                /**ImageCaptureDialog dlg = new ImageCaptureDialog(Attachment, Attachment.FilePath);
                dlg.Owner = Application.Current.MainWindow;
                dlg.ShowDialog();**
            }
        }
        ***/
        //ViewAttachments.RowID = Attachment.RowID;
        //ViewAttachments.ColID = Attachment.ColID;
        //ViewAttachments.Refresh = true;
    }

    // Name : onLinkRefClick
    // Desc : its a sub method of onAttachLinkClick, it will attach file in row on click ().
    // Category : COMMON
    onLinkRefClick(sender: any) {
        if (this.IsInventoryVoucher) {
            if (this.SelectedRow != null && this.ScreenObject.GridDataColumns.Contains("LinkedInvDocDetailsID") && Util.String(this.SelectedRow["LinkedInvDocDetailsID"]) != "") {
                let linkDetails: any = [];
                if (this.ScreenObject.GridDataColumns.Contains("RefNO") && Util.String(this.SelectedRow["RefNO"]) != "" && Util.String(this.SelectedRow["LinkedInvDocDetailsID"]) == "0" && this.ScreenObject.RefNodeID > 0)
                    linkDetails = this.ScreenObject.GetDocDetailsByInvID(this.ScreenObject.RefNodeID);
                else
                    linkDetails = this.ScreenObject.GetDocDetailsByInvID(parseInt(this.SelectedRow["LinkedInvDocDetailsID"]));
                if (linkDetails != null && linkDetails.Tables.length > 0 && linkDetails.Tables[0].length > 0 && !linkDetails.Columns[0].Contains("ErrorMessage")) {
                    let sname = "";
                    if (linkDetails.Columns[0].Contains("DisplayName") && !Util.IsEmpty(linkDetails.Tables[0][0]["DisplayName"]))
                        sname = linkDetails.Tables[0][0]["DisplayName"].toString();
                    else
                        sname = linkDetails.Tables[0][0]["ResourceData"].toString();
                    let oDocument = new AddEditDocumentViewModel(parseInt(linkDetails.Tables[0][0]["CCID"]), sname, true);
                    oDocument.ScreenObject.DocPrefix.ComboBox.SelectedValue = linkDetails.Tables[0][0]["Prefix"].toString();
                    oDocument.ScreenObject.DocPrefix.TextBox.Text = linkDetails.Tables[0][0]["DocNumber"].toString();
                    oDocument.OnDocPrefixChanged("lostFocus");

                    if (!oDocument.RefreshGridFooter)
                        oDocument.RefreshGridFooter = true;
                    oDocument.ScreenObject.FillDocumentPrefix(true);
                    if (oDocument.ScreenObject.DocPrefix.ComboBox.SelectedValue == null)
                        oDocument.ScreenObject.DocPrefix.ComboBox.SelectedValue = linkDetails.Tables[0][0]["Prefix"].toString();
                    let retObj: IPage = { component: AddEditDocumentComponent, params: { obj: oDocument } }
                    BaseService.page.addNewTab(retObj);
                }
            }
        }
        else if (this.SelectedRow != null) {
            BaseService.page.ShowDialog(new AddDenominationViewModel(this, Util.String(this.SelectedRow["DenominationsXML"])), AddDenominationComponent);
        }
    }

    Setselectedrow(index: number) {
        this.SelectedRow = this.ScreenObject.GridData[index];
    }

    onVerionChanged(VersionNo: string) {
        let ver;
        if (!Util.IsEmpty(VersionNo) && Util.IsNum(VersionNo)) {
            ver = 0;
            for (let i = 0; i < this.ScreenObject.DocPrefix.RevisionCombo.Items.length; i++) {
                if (parseInt(this.ScreenObject.DocPrefix.RevisionCombo.Items[i].Value) > ver)
                    ver = parseInt(this.ScreenObject.DocPrefix.RevisionCombo.Items[i].Value);
            }
            let ds = null;
            if (parseInt(VersionNo) < ver) {
                ds = this.ScreenObject.GetEditDataByVersion(parseInt(VersionNo), "0");
            }
            else if (this.ScreenObject.IsDocEdit) {
                ds = this.ScreenObject.GetEditDataByDOCID();
                if (BaseService.SessionManager.HideUnathorizedAccess)
                    this.ButtonDelete.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");
                else
                    this.ButtonDelete.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");

                if (BaseService.SessionManager.HideUnathorizedAccess)
                    this.ButtonSuspendDoc.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");
                else
                    this.ButtonSuspendDoc.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");

                if (BaseService.SessionManager.HideUnathorizedAccess)
                    this.ButtonSave.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit");
                else
                    this.ButtonSave.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit");

                if (BaseService.SessionManager.HideUnathorizedAccess)
                    this.ButtonSaveandPrint.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");
                else
                    this.ButtonSaveandPrint.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");

                this.HideButtons("Save&Barcode");
                this.HideButtons("BarcodePrint");

                if (this.ScreenObject.Preferences.ContainsKey("EnableRevision") && this.ScreenObject.Preferences["EnableRevision"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableRevision"])) {
                    if (BaseService.SessionManager.HideUnathorizedAccess)
                        this.ButtonRevise.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Revise");
                    else {
                        this.ButtonRevise.Visible = true;
                        this.ButtonRevise.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Revise");
                    }
                }
                else
                    this.ButtonRevise.Visible = false;

            }
            if (ds != null && this.ScreenObject.IsDocEdit && ds.Tables.length > 0 && ds.Tables[0].length > 0) {
                this.ScreenObject.LoadEditData(ds, false);
                this.RefreshGrid = true;
                this.CalculateTotals(null, false);
            }
            if (parseInt(VersionNo) < ver) {
                this.ButtonSave.Visible = false;
                this.ButtonSaveandPrint.Visible = false;
                this.ButtonRevise.Visible = false;
                this.ButtonDelete.Visible = false;
                this.ButtonSuspendDoc.Visible = false;
                if (this.ScreenObject.Preferences.ContainsKey("EnableRevision") && this.ScreenObject.Preferences["EnableRevision"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableRevision"])) {
                    this.ButtonRevise.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "EnableReviseButton");
                    this.ButtonRevise.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "EnableReviseButton");
                }
            }
        }
    }
    onComboBoxSelectionChanged(sender: any) {
        if (this.ScreenObject == null)
            return;

        if (this.ScreenObject.DocumentType == 72) {
            if (sender != null && !Util.IsEmpty(sender)) {
                //EncashRemainingDays
                if (sender instanceof PactComboBoxData && sender.DBColumnName.toLowerCase() == "dcalpha13")
                    this.ApplyVacationIsEncash(null);

                //if (sender.toLowerCase() == "dcalpha14")
                //    ApplyVacationIsTextEncash(null);

                //PAY EXCESS DAYS
                if (sender instanceof PactComboBoxData && sender.DBColumnName.toLowerCase() == "dcalpha15")
                    this.ApplyVacationExcessdays("");

                if (sender instanceof PactComboBoxData && sender.DBColumnName.toLowerCase() == "dcalpha16")
                    this.ApplyVacationIsEncash(null);
            }

        }
        else if (this.DocumentType == 92) //Shift Assign
        {
            let sAssgnType = "DayWise";
            let vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
            if (vFld instanceof PactComboBoxData)
                sAssgnType = vFld.SelectedValue;

            if (sAssgnType == "DayWise") {
                this.ScreenObject._TextFields.forEach(item => {
                    if (item instanceof PactExtraFieldDateData && (item.DBColumnName.toLowerCase() == "dcalpha1" || item.DBColumnName.toLowerCase() == "dcalpha2"))
                        item.IsReadOnly = false;
                });
                this.SetButtonVisibility("FillDates", true);
            }
            else {
                this.ScreenObject._TextFields.forEach(item => {
                    if (item instanceof PactExtraFieldDateData && (item.DBColumnName.toLowerCase() == "dcalpha1" || item.DBColumnName.toLowerCase() == "dcalpha2"))
                        item.IsReadOnly = true;
                });
                this.SetButtonVisibility("FillDates", false);
            }

            for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
                if (this.ScreenObject.ColumnSource[i].DisplayMember.toUpperCase() == "DCALPHA5" || this.ScreenObject.ColumnSource[i].DisplayMember.toUpperCase() == "DCALPHA6" || this.ScreenObject.ColumnSource[i].DisplayMember.toUpperCase() == "DCCCNID73") {
                    if (sAssgnType == "DayWise")
                        this.ScreenObject.ColumnSource[i].Mandatory = false;
                    else
                        this.ScreenObject.ColumnSource[i].Mandatory = true;
                }
            }
        }
        else if (this.ScreenObject.DocumentType == 89 || this.ScreenObject.DocumentType == 90) //Attendance & Time Sheet
        {
            let vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha32");
            if (vFld instanceof PactComboBoxData) {
                if (vFld.SelectedValue != null && vFld.SelectedValue == "Manual") {
                    this.ScreenObject._TextFields.forEach(item => {
                        if (item.DBColumnName.toLowerCase() == "dcalpha26")
                            item.IsReadOnly = true;
                        else if (item.DBColumnName.toLowerCase() == "dcalpha27")
                            item.Enable = false;
                    });
                    this.SetButtonVisibility("Save", true);
                    this.SetButtonVisibility("SaveAndPrint", true);
                    this.SetButtonVisibility("Check-in", false);
                    this.SetButtonVisibility("Check-out", false);
                }
                else {
                    this.ScreenObject._TextFields.forEach(item => {
                        if (item.DBColumnName.toLowerCase() == "dcalpha26")
                            item.IsReadOnly = false;
                        else if (item.DBColumnName.toLowerCase() == "dcalpha27")
                            item.Enable = true;
                    });
                    this.SetButtonVisibility("Save", false);
                    this.SetButtonVisibility("SaveAndPrint", false);
                    this.SetButtonVisibility("Check-in", true);
                    this.SetButtonVisibility("Check-out", true);
                }

            }
        }
    }

    onPactCodeNameListBoxFocus(sender: any) {
        if (!Util.IsEmpty(sender) && sender instanceof PactListBoxData && !Util.IsEmpty(sender.CCID) && sender.CCID == 2) {
            let id = 0;
            id = sender.SelectedValue;

            if (!(this.ccid == 2 && this.PrAccID == id)) {
                this.t.Enabled = false;
                this.ccid = 2; this.PrAccID = id;
                this.t.Enabled = true;
            }
        }
    }

    onTextBoxLostFocus(sender: any) {
        if (this.ScreenObject == null)
            return;
        this.ScreenObject._TextFields.forEach(item => {
            if (this.fldDict.ContainsKey(item.Lbl)) {
                if (item instanceof PactTextBoxData) {
                    if (item.DataType == "FLOAT") {
                        if (item.Text != null && item.Text != "" && item.ValidateData() == "")
                            this.fldDict[item.Lbl].setFieldValue(item.Text);
                        else
                            this.fldDict[item.Lbl].setFieldValue(0);
                    }
                    else
                        this.fldDict[item.Lbl].setFieldValue(item.Text);
                }
                else if (item instanceof PactComboBoxData)
                    this.fldDict[item.Lbl].setFieldValue(item.SelectedValue);
                else if (item instanceof PactSelectionBoxData)
                    this.fldDict[item.Lbl].setFieldValue(item.Text);
                else if (item instanceof PactListBoxData) {
                    if (item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                        this.fldDict[item.Lbl].setFieldValue(item.Text);
                    else
                        this.fldDict[item.Lbl].setFieldValue("");
                }
            }
        });

        if (this.ScreenObject.DocumentType == 30 && this.ScreenObject.GridDataColumns.Contains("IsKit") && this.ScreenObject.Preferences.ContainsKey("AssembleQty") && !Util.IsEmpty(this.ScreenObject.Preferences["AssembleQty"])) {
            let Qty: number;
            let typefld = this.ScreenObject._TextFields.find(a => a.DBColumnID.toString() == this.ScreenObject.Preferences["AssembleQty"]);
            if (typefld && typefld instanceof PactTextBoxData && !Util.IsEmpty(typefld.Text)
                && Util.IsNum(typefld.Text) && typefld == sender) {
                Qty = parseFloat(typefld.Text);

                let drkit = this.ScreenObject.GridData.filter(x => x.IsKit == 1);
                if (drkit.length > 0 && !(!Util.IsEmpty(drkit[0]["Quantity"]) && parseFloat(drkit[0]["Quantity"]) == Qty)) {
                    drkit[0]["Quantity"] = Qty;
                    this.CalculateTotals(drkit[0], false, "Quantity");

                    drkit = this.ScreenObject.GridData.find(x => x.IsKit == 2);
                    drkit.forEach(dr => {
                        if (!Util.IsEmpty(dr["DefaultQuantity"]))
                            dr["Quantity"] = Qty * parseFloat(dr["DefaultQuantity"]);
                        else
                            dr["Quantity"] = Qty;
                        this.CalculateTotals(dr, false, "Quantity");
                    });
                }
            }
        }

        if (sender instanceof PactTextBoxData || sender instanceof PactComboBoxData || sender instanceof PactSelectionBoxData) {
            this.ValidateData(sender as PactControlData);
        }

        if (this.ScreenObject.DocumentType == 72) {
            if (sender instanceof PactTextBoxData && sender.DBColumnName.toLowerCase() == "dcalpha14")
                this.ApplyVacationIsTextEncash(null);
        }

        if (sender instanceof PactControlData && !Util.IsEmpty(sender.KeyTip) && sender.KeyTip.toLowerCase() == "lostfocus" && this.ValidateData(sender as PactControlData, true))
            this.ScreenObject.GetExternalFuncData(sender.Mode, sender.ToolTipFooterTitle, sender.ToolTipFooterDescription, sender.ToolTipDescription, null);

        this.CalcTextFields();

        if (sender instanceof PactTextBoxData && sender.Calculate) {
            let cnt = 0;
            this.ScreenObject.GridData.forEach(dr => {
                if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(dr["ProductID_Key"])) {
                    this.CalculateTotals(dr, false);
                    cnt++;
                }
            });
            if (cnt == 0)
                this.CalculateTotals(null, false);
        }
    }
    onGPSchange(sender: any) {
        if (this.ScreenObject == null) {
            return;
        }
        for (let i = 0; i < this.ScreenObject._TextFields.length; i++) {
            const item = this.ScreenObject._TextFields[i];
            if (item instanceof PactGPSData) {
                if (!Util.IsEmpty(item.Text)) {
                    if (!item.Text.Contains(',')) {
                        this.DisplayMessage = "GPS should have latitude and longitude";
                        this.MessageVisibility = true;
                        return;
                    }
                }
            }
        }
    }
    CalcQOH(DueDate: Date) {
        let prdids = "";
        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                if (prdids.length > 0)
                    prdids += ",";
                prdids += this.ScreenObject.GridData[i]["ProductID_Key"].toString();
            }
        }

        if (prdids.length > 0 && this.ScreenObject.GridDataColumns.Contains("QOH")) {
            let QOHField = "";
            if (this.ScreenObject.Preferences.ContainsKey("QOHField")) {
                let fld = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["QOHField"]);
                if (fld && (this.DocumentType == 31 || this.DocumentType == 32))
                    QOHField = fld.DisplayMember;
            }
            let dsQOH = this.ScreenObject.GetProductQtyOnHand(prdids, DueDate);
            if (dsQOH != null && dsQOH.Tables.length > 0 && dsQOH.Columns[0].Contains("ProductID")) {
                for (let k = 0; k < dsQOH.Tables[0].length; k++) {
                    let drrows = this.ScreenObject.GridData.filter(x => x.ProductID_Key == dsQOH.Tables[0][k]["ProductID"]);
                    if (drrows.length > 0)
                        drrows[0]["QOH"] = dsQOH.Tables[0][k]["QOH"].toString();
                    else
                        drrows[0]["QOH"] = 0;

                    if (QOHField != "")
                        drrows[0][QOHField] = drrows[0]["QOH"].toString();
                }
            }
        }
    }

    onDateChanged(sender: any) {
        if (sender instanceof PactExtraFieldDateData) {
            if ((this.DocumentType == 31 || this.DocumentType == 32) && sender.DBColumnName.toLowerCase() == "duedate") {
                if (sender.Date)
                    this.CalcQOH(sender.Date);
                else
                    this.CalcQOH(this.DocumentDate);
            }

            if (this.ScreenObject.Preferences.ContainsKey("DueDateonBillDate") && this.ScreenObject.Preferences["DueDateonBillDate"] != "") {
                let datefield = this.ScreenObject.Preferences["DueDateonBillDate"];
                if (sender.DBColumnName.toLowerCase() == datefield.toLowerCase() && sender.Date) {
                    if (this.ScreenObject.IsPurchase && this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0)
                        this.ScreenObject.GetDueDate(this.ScreenObject.CreditAccount.SelectedValue, sender.Date, this.ScreenObject.IsPurchase);
                    else if (!this.ScreenObject.IsPurchase && this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0)
                        this.ScreenObject.GetDueDate(this.ScreenObject.DebitAccount.SelectedValue, sender.Date, this.ScreenObject.IsPurchase);
                }
            }
            if (this.ScreenObject.DocumentType == 35) {
                if (sender.DBColumnName.toLowerCase() == "dcalpha3" && sender.Date) {
                    let endd = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                    if (endd && endd instanceof PactExtraFieldDateData && endd.Date) {
                        let per = this.ScreenObject._numericFields.find(a => a.DBColumnName.toLowerCase() == "dcnum30");
                        if (per != null && per instanceof PactTextBoxData)
                            per.Text = Util.Round(endd.Date.Subtract(sender.Date).Days / 30, 0).toString();
                    }
                }
                if (sender.DBColumnName.toLowerCase() == "dcalpha4" && sender.Date) {
                    let endd = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                    if (endd && endd instanceof PactExtraFieldDateData && endd.Date) {
                        let per = this.ScreenObject._numericFields.find(a => a.DBColumnName.toLowerCase() == "dcnum30");
                        if (per != null && per instanceof PactTextBoxData)
                            per.Text = Util.Round(sender.Date.Subtract(endd.Date).Days / 30, 0).toString();
                    }
                }
            }

            if (this.ScreenObject.DocumentType == 92) //Payroll - Shift Assign
            {
                if (this.iDtColFrom > 0 && this.iDtColUpto > 0) {
                    if (sender.DBColumnName.toLowerCase() == "dcalpha1" && sender.Date) //FromDate
                    {
                        this.DisplayMessage = "Changing of Date will be effected on Line wise, Click on Fill Dates..";
                    }
                    else if (sender.DBColumnName.toLowerCase() == "dcalpha2" && sender.Date) //FromDate
                    {
                        this.DisplayMessage = "Changing of Date will be effected on Line wise, Click on Fill Dates..";
                    }
                }
            }
            else if (this.DocumentType == 72) {
                if (sender.DBColumnName.toLowerCase() == "dcalpha2" && sender.Date)
                    this.ApplyVacationFrom(sender);
                else if (sender.DBColumnName.toLowerCase() == "dcalpha3" && sender.Date)
                    this.ApplyVacation(sender);
            }
            else if (this.DocumentType == 97) //Lates Processing
            {
                if (sender.DBColumnName.toLowerCase() == "dcalpha16" && sender.Date) {
                    sender.Date = new Date(sender.Date.getFullYear(), sender.Date.getMonth(), 1);
                    if (this.ScreenObject.GridData.length > 0 && this.dtPayMon.getFullYear() != 1 && this.dtPayMon != sender.Date) {
                        this.DisplayMessage = "Changing of Payroll Month will be effected on Line wise, Click on Filter to Process Lates..";
                    }
                }
                if (sender.DBColumnName.toLowerCase() == "dcalpha33" && sender.Date) {
                    sender.Date = new Date(sender.Date.getFullYear(), sender.Date.iMonth(), 1);
                }
            }

            if (sender instanceof PactExtraFieldDateData && sender.Calculate) {
                this.FillHeaderDictionary();
                this.CalcTextFields();
            }
            if (this.ScreenObject.DocID == 0 && sender instanceof PactExtraFieldDateData && this.ScreenObject.Preferences.ContainsKey("ShowLinkedDocsBasedon") && this.ScreenObject.Preferences["ShowLinkedDocsBasedon"].toString() != ""
                && sender.DBColumnID == parseInt(this.ScreenObject.Preferences["ShowLinkedDocsBasedon"])) {
                this.OLinkSelectionChanged("");
            }
        }
        else if (sender instanceof PactDateTimeData) {
            let drr = this.ScreenObject.Data.Tables[0].filter(x => x.CostCenterColID == sender.DBColumnID && x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 53580);
            if (drr.length > 0) {
                let ds = BaseService.common.GetDataSet("DOC001", "")
                {
                    if (ds != null && ds.Tables.length > 0 && !ds.Columns[0].Contains("ErrorMessage") && ds.Tables[0].length > 0 && !Util.IsEmpty(ds.Tables[0][0][ds.Columns[0][0]])
                        && this.fldDict != null) {
                        let c0 = ds.Columns[0][0]
                        sender.Date = Util.ParseDate(ds.Tables[0][0][c0]);
                        if (this.fldDict != null) {
                            if (BaseService.SessionManager.IsWebApplication) {
                                let ServerDate = Util.ParseDate(ds.Tables[0][0][c0]);
                                this.fldDict["ServerDate"].setFieldValue(ServerDate.ToString("MMM/dd/yyyy"));
                                this.FooterDics["ServerDate"].setFieldValue(ServerDate.ToString("MMM/dd/yyyy"));
                            }
                            else {
                                this.fldDict["ServerDate"].setFieldValue(ds.Tables[0][0][c0]);
                                this.FooterDics["ServerDate"].setFieldValue(ds.Tables[0][0][c0]);
                            }

                        }
                    }
                }
            }

            //#region Time off Request

            if (this.ScreenObject.DocumentType == 86) {
                let dtReq: Date = null, dtComingIn: Date = null, dtGoingOut: Date = null;

                let dtr = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                if (dtr && dtr instanceof PactExtraFieldDateData)
                    dtReq = dtr.Date;

                if (sender.DBColumnName.toLowerCase() == "dcalpha2" || sender.DBColumnName.toLowerCase() == "dcalpha3") {
                    let per = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                    if (per && per instanceof PactDateTimeData && per.Date)
                        dtGoingOut = per.Date;

                    per = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                    if (per && per instanceof PactDateTimeData && per.Date)
                        dtComingIn = per.Date;
                }

                if (dtComingIn != null && dtGoingOut != null) {
                    let per = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                    if (per && per instanceof PactTextBoxData)
                        per.Text = this.CalculateTotalTimeAvailed(dtReq, dtComingIn, dtGoingOut);
                }
            }
            //#endregion

            if (sender instanceof PactDateTimeData && sender.Calculate) {
                this.FillHeaderDictionary();
                this.CalcTextFields();
            }
        }
        if (sender instanceof PactControlData && !Util.IsEmpty(sender.KeyTip) && sender.KeyTip.toLowerCase() == "lostfocus" && this.ValidateData(sender as PactControlData, true))
            this.ScreenObject.GetExternalFuncData(sender.Mode, sender.ToolTipFooterTitle, sender.ToolTipFooterDescription, sender.ToolTipDescription, null);


    }

    LoadButtons() {
        let Defaultlft = "", DefaultRight = "";

        let buttonwidth = 40, buttonheight = 40;
        if (this.IsPOs) {
            Defaultlft += "Pay,Print,Hold,Release,Exit,Options,Return Line,Delete Line,Sales Return,Docs,LineDisc,Disc,";

            DefaultRight += "SearchPrice,";

            if (this.ScreenObject.Data.Columns[1].Contains("ActionHeight")) {
                if (!Util.IsEmpty(this.ScreenObject.Data.Tables[1][0]["ActionHeight"]))
                    buttonheight = parseInt(this.ScreenObject.Data.Tables[1][0]["ActionHeight"]);
                else
                    buttonheight = 60;
                if (!Util.IsEmpty(this.ScreenObject.Data.Tables[1][0]["ActionWidth"]))
                    buttonwidth = parseInt(this.ScreenObject.Data.Tables[1][0]["ActionWidth"]);
                else
                    buttonwidth = 62;
            }
            else {
                buttonwidth = 62;
                buttonheight = 60;
            }
        }

        Defaultlft += "LinkStatus,Lock,Generate,Adjust Down Payments,Close,Enquiries,Advance,Redeposit,Pack,Approve,Submit,Stock Posting,New,Save,Revise,Post,Delete,SaveAndPrint";
        if (this.DocumentType > 50)
            Defaultlft += ",Copy Leaves,Set Columns,Employee Filter,Get Previous Day,All Employees,Guarantees,Distribute,Fill Dates,Fill General Timings";

        DefaultRight += "Print,PrintPreview,Suspend,ContinuousPrint,SaveAndBarcode,BarcodePrint,Export,Email,SMS,Draft,Copy,Clone,Import,Sort,Recur,Show JV,Generate Cheques,Pre Payments,Location,Notes,Attachments,Contacts,ReEvaluate,ReEvaluatePriceChart,ReEvaluateTaxChart,Activities,Customize,Search,Report,Documents,History,Bounce,Load Drafts,Hold,Release,CashDrawer,Payment Terms,Terms Conditions,Convert,DocumentHistory,Revise History,PriceChart,Map,Post Billwise,Help,LinkInfo,TabsPopUp,AssignVPT,Assign,UBLNEW";

        if (this.ScreenObject.Preferences.ContainsKey("RightButtons") && !Util.IsEmpty(this.ScreenObject.Preferences["RightButtons"]))
            DefaultRight = this.ScreenObject.Preferences["RightButtons"].toString();

        if (this.ScreenObject.Preferences.ContainsKey("LeftButtons") && !Util.IsEmpty(this.ScreenObject.Preferences["LeftButtons"]))
            Defaultlft = this.ScreenObject.Preferences["LeftButtons"].toString();

        if (this.DocumentType <= 50 && this.ScreenObject.Preferences.ContainsKey("Distributebasedon") && !Util.IsEmpty(this.ScreenObject.Preferences["Distributebasedon"]))
            Defaultlft += ",Distribute";

        if (this.ScreenObject.Preferences.ContainsKey("ReleaseJob") && parseBoolean(this.ScreenObject.Preferences["ReleaseJob"]))
            Defaultlft += ",ReleaseJob";

        if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Innoviti"))
            Defaultlft = "Innoviti," + Defaultlft;

        if (this.DocumentType == 89 || this.DocumentType == 90) {
            Defaultlft += ",Check-in,Check-out";
            buttonwidth = 45;
        }

        if (this.ScreenObject.DocumentType == 85) {
            if (BaseService.SessionManager.Preferences.ContainsKey("ConsiderGradeWiseSalarySlabs") && BaseService.SessionManager.Preferences["ConsiderGradeWiseSalarySlabs"] == "True") {
                Defaultlft += ",Pick Min.,Pick Max.";
                buttonwidth = 45;
            }
        }

        if (this.DocumentType == 61) {
            Defaultlft += ",Define Days";
            buttonwidth = 45;
        }

        if (this.DocumentType == 103) {
            Defaultlft += ",GenerateOnDuty";
            buttonwidth = 45;
        }

        if (this.DocumentType == 67) {
            Defaultlft += ",Validate";
            buttonwidth = 45;
        }
        if (this.DocumentType == 92) {
            Defaultlft += ",Rotation";
            buttonwidth = 45;
        }
        if (this.DocumentType == 99) //Regularization of Attendance
        {
            Defaultlft += ",Load";
            buttonwidth = 45;
        }
        if (this.DocumentType == 104) //Renew Button AMC 
        {
            Defaultlft += ",Renew";
            buttonwidth = 45;
        }
        if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "GST"))
            Defaultlft = "GST," + Defaultlft;
        if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "API"))
            Defaultlft = "API," + Defaultlft;
        if (!DefaultRight.Contains(",EInv"))
            DefaultRight = DefaultRight + ",EInv";
        if (BaseService.IsMobile && this.ScreenObject.Link?.Visible)
            Defaultlft = Defaultlft + ",DocLink";
        if (BaseService.IsMobile && this.AssignAddress)
            Defaultlft = Defaultlft + ",Addresses";
        if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "UBL"))
            Defaultlft = "UBLNEW," + Defaultlft;

        Defaultlft = "ExternalFun," + Defaultlft;

        Defaultlft = "BidRevise," + Defaultlft;
        Defaultlft = "BidReviseDistribute," + Defaultlft;

        if (this.DocumentType == 17 || this.DocumentType == 28 || this.DocumentType == 29) {
            if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReverseJV"))
                Defaultlft = DefaultRight + ",ReverseJV";
        }  

        this.ButtonsLeft.Clear();
        this.ButtonsPopup.Clear();

        if (Defaultlft[Defaultlft.length - 1] == ',') {
            Defaultlft = Defaultlft.Remove(Defaultlft.length - 2, 2);
        }

        let removeButtons = BaseService.IsMobile ? ["Customize", "Documents"] : ["Customize", "Report", "Documents"];
        let flds = Defaultlft.split(',');
        for (let i = 0; i < flds.length; i++) {
            if (removeButtons.Contains(flds[i]))
                continue;

            if (this.ButtonsLeft.filter(x => x.Visible).length >= 7 && BaseService.IsMobile) {
                if (this.ClassName == "POSDocumentViewModel" && flds[i] == "Pay")
                    this.AddButton(flds[i], this.ButtonsPopup, (buttonwidth * 3) + 8, buttonheight);
                else
                    this.AddButton(flds[i], this.ButtonsPopup, buttonwidth, buttonheight);
            } else {
                if (this.ClassName == "POSDocumentViewModel" && flds[i] == "Pay")
                    this.AddButton(flds[i], this.ButtonsLeft, (buttonwidth * 3) + 8, buttonheight);
                else
                    this.AddButton(flds[i], this.ButtonsLeft, buttonwidth, buttonheight);
            }

        }
        if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "UBL"))
            DefaultRight = DefaultRight + "," + "UBL";

        flds = DefaultRight.split(',');

        if (this.IsMobile) {
            var allowBluetoothPrint = false
            var docAbbr = this.ScreenObject.Data.Tables[3][0]["DocumentAbbr"]
            if (this.IsNativeMobile) {
                if (docAbbr.toLowerCase().Contains("vsi"))
                    allowBluetoothPrint = true
                if (docAbbr.toLowerCase().Contains("rct"))
                    allowBluetoothPrint = true
                else if (docAbbr.toLowerCase().Contains("sic"))
                    allowBluetoothPrint = true
                else if (docAbbr.toLowerCase().Contains("brd"))
                    allowBluetoothPrint = true
                else if (docAbbr.toLowerCase().Contains("srt"))
                    allowBluetoothPrint = true
                else if (docAbbr.toLowerCase().Contains("vti"))//Siwar
                    allowBluetoothPrint = true
                else if (docAbbr.toLowerCase().Contains("sct"))//Siwar
                    allowBluetoothPrint = true
                else if (docAbbr.toLowerCase().Contains("cn"))
                    allowBluetoothPrint = true
                else if (docAbbr.toLowerCase().Contains("bfi"))
                    allowBluetoothPrint = true
            } else {
                if (docAbbr.toLowerCase().Contains("bfi"))
                    allowBluetoothPrint = true
            }


            if (allowBluetoothPrint) {
                this.AddButton('BluetoothPrint', this.ButtonsPopup, 40, 40);
            }
        }



        for (let i = 0; i < flds.length; i++) {
            if (removeButtons.Contains(flds[i]))
                continue;
            this.AddButton(flds[i], this.ButtonsPopup, 40, 40);
        }
        //this.ButtonsPopup.sort((a, b) => a.Label > b.Label ? 1 : -1)

        //#region ButtonSecurity

        if (BaseService.SessionManager.HideUnathorizedAccess)
            this.ButtonSave.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Create");
        else
            this.ButtonSave.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Create");
        if (BaseService.SessionManager.HideUnathorizedAccess)
            this.ButtonDelete.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");
        else
            this.ButtonDelete.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");
        if (BaseService.SessionManager.HideUnathorizedAccess)
            this.ButtonSuspendDoc.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");
        else
            this.ButtonSuspendDoc.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");

        if (BaseService.SessionManager.HideUnathorizedAccess)
            this.ButtonSaveandPrint.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");
        else
            this.ButtonSaveandPrint.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");

        this.HideButtons("Save&Barcode");

        this.HideButtons("BarcodePrint");

        this.ButtonRevise.Visible = false;
        this.ButtonApprove.Visible = false;
        // #endregion

        /** added for Desktop UI Design Purpose Commented
         *    // #region RightTabPanel
            this.RightTabVisible = new Dictionary<string, PactButtonData>();
    
            this.CheckRightTab("Attachments");
            if (!(ScreenObject.Preferences.ContainsKey("ActivityAsPopUp") && ScreenObject.Preferences["ActivityAsPopUp"].ToString() == "True"))
                   CheckRightTab("Activities");
            this.CheckRightTab("Recur");
            this.CheckRightTab("Report");
            this.CheckRightTab("Bounce");
    
            /*RightTabVisible.Add("Import", GetButtonVisibility("Import"));
            RightTabVisible.Add("Attachments", GetButtonVisibility("Attachments"));
            RightTabVisible.Add("Activities", GetButtonVisibility("Activities"));
            RightTabVisible.Add("Recur", GetButtonVisibility("Recur"));
            RightTabVisible.Add("Report", GetButtonVisibility("Report"));
            RightTabVisible.Add("Bounce", GetButtonVisibility("Bounce"));
            *
    
            this.ButtonAttachments = GetButton("Attachments");
            if (this.ButtonAttachments == null)
            {
                this.ButtonAttachments = new PactButtonData();
                this.ButtonAttachments.Visible = false;
            }
            this.ButtonActivities = GetButton("Activities");
            if (this.ButtonActivities == null || (ScreenObject.Preferences.ContainsKey("ActivityAsPopUp") && ScreenObject.Preferences["ActivityAsPopUp"].ToString() == "True"))
            {
                this.ButtonActivities = new PactButtonData();
                this.ButtonActivities.Visible = false;
            }
            this.ButtonReport = GetButton("Report");
            if (this.ButtonReport == null)
            {
                this.ButtonReport = new PactButtonData();
                this.ButtonReport.Visible = false;
            }
            this.ButtonRecur = GetButton("Recur");
            if (this.ButtonRecur == null)
            {
                this.ButtonRecur = new PactButtonData();
                this.ButtonRecur.Visible = false;
            }
            this.ButtonBounce = GetButton("Bounce");
            if (this.ButtonBounce == null)
            {
                this.ButtonBounce = new PactButtonData();
                this.ButtonBounce.Visible = false;
            }
    
           // #endregion
    **/
        let btn = this.GetButton("Generate Cheques");
        if (btn == null)
            btn = this.GetButton("Pre Payments");

        if (btn != null)
            this.pdcGCVM = new pdcGenerateChequeViewModel(this);
    }

    ButtonReport: PactButtonData;
    RightTabSelectedIndex = 0;
    AddButton(ButtonName: string, lst: PactButtonData[], widt: number, height: number) {
        let tempccid: number;
        let btn: PactButtonData = new PactButtonData();
        btn.DBColumnName = ButtonName;

        switch (ButtonName) {
            case "":
                return;
            case "Assign":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "AssignUsers"))
                    return;
                btn.ImgData = "btn_assign";
                btn.Icon = "fa-light fa-user-plus";
                btn.Label = BaseService.GetResource("Assign");
                btn.ComParam = "Assign";
                break;
            case "Pick Min.":
                btn.ImgData = "btn_PickMin";
                btn.Icon = "fa-light fa-layer-minus";
                btn.Label = BaseService.GetResource("PickMin");
                btn.ComParam = "PickMin";
                break;
            case "UBL":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "UBL"))
                    return;
                btn.ImgData = "btn_EInv";
                btn.Icon = "fa-light fa-time-circle";
                btn.Label = BaseService.GetResource("EInv");
                btn.ComParam = "UBL";
                btn.Visible = true;
                break;
            case "UBLNEW":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "UBL"))
                    return;
                btn.ImgData = "btn_EInv";
                btn.Icon = "fa-light fa-time-circle";
                btn.Label = BaseService.GetResource("EInvoice");
                btn.ComParam = "UBLNEW";
                btn.Visible = true;
                break;
            case "Close":
                if (!((this.ScreenObject.Preferences.ContainsKey("UseAsLC") && this.ScreenObject.Preferences["UseAsLC"] != "" && parseBoolean(this.ScreenObject.Preferences["UseAsLC"]))
                    || (this.ScreenObject.Preferences.ContainsKey("UseAsTR") && this.ScreenObject.Preferences["UseAsTR"] != "" && parseBoolean(this.ScreenObject.Preferences["UseAsTR"]))))
                    return;
                btn.ImgData = "btn_Close";
                btn.Icon = "fa-light fa-time-circle";
                btn.Label = BaseService.GetResource("Close");
                btn.ComParam = "Close";
                break;
            case "next":
                btn.ImgData = "btn_PickMax";
                btn.Icon = "far fa-angle-right";
                btn.Label = BaseService.GetResource("next");
                btn.ComParam = "next";
                break;
            case "prev":
                btn.ImgData = "far fa-angle-left";
                btn.Label = BaseService.GetResource("prev");
                btn.ComParam = "prev";
                break;
            case "Pick Max.":
                btn.ImgData = "btn_PickMax";
                btn.Icon = "fa-light fa-layer-plus";
                btn.Label = BaseService.GetResource("PickMax");
                btn.ComParam = "PickMax";
                break;
            case "Check-in":
                btn.ImgData = "btn_Check-in";
                btn.Label = BaseService.GetResource("Check_In");
                btn.ComParam = "Check-in";
                break;
            case "Load":
                btn.ImgData = "btn_Load";
                btn.Icon = "fa-light fa-circle-notch fa-spin";
                btn.Label = BaseService.GetResource("Load");
                btn.ComParam = "Load";
                break;
            case "Check-out":
                btn.ImgData = "btn_Check-out";
                btn.Label = BaseService.GetResource("Check_Out");
                btn.ComParam = "Check-out";
                break;
            case "Rotation":
                btn.ImgData = "btn_Rotation";
                btn.Icon = "fa-light fa-arrows-rotate";
                btn.Label = BaseService.GetResource("Rotation");
                btn.ComParam = "Rotation";
                break;
            case "GenerateOnDuty":
                btn.ImgData = "btn_GenerateOnDuty";
                btn.Icon = "fa-light fa-link";
                btn.Label = BaseService.GetResource("GenerateOnDuty");
                btn.ComParam = "GenerateOnDuty";
                break;
            case "Renew":
                btn.ImgData = "btn_Renew";
                btn.Icon = "fa-light fa-file";
                btn.Label = BaseService.GetResource("Renew");
                btn.ComParam = "Renew";
                break;
            case "Validate":
                btn.ImgData = "btn_Validate";
                btn.Icon = "fa-light fa-arrows-rotate";
                btn.Label = BaseService.GetResource("Validate");
                btn.ComParam = "Validate";
                break;
            case "ReleaseJob":
                btn.ImgData = "btn_ReleaseJob";
                btn.Icon = "fa-light fa-arrows-rotate";
                btn.Label = BaseService.GetResource("ReleaseJob");
                btn.ComParam = "ReleaseJob";
                break;
            case "Innoviti":
                btn.ImgData = "btn_Innoviti";
                btn.Icon = "fa-light fa-credit-card";
                btn.Label = BaseService.GetResource("CardPay");
                btn.ComParam = "Innoviti";
                break;
            case "LinkStatus":
                this.ButtonSuspend = btn;
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_linkStatus";
                btn.Icon = "far fa-link";
                btn.Label = BaseService.GetResource("LinkStatus");
                btn.ComParam = "SuspendVisiblity";
                break;
            case "Lock":
                if (!(BaseService.SessionManager.Preferences.ContainsKey("LockEditMode") && parseBoolean(BaseService.SessionManager.Preferences["LockEditMode"])))
                    return;
                btn.ImgData = "btn_Lock";
                btn.Icon = "fa-light fa-lock";
                btn.Label = BaseService.GetResource("Lock");
                btn.ComParam = "Lock";
                btn.Visible = false;
                break;
            case "Generate":
                if (!this.IsInventoryVoucher || this.IsPOs || (this.ScreenObject.Preferences.ContainsKey("DisableGenerate") && this.ScreenObject.Preferences["DisableGenerate"] == "True")
                    || (this.ScreenObject.Data.Tables.length > 20 && this.ScreenObject.Data.Tables[20].filter(x => x.CostCenterIDBase > 40000).length == 0))
                    return;
                btn.ImgData = "btn_GenerateLink";
                btn.Icon = "fa-light fa-link";;
                btn.Label = BaseService.GetResource("GenerateLink");
                btn.ComParam = "GenerateLink";
                btn.Visible = false;
                break;
            case "New":
                btn.ImgData = "btn_new";
                btn.Icon = "fa-light fa-file";
                btn.Label = BaseService.GetResource("New");
                if (this.IsPOs)
                    btn.Label = btn.Label + " F2";
                btn.ComParam = "New";
                break;
            case "Revise":
                this.ButtonRevise = btn;
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_revise";
                btn.Icon = "fa-light fa-book-open";
                btn.Label = BaseService.GetResource("Revise");
                btn.ComParam = "Revise";
                break;
            case "BidRevise":
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_bidrevise";
                btn.Icon = "fa-light fa-book-open";
                btn.Label = BaseService.GetResource("Bid Revise");
                btn.ComParam = "BidRevise";
                btn.Visible = false;
                this.ButtonBidRevise = btn;
                break;
            case "BidReviseDistribute":
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_bidrevisedistribute";
                btn.Icon = "fa-light fa-book-open";
                btn.Label = BaseService.GetResource("Decrease By");
                btn.ComParam = "BidReviseDistribute";
                btn.Visible = false;
                this.ButtonBidReviseDistribute = btn;
                break;
            case "GST":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "GST") || !this.IsInventoryVoucher)
                    return;
                btn.ImgData = "btn_gst";
                btn.Icon = "fa-light fa-money-bill";
                btn.Label = BaseService.GetResource("GST");
                btn.ComParam = "GST";
                btn.Visible = false;
                break;
            case "API":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "API"))
                    return;
                btn.ImgData = "btn_API";
                btn.Icon = "fa-light fa-time-circle";
                btn.Label = BaseService.GetResource("API");
                btn.ComParam = "API";
                btn.Visible = false;
                break;
            case "ExternalFun":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ExternalFun"))
                    return;
                btn.ImgData = "btn_ExternalFun";
                btn.Icon = "fa-light fa-plus-square";
                btn.Label = BaseService.GetResource("ExternalFun");
                btn.ComParam = "ExternalFun";
                btn.Visible = false;
                break;
                let isExtCall = true;
                var Extfld = this.ScreenObject._TextFields.find(a => !Util.IsEmpty(a.DBColumnName) && a.DBColumnName.toLowerCase() == btn.ControlDataXML.toLowerCase());
                if (Extfld == null)
                    Extfld = this.ScreenObject._CCFields.find(a => !Util.IsEmpty(a.DBColumnName) && a.DBColumnName.toLowerCase() == btn.ControlDataXML.toLowerCase());
                if (Extfld != null)
                    isExtCall = this.ValidateData(Extfld as PactControlData, true);
                else {
                    var GExtfld = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.DisplayMember) && a.DisplayMember.toLowerCase() == btn.ControlDataXML.toLowerCase());
                    if (GExtfld != null)
                        isExtCall = this.ValidateData_Column(GExtfld, this.SelectedRow, true);
                }
                if (isExtCall) {
                    this.ScreenObject.GetExternalFuncData(btn.Mode, btn.ToolTipFooterTitle, btn.ToolTipFooterDescription, btn.ToolTipDescription, this.SelectedRow, null);
                    if (!Util.IsEmpty(btn.ToolTipDescription) && btn.ToolTipDescription.split(',')[0] == "-501")
                        this.ReEvaluate(true, false);
                }
                break;
            case "Post":
                this.ButtonSave = btn;
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_post";
                btn.Icon = "fa-light fa-floppy-disk-circle-arrow-right";
                btn.Label = BaseService.GetResource("Post");
                btn.ComParam = "Save";
                break;
            case "Save":
                if (!(this.ScreenObject.Preferences.ContainsKey("enebleSaveonhold") && this.ScreenObject.Preferences["enebleSaveonhold"] == "True"))
                    return;
                btn.ImgData = "btn_saveonhold";
                btn.Icon = "fa-light fa-save";
                btn.Label = BaseService.GetResource("Save");
                btn.ComParam = "SaveonHold";
                break;
            case "Delete":
                this.ButtonDelete = btn;
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_delete";
                btn.Icon = "fa-light fa-trash-alt";
                btn.Label = BaseService.GetResource("Delete");
                btn.ComParam = "Delete";
                break;
            case "SaveAndPrint":
                this.ButtonSaveandPrint = btn;
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_saveprint";
                btn.Icon = "fas fa-print";
                btn.Label = BaseService.GetResource("SaveAndPrint");
                btn.ComParam = "SaveAndPrint";
                break;
            case "Adjust Down Payments":
                if (!(this.ScreenObject.Preferences.ContainsKey("AllowAdjToDownPmt") && this.ScreenObject.Preferences["AllowAdjToDownPmt"].toString() == "True"))
                    return;
                btn.ImgData = "btn_adjustdownpayments";
                btn.Icon = "fa-light fa-money-bill";
                btn.Label = BaseService.GetResource("AdjustDownPay");
                btn.ComParam = "AdjustDownPay";
                break;
            case "Enquiries":
                if (this.ScreenObject.DocumentType != 25)
                    return;
                btn.ImgData = "btn_enquiries";
                btn.Icon = "fa-light fa-megaphone";
                btn.Label = BaseService.GetResource("Doc_Enquiries");
                btn.ComParam = "Enquiries";
                break;
            case "Advance":
                if (!(this.ScreenObject.Preferences.ContainsKey("DonotupdateAccounts") && this.ScreenObject.Preferences["DonotupdateAccounts"] != "" &&
                    parseBoolean(this.ScreenObject.Preferences["DonotupdateAccounts"]) && this.ScreenObject.Preferences.ContainsKey("AllowAdvRct") && this.ScreenObject.Preferences["AllowAdvRct"] != "" && parseBoolean(this.ScreenObject.Preferences["AllowAdvRct"])
                    && this.ScreenObject.Preferences.ContainsKey("PostVoucherDocument") && this.ScreenObject.Preferences["PostVoucherDocument"] != "" && Util.IsNum(this.ScreenObject.Preferences["PostVoucherDocument"])
                    && parseInt(this.ScreenObject.Preferences["PostVoucherDocument"]) > 40000))
                    return;
                btn.ImgData = "btn_advance";
                btn.Icon = "fa-light fa-ad";
                btn.Label = BaseService.GetResource("Advance");
                btn.ComParam = "Advance";
                break;
            case "Redeposit":
                if (!(this.DocumentType == 14 || this.DocumentType == 19 || this.ScreenObject.DocumentType == 18 || this.ScreenObject.DocumentType == 15))
                    return;
                btn.ImgData = "btn_redeposit";
                btn.Icon = "fa-light fa-step-backward";
                btn.Label = BaseService.GetResource("Redeposit");
                btn.ComParam = "Redeposit";
                btn.Visible = false;
                break;
            case "Pack":
                if (!(this.ScreenObject.Preferences.ContainsKey("EnablePacking") && this.ScreenObject.Preferences["EnablePacking"] == "True"))
                    return;
                btn.ImgData = "btn_pack";
                btn.Icon = "fa-light fa-archive";
                btn.Label = BaseService.GetResource("Pack");
                btn.ComParam = "Pack";
                break;
            case "Approve":
                this.ButtonApprove = btn;
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_approve";
                btn.Icon = "fa-light fa-user";
                if (BaseService.SessionManager.Preferences.ContainsKey("ApproveActionText") && !Util.IsEmpty(BaseService.SessionManager.Preferences["ApproveActionText"]))
                    btn.Label = BaseService.SessionManager.Preferences["ApproveActionText"];
                else
                    btn.Label = BaseService.GetResource("btnApprove");
                btn.ComParam = "ApproveVisiblity";
                btn.Visible = false;
                break;
            case "Submit":
                btn.ImgData = "btn_submit";
                btn.Icon = "fa-light fa-check-circle";
                btn.Label = BaseService.GetResource("Submit");
                btn.ComParam = "NoWorkFlow";
                btn.Visible = false;
                break;
            case "Stock Posting":
                if (!(this.ScreenObject.DocumentType == 31))
                    return;
                btn.ImgData = "btn_stockposting";
                btn.Icon = "fa-light fa-box-check";
                btn.Label = BaseService.GetResource("StockPosting");
                btn.ComParam = "PostStock";
                break;
            case "Copy Leaves":
                if (this.ScreenObject.DocumentType != 81)
                    return;
                btn.ImgData = "btn_copyleaves";
                btn.Icon = "far fa-copy";
                btn.Label = BaseService.GetResource("CopyLeaves");
                btn.ComParam = "ALCopy";
                break;
            case "Set Columns":
                if (this.ScreenObject.DocumentType != 67)
                    return;
                btn.ImgData = "btn_setcolumns";
                btn.Icon = "fa-light fa-columns";
                btn.Label = BaseService.GetResource("SetColumns");
                btn.ComParam = "DATCustomize";
                break;
            case "Employee Filter":
                if (this.ScreenObject.DocumentType != 67 && this.ScreenObject.DocumentType != 97)
                    return;
                btn.ImgData = "btn_employeefilter";
                btn.Icon = "fa-light fa-filter";
                btn.Label = BaseService.GetResource("Filter");
                btn.ComParam = "DailyAttendanceFilter";
                break;
            case "Get Previous Day":
                if (this.ScreenObject.DocumentType != 67)
                    return;
                btn.ImgData = "btn_getpreviousday";
                btn.Icon = "fa-light fa-calendar-minus";
                btn.Label = BaseService.GetResource("PreviousDay");
                btn.ComParam = "GetPreviousDay";
                break;
            case "All Employees":
                if (this.ScreenObject.DocumentType != 67)
                    return;
                btn.ImgData = "btn_allemployee";
                btn.Icon = "fa-light fa-users-class";
                btn.Label = "All Employees";
                btn.ComParam = "GetAllEmployees";
                break;

            case "Fill Dates":
                if (this.ScreenObject.DocumentType != 67 && this.ScreenObject.DocumentType != 92)
                    return;
                btn.ImgData = "btn_filldates";
                btn.Icon = "fa-light fa-calendar-day";
                btn.Label = BaseService.GetResource("FillDates");
                btn.ComParam = "FillDates";
                break;

            case "Fill General Timings":
                if (this.ScreenObject.DocumentType != 67)
                    return;
                btn.ImgData = "btn_fillgeneraltimings";
                btn.Icon = "fa-light fa-clock";
                btn.Label = BaseService.GetResource("FillGeneralTimings");
                btn.ComParam = "FillGeneralTimings";
                break;

            case "Define Days":
                if (this.ScreenObject.DocumentType != 61) //Vacation Management
                    return;
                btn.ImgData = "btn_DefineDays";
                btn.Label = BaseService.GetResource("DefineDays");
                btn.ComParam = "DefineDays";
                break;
            case "Guarantees":
                if (!(this.ScreenObject.DocumentType == 56 && BaseService.SessionManager.Preferences.ContainsKey("IsLoanGuaranteeMandatory") && BaseService.SessionManager.Preferences["IsLoanGuaranteeMandatory"] == "True"))
                    return;
                this.LoanGuaranteeVisible = true;

                btn.ImgData = "btn_guarantees";
                btn.Label = BaseService.GetResource("Guarantees");
                btn.ComParam = "LoanGuarantees";
                break;
            case "Distribute":
                if (this.ScreenObject.DocumentType > 50 && this.ScreenObject.DocumentType != 56)
                    return;
                btn.ImgData = "btn_distribute";
                btn.Icon = "fa-project-diagram fa-light";
                btn.Label = BaseService.GetResource("Distribute");
                btn.ComParam = "DistributeInstallments";
                break;
            case "Pay":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Create") && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit"))
                    return;
                btn.ImgData = "btn_pay";
                btn.Icon = "fa-light fa-check";
                btn.Label = "Pay F7";
                btn.ComParam = "Pay";
                break;
            case "Print":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Print"))
                    return;
                btn.ImgData = "btn_print";
                btn.Icon = "fa-light fa-print";
                btn.Label = BaseService.GetResource("Print"); //Print is given twice
                if (this.IsPOs)
                    btn.Label = btn.Label + " F4";
                btn.ComParam = "Print"; //No command parameter
                break;
            case "Hold":
                if ((this.IsPOs && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Hold")) || (BaseService.SessionManager.LicenseSettings.ContainsKey("Hold_Release") && BaseService.SessionManager.LicenseSettings["Hold_Release"].toUpperCase() == "FALSE"))
                    return;
                if (!this.IsPOs && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "HoldDoc"))
                    return;
                btn.ImgData = "btn_hold";
                btn.Icon = "fa-light fa-box";
                btn.Label = BaseService.GetResource("Hold") + " F8";
                btn.ComParam = "Hold";
                break;
            case "Release":
                if ((this.IsPOs && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Release")) || (BaseService.SessionManager.LicenseSettings.ContainsKey("Hold_Release") && BaseService.SessionManager.LicenseSettings["Hold_Release"].toUpperCase() == "FALSE"))
                    return;
                btn.ImgData = "btn_release";
                btn.Icon = "fa-light fa-box-open";
                btn.Label = BaseService.GetResource("Com_Release") + " F6";
                btn.ComParam = "Release";
                break;
            case "Exit":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Exit"))
                    return;
                btn.ImgData = "btn_exit";
                btn.Icon = "fa-light fa-share";
                btn.Label = "Exit";
                btn.ComParam = "Exit";
                break;
            case "Options":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Options"))
                    return;
                btn.ImgData = "btn_options";
                btn.Icon = "fa-light fa-money-check";
                btn.Label = BaseService.GetResource("Com_Options");
                btn.ComParam = "Options";
                break;
            case "LineDisc":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Line Wise Discount"))
                    return;
                let drlineDisc = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 23094);
                if (drlineDisc.length == 0)
                    return;
                btn.ImgData = "btn_LineDisc";
                btn.Icon = "fa-light fa-money-check";
                btn.Label = BaseService.GetResource("LineDisc");
                btn.ComParam = "LineDisc";
                break;
            case "Disc":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Overall Discount"))
                    return;
                let drDisc = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 23095);
                if (drDisc.length == 0)
                    return;

                btn.ImgData = "btn_Disc";
                btn.Icon = "fa-light fa-money-check";
                btn.Label = BaseService.GetResource("Disc");
                btn.ComParam = "Disc";
                break;
            //case "Print":
            //    btn.ImgData = "M29.300499,30.022999 C28.895399,30.022999 28.566999,30.411167 28.566999,30.889997 28.566999,31.36883 28.895399,31.756998 29.300499,31.756998 29.705601,31.756998 30.034,31.36883 30.034,30.889997 30.034,30.411167 29.705601,30.022999 29.300499,30.022999 z M13.133119,29.076027 L9.7585115,30.982679 18.367262,35.462646 21.784939,33.502659 z M33.033501,28.155998 C32.628399,28.155998 32.299999,28.544168 32.299999,29.022999 32.299999,29.501829 32.628399,29.889999 33.033501,29.889999 33.438599,29.889999 33.766998,29.501829 33.766998,29.022999 33.766998,28.544168 33.438599,28.155998 33.033501,28.155998 z M10.185559,23.554455 L10.074273,29.528889 11.963757,28.355318 11.85261,25.901478 23.967398,31.449287 23.967398,30.169023 z M37.572033,21.181215 L37.665001,30.982225 25.984245,37.02285 C25.984245,37.02285 22.493893,26.021702 37.572033,21.181215 z M16.783514,19.991077 L15.897782,20.861204 23.066936,24.22168 23.95266,23.231535 z M27.177462,8.9766511 L23.106972,16.650587 30.957205,20.417793 34.73695,12.743855 z M26.835384,8.0860004 L29.331661,9.3300142 29.321669,9.3124485 C29.266296,9.2033968 29.255922,9.1029529 29.301765,9.0261993 29.424013,8.8215217 29.899731,8.8628091 30.364305,9.1184167 L32.827984,10.473923 C33.292561,10.72953 33.570076,11.102666 33.447826,11.307342 33.440186,11.320135 33.431164,11.331967 33.420853,11.342846 L33.402412,11.358663 35.769585,12.538338 33.019245,18.122374 37.664986,20.367207 C37.664986,20.367207 29.485924,23.581116 28.068771,25.661402 28.068771,25.661402 24.511995,29.421925 25.067741,33.902546 L25.438702,37.223 22.098324,35.64159 19.132484,37.223 7.4619999,31.302462 9.9445658,29.887732 8.9886332,29.435175 C8.9886332,29.435175 8.0994434,20.900703 11.100445,18.553726 11.100445,18.553726 13.212145,15.353301 21.548338,12.5796 L23.859512,13.696365 z M24.043997,2.98825 C12.424756,2.98825 3.0054996,12.353447 3.0054998,23.906 3.0054996,35.458557 12.424756,44.823753 24.043997,44.823753 35.663239,44.823753 45.082497,35.458557 45.082497,23.906 45.082497,12.353447 35.663239,2.98825 24.043997,2.98825 z M24.043997,0 C37.323128,-8.3754003E-08 48.087997,10.703081 48.087997,23.906 48.087997,37.108921 37.323128,47.812 24.043997,47.812 10.764864,47.812 0,37.108921 0,23.906 0,10.703081 10.764864,-8.3754003E-08 24.043997,0 z";
            //    btn.Label = BaseService.GetResource("Print"); //Print is given twice
            //    //btn.ComParam = "Options";  //No command parameter
            //break;
            case "PrintPreview":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Print"))
                    return;
                btn.ImgData = "btn_printpreview";
                btn.Icon = "fa-light fa-eye";
                btn.Label = BaseService.GetResource("VPDesigner_PrintPreview");
                btn.ComParam = "PrintPreview"; //No command parameter
                break;
            case "BluetoothPrint":
                btn.ImgData = "btn_printpreview";
                btn.Icon = "fa-light fa-bluetooth";
                btn.Label = BaseService.GetResource("Bluetooth Print");
                btn.ComParam = "BluetoothPrint"; //No command parameter
                break;
            case "Suspend":
                this.ButtonSuspendDoc = btn;
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_suspend";
                btn.Icon = "fa-light fa-ban";
                btn.Label = BaseService.GetResource("Suspend");
                btn.ComParam = "Suspend";
                break;
            case "ContinuousPrint":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ContinuousPrint"))
                    return;
                btn.ImgData = "btn_ContinuousPrint";
                btn.Icon = "fa-light fa-shredder";
                btn.Label = BaseService.GetResource("Doc_ContinuousPrinting");
                btn.ComParam = "ContinuousPrint";
                break;
            case "SaveAndBarcode":
                this.ButtonSaveandBarcode = btn;
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_SaveAndBarcode";
                btn.Icon = "fa-light fa-barcode-alt";
                btn.Label = BaseService.GetResource("SaveAndBarcode");
                btn.ComParam = "SaveAndBarcode";
                break;
            case "BarcodePrint":
                this.ButtonBarcode = btn;
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_barcodeprint";
                btn.Icon = "fa-light fa-barcode";
                btn.Label = BaseService.GetResource("Barcode");
                btn.ComParam = "BarcodePrint";
                break;
            case "Export":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Export"))
                    return;
                btn.ImgData = "btn_export";
                btn.Icon = "fa-light fa-file-export";
                btn.Label = BaseService.GetResource("Export");
                btn.ComParam = "Export";
                break;
            case "Email":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Email"))
                    return;
                btn.ImgData = "btn_email";
                btn.Icon = "fa-light fa-envelope ";
                btn.Label = BaseService.GetResource("SMTP_Email");
                btn.ComParam = "Email";
                break;
            case "SMS":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "SMS"))
                    return;
                btn.ImgData = "btn_sms";
                btn.Icon = "fa-light fa-message-dots";
                btn.Label = BaseService.GetResource("SMTP_SMS");
                btn.ComParam = "SMS";
                break;
            case "Draft":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Draft"))
                    return;
                btn.ImgData = "btn_saveasDraft";
                btn.Icon = "fa-light fa-clipboard";
                btn.Label = BaseService.GetResource("Com_SaveAsDraft");
                btn.ComParam = "SaveDraft";
                break;
            case "Copy":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Copy"))
                    return;
                btn.ImgData = "btn_copy";
                btn.Icon = "fa-light fa-copy";
                btn.Label = BaseService.GetResource("Copy");
                btn.ComParam = "Copy";
                break;
            case "Clone":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Duplicate"))
                    return;
                btn.ImgData = "btn_clone";
                btn.Icon = "fa-light fa-clone";
                btn.Label = BaseService.GetResource("Clone");
                btn.ComParam = "Duplicate";
                break;
            case "Import":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Import") || (BaseService.SessionManager.LicenseSettings.ContainsKey("Import") && BaseService.SessionManager.LicenseSettings["Import"].toUpperCase() == "FALSE"))
                    return;
                btn.ImgData = "btn_import";
                btn.Icon = "fa-light fa-file-import";
                btn.Label = BaseService.GetResource("Import_Data");
                btn.ComParam = "ImportVisiblity";
                break;
            case "Sort":
                if (!BaseService.SessionManager.IsActionAssigned(43, "Sort Body"))
                    return;
                btn.ImgData = "btn_sort";
                btn.Icon = "fa-light fa-sort";
                btn.Label = BaseService.GetResource("Reports_Sort");
                btn.ComParam = "SortVisiblity";
                break;
            case "Recur":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Recur"))
                    return;
                btn.ImgData = "btn_Recur";
                btn.Icon = "fa-light fa-repeat-alt";
                btn.Label = BaseService.GetResource("Recur");
                btn.ComParam = "Recur";
                break;
            case "Show JV":
                if ((this.ScreenObject.Preferences.ContainsKey("DonotupdateAccounts") && this.ScreenObject.Preferences["DonotupdateAccounts"] != "" &&
                    parseBoolean(this.ScreenObject.Preferences["DonotupdateAccounts"])) || this.DocumentType == 30)
                    return;

                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "JV"))
                    return;
                btn.ImgData = "btn_showjv";
                btn.Icon = "fa-light fa-book";
                btn.Label = BaseService.GetResource("ShowJV");
                btn.ComParam = "ShowJV";
                break;
            case "ReverseJV":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReverseJV"))
                    return;
                btn.ImgData = "btn_showjv";
                btn.Icon = "fa-light fa-book";
                btn.Label = BaseService.GetResource("Reverse JV");
                btn.ComParam = "ReverseJV";
                break;       
            case "Generate Cheques":
                if (!(this.ScreenObject.Preferences.ContainsKey("LineWisePDC") && this.ScreenObject.Preferences["LineWisePDC"] == "True"))
                    return;
                btn.ImgData = "btn_generatecheques";
                btn.Label = BaseService.GetResource("Generate_Cheques");
                btn.ComParam = "Cheque";
                break;
            case "Pre Payments":
                if (this.IsInventoryVoucher || !(this.ScreenObject.Preferences.ContainsKey("PrepaymentDoc") && !Util.IsEmpty(this.ScreenObject.Preferences["PrepaymentDoc"]) && parseInt(this.ScreenObject.Preferences["PrepaymentDoc"]) > 40000))
                    return;
                btn.ImgData = "btn_prepayments";
                btn.Icon = "fa-light fa-money-bill-wave-alt";
                btn.Label = BaseService.GetResource("PrePayments");
                btn.ComParam = "Cheque";
                break;
            case "Location":
                if (!(this.ScreenObject.Preferences.ContainsKey("LocationVisibility") && this.ScreenObject.Preferences["LocationVisibility"] == "True"))
                    return;
                btn.ImgData = "btn_changeloc";
                btn.Icon = "fa-light fa-map-marker";
                btn.Label = BaseService.GetResource("DocChangeLocation");
                btn.ComParam = "ChangeLocation";
                break;
            case "Notes":
                if (!(this.ScreenObject.Preferences.ContainsKey("Notes") && this.ScreenObject.Preferences["Notes"] == "True" && BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Notes")))
                    return;
                btn.ImgData = "btn_note";
                btn.Icon = "fa-light fa-sticky-note";
                btn.Label = BaseService.GetResource("Notes");
                btn.ComParam = "Notes";
                break;
            case "Attachments":
                if (!(this.ScreenObject.Preferences.ContainsKey("Attachments") && this.ScreenObject.Preferences["Attachments"] == "True" && BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Attach")))
                    return;

                btn = new PactButtonData();
                btn.DBColumnName = "Capture";
                btn.ImgData = "btn_attachment";
                btn.Icon = "fa-light fa-camera";
                btn.Label = BaseService.GetResource("Capture Image");
                btn.ComParam = "Capture";
                btn.Width = widt.toString();
                btn.SectionID = height.toString();
                lst.push(btn);

                btn = new PactButtonData();
                btn.DBColumnName = "Sign";
                btn.ImgData = "btn_attachment";
                btn.Icon = "fa-light fa-signature";
                btn.Label = BaseService.GetResource("Sign");
                btn.ComParam = "Sign";
                btn.Width = widt.toString();
                btn.SectionID = height.toString();
                lst.push(btn);

                btn = new PactButtonData();
                btn.DBColumnName = ButtonName;
                btn.ImgData = "btn_attachment";
                btn.Icon = "fa-light fa-paperclip";
                btn.Label = BaseService.GetResource("Attachments");
                btn.ComParam = "Attachment";

                break;
            case "Contacts":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Contacts"))
                    return;
                btn.ImgData = "btn_Contacts";
                btn.Label = BaseService.GetResource("Com_Contacts");
                btn.ComParam = "Contacts";
                break;
            case "ReEvaluate":
                if (!this.IsInventoryVoucher || !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReEvaluate"))
                    return;
                btn.ImgData = "btn_reevaluate";
                btn.Icon = "fa-light fa-calculator";
                btn.Label = BaseService.GetResource("ReEvaluate");
                btn.ComParam = "ReEvaluate";
                break;
            case "ReEvaluatePriceChart":
                if (!this.IsInventoryVoucher || !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReEvaluatePriceChart"))
                    return;
                btn.ImgData = "btn_reevaluate";
                btn.Icon = "fa-light fa-calculator";
                btn.Label = BaseService.GetResource("ReEvaluatePriceChart");
                btn.ComParam = "ReEvaluatePrice";
                break;
            case "ReEvaluateTaxChart":
                if (!this.IsInventoryVoucher || !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReEvaluateTaxChart"))
                    return;
                btn.ImgData = "btn_reevaluate";
                btn.Icon = "fa-light fa-calculator";//fa-light fa-chart-scatter
                btn.Label = BaseService.GetResource("ReEvaluateTaxChart");
                btn.ComParam = "ReEvaluateTax";
                break;
            case "Activities":
                if (!(this.ScreenObject.Preferences.ContainsKey("Activities") && this.ScreenObject.Preferences["Activities"] == "True"))
                    return;
                btn.ImgData = "btn_activity";
                btn.Icon = "fa-light fa-calendar-alt";
                btn.Label = BaseService.GetResource("Activities");
                btn.ComParam = "Activities";
                break;
            case "Customize":
                if (!(BaseService.SessionManager.IsFeatureAssigned(43) && BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Customize")))
                    return;
                btn.ImgData = "btn_customize";
                btn.Label = BaseService.GetResource("Customize");
                btn.ComParam = "Customize";
                break;
            case "Search":
                btn.ImgData = "btn_search";
                btn.Icon = "fa-light fa-search";
                btn.Label = BaseService.GetResource("btnSearch");
                btn.ComParam = "Search";
                break;
            case "SearchPrice":
                btn.ImgData = "btn_searchprice";
                btn.Icon = "fa-light fa-search";
                btn.Label = BaseService.GetResource("Search Price");
                btn.ComParam = "SearchPrice";
                break;
            case "Report":
                btn.ImgData = "btn_Report";
                btn.Icon = "fa-light fa-file-chart-line";
                btn.Label = BaseService.GetResource("Report");
                btn.ComParam = "Report";
                break;
            case "Documents":
                btn.ImgData = "btn_Report";
                btn.Icon = "fa-light fa-book";
                btn.Label = BaseService.GetResource("Documents");
                btn.ComParam = "Documents";
                break;
            case "DocLink":
                btn.Icon = "fa-light fa-project-diagram";
                btn.Label = BaseService.GetResource("Doc_link");
                btn.ComParam = "DocLink";
                break;
            case "Addresses":
                btn.Icon = "fa-light fa-book";
                btn.Label = "Address";
                btn.ComParam = "Addresses";
                break;
            case "Bounce":
                if (!(this.ScreenObject.DocumentType == 18 || this.ScreenObject.DocumentType == 15))
                    return;
                btn.ImgData = "btn_bounce";
                btn.Icon = "fa-light fa-money-check";
                btn.Label = BaseService.GetResource("DocumentDesigner_Bounce");
                btn.ComParam = "Bounce";
                break;
            case "History":
                btn.ImgData = "btn_history";
                btn.Icon = "fa-light fa-history";
                btn.Label = BaseService.GetResource("History");
                btn.ComParam = "ViewHistory";
                btn.Visible = false;
                break;
            case "Load Drafts":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Draft"))
                    return;
                btn.ImgData = "btn_loaddrafts";
                btn.Icon = "fa-light fa-file-upload";
                btn.Label = BaseService.GetResource("Com_LoadDraft");
                btn.ComParam = "LoadDraft";
                break;
            //case "Hold":
            //    btn.ImgData = "M19.110601,18.563202 L18.265291,18.738087 17.987889,19.499944 18.564974,20.21662 19.416821,19.991161 19.640322,19.248151 z M11.293121,8.0873224 C11.392489,8.0890351 11.492839,8.0962141 11.593825,8.1091189 13.030063,8.2926578 14.050814,9.564903 13.873734,10.950758 13.840532,11.210605 13.767576,11.455998 13.661474,11.682009 L13.651067,11.702786 15.0279,13.228183 18.824523,9.3943181 C18.824523,9.394318 19.140872,9.2239439 19.470628,9.4361365 19.470628,9.4361366 20.359267,9.7847023 20.807165,10.825176 20.807165,10.825177 20.942139,10.88601 20.678352,11.320988 20.665603,11.342013 20.65192,11.363912 20.637248,11.386719 20.353802,11.827299 17.500436,14.61448 16.879653,15.218904 L16.850421,15.247358 18.77279,17.377155 18.853621,17.376846 C18.918926,17.378299 18.984755,17.383181 19.05092,17.391635 20.109579,17.526922 20.854148,18.525988 20.713963,19.623109 20.573775,20.720232 19.60192,21.499954 18.543262,21.364665 17.484603,21.229379 16.740033,20.230313 16.880219,19.13319 16.897742,18.996051 16.928261,18.86387 16.970319,18.737816 L17.003294,18.646406 15.074982,16.506892 15.06202,16.525836 C15.003895,16.617702 14.963834,16.711501 14.948184,16.805911 14.948184,16.805911 14.932747,17.339283 14.533682,17.313454 14.533682,17.313454 14.347342,17.244139 13.801846,16.827139 13.801846,16.827139 10.852632,19.565254 10.744088,19.768157 10.744088,19.768157 10.555843,20.023161 10.401911,20.337636 L9.3724868,21.206152 8.8539903,20.666849 9.7250609,19.663158 C9.7250612,19.663158 9.9756771,19.474508 10.329479,19.255787 L13.40929,16.405718 C13.40929,16.405718 12.865702,15.664404 12.865702,15.664404 12.865702,15.664404 12.8296,15.337628 13.228665,15.363457 13.228665,15.363457 13.445908,15.294698 13.724107,15.096941 L13.772371,15.061612 11.972145,13.06421 11.866173,13.089745 C11.574775,13.15262 11.266742,13.167893 10.952565,13.127744 9.5612088,12.949941 8.559778,11.750412 8.6595386,10.415667 8.6627567,10.372611 8.6671208,10.329414 8.6726546,10.286106 8.6975562,10.091219 8.7448197,9.9044652 8.811657,9.7279192 L8.8126342,9.725435 10.075197,11.113952 11.614002,10.744784 12.058911,9.3259526 10.976887,8.1005636 10.998316,8.0983235 C11.095369,8.0893632 11.193753,8.0856096 11.293121,8.0873224 z M15,1.875 C7.7512631,1.875 1.8750005,7.7512622 1.8750005,15 1.8750005,22.248737 7.7512631,28.124999 15,28.124999 22.248737,28.124999 28.125,22.248737 28.125,15 28.125,7.7512622 22.248737,1.875 15,1.875 z M15,0 C23.28427,0 30,6.7157291 30,15 30,23.284271 23.28427,29.999999 15,29.999999 6.7157292,29.999999 0,23.284271 0,15 0,6.7157291 6.7157292,0 15,0 z";
            //    btn.Label = BaseService.GetResource("Customize");
            //    btn.ComParam = "Customize";
            //    break;
            //case "Release":
            //    btn.ImgData = "M22.026186,20.25725 C23.67647,20.253851 25.125227,21.458243 25.380302,23.139502 25.661165,24.99069 24.388493,26.719004 22.537712,26.9998 20.686928,27.280594 18.958891,26.007538 18.678032,24.156348 18.397173,22.305157 19.669844,20.576844 21.520624,20.296051 21.636299,20.2785 21.751493,20.267021 21.865885,20.261374 21.919506,20.258726 21.97295,20.257359 22.026186,20.25725 z M22.039997,18.821163 C21.797621,18.820898 21.552155,18.838932 21.305153,18.876404 18.670467,19.276131 16.858751,21.736508 17.258575,24.371809 17.658401,27.007113 20.118359,28.819405 22.753048,28.41968 23.65872,28.282273 24.467148,27.901371 25.121929,27.353571 L25.196831,27.289358 25.235458,27.317459 29.279747,30.105644 C29.84692,30.49666 30.62361,30.3538 31.014528,29.786555 L31.01487,29.786062 C31.40579,29.218819 31.262911,28.441994 30.695742,28.05098 L26.651457,25.262791 C26.63373,25.250572 26.615801,25.238875 26.597687,25.227694 L26.59066,25.223599 26.607307,25.175747 C26.842106,24.473566 26.918322,23.706629 26.799623,22.924273 26.437283,20.536028 24.382975,18.823717 22.039997,18.821163 z M14.180218,11.503 L28.020515,11.503 C28.020515,11.503 34.367001,18.008496 34.367001,18.008496 L34.367001,35.761807 C34.367001,36.064011 34.122002,36.309002 33.819786,36.309002 L14.180218,36.309002 C13.877998,36.309002 13.633,36.064011 13.633,35.761807 L13.633,12.050192 C13.633,11.747989 13.877998,11.503 14.180218,11.503 z M24,2.9882505 C12.40202,2.9882507 3,12.353446 3,23.906 3,35.458554 12.40202,44.82375 24,44.82375 35.59798,44.82375 45,35.458554 45,23.906 45,12.353446 35.59798,2.9882507 24,2.9882505 z M24,0 C37.254833,7.1525574E-07 48,10.70308 48,23.906 48,37.108917 37.254833,47.812001 24,47.812001 10.745166,47.812001 0,37.108917 0,23.906 0,10.70308 10.745166,7.1525574E-07 24,0 z";
            //    btn.Label = BaseService.GetResource("btnSearch");
            //    btn.ComParam = "Search";
            //    break;
            case "CashDrawer":
                if (!(this.ScreenObject.Preferences.ContainsKey("Select Port") && this.ScreenObject.Preferences["Select Port"] == "True"))
                    return;
                btn.ImgData = "btn_cashdrawer";
                btn.Icon = "fafa-cash-register";
                btn.Label = BaseService.GetResource("Com_CashDrawer");
                btn.ComParam = "CashDrawer";
                break;
            case "Payment Terms":
                if ((this.ScreenObject.Preferences.ContainsKey("Enable Payment Terms") && this.ScreenObject.Preferences["Enable Payment Terms"] != "" && parseBoolean(this.ScreenObject.Preferences["Enable Payment Terms"]))
                    || (this.ScreenObject.Preferences.ContainsKey("CopyPaymentTerms") && this.ScreenObject.Preferences["CopyPaymentTerms"] != "" && parseBoolean(this.ScreenObject.Preferences["CopyPaymentTerms"]))) {
                    btn.ImgData = "btn_paymentTerms";
                    btn.Icon = "fa-light fa-list";
                    btn.Label = BaseService.GetResource("ViewPaymentTerms");
                    btn.ComParam = "ViewPaymentTerms";
                }
                else
                    return;
                break;
            case "Terms Conditions":
                if (!(this.ScreenObject.Preferences.ContainsKey("DocQtyAdjustment") && this.ScreenObject.Preferences["DocQtyAdjustment"] != "" && parseBoolean(this.ScreenObject.Preferences["DocQtyAdjustment"])))
                    return;
                btn.ImgData = "btn_termsConditions";
                btn.Icon = "fa-light fa-list";
                btn.Label = BaseService.GetResource("TermsConditions");
                btn.ComParam = "TermsConditions";
                break;
            case "Convert":
                if (!(this.ScreenObject.Data.Tables.length > 20 && this.ScreenObject.Data.Columns[20].Contains("DocumentLinkDefID") && this.ScreenObject.Data.Tables[20].filter(x => x.Mode == 2 && x.CostCenterIDBase == 73).length > 0))
                    return;
                btn.ImgData = "btn_convert";
                btn.Label = BaseService.GetResource("Convert");
                btn.ComParam = "Convert";
                btn.Visible = false;
                break;
            case "DocumentHistory":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "DocumentHistory"))
                    return;
                btn.ImgData = "btn_dochistory";
                btn.Icon = "fa-light fa-file-medical-alt";
                btn.Label = BaseService.GetResource("Doc_History");
                btn.ComParam = "DocumentHistory";
                break;
            case "Revise History":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReviseHistory")
                    || !(this.ScreenObject.Preferences.ContainsKey("EnableRevision") && this.ScreenObject.Preferences["EnableRevision"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableRevision"])))
                    return;

                btn.ImgData = "btn_revhistory";
                btn.Icon = "fa-light fa-history";
                btn.Label = BaseService.GetResource("Revise_History");
                btn.ComParam = "ReviseHistory";
                break;
            case "PriceChart":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "PriceChart") && BaseService.SessionManager.LicenseSettings.ContainsKey("PriceChartFromDocument") && BaseService.SessionManager.LicenseSettings["PriceChartFromDocument"].toUpperCase() == "FALSE")
                    return;
                btn.ImgData = "btn_pricechart";
                btn.Icon = "fa-light fa-chart-line";
                btn.Label = BaseService.GetResource("PriceChart");
                btn.ComParam = "PriceChart";
                btn.Visible = false;
                break;
            case "Map":
                // if (!this.IsInventoryVoucher)
                //     return;
                btn.ImgData = "btn_map";
                btn.Icon = "fa-light fa-project-diagram";
                btn.Label = BaseService.GetResource("Map");
                btn.ComParam = "LINKMAP";
                break;
            case "Post Billwise":
                if (!this.IsInventoryVoucher || !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Post Billwise")
                    || (this.ScreenObject.Preferences.ContainsKey("BillwisePosting") && (this.ScreenObject.Preferences["BillwisePosting"] == "1" || this.ScreenObject.Preferences["BillwisePosting"] == "2")))
                    return;
                btn.ImgData = "btn_postbillwise";
                btn.Icon = "fa-light fa-list-alt";
                btn.Label = BaseService.GetResource("PostBillwise");
                btn.ComParam = "PostBills";
                break;
            case "Help":
                if (Util.IsEmpty(this.HelpDoc))
                    return;
                btn.ImgData = "btn_help";
                btn.Label = BaseService.GetResource("Help");//"Help";
                btn.ComParam = "HelpDoc";
                break;
            case "LinkInfo":
                if (!this.IsInventoryVoucher || this.ScreenObject.Link == null)
                    return;

                if (!(this.ScreenObject.Preferences.ContainsKey("LinkPopup") && this.ScreenObject.Preferences["LinkPopup"] == "True"))
                    return;

                this.ScreenObject.Link.Visible = false;
                btn.ImgData = "LinkInfo";
                btn.Icon = "fafa-link";
                btn.Label = BaseService.GetResource("Doc_link");//"Link";
                btn.ComParam = "LinkInfo";
                break;
            case "TabsPopUp":
                if (this.ScreenObject.Preferences.ContainsKey("TabsPopup") && this.ScreenObject.Preferences["TabsPopup"] == "2") {
                    this.TabBtnVisible = true;
                    return;
                }

                if (!(this.ScreenObject.Preferences.ContainsKey("TabsPopup") && this.ScreenObject.Preferences["TabsPopup"] == "1") || !this.ScreenObject.CustomTab.Visible)
                    return;
                this.ScreenObject.CustomTab.Visible = false;
                btn.ImgData = "TabsPopUp";
                btn.Icon = "fa-light fa-info-square";
                btn.Label = BaseService.GetResource("ExtraInfo");
                btn.ComParam = "TabsPopUp";
                break;
            case "AssignVPT":
                if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "AssignVPT"))
                    return;
                btn.ImgData = "btn_AssignVPT";
                btn.Icon = "fa-light fa-user-plus";
                btn.Label = BaseService.GetResource("AssignVPT");
                btn.ComParam = "AssignVPT";
                break;

            case "Change Qty":
                btn.ImgData = "btn_AssignVPT";
                btn.Label = "Change Qty";
                btn.ComParam = "ChangeQty";
                break;
            case "Change Rate":
                btn.ImgData = "btn_AssignVPT";
                btn.Label = "Change Rate";
                btn.ComParam = "ChangeRate";
                break;
            case "Change Unit":
                btn.ImgData = "btn_AssignVPT";
                btn.Label = "Change Unit";
                btn.ComParam = "ChangeUnit";
                break;
            case "Return Line":
                btn.ImgData = "btn_AssignVPT";
                btn.Label = BaseService.GetResource("ReturnLine");
                btn.Icon = "fa-light fa-user-plus";
                btn.ComParam = "ReturnLine";
                break;
            case "Delete Line":
                btn.ImgData = "btn_AssignVPT";
                btn.Label = "Void";
                btn.Icon = "fa-light fa-layer-minus";
                btn.ComParam = "DeleteLine";
                break;
            case "Sales Return":
                btn.ImgData = "btn_AssignVPT";
                btn.Label = BaseService.GetResource("SalesReturn");
                btn.Icon = "fa-light fa-file-chart-line";
                btn.ComParam = "SalesReturn";
                break;
            case "Docs":
                btn.ImgData = "btn_Report";
                btn.Icon = "fa-light fa-folder ";
                btn.Label = BaseService.GetResource("Docs");
                btn.ComParam = "Docs";
                break;
        }

        btn.Width = widt.toString();
        btn.SectionID = height.toString();
        lst.push(btn);
        if (ButtonName == "Submit") {
            btn = new PactButtonData();
            btn.DBColumnName = "Submitprint";
            btn.ImgData = "M17.099383,21.729994 L17.099383,24.035563 22.019618,24.035563 22.019618,21.729994 z M15.763892,20.31729 L15.763892,22.26473 C15.763892,22.341222 15.827995,22.40534 15.90447,22.40534 L16.537071,22.40534 16.537071,21.167554 22.58193,21.167554 22.58193,22.40534 23.214533,22.40534 C23.291007,22.40534 23.35511,22.341222 23.35511,22.26473 L23.35511,20.31729 z M20.690592,16.192655 L20.690592,17.39824 21.915168,17.39824 z M17.099383,16.17044 L17.099383,19.019888 22.019618,19.019888 22.019618,17.820068 20.268858,17.820068 20.268858,16.17044 z M16.537071,15.608 L20.697621,15.608 22.58193,17.462922 22.58193,17.819929 C22.835533,17.874203 23.02714,18.100584 23.02714,18.369571 L23.02714,19.019888 23.214533,19.019888 C23.678579,19.019888 24.058001,19.314042 24.058001,19.673298 L24.058001,22.26473 C24.058001,22.729022 23.678579,23.108386 23.214533,23.108386 L22.58193,23.108386 22.58193,24.598001 16.537071,24.598001 16.537071,23.108386 15.90447,23.108386 C15.440421,23.108386 15.061,22.729022 15.061001,22.26473 L15.061001,19.673298 C15.061,19.314042 15.440421,19.019888 15.90447,19.019888 L16.091861,19.019888 16.091861,18.369571 C16.091861,18.100584 16.283468,17.874203 16.537071,17.819929 z M9.4247408,7.9182401 L18.343435,7.9182401 C18.343435,7.9182401 22.433113,11.712019 22.433113,11.712018 L22.433113,14.734 20.624731,14.734 20.624731,12.643335 C20.624731,12.643335 17.642112,9.8768835 17.642113,9.8768835 L11.137668,9.8768835 C10.995637,9.8768835 10.880497,9.9810638 10.880497,10.109576 L10.880497,20.192904 C10.880497,20.321415 10.995637,20.425596 11.137668,20.425596 L13.847999,20.425596 13.847999,22.384239 9.4247408,22.384239 C9.229991,22.384239 9.0721149,22.241371 9.0721149,22.065136 L9.0721149,8.2373428 C9.0721149,8.0611076 9.229991,7.9182401 9.4247408,7.9182401 z M15,1.875 C7.7512627,1.875 1.875,7.7512622 1.875,15 1.875,22.248737 7.7512627,28.125 15,28.125 22.248737,28.125 28.125,22.248737 28.125,15 28.125,7.7512622 22.248737,1.875 15,1.875 z M15,0 C23.284269,0 30,6.7157288 30,15 30,23.284271 23.284269,30 15,30 6.7157297,30 0,23.284271 0,15 0,6.7157288 6.7157297,0 15,0 z";
            btn.Label = BaseService.GetResource("Submit_print");
            btn.ComParam = "NoWorkFlowprint";
            btn.Visible = false;
            btn.Width = widt.toString();
            btn.SectionID = height.toString();
            lst.push(btn);
        }
    }

    GetButton(buttonName: string): PactButtonData {
        let btn = this.ButtonsLeft.find(a => a.DBColumnName == buttonName);
        if (btn == undefined) {
            btn = this.ButtonsPopup.find(a => a.DBColumnName == buttonName);
            /** if (btn == null && this.RightTabVisible.ContainsKey(buttonName))
                    return this.RightTabVisible[buttonName]; **/
        }
        return btn;
    }

    public GetButtonVisibility(buttonName: string): boolean {
        var btn = this.ButtonsLeft.find(a => a.DBColumnName == buttonName);
        if (btn == null)
            btn = this.ButtonsPopup.find(a => a.DBColumnName == buttonName);
        if (btn != null)
            return btn.Visible && btn.Enable;
        return false;
    }


    CheckRightTab(buttonName: string) {
        let btn: PactButtonData = this.ButtonsLeft.find(a => a.DBColumnName == buttonName);
        if (btn != null) {
            this.ButtonsLeft.Remove(btn);
            /** added for Desktop UI
             this.RightTabVisible.push(buttonName, btn);
             **/
        }
        else {
            btn = this.ButtonsPopup.find(a => a.DBColumnName == buttonName);
            if (btn != null) {
                this.ButtonsPopup.Remove(btn);
                /** added for Desktop UI
               this.RightTabVisible.Add(buttonName, btn);
               **/
            }
            else {
                btn = new PactButtonData();
                btn.Visible = false;
                /** added for Desktop UI
                 this.RightTabVisible.Add(buttonName, btn);
                 **/
            }
        }

    }

    SetButtonVisibility(sBtnCommandParameter: string, bVisibilityy: boolean) {
        let btn = this.ButtonsLeft.find(a => a.ComParam.toUpperCase() == sBtnCommandParameter.toUpperCase());
        if (btn != null)
            btn.Visible = bVisibilityy;
        else {
            btn = this.ButtonsPopup.find(a => a.ComParam.toUpperCase() == sBtnCommandParameter.toUpperCase());
            if (btn != null)
                btn.Visible = bVisibilityy;
        }
    }
    POSRegisterID: number;
    worker_DoWork(srcdoc: any) {
        Logger.InfoLog("AddEditDocumentViewModel::Entering worker_DoWork");
        this.DisplayName = BaseService.GetResource("Loading");
        this.ScreenObject.LoadScreen(this, this.POSRegisterID);
        if (this.ScreenObject.IsAccessDenied)
            return

        if (this.ScreenObject.Data.Tables[0].length > 0 && this.ScreenObject.Data.Columns[0].Contains("ErrorNumber"))
            return;

        if (this.ScreenObject.DocumentType == 65) // Join From Vacation/Leave
        {
            let strWhr = "";
            strWhr = this.FilterLeaveTypes(2);
            let DimLTfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
            if (DimLTfld && DimLTfld instanceof PactListBoxData) {
                DimLTfld.CustomWhere = strWhr;
                let dt1 = BaseService.common.GetDataSet("PAY043", "").Tables[0];
                if (dt1 != null && dt1.length > 0) {
                    DimLTfld.DefaultValue = dt1[0]["ComponentID"].toString();
                    DimLTfld.SelectedValue = parseInt(dt1[0]["ComponentID"]);
                }
            }
        }
        if (this.ScreenObject.DocumentType == 94) // Consider LOP to Service Days
        {
            let strWhr = "";
            strWhr = this.FilterLeaveTypes(3);
            let DimLTfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
            if (DimLTfld && DimLTfld instanceof PactListBoxData) {
                DimLTfld.CustomWhere = strWhr;
            }
            this.ScreenObject.GridDataObj.Clear();
        }

        if (this.IsNewAssignLeave) {
            this.dtALeaveComp = BaseService.common.GetDataTable("DOC069", "");

            if (this.dtALeaveComp != null && this.dtALeaveComp.length > 0) {
                this.FillComponent(this.dtALeaveComp);
            }
        }


        if (this.ScreenObject.IsPayrollDocument) {
            if (BaseService.SessionManager.IsEmpUser) {
                let drnull1 = null;
                let DimLTfld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (DimLTfld && DimLTfld instanceof PactListBoxData) {
                    if (BaseService.SessionManager.lstEmpFilteredEmpSeqNos.Contains(BaseService.SessionManager.iEmployee)) {
                        DimLTfld.DefaultValue = BaseService.SessionManager.iEmployee.toString();
                        DimLTfld.SelectedValue = BaseService.SessionManager.iEmployee;
                        this.ScreenObject.OnGetReference(DimLTfld);
                        let param = { ReferenceTable: null, ReferenceEditTable: null, DBColumnName: "Dimension", ccid: 0, dr: drnull1 }
                        this.ReferenceCallBack(param);
                        drnull1 = param.dr
                    }
                }
                else if (DimLTfld && DimLTfld instanceof PactCodeNameListBoxData) {
                    if (BaseService.SessionManager.lstEmpFilteredEmpSeqNos.Contains(BaseService.SessionManager.iEmployee)) {
                        DimLTfld.DefaultValue = BaseService.SessionManager.iEmployee.toString();
                        DimLTfld.SelectedValue = BaseService.SessionManager.iEmployee;
                        this.ScreenObject.OnGetReference(DimLTfld.Name);
                        let param = { ReferenceTable: null, ReferenceEditTable: null, DBColumnName: "Dimension", ccid: 0, dr: drnull1 }
                        this.ReferenceCallBack(param);
                        drnull1 = param.dr
                    }
                }
            }
        }

        if (this.IsPOs && this.ScreenObject.Data.Tables[1].length == 0) {
            this.DisplayMessage = "NO Register Assigned";

            this.DialogResult = true;
            this.OKCancelVisibility = true;
            return;
        }
        else if (this.IsPOs && this.ScreenObject.CCguid == "") {
            this.DisplayMessage = "Define Register in document prefix";

            this.DialogResult = true;
            this.OKCancelVisibility = true;
            return;
        }
        else if (this.IsPOs) {
            this.POSPayModes = new POSPayModesViewModel(this);
            //this.POSPayModes.POSPayModesViewModel(this);// = new POSPayModesViewModel(this);
        }

        if (this.ScreenObject.GridDataColumns.Contains("FieldType")) {
            if (this.ScreenObject.Data.Tables[1].length == 0) {
                this.DisplayMessage = "NO Register Assigned";
                this.DialogResult = true;
                this.OKCancelVisibility = true;
                return;
            }
            else {
                this.ScreenObject.RegisterNodeID = parseInt(this.ScreenObject.Data.Tables[1][0]["NodeID"]);
                this.ScreenObject.ShiftNodeID = parseInt((this.ScreenObject.Data.Tables[1][0]["ShiftID"].toString() == "0") ? "1" : this.ScreenObject.Data.Tables[1][0]["ShiftID"]);
            }
            if (this.ScreenObject.Data.Tables[8].filter(x => x.CCID == BaseService.SessionManager.RegisterCCID).length == 0) {
                this.DisplayMessage = "Define Register in document prefix";
                this.DialogResult = true;
                this.OKCancelVisibility = true;
                return;
            }
            if (!this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key")) {
                this.DisplayMessage = "Define line wise debit account";
                this.DialogResult = true;
                this.OKCancelVisibility = true;
                return;
            }
            if (!this.ScreenObject.Preferences.ContainsKey("PosPaymentTypeFld") || this.ScreenObject.Preferences["PosPaymentTypeFld"] == "" || this.ScreenObject.Preferences["PosPaymentTypeFld"] == "0") {
                this.DisplayMessage = "Define Payment type field in preferences";
                this.DialogResult = true;
                this.OKCancelVisibility = true;
                return;
            }
        }

        let dvrws = this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -2 && (x.Mode == 1 || x.Mode == 3));
        if (dvrws.length > 0) {
            this.BodyVisible = parseBoolean(dvrws[0]["IsVisible"]);
            this.ReadOnlyBody = !parseBoolean(dvrws[0]["IsEditable"]);
        }
        else {
            this.BodyVisible = true;
            this.ReadOnlyBody = false;
        }

        if (this.ScreenObject.Preferences.ContainsKey("Lock Body") && parseBoolean(this.ScreenObject.Preferences["Lock Body"]))
            this.ReadOnlyBody = true;
        else
            this.ReadOnlyBody = false;

        if (!Util.IsEmpty(BaseService.SessionManager.Preferences["DimensionwiseCurrency"]) && parseInt(BaseService.SessionManager.Preferences["DimensionwiseCurrency"]) > 50000
            && !(this.ScreenObject.DocumentType >= 51 && this.ScreenObject.DocumentType <= 199)) {
            let exccol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == parseInt(BaseService.SessionManager.Preferences["DimensionwiseCurrency"]) && a.DisplayMember.toLowerCase().startsWith("dcccnid"));
            if (exccol) {
                this.DisplayMessage = "Define Exchange Rate Dimension in header";
                this.DialogResult = true;
                this.OKCancelVisibility = true;
                return;
            }

            let excfld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == parseInt(BaseService.SessionManager.Preferences["DimensionwiseCurrency"]));
            if (excfld == null) {
                this.DisplayMessage = "Define Exchange Rate Dimension in document";
                this.DialogResult = true;
                this.OKCancelVisibility = true;
                return;
            }
        }

        this.SetLockDims();
        if (this.ScreenName == "") {
            if (this.ScreenObject.Data.Tables.length > 3 && this.ScreenObject.Data.Columns[3].Contains("DocumentName") && this.ScreenObject.Data.Tables[3].length > 0)
                this.ScreenName = this.ScreenObject.Data.Tables[3][0]["DocumentName"].toString();
        }
        this.HistCols = [];
        let col = new DgColumn();
        col.Header = "Version";
        col.DisplayMember = "VersionNo";
        col.ReadOnly = true;
        col.DisableTab = true;
        col.Width = 50;
        this.HistCols.push(col);

        col = new DgColumn();
        col.Header = "Reason";
        col.DisplayMember = "ReviseReason";
        col.ReadOnly = true;
        col.DisableTab = true;
        col.Width = 100;
        this.HistCols.push(col);

        col = new DgColumn();
        col.Header = "User";
        col.DisplayMember = "ModifiedBy";
        col.ReadOnly = true;
        col.DataType = "LINK";
        col.DisableTab = true;
        col.Click.Subscribe(this, "onHistoryClick");
        col.Width = 100;
        this.HistCols.push(col);

        col = new DgColumn();
        col.Header = "Date";
        col.DisplayMember = "ModifiedDate";
        col.ReadOnly = true;
        col.DisableTab = true;
        col.Width = 120;
        this.HistCols.push(col);

        this.DocHistory = [];//new DataTable();
        this.DocHistoryColumns = [];
        this.DocHistoryColumns.push("ModifiedBy");
        this.DocHistoryColumns.push("ModifiedDate");
        this.DocHistoryColumns.push("MaxID");
        this.DocHistoryColumns.push("IsCurrent");
        this.DocHistoryColumns.push("VersionNo");
        this.DocHistoryColumns.push("ReviseReason");

        if (this.ScreenObject.Link != null && this.ScreenObject.Link.DocumentList != null)
            this.ScreenObject.Link.DocumentList.cmnItem_Click.Subscribe(this, "onselectall");
        let cno = 0; let ispa: boolean = false;
        if (this.ScreenObject.IsInventory) {
            ispa = parseBoolean(BaseService.SessionManager.Preferences["EnableLocationWise"]);
            ispa = parseBoolean(BaseService.SessionManager.Preferences["Location AverageRate"]);
            if (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && parseBoolean(BaseService.SessionManager.Preferences["EnableLocationWise"])
                && BaseService.SessionManager.Preferences.ContainsKey("Location AverageRate") && parseBoolean(BaseService.SessionManager.Preferences["Location AverageRate"])) {
                if (this.ScreenObject.PriceTaxcc.ContainsKey(50002))
                    this.ScreenObject.PriceTaxcc[50002] = this.ScreenObject.PriceTaxcc[50002] + ",a";
                else
                    this.ScreenObject.PriceTaxcc.push(50002, "a");
            }
            ispa = parseBoolean(BaseService.SessionManager.Preferences["EnableDivisionWise"]);
            ispa = parseBoolean(BaseService.SessionManager.Preferences["Division AverageRate"]);
            if (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && parseBoolean(BaseService.SessionManager.Preferences["EnableDivisionWise"])
                && BaseService.SessionManager.Preferences.ContainsKey("Division AverageRate") && parseBoolean(BaseService.SessionManager.Preferences["Division AverageRate"])) {
                if (this.ScreenObject.PriceTaxcc.ContainsKey(50001))
                    this.ScreenObject.PriceTaxcc[50001] = this.ScreenObject.PriceTaxcc[50001] + ",a";
                else
                    this.ScreenObject.PriceTaxcc.push(50001, "a");
            }
            ispa = parseBoolean(BaseService.SessionManager.Preferences["EnableLocationWise"]);
            ispa = parseBoolean(BaseService.SessionManager.Preferences["Location Stock"]);
            if (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise")/* && parseBoolean(BaseService.SessionManager.Preferences["EnableLocationWise"], out ispa)*/ && parseBoolean(BaseService.SessionManager.Preferences["EnableLocationWise"])
                && BaseService.SessionManager.Preferences.ContainsKey("Location Stock") /*&& parseBoolean(BaseService.SessionManager.Preferences["Location Stock"], out ispa)*/ && parseBoolean(BaseService.SessionManager.Preferences["Location Stock"])) {
                if (this.ScreenObject.PriceTaxcc.ContainsKey(50002))
                    this.ScreenObject.PriceTaxcc[50002] = this.ScreenObject.PriceTaxcc[50002] + ",s";
                else
                    this.ScreenObject.PriceTaxcc.push(50002, "s");
            }
            ispa = parseBoolean(BaseService.SessionManager.Preferences["EnableDivisionWise"]);
            ispa = parseBoolean(BaseService.SessionManager.Preferences["Division Stock"]);
            if (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && parseBoolean(BaseService.SessionManager.Preferences["EnableDivisionWise"])//&& parseBoolean(BaseService.SessionManager.Preferences["EnableDivisionWise"], out ispa)
                && BaseService.SessionManager.Preferences.ContainsKey("Division Stock") && parseBoolean(BaseService.SessionManager.Preferences["Division Stock"]))// && parseBoolean(BaseService.SessionManager.Preferences["Division Stock"], out ispa)
            {
                if (this.ScreenObject.PriceTaxcc.ContainsKey(50001))
                    this.ScreenObject.PriceTaxcc[50001] = this.ScreenObject.PriceTaxcc[50001] + ",s";
                else
                    this.ScreenObject.PriceTaxcc.push(50001, "s");
            }

            cno = Util.Int(BaseService.SessionManager.Preferences["Maintain Dimensionwise stock"])
            if (BaseService.SessionManager.Preferences.ContainsKey("Maintain Dimensionwise stock") && cno > 50000)//&& Util.Int(BaseService.SessionManager.Preferences["Maintain Dimensionwise stock"],out cno)
            {
                if (this.ScreenObject.PriceTaxcc.ContainsKey(cno))
                    this.ScreenObject.PriceTaxcc[cno] = this.ScreenObject.PriceTaxcc[cno] + ",s";
                else
                    this.ScreenObject.PriceTaxcc.push(cno, "s");
            }
            cno = Util.Int(BaseService.SessionManager.Preferences["Maintain Dimensionwise AverageRate"]);
            if (BaseService.SessionManager.Preferences.ContainsKey("Maintain Dimensionwise AverageRate") && cno > 50000) {
                if (this.ScreenObject.PriceTaxcc.ContainsKey(cno))
                    this.ScreenObject.PriceTaxcc[cno] = this.ScreenObject.PriceTaxcc[cno] + ",a";
                else
                    this.ScreenObject.PriceTaxcc.push(cno, "a");
            }
            cno = Util.Int(BaseService.SessionManager.Preferences["DimWisePaymentterms"]);
           if (this.ScreenObject.Preferences.ContainsKey("DimWisePaymentterms") && !Util.IsEmpty(this.ScreenObject.Preferences["DimWisePaymentterms"])
               && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (cno - 50000) + "_Key"))
           {
               this.PaytermDimCol = "dcCCNID" + (cno - 50000) + "_Key";
               this.Paytermsdt = []
               this.PaytermsdtColumns.push("Amt");
               this.PaytermsdtColumns.push("VatAmt");
               this.PaytermsdtColumns.push("DimID");
               this.PaytermsdtColumns.push("DimName");
           }
        }

        cno = 0;
        ispa = false;
        this.SalesManDimension = new PactListBoxData(); //{ Visible = false };
        this.SalesManDimension.Visible = false;
        this.ScreenObject.ColumnSource.forEach(item => {
            item.footer = "";
            cno++;
            if (item.DisplayMember == "RefNo" || item.DisplayMember == "Denomination") {
                item.DataType = "LINK";
                item.DisableTab = true;
                item.Click.Subscribe(this, "onLinkRefClick");// = new Delegate<string>(onLinkRefClick);
                if (item.DisplayMember == "Denomination")
                    this.ScreenObject.GridDataColumns.push("DenominationsXML");
            }
            else if (item.DataType == "LINK") {
                if (item.ValueBinding)//For Image Icons
                    return;
                item.Click.Subscribe(this, "onAttachLinkClick");// new DelegateCommand<string>(onAttachLinkClick);
            }
            else if (item.DataType == "CheckBox") {
                item.CheckedChanged.Subscribe(this, "OnCheckedChanged"); //= new Microsoft.Windows.Controls.DataGridCheckBoxColumn.OnCheckedChanged(OnCheckedChanged);
            }
            if (this.ScreenObject.IsInventory && this.ColumnNo == 0) {
                if (item.ValueMember != null && item.ValueMember.toLowerCase() == "productid_key")
                    ispa = true;
                else if (ispa && item.IsVisible)
                    this.ColumnNo = cno;
            }
            else if (!this.ScreenObject.IsInventory && this.ColumnNo == 0) {
                if (item.ValueMember != null && (item.ValueMember.toLowerCase() == "debitaccount_key" || item.ValueMember.toLowerCase() == "creditaccount_key" || item.ValueMember.toLowerCase() == "accountid_key"))
                    ispa = true;
                else if (ispa && item.IsVisible)
                    this.ColumnNo = cno;
            }

            if ((this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 39) && item.CostCenterID == 50005) {
                this.SalesManDimension.Visible = true;
                this.SalesManDimension.CCID = 50005;
                this.SalesManDimension.Label = item.Header;
                this.SalesManDimension.TypeID = item.TypeID;
                this.SalesManDimension.GridViewID = item.GridViewID;
                if (this.SalesManDimension.GridViewID > 0)
                    this.SalesManDimension.SearchVisible = true;
            }
            if (!Util.IsEmpty(item.Shortcut))
                this.Shortcuts.push(item);
        });

        if (this.ScreenObject.Preferences.ContainsKey("Dynamic Footer") && this.ScreenObject.Preferences["Dynamic Footer"] != null && this.ScreenObject.Preferences["Dynamic Footer"] == "True")
            this.DynFooter = true;
        else
            this.DynFooter = false;

        if (this.ScreenObject.Preferences.ContainsKey("AppDate") && this.ScreenObject.Preferences["AppDate"] == "True")
            this.AppRejDate.Visible = true;
        else
            this.AppRejDate.Visible = false;

        if (this.ScreenObject.Data.Tables.length > 3 && this.ScreenObject.Data.Tables[3].length > 0) {
            if (this.ScreenObject.Data.Columns[3].Contains("IsLineWise")
                && !Util.IsEmpty(this.ScreenObject.Data.Tables[3][0]["IsLineWise"]))
                this.LineWiseApproval = parseBoolean(this.ScreenObject.Data.Tables[3][0]["IsLineWise"]);
            if (this.ScreenObject.Data.Columns[3].Contains("UserWise")
                && !Util.IsEmpty(this.ScreenObject.Data.Tables[3][0]["UserWise"]))
                this.UserWiseApproval = parseBoolean(this.ScreenObject.Data.Tables[3][0]["UserWise"]);
            if (this.ScreenObject.Data.Columns[3].Contains("OnReject")
                && !Util.IsEmpty(this.ScreenObject.Data.Tables[3][0]["OnReject"]))
                this.OnRejectEdit = parseBoolean(this.ScreenObject.Data.Tables[3][0]["OnReject"]);
            if (this.ScreenObject.Data.Columns[3].Contains("attachfile")
                && !Util.IsEmpty(this.ScreenObject.Data.Tables[3][0]["attachfile"]))
                this.HelpDoc = this.ScreenObject.Data.Tables[3][0]["attachfile"];
        }

        if (this.ScreenObject.Preferences.ContainsKey("HideRightNav") && this.ScreenObject.Preferences["HideRightNav"] != "" && this.ScreenObject.Preferences["HideRightNav"] == "True")
            this.RightPanelVisiblity = false;
        else
            this.RightPanelVisiblity = true;

        if (this.ScreenObject.Preferences.ContainsKey("DisableRightPanel") && this.ScreenObject.Preferences["DisableRightPanel"] != "")
            this.DisableRightPanel = parseBoolean(this.ScreenObject.Preferences["DisableRightPanel"]);

        if (this.ScreenObject.Preferences.ContainsKey("EnableRevision") && this.ScreenObject.Preferences["EnableRevision"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableRevision"])) {
            this.ScreenObject.DocPrefix.RevisionCombo.Visible = true;
            this.ScreenObject.DocPrefix.RevisionCombo.Items.push(ComboBoxItems.ComboBoxItems_2("", "0"));
            this.ScreenObject.DocPrefix.RevisionCombo.SelectedValue = "0";
            this.ScreenObject.DocPrefix.RevisionCombo.SelectionChangedCommand.Subscribe(this, "onVerionChanged");
        }

        if (this.ScreenObject.Preferences.ContainsKey("DonotupdateInventory")) {
            if (this.ScreenObject.Preferences["DonotupdateInventory"] != "")
                this.DonotUpdateInventory = parseBoolean(this.ScreenObject.Preferences["DonotupdateInventory"]);
        }
        if (this.ScreenObject.Preferences.ContainsKey("DonotUpdateSchemeQty")) {
            if (this.ScreenObject.Preferences["DonotUpdateSchemeQty"] != "")
                this.DonotUpdateSchemeQty = parseBoolean(this.ScreenObject.Preferences["DonotUpdateSchemeQty"]);
        }
        if (this.ScreenObject.Preferences.ContainsKey("HideNetAmt") && this.ScreenObject.Preferences["HideNetAmt"] == "True")
            this.NetAmtVisibility = false;
        if (this.ScreenObject.Preferences.ContainsKey("HideNetAmt") && this.ScreenObject.Preferences["HideNetAmt"] == "True")
            this.NetAmtVisibility = false;
        else if (this.ScreenObject.Data.Tables.length > 10) {
            let dv = this.ScreenObject.Data.Tables[10].filter(x => (x.Mode == 1 || x.Mode == 3) && x.CostCenterColID == -1);//New or both
            if (dv.length > 0 && !Util.IsEmpty(dv[0]["IsVisible"]))
                this.NetAmtVisibility = parseBoolean(dv[0]["IsVisible"]);
        }
        if (this.ScreenObject.Preferences.ContainsKey("OptionalInventory") && this.ScreenObject.Preferences["OptionalInventory"] != "" && parseBoolean(this.ScreenObject.Preferences["OptionalInventory"])) {
            let chk = new PactCheckBoxData(0)
            chk.Row = 3; chk.Column = 3;
            this.ScreenObject.HeaderFields.push(chk);
            this.donotupInv = this.ScreenObject.HeaderFields[this.ScreenObject.HeaderFields.length - 1] as PactCheckBoxData;
            if (this.donotupInv != null) {
                this.donotupInv.IsChecked = this.DonotUpdateInventory;
                this.donotupInv.Label = "Do not Update Inventory";
            }
        }

        this.ConstructFormulaFields();
        this.IsInventoryVoucher = this.ScreenObject.IsInventory;
        this.DocumentType = this.ScreenObject.DocumentType;

        this.LoadButtons();

        if (this.ScreenObject.DocumentType == 32)//|| this.ScreenObject.DocumentType == 81
            this.savebulk = true;

        this.ScreenObject.HeaderFields.forEach(item => {
            if (item instanceof PactHistoryData)
                item.ClickCommand.Subscribe(this, "OnHistoryButtonClick");
            else if (item instanceof PactCurrencyData) {
                this.Currency = item as PactCurrencyData;
                this.Currency.Currency.SelectionChangedCommand.Subscribe(this, "onCurrencyChanged");
                this.Currency.ExchangeRate.LostFocusCommand.Subscribe(this, "onExchangeRateChanged");
            }
            else if (item instanceof PactComboBoxData && item.DBColumnName == "ChequeBookNo") {
                this.ChequeBook = item as PactComboBoxData;
                this.ChequeBook.SelectionChangedCommand.Subscribe(this, "OnChequeBookSelection");
            }
            else if (item instanceof PactExtraFieldDateData && item.DBColumnName.toLowerCase() == "chequematuritydate")
                item.SelectedDateChanged.Subscribe(this, "ValidateDate");
            else if (item instanceof PactExtraFieldDateData && item.DBColumnName.toLowerCase() == "duedate") {
                if (this.ScreenObject.DocumentType == 31 || this.ScreenObject.DocumentType == 32)
                    item.SelectedDateChanged.Subscribe(this, "onDateChanged");

                if (this.ScreenObject.Preferences.ContainsKey("DueDateonBillDate") && this.ScreenObject.Preferences["DueDateonBillDate"] != "") {
                    let datefield: string = this.ScreenObject.Preferences["DueDateonBillDate"];
                    for (let i = 0; i < this.ScreenObject.HeaderFields.length; i++) {
                        let oControl = this.ScreenObject.HeaderFields[i]
                        if (oControl instanceof PactExtraFieldDateData) {
                            if (oControl.DBColumnName.toLowerCase() == datefield.toLowerCase()) {
                                item.VoucherDate = oControl;
                                break;
                            }
                        }
                    }
                    for (let i = 0; i < this.ScreenObject._TextFields.length; i++) {
                        let oControl = this.ScreenObject._TextFields[i]
                        if (oControl instanceof PactExtraFieldDateData) {
                            if (oControl.DBColumnName.toLowerCase() == datefield.toLowerCase()) {
                                item.VoucherDate = oControl;
                                break;
                            }
                        }
                    }
                }
            }
            else if (item instanceof PactExtraFieldDateData && item.DBColumnName.toLowerCase() == "billdate") {
                //#region get Due date based on Bill date onselectionchange, if the DueDATEonBillDate preference set to billdate
                // Wajid:- Issue No 223807 
                if (this.ScreenObject.Preferences.ContainsKey("DueDateonBillDate") && Util.String(this.ScreenObject.Preferences["DueDateonBillDate"])) {
                    let datefield = this.ScreenObject.Preferences["DueDateonBillDate"];
                    if (!Util.IsEmpty(datefield) && datefield.toLowerCase() == "billdate") {
                        item.SelectedDateChanged.Subscribe(this, "onDateChanged");

                        for (let i = 0; i < this.ScreenObject.HeaderFields.length; i++) {
                            const oControl = this.ScreenObject.HeaderFields[i];
                            if (oControl instanceof PactExtraFieldDateData) {
                                if (oControl.DBColumnName.toLowerCase() == datefield.toLowerCase()) {
                                    item.VoucherDate = oControl;
                                    break;
                                }
                            }
                        }

                        for (let i = 0; i < this.ScreenObject._TextFields.length; i++) {
                            const oControl = this.ScreenObject._TextFields[i];
                            if (oControl instanceof PactExtraFieldDateData) {
                                if (oControl.DBColumnName.toLowerCase() == datefield.toLowerCase()) {
                                    item.VoucherDate = oControl;
                                    break;
                                }
                            }
                        }
                    }
                }
                //#endregion
            }
            else if (item instanceof PactTextBoxData && item.DBColumnName == "SKU") {
                this.SKU = item as PactTextBoxData;
                this.SKU.isSKU = true;
                item.TextChangedCommand.Subscribe(this, "onSKUKeyDown");
            }

            else if (item instanceof PactDatePickerData && item.DBColumnName.toLowerCase() == "docdate") {
                if (this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 39 || this.ScreenObject.GridDataColumns.Contains("FieldType")) {
                    if (!Util.IsEmpty(this.ScreenObject.Data.Tables[1][0]["Day"])) {
                        (item as PactVoucherDateData).DefaultValue = this.ScreenObject.Data.Tables[1][0]["Day"].toString();
                        (item as PactVoucherDateData).Date = Util.ParseDate(this.ScreenObject.Data.Tables[1][0]["Day"]);
                        (item as PactVoucherDateData).Text = Util.ParseDate(this.ScreenObject.Data.Tables[1][0]["Day"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        this.DocumentDate = Util.ParseDate(this.ScreenObject.Data.Tables[1][0]["Day"]);
                    }
                    item.IsReadOnly = true;
                }
                else if (BaseService.SessionManager.Preferences.ContainsKey("DocumentDateFromServer") && BaseService.SessionManager.Preferences["DocumentDateFromServer"].toLowerCase() == "true"
                    && this.ScreenObject.Data.Tables.length > 22 && this.ScreenObject.Data.Columns[22].Contains("ServerDate")
                    && this.ScreenObject.Data.Tables[22].length > 0 && !Util.IsEmpty(this.ScreenObject.Data.Tables[22][0]["ServerDate"])) {
                    item.DefaultValue = this.ScreenObject.Data.Tables[22][0]["ServerDate"].toString();
                    this._Ddate = Util.ParseDate(this.ScreenObject.Data.Tables[22][0]["ServerDate"]);
                }
            }

            if (item instanceof PactCodeNameListBoxData)
                item.FocusCallBack.Subscribe(this, "onPactCodeNameListBoxFocus");

            if (item instanceof PactControlData && !Util.IsEmpty(item.KeyTip))
                this.Shortcuts.push(item);
        });
        this.ScreenObject.HeaderFields.Remove(this.SKU);
        this.ScreenObject._TextFields.forEach(item => {
            if (item instanceof PactTextBoxData)
                item.LostFocusCommand.Subscribe(this, "onTextBoxLostFocus");
            else if (item instanceof PactGPSData) {
                item.LostFocusCommand.Subscribe(this, "onGPSchange");
            }
            else if (item instanceof PactComboBoxData) {
                item.LostFocusCommand.Subscribe(this, "onTextBoxLostFocus");
                item.SelectionChangedCommand.Subscribe(this, "onComboBoxSelectionChanged");

            }
            else if (item instanceof PactSelectionBoxData)
                item.LostFocusCommand.Subscribe(this, "onTextBoxLostFocus");
            else if (item instanceof PactDatePickerData || item instanceof PactExtraFieldDateData || item instanceof PactDateTimeData)
                item.SelectedDateChanged.Subscribe(this, "onDateChanged");

            if (!Util.IsEmpty(item.KeyTip))
                this.Shortcuts.push(item);

            if (this.ScreenObject.DocumentType == 30) {
                if (this.ScreenObject.Preferences.ContainsKey("AssembleType") && this.ScreenObject.Preferences["AssembleType"] == item.DBColumnID.toString()) {
                    if (item instanceof PactComboBoxData) {
                        item.SelectionChangedCommand.Subscribe(this, "onTypeChange");
                        item.Items.Clear();
                        item.Items.push(ComboBoxItems.ComboBoxItems_2("DisAssemble", "DisAssemble"));
                        item.Items.push(ComboBoxItems.ComboBoxItems_2("Assemble", "Assemble"));
                        if (item.DefaultValue == "DisAssemble")
                            item.DefaultValue = item.SelectedValue = "DisAssemble";
                        else
                            item.DefaultValue = item.SelectedValue = "Assemble";
                    }
                }
                else if (this.ScreenObject.Preferences.ContainsKey("AssembleProduct") && this.ScreenObject.Preferences["AssembleProduct"] == item.DBColumnID.toString()) {
                    if (item instanceof PactListBoxData) {
                        item.OnPactListBoxValueChanged.Subscribe(this, "OnKitProductChange");
                        item.CustomWhere = " a.ProductTypeID=9 ";
                    }
                }
            }

            if (this.ScreenObject.DocumentType == 81 || this.IsNewAssignLeave) {
                if (item.DBColumnName.toString() == "dcAlpha1") {
                    if (item instanceof PactComboBoxData) {
                        item.SelectionChangedCommand.Subscribe(this, "OnYearSelected");
                        item.Items.Clear();
                        item.Items.push(ComboBoxItems.ComboBoxItems_2("GradeWise", "GradeWise"));
                        item.Items.push(ComboBoxItems.ComboBoxItems_2("EmployeeWise", "EmployeeWise"));
                        item.SelectedValue = "GradeWise";
                    }
                }
                if (item.DBColumnName.toString() == "dcAlpha2") {
                    if (item instanceof PactComboBoxData) {
                        item.SelectionChangedCommand.Subscribe(this, "OnYearSelected");
                        for (let i = 2000; i < 2100; i++) {
                            item.Items.push(ComboBoxItems.ComboBoxItems_2(i.toString(), i.toString()));
                        }
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 61) {
                if (item.DBColumnName.toString() == "dcAlpha18") {
                    if (item instanceof PactComboBoxData) {
                        item.SelectionChangedCommand.Subscribe(this, "OnYearSelected");
                        item.Items.Clear();
                        item.Items.push(ComboBoxItems.ComboBoxItems_2("(VacDaysPerMonth * MonthDaysToConsider)/TotalMonthDays", "1"));
                        item.Items.push(ComboBoxItems.ComboBoxItems_2("(VacDaysPerYear / 365) * MonthDaysToConsider", "2"));
                        item.SelectedValue = "1";
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 85) // Bulk Appraisals
            {
                if (item.DBColumnName.toString() == "dcAlpha1" || item.DBColumnName.toString() == "dcAlpha2") {
                    (item as PactDatePickerData).CustomFormat = "MMM/yyyy";
                    (item as PactDatePickerData).Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                    if (item.DBColumnName.toString() == "dcAlpha1")
                        (item as PactDatePickerData).SelectedDateChanged.Subscribe(this, "dtpBulkApprEffectFrom_SelectedDateChanged");
                }
            }
            else if (this.ScreenObject.DocumentType == 58) // Leave Encashment
            {
                if (item.DBColumnName.toString() == "dcAlpha10") //In which Payroll Month
                {
                    (item as PactDatePickerData).CustomFormat = "MMM/yyyy";
                    (item as PactDatePickerData).Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                    (item as PactDatePickerData).SelectedDateChanged.Subscribe(this, "PayrollMonthTypeOfField_SelectedDateChanged");
                }
            }
            else if (this.ScreenObject.DocumentType == 72) // Apply Vaction
            {
                if (item.DBColumnName.toString() == "dcAlpha25") //In which Payroll Month
                {
                    (item as PactDatePickerData).CustomFormat = "MMM/yyyy";
                    (item as PactDatePickerData).Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                    (item as PactDatePickerData).SelectedDateChanged.Subscribe(this, "PayrollMonthTypeOfField_SelectedDateChanged");
                }
            }
            else if (this.ScreenObject.DocumentType == 79) // Attendance Dimension Wise
            {
                if (item.DBColumnName.toString() == "dcAlpha1") //Payroll Month
                {
                    (item as PactDatePickerData).Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                    (item as PactDatePickerData).SelectedDateChanged.Subscribe(this, "PayrollMonthTypeOfField_SelectedDateChanged");
                }
            }
        });
        this.ScreenObject._CCFields.forEach(item => {
            if (item instanceof PactHistoryData)
                item.ClickCommand.Subscribe(this, "OnHistoryButtonClick");
            if (!Util.IsEmpty(item.KeyTip))
                this.Shortcuts.push(item);
        });

        this.ScreenObject.GridDataObj.RowDeleted.Subscribe(this, "onDeleteRow");

        if (this.ScreenObject.DocumentType == 31)
            this.ImportbuttonVisible = true;

        if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 39 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 6 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 13)
            this.VoucherType = 1;
        else if (this.ScreenObject.DocumentType == 11 || this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 5 || this.ScreenObject.DocumentType == 7 || this.ScreenObject.DocumentType == 9 || this.ScreenObject.DocumentType == 24 || this.ScreenObject.DocumentType == 33 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 8 || this.ScreenObject.DocumentType == 12)
            this.VoucherType = -1;

        this.Title = this.ScreenName;


        if (this.ClassName == "POSDocumentViewModel")
            this.DocStatus = "";
        else
            this.DocStatus = "[" + BaseService.GetResource("Doc_Draft") + "]";

        this.ChangeLocation(false, this.IsEdit, BaseService.SessionManager.LocationID, srcdoc);

        this.ScreenObject.SetDefaultValuesforCostCenters(0);
        if (this.ScreenObject.Data.Tables.length > 22 && this.ScreenObject.Data.Columns[22].Contains("ServerDate")
            && this.ScreenObject.Data.Tables[22].length > 0 && !Util.IsEmpty(this.ScreenObject.Data.Tables[22][0]["ServerDate"])) {
            if (BaseService.SessionManager.IsWebApplication == true) {
                let ServerDate = Util.ParseDate(this.ScreenObject.Data.Tables[22][0]["ServerDate"]);
                this.fldDict["ServerDate"].setFieldValue(ServerDate.ToString("MMM/dd/yyyy"));
                this.FooterDics["ServerDate"].setFieldValue(ServerDate.ToString("MMM/dd/yyyy"));
            }
            else {
                this.fldDict["ServerDate"].setFieldValue(this.ScreenObject.Data.Tables[22][0]["ServerDate"].toString());
                this.FooterDics["ServerDate"].setFieldValue(this.ScreenObject.Data.Tables[22][0]["ServerDate"].toString());
            }
        }

        // AssignRowColumns();

        if (this.SKU != null) {
            if (this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 39) {
                this.SKU.Mandatory = true;
                if (this.ClassName == "POSDocumentViewModel")
                    this.SKU.Label = this.SKU.Label.replace("*", "") + " F12";
            }
            else
                this.SKU.Mandatory = false;

        }
        else {
            this.SKU = new PactTextBoxData();
            this.SKU.isSKU = true;
            this.SKU.Visible = false;
        }

        let dratt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LinkData == 55500);
        if (dratt.length > 0) {
            let attcnt: any = this.ScreenObject._TextFields.find(a => a.DBColumnID.toString() == dratt[0]["CostCenterColID"].toString());
            if (attcnt instanceof PactTextBoxData)
                attcnt.Text = "0";
        }


        if (this.ScreenObject.CustomTab.Pages.length > 0 && this.ScreenObject.FooterGridData.length > 0) {
            this.ScreenObject.GridDataObj.Height = 252;
        }
        else if (this.ScreenObject.CustomTab.Pages.length > 0)
            this.ScreenObject.GridDataObj.Height = 300;
        else
            this.ScreenObject.GridDataObj.Height = 350;

        /**if (!BaseService.SessionManager.IsWebApplication && ShellWindowViewModel.Instance().Ribbon != null && ShellWindowViewModel.Instance().Ribbon.IsMinimized)
            this.ScreenObject.GridDataObj.Height += 120;**/
        let tempint = Util.Int(this.ScreenObject.Preferences["MaxRows"]);
        if (this.ScreenObject.Preferences.ContainsKey("MaxRows") && tempint > 0) {
            if ((tempint * this.ScreenObject.GridDataObj.RowHeight) + 55 < this.ScreenObject.GridDataObj.Height)
                this.ScreenObject.GridDataObj.Height = tempint * this.ScreenObject.GridDataObj.RowHeight + 55;
            this.ScreenObject.MinRowCount = tempint;

            if (this.ScreenObject.GridData.length > tempint) {
                tempint = this.ScreenObject.GridData.length - tempint;
                for (let i = 0; i < tempint; i++) {
                    this.ScreenObject.GridDataObj.removeRowAt(0);
                }
                this.ScreenObject.UpdateSequence();
            }
            this.ScreenObject.GridDataObj.CanUserAddRows = false;
        }
        if (this.ScreenObject.Preferences.ContainsKey("BulkSaveon") && Util.Int(this.ScreenObject.Preferences["BulkSaveon"]) > 0)
            this.ScreenObject.BulkSaveon = tempint = Util.Int(this.ScreenObject.Preferences["BulkSaveon"]);
        /**SearchDocument = new DelegateCommand<string>(OnSearchDocument);**/
        if (this.IsInventoryVoucher) {
            if (this.ScreenObject.DocumentType != 33 && this.ScreenObject.DocumentType != 34) {
                this.SetVisibiltiFalse();
                if ((this.ScreenObject.Preferences.ContainsKey("PrimaryAddress") && parseBoolean(this.ScreenObject.Preferences["PrimaryAddress"])) ||
                    (this.ScreenObject.Preferences.ContainsKey("BillingAddress") && parseBoolean(this.ScreenObject.Preferences["BillingAddress"])) ||
                    (this.ScreenObject.Preferences.ContainsKey("ShippingAddress") && parseBoolean(this.ScreenObject.Preferences["ShippingAddress"]))) {
                    this.AssignAddress = new AddressViewModel(this);
                    this.AddressViewVisibility = true;
                    if (this.ScreenObject.Preferences.ContainsKey("BillingAddress") && parseBoolean(this.ScreenObject.Preferences["BillingAddress"]))
                        this.AssignAddress.BillsVisibe = parseBoolean(this.ScreenObject.Preferences["BillingAddress"]);
                    else
                        this.AssignAddress.BillsVisibe = false;

                    if (this.ScreenObject.Preferences.ContainsKey("ShippingAddress") && parseBoolean(this.ScreenObject.Preferences["ShippingAddress"]))
                        this.AssignAddress.ShipVisibe = parseBoolean(this.ScreenObject.Preferences["ShippingAddress"]);
                    else
                        this.AssignAddress.ShipVisibe = false;

                    if (this.ScreenObject.Preferences.ContainsKey("PrimaryAddress") && parseBoolean(this.ScreenObject.Preferences["PrimaryAddress"]))
                        this.AssignAddress.PrimVisibe = parseBoolean(this.ScreenObject.Preferences["PrimaryAddress"]);
                    else
                        this.AssignAddress.PrimVisibe = false;

                    dvrws = this.ScreenObject.Data.Tables[10].length > 0 ? this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -6 && (x.Mode == 1 || x.Mode == 3)) : [];
                    if (dvrws.length > 0) {
                        this.AssignAddress.PrimVisibe = parseBoolean(dvrws[0]["IsVisible"])
                        this.AssignAddress.PrimMandatory = parseBoolean(dvrws[0]["IsMandatory"])
                    }

                    dvrws = this.ScreenObject.Data.Tables[10].length > 0 ? this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -7 && (x.Mode == 1 || x.Mode == 3)) : [];
                    if (this.AssignAddress.BillsVisibe && this.AssignAddress.PrimVisibe && dvrws.length > 0) {
                        this.AssignAddress.BillsVisibe = parseBoolean(dvrws[0]["IsVisible"])
                        this.AssignAddress.BillsMandatory = parseBoolean(dvrws[0]["IsMandatory"])
                    }

                    dvrws = this.ScreenObject.Data.Tables[10].length > 0 ? this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -8 && (x.Mode == 1 || x.Mode == 3)) : [];
                    if (this.AssignAddress.ShipVisibe && dvrws.length > 0) {
                        this.AssignAddress.ShipVisibe = parseBoolean(dvrws[0]["IsVisible"])
                        this.AssignAddress.ShipMandatory = parseBoolean(dvrws[0]["IsMandatory"])
                    }
                }
            }
            else {
                this.AddressViewVisibility = false;
            }

            this.BillWisedt = [];
            this.BillWisedtColumns.push("AccountID")//, typeof(long));
            this.BillWisedtColumns.push("Amount")//, typeof(double));
            this.BillWisedtColumns.push("IsCredit")//, typeof(bool));
            this.BillWisedtColumns.push("CurrencyID")//, typeof(long));
            this.BillWisedtColumns.push("ExchangeRate")//, typeof(double));
            this.BillWisedtColumns.push("XML");
            this.BillWisedtColumns.push("FromTo");
            this.BillWisedtColumns.push("AccountName");
            this.BillWisedtColumns.push("DocXML");
            this.BillWisedtColumns.push("Decimal");
            if (this.ScreenObject.Preferences.ContainsKey("BillwisePosting") && this.ScreenObject.Preferences["BillwisePosting"] == "1")
                this.BillWisedtColumns.push("DocSeqNo");//, typeof(int));
        }
        else {
            this.AddressViewVisibility = false;
            if (this.ScreenObject.DocumentType == 16)
                this.IsImportNewRefBillwise = true;
        }

        if (this.ScreenObject.DocPrefix)
            this.ScreenObject.DocPrefix.ComboBox.SelectionChangedCommand.Subscribe(this, "OnDocPrefixChanged");

        if (this.ScreenObject.Link != null) {
            this.ScreenObject.Link.LinkCombo.SelectionChangedCommand.Subscribe(this, "OLinkSelectionChanged");
            this.ScreenObject.Link.DocumentList.CheckedChangedCommand.Subscribe(this, "OnLinkDocumentCheckedChanged");
        }

        if (this.IsInventoryVoucher) {
            if (this.ScreenObject.Data.Tables.length > 22 && this.ScreenObject.Data.Columns[22].Contains("CNT")
                && this.ScreenObject.Data.Tables[22].length > 0 && !Util.IsEmpty(this.ScreenObject.Data.Tables[22][0]["CNT"]) &&
                parseInt(this.ScreenObject.Data.Tables[22][0]["CNT"]) > 0)
                this.ButtonSuspend.Mandatory = true;
            else
                this.ButtonSuspend.Mandatory = false;
        }
        else
            this.ButtonSuspend.Mandatory = false;
        this.ButtonSuspend.Visible = false;

        //if(this.ScreenObject.GridDataColumns.g   

        //if(this.ScreenObject.Preferences.ContainsKey("Dynamic Footer") && this.ScreenObject.Preferences["Dynamic Footer"] != "" && parseBoolean(this.ScreenObject.Preferences["Dynamic Footer"]))
        //     CanUserAddRows = true;

        if ((this.ScreenObject.FooterGridData.length > 0 || (this.ScreenObject.Preferences.ContainsKey("Dynamic Footer") && this.ScreenObject.Preferences["Dynamic Footer"] != "" && parseBoolean(this.ScreenObject.Preferences["Dynamic Footer"]))) && this.ScreenObject.FooterColumnSource.length > 1
            && this.ScreenObject.FooterColumnSource[1].ComboData.length > 0)
            this.FooterVisible = true;
        else
            this.FooterVisible = false;

        let drmat = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 55847);
        if (drmat.length > 0 && BaseService.SessionManager.Preferences["BaseCurrency"] != "" && Util.Int(BaseService.SessionManager.Preferences["BaseCurrency"]) > 0) {
            let fld = this.ScreenObject._TextFields.find(a => a.DBColumnID.toString() == drmat[0]["CostcenterColid"].toString());
            if (fld && fld instanceof PactTextBoxData) {
                fld.Text = this.ScreenObject.GetExchangeRate(parseInt(BaseService.SessionManager.Preferences["BaseCurrency"]), this.DocumentDate).toString();
            }
        }
        Logger.InfoLog("AddEditDocumentViewModel::BuildControls Success");
        this.DisplayName = this.ScreenName;

        //CheckLockDate();
        if (this.ScreenObject.Preferences.ContainsKey("HideBody") && !Util.IsEmpty(this.ScreenObject.Preferences["HideBody"]) && parseBoolean(this.ScreenObject.Preferences["HideBody"].toString()))
            this.BodyVisible = false;

        //#region Reserved word - User location and division.
        // Reserved word - User location and division.
        let drrLD: any = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && (x.LinkData == 7802 || x.LinkData == 7803));
        if (drrLD.length > 0) {
            this.SetUserLocationDivsion(drrLD);
        }
        //#endregion
        Logger.InfoLog("AddEditDocumentViewModel::Exiting worker_DoWork");
    }

    OnHistoryButtonClick(lst: PactHistoryData) {
        if (lst.Dialog == null)
            lst.Dialog = new HistoryDialogViewModel(lst);
        let PreVal = 0, CurVal = 0;
        PreVal = lst.SelectedValue;
        lst.Dialog.CheckEditData();
        BaseService.page.ShowDialog(lst.Dialog, HistoryDialogComponent, { ShowCenter: true, Title: BaseService.GetResource("History") }).subscribe(sender => {
            CurVal = lst.SelectedValue;
            if (PreVal != CurVal) {
                if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == lst.DBColumnID).length > 0
                    || this.ScreenObject.DefaultBasedOn.ContainsKey(lst.CCID.toString()))
                    this.ScreenObject.GetLinkReferenceData(lst.DBColumnID, this.CostCenterID, lst.SelectedValue, this.DocumentDate, lst.DBColumnName, lst.CCID, null);
            }
        })
    }

    OnCheckedChanged(obj: any, IsChecked: boolean) {
        if (this.SelectedRow != null) {
            if (IsChecked) {
            }
            else {
                if (this.DocumentType == 94) {
                    if (!Util.IsEmpty(this.SelectedRow["ProductID_Key"])) {
                        this.SelectedRow["dcAlpha7"] = 0;
                        this.ScreenObject.GridDataObj.updateRow(this.SelectedRow);
                    }
                }
            }
        }

    }

    OnClick(event: any) {
        event.IsChecked = event.target.checked;
        if (event.IsChecked == true)
            this.IsImportonSno = true;
        else {
            this.IsImportonSno = false;
            this.ImportUpdateSnoBased = false;
        }
    }

    GetProductByExternFunc(StkCode: string, dr: any, RowPos: number) {
        let ds = this.ScreenObject.GetProductByExternFunc(StkCode, this.IsSales, this.ScreenObject.Preferences["OnScan"], dr);
        if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0 && ds.Columns[0].Contains("ProductID")) {
            for (let i = 0; i < ds.Tables[0].length; i++) {
                if (i > 0) {
                    RowPos = this.GetEmptyRowPosition(this.ScreenObject.GridDataObj, "ProductID_Key");
                    dr = this.ScreenObject.GridData[RowPos];
                }
                if (Util.IsEmpty(dr["DocSeqNo"]))
                    dr["DocSeqNo"] = RowPos + 1;

                dr["ProductID_Key"] = ds.Tables[0][i]["ProductID"].toString();
                if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                    dr["ProductCode"] = ds.Tables[0][i]["ProductCode"].toString();
                if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                    dr["ProductName"] = ds.Tables[0][i]["ProductName"].toString();
                if (this.ScreenObject.GridDataColumns.Contains("UOMID")) {
                    dr["UOM"] = ds.Tables[0][i]["UnitName"].toString();
                    dr["UOM_Key"] = ds.Tables[0][i]["UOMID"].toString();
                }
                dr["Type"] = ds.Tables[0][i]["ProductTypeID"].toString();
                dr["UOMConversion"] = ds.Tables[0][i]["Conversion"].toString();

                if (this.ScreenObject.GridDataColumns.Contains("IsWeightable") && ds.Columns[0].Contains("IsWeightable"))
                    dr["IsWeightable"] = ds.Tables[0][i]["IsWeightable"].toString();

                if (this.ScreenObject.Preferences.ContainsKey("EnableWieghingPopupOnQty") && this.ScreenObject.Preferences["EnableWieghingPopupOnQty"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableWieghingPopupOnQty"]) && dr["IsWeightable"].toString().toLowerCase() == "true") {
                    let Quantity = this.QtyReader("0");
                    if (this.IsSales == "0") {
                        dr["Quantity"] = Util.IsEmpty(Quantity) ? 0 : -parseFloat(Quantity);
                        this.RowForegroundChange(dr);
                    }
                    else
                        dr["Quantity"] = Util.IsEmpty(Quantity) ? 0 : parseFloat(Quantity);
                }
                else {
                    if (this.IsSales == "0") {
                        dr["Quantity"] = -1;
                        this.RowForegroundChange(dr);
                    }
                    else
                        dr["Quantity"] = 1;
                }

                if (!Util.IsEmpty(ds.Tables[0][i]["Conversion"]))
                    dr["UOMConvertedQty"] = parseFloat(dr["UOMConversion"]) * parseFloat(dr["Quantity"]);
                else
                    dr["UOMConvertedQty"] = "1";

                let stkcol: DgColumn = null;
                if (BaseService.SessionManager.Preferences.ContainsKey("POSItemCodeDimension") && BaseService.SessionManager.Preferences["POSItemCodeDimension"] != "" && parseInt(BaseService.SessionManager.Preferences["POSItemCodeDimension"]) > 50000) {
                    stkcol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID.toString() == BaseService.SessionManager.Preferences["POSItemCodeDimension"]);
                    if (stkcol && this.ScreenObject.GridDataColumns.Contains(stkcol.DisplayMember)) {
                        dr[stkcol.DisplayMember] = ds.Tables[0][i]["Code"].toString();
                        if (!Util.IsEmpty(stkcol.ValueMember) && this.ScreenObject.GridDataColumns.Contains(stkcol.ValueMember) && ds.Columns[0].Contains("NodeID"))
                            dr[stkcol.ValueMember] = ds.Tables[0][i]["NodeID"].toString();
                    }
                }
                if (this.SalesManDimension.Visible && this.ScreenObject.GridDataColumns.Contains("dcCCNID5") && this.SalesManDimension.SelectedValue > 0) {
                    dr["dcCCNID5"] = this.SalesManDimension.Text;
                    dr["dcCCNID5_Key"] = this.SalesManDimension.SelectedValue;
                }
                this.FillDefaultValues(dr);
                this.RepeatRowData(dr);
                this.BindDivisionorLocation(dr);

                this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 55490 }, "AvgPrice");
                this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 55491 }, "DealerPrice");
                this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 55492 }, "MRP");
                if (ds.Tables.length > 1 && ds.Tables[1].length > 0) {
                    this.FillPromotions(ds.Tables[1], RowPos);
                    RowPos += ds.Tables[1].length;
                }
                for (let j = 11; j < ds.Tables[0].Columns.length; j++) {
                    let cj = ds.Tables[0].Columns[j];
                    if (this.ScreenObject.GridDataColumns.Contains(cj) && !Util.IsEmpty(ds.Tables[0][i][cj]))
                        dr[cj] = ds.Tables[0][i][cj];
                }

                if (!Util.IsEmpty(dr["ProductID_Key"])) {
                    this.ProdID = 0;
                    this.AddProductData(dr, false, true, false, null, null, stkcol);

                    for (let j = 11; j < ds.Tables[0].Columns.length; j++) {
                        let cj = ds.Tables[0].Columns[j];
                        if (this.ScreenObject.GridDataColumns.Contains(cj) && cj.toLowerCase().Contains("dcnum") && !Util.IsEmpty(ds.Tables[0][i][cj]))
                            dr[cj] = ds.Tables[0][i][cj];
                    }
                    this.FillScan(dr, RowPos);
                }
            }
        }
        else if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0 && ds.Columns[0].Contains("ErrorMessage")) {
            this.DisplayMessage = ds.Tables[0][0]["ErrorMessage"].toString();
        }
    }

    GetProductByStockCode(StkCode: string, dr: any, RowPos: number) {
        let ds = this.ScreenObject.GetProductByStockCode(StkCode);
        if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0) {
            dr["ProductID_Key"] = ds.Tables[0][0]["ProductID"].toString();
            if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                dr["ProductCode"] = ds.Tables[0][0]["ProductCode"].toString();
            if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                dr["ProductName"] = ds.Tables[0][0]["ProductName"].toString();
            if (this.ScreenObject.GridDataColumns.Contains("UOMID")) {
                dr["UOM"] = ds.Tables[0][0]["UnitName"].toString();
                dr["UOM_Key"] = ds.Tables[0][0]["UOMID"].toString();
            }
            dr["Type"] = ds.Tables[0][0]["ProductTypeID"].toString();
            dr["UOMConversion"] = ds.Tables[0][0]["Conversion"].toString();

            if (this.ScreenObject.GridDataColumns.Contains("IsWeightable") && ds.Columns[0].Contains("IsWeightable"))
                dr["IsWeightable"] = ds.Tables[0][0]["IsWeightable"].toString();

            if (this.ScreenObject.Preferences.ContainsKey("EnableWieghingPopupOnQty") && this.ScreenObject.Preferences["EnableWieghingPopupOnQty"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableWieghingPopupOnQty"]) && dr["IsWeightable"].toString().toLowerCase() == "true") {
                let Quantity = this.QtyReader("0");
                if (this.IsSales == "0") {
                    dr["Quantity"] = Util.IsEmpty(Quantity) ? 0 : -parseFloat(Quantity);
                    this.RowForegroundChange(dr);
                }
                else
                    dr["Quantity"] = Util.IsEmpty(Quantity) ? 0 : parseFloat(Quantity);
            }
            else {
                if (this.IsSales == "0") {
                    dr["Quantity"] = -1;
                    this.RowForegroundChange(dr);
                }
                else
                    dr["Quantity"] = 1;
            }

            if (!Util.IsEmpty(ds.Tables[0][0]["Conversion"]))
                dr["UOMConvertedQty"] = parseFloat(dr["UOMConversion"]) * parseFloat(dr["Quantity"]);
            else
                dr["UOMConvertedQty"] = "1";

            if (BaseService.SessionManager.Preferences.ContainsKey("POSItemCodeDimension")) {
                let stkcol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID.toString() == BaseService.SessionManager.Preferences["POSItemCodeDimension"]);
                if (stkcol && this.ScreenObject.GridDataColumns.Contains(stkcol.DisplayMember)) {
                    dr[stkcol.DisplayMember] = ds.Tables[0][0]["Code"].toString();
                    if (!Util.IsEmpty(stkcol.ValueMember) && this.ScreenObject.GridDataColumns.Contains(stkcol.ValueMember) && ds.Columns[0].Contains("NodeID"))
                        dr[stkcol.ValueMember] = ds.Tables[0][0]["NodeID"].toString();
                }
            }
            if (this.SalesManDimension.Visible && this.ScreenObject.GridDataColumns.Contains("dcCCNID5") && this.SalesManDimension.SelectedValue > 0) {
                dr["dcCCNID5"] = this.SalesManDimension.Text;
                dr["dcCCNID5_Key"] = this.SalesManDimension.SelectedValue;
            }
            this.FillDefaultValues(dr);
            this.RepeatRowData(dr);
            this.BindDivisionorLocation(dr);

            this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 55490 }, "AvgPrice");
            this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 55491 }, "DealerPrice");
            this.FillDatarow(dr, ds.Tables[0], null, { LocalReference: 79, LinkData: 55492 }, "MRP");
            if (ds.Tables.length > 1 && ds.Tables[1].length > 0) {
                this.FillPromotions(ds.Tables[1], RowPos);
                RowPos += ds.Tables[1].length;
            }
        }
        this.ScreenObject.UpdateSequence();
    }

    public onSKUKeyDown(txtObj: any, sender: any) {
        if (BaseService.IsNativeMobile && this.SKU.Text != '') {
            if (this.IsInventoryVoucher)
                this.onSKUSearch(this.SKU.Text);
            else
                this.SearchInvoice(this.SKU.Text);
        }
        else if (this.SKU != null && sender.keyCode == "13")//Enter
        {
            if (this.IsInventoryVoucher)
                this.onSKUSearch(this.SKU.Text);
            else
                this.SearchInvoice(this.SKU.Text);
        }
        else if (this.SKU != null && sender.key == "F5") {
            event.preventDefault();
            BaseService.page.ShowDialog(new FieldCalculatorViewModel(this, 7), FieldCalculatorComponent, { ShowCenter: true });
        }
    }

    public SearchInvoice(text: string) {
        let IsCredit = false;
        let colName = '';
        if ((this.DocumentType == 18 || this.DocumentType == 19 || this.DocumentType == 21 || this.DocumentType == 22)
            && this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")) {
            colName = "CreditAccount_Key";
            IsCredit = true;
        }
        else if ((this.DocumentType == 14 || this.DocumentType == 15 || this.DocumentType == 20 || this.DocumentType == 23)
            && this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key"))
            colName = "DebitAccount_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key"))
            colName = "AccountID_Key";

        if (colName != '') {
            let RowPos = this.GetEmptyRowPosition(this.ScreenObject.GridDataObj, colName);
            let dr = this.ScreenObject.GridData[RowPos];
            let dsdet: any = this.ScreenObject.GetDetailsByDocno(text);
            if (dsdet != null && dsdet.Tables.length > 0 && dsdet.Columns[0].Contains("Account1")
                && dsdet.Tables[0].length > 0) {
                dr[colName] = dsdet.Tables[0][0]["Account1"].toString();
                if (this.ScreenObject.GridDataColumns.Contains("AccountName"))
                    dr["AccountName"] = dsdet.Tables[0][0]["AccountName"].toString();
                if (this.ScreenObject.GridDataColumns.Contains("AccountCode"))
                    dr["AccountCode"] = dsdet.Tables[0][0]["AccountCode"].toString();


                dr["Type"] = parseBoolean(dsdet.Tables[0][0]["IsBillwise"].toString());
                if (parseBoolean(dsdet.Tables[0][0]["IsBillwise"].toString())) {
                    let CurrID = 1; let ExhgRate = 1;
                    if (this.Currency != null && this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue != "")
                        CurrID = parseInt(this.Currency.Currency.SelectedValue);
                    if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                        ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
                    this.Setselectedrow(RowPos);
                    this.CheckIsBillWise(parseInt(dr[colName]), dr, colName, 0, IsCredit, CurrID, ExhgRate, dsdet.Tables[0][0]["VoucherNo"].toString());
                }
                this.SKU.Text = '';
            }
        }
    }


    CheckandAddBatch(drrows: any, dr: any)//ref DataRow dr)
    {
        let div = 0, loc = 0;
        if (this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])) {
            let ccfld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
            if (ccfld != null && ccfld != undefined && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0)
                loc = ccfld.SelectedValue;
            else if (dr != null && this.ScreenObject.GridDataColumns.Contains("dcCCNID2_Key") && !Util.IsEmpty(dr["dcCCNID2_Key"]))
                loc = parseInt(dr["dcCCNID2_Key"].toString());
        }
        else if (this.ScreenObject.LocationID > 0)
            loc = this.ScreenObject.LocationID;
        else
            loc = BaseService.SessionManager.LocationID;
        if (this.ScreenObject.DivisionID > 0)
            div = this.ScreenObject.DivisionID;
        else
            div = BaseService.SessionManager.DivisionID;
        let qt = 0, UomConv = 1;
        if (!Util.IsEmpty(dr["Quantity"]) && parseFloat(dr["Quantity"].toString()) > 0)
            qt = parseFloat(dr["Quantity"].toString());
        else if (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(dr["FreeQTY"]) && parseFloat(dr["FreeQTY"].toString()) > 0)
            qt = parseFloat(dr["FreeQTY"].toString());
        if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && !Util.IsEmpty(dr["UOMConversion"]))
            UomConv = parseFloat(dr["UOMConversion"].toString());
        qt = qt * UomConv;
        let Ds: any = this.ScreenObject.GetProductwiseBatches(parseInt(dr["ProductID_Key"].toString()), 0, this.VoucherType, dr, 0, false);


        let batchID = 0;
        let batrows: any[] = null;
        if (this.barcodeValues.ContainsKey("Batch_Code"))
            batrows = Ds.Tables[0].filter(x => x.BatchCode == this.barcodeValues["Batch_Code"]);
        else if (this.barcodeValues.ContainsKey("Batch_No"))
            batrows = Ds.Tables[0].filter(x => x.BATCHNUMBER == this.barcodeValues["Batch_No"]);

        if (batrows != null && batrows.length == 0) {
            if (this.ScreenObject.Preferences.ContainsKey("OnBatchScan") && (this.ScreenObject.Preferences["OnBatchScan"] == "1" || this.ScreenObject.Preferences["OnBatchScan"] == "2")) {
                if (this.ScreenObject.Preferences["OnBatchScan"] == "1") {
                    if (confirm("Batch not exits.Do you want to create?"))
                        return;

                }
                let templong = 0;
                let Exists = false;
                let CustomCostCenterFieldsQuery = '';
                if (BaseService.SessionManager.Preferences.ContainsKey("Maintain Dimensionwise Batches") && !Util.IsEmpty(BaseService.SessionManager.Preferences["Maintain Dimensionwise Batches"])) {
                    templong = Util.Int(BaseService.SessionManager.Preferences["Maintain Dimensionwise Batches"].toString());
                    if (templong > 0) {
                        for (let i = 0; i < this.ScreenObject._CCFields.length; i++) {
                            const item = this.ScreenObject._CCFields[i];
                            if (item instanceof PactListBoxData && item.CCID == templong) {
                                CustomCostCenterFieldsQuery = "CCNID" + (templong - 50000) + "='" + item.SelectedValue + "',";
                                Exists = true;
                                break;
                            }
                        }

                        if (!Exists) {
                            if (dr != null && templong > 50000 && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (templong - 50000).toString() + "_Key") && !Util.IsEmpty(dr["dcCCNID" + (templong - 50000).toString() + "_Key"]))
                                CustomCostCenterFieldsQuery = CustomCostCenterFieldsQuery + "CCNID" + (templong - 50000) + "='" + dr["dcCCNID" + (templong - 50000).toString() + "_Key"].toString() + "',";
                        }
                    }
                }

                if (this.ScreenObject.Preferences.ContainsKey("BatchFilterDim")) {
                    templong = 0;
                    Exists = false;
                    templong = Util.Int(this.ScreenObject.Preferences["BatchFilterDim"].toString());
                    if (templong > 0) {
                        if (!CustomCostCenterFieldsQuery.Contains("CCNID" + (templong - 50000) + "=")) {
                            for (let i = 0; i < this.ScreenObject._CCFields.length; i++) {
                                const item = this.ScreenObject._CCFields[i];
                                if (item instanceof PactListBoxData && item.CCID == templong) {
                                    if (item.SelectedValue > 0)
                                        CustomCostCenterFieldsQuery = CustomCostCenterFieldsQuery + "CCNID" + (templong - 50000) + "='" + item.SelectedValue + "',";
                                    Exists = true;
                                    break;
                                }
                            }
                            if (!Exists) {
                                if (templong > 50000 && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (templong - 50000).toString() + "_Key")) {
                                    Exists = true;
                                    if (!Util.IsEmpty(dr["dcCCNID" + (templong - 50000).toString() + "_Key"]))
                                        CustomCostCenterFieldsQuery = CustomCostCenterFieldsQuery + "CCNID" + (templong - 50000) + "='" + dr["dcCCNID" + (templong - 50000).toString() + "_Key"].toString() + "',";
                                }
                            }
                        }
                    }
                }
                let mfg: any, exp: any;

                if (!(this.barcodeValues.ContainsKey("Batch_MfgDate") && Util.isValidDate(this.barcodeValues["Batch_MfgDate"])))
                    mfg = new Date().OnlyDate();

                if (!(this.barcodeValues.ContainsKey("Batch_ExpDate") && Util.isValidDate(this.barcodeValues["Batch_ExpDate"])))
                    exp = new Date().OnlyDate().AddYears(1);

                batchID = this.ScreenObject.SaveBatch(this.barcodeValues["Batch_No"], mfg, exp, null, 0, 0, 0, dr["ProductID_Key"].toString(), '', CustomCostCenterFieldsQuery);
                if (batchID < 1)
                    return;
            }
            else
                return;
        }
        else if (batrows != null)
            batchID = parseInt(batrows[0]["BatchID"].toString());

        if (drrows.length > 1 && this.ScreenObject.Preferences.ContainsKey("DuplicateProduct_IncrementQuantity") && !Util.IsEmpty(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"]) && parseBoolean(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"])) {
            for (let i = 0; i < drrows.length; i++) {
                const item = drrows[i];
                if (!Util.IsEmpty(item["ExtraXML"]) && item != dr) {
                    let xDoc: any = new XmlDocument();
                    xDoc.LoadXml(item["ExtraXML"].toString());

                    let xList: any = xDoc.SelectNodes("xml/Row");

                    if (xList.length > 0 && xList[0].attributes["BatchID"].value != null && xList[0].attributes["BatchID"].value == batchID.toString()) {
                        let qty = 1;
                        if (!Util.IsEmpty(dr["Quantity"]))
                            qty = parseFloat(dr["Quantity"].toString());
                        this.ClearDatarow(dr, true);

                        dr = item;
                        if (!Util.IsEmpty(dr["Quantity"]))
                            dr["Quantity"] = parseFloat(dr["Quantity"].toString()) + qty;

                        xList[0].attributes["Quantity"].value = dr["Quantity"].toString();
                        if (xList[0].attributes["Release"] != null)
                            xList[0].attributes["Release"].value = dr["Quantity"].toString();

                        dr["ExtraXML"] = xDoc.InnerXml;
                        return;
                    }
                }
            }
        }

        let sb = '';
        sb += "<xml><Row ProductID=\"" + dr["ProductID_Key"].toString() + "\" ";
        sb += " BatchID" + "=\"" + batchID + "\" ";
        sb += " Quantity" + "=\"" + dr["Quantity"].toString() + "\" ";
        sb += " Hold" + "=\"0\" ";
        sb += " Release" + "=\"" + dr["Quantity"].toString() + "\" ></Row></xml>";
        dr["ExtraXML"] = sb.toString();
    }

    onSKUSearch(text: string, Drow: any = null) {
        if (this.ScreenObject.Preferences.ContainsKey("MandatorySalesMan") && this.ScreenObject.Preferences["MandatorySalesMan"] == "True"
            && this.SalesManDimension != null && this.SalesManDimension.Visible && this.SalesManDimension.SelectedValue < 1) {
            this.DisplayMessage = BaseService.GetResource("Select") + " " + this.SalesManDimension.Label;
            return;
        }

        let RowPos = this.GetEmptyRowPosition(this.ScreenObject.GridDataObj, "ProductID_Key");
        let dr = this.ScreenObject.GridData[RowPos];

        if (Drow != null)
            dr = Drow;

        if (this.ScreenObject.Preferences.ContainsKey("OnScan") && this.ScreenObject.Preferences["OnScan"].toLowerCase() != "") {
            this.GetProductByExternFunc(this.SKU.Text, dr, RowPos);
        }
        else if (this.ScreenObject.Preferences.ContainsKey("PickStockRate") && this.ScreenObject.Preferences["PickStockRate"].toLowerCase() == "true") {
            this.GetProductByStockCode(this.SKU.Text, dr, RowPos);
            if (!Util.IsEmpty(dr["ProductID_Key"]))
                this.FillScan(dr, RowPos);
        }
        else {
            let prID = 0;
            let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != null && a.DisplayMember == "ProductCode");
            if (col && col.UseBarcode) {
                let outPID = { PID: 0 };
                if (this.ReadBarcode(col.BarcodeDef, col.BarcodeProp, null, dr, this.SKU.Text, outPID)) {
                    prID = outPID.PID;
                    let Scqty = 1;
                    let drrows: any;
                    if (this.DocumentType == 31 && this.ScreenObject.GridDataColumns.Contains("BOEID") && this.barcodeValues.ContainsKey("INVID"))
                        drrows = this.ScreenObject.GridData.filter(x => x.BOEID == this.barcodeValues["INVID"]);
                    else {
                        if (this.ScreenObject.GridDataColumns.Contains("IsFullBatchScanned"))
                            drrows = this.ScreenObject.GridData.filter(x => parseInt(x.ProductID_Key) == prID && (x.IsFullBatchScanned == null || x.IsFullBatchScanned != '1'));
                        else if (this.barcodeValues.ContainsKey("Unit_Key"))
                            drrows = this.ScreenObject.GridData.filter(x => x.ProductID_Key == prID && x.Unit_Key == this.barcodeValues["Unit_Key"]);
                        else
                            drrows = this.ScreenObject.GridData.filter(x => parseInt(x.ProductID_Key) == prID);
                        //drrows = drrows.sort((a,b) => parseInt(b.DocSeqNo)-parseInt(a.DocSeqNo)); /// commented line because duplicate product quatity not adding while scaning product in document.

                        if (this.ScreenObject.Preferences.ContainsKey("ClubProdBasedon") && !Util.IsEmpty(this.ScreenObject.Preferences["ClubProdBasedon"])) {
                            let StrDocs = this.ScreenObject.Preferences["ClubProdBasedon"].split(',');

                            // foreach (var item in StrDocs)
                            // {
                            //     if (this.ScreenObject.GridData.Columns.Contains(item))
                            //     {
                            //         if (barcodeValues.ContainsKey(item) && barcodeValues[item] != "")
                            //             wherefilter += " and " + item + "='" + barcodeValues[item].Replace("'", "''") + "'";
                            //         else if (dr[item].toString() != "")
                            //             wherefilter += " and " + item + "='" + dr[item].toString().Replace("'", "''") + "'";
                            //         else
                            //             wherefilter += " and " + item + "='0'";
                            //     }
                            // }
                            for (let b = 0; b < StrDocs.length; b++) {
                                const item = StrDocs[b];
                                if (this.ScreenObject.GridDataColumns.Contains(item)) {
                                    if (this.barcodeValues.ContainsKey(item) && !Util.IsEmpty(this.barcodeValues[item]))
                                        drrows = drrows.filter(x => x[item] == this.barcodeValues[item].toString().Replace("'", "''"))
                                    else if (!Util.IsEmpty(dr[item]))
                                        drrows = drrows.filter(x => x[item] == dr[item].toString().Replace("'", "''"))
                                    else
                                        drrows = drrows.filter(x => x[item] == '0')
                                }
                            }

                        }

                    }

                    //Reserved Word - Scanned Barcode
                    let drScan = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 7801);
                    if (drScan.length > 0 && this.ScreenObject.GridDataColumns.Contains(Util.String(drScan[0]["SysColumnName"])))
                        dr[Util.String(drScan[0]["SysColumnName"])] = text;

                    if (drrows.length > 0 && drrows[0] != dr && !(this.VoucherType == 1 && (this.barcodeValues.ContainsKey("Batch_Code") || this.barcodeValues.ContainsKey("Batch_No")))
                        && (this.DocumentType == 31 || (this.ScreenObject.Preferences.ContainsKey("DuplicateProduct_IncrementQuantity") && Util.String(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"]) != "" && Util.String(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"]) == "True"))) {
                        if (!Util.IsEmpty(dr["Quantity"]))
                            Scqty = parseFloat(dr["Quantity"]);
                        this.ClearDatarow(dr, true);
                        dr = drrows[0];
                        if (!Util.IsEmpty(dr["Quantity"]))
                            dr["Quantity"] = parseFloat(dr["Quantity"]) + Scqty;

                        if (this.barcodeValues.ContainsKey("INVID") && this.ScreenObject.GridDataColumns.Contains("DocExtraXML")) {
                            dr["DocExtraXML"] = "<DocExtraXML><Row RefID=\"" + this.barcodeValues["INVID"] + "\" Qty=\"" + dr["Quantity"].toString() + "\" Type=\"1\" ></Row></DocExtraXML>";
                            dr["BOEID"] = this.barcodeValues["INVID"].toString();
                            if (this.DocumentType != 31) {
                                let dsbins = this.ScreenObject.GetinvBinDetails(this.barcodeValues["INVID"].toString(), prID.toString(), "");
                                if (dsbins != null && dsbins.Tables.length > 0 && dsbins.Tables[0].length > 0)
                                    this.AddBins(dr, false, false, dsbins.Tables[0]);
                            }
                        }
                    }
                    else {
                        dr["ProductID_Key"] = prID;

                        if (this.IsSales == "0") {
                            dr["Quantity"] = -Scqty;
                            this.RowForegroundChange(dr);
                        }
                        else
                            dr["Quantity"] = Scqty;
                        this.ProdID = 0;
                        this.AddProductData(dr, false, false, false, null, null);

                        if (this.ScreenObject.Preferences.ContainsKey("PickQtyNumpad") && this.ScreenObject.Preferences["PickQtyNumpad"] != "" && parseBoolean(this.ScreenObject.Preferences["PickQtyNumpad"])) {
                            if (this.ClassName == "POSDocumentViewModel") {
                                Scqty = 1;
                                if (!Util.IsEmpty(this.NumPadText)) {
                                    Scqty = parseFloat(this.NumPadText)
                                }
                                else
                                    this.NumPadText = "";
                            }
                            else if (this.NumericPADView != null) {
                                Scqty = 1;
                                if (!Util.IsEmpty(this.NumericPADView.txt.Text)) {
                                    Scqty = parseFloat(this.NumericPADView.txt.Text)
                                }
                            }
                            if (this.IsSales == "0") {
                                dr["Quantity"] = -Scqty;
                                this.RowForegroundChange(dr);
                            }
                            else
                                dr["Quantity"] = Scqty;
                        }

                        if (this.barcodeValues != null && this.barcodeValues.length > 0) {
                            for (let k = 0; k < this.barcodeValues.keys.length; k++) {
                                let item = { Key: this.barcodeValues.keys[k], Value: this.barcodeValues.values[k] }
                                if (this.ScreenObject.GridDataColumns.Contains(item.Key)) {
                                    if (item.Key != "Unit" && this.ScreenObject.GridDataColumns.Contains(item.Key + "_Key")) {
                                        let tempcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == item.Key.toLowerCase());
                                        if (tempcol && tempcol.CostCenterID > 0 && tempcol.CostCenterID != 11) {
                                            let tempds: any = this.ScreenObject.GetCCListViewDataID(tempcol.CostCenterID, tempcol.TypeID, item.Value.toString());
                                            {
                                                if (tempds != null && tempds.Tables.length > 0 && tempds.Tables[0].length > 0
                                                    && tempds.Columns[0].Contains("NodeID") && !Util.IsEmpty(tempds.Tables[0][0]["NodeID"])) {
                                                    dr[item.Key + "_Key"] = tempds.Tables[0][0]["NodeID"].toString();
                                                    dr[item.Key] = item.Value;
                                                    if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == tempcol.ID).length > 0) {
                                                        this.ScreenObject.GetLinkReferenceData(parseInt(tempcol.ID), this.DocumentID, parseInt(dr[tempcol.ValueMember]), Date.Today(), "", tempcol.CostCenterID, dr);
                                                    }
                                                }
                                            }
                                        }
                                        else if (tempcol.DataType == "DATE" || tempcol.DataType == "DATETIME") {
                                            if (Util.isValidDate(item.Value)) {
                                                let tempdt = Util.ParseDate(item.Value);
                                                dr[item.Key + "_Key"] = tempdt;
                                                if (tempcol.DataType == "DATE")
                                                    dr[item.Key] = tempdt.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                else
                                                    dr[item.Key] = tempdt.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                                            }
                                        }
                                    }
                                    else
                                        dr[item.Key] = item.Value;
                                }
                                else if (this.barcodeValues.ContainsKey("INVID")) {
                                    if (this.ScreenObject.GridDataColumns.Contains("DocExtraXML")) {
                                        if (this.barcodeValues.ContainsKey("Quantity"))
                                            dr["Quantity"] = this.barcodeValues["Quantity"];
                                        dr["DocExtraXML"] = "<DocExtraXML><Row RefID=\"" + this.barcodeValues["INVID"] + "\" Qty=\"" + dr["Quantity"].toString() + "\" Type=\"1\" ></Row></DocExtraXML>";
                                        dr["BOEID"] = this.barcodeValues["INVID"].toString();
                                        if (this.DocumentType != 31) {
                                            let dsbins = this.ScreenObject.GetinvBinDetails(this.barcodeValues["INVID"].toString(), dr["ProductID_Key"].toString(), "");
                                            if (dsbins != null && dsbins.Tables.length > 0 && dsbins.Tables[0].length > 0)
                                                this.AddBins(dr, false, false, dsbins.Tables[0]);
                                        }
                                    }
                                }
                                else {
                                    let tempcol = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.ValueMember) && a.ValueMember.toLowerCase() == item.Key.toLowerCase() + "_key");
                                    if (tempcol && tempcol.CostCenterID > 0) {
                                        let tempds: any = this.ScreenObject.GetCCListViewDataID(tempcol.CostCenterID, tempcol.TypeID, item.Value.toString())
                                        {
                                            if (tempds != null && tempds.Tables.length > 0 && tempds.Tables[0].length > 0
                                                && tempds.Columns[0].Contains("NodeID") && !Util.IsEmpty(tempds.Tables[0][0]["NodeID"])) {
                                                dr[tempcol.ValueMember] = tempds.Tables[0][0]["NodeID"].toString();
                                                dr[tempcol.DisplayMember] = item.Value;
                                                if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == tempcol.ID).length > 0) {
                                                    this.ScreenObject.GetLinkReferenceData(parseInt(tempcol.ID), this.DocumentID, parseInt(dr[tempcol.ValueMember]), Date.Today(), "", tempcol.CostCenterID, dr);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    if (Util.String(dr["Type"]) == "5" && (this.barcodeValues.ContainsKey("Batch_Code") || this.barcodeValues.ContainsKey("Batch_No"))) {
                        if (this.VoucherType == -1) {
                            let div = 0, loc = 0;
                            if (this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])) {
                                var ccfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
                                if (ccfld != null && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0)
                                    loc = ccfld.SelectedValue;
                                else if (dr != null && this.ScreenObject.GridDataColumns.Contains("dcCCNID2_Key") && !Util.IsEmpty(dr["dcCCNID2_Key"]))
                                    loc = parseInt(dr["dcCCNID2_Key"].toString());
                            }
                            else if (this.ScreenObject.LocationID > 0)
                                loc = this.ScreenObject.LocationID;
                            else
                                loc = BaseService.SessionManager.LocationID;
                            if (this.ScreenObject.DivisionID > 0)
                                div = this.ScreenObject.DivisionID;
                            else
                                div = BaseService.SessionManager.DivisionID;
                            let qt = 0, UomConv = 1;
                            if (Util.Double(dr["Quantity"]) > 0)
                                qt = parseFloat(dr["Quantity"].toString());
                            else if (Util.Double(dr["FreeQTY"]) > 0)
                                qt = parseFloat(dr["FreeQTY"].toString());
                            if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && !Util.IsEmpty(dr["UOMConversion"]))
                                UomConv = parseFloat(dr["UOMConversion"].toString());
                            qt = qt * UomConv;
                            let objbat = new BatchNumberViewModel(this.ScreenObject.GridDataObj);
                            objbat.BatchNumberViewModel_3(this, this.VoucherType, qt, parseInt(dr["ProductID_Key"]), dr["ProductName"].toString(), loc, div, dr)
                            {

                                if (drrows.length > 2 && this.ScreenObject.Preferences.ContainsKey("DuplicateProduct_IncrementQuantity") && !Util.IsEmpty(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"]) && parseBoolean(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"])) {
                                    let batrows: any[] = null;
                                    if (this.barcodeValues.ContainsKey("Batch_Code"))
                                        batrows = objbat.GridData.filter(x => x.BatchCode == this.barcodeValues["Batch_Code"]);
                                    else if (this.barcodeValues.ContainsKey("Batch_No"))
                                        batrows = objbat.GridData.filter(x => x.BATCHNUMBER == this.barcodeValues["Batch_No"]);
                                    if (batrows != null && batrows.length > 0) {
                                        let xDoc: XmlDocument;
                                        for (let m = 0; m < drrows.length; m++) {
                                            let item = drrows[m]
                                            if (!Util.IsEmpty(item["ExtraXML"])) {
                                                xDoc = new XmlDocument();
                                                xDoc.LoadXml(item["ExtraXML"].toString());
                                                let xList = xDoc.SelectNodes("xml/Row");
                                                if (xList.length > 0 && xList[0].attributes["BatchID"].value != null && xList[0].attributes["BatchID"].value == batrows[0]["BatchID"].toString()) {
                                                    if (xList[0].attributes["RefInvID"] != null && xList[0].attributes["RefInvID"].value != batrows[0]["RefInvID"].toString())
                                                        continue;

                                                    if (item != dr) {
                                                        if (!Util.IsEmpty(batrows[0]["BalQty"]) && !Util.IsEmpty(item["Quantity"])) {
                                                            if (objbat.GridDataColumns.Contains("QtyUom"))
                                                                batrows[0]["BalQty"] = parseFloat(batrows[0]["BalQty"]) + (parseFloat(item["Quantity"]) * UomConv);
                                                            else
                                                                batrows[0]["BalQty"] = parseFloat(batrows[0]["BalQty"]) + parseFloat(item["Quantity"]);
                                                        }
                                                        if (!Util.IsEmpty(dr["ExtraXML"])) {
                                                            xDoc = new XmlDocument();
                                                            xDoc.LoadXml(dr["ExtraXML"].toString());
                                                            xList = xDoc.SelectNodes("xml/Row");
                                                            if (xList.length > 0 && xList[0].attributes["BatchID"].value != null) {
                                                                batrows = objbat.GridData.filter(x => x.BatchID == xList[0].attributes["BatchID"].value);
                                                                if (batrows.length > 0) {
                                                                    batrows[0]["Quantity"] = null;
                                                                    if (objbat.GridDataColumns.Contains("QtyUom"))
                                                                        batrows[0]["QtyUom"] = null;
                                                                }
                                                            }
                                                        }
                                                        dr["Quantity"] = parseFloat(dr["Quantity"]) - Scqty;
                                                        item["Quantity"] = parseFloat(item["Quantity"]) + Scqty;
                                                        if (UomConv > 1) {
                                                            dr["UOMConvertedQty"] = parseFloat(dr["Quantity"]) * UomConv;
                                                            item["UOMConvertedQty"] = parseFloat(item["Quantity"]) * UomConv;
                                                        }

                                                        dr = item;

                                                        objbat.BatchQty = parseFloat(dr["Quantity"]) * UomConv;
                                                        objbat.drSel = dr;
                                                        break;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                for (let k = 0; k < objbat.GridData.length; k++) {
                                    if (this.barcodeValues.ContainsKey("Batch_Code") && Util.StringValue(objbat.GridData[k]["BatchCode"]).toString().toLowerCase() == this.barcodeValues["Batch_Code"].toString().toLowerCase()) {
                                        if (!Util.IsEmpty(objbat.GridData[k]["BalQty"]) && !Util.IsEmpty(objbat.GridData[k]["Quantity"])
                                            && parseFloat(objbat.GridData[k]["BalQty"].toString()) <= parseFloat(objbat.GridData[k]["Quantity"].toString()))
                                            continue;
                                        if (Util.String(objbat.GridData[k]["BalQty"]) == "" || parseFloat(objbat.GridData[k]["BalQty"].toString()) == 0)
                                            continue;
                                        objbat.GridData[k]["Quantity"] = null;
                                        objbat.SelectQty(objbat.GridData[k]);
                                        break;
                                    }
                                    else if (this.barcodeValues.ContainsKey("Batch_No") && Util.StringValue(objbat.GridData[k]["BATCHNUMBER"]).toString().toLowerCase() == this.barcodeValues["Batch_No"].toString().toLowerCase()) {
                                        if (!Util.IsEmpty(objbat.GridData[k]["BalQty"]) && !Util.IsEmpty(objbat.GridData[k]["Quantity"])
                                            && parseFloat(objbat.GridData[k]["BalQty"].toString()) <= parseFloat(objbat.GridData[k]["Quantity"].toString()))
                                            continue;
                                        if (Util.String(objbat.GridData[k]["BalQty"]) == "" || parseFloat(Util.String(objbat.GridData[k]["BalQty"])) == 0)
                                            continue;
                                        objbat.GridData[k]["Quantity"] = null;
                                        objbat.SelectQty(objbat.GridData[k]);
                                        break;
                                    }
                                }
                                objbat.DisplayMessage = '';
                                objbat.OnSave("AutoSaveScan");
                                if (objbat.DisplayMessage != '')
                                    BaseService.page.ShowDialog(objbat, BatchNumberComponent);
                            }
                        }
                        else
                            this.CheckandAddBatch(drrows, dr);//ref dr);
                    }
                    if (this.barcodeValues != null && this.barcodeValues.length > 0 && this.barcodeValues.ContainsKey("FreeQTY")) {
                        let dFreeQty = 0;
                        dFreeQty = parseFloat(this.barcodeValues["FreeQTY"]);
                        if (dFreeQty > 0) {
                            dr["Quantity"] = "0";
                            dr["FreeQTY"] = dFreeQty;
                        }
                    }

                    if (this.barcodeValues != null)
                        this.barcodeValues.Clear();
                }
                else if (this.ScreenObject.Preferences.ContainsKey("usetempifnotscanned") && parseBoolean(this.ScreenObject.Preferences["usetempifnotscanned"])) {
                    if (this.DocumentType == 31 && this.ScreenObject.GridDataColumns.Contains("BOEID") && !this.barcodeValues.ContainsKey("INVID")) {
                        Util.PlaySound("beep-01.wav");
                        return;
                    }
                    if (this.ScreenObject.TempProductID > 0) {
                        prID = this.ScreenObject.TempProductID;
                        let drrows;

                        if (this.DocumentType == 31 && this.ScreenObject.GridDataColumns.Contains("BOEID") && this.barcodeValues.ContainsKey("INVID"))
                            drrows = this.ScreenObject.GridData.filter(x => x.BOEID == this.barcodeValues["INVID"]);
                        else
                            drrows = this.ScreenObject.GridData.filter(x => x.ProductID_Key == prID);
                        if (drrows.length > 0 && drrows[0] != dr
                            && (this.DocumentType == 31 || (this.ScreenObject.Preferences.ContainsKey("DuplicateProduct_IncrementQuantity") && Util.String(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"]) != "" && Util.String(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"]) == "True"))) {
                            let qty = 1;
                            if (!Util.IsEmpty(dr["Quantity"]))
                                qty = parseFloat(dr["Quantity"]);
                            this.ClearDatarow(dr, true);
                            dr = drrows[0];
                            if (!Util.IsEmpty(dr["Quantity"]))
                                dr["Quantity"] = parseFloat(dr["Quantity"]) + qty;
                        }
                        else {
                            dr["ProductID_Key"] = prID;
                            if (this.IsSales == "0") {
                                dr["Quantity"] = -1;
                                this.RowForegroundChange(dr);
                            }
                            else
                                dr["Quantity"] = 1;
                            this.ProdID = 0;
                            this.AddProductData(dr, false, false, false, null, null);
                        }
                        if (this.barcodeValues.ContainsKey("INVID")) {
                            if (this.ScreenObject.GridDataColumns.Contains("DocExtraXML")) {
                                dr["DocExtraXML"] = "<DocExtraXML><Row RefID=\"" + this.barcodeValues["INVID"] + "\" Qty=\"" + dr["Quantity"].toString() + "\" Type=\"1\" ></Row></DocExtraXML>";
                                dr["BOEID"] = this.barcodeValues["INVID"].toString();
                                if (this.DocumentType != 31) {
                                    let dsbins = this.ScreenObject.GetinvBinDetails(this.barcodeValues["INVID"].toString(), dr["ProductID_Key"].toString(), "");
                                    if (dsbins != null && dsbins.Tables.length > 0 && dsbins.Tables[0].length > 0)
                                        this.AddBins(dr, false, false, dsbins.Tables[0]);
                                }
                            }
                        }
                    }
                    else {
                        Util.PlaySound("beep-01.wav");
                        this.DisplayMessage = "Define Temp product";
                        return;
                    }
                }
            }

            if (prID == 0 && (this.DocumentType == 38 || this.DocumentType == 39)) {
                let dtPrdCheck = BaseService.common.GetDataTable("DOC065", this.SKU.Text);
                if (dtPrdCheck != null && dtPrdCheck.length > 0) {
                    if (Util.String(dtPrdCheck[0]["StatusID"]) == "32") {
                        this.DisplayMessage = "Cannot scan the Inactive item";
                        this.MessageVisibility = true;
                        return;
                    }
                    else {
                        this.DisplayMessage = "";
                        this.MessageVisibility = false;
                        this.AddProductData(dr, false, false, false, null, this.SKU.Text);//text);
                    }
                }
                else {
                    this.DisplayMessage = "Item not found";
                    this.MessageVisibility = true;
                    return;
                }
            }
            if (!Util.IsEmpty(dr["ProductID_Key"])) {
                this.FillScan(dr, RowPos);
                Util.PlaySound("beep-02.wav");
            }
        }

        if (!Util.IsEmpty(dr["ProductID_Key"])) {
            let col = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.ValueMember) && a.ValueMember.toLowerCase() == "productid_key" && !Util.IsEmpty(a.Shortcut) && a.Shortcut.toLowerCase() == "lostfocus");
            if (col && this.ValidateData_Column(col, dr, true))
                this.ScreenObject.GetExternalFuncData(col.Mode, col.SPName, col.IPParams, col.OPParams, dr);
            this.PoleDisplayMessage(2, dr);
            this.ScreenObject.GridDataObj.updateRow(dr);
            this.ScreenObject.GridDataObj.refreshDatawithIDs();
        }
        else {
            Util.PlaySound("beep-01.wav");

            this.ScreenObject.GridDataObj.removeRow(dr);
            this.ScreenObject.GridDataObj.refreshDatawithIDs();

            if (this.SKU.Visible && this.ScreenObject.Preferences.ContainsKey("ShowSearchOnProductNotFound") && this.ScreenObject.Preferences["ShowSearchOnProductNotFound"] != "" && parseBoolean(this.ScreenObject.Preferences["ShowSearchOnProductNotFound"]))
                this.onButtonClick("SearchSKU");
        }
    }

    FillScan(dr: any, RowPos: number) {
        if (this.DocumentType == 38 || this.DocumentType == 39)
            this.Setselectedrow(RowPos);
        else
            this.Setselectedrow(this.ScreenObject.GridData.indexOf(dr));

        this.SKU.Text = "";
        this.CalculateTotals(dr, false, "Quantity");

        let schemes = parseBoolean(this.ScreenObject.Preferences["EnableSchemes"]);
        if (schemes) {
            let GrossFld = "GROSS";
            if (this.ScreenObject.Preferences.ContainsKey("SchemesNumericFields") && this.ScreenObject.Preferences["SchemesNumericFields"] != "" && this.ScreenObject.Preferences["SchemesNumericFields"] != "0") {
                let Col = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["SchemesNumericFields"]);
                if (Col && Col.DisplayMember != "")
                    GrossFld = Col.DisplayMember;
            }

            if (Util.Int(dr["ProductID_Key"]) > 0) {
                let ds = this.ScreenObject.GetSchemes(this.DocumentDate, dr);
                if (ds.Tables.length > 0 && ds.Columns[0].Contains("SchemeID"))
                    this.fillSchemevalues(ds.Tables[0], ds.Columns[0], dr);
            }
            this.ApplySchemes(dr);
        }
        if ((this.DocumentType == 38 || this.DocumentType == 39) && ((this.ScreenObject.Preferences.ContainsKey("DuplicateProduct_IncrementQuantity") && this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"] != "" && parseBoolean(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"])))) {
            if (this.AddProductQty(dr, false)) {
                let Vldbl = 0;
                if (Util.IsNum(dr["Quantity"]) && Util.IsNum(dr["UOMConversion"])) {
                    dr["UOMConvertedQty"] = parseFloat(dr["UOMConversion"]) * parseFloat(dr["Quantity"]);
                }
                else if (!Util.IsEmpty(dr["Quantity"]))
                    dr["UOMConvertedQty"] = dr["Quantity"].toString();

                this.Celleditend(dr, "Quantity", this.CostCenterID);
                this.ScreenObject.GridDataObj.updateRow(dr);
                this.CalculateTotals(dr, false, "Quantity");
            }
            this.SKU.SetFocus = true;
        }
    }

    FillPromotions(dt: any[], RowPos: number) {
        let MaxSchemeID = 0;
        let templink = this.ScreenObject.GridData.Compute("max", "MaxSchemeID");
        if (templink != null)
            MaxSchemeID = Util.Int(templink);
        MaxSchemeID++;

        this.ScreenObject.GridData[RowPos]["MaxSchemeID"] = MaxSchemeID;
        this.ScreenObject.GridData[RowPos]["IsScheme"] = "N";
        this.ScreenObject.GridData[RowPos]["SchemeID"] = "2";

        RowPos++;
        for (let i = 0; i < dt.length; i++) {
            let dr = this.ScreenObject.GridDataObj.NewRow();

            dr["ProductID_Key"] = dt[i]["ProductID"].toString();
            if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                dr["ProductCode"] = dt[i]["ProductCode"].toString();
            if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                dr["ProductName"] = dt[i]["ProductName"].toString();
            if (this.ScreenObject.GridDataColumns.Contains("UOMID")) {
                dr["UOM"] = dt[i]["UnitName"].toString();
                dr["UOM_Key"] = dt[i]["Unit"].toString();
            }
            dr["Type"] = dt[i]["ProductTypeID"].toString();
            dr["UOMConversion"] = dt[i]["Conversion"].toString();
            dr["Quantity"] = dt[i]["Quantity"].toString();

            if (Util.IsNum(dt[i]["Conversion"]))
                dr["UOMConvertedQty"] = parseFloat(dr["UOMConversion"]) * parseFloat(dr["Quantity"]);
            else
                dr["UOMConvertedQty"] = "1";

            dr["SchemeID"] = "2";
            dr["MaxSchemeID"] = MaxSchemeID;
            dr["IsScheme"] = "Y";

            if (this.ScreenObject.GridData.length > RowPos)
                this.ScreenObject.GridDataObj.insertRowAt(dr, RowPos);
            else
                this.ScreenObject.GridDataObj.addRow(dr);
        }
        this.ScreenObject.UpdateSequence();
    }

    CalcOpRate() {
        if (this.ScreenObject.DocumentType == 30 && this.ScreenObject.Preferences.ContainsKey("AssembleCalcOPRate") && parseBoolean(this.ScreenObject.Preferences["AssembleCalcOPRate"])) {
            if (this.ScreenObject.GridDataColumns.Contains("IsKit")) {
                let CHrows: any[] = this.ScreenObject.GridData.filter(x => x.IsKit == 2);
                let Val = 0;
                CHrows.forEach(citem => {
                    if (!Util.IsEmpty(citem["DefaultQuantity"]) && !Util.IsEmpty(citem["Rate"]))
                        Val += parseFloat(citem["DefaultQuantity"]) * parseFloat(citem["Rate"]);
                });
                CHrows = this.ScreenObject.GridData.filter(x => x.IsKit == 1);
                if (CHrows.length > 0) {
                    CHrows[0]["Rate"] = Val;
                    this.CalculateTotals(CHrows[0], false);
                }
            }
        }
    }
    OnKitProductChange(sender: any) {
        if (sender instanceof PactListBoxData) {
            if (this.ScreenObject.GridDataColumns.Contains("IsKit")) {
                let roremove = this.ScreenObject.GridData.filter(x => x.IsKit == 1 || x.IsKit == 2);
                roremove.forEach(citem => {
                    this.ScreenObject.GridDataObj.removeRow(citem);
                });
            }

            if (sender.SelectedValue > 0) {
                let isassemble = true, KitSizeDef = false;
                let Qty = 0;
                let typefld = this.ScreenObject._TextFields.find(a => a.DBColumnID.toString() == this.ScreenObject.Preferences["AssembleType"]);
                if (typefld && typefld instanceof PactComboBoxData && !Util.IsEmpty(typefld.SelectedValue) && typefld.SelectedValue == "DisAssemble")
                    isassemble = false;

                typefld = this.ScreenObject._TextFields.find(a => a.DBColumnID.toString() == this.ScreenObject.Preferences["AssembleQty"]);
                if (typefld && typefld instanceof PactTextBoxData && !Util.IsEmpty(typefld.Text)
                    && Util.IsNum(typefld.Text))
                    Qty = parseFloat(typefld.Text);
                else
                    Qty = 1;

                if (!this.ScreenObject.GridDataColumns.Contains("IsKit"))
                    this.ScreenObject.GridDataColumns.push("IsKit");

                let dsPrds = this.ScreenObject.GetProductBundle(sender.SelectedValue);

                if (dsPrds != null && dsPrds.Tables.length > 0 && dsPrds.Tables[0].length > 0 && dsPrds.Columns[0].Contains("KitSize")
                    && !Util.IsEmpty(dsPrds.Tables[0][0]["KitSize"])) {
                    Qty = parseFloat(dsPrds.Tables[0][0]["KitSize"]);
                    KitSizeDef = true;

                    if (typefld && typefld instanceof PactTextBoxData)
                        typefld.Text = Qty.toString();
                }
                let RowPos = 0;
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (Util.IsEmpty(this.ScreenObject.GridData[k]["ProductID_Key"])) {
                        RowPos = k;
                        break;
                    }
                }

                let drGrid = this.ScreenObject.GridDataObj.NewRow();
                this.ScreenObject.GridData.InsertAt(drGrid, RowPos);
                drGrid["ProductID_Key"] = sender.SelectedValue;
                drGrid["IsKit"] = 1;
                drGrid["Quantity"] = Qty;
                this.AddProductData(drGrid, false, true);

                if (isassemble)
                    drGrid["VoucherType"] = 1;
                else
                    drGrid["VoucherType"] = -1;
                let Vldbl = 1;
                if (Util.IsNum(drGrid["UOMConversion"]))
                    Vldbl = parseFloat(drGrid["UOMConversion"]);

                drGrid["UOMConvertedQty"] = Vldbl * parseFloat(drGrid["Quantity"]);

                this.CalculateTotals(drGrid, false);
                RowPos++;
                for (let i = 0; i < dsPrds.Tables[0].length; i++) {
                    drGrid = this.ScreenObject.GridDataObj.NewRow();
                    this.ScreenObject.GridData.InsertAt(drGrid, RowPos + i);

                    drGrid["ProductID_Key"] = dsPrds.Tables[0][i]["ProductID"];
                    drGrid["LineNarration"] = dsPrds.Tables[0][i]["Remarks"];

                    if (!Util.IsEmpty(dsPrds.Tables[0][i]["Quantity"])) {
                        if (KitSizeDef) {
                            drGrid["Quantity"] = dsPrds.Tables[0][i]["Quantity"].toString();
                            drGrid["DefaultQuantity"] = parseFloat(dsPrds.Tables[0][i]["Quantity"]) / Qty;
                        }
                        else {
                            drGrid["Quantity"] = Qty * parseFloat(dsPrds.Tables[0][i]["Quantity"]);
                            drGrid["DefaultQuantity"] = dsPrds.Tables[0][i]["Quantity"].toString();
                        }
                    }
                    else {
                        if (KitSizeDef) {
                            drGrid["Quantity"] = 1;
                            drGrid["DefaultQuantity"] = 1 / Qty;
                        }
                        else {
                            drGrid["Quantity"] = Qty;
                            drGrid["DefaultQuantity"] = 1;
                        }
                    }

                    if (dsPrds.Columns[0].Contains("unit") && !Util.IsEmpty(dsPrds.Tables[0][i]["unit"])) {
                        drGrid["Unit_Key"] = dsPrds.Tables[0][i]["unit"].toString();
                        drGrid["Unit"] = dsPrds.Tables[0][i]["UnitName"].toString();
                    }

                    drGrid["LineNarration"] = dsPrds.Tables[0][i]["Remarks"];

                    this.AddProductData(drGrid, false, true);

                    if (Util.IsNum(drGrid["UOMConversion"]))
                        Vldbl = parseFloat(drGrid["UOMConversion"] as any);

                    drGrid["UOMConvertedQty"] = Vldbl * parseFloat(drGrid["Quantity"]);

                    if (isassemble)
                        drGrid["VoucherType"] = -1;
                    else
                        drGrid["VoucherType"] = 1;

                    drGrid["IsKit"] = 2;
                    this.CalculateTotals(drGrid, false);
                }

                this.ScreenObject.UpdateSequence();
                if (this.RefreshGrid)
                    this.RefreshGrid = false;
                else
                    this.RefreshGrid = true;
            }

            if (sender instanceof PactControlData && !Util.IsEmpty(sender.KeyTip) && sender.KeyTip.toLowerCase() == "lostfocus" && this.ValidateData(sender as PactControlData, true))
                this.ScreenObject.GetExternalFuncData(sender.Mode, sender.ToolTipFooterTitle, sender.ToolTipFooterDescription, sender.ToolTipDescription, null);
        }
    }
    onTypeChange(VersionNo: string) {
        if (this.ScreenObject == null)
            return;

        let isassemble = true;
        let typefld = this.ScreenObject._TextFields.find(a => a.DBColumnID.toString() == this.ScreenObject.Preferences["AssembleType"]);
        if (typefld && typefld instanceof PactComboBoxData && !Util.IsEmpty(typefld.SelectedValue)
            && typefld.SelectedValue == "DisAssemble")
            isassemble = false;
        if (this.ScreenObject.GridDataColumns.Contains("IsKit")) {
            let drkit = this.ScreenObject.GridData.filter(x => x.IsKit == 1);
            if (drkit.length > 0) {
                if (isassemble)
                    drkit[0]["VoucherType"] = 1;
                else
                    drkit[0]["VoucherType"] = -1;

                drkit = this.ScreenObject.GridData.filter(x => x.IsKit == 2);
                drkit.forEach(dr => {
                    if (isassemble)
                        dr["VoucherType"] = -1;
                    else
                        dr["VoucherType"] = 1;
                });
            }
        }
    }

    //#region "Assign Leaves"
    LoadGradeData(Flag: number, FromDate: Date, Type: string) {
        let AssingLeavesDt;
        let strWhr = "";
        if (Flag == 0 || Flag == 2)//New
        {
            AssingLeavesDt = [];
            let dtALMain = [];
            this.dtData = null;
            if (this.ScreenObject == null)
                return;

            if (this.DocID > 0)
                return;

            if (Util.IsEmpty(Type))
                return;

            Logger.InfoLog("AssignLeavesViewModel::Start Loading Grade data");

            if (BaseService.SessionManager.Preferences.ContainsKey("AssignLeavesFilter") && BaseService.SessionManager.Preferences["AssignLeavesFilter"].toString() == "True") {
                strWhr = this.PopupEmployeesFilter(Type + '~' + FromDate, "LoadGradeData");

                if (strWhr != null && strWhr.length > 0 && strWhr.toString() == "Different LeaveYear") {
                    this.DisplayMessage = "Selected Grades have Different LeaveYear";
                    this.MessageVisibility = true;
                    return;
                }
            }

            let ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
            if (ALfld && ALfld instanceof PactExtraFieldDateData)
                FromDate = Util.ParseDate(ALfld.Date.ToString("dd/MMM/yyyy"));

            this.LoadGradeDataTemp(strWhr, Type + '~' + FromDate);
        }
        else if (Flag == 1)//Edit
        {
            if (Util.IsEmpty(Type))
                return;
            let AssingLeavesDt1 = [];

            let ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
            if (ALfld && ALfld instanceof PactComboBoxData)
                ALfld.IsReadOnly = true;

            ALfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
            if (ALfld && ALfld instanceof PactListBoxData)
                ALfld.Enable = false;

            let DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50051);
            let DimGrdBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50053);
            if (DimEmpBodyfld && DimEmpBodyfld instanceof DgColumn) {
                if (Type == "EmployeeWise") {
                    DimEmpBodyfld.IsVisible = true;
                    DimGrdBodyfld.IsVisible = false;
                }
                else {
                    DimGrdBodyfld.IsVisible = true;
                    DimEmpBodyfld.IsVisible = false;
                }
            }

            AssingLeavesDt1 = this.ScreenObject.GridData;
            if (this.dtData != null && this.dtData.length > 0)
                AssingLeavesDt1.AddRange(this.dtData);

            if (Type == "GradeWise") {
                AssingLeavesDt1 = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key != 1);//Employee list
                this.dtData = AssingLeavesDt1.Copy();

                AssingLeavesDt1 = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key == 1);//Grade list
                AssingLeavesDt1 = AssingLeavesDt1.Copy();
            }
            else if (Type == "EmployeeWise") {
                AssingLeavesDt1 = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key == 1);//Employee list
                this.dtData = AssingLeavesDt1.Copy();

                AssingLeavesDt1 = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key != 1);//Grade list
                AssingLeavesDt1 = AssingLeavesDt1.Copy();
            }
            if (AssingLeavesDt1.length > 0) {
                this.ScreenObject.GridDataObj.Clear();
                this.ScreenObject.GridDataObj.ClearFilters();
                this.ScreenObject.GridDataObj.addRows(AssingLeavesDt1);
            }
            this.ScreenObject.UpdateSequence();
            this.RefreshGrid = true;
        }
        this.ScreenObject.GridDataObj.RefreshColumns();
    }

    LoadLeaveyearDates(Year: number) {
        let strALPrefDate = new Date(Year, parseInt(BaseService.SessionManager.Preferences["LeaveYear"]), 1);
        let ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
        if (ALfld && ALfld instanceof PactExtraFieldDateData)
            ALfld.Date = Util.ParseDate(strALPrefDate.ToString("dd/MMM/yyyy"));

        strALPrefDate = strALPrefDate.AddMonths(12);
        strALPrefDate = strALPrefDate.AddDays(-(strALPrefDate.getDate()));
        ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
        if (ALfld && ALfld instanceof PactExtraFieldDateData)
            ALfld.Date = Util.ParseDate(strALPrefDate.ToString("dd/MMM/yyyy"));
    }
    //#endregion


    //#endregion

    OnChequeBookSelection(sender: string) {
        if (!Util.IsEmpty(this.ChequeBook.SelectedValue) && this.ScreenObject != null) {
            if (this.ScreenObject.Preferences.ContainsKey("AutoChequeonPost") && this.ScreenObject.Preferences["AutoChequeonPost"] == "True")
                return;
            let CID = 0;
            if (this.ScreenObject.CreditAccount != null)
                CID = this.ScreenObject.CreditAccount.SelectedValue;
            this.ScreenObject.HeaderFields.forEach(item => {
                if (item instanceof PactTextBoxData && item.DBColumnName == "ChequeNumber") {
                    if (this.ScreenObject.ChequeBookChecking == 0) {
                        item.Text = BaseService.document.GetChequeNumbers(CID, this.ChequeBook.SelectedValue);
                    }
                }
            });
        }
    }
    OnSearchDocument(sender: any) {
        if ((this.ScreenObject.Link.LinkCombo.SelectedItem == null || this.ScreenObject.Link.LinkCombo.SelectedItem == undefined)
            && Util.Int(this.ScreenObject.Link.LinkCombo.SelectedValue) > 0) {
            this.ScreenObject.Link.LinkCombo.SelectedItem = this.ScreenObject.Link.LinkCombo.Items.find(x => x.Value == this.ScreenObject.Link.LinkCombo.SelectedValue)
        }
        if (this.ScreenObject.Link.LinkCombo.SelectedItem != null && this.ScreenObject.Link.LinkCombo.SelectedItem != undefined) {
            let duedate = "", loc = "", div = "", where = "";

            if (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True"
                && BaseService.SessionManager.Preferences.ContainsKey("LocationWiseLinking") && BaseService.SessionManager.Preferences["LocationWiseLinking"].toString() == "True") {
                if (this.ScreenObject.LocationID > 0)
                    loc = this.ScreenObject.LocationID.toString();
                else if (BaseService.SessionManager.LocationID > 0)
                    loc = BaseService.SessionManager.LocationID.toString();
            }
            if (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True"
                && BaseService.SessionManager.Preferences.ContainsKey("DivisionWiseLinking") && BaseService.SessionManager.Preferences["DivisionWiseLinking"].toString() == "True") {
                if (this.ScreenObject.DivisionID > 0)
                    div = this.ScreenObject.DivisionID.toString();
                else if (BaseService.SessionManager.DivisionID > 0)
                    div = BaseService.SessionManager.DivisionID.toString();
            }

            if (this.ScreenObject.DueDate && this.ScreenObject.DueDate.Date)
                duedate = this.ScreenObject.DueDate.Date.ToString("dd/MMM/yyyy");

            if (this.ScreenObject.Preferences.ContainsKey("DimensionWise") && this.ScreenObject.Preferences["DimensionWise"] != "") {
                let ccids = this.ScreenObject.Preferences["DimensionWise"].split(',');
                ccids.forEach(item => {
                    if (item != "") {
                        let ccid = parseInt(item);
                        for (let c = 0; c < this.ScreenObject._CCFields.length; c++) {
                            let cc = this.ScreenObject._CCFields[c]
                            if (cc instanceof PactListBoxData && cc.CCID == ccid) {
                                if (cc.SelectedValue > 0)
                                    where += " and DCM.dcCCNID" + (ccid - 50000).toString() + "=" + cc.SelectedValue.toString();
                                else
                                    where += " and DCM.dcCCNID" + (ccid - 50000).toString() + "=0";
                                break;
                            }
                        }
                    }
                });
            }

            let drdef = this.ScreenObject.Data.Tables[6].filter(x => x.DocumentLinkDefID == this.ScreenObject.Link.LinkCombo.SelectedValue);
            let Initial;
            if (drdef.length > 0 && this.ScreenObject.Data.Columns[6].Contains("syscolumnname") && Util.String(drdef[0]["syscolumnname"]).toLowerCase().Contains("dcnum"))
                Initial = " d.";
            else
                Initial = " a.";
            let linkDoctype = 0;
            if (drdef.length > 0 && this.ScreenObject.Data.Columns[6].Contains("DocumentType") && !Util.IsEmpty(drdef[0]["DocumentType"]))
                linkDoctype = parseInt(drdef[0]["DocumentType"].toString());
            if (((this.ScreenObject.DocumentType == 6 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 39) && linkDoctype != 6 && linkDoctype != 10 && linkDoctype != 39)
                || ((linkDoctype == 6 || linkDoctype == 10 || linkDoctype == 39) && this.ScreenObject.DocumentType != 6 && this.ScreenObject.DocumentType != 10 && this.ScreenObject.DocumentType != 39)) {
                if (this.ScreenObject.Preferences.ContainsKey("Debit Account") && parseBoolean(this.ScreenObject.Preferences["Debit Account"]) && this.ScreenObject.DebitAccount != null) {
                    if (this.ScreenObject.DebitAccount.SelectedValue > 0)
                        where += " and " + Initial + "CreditAccount=" + this.ScreenObject.DebitAccount.SelectedValue.toString();
                    else
                        where += " and " + Initial + "CreditAccount=0";
                }
                if (this.ScreenObject.Preferences.ContainsKey("Credit Account") && parseBoolean(this.ScreenObject.Preferences["Credit Account"]) && this.ScreenObject.CreditAccount != null) {
                    if (this.ScreenObject.CreditAccount.SelectedValue > 0)
                        where += " and " + Initial + "DebitAccount=" + this.ScreenObject.CreditAccount.SelectedValue.toString();
                    else
                        where += " and " + Initial + "DebitAccount=0";
                }

            }
            else {
                if (this.ScreenObject.Preferences.ContainsKey("Debit Account") && parseBoolean(this.ScreenObject.Preferences["Debit Account"]) && this.ScreenObject.DebitAccount != null) {
                    if (this.ScreenObject.DebitAccount.SelectedValue > 0)
                        where += " and " + Initial + "DebitAccount=" + this.ScreenObject.DebitAccount.SelectedValue.toString();
                    else
                        where += " and " + Initial + "DebitAccount=0";
                }
                if (this.ScreenObject.Preferences.ContainsKey("Credit Account") && parseBoolean(this.ScreenObject.Preferences["Credit Account"]) && this.ScreenObject.CreditAccount != null) {
                    if (this.ScreenObject.CreditAccount.SelectedValue > 0)
                        where += " and " + Initial + "CreditAccount=" + this.ScreenObject.CreditAccount.SelectedValue.toString();
                    else
                        where += " and " + Initial + "CreditAccount=0";
                }
            }

            //Load Vouchers based on DateField        
            if ((this.CostCenterID > 40000 && this.CostCenterID < 50000) && this.ScreenObject.Preferences.ContainsKey("ShowLinkedDocsBasedon") && this.ScreenObject.Preferences["ShowLinkedDocsBasedon"].toString() != "") {
                let IsValExists = false;
                let f = this.ScreenObject.HeaderFields.find(x => x instanceof PactExtraFieldDateData && x.DBColumnID == parseInt(this.ScreenObject.Preferences["ShowLinkedDocsBasedon"]))
                if (f && f.Date) {
                    IsValExists = true;
                    where += " and convert(datetime, a.DocDate) <= convert(nvarchar(20), ''" + f.Date.ToString("dd/MMM/yyyy") + "'') ";
                }

                if (!IsValExists) {
                    f = this.ScreenObject.HeaderFields.find(x => x instanceof PactDatePickerData && x.DBColumnID == parseInt(this.ScreenObject.Preferences["ShowLinkedDocsBasedon"]))
                    if (f && f.Date) {
                        IsValExists = true;
                        where += " and convert(datetime, a.DocDate) <= convert(nvarchar(20), ''" + f.Date.ToString("dd/MMM/yyyy") + "'') ";
                    }
                }

                if (!IsValExists) {
                    f = this.ScreenObject._TextFields.find(x => x instanceof PactExtraFieldDateData && x.DBColumnID == parseInt(this.ScreenObject.Preferences["ShowLinkedDocsBasedon"]))
                    if (f && f.Date) {
                        IsValExists = true;
                        where += " and convert(datetime, a.DocDate) <= convert(nvarchar(20), ''" + f.Date.ToString("dd/MMM/yyyy") + "'') ";
                    }
                }

                if (!IsValExists) {
                    f = this.ScreenObject._StaticFields.find(x => x instanceof PactExtraFieldDateData && x.DBColumnID == parseInt(this.ScreenObject.Preferences["ShowLinkedDocsBasedon"]))
                    if (f && f.Date) {
                        IsValExists = true;
                        where += " and convert(datetime, a.DocDate) <= convert(nvarchar(20), ''" + f.Date.ToString("dd/MMM/yyyy") + "'') ";
                    }
                }

            }

            if (this.ScreenObject.Preferences.ContainsKey("LinkVendorProducts") && parseBoolean(this.ScreenObject.Preferences["LinkVendorProducts"])) {
                if (this.ScreenObject.IsPurchase && this.ScreenObject.CreditAccount != null)
                    where += " join INV_ProductVendors PV WITH(NOLOCK) ON p.ProductID=pv.ProductID and pv.AccountID=" + this.ScreenObject.CreditAccount.SelectedValue;
                else if (!this.ScreenObject.IsPurchase && this.ScreenObject.DebitAccount != null)
                    where += " join INV_ProductVendors PV WITH(NOLOCK) ON p.ProductID=pv.ProductID and pv.AccountID=" + this.ScreenObject.DebitAccount.SelectedValue;
            }

            let SelectedDOcs = "";
            if (this.ScreenObject.Link.DocumentList != null) {
                this.ScreenObject.Link.DocumentList.Items.forEach(item => {
                    if (item.IsChecked)
                        SelectedDOcs += item.Value + ",";
                });
            }
            if (sender.toString() == "Link") {
                let SDocVM = new SearchDocumentViewModel();
                SDocVM.SearchDocumentViewModel_1(this, this.ScreenObject.Link.LinkCombo.SelectedItem.Value, this.ScreenObject.Link.LinkCombo.SelectedItem.Parent, this.DocumentDate, duedate, loc, div, where, SelectedDOcs, true);
                BaseService.page.ShowDialog(SDocVM, SearchDocumentComponent, { HideHeader: true });
                // BaseService.page.ShowDialog(new SearchDocumentViewModel(this, this.ScreenObject.Link.LinkCombo.SelectedItem.Value, this.ScreenObject.Link.LinkCombo.SelectedItem.Parent, this.DocumentDate, duedate, loc, div, where, SelectedDOcs, true), SearchDocumentComponent, {  HideHeader: true })
            }
            else {
                let SDocVM = new SearchDocumentViewModel();
                SDocVM.SearchDocumentViewModel_1(this, this.ScreenObject.Link.LinkCombo.SelectedItem.Value, this.ScreenObject.Link.LinkCombo.SelectedItem.Parent, this.DocumentDate, duedate, loc, div, where, SelectedDOcs, false);
                BaseService.page.ShowDialog(SDocVM, SearchDocumentComponent, { HideHeader: true });
                //BaseService.page.ShowDialog(new SearchDocumentViewModel(this, this.ScreenObject.Link.LinkCombo.SelectedItem.Value, this.ScreenObject.Link.LinkCombo.SelectedItem.Parent, this.DocumentDate, duedate, loc, div, where, SelectedDOcs, false), SearchDocumentComponent, { HideHeader: true });
            }
        }
    }

    GetWorkFlow(IschildWorkflow: boolean, dr: any): number {
        if (IschildWorkflow) {
            if (this.ScreenObject.Data.Tables.length <= 1 || (this.ScreenObject.Data.Tables.length > 1 && this.ScreenObject.Data.Tables[1].length < 1))
                return 0;
        }
        else if (this.ScreenObject.Data.Tables.length <= 9 || (this.ScreenObject.Data.Tables.length > 9 && this.ScreenObject.Data.Tables[9].length < 1))
            return 0;
        if (!this.IsInventoryVoucher && this.ScheduleID > 0 && !this.ScreenObject.IsPostRecurDocumentWithApproval(this.RecurDocumentVoucherNo))
            return 0;

        if (this.IsInventoryVoucher && this.commandprarameter == "ReSave" && this.DocID == 0 && this.ScheduleID > 0 && !this.ScreenObject.IsAutoPostRecurDocumentWithApproval(this.ScheduleID))
            return 0;

        if (this.commandprarameter != null && (this.commandprarameter == "NoWorkFlow" || this.commandprarameter == "NoWorkFlowReSave" || this.commandprarameter == "NoWorkFlowprint"))
            return 0;
        if (this.ScreenObject.Preferences.ContainsKey("NoWorkflowPostedDocs") && this.ScreenObject.Preferences["NoWorkflowPostedDocs"] != "" && parseBoolean(this.ScreenObject.Preferences["NoWorkflowPostedDocs"])
            && !this.LineWiseApproval && this.StatusID == 369)
            return 0;

        let WID = 0, Level = this.WorkFlowDocLevel;

        if (!this.LineWiseApproval && (this.StatusID == 369 || this.StatusID == 370))//edit posted document so starting from level 1
            Level = 0;

        if (dr != null) {
            Level = 0;
            if (!Util.IsEmpty(dr["WorkFlowLevel"]) && dr["StatusID"].toString() != "369")
                Level = parseInt(dr["WorkFlowLevel"]);

            this.FillDictionary(dr, false);
        }
        this.FooterDics.keys.forEach(key => {
            let item = { Key: key, Value: this.FooterDics[key] }
            let col = this.ScreenObject.ColumnSource.find(a => a.lbl == (this.FooterDics[item.Key].getFieldName()));
            if (col) {
                if (col.DataType != "FLOAT") {
                    this.FooterDics[item.Key].setFieldValue(this.fldDict[item.Key].getFieldResult());
                }
                else {
                    let TotValue = 0;
                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        let ExchangeRate = 1;
                        if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                            if (this.Currency != null && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
                                ExchangeRate = parseFloat(this.Currency.ExchangeRate.Text);
                            else if (this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ExchangeRate"]))
                                ExchangeRate = parseFloat(this.ScreenObject.GridData[i]["ExchangeRate"]);
                        }

                        if (col.DisplayMember.toLowerCase().Contains("dcnum")) {
                            if (col.DefaultValue == "-2") {
                                if (this.ScreenObject.GridDataColumns.Contains(col.DisplayMember.toLowerCase().replace("dcnum", "dcExchRT")) && !Util.IsEmpty(this.ScreenObject.GridData[i][col.DisplayMember.toLowerCase().replace("dcnum", "dcExchRT")]))
                                    ExchangeRate = parseFloat(this.ScreenObject.GridData[i][col.DisplayMember.toLowerCase().replace("dcnum", "dcExchRT")]);
                                else
                                    ExchangeRate = 1;
                            }

                            let def = Util.Int(col.DefaultValue);
                            if (def > 0)
                                if (col.CurrID > 0) {
                                    ExchangeRate = col.ExhcgRt;
                                }
                                else
                                    ExchangeRate = 1;
                        }

                        if (col.DisplayMember == "Quantity") {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["UOMConvertedQty"]))
                                TotValue += parseFloat(this.ScreenObject.GridData[i]["UOMConvertedQty"]);
                        }
                        else if (!col.IsColumnUserDefined && col.DataType == "FLOAT") {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i][col.DisplayMember]))
                                TotValue += parseFloat(this.ScreenObject.GridData[i][col.DisplayMember]) * ExchangeRate;
                        }
                        else if (col.DisplayMember.Contains("dcNum")) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCalc" + col.DisplayMember]))
                                TotValue += parseFloat(this.ScreenObject.GridData[i]["dcCalc" + col.DisplayMember]) * ExchangeRate;
                        }
                    }
                    this.FooterDics[item.Key].setFieldValue(TotValue);
                }
            }
            else
                this.FooterDics[item.Key].setFieldValue(0);
        });

        this.ScreenObject._TextFields.forEach(item => {
            if (this.FooterDics.ContainsKey(item.Lbl)) {
                if (item instanceof PactTextBoxData) {
                    if (item.DataType == "FLOAT") {
                        if (item.Text != null && item.Text != "" && item.ValidateData() == "")
                            this.FooterDics[item.Lbl].setFieldValue(item.Text);
                        else
                            this.FooterDics[item.Lbl].setFieldValue(0);
                    }
                    else
                        this.FooterDics[item.Lbl].setFieldValue(item.Text);
                }
                else if (item instanceof PactComboBoxData)
                    this.FooterDics[item.Lbl].setFieldValue(item.SelectedValue);
                else if (item instanceof PactSelectionBoxData)
                    this.FooterDics[item.Lbl].setFieldValue(item.Text);
                else if (item instanceof PactListBoxData) {
                    if (item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                        this.FooterDics[item.Lbl].setFieldValue(item.Text);
                    else
                        this.FooterDics[item.Lbl].setFieldValue("");
                }
                else if (item instanceof PactCodeNameListBoxData) {
                    if (item.SelectedValue > 0) {
                        if (item.Code.Visible && !Util.IsEmpty(item.Code.Text))
                            this.FooterDics[item.Lbl].setFieldValue(item.Code.Text);
                        else if (item.Name.Visible && !Util.IsEmpty(item.Name.Text))
                            this.FooterDics[item.Lbl].setFieldValue(item.Name.Text);
                    }
                    else
                        this.FooterDics[item.Lbl].setFieldValue('');
                }
            }
        });
        this.ScreenObject._CCFields.forEach(item => {
            if (this.FooterDics.ContainsKey(item.Lbl)) {
                if (item instanceof PactListBoxData && item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                    this.FooterDics[item.Lbl].setFieldValue(item.Text);
                else
                    this.FooterDics[item.Lbl].setFieldValue("");
            }
        });
        this.ScreenObject.HeaderFields.forEach(item => {
            if (item instanceof PactControlData && !Util.IsEmpty(item.Lbl) && this.FooterDics.ContainsKey(item.Lbl)) {
                if (item instanceof PactTextBoxData) {
                    if (item.DataType == "FLOAT") {
                        if (!Util.IsEmpty(item.Text) && item.ValidateData() == "")
                            this.FooterDics[item.Lbl].setFieldValue(item.Text);
                        else
                            this.FooterDics[item.Lbl].setFieldValue(0);
                    }
                    else
                        this.FooterDics[item.Lbl].setFieldValue(item.Text);
                }
                else if (item instanceof PactComboBoxData)
                    this.FooterDics[item.Lbl].setFieldValue(item.SelectedValue);
                else if (item instanceof PactSelectionBoxData)
                    this.FooterDics[item.Lbl].setFieldValue(item.Text);
                else if (item instanceof PactExtraFieldDateData && item.Date)
                    this.FooterDics[item.Lbl].setFieldValue(item.Date);
                else if (item instanceof PactListBoxData) {
                    if (item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                        this.FooterDics[item.Lbl].setFieldValue(item.Text);
                    else
                        this.FooterDics[item.Lbl].setFieldValue("");
                }
            }
        });

        if (this.IsInventoryVoucher) {
            let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Rate");
            if (col && !Util.IsEmpty(col.footer))
                this.FooterDics["RATE"].setFieldValue(col.footer);
            else
                this.FooterDics["RATE"].setFieldValue(0);

            col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Quantity");
            if (col && !Util.IsEmpty(col.footer))
                this.FooterDics["QTY"].setFieldValue(col.footer);
            else
                this.FooterDics["QTY"].setFieldValue(0);

            col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Gross");
            if (col && !Util.IsEmpty(col.footer))
                this.FooterDics["GROSS"].setFieldValue(col.footer);
            else
                this.FooterDics["GROSS"].setFieldValue(0);

            this.FooterDics["NET"].setFieldValue(this.NetAmount);
        }

        let temp = null;

        let Wdv = null, WdvDt;
        if (IschildWorkflow)
            WdvDt = this.ScreenObject.Data.Tables[1];
        else
            WdvDt = this.ScreenObject.Data.Tables[9];

        if (this.ScreenObject.IsDocEdit) {
            if (this.commandprarameter == "Revise") {
                Wdv = WdvDt.filter(x => x.Action == 11);
                if (Wdv.length == 0)
                    Wdv = WdvDt.filter(x => x.Action == 2);
            }
            else
                Wdv = WdvDt.filter(x => x.Action == 2 || x.Action == 6);
        }
        else
            Wdv = WdvDt.filter(x => x.Action == 1 || x.Action == 6);

        Wdv.sort((a, b) => a.LevelID - b.LevelID)
        let LWExp = false;
        for (let i = 0; i < Wdv.length; i++) {
            if (Level > 0 && !Util.IsEmpty(Wdv[i]["LevelID"]) && parseInt(Wdv[i]["LevelID"]) < Level)
                continue;

            if (!this.LineWiseApproval && Level > 0 && this.WfID > 0 && !Util.IsEmpty(Wdv[i]["WorkFlowID"]) && parseInt(Wdv[i]["WorkFlowID"]) != this.WfID)
                continue;

            if (dr != null && this.ScreenObject.GridDataColumns.Contains("WorkFlowID") && !Util.IsEmpty(dr["WorkFlowID"]) && dr["WorkFlowID"].toString() != "0" && dr["WorkFlowID"].toString() != Wdv[i]["WorkFlowID"].toString())
                continue;

            if (Util.IsNullOrWhiteSpace(Wdv[i]["Expression"]))
                return parseInt(Wdv[i]["WorkFlowID"]);

            if (!Util.IsNullOrWhiteSpace(Wdv[i]["IsExpressionLineWise"]))
                LWExp = parseBoolean(Wdv[i]["IsExpressionLineWise"]);
            else
                LWExp = false;

            if (Wdv[i]["Expression"] != null && Wdv[i]["Expression"].toString() != "" && Wdv[i]["Expression"].toString().Contains("ServerDate")) {
                let dtSD = BaseService.common.GetDataTable("DOC068", "");
                if (this.FooterDics["ServerDate"] != null)
                    this.FooterDics["ServerDate"].setFieldValue(Util.ParseDate(dtSD[0]["ServerDate"]).Date());

                if (this.fldDict["ServerDate"] != null)
                    this.fldDict["ServerDate"].setFieldValue(Util.ParseDate(dtSD[0]["ServerDate"]).Date());
            }

            if (Wdv[i]["Expression"] != null && Wdv[i]["Expression"].toString() != "" && Wdv[i]["Expression"].toString().Contains("DOCDATE")) {
                if (this.FooterDics["DOCDATE"] != null)
                    this.FooterDics["DOCDATE"].setFieldValue(this.DocumentDate.Date());

                if (this.fldDict["DOCDATE"] != null)
                    this.fldDict["DOCDATE"].setFieldValue(this.DocumentDate.Date());
            }

            if (LWExp) {
                if (dr != null)
                    temp = this.fldDict;
                else {
                    let colName = this.GetPrimaryColName();

                    for (let h = 0; h < this.ScreenObject.GridData.length; h++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[h][colName])) {
                            this.FillDictionary(this.ScreenObject.GridData[h], false);
                            temp = this.fldDict;
                            let Res = BaseService.eval.EvaluateExpression(Wdv[i]["Expression"].toString(), temp);
                            if (Res != null && Res.toString() == "1") {
                                return parseInt(Wdv[i]["WorkFlowID"]);
                            }
                        }
                    }
                    return 0;
                }
            }
            else
                temp = this.FooterDics;
            try {
                let Res = BaseService.eval.EvaluateExpression(Wdv[i]["Expression"].toString(), temp);

                if (Res != null && Res.toString() == "1") {
                    return parseInt(Wdv[i]["WorkFlowID"]);
                }
            }
            catch (error) {

            }
        }

        if (dr != null && (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Posted Docs") || BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Approved Docs"))) {
            for (let i = 0; i < Wdv.length; i++) {
                if (Wdv[i]["Expression"].toString().trim() == "")
                    return parseInt(Wdv[i]["WorkFlowID"]);

                if (Wdv[i]["IsExpressionLineWise"].toString().trim() != "")
                    LWExp = parseBoolean(Wdv[i]["IsExpressionLineWise"]);
                else
                    LWExp = false;

                if (Wdv[i]["Expression"] != null && Wdv[i]["Expression"].toString() != "" && Wdv[i]["Expression"].toString().Contains("ServerDate")) {
                    let dtSD = BaseService.common.GetDataTable("DOC068", "");
                    if (this.FooterDics["ServerDate"] != null)
                        this.FooterDics["ServerDate"].setFieldValue(Util.ParseDate(dtSD[0]["ServerDate"]).Date);

                    if (this.fldDict["ServerDate"] != null)
                        this.fldDict["ServerDate"].setFieldValue(Util.ParseDate(dtSD[0]["ServerDate"]).Date);
                }

                if (Wdv[i]["Expression"] != null && Wdv[i]["Expression"].toString() != "" && Wdv[i]["Expression"].toString().Contains("DOCDATE")) {
                    if (this.FooterDics["DOCDATE"] != null)
                        this.FooterDics["DOCDATE"].setFieldValue(this.DocumentDate.Date);

                    if (this.fldDict["DOCDATE"] != null)
                        this.fldDict["DOCDATE"].setFieldValue(this.DocumentDate.Date);
                }

                if (LWExp) {
                    if (dr != null)
                        temp = this.fldDict;
                    else {
                        let colName = this.GetPrimaryColName();

                        for (let h = 0; h < this.ScreenObject.GridData.length; h++) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[h][colName])) {
                                this.FillDictionary(this.ScreenObject.GridData[h], false);
                                temp = this.fldDict;
                                let Res = BaseService.eval.EvaluateExpression(Wdv[i]["Expression"].toString(), temp);
                                if (Res != null && Res.toString() == "1") {
                                    return parseInt(Wdv[i]["WorkFlowID"]);
                                }
                            }
                        }
                        return 0;
                    }
                }
                else
                    temp = this.FooterDics;
                try {
                    let Res = BaseService.eval.EvaluateExpression(Wdv[i]["Expression"].toString(), temp);
                    if (Res != null && Res.toString() == "1") {
                        return parseInt(Wdv[i]["WorkFlowID"]);
                    }
                }
                catch (error) {

                }
            }
        }
        return WID;
    }
    GetRowValue(refObj: any, i: number, j: number) {
        if (this.ScreenObject.Preferences.ContainsKey("PosPaymentTypeFld") && this.ScreenObject.Preferences["PosPaymentTypeFld"] == this.ScreenObject.ColumnSource[j].ID)
            refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + Util.String(this.ScreenObject.GridData[i]["FieldType"]) + "', ";
        else if (this.ScreenObject.ColumnSource[j].DataType == "SELECTIONBOX" && this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember] != null) {
            if (this.savebulk)
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) + "\" ";
            else
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) + "', ";
        }
        else if (this.ScreenObject.ColumnSource[j].DataType == "DATE" && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"])) {
            if (this.DocumentType == 55 && this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "dcalpha1") // Loan OP Bal - Deduction Month
            {
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("01/MMM/yyyy") + "', ";
            }
            else if (this.DocumentType == 56 && this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "dcalpha5") // ApplyLoan - Deduction Month
            {
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("01/MMM/yyyy") + "', ";
            }
            else {
                if (this.savebulk)
                    refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("dd/MMM/yyyy") + "\" ";
                else
                    refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("dd/MMM/yyyy") + "', ";
            }
        }
        else if ((this.ScreenObject.ColumnSource[j].DataType == "DATETIME" || this.ScreenObject.ColumnSource[j].DataType == "TIME") && Util.String(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]) != "") {
            if (this.savebulk)
                // refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("dd/MMM/yyyy hh:mm:ss tt") + "\" ";
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("dd/MMM/yyyy hh:mm:ss a") + "\" ";
            else
                // refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("dd/MMM/yyyy hh:mm:ss tt") + "', ";
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("dd/MMM/yyyy hh:mm:ss a") + "', ";
        }
        else if ((this.ScreenObject.ColumnSource[j].DataType == "Time2") && Util.String(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]) != "") {
            if (this.savebulk)
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("dd/MMM/yyyy HH:mm") + "\" ";
            else
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("dd/MMM/yyyy HH:mm") + "', ";
        }
        else if (this.ScreenObject.ColumnSource[j].DataType == "ComboBox") {
            if (this.savebulk)
                refObj.sbText += this.ScreenObject.ColumnSource[j].ValueBinding + "=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding]) + "\" ";
            else
                refObj.sbText += this.ScreenObject.ColumnSource[j].ValueBinding + "=N'" + PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding]) + "', ";
        }
        else if (this.ScreenObject.ColumnSource[j].DataType == "PactComboBox") {
            if (this.DocumentType == 68 || this.DocumentType == 70 || this.DocumentType == 80) {
                refObj.sbText += this.ScreenObject.ColumnSource[j].ValueBinding + "=N'" + PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding]) + "', ";
            }
            else {
                if (this.savebulk)
                    refObj.sbText += this.ScreenObject.ColumnSource[j].ValueBinding + "=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding + "_Key"]) + "\" ";
                else
                    refObj.sbText += this.ScreenObject.ColumnSource[j].ValueBinding + "=N'" + PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding + "_Key"]) + "', ";
            }
        }
        else if (this.ScreenObject.ColumnSource[j].DataType == "LISTBOX" && this.ScreenObject.ColumnSource[j].CostCenterID != 0 && this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("alpha")) {
            if (this.savebulk)
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + Util.String(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) + "\" ";
            else
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + Util.String(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) + "', ";
        }
        else if (this.ColumnSource[j].DataType == "CheckBox") {
            if (Util.String(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) == "True")
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'True',";
            else
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'False',";
        }
        else if (this.ScreenObject.ColumnSource[j].DataType.toLowerCase() == "textblock" || this.ScreenObject.ColumnSource[j].DataType.toLowerCase() == "text"
            || this.ScreenObject.ColumnSource[j].DataType.toLowerCase() == "float" || this.ScreenObject.ColumnSource[j].DataType.toLowerCase() == "int" || Util.IsEmpty(this.ScreenObject.ColumnSource[j].DataType)) {
            if (this.savebulk)
                refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) + "\" ";
            else {
                if ((this.ScreenObject.DocumentType == 89 || this.ScreenObject.DocumentType == 90)) {
                    if (this.isCheckIn && this.ScreenObject.ColumnSource[j].DisplayMember == "dcAlpha9") {
                        /** refObj.sbText +=this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i]["dcAlpha8"].toString()) == "Web" ? BaseService.SessionManager.GetSysInfo() : PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString()) + "', "; **/
                        refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + (this.IsMobile ? (BaseService.IsAndroid ? "Android" : "IOS") : "WEBIP") + "',";
                    }
                    else if (this.isCheckOut && this.ScreenObject.ColumnSource[j].DisplayMember == "dcAlpha19") {
                        /** refObj.sbText +=this.ScreenObject.ColumnSource[j].DisplayMember +"=N'"+ PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i]["dcAlpha18"].toString()) == "Web" ? BaseService.SessionManager.GetSysInfo() : PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString()) + "', "; **/
                        refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + (this.IsMobile ? (BaseService.IsAndroid ? "Android" : "IOS") : "WEBIP") + "',";
                    }
                    else
                        refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) + "', ";
                }
                else
                    refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) + "', ";
            }
        }
        else if (!this.savebulk)
            refObj.sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=NULL,";
    }

    DistributeInstallments(basedon: string) {
        try {
            let Amt = 0, InstAmt = 0, NoOfins = 1, tot = 0, ActInst = 1, amtTmp = 0;
            let txtfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
            if (txtfld && txtfld instanceof PactTextBoxData && !Util.IsEmpty(txtfld.Text) && txtfld.ValidateData() == "")
                Amt = parseFloat(txtfld.Text);

            if (Amt == 0) {
                txtfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                if (txtfld && txtfld instanceof PactTextBoxData && !Util.IsEmpty(txtfld.Text) && txtfld.ValidateData() == "")
                    Amt = parseFloat(txtfld.Text);
            }

            if (Amt > 0) {
                txtfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                if (txtfld && txtfld instanceof PactTextBoxData && !Util.IsEmpty(txtfld.Text) && txtfld.ValidateData() == "" && parseFloat(txtfld.Text) > 0) {
                    InstAmt = parseFloat(txtfld.Text);
                    NoOfins = parseInt((Amt / InstAmt) as any);
                    ActInst = parseFloat((Amt / InstAmt) as any);
                    if (ActInst > NoOfins && (ActInst - NoOfins) > 0.01)
                        NoOfins++;

                    txtfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                    (txtfld as PactTextBoxData).Text = NoOfins.toString();
                }
                else {
                    txtfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                    if (txtfld && txtfld instanceof PactTextBoxData && !Util.IsEmpty(txtfld.Text) && txtfld.ValidateData() == "" && parseInt(txtfld.Text) > 0) {
                        NoOfins = parseInt(txtfld.Text);
                        InstAmt = parseFloat((Amt / NoOfins) as any);
                        //For Installment amount
                        txtfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                        (txtfld as PactTextBoxData).Text = InstAmt.toString();
                    }
                }

                if (InstAmt == 0)
                    InstAmt = Amt;

                let fldInstAmtCol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != null && a.DisplayMember.toLowerCase() == "dcnum2");
                if (fldInstAmtCol) {
                    let dec = Util.Int(fldInstAmtCol.DecimalPoints);
                    InstAmt = parseFloat(InstAmt.ToString("N" + dec));
                }

                txtfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                if (txtfld && txtfld instanceof PactTextBoxData)
                    txtfld.Text = InstAmt.toString();

                txtfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                if (txtfld && txtfld instanceof PactTextBoxData)
                    txtfld.Text = NoOfins.toString();


                let namecode = null; let dtdm = new Date();
                let prodcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "productid_key");
                if (prodcol && prodcol.DefaultValueText && Util.IsNum(prodcol.DefaultValue)) //&& parseInt(prodcol.DefaultValue) > 0
                {
                    namecode = prodcol.DefaultValueText.split('\u0011');
                }

                if (InstAmt > Amt) {
                    this.DisplayMessage = "Installment amount should be less than or equal to approved amount";
                    return;
                }

                txtfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
                if (txtfld instanceof PactExtraFieldDateData) {
                    if (!txtfld.Date) {
                        this.DisplayMessage = BaseService.GetResource("Select") + " " + txtfld.Label;
                        return;
                    }
                    else {
                        if (basedon == "") {
                            dtdm = new Date(parseInt(txtfld.Date.ToString("yyyy")), parseInt(txtfld.Date.ToString("MM")) - 1, 1);
                            txtfld.Date = dtdm;
                        }
                        else
                            dtdm = txtfld.Date;
                    }
                }
                else
                    dtdm = this.DocumentDate;

                let colName = "";
                if (this.IsInventoryVoucher)
                    colName = "ProductID_Key";
                let LinkedInvDocDetailsID = "", LinkedFieldName = "", refno = "";
                let drr = this.ScreenObject.GridData.filter(x => !Util.IsEmpty(x.ProductName));
                if (drr.length > 0) {
                    drr.forEach(drtoDelete => {
                        if (LinkedInvDocDetailsID == "" && !Util.IsEmpty(drtoDelete["LinkedInvDocDetailsID"])) {
                            LinkedInvDocDetailsID = drtoDelete["LinkedInvDocDetailsID"].toString();
                            if (!Util.IsEmpty(drtoDelete["LinkedFieldName"]))
                                LinkedFieldName = drtoDelete["LinkedFieldName"].toString();
                            if (!Util.IsEmpty(drtoDelete["RefNo"]))
                                refno = drtoDelete["RefNo"].toString();
                        }
                        this.ScreenObject.GridDataObj.removeRow(drtoDelete);
                    });
                }
                for (let l = 10; l <= NoOfins; l++) {
                    let drnew = this.ScreenObject.GridDataObj.NewRow();
                    drnew["DocSeqNo"] = this.ScreenObject.GridData.length + 1;
                    drnew["DocDetailsID"] = 0;
                    this.ScreenObject.GridDataObj.addRow(drnew);
                }

                for (let i = 0; i < NoOfins; i++) {
                    let rowpos = this.GetEmptyRowPosition(this.ScreenObject.GridDataObj, colName);
                    if (prodcol && namecode != null && namecode.length > 0) {
                        this.ScreenObject.GridData[rowpos]["ProductID_Key"] = prodcol.DefaultValue;
                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode") && namecode.length > 1)
                            this.ScreenObject.GridData[rowpos]["ProductCode"] = namecode[1];
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName") && namecode.length > 0)
                            this.ScreenObject.GridData[rowpos]["ProductName"] = namecode[0];
                    }

                    if (LinkedInvDocDetailsID != "")
                        this.ScreenObject.GridData[rowpos]["LinkedInvDocDetailsID"] = LinkedInvDocDetailsID;

                    if (LinkedFieldName != "")
                        this.ScreenObject.GridData[rowpos]["LinkedFieldName"] = LinkedFieldName;
                    if (refno != "")
                        this.ScreenObject.GridData[rowpos]["RefNo"] = refno;

                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha6_Key")) {
                        this.ScreenObject.GridData[rowpos]["dcAlpha6_Key"] = dtdm;
                        this.ScreenObject.GridData[rowpos]["dcAlpha6"] = dtdm.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                    }
                    if (this.ScreenObject.GridDataColumns.Contains("dcNum1"))
                        this.ScreenObject.GridData[rowpos]["dcNum1"] = (i + 1);

                    amtTmp = 0;
                    if (this.ScreenObject.GridDataColumns.Contains("dcNum2")) {
                        if (i + 1 == NoOfins)
                            this.ScreenObject.GridData[rowpos]["dcNum2"] = Amt - tot;
                        else
                            this.ScreenObject.GridData[rowpos]["dcNum2"] = InstAmt;

                        amtTmp = parseFloat(this.ScreenObject.GridData[rowpos]["dcNum2"]);
                    }
                    this.ScreenObject.GridDataObj.updateRow(this.ScreenObject.GridData[rowpos]);
                    this.CalculateTotals(this.ScreenObject.GridData[rowpos], false);

                    tot += amtTmp;

                    if (basedon == "" || basedon == "monthly")
                        dtdm = dtdm.AddMonths(1);
                    else if (basedon == "daily")
                        dtdm = dtdm.AddDays(1);
                    else if (basedon == "weekly")
                        dtdm = dtdm.AddDays(7);
                    else if (basedon == "quarterly")
                        dtdm = dtdm.AddMonths(3);
                    else if (basedon == "halfyearly")
                        dtdm = dtdm.AddMonths(6);
                    else if (basedon == "yearly")
                        dtdm = dtdm.AddYears(1);
                }
            }
            else {
                if (txtfld)
                    this.DisplayMessage = txtfld.Label + " should not be empty";
                else
                    this.DisplayMessage = "Loan amount should not be empty";

            }
        }
        catch (error) {
            Logger.ErrorLog("AddEditDocumentViewModel::" + error.stack, "DistributeInstallments", error);
        }
    }


    IgnoreOnSave = new Dictionary<any>();
    SaveInventoryDocument_1(sender: any) {

        this.IgnoreOnSave.Clear();
        if (!this.ButtonsEnabled)
            return;
        if ((sender != null && sender.toString() != "Approve" && sender.toString() != "ApproveandPrint" && sender.toString() != "CheckoutSave" && sender.toString() != "CheckoutPrint" && sender.toString() != "NoWorkFlow" && sender.toString() != "NoWorkFlowprint") && !(this.IsPOs && sender.toString() == "SaveonHold") && !(this.ButtonRevise.Visible && sender.toString() == "Revise") && (!this.ButtonSave.Visible || !this.ButtonSave.Enable) && !this.IsBidVisible) // IsBidVisible added by wajid we skip this condtion because Revise.visible is false and sender is "Revise" and btnSave.Visible is false (we need to skip this condition for posting Counter and Reverse bidding)
            return;

        if (this.ScreenObject.Preferences.ContainsKey("NoWorkflowPostedDocs") && this.ScreenObject.Preferences["NoWorkflowPostedDocs"] != "" && parseBoolean(this.ScreenObject.Preferences["NoWorkflowPostedDocs"])
            && this.StatusID == 369 && sender.toString() == "Save" && !this.LineWiseApproval)
            sender = "NoWorkFlow";

        if (this.ScreenObject.RefNodeID != 0 && !(this.ScreenObject.RefCCId == 86 || this.ScreenObject.RefCCId == 73 || this.ScreenObject.RefCCId == 89 || BaseService.SessionManager.IsActionAssigned(43, "Edit Reference Documents") || BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Reference Documents"))) {
            this.DisplayMessage = BaseService.GetResource("RefDocument");
            return;
        }

        if (this.ScreenObject.DocID > 0 && this.IsUserLock) {
            this.DisplayMessage = "Document is Locked";
            return;
        }

        if (this.ScreenObject.DocumentType == 56) {
            if (this.LoanGuaranteeVisible && (this.dtLoanGuarantees == null || this.dtLoanGuarantees.length == 0)) {
                this.DisplayMessage = "Loan Guarantee is Mandatory";
                return;
            }
        }

        if (this.ScreenObject.Preferences.ContainsKey("Linksingledoc") && this.ScreenObject.Preferences["Linksingledoc"] != "" && parseBoolean(this.ScreenObject.Preferences["Linksingledoc"])) {
            let drrows = this.ScreenObject.GridData.filter(x => x.LinkedInvDocDetailsID > 0);
            drrows.sort((a, b) => a.RefNo > b.RefNo ? 1 : -1);
            if (drrows.length > 0) {
                let refno = drrows[0]["RefNo"].toString();
                for (let i = 0; i < drrows.length; i++) {
                    if (refno != drrows[i]["RefNo"]) {
                        this.DisplayMessage = "Can link only one document";
                        return;
                    }
                }
            }
        }
        this.ButtonsEnabled = false;
        this.SaveInventoryDocument(sender, true).then((val) => {
            if (!val)
                this.ButtonsEnabled = true;
        });
    }

    DistributeFooter(Validate: boolean, calcTotals: boolean = false): boolean {
        let footercolsused: string[] = [];
        for (let k = 0; k < this.ScreenObject.FooterGridData.length; k++) {
            if (Validate && !Util.IsEmpty(this.ScreenObject.FooterGridData[k]["ColumnName"])) {
                if (!this.ValidateFooterDataonSave(this.ScreenObject.FooterGridData[k]))
                    return false;
            }
            let FooterVal = 0;
            let FCol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == this.ScreenObject.FooterGridData[k]["ColumnName"]);
            FooterVal = Util.Double(this.ScreenObject.FooterGridData[k]["Amount"]);
            if (FCol != null) {
                footercolsused.push(FCol.DisplayMember);
                //DistributeValues(FCol.DisplayMember, FooterVal, (FCol.DistributeColName != "") ? FCol.DistributeColName : "Gross");
                if (this.ScreenObject.FooterColumnSource.length > 3 && this.ScreenObject.FooterColumnSource[3].IsVisible && Util.Int(this.ScreenObject.FooterGridData[k]["DebitAccount"]) > 0)
                    FCol.DebitAccount = parseInt(this.ScreenObject.FooterGridData[k]["DebitAccount"]);
                if (this.ScreenObject.FooterColumnSource.length > 4 && this.ScreenObject.FooterColumnSource[4].IsVisible && Util.Int(this.ScreenObject.FooterGridData[k]["CreditAccount"]) > 0)
                    FCol.CreditAcount = parseInt(this.ScreenObject.FooterGridData[k]["CreditAccount"]);
                if (!Util.IsEmpty(this.ScreenObject.FooterGridData[k]["Remarks"]))
                    FCol.Remarks = this.ScreenObject.FooterGridData[k]["Remarks"].toString();

                for (let h = 0; h < this.ScreenObject.GridData.length; h++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[h]["ProductID_Key"]))
                        this.ScreenObject.GridData[h][FCol.DisplayMember] = FooterVal;
                }
                FooterVal = Util.Double(this.ScreenObject.FooterGridData[k]["CalcAmount"]);
                if (this.ScreenObject.FooterGridData[k]["IsCalculated"].toString() == "3")
                    this.DistributeValues("dcCalc" + FCol.DisplayMember, FooterVal, (!Util.IsEmpty(FCol.DistributeColName)) ? FCol.DistributeColName : "Gross", true);
                else
                    this.DistributeValues("dcCalc" + FCol.DisplayMember, FooterVal, (!Util.IsEmpty(FCol.DistributeColName)) ? FCol.DistributeColName : "Gross", false);
            }
        }
        if (!this.ScreenObject.FooterColumnSource[1].ReadOnly) {
            let footercols = this.ScreenObject.ColumnSource.filter(a => a.SectionID == 4);
            footercols.forEach(item => {
                if (!footercolsused.Contains(item.DisplayMember)) {
                    for (let h = 0; h < this.ScreenObject.GridData.length; h++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[h]["ProductID_Key"])) {
                            this.ScreenObject.GridData[h][item.DisplayMember] = 0;
                            this.ScreenObject.GridData[h]["dcCalc" + item.DisplayMember] = 0;
                        }
                    }
                }
            });
        }

        if (calcTotals) {
            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                    this.CalculateTotals(this.ScreenObject.GridData[i], false);
                }
            }
        }
        return true;
    }

    AutoAdjustbatches(IgnoreBatches: boolean, AutoBatches: boolean) {
        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (Util.String(this.ScreenObject.GridData[i]["ProductID_Key"]) == "")
                continue;
            let qt = 0;

            if (this.ScreenObject.Preferences.ContainsKey("ExcludeHold") && !Util.IsEmpty(this.ScreenObject.Preferences["ExcludeHold"]) && parseBoolean(this.ScreenObject.Preferences["ExcludeHold"])
                && this.ScreenObject.GridDataColumns.Contains("HoldQuantity")) {
                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["HoldQuantity"]) && parseFloat(this.ScreenObject.GridData[i]["HoldQuantity"].toString()) > 0)
                    qt = parseFloat(this.ScreenObject.GridData[i]["HoldQuantity"].toString());
                else
                    qt = 0;
            }

            if (this.ScreenObject.Preferences.ContainsKey("ExcludeReserve") && !Util.IsEmpty(this.ScreenObject.Preferences["ExcludeReserve"]) && parseBoolean(this.ScreenObject.Preferences["ExcludeReserve"])
                && this.ScreenObject.GridDataColumns.Contains("ReserveQuantity")) {
                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ReserveQuantity"]) && parseFloat(this.ScreenObject.GridData[i]["ReserveQuantity"].toString()) > 0)
                    qt = parseFloat(this.ScreenObject.GridData[i]["ReserveQuantity"].toString());
                else
                    qt = 0;
            }

            if (this.DocumentType == 32) {
                let VarFldName = "";
                var fld: any = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["VarienceField"]);
                if (fld != null && fld != undefined)
                    VarFldName = fld.DisplayMember;

                if (VarFldName != "" && this.ScreenObject.GridDataColumns.Contains(VarFldName) && !Util.IsEmpty(this.ScreenObject.GridData[i][VarFldName])) {
                    qt = parseFloat(Util.String(this.ScreenObject.GridData[i][VarFldName]).Replace("-", ""));
                }
            }

            if (Util.String(this.ScreenObject.GridData[i]["Type"]) == "8" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "3")
                this.FillAutoBatchesforDynamic(i);

            if (((AutoBatches && Util.String(this.ScreenObject.GridData[i]["ExtraXML"]) == '') || (!this.DonotUpdateInventory || qt > 0)) && !Util.IsEmpty(this.ScreenObject.GridData[i]["Type"]) && parseInt(this.ScreenObject.GridData[i]["Type"].toString()) == 5
                && !(this.ScreenObject.Preferences.ContainsKey("SameBatchtoall") && this.ScreenObject.Preferences["SameBatchtoall"].toLowerCase() == "true")
                && !(IgnoreBatches && this.ScreenObject.Preferences.ContainsKey("BatchBasedon") && this.ScreenObject.Preferences["BatchBasedon"] != "")
                && ((!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"].toString()) > 0)
                    || qt > 0 || this.DocumentType == 32 || (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(this.ScreenObject.GridData[i]["FreeQTY"]) && parseFloat(this.ScreenObject.GridData[i]["FreeQTY"].toString()) > 0))) {

                if (this.VoucherType == -1 && ((this.ScreenObject.Preferences.ContainsKey("AutoBatches") && !Util.IsEmpty(this.ScreenObject.Preferences["AutoBatches"]) && parseBoolean(this.ScreenObject.Preferences["AutoBatches"])
                    && (Util.String(this.ScreenObject.GridData[i]["DocDetailsID"]) == '' || parseInt(Util.String(this.ScreenObject.GridData[i]["DocDetailsID"])) == 0)) || (AutoBatches && Util.String(this.ScreenObject.GridData[i]["ExtraXML"]) == ''))) {
                    let div = 0, loc = 0;
                    if (this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])) {
                        var ccfld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
                        if (ccfld != null && ccfld != undefined && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0)
                            loc = ccfld.SelectedValue;
                        else if (this.ScreenObject.GridDataColumns.Contains("dcCCNID2_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID2_Key"]))
                            loc = parseInt(this.ScreenObject.GridData[i]["dcCCNID2_Key"].toString());
                    }
                    else if (this.ScreenObject.LocationID > 0)
                        loc = this.ScreenObject.LocationID;
                    else
                        loc = BaseService.SessionManager.LocationID;
                    if (this.ScreenObject.DivisionID > 0)
                        div = this.ScreenObject.DivisionID;
                    else
                        div = BaseService.SessionManager.DivisionID;


                    if (qt == 0) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"].toString()) > 0)
                            qt = parseFloat(this.ScreenObject.GridData[i]["Quantity"].toString());
                        if (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(this.ScreenObject.GridData[i]["FreeQTY"])
                            && parseFloat(this.ScreenObject.GridData[i]["FreeQTY"].toString()) > 0)
                            qt = parseFloat(this.ScreenObject.GridData[i]["FreeQTY"].toString());


                        if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && !Util.IsEmpty(this.ScreenObject.GridData[i]["UOMConversion"]))
                            qt = qt * parseFloat(this.ScreenObject.GridData[i]["UOMConversion"].toString());
                    }

                    let objbat = new BatchNumberViewModel(this.ScreenObject.GridDataObj);
                    objbat.BatchNumberViewModel_3(this, this.VoucherType, qt, parseInt(this.ScreenObject.GridData[i]["ProductID_Key"].toString()), this.ScreenObject.GridData[i]["ProductName"].toString(), loc, div, this.ScreenObject.GridData[i]);
                    {
                        objbat.ChkFifo = true;
                        objbat.OnSave("AutoSave");
                        if (objbat.count > 1)
                            this.ScreenObject.UpdateSequence();
                    }
                }
            }

        }
    }
    public FillPaytermDt(AccID:number, Cr:number, Db:number, Amt:string, dr,fldname:string, decimals:string)
    {
        if (this.Paytermsdt == null)
            return;
 
        if (AccID != Cr && AccID != Db)
            return;
 
        if (Util.IsEmpty(decimals))
            decimals = "2";
 
        let IsVat = false;
        if (fldname.toLowerCase().startsWith("dcnum"))
        {
            let fldno = Util.Int(fldname.toLowerCase().Replace("dcnum", ""));
            if (fldno > 51 && fldno < 62)
                IsVat = true;
        }
        let temp = parseFloat(Amt);
 
        if (AccID == Cr)
            temp = parseFloat((temp * -1).ToString("N" + decimals));
 
            let nodeid = 1;
        if (dr[this.PaytermDimCol].toString() != "")
            nodeid = parseInt(dr[this.PaytermDimCol].toString());
 
        let payRows = this.Paytermsdt.filter(x=>x.DimID == nodeid);
        if (payRows.length > 0)
        {
            if (IsVat)
                payRows[0]["VatAmt"] = parseFloat(payRows[0]["VatAmt"].toString()) + temp;
            else
                payRows[0]["Amt"] = parseFloat(payRows[0]["Amt"].toString()) + temp;
        }
        else if (this.BillWisedtColumns.length > 0)
        {
            let payDr = {};
            payDr["DimID"] = nodeid;
            payDr["DimName"] = dr[this.PaytermDimCol.Replace("_Key", "")].toString();
            if (IsVat)
            {
                payDr["VatAmt"] = temp;
                payDr["Amt"] = 0;
            }
            else
            {
                payDr["VatAmt"] = 0;
                payDr["Amt"] = temp;
            }
            this.Paytermsdt.push(payDr);
        }
    }
 
    fillPaytermsdt()
    {
        let CurrencyID = 1;
        let ExchangeRate = 1;
 
        let accid = 0;
        if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 39 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 6 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 13)
        {
            if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0)
                accid = this.ScreenObject.CreditAccount.SelectedValue;
        }
        else if (this.ScreenObject.DocumentType == 11 || this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 5 || this.ScreenObject.DocumentType == 7 || this.ScreenObject.DocumentType == 9 || this.ScreenObject.DocumentType == 24 || this.ScreenObject.DocumentType == 33 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 8 || this.ScreenObject.DocumentType == 12)
        {
            if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0)
                accid = this.ScreenObject.DebitAccount.SelectedValue;
        }
 
        for(let i = 0; i < this.ScreenObject.GridData.length; i++)
        {
            for(let j = 0; j < this.ScreenObject.ColumnSource.length; j++)
            {
                let TempVal;
                CurrencyID = this.GetCurrencyID(i);
                ExchangeRate = this.GetExchRate(this.ScreenObject.GridData[i]);
 
                if (this.ScreenObject.ColumnSource[j].SectionID == 3 && ((this.ScreenObject.ColumnSource[j].PostingType == 3 || this.ScreenObject.ColumnSource[j].PostingType == 4)))
                {
                    let Amount = this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString();
                    if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcnum"))
                    {
                        Amount = this.ScreenObject.GridData[i]["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("dcExchRT" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Replace("dcnum", "").toString()) && this.ScreenObject.GridDataColumns.Contains("dcCurrID" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Replace("dcnum", "").toString() + "_Key") && this.ScreenObject.GridData[i]["dcCurrID" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Replace("dcnum", "").toString() + "_Key"].toString() != "")
                        {
                            CurrencyID = parseInt(this.ScreenObject.GridData[i]["dcCurrID" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Replace("dcnum", "").toString() + "_Key"].toString());
                            ExchangeRate = parseFloat(this.ScreenObject.GridData[i]["dcExchRT" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Replace("dcnum", "").toString()].toString());
                        }
                    }
 
                    if (Amount != ""  && parseFloat(Amount) != 0)
                    {
                        let DBAcc = 0, CrACC = 0;
 
                        if (this.ScreenObject.ColumnSource[j].DebitAccount > 0)
                            DBAcc = this.ScreenObject.ColumnSource[j].DebitAccount;
                        else if (this.ScreenObject.DebitAccount != null)
                            DBAcc = this.ScreenObject.DebitAccount.SelectedValue;
                        else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && this.ScreenObject.GridData[i]["DebitAccount_Key"].toString() != "")
                            DBAcc = parseInt(this.ScreenObject.GridData[i]["DebitAccount_Key"].toString());
 
                        if (this.ScreenObject.ColumnSource[j].CreditAcount > 0)
                            CrACC = this.ScreenObject.ColumnSource[j].CreditAcount;
                        else if (this.ScreenObject.CreditAccount != null)
                            CrACC = this.ScreenObject.CreditAccount.SelectedValue;
                        else if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && this.ScreenObject.GridData[i]["CreditAccount_Key"].toString() != "")
                            CrACC = parseInt(this.ScreenObject.GridData[i]["CreditAccount_Key"].toString());
 
                        this.FillPaytermDt(accid, CrACC, DBAcc, Amount, this.ScreenObject.GridData[i], this.ScreenObject.ColumnSource[j].DisplayMember, this.ScreenObject.ColumnSource[j].DecimalPoints);
                    }
                }
            }
        }
    }
    SaveDocument() {
        this.SaveInventoryDocument(this.SaveCallReq.sender, this.SaveCallReq.Validate, this.SaveCallReq.CheckStock
            , this.SaveCallReq.CallType, this.SaveCallReq.AutoBatches, this.SaveCallReq.IgnoreBatches, true)
    }

    public SaveCallReq: any = { Validate: true };
    async SaveInventoryDocument(sender: any, Validate: boolean = false, CheckStock: boolean = true, CallType: string = null, AutoBatches: boolean = false, IgnoreBatches: boolean = false, IsIgnoreOnSave = false): Promise<any> {
        ;
        CallType = "SYNC_SAVE";
        this.SaveCallReq.sender = sender
        this.SaveCallReq.Validate = Validate
        this.SaveCallReq.CheckStock = CheckStock
        this.SaveCallReq.CallType = CallType
        this.SaveCallReq.AutoBatches = AutoBatches
        this.SaveCallReq.IgnoreBatches = IgnoreBatches
        console.log("SaveInventoryDocument In");
        Logger.InfoLog("AddEditDocumentViewModel::Entering OnSaveAccount");
        try {
            if (this.ScreenObject.BulkSaveon > 0) {
                let TotCnt: any = this.ScreenObject.GridData.filter(x => x.ProductID_Key > 0).Compute("count", "ProductID_Key");//.Compute("COUNT(ProductID_Key)", "ProductID_Key>0 ");
                if (TotCnt == null)
                    TotCnt = 0;
                if (parseInt(TotCnt) > this.ScreenObject.BulkSaveon)
                    this.savebulk = true;
                else
                    this.savebulk = false;
            }
            if (this.ScreenObject.Preferences.ContainsKey("LinkAll") && this.ScreenObject.Preferences["LinkAll"] != "" && parseBoolean(this.ScreenObject.Preferences["LinkAll"])

                && this.ScreenObject.Link != null && this.ScreenObject.Link.DocumentList != null && this.ScreenObject.Link.DocumentList.Items.length > 0) {
                this.ScreenObject.Link.DocumentList.Items.forEach(item => {
                    if (!item.IsChecked || this.ScreenObject.GridData.filter(x => x.RefNo == item.Name).length == 0) {
                        this.DisplayMessage = "Link all Documents";
                        return false;
                    }
                    return true
                });
            }

            if (!IsIgnoreOnSave)
                this.BillWisedt.Clear();
            if (this.Paytermsdt != null)
               this.Paytermsdt.Clear();
            /**
                        if ((BaseService.SessionManager.IsWebApplication) && this.BillWisedtColumns.length == 0)
                        {
                            this.BillWisedtColumns.push("AccountID");//, typeof(long));
                            this.BillWisedtColumns.push("Amount");//, typeof(double));
                            this.BillWisedtColumns.push("IsCredit");//, typeof(bool));
                            this.BillWisedtColumns.push("CurrencyID");//, typeof(long));
                            this.BillWisedtColumns.push("ExchangeRate");//, typeof(double));
                            this.BillWisedtColumns.push("XML");
                            this.BillWisedtColumns.push("FromTo");
                            this.BillWisedtColumns.push("AccountName");
                            this.BillWisedtColumns.push("DocXML");
                            this.BillWisedtColumns.push("Decimal");
                        }*/

            if (Validate && this.ScreenObject.Preferences.ContainsKey("MadatoryAttachments") && this.ScreenObject.Preferences["MadatoryAttachments"] != "" && parseBoolean(this.ScreenObject.Preferences["MadatoryAttachments"])
                && (this.ViewAttachments == null || this.ViewAttachments.AttachmentsList.length == 0)) {
                this.DisplayMessage = "No Attachments added.";
                return false;
            }

            let DonotUpdateAccounts = true, DontSaveValueZero = false, DontSaveRateZero = false, DontSaveQtyIsZero = false, DontSaveQtyIsNegative = true;

            if (this.ScreenObject.Preferences.ContainsKey("DonotupdateAccounts")) {
                if (this.ScreenObject.Preferences["DonotupdateAccounts"] != "")
                    DonotUpdateAccounts = parseBoolean(this.ScreenObject.Preferences["DonotupdateAccounts"]);
            }
            if (this.ScreenObject.Preferences.ContainsKey("DonotupdateInventory")) {
                if (this.ScreenObject.Preferences["DonotupdateInventory"] != "")
                    this.DonotUpdateInventory = parseBoolean(this.ScreenObject.Preferences["DonotupdateInventory"]);
            }
            if (this.donotupInv != null)
                this.DonotUpdateInventory = this.donotupInv.IsChecked;
            if (this.ScreenObject.Preferences.ContainsKey("DonotUpdateSchemeQty")) {
                if (this.ScreenObject.Preferences["DonotUpdateSchemeQty"] != "")
                    this.DonotUpdateSchemeQty = parseBoolean(this.ScreenObject.Preferences["DonotUpdateSchemeQty"]);
            }
            if (this.ScreenObject.Preferences.ContainsKey("DontSaveIf_ValueZero")) {
                if (this.ScreenObject.Preferences["DontSaveIf_ValueZero"] != "")
                    DontSaveValueZero = parseBoolean(this.ScreenObject.Preferences["DontSaveIf_ValueZero"]);
            }
            if (this.ScreenObject.Preferences.ContainsKey("DontSaveIf_RateZero")) {
                if (this.ScreenObject.Preferences["DontSaveIf_RateZero"] != "")
                    DontSaveRateZero = parseBoolean(this.ScreenObject.Preferences["DontSaveIf_RateZero"]);
            }
            if (this.ScreenObject.Preferences.ContainsKey("DontSaveIf_QtyIsZero")) {
                if (this.ScreenObject.Preferences["DontSaveIf_QtyIsZero"] != "")
                    DontSaveQtyIsZero = parseBoolean(this.ScreenObject.Preferences["DontSaveIf_QtyIsZero"]);
            }
            if (this.ScreenObject.Preferences.ContainsKey("DontSaveIf_QtyIsNegative")) {
                if (this.ScreenObject.Preferences["DontSaveIf_QtyIsNegative"] != "")
                    DontSaveQtyIsNegative = parseBoolean(this.ScreenObject.Preferences["DontSaveIf_QtyIsNegative"]);
            }

            if (this.ScreenObject.IsForecast) {
                let strErr: string = this.ScreenObject.ForecastObj.Validate();
                if (strErr.length > 0) {
                    this.DisplayMessage = strErr;
                    return false;
                }
            }

            if (Validate && this.ScreenObject.DocumentType == 30 && this.ScreenObject.GridDataColumns.Contains("VoucherType") && this.ScreenObject.Preferences.ContainsKey("DontSaveIssueRctequal") && this.ScreenObject.Preferences["DontSaveIssueRctequal"] != "" && parseBoolean(this.ScreenObject.Preferences["DontSaveIssueRctequal"])) {
                let TotIss = this.ScreenObject.GridData.filter(x => x.ProductID_Key > 0 && x.VoucherType == -1).Compute("sum", "Quantity");
                let TotRcv = this.ScreenObject.GridData.filter(x => x.ProductID_Key > 0 && x.VoucherType == 1).Compute("sum", "Quantity");
                if (TotRcv == null)
                    TotRcv = 0;
                if (TotIss == null)
                    TotRcv = 0;
                let totiss = parseFloat(TotIss).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinQty"]);
                let totrcv = parseFloat(TotRcv).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinQty"]);
                if (TotIss == null && TotRcv == null) {

                }
                else if (totiss.toString() != totrcv.toString()) {
                    this.DisplayMessage = BaseService.GetResource("IssRcvarenotEqual");
                    return false;
                }
            }

            if (this.ScreenObject.Preferences.ContainsKey("DocQtyAdjustment") && !Util.IsEmpty(this.ScreenObject.Preferences["DocQtyAdjustment"]) && parseBoolean(this.ScreenObject.Preferences["DocQtyAdjustment"])) {
                if (Validate) {
                    //ShellWindowViewModel.Instance().PopViewModel = new FieldCalculatorViewModel(this, -1);
                    if (this.isBidding) {
                        let FldC = new FieldCalculatorViewModel(this, -1)
                        FldC.OnButtonClick("OK");
                    }
                    else {
                        if (!this.IgnoreOnSave.ContainsKey("DocQtyAdjustment")) {
                            this.IgnoreOnSave["ACTION"] = "DocQtyAdjustment";
                            this.IgnoreOnSave.push("DocQtyAdjustment", "DocQtyAdjustment");
                            let FC = new FieldCalculatorViewModel(this, -1);
                            FC.DocQtyAdjustment = true;
                            BaseService.page.ShowDialog(FC, FieldCalculatorComponent, { ShowCenter: true });
                            return false;
                        }
                    }
                }
                else {
                    //using (FieldCalculatorViewModel FldC = new FieldCalculatorViewModel(this, -1))
                    let FldC = new FieldCalculatorViewModel(this, -1)
                    FldC.OnButtonClick("OK");
                }
            }

            if (this.ScreenObject.DocumentType == 81)//Assign Leaves
            {
                /* if (this.DocID == 0) {
                    for (let i = 0; i < this.ScreenObject._CCFields.length; i++) {
                        let cc: PactControlData = this.ScreenObject._CCFields[i]
                        if (cc instanceof PactListBoxData && cc.CCID == 50002) {
                            if (cc.SelectedValue > 0) {
                                this.dtData = null;
                                let ALfld1 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                                if (ALfld1 && ALfld1 instanceof PactComboBoxData && !Util.IsEmpty(ALfld1.SelectedValue))
                                    this.LoadGradeData(this.DocID > 0 ? 1 : 2, new Date(), "GradeWiseCopy");
                                break;
                            }
                        }
                    }
                } */

                if (this.dtData != null && this.dtData.length > 0) {
                    let ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                    if (ALfld && ALfld instanceof PactComboBoxData && Util.IsEmpty(ALfld.SelectedValue)) {
                        this.DisplayMessage = "Please select the Year";
                        return false;
                    }
                    let dtLeaveYear = new Date(parseInt((ALfld as PactComboBoxData).SelectedValue), parseInt(BaseService.SessionManager.Preferences["LeaveYear"]), 1);
                    let RowPos = 0;
                    ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                    if (ALfld && ALfld instanceof PactComboBoxData) {
                        if (ALfld.SelectedValue.toString() != "EmployeeWise") {
                            for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                                if (this.ScreenObject.GridData[k]["ProductID_Key"] != null) {
                                    for (let j = 0; j < this.dtData.length; j++) {
                                        if (parseFloat(this.ScreenObject.GridData[k]["dcCCNID53_Key"]) == parseFloat(this.dtData[j]["dcCCNID53_Key"]) && parseFloat(this.ScreenObject.GridData[k]["dcCCNID52_Key"]) == parseFloat(this.dtData[j]["dcCCNID52_Key"]))
                                            this.dtData[j]["dcNum3"] = parseFloat(this.ScreenObject.GridData[k]["dcNum3"]);
                                    }
                                }
                                RowPos = k;
                            }
                        }
                        else {
                            RowPos = this.ScreenObject.GridData.length - 1;
                        }
                    }

                    let drr = this.ScreenObject.GridData.filter(x => Util.IsEmpty(x.ProductID_Key) || x.ProductID_Key == 0);
                    if (drr.length > 0) {
                        drr.forEach(drtoDelete => {
                            this.ScreenObject.GridDataObj.removeRow(drtoDelete);
                        });
                    }

                    RowPos = RowPos + 2;
                    let dtDOJ = new Date();
                    let dblAdd = 0;
                    let drcE: any[] = null;
                    let drcStr: any[] = null;

                    let dtStr = BaseService.common.GetDataTable("DOC070", "");
                    let drLeaveyear: any = null;
                    for (let i = 0; i < this.dtData.length; i++) {
                        let drGrid = this.ScreenObject.GridDataObj.NewRow();
                        this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPos + i);
                        drGrid["ProductID_Key"] = parseInt(BaseService.SessionManager.Preferences["PayrollProduct"]);
                        drGrid["Unit_Key"] = 1;
                        drGrid["dcCCNID51_Key"] = this.dtData[i]["dcCCNID51_Key"].toString();
                        drGrid["dcCCNID52_Key"] = this.dtData[i]["dcCCNID52_Key"].toString();
                        drGrid["dcCCNID53_Key"] = this.dtData[i]["dcCCNID53_Key"].toString();

                        dblAdd = parseFloat(this.dtData[i]["dcNum3"]);

                        if (BaseService.SessionManager.Preferences.ContainsKey("ConsiderGlobalPreferencesBasedOnGrade") && BaseService.SessionManager.Preferences["ConsiderGlobalPreferencesBasedOnGrade"] == "True") {
                            drLeaveyear = this.dtPayLeaveYear.filter(x => x.GradeID == this.dtData[i]["dcCCNID53_Key"].toString());
                            if (drLeaveyear != null && drLeaveyear.length > 0) {
                                ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                                if (ALfld && ALfld instanceof PactComboBoxData && Util.IsEmpty(ALfld.SelectedValue)) {
                                    dtLeaveYear = new Date(parseInt((ALfld as PactComboBoxData).SelectedValue), parseInt(drLeaveyear[0]["Value"].toString()), 1);
                                }
                            }
                        }

                        //Check DOJ And Assign Leaves
                        if (parseInt(drGrid["dcCCNID51_Key"]) > 0) {

                            if (this.dtPayEmps != null && this.dtPayEmps.length > 0) {
                                drcE = this.dtPayEmps.filter(x => x.NodeID == drGrid["dcCCNID51_Key"]);
                                if (drcE != null && drcE.length > 0) {
                                    if (dtStr != null && dtStr.length > 0) {
                                        drcStr = dtStr.filter(x => x.GradeID == drGrid["dcCCNID53_Key"] && x.ComponentID == drGrid["dcCCNID52_Key"]);//, "PayrollDate DESC");
                                        drcStr = drcStr.sort((a, b) => a.PayrollDate > b.PayrollDate ? 1 : -1);
                                    }

                                    if (drcStr != null && drcStr.length > 0 && Util.String(drcStr[0]["AccrualInProbation"]) == "No") {
                                        if (!Util.IsEmpty(drcE[0]["DOC"])) {
                                            if (!Util.IsEmpty(drcE[0]["DOC"]))
                                                dtDOJ = Util.ParseDate(drcE[0]["DOC"]);
                                            else
                                                dtDOJ = Util.ParseDate("01-Jan-1900");

                                            if (dtDOJ > dtLeaveYear) {
                                                //let MonthsDiff = 12 - (dtDOJ.iMonth() - dtLeaveYear.iMonth());
                                                let MonthsDiff;
                                                if (BaseService.SessionManager.Preferences.ContainsKey("AccrueLeavesonlyiftheConfirmationDateisLessby") && BaseService.SessionManager.Preferences["AccrueLeavesonlyiftheConfirmationDateisLessby"] != "" && parseInt(BaseService.SessionManager.Preferences["AccrueLeavesonlyiftheConfirmationDateisLessby"]) > 0) {
                                                    let ADays = parseInt(BaseService.SessionManager.Preferences["AccrueLeavesonlyiftheConfirmationDateisLessby"]);
                                                    if (dtDOJ.getDate() < ADays) {
                                                        MonthsDiff = 12 - (dtDOJ.iMonth() - dtLeaveYear.iMonth());
                                                    }
                                                    else
                                                        MonthsDiff = 12 - ((dtDOJ.iMonth() - dtLeaveYear.iMonth()) + 1);
                                                }
                                                else
                                                    MonthsDiff = 12 - (dtDOJ.iMonth() - dtLeaveYear.iMonth());
                                                if (MonthsDiff > 0 && dtDOJ.getFullYear() == dtLeaveYear.getFullYear()) {
                                                    dblAdd = (dblAdd * MonthsDiff) / 12;
                                                    //dblAdd = Math.round(dblAdd);
                                                }
                                                else
                                                    dblAdd = 0;
                                            }
                                        }
                                    }
                                    else if (drcStr != null && drcStr.length > 0 && !Util.IsEmpty(drcStr[0]["LeaveOthFeatures"]) && drcStr[0]["LeaveOthFeatures"].toString().toUpperCase().Contains("#NONPRORATED#")) {
                                        drGrid["dcNum3"] = dblAdd.toString();
                                        continue;
                                    }
                                    else {
                                        if (!Util.IsEmpty(drcE[0]["DOJ"]))
                                            dtDOJ = Util.ParseDate(drcE[0]["DOJ"]);
                                        else
                                            dtDOJ = Util.ParseDate("01-Jan-1900");

                                        if (dtDOJ > dtLeaveYear) {
                                            let MonthsDiff = 12 - (dtDOJ.iMonth() - dtLeaveYear.iMonth());
                                            if (MonthsDiff > 0) {
                                                dblAdd = (dblAdd * MonthsDiff) / 12;
                                                //dblAdd = Math.round(dblAdd);
                                            }
                                            else
                                                dblAdd = 0;
                                        }
                                    }
                                }
                            }
                        }

                        drGrid["dcNum3"] = dblAdd.toString();
                        //drGrid["dcNum3"] = dtData[i]["dcNum3"].toString();

                    }
                    this.ScreenObject.GridDataObj.refreshDataView();
                    this.ScreenObject.UpdateSequence();
                    this.RefreshGrid = true;
                    if (this.dtData.length > 0)
                        this.dtData.Clear();
                }
            }

            if (this.IsNewAssignLeave) {
                let ALfld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                if (ALfld != undefined && ALfld instanceof PactComboBoxData && Util.String(ALfld.SelectedValue) == "") {
                    this.DisplayMessage = "Please select the Year";
                    this.MessageVisibility = true;
                    return false;
                }
                let dtLeaveYear = new Date(parseInt(ALfld.SelectedValue), parseInt(BaseService.SessionManager.Preferences["LeaveYear"].toString()), 1);
                let RowPos = 0;
                ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                if (ALfld != undefined && ALfld instanceof PactComboBoxData) {
                    if (ALfld.SelectedValue.toString() != "EmployeeWise") {
                        for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                            if (this.ScreenObject.GridData[k]["ProductID_Key"] != null) {
                                for (let j = 0; j < this.dtData.length; j++) {
                                    let dr = this.dtALeaveComp.filter(x => x.ComponentID == this.dtData[j]["dcCCNID52_Key"]);
                                    if (parseFloat(this.ScreenObject.GridData[k]["dcCCNID53_Key"]) == parseFloat(this.dtData[j]["dcCCNID53_Key"]) && this.ScreenObject.GridDataColumns.Contains("dcNum" + dr[0]["SNo"].toString())) {
                                        if (this.ScreenObject.GridData[k]["dcNum" + dr[0]["SNo"].toString()] != null && this.ScreenObject.GridData[k]["dcNum" + dr[0]["SNo"].toString()] != "" && this.ScreenObject.GridData[k]["dcNum" + dr[0]["SNo"].toString()] != null)
                                            this.dtData[j]["dcNum3"] = parseFloat(this.ScreenObject.GridData[k]["dcNum" + dr[0]["SNo"].toString()]);
                                    }
                                }
                            }
                            RowPos = k;
                        }
                    }
                    else {
                        RowPos = this.ScreenObject.GridData.length - 1;
                    }
                }

                let drr = this.ScreenObject.GridData.filter(x => x.ProductID_Key == 0 || x.ProductID_Key == null);//("isnull(ProductID_Key,0)=0");
                if (drr.length > 0) {
                    drr.forEach(drtoDelete => {
                        this.ScreenObject.GridData.Remove(drtoDelete);
                    });
                }

                RowPos = RowPos + 2;
                let dtDOJ = new Date();
                let dblAdd = 0;
                let drcE = null;

                let dtDistEmp = this.dtData.ToTable(true, ["dcCCNID51_Key"]);

                for (let i = 0; i < dtDistEmp.length; i++) {
                    let dr1 = this.dtData.filter(x => x.dcCCNID51_Key == dtDistEmp[i]["dcCCNID51_Key"]);
                    if (dr1 != null && dr1.length > 0) {
                        let drGrid = this.ScreenObject.GridDataObj.NewRow();
                        this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPos + i);
                        drGrid["ProductID_Key"] = parseInt(BaseService.SessionManager.Preferences["PayrollProduct"]);
                        drGrid["Unit_Key"] = 1;
                        drGrid["dcCCNID51_Key"] = dr1[0]["dcCCNID51_Key"].toString();
                        drGrid["dcCCNID53_Key"] = dr1[0]["dcCCNID53_Key"].toString();

                        for (let k = 0; k < dr1.length; k++) {
                            let drC = this.dtALeaveComp.filter(x => x.ComponentID == dr1[k]["dcCCNID52_Key"]);
                            dblAdd = parseFloat(dr1[k]["dcNum3"]);

                            //Check DOJ And Assign Leaves
                            if (parseInt(drGrid["dcCCNID51_Key"]) > 0) {
                                if (this.dtPayEmps != null && this.dtPayEmps.length > 0) {
                                    drcE = this.dtPayEmps.filter(x => x.NodeID == drGrid["dcCCNID51_Key"].toString());
                                    if (drcE != null && drcE.length > 0) {
                                        if (drcE[0]["DOJ"] != null && drcE[0]["DOJ"].toString() != "")
                                            dtDOJ = Util.ParseDate(drcE[0]["DOJ"]);
                                        else
                                            dtDOJ = Util.ParseDate("01-Jan-1900");

                                        if (dtDOJ > dtLeaveYear) {
                                            let MonthsDiff = 12 - (dtDOJ.iMonth() - dtLeaveYear.iMonth());
                                            if (MonthsDiff > 0) {
                                                dblAdd = (dblAdd * MonthsDiff) / 12;
                                                dblAdd = Math.round(dblAdd);//, 0);
                                            }
                                            else
                                                dblAdd = 0.0;
                                        }
                                    }
                                }
                            }

                            drGrid["dcNum" + drC[0]["SNo"].toString()] = dblAdd.toString();
                            //drGrid["dcNum3"] = dtData[i]["dcNum3"].toString();
                            this.ScreenObject.GridDataObj.updateRow(drGrid);
                        }
                    }
                }

                //this.ScreenObject.GridData.AcceptChanges();
                this.ScreenObject.UpdateSequence();
                this.RefreshGrid = true;
                if (this.dtData.length > 0)
                    this.dtData.Clear();
            }

            this.FillHeaderDictionary();

            if (Validate && !this.ValidateHeaderSave())
                return false;

            let ValidationMessage = "";

            if (this.DocumentType > 50) {
                //ButtonsEnabled = true;
                this.DisplayMessage = this.CheckDocumentValidations(ValidationMessage);
                if (this.DisplayMessage != "") {
                    if (this.strVacXml != "")
                        this.strVacXml = this.strVacXml + this.DisplayMessage;
                    return false;
                }
            } else if (this.DocumentType == 46) {
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {

                    let row = this.ScreenObject.GridData[k];

                    if (!Util.IsEmpty(row["ProductID_Key"])) {
                        if (!Util.IsEmpty(row["dcAlpha15_Key"]) && !Util.IsEmpty(row["dcAlpha16_Key"])) {
                            let startDate: Date = new Date(row["dcAlpha15_Key"]);
                            let endDate: Date = new Date(row["dcAlpha15_Key"]);
                            if (endDate < startDate) {
                                this.DisplayMessage = "To Date should be greater than start date at : " + row["DocSeqNo"] + "\r\n";
                                this.MessageVisibility = true;
                                return false;
                            }
                        }
                        else if (Util.IsEmpty(row["dcAlpha15_Key"])) {
                            this.DisplayMessage = "please select start date at : " + row["DocSeqNo"] + "\r\n";
                            this.MessageVisibility = true;
                            return false;
                        }
                        else if (Util.IsEmpty(row["dcAlpha16_Key"])) {
                            this.DisplayMessage = "please select end date at : " + row["DocSeqNo"] + "\r\n";
                            this.MessageVisibility = true;
                            return false;
                        }

                        if (!Util.IsEmpty(row["dcAlpha30"]) && !Util.IsEmpty(row["dcAlpha33"])) {
                            let actualHours: number = parseFloat(row["dcAlpha30"]);
                            let standardHours: number = parseFloat(row["dcAlpha33"]);
                            if (actualHours < standardHours) {
                                this.DisplayMessage = "Actual hours should be less than or equal to Standard hours at : " + row["DocSeqNo"] + "";
                                this.MessageVisibility = true;
                                return false;
                            }
                        }

                        if (BaseService.SessionManager.Preferences.ContainsKey("PMLevel1Dimension") && Util.DoubleTryParse(BaseService.SessionManager.Preferences["PMLevel1Dimension"]) > 0 && !Util.IsEmpty(row["UserID_Key"])) {
                            let UserID = parseInt(row["UserID_Key"]);

                            let ccid = Util.DoubleTryParse(BaseService.SessionManager.Preferences["PMLevel1Dimension"]);
                            let PhaseID = parseInt(row["dcCCNID" + (ccid - 50000) + "_Key"]);

                            if (UserID != 1) {
                                let groupPhaseExists: boolean = false;
                                let groupStartDate: Date = null;
                                let groupEndDate: Date = null;
                                for (let j = 0; j < this.ScreenObject.GridData.length; j++) {
                                    var potentialGrouprow = this.ScreenObject.GridData[j];

                                    if (Util.String(potentialGrouprow["ProductID_Key"]) != "" && parseInt(potentialGrouprow["dcCCNID" + (ccid - 50000) + "_Key"]) == PhaseID && (Util.IsEmpty(potentialGrouprow["UserID_Key"]) || Util.String(potentialGrouprow["UserID_Key"]) == "1")) {
                                        groupPhaseExists = true;
                                        break;
                                    }
                                }
                                if (!groupPhaseExists) {
                                    this.DisplayMessage = "Group Phase not Found for Task in Phase " + Util.String(row["dcCCNID" + (ccid - 50000)]) + "  at row no " + row["DocSeqNo"] + "";
                                    this.MessageVisibility = true;
                                    return false;
                                }
                            }
                        }
                    }
                }
            }

            if (Validate)
                this.FillCreatedByDate(sender.toString());

            let outmess = { message: ValidationMessage };
            let Footer = this.ScreenObject.GenerateQuery(outmess, DonotUpdateAccounts, this.DocumentDate, Validate, this.savebulk);
            ValidationMessage = outmess.message;
            if (this.ScreenObject.DebitAccount != null) {
                this.ScreenObject.strStaticFields += " DebitAccount=\"" + this.ScreenObject.DebitAccount.SelectedValue + "\" ";
            }
            if (this.ScreenObject.CreditAccount != null) {
                this.ScreenObject.strStaticFields += " CreditAccount=\"" + this.ScreenObject.CreditAccount.SelectedValue + "\" ";
            }

            if (ValidationMessage != "") {
                this.DisplayMessage = ValidationMessage;
                return false;
            }

            if (sender.toString() != "NoWorkFlowReSave" && this.ScreenObject.Preferences.ContainsKey("ReEvaluateBeforeSave") && this.ScreenObject.Preferences["ReEvaluateBeforeSave"] != ""
                && parseBoolean(this.ScreenObject.Preferences["ReEvaluateBeforeSave"])) {
                this.ReEvaluate(true, false);
            }
            if (sender.toString() != "NoWorkFlowReSave" && this.ScreenObject.Preferences.ContainsKey("ValidateSchemeBeforeSave") && this.ScreenObject.Preferences["ValidateSchemeBeforeSave"] != ""
                && parseBoolean(this.ScreenObject.Preferences["ValidateSchemeBeforeSave"])) {
                if (!this.ValidateSchemes())
                    return false;
            }

            //// SHIFT ASSIGN SAVE

            if (this.ScreenObject.DocumentType == 92) //SHIFT ASSIGN
            {
                return this.SaveShiftAssign();
            }

            //// END SHIFT ASSIGN SAVE

            this.AutoPOstXML = "";
            if (this.AutoPostViewModel != null && this.ScreenObject.Preferences.ContainsKey("Autopostdocument") && this.ScreenObject.Preferences["Autopostdocument"] != ""
                && Util.Int(this.ScreenObject.Preferences["Autopostdocument"]) && parseInt(this.ScreenObject.Preferences["Autopostdocument"]) > 40000) {
                this.AutoPostViewModel.RefreshGrid = true;
                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                        let drbomd = this.AutoPostViewModel.ScreenObject.GridData.filter(x => x.RefSeqNo == this.ScreenObject.GridData[i]["RefSeqNo"]);
                        if (drbomd.length > 0) {
                            let ExpFpQty = 0;
                            drbomd.forEach(sr => {
                                if (this.ScreenObject.Preferences.ContainsKey("ExpFPQTY") && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["ExpFPQTY"])) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.Preferences["ExpFPQTY"]]))
                                        ExpFpQty = parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.Preferences["ExpFPQTY"]]);
                                }
                                else if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]))
                                    ExpFpQty = parseFloat(this.ScreenObject.GridData[i]["Quantity"]);

                                if (!Util.IsEmpty(sr["defaultQuantity"]) && (ExpFpQty * parseFloat(sr["defaultQuantity"])) != parseFloat(sr["Quantity"])) {
                                    sr["Quantity"] = ExpFpQty * parseFloat(sr["defaultQuantity"]);
                                    if (!Util.IsEmpty(sr["Quantity"]) && !Util.IsEmpty(sr["UOMConversion"]) && Util.IsNum(sr["UOMConversion"])) {
                                        sr["UOMConvertedQty"] = Util.Double(sr["UOMConversion"]) * parseFloat(sr["Quantity"]);
                                    }
                                    else if (!Util.IsEmpty(sr["Quantity"]))
                                        sr["UOMConvertedQty"] = sr["Quantity"].toString();
                                    this.AutoPostViewModel.CalculateTotals(sr, false);
                                }
                            });
                            if (this.ScreenObject.Preferences.ContainsKey("Autopostdocument") && this.ScreenObject.Preferences["Autopostdocument"] != "" && this.ScreenObject.Preferences["Autopostdocument"] != "0") {
                                let qtyfld = this.AutoPostViewModel.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == this.ScreenObject.Preferences["FPQty"].toLowerCase());
                                if (qtyfld && qtyfld instanceof PactTextBoxData)
                                    qtyfld.Text = ExpFpQty.toString();
                            }
                        }
                    }
                }

                this.AutoPostViewModel.ScreenObject.UpdateSequence();
                this.AutoPostViewModel.ScreenObject.DocID = this.AutoPostDocID;
                this.AutoPostViewModel.OKCancelVisibility = true;
                this.AutoPostViewModel.parent = this;
                if (this.ScreenObject.Preferences.ContainsKey("DisplaydocbeforeSave") && this.ScreenObject.Preferences["DisplaydocbeforeSave"] != ""
                    && parseBoolean(this.ScreenObject.Preferences["DisplaydocbeforeSave"])) {
                    this.AutoPostViewModel.RefreshGrid = !this.AutoPostViewModel.RefreshGrid
                    this.AutoPostViewModel.DisplayMessage = "";
                    /**ShellWindowViewModel.Instance().PopViewModel = this.AutoPostViewModel; **/;
                    await BaseService.page.openDialog(this.AutoPostViewModel, AddEditDocumentComponent, { ShowCenter: true });
                    if (this.AutoPostViewModel.DisplayMessage == "close") {
                        return false;
                    }
                    else if (!this.ScreenObject.IsPurchase) {
                        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                                let drbomdetails = this.AutoPostViewModel.ScreenObject.GridData.filter(x => x.RefSeqNo == this.ScreenObject.GridData[i]["RefSeqNo"]);
                                let gr = 0;
                                drbomdetails.forEach(dd => {
                                    if (!Util.IsEmpty(dd["Gross"]))
                                        gr += parseFloat(dd["Gross"]);
                                });
                                //if (this.ScreenObject.Preferences.ContainsKey("ExpFPQTY") && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["ExpFPQTY"])
                                //    && this.ScreenObject.Preferences["ExpFPQTY"].toLowerCase()=="quantity")
                                //    this.ScreenObject.GridData[i]["Rate"] = gr / parseFloat(this.ScreenObject.GridData[i]["Quantity"]);
                                //else
                                this.ScreenObject.GridData[i]["Rate"] = gr / parseFloat(this.ScreenObject.GridData[i]["Quantity"]);
                                this.CalculateTotals(this.ScreenObject.GridData[i], false);
                            }
                        }
                    }
                    else {
                        //if (ScreenObject.IsPurchase) // Used This Preference for Temporarly for Purchase Document
                        if (this.ScreenObject.DocumentType == 34 && this.ScreenObject.Preferences.ContainsKey("Check Budget") && this.ScreenObject.Preferences["Check Budget"] != "" && parseBoolean(this.ScreenObject.Preferences["Check Budget"])) {
                            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                                if (this.ScreenObject.GridData[i]["ProductID_Key"].toString() != "") {
                                    if (this.ScreenObject.GridDataColumns.Contains("RefSeqNo") && !Util.IsEmpty(this.ScreenObject.GridData[i]["RefSeqNo"].toString())) {
                                        let drbomdetails = this.AutoPostViewModel.ScreenObject.GridData.filter(x => x["RefSeqNo"] == this.ScreenObject.GridData[i]["RefSeqNo"].toString() + "'");
                                        let gr = 0;
                                        drbomdetails.forEach(dd => {
                                            if (dd["Gross"].toString() != "")
                                                gr += Util.DoubleTryParse(dd["Gross"].toString());
                                        });
                                        this.ScreenObject.GridData[i]["Rate"] = gr / parseFloat(this.ScreenObject.GridData[i]["Quantity"].toString());
                                        this.CalculateTotals(this.ScreenObject.GridData[i], false);
                                    }
                                }
                            }
                        }
                    }
                }
                else {
                    this.AutoPostViewModel.SaveInventoryDocument("", true);
                    if (this.AutoPostViewModel.DisplayMessage != "") {
                        this.DisplayMessage = " Auto Post" + this.AutoPostViewModel.DisplayMessage;

                        return false;
                    }
                }
            }

            if (this.AutoProduce != null) {
                this.AutoProduce.ScreenObject.UpdateSequence();
                this.AutoProduce.ScreenObject.DocID = this.AutoProduceDocID;
                this.AutoProduce.parent = this;
                this.AutoProduceXML = "";
                this.AutoProduce.SaveInventoryDocument("", true);
                if (this.AutoProduce.DisplayMessage != "") {
                    this.DisplayMessage = " Auto Produce:" + this.AutoProduce.DisplayMessage;
                    return false;
                }
            }

            let sbRows = "";
            let sbStatic = "";
            let sbNumeric = "";
            let sbText = "";
            let sbCC = "";
            let NumXml = "";
            let ExtraXml = "";
            let DOcExtraXml = "";
            let ProjectPlanXml = "";

            if (this.savebulk) {
                sbStatic += "<DocXML>";
                sbNumeric += "<NumXML>";
                sbText += "<TextXML>";
                sbCC += "<CCXML>";
                sbRows += "<AccXML>";
                ExtraXml += "<EXTRAXML>";
                DOcExtraXml += "<DocExtraXml>";
                ProjectPlanXml+="<ProjectPlanXML>"
            }

            let RowCount = 0;
            let StockValue = 0, NetValue = 0;
            let QtyDim: string[] = [], ValueDims: string[] = [];
            let IsQtyBudLineWise = false, IsValueBudLineWise = false;
            let BudStartDate: Date, ValueBudStartDate: Date;
            let BudID: number = 0, ValueBudID: number = 0;
            let outBudVal = { dim: QtyDim, BudID: BudID, BudStartDate: BudStartDate, IsQtyBudLineWise: IsQtyBudLineWise }
            let QtyWhere: string = this.ValidateBudget(1, outBudVal);
            QtyDim = outBudVal.dim;
            BudID = outBudVal.BudID;
            BudStartDate = outBudVal.BudStartDate;
            IsQtyBudLineWise = outBudVal.IsQtyBudLineWise;
            let outBudVal2 = { dim: ValueDims, ValueBudID: ValueBudID, ValueBudStartDate: ValueBudStartDate, IsValueBudLineWise: IsValueBudLineWise }
            let ValueBudWhere: string = this.ValidateBudget(2, outBudVal2);
            ValueDims = outBudVal.dim;
            ValueBudID = outBudVal2.ValueBudID;
            ValueBudStartDate = outBudVal2.ValueBudStartDate;
            IsValueBudLineWise = outBudVal2.IsValueBudLineWise;
            let DecimalsinQty: string = BaseService.SessionManager.Preferences["DecimalsinQty"];
            let qtycol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != null && a.DisplayMember.toLowerCase() == "quantity");
            if (qtycol && !Util.IsEmpty(qtycol.DecimalPoints))
                DecimalsinQty = qtycol.DecimalPoints;
            // sbRows+="<DocumentXML";
            // if (sender != null && sender.toString() == "SaveonHold")
            //     sbRows+=" status=\"" + sender.toString() + "\"";

            // if (sender != null && sender.toString() == "Revise")
            //     sbRows+=" IsRevision=\"1\"";


            // if (this.ScreenObject.Preferences.ContainsKey("Enable Hold") && parseBoolean(this.ScreenObject.Preferences["Enable Hold"]))
            // {
            //     let hldcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "HoldQuantity");
            //     if (hldcol && hldcol.Expression != null && hldcol.Expression != "")
            //     {
            //         sbRows+=" HoldCheck=\"1\"";
            //     }
            // }

            // sbRows+=">";

            if (!this.BodyVisible || this.ReadOnlyBody)
                this.CheckEmptyGrid();

            let DocDetailsID = "", CostXMl = "";
            this.IsBinwise = null; this.IsToBinwise = null;
            let DupChk = false, DistCost = false;
            let costDims: string[] = null;

            if ((this.ScreenObject.Preferences.ContainsKey("Alert Duplicate Product") && this.ScreenObject.Preferences["Alert Duplicate Product"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["Alert Duplicate Product"]))
                || (this.ScreenObject.Preferences.ContainsKey("DuplicateProduct_IncrementQuantity") && this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"] != "" && parseBoolean(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"])))
                DupChk = true;

            if (this.ScreenObject.DocID == 0)
                this.ScreenObject.DistributeCostXML = "";

            let accid = 0, ToAccid = 0;
            if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 39 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 6 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 13) {
                if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0)
                    accid = this.ScreenObject.CreditAccount.SelectedValue;
                if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0)
                    ToAccid = this.ScreenObject.DebitAccount.SelectedValue;
            }
            else if (this.ScreenObject.DocumentType == 11 || this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 5 || this.ScreenObject.DocumentType == 7 || this.ScreenObject.DocumentType == 9 || this.ScreenObject.DocumentType == 24 || this.ScreenObject.DocumentType == 33 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 8 || this.ScreenObject.DocumentType == 12) {
                if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0)
                    accid = this.ScreenObject.DebitAccount.SelectedValue;
                if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0)
                    ToAccid = this.ScreenObject.CreditAccount.SelectedValue;
            }
            if (BaseService.SessionManager.Preferences.ContainsKey("DistributeCost") && BaseService.SessionManager.Preferences["DistributeCost"] == "True"
                && BaseService.SessionManager.Preferences.ContainsKey("CostBasedON") && BaseService.SessionManager.Preferences["CostBasedON"] == "True"
                && BaseService.SessionManager.Preferences.ContainsKey("CostBasedONDims") && BaseService.SessionManager.Preferences["CostBasedONDims"] != ""
                && !(this.ScreenObject.Preferences.ContainsKey("DistributeCost") && this.ScreenObject.Preferences["DistributeCost"].toString() == "True")) {
                costDims = BaseService.SessionManager.Preferences["CostBasedONDims"].split(',');
            }
            else if (BaseService.SessionManager.Preferences.ContainsKey("DistributeCost") && BaseService.SessionManager.Preferences["DistributeCost"] == "True"
                && !(this.ScreenObject.Preferences.ContainsKey("DistributeCost") && this.ScreenObject.Preferences["DistributeCost"].toString() == "True")) {
                DistCost = this.ScreenObject.IsDistCost(accid.toString() + "," + ToAccid.toString());
            }
            if (this.ScreenObject.Preferences.ContainsKey("BatchBasedon") && this.ScreenObject.Preferences["BatchBasedon"] != "" && !this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["BatchBasedon"])) {
                let txtfld = this.ScreenObject._TextFields.find(a => a instanceof PactTextBoxData && a.DBColumnName.toLowerCase() == this.ScreenObject.Preferences["BatchBasedon"].toLowerCase());
                if (txtfld && (txtfld as PactTextBoxData).Text == "1")
                    IgnoreBatches = true;
            }
            if (this.VoucherType == -1 && (AutoBatches || this.ScreenObject.Preferences.ContainsKey("AutoBatches") && !Util.IsEmpty(this.ScreenObject.Preferences["AutoBatches"]) && parseBoolean(this.ScreenObject.Preferences["AutoBatches"])))
                this.AutoAdjustbatches(IgnoreBatches, AutoBatches);

            let BatDim: number = 0;
            if (BaseService.SessionManager.Preferences.ContainsKey("Maintain Dimensionwise Batches") && !Util.IsEmpty(BaseService.SessionManager.Preferences["Maintain Dimensionwise Batches"]))
                BatDim = Util.Int(BaseService.SessionManager.Preferences["Maintain Dimensionwise Batches"].toString());

            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                    if (Validate) {
                        for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                            if (this.ScreenObject.ColumnSource[j].IsVisible && this.ScreenObject.ColumnSource[j].DisplayMember != "DocSeqNo") {
                                if (((this.ScreenObject.ColumnSource[j].DataType == "INT" || this.ScreenObject.ColumnSource[j].DataType == "FLOAT") && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) && parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) != 0)
                                    || (this.ScreenObject.ColumnSource[j].DataType == "LISTBOX" && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) && parseInt(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) > 0)
                                    || ((this.ScreenObject.ColumnSource[j].DataType == "SELECTIONBOX" || this.ScreenObject.ColumnSource[j].DataType == "String" || this.ScreenObject.ColumnSource[j].DataType == "TextBlock" || this.ScreenObject.ColumnSource[j].DataType == "TEXT") && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]))
                                    || ((this.ScreenObject.ColumnSource[j].DataType == "DATE" || this.ScreenObject.ColumnSource[j].DataType == "DATETIME") && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]))) {
                                    this.DisplayMessage = " Product not selected at row no." + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                    return false;
                                }
                            }
                        }
                    }
                    continue;
                }
                let IsSchemeRow = false;
                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["SchemeID"]) && parseInt(this.ScreenObject.GridData[i]["SchemeID"]) > 0
                    && this.ScreenObject.GridData[i]["IsScheme"].toString() == "Y")
                    IsSchemeRow = true;

                if (Validate && DupChk && !Util.IsEmpty(this.ScreenObject.GridData[i]["LinkedInvDocDetailsID"]) && parseInt(this.ScreenObject.GridData[i]["LinkedInvDocDetailsID"]) > 0
                    && sbRows.Contains("ProductID=\"" + this.ScreenObject.GridData[i]["ProductID_Key"].toString() + "\"")) {
                    if (BaseService.SessionManager.Preferences.ContainsKey("ShowProdCodeinErrMsg") && parseBoolean(BaseService.SessionManager.Preferences["ShowProdCodeinErrMsg"]))
                        this.res = this.ScreenObject.GridData[i]["ProductCode"].toString() + "-" + this.ScreenObject.GridData[i]["ProductName"].toString();
                    else if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                        this.res = this.ScreenObject.GridData[i]["ProductName"].toString();
                    else if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                        this.res = this.ScreenObject.GridData[i]["ProductCode"].toString();

                    if (!confirm("Duplicate product:" + this.res + " at row no:" + this.ScreenObject.GridData[i]["DocSeqNo"].toString() + " \n do you want to continue?"))
                        return false;
                }

                if (this.ScreenObject.Preferences.ContainsKey("BatchBasedon") && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["BatchBasedon"])) {
                    IgnoreBatches = false;
                    if (this.ScreenObject.GridData[i][this.ScreenObject.Preferences["BatchBasedon"]].toString() == "1")
                        IgnoreBatches = true;
                }

                if (Validate && !IsSchemeRow) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]) && parseInt(this.ScreenObject.GridData[i]["ProductID_Key"]) == this.ScreenObject.TempProductID
                        && this.ScreenObject.Preferences.ContainsKey("MandatorytempPartinfo") && parseBoolean(this.ScreenObject.Preferences["MandatorytempPartinfo"])
                        && Util.IsEmpty(this.ScreenObject.GridData[i]["ExtraXML"])) {
                        this.DisplayMessage = BaseService.GetResource("Doc_MandatoryTempInfo") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();

                        return false;
                    }

                    if (Validate && this.ScreenObject.Preferences.ContainsKey("Mandatory") && parseBoolean(this.ScreenObject.Preferences["Mandatory"]) && (Util.IsEmpty(this.ScreenObject.GridData[i]["LinkedInvDocDetailsID"]) || (!Util.IsEmpty(this.ScreenObject.GridData[i]["LinkedInvDocDetailsID"]) && parseInt(this.ScreenObject.GridData[i]["LinkedInvDocDetailsID"]) < 1))) {
                        if (!((this.ScreenObject.GridDataColumns.Contains("jobID") && !Util.IsEmpty(this.ScreenObject.GridData[i]["jobID"])) ||
                            (this.ScreenObject.GridDataColumns.Contains("BOMID") && !Util.IsEmpty(this.ScreenObject.GridData[i]["BOMID"])))) {
                            this.DisplayMessage = BaseService.GetResource("Doc_MissingRef") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();

                            return false;
                        }
                    }

                    if (DontSaveQtyIsZero) {
                        if (Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) || !Util.IsNum(this.ScreenObject.GridData[i]["Quantity"]) || Util.Double((this.ScreenObject.GridData[i]["Quantity"])) == 0) {
                            this.DisplayMessage = BaseService.GetResource("Doc_ZeroQty") + " " + this.ScreenObject.GridData[i]["DocSeqNo"];
                            return false;
                        }
                    }
                    if (DontSaveQtyIsNegative) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) < 0) {
                            this.DisplayMessage = BaseService.GetResource("Doc_NegativeQty") + " " + this.ScreenObject.GridData[i]["DocSeqNo"];
                            return false;
                        }
                    }
                    if (DontSaveRateZero) {
                        if (Util.IsEmpty(this.ScreenObject.GridData[i]["Rate"]) || !Util.IsNum(this.ScreenObject.GridData[i]["Rate"]) || parseFloat(this.ScreenObject.GridData[i]["Rate"]) == 0) {
                            this.DisplayMessage = BaseService.GetResource("Doc_ZeroRate") + " " + this.ScreenObject.GridData[i]["DocSeqNo"];
                            return false;
                        }
                    }
                    if (DontSaveValueZero) {
                        if (Util.IsEmpty(this.ScreenObject.GridData[i]["Gross"]) || !Util.IsNum(this.ScreenObject.GridData[i]["Gross"]) || parseFloat(this.ScreenObject.GridData[i]["Gross"]) == 0) {
                            this.DisplayMessage = BaseService.GetResource("Doc_ZeroValue") + " " + this.ScreenObject.GridData[i]["DocSeqNo"];
                            return false;
                        }
                    }
                }

                if (Validate && this.ScreenObject.GridDataColumns.Contains("QtyType") && Util.String(this.ScreenObject.GridData[i]["QtyType"]) == "1") {
                    if (Util.IsEmpty(this.ScreenObject.GridData[i]["QtyXML"])) {
                        this.DisplayMessage = "Qty Adjustment not done at row no. " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                        return false;
                    }
                }

                if (Validate && this.ScreenObject.GridDataColumns.Contains("IsTestCase") && Util.LowerCase(this.ScreenObject.GridData[i]["IsTestCase"]) == "true") {
                    if (Util.IsEmpty(this.ScreenObject.GridData[i]["TestCaseXML"])) {
                        this.DisplayMessage = "Test Case not done at row no. " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                        return false;
                    }
                }

                this.AutoAdjustBOE(i);

                if (Validate && this.ScreenObject.GridDataColumns.Contains("landingType")
                    && (Util.String(this.ScreenObject.GridData[i]["landingType"]) == "1" || Util.String(this.ScreenObject.GridData[i]["landingType"]) == "2")
                    && (!this.ScreenObject.GridDataColumns.Contains("VoucherType") || Util.String(this.ScreenObject.GridData[i]["VoucherType"]) == "-1")
                    && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) > 0) {
                    if (Util.String(this.ScreenObject.GridData[i]["DocExtraXML"]) == "") {
                        this.DisplayMessage = "Bill of Entry not done at row no. " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                        return false;
                    }
                    else {
                        let xDoc = new XmlDocument();
                        xDoc.LoadXml(this.ScreenObject.GridData[i]["DocExtraXML"]);
                        let xList = xDoc.SelectNodes("DocExtraXML/Row");
                        let qty = 0;
                        for (let h = 0; h < xList.length; h++) {
                            if (xList[h].attributes["Qty"] != null && !Util.IsEmpty(xList[h].attributes["Qty"].value))
                                qty += parseFloat(xList[h].attributes["Qty"].value);
                        }
                        let BoeQty = 0;
                        if (this.ScreenObject.GridData[i]["Quantity"].toString() != "" && parseFloat(this.ScreenObject.GridData[i]["Quantity"].toString()) > 0)
                            BoeQty = parseFloat(this.ScreenObject.GridData[i]["Quantity"].toString());
                        if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && this.ScreenObject.GridData[i]["UOMConversion"].toString() != "")
                            BoeQty = BoeQty * parseFloat(this.ScreenObject.GridData[i]["UOMConversion"].toString());
                            if (BoeQty.ToString("N" + DecimalsinQty) != qty.ToString("N" + DecimalsinQty)){
                            this.DisplayMessage = "Bill of Entry not done at row no. " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                            return false;
                        }
                    }
                }

                if (this.ScreenObject.DocumentType == 5 && this.ScreenObject.GridDataColumns.Contains("RecievedQty") && !Util.IsEmpty(this.ScreenObject.GridData[i]["RecievedQty"])) {
                    if ((!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"])
                        && parseFloat(this.ScreenObject.GridData[i]["RecievedQty"]) > parseFloat(this.ScreenObject.GridData[i]["Quantity"]))
                        || Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"])) {
                        this.DisplayMessage = "RecievedQty greater than Issued quantity at row no:" + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                        return false;
                    }

                }
                RowCount++;
                this.res = "No";

                if (RowCount == 1) {
                    if (this.DocID == 0 && this.ScreenObject.Preferences.ContainsKey("AutoadjustDownPmt") && parseBoolean(this.ScreenObject.Preferences["AutoadjustDownPmt"])
                        && parseBoolean(this.ScreenObject.Preferences["AllowAdjToDownPmt"])) {
                        let drmat = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 26425);
                        if (drmat.length > 0) {
                            let dnpmt = new ShowJVViewModel()
                            dnpmt.ShowJVViewModel_2(this, drmat[0]["SysColumnName"].toString(), 1);
                            dnpmt.OnSave("OK");
                        }
                        else {
                            this.DisplayMessage = "Define Advance AR/AP field.";
                            return false;
                        }
                    }

                    if (Util.IsEmpty(this.ArApBills) && this.ScreenObject.Preferences.ContainsKey("AllowAdjToDownPmt") && parseBoolean(this.ScreenObject.Preferences["AllowAdjToDownPmt"])
                        && this.ScreenObject.Preferences.ContainsKey("PromptifAdvPmtthere") && parseBoolean(this.ScreenObject.Preferences["PromptifAdvPmtthere"])) {
                        let ds = null;
                        if (this.DocumentType == 11 && this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0)
                            ds = this.ScreenObject.GetArApDetails(this.ScreenObject.DebitAccount.SelectedValue, this.DocumentDate, false);
                        else if (this.DocumentType == 1 && this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0)
                            ds = this.ScreenObject.GetArApDetails(this.ScreenObject.CreditAccount.SelectedValue, this.DocumentDate, false);

                        if (ds != null && ds.Tables.length > 0 && ds.Columns[0].Contains("DocNo") && ds.Tables[0].Rows.Count > 0) {
                            if (!confirm("Advance payments not adjusted.Do you want to proceed?"))
                                return false;
                            //    MessageBoxResult result = Microsoft.Windows.Controls.MessageBox.Show(Application.Current.MainWindow, , MessageBoxButton.YesNo);
                            //    if (result == MessageBoxResult.No)
                            //        return false;
                        }
                    }

                    let col = this.ScreenObject.ColumnSource.find(a => a.DistributionColID == -1);
                    if (col && (col.PostingType == 3 || col.PostingType == 4))
                        this.RoundOffValue(this.ScreenObject.GridData[i], col);

                    if ((sender.toString() == "CheckoutPrint" || sender.toString() == "CheckoutSave" || !Validate) && this.POSPayModes != null) {
                        this.FillHeaderDictionary();
                        for (let k = 0; k < this.POSPayModes.GridData.length; k++) {
                            if (Util.IsEmpty(this.POSPayModes.GridData[k]["ColumnName"]))
                                continue;

                            if (this.FooterDics.ContainsKey(this.POSPayModes.GridData[k]["Name"].toString().Replace(" ", ""))) {
                                this.FooterDics[this.POSPayModes.GridData[k]["Name"].toString().Replace(" ", "")].setFieldValue(this.POSPayModes.GridData[k]["Amount"].toString());
                            }
                            //drrow["Amount"] = parseFloat(drrow["Amount"]) + parseFloat(POSPayModes.GridData[k]["Amount"]);
                        }
                        this.CalculateFooter(-1);
                    }

                    if (!this.DistributeFooter(Validate))
                        return false;
                }

                let FromTOCount = 0;
                do {
                    if (this.savebulk) {
                        sbStatic += "<Transactions ";
                        sbNumeric += "<Numeric ";
                        sbCC += "<CostCenters ";
                        sbText += "<Alpha ";
                    }
                    else {
                        sbStatic = "";
                        sbNumeric = "";
                        sbText = "";
                        sbCC = "";
                        DOcExtraXml = "";

                        sbStatic += "<Transactions ";
                        sbNumeric += "<Numeric Query=\"";
                        sbCC += "<CostCenters Query=\"";
                        sbText += "<Alpha Query=\"";

                        if (this.isSaveXml || ((this.IsAutoPost || this.isAutoProduce) && this.parent != null))
                            sbRows += "<RowHead/>";
                        else
                            sbRows += "\u0011";
                        sbRows += "<Row>";
                        sbRows += "<AccountsXML>";
                    }

                    StockValue = 0;
                    NumXml = "";
                    let batchQty = 0.0, qt = 0;

                    if (this.DocumentType == 32) {
                        let VarFldName = "";
                        var fld = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["VarienceField"]);
                        if (fld != undefined)
                            VarFldName = fld.DisplayMember;

                        if (VarFldName != "" && this.ScreenObject.GridDataColumns.Contains(VarFldName) && this.ScreenObject.GridData[i][VarFldName].toString() != "") {
                            qt = parseFloat(this.ScreenObject.GridData[i][VarFldName].toString().Replace("-", ""));
                        }
                    }
                    else if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]))
                        qt = parseFloat(this.ScreenObject.GridData[i]["Quantity"].toString());
                    let xDoc: any = new XmlDocument();
                    if (Validate && (!this.DonotUpdateInventory || this.DocumentType == 32) && !Util.IsEmpty(this.ScreenObject.GridData[i]["Type"]) && parseInt(this.ScreenObject.GridData[i]["Type"]) == 2 && qt > 0) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ExtraXML"])) {
                            xDoc.LoadXml(this.ScreenObject.GridData[i]["ExtraXML"]);
                            let xList = xDoc.SelectNodes("xml/Row");
                            if (qt != xList.length) {
                                this.DisplayMessage = BaseService.GetResource("Doc_SerialNoProductQtyMisMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                return false;
                            }
                        }
                        else {
                            this.DisplayMessage = BaseService.GetResource("Doc_SerialNoProductQtyMisMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                            return false;
                        }

                        if (this.ScreenObject.DocumentType == 5 && this.ScreenObject.GridDataColumns.Contains("RecievedQty") && !Util.IsEmpty(this.ScreenObject.GridData[i]["RecievedQty"])) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["RecievedQtyXML"])) {
                                xDoc.LoadXml(this.ScreenObject.GridData[i]["RecievedQtyXML"]);
                                let xList = xDoc.SelectNodes("xml/Row");
                                if (parseInt(this.ScreenObject.GridData[i]["RecievedQty"]) != xList.length) {
                                    this.DisplayMessage = "Serial Numbers not defined for RecievedQty at row " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                    return false;
                                }
                            }
                            else {
                                this.DisplayMessage = "Serial Numbers not defined for RecievedQty at row " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                return false;
                            }
                        }
                    }

                    if (Validate && this.ScreenObject.Preferences.ContainsKey("EnableAssetSerialNo") && this.ScreenObject.Preferences["EnableAssetSerialNo"].toLowerCase() == "true"
                        && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"])) {
                        let AssetQty = 0;
                        if (this.ScreenObject.Preferences.ContainsKey("AssetBasedOn") && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["AssetBasedOn"])) {
                            if (this.ScreenObject.GridData[i][this.ScreenObject.Preferences["AssetBasedOn"]].toString() == "0")
                                AssetQty = 0;
                            else if ((this.ScreenObject.GridData[i][this.ScreenObject.Preferences["AssetBasedOn"]].toString() == "1" || this.ScreenObject.GridData[i][this.ScreenObject.Preferences["AssetBasedOn"]].toString() == "2")
                                && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]))
                                AssetQty = parseFloat(this.ScreenObject.GridData[i]["Quantity"]);
                            else if (this.ScreenObject.GridData[i][this.ScreenObject.Preferences["AssetBasedOn"]].toString() == "3" || this.ScreenObject.GridData[i][this.ScreenObject.Preferences["AssetBasedOn"]].toString() == "4")
                                AssetQty = 1;
                        }
                        else if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]))
                            AssetQty = parseFloat(this.ScreenObject.GridData[i]["Quantity"]);

                        if (AssetQty > 0) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ExtraXML"])) {
                                xDoc.LoadXml(this.ScreenObject.GridData[i]["ExtraXML"]);
                                let xList = xDoc.SelectNodes("xml/Row");

                                if ((AssetQty >= 1 && AssetQty != xList.length) || (AssetQty < 1 && xList.length > 1)) {
                                    this.DisplayMessage = BaseService.GetResource("Doc_SerialNoProductQtyMisMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                    return false;
                                }
                            }
                            else {
                                this.DisplayMessage = BaseService.GetResource("Doc_SerialNoProductQtyMisMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                return false;
                            }
                        }
                        else
                            this.ScreenObject.GridData[i]["ExtraXML"] = "";
                    }


                    if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && (Util.IsEmpty(this.ScreenObject.GridData[i]["UOMConversion"])
                        || !Util.IsNum(this.ScreenObject.GridData[i]["UOMConversion"]) || parseFloat(this.ScreenObject.GridData[i]["UOMConversion"]) == 0)) {
                        this.ScreenObject.GridData[i]["UOMConversion"] = "1";
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]))
                            this.ScreenObject.GridData[i]["UOMConvertedQty"] = this.ScreenObject.GridData[i]["Quantity"].toString();
                        else {
                            this.ScreenObject.GridData[i]["UOMConvertedQty"] = 0;
                            this.ScreenObject.GridData[i]["Quantity"] = 0;
                        }
                    }


                    if ((this.ScreenObject.Preferences.ContainsKey("AutoAdjustBins") && !Util.IsEmpty(this.ScreenObject.Preferences["AutoAdjustBins"]) && parseBoolean(this.ScreenObject.Preferences["AutoAdjustBins"]))
                        && (Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"]) || parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) == 0))
                        this.AddBins(this.ScreenObject.GridData[i], false, false, null, true);

                    qt = 0;
                    if (!this.DonotUpdateInventory) {
                        if (FromTOCount == 1 && this.ScreenObject.GridDataColumns.Contains("RecievedQty")) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["RecievedQty"]) && parseFloat(this.ScreenObject.GridData[i]["RecievedQty"]) > 0)
                                qt = parseFloat(this.ScreenObject.GridData[i]["RecievedQty"]);
                        }
                        else {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) > 0)
                                qt = parseFloat(this.ScreenObject.GridData[i]["Quantity"]);
                            else if (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(this.ScreenObject.GridData[i]["FreeQTY"])
                                && parseFloat(this.ScreenObject.GridData[i]["FreeQTY"]) > 0)
                                qt = parseFloat(this.ScreenObject.GridData[i]["FreeQTY"]);
                            else if (!this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]))
                                qt = parseFloat(this.ScreenObject.GridData[i]["Quantity"]);
                        }

                        if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && !Util.IsEmpty(this.ScreenObject.GridData[i]["UOMConversion"]))
                            qt = qt * parseFloat(this.ScreenObject.GridData[i]["UOMConversion"]);
                    }
                    else if ((this.ScreenObject.Preferences.ContainsKey("ExcludeHoldBins") && !Util.IsEmpty(this.ScreenObject.Preferences["ExcludeHoldBins"]) && parseBoolean(this.ScreenObject.Preferences["ExcludeHoldBins"]))
                        && (this.ScreenObject.GridDataColumns.Contains("ReserveQuantity") || this.ScreenObject.GridDataColumns.Contains("HoldQuantity"))) {
                        if (this.ScreenObject.GridDataColumns.Contains("ReserveQuantity") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ReserveQuantity"]) && parseFloat(this.ScreenObject.GridData[i]["ReserveQuantity"]) > 0)
                            qt = parseFloat(this.ScreenObject.GridData[i]["ReserveQuantity"]);
                        if (this.ScreenObject.GridDataColumns.Contains("HoldQuantity") && !Util.IsEmpty(this.ScreenObject.GridData[i]["HoldQuantity"]) && parseFloat(this.ScreenObject.GridData[i]["HoldQuantity"]) > 0)
                            qt = parseFloat(this.ScreenObject.GridData[i]["HoldQuantity"]);
                    }

                    if (Validate && qt > 0 && this.ScreenObject.GridDataColumns.Contains("BinWise") && !Util.IsEmpty(this.ScreenObject.GridData[i]["BinWise"]) && this.ScreenObject.GridData[i]["BinWise"].toString() == "True") {
                        let WID = { DimensionID: 0 };
                        if (this.IsWarehouseBinwise(i, FromTOCount, WID)) {
                            if (!this.ScreenObject.GridDataColumns.Contains("BinStatus")) {
                                if (FromTOCount == 1) {
                                    if (Util.IsEmpty(this.ScreenObject.GridData[i]["TOBinsXML"]) && this.ScreenObject.Preferences.ContainsKey("AutoSelectBins") && this.ScreenObject.Preferences["AutoSelectBins"].toLowerCase() == "true") {
                                        let dimid = 0;
                                        if (BaseService.SessionManager.Preferences.ContainsKey("DimensionwiseBins") && BaseService.SessionManager.Preferences["DimensionwiseBins"].toString() != "")
                                            dimid = Util.Int(BaseService.SessionManager.Preferences["DimensionwiseBins"]);
                                        this.AddToWarehouseBins(dimid, this.ScreenObject.GridData[i], qt, true);
                                    }
                                    if (Util.IsEmpty(this.ScreenObject.GridData[i]["TOBinsXML"]) && qt > 0) {
                                        this.DisplayMessage = BaseService.GetResource("Doc_BinsMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                        return false;
                                    }
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["TOBinsXML"]))
                                        xDoc.LoadXml(this.ScreenObject.GridData[i]["TOBinsXML"]);
                                }
                                else {
                                    if (Util.IsEmpty(this.ScreenObject.GridData[i]["BinsXML"]) && this.ScreenObject.Preferences.ContainsKey("AutoSelectBins") && this.ScreenObject.Preferences["AutoSelectBins"].toLowerCase() == "true")
                                        this.AddBins(this.ScreenObject.GridData[i], true, false, null);

                                    if (Util.IsEmpty(this.ScreenObject.GridData[i]["BinsXML"]) && qt > 0) {
                                        this.DisplayMessage = BaseService.GetResource("Doc_BinsMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                        return false;
                                    }
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["BinsXML"]))
                                        xDoc.LoadXml(this.ScreenObject.GridData[i]["BinsXML"]);
                                }

                                if (qt > 0) {
                                    let xList = xDoc.SelectNodes("BinsXML/Row");
                                    for (let iRow = 0; iRow < xList.length; iRow++) {
                                        if (xList[iRow].attributes["Allocate"].value != null && xList[iRow].attributes["Allocate"].value != "")
                                            batchQty += parseFloat(xList[iRow].attributes["Allocate"].value);

                                        if (xList[iRow].attributes["Warehouse"] != null && !Util.IsEmpty(xList[iRow].attributes["Warehouse"].value) && xList[iRow].attributes["Warehouse"].value != WID.DimensionID.toString()) {
                                            this.DisplayMessage = BaseService.GetResource("Doc_BinsMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                            return false;
                                        }
                                    }

                                    if (qt.ToString("N" + DecimalsinQty) != batchQty.ToString("N" + DecimalsinQty)) {
                                        this.DisplayMessage = BaseService.GetResource("Doc_BinsMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                        return false;
                                    }
                                }
                            }
                        }
                        else {
                            if (FromTOCount == 1)
                                this.ScreenObject.GridData[i]["TOBinsXML"] = "<BinsXML> <Row  NodeID=\"1\" Allocate=\"" + qt + "\" ></Row></BinsXML>";
                            else
                                this.ScreenObject.GridData[i]["BinsXML"] = "<BinsXML> <Row  NodeID=\"1\" Allocate=\"" + qt + "\" ></Row></BinsXML>";
                        }
                    }

                    batchQty = 0.0; qt = 0;

                    if (this.ScreenObject.Preferences.ContainsKey("ExcludeHold") && this.ScreenObject.Preferences["ExcludeHold"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["ExcludeHold"])
                        && this.ScreenObject.GridDataColumns.Contains("HoldQuantity")) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["HoldQuantity"]) && parseFloat(this.ScreenObject.GridData[i]["HoldQuantity"]) > 0)
                            qt = parseFloat(this.ScreenObject.GridData[i]["HoldQuantity"]);
                        else
                            qt = 0;
                    }

                    if (this.ScreenObject.Preferences.ContainsKey("ExcludeReserve") && this.ScreenObject.Preferences["ExcludeReserve"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["ExcludeReserve"])
                        && this.ScreenObject.GridDataColumns.Contains("ReserveQuantity")) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ReserveQuantity"]) && parseFloat(this.ScreenObject.GridData[i]["ReserveQuantity"]) > 0)
                            qt = parseFloat(this.ScreenObject.GridData[i]["ReserveQuantity"]);
                        else
                            qt = 0;
                    }

                    if (this.DocumentType == 32) {
                        let VarFldName = "";
                        let fld = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["VarienceField"]);
                        if (fld)
                            VarFldName = fld.DisplayMember;

                        if (VarFldName != "" && this.ScreenObject.GridDataColumns.Contains(VarFldName) && !Util.IsEmpty(this.ScreenObject.GridData[i][VarFldName])) {
                            qt = parseFloat(this.ScreenObject.GridData[i][VarFldName].toString().replace("-", ""));
                        }
                    }

                    if (this.VoucherType == -1 && (AutoBatches || this.ScreenObject.Preferences.ContainsKey("AutoBatches") && this.ScreenObject.Preferences["AutoBatches"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["AutoBatches"]))
                        && (Util.String(this.ScreenObject.GridData[i]["Type"]) == "8" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "3" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "11" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "12"))
                        this.FillAutoBatchesforDynamic(i);

                    if ((Validate && (!this.DonotUpdateInventory || qt > 0)) && !Util.IsEmpty(this.ScreenObject.GridData[i]["Type"]) && parseInt(this.ScreenObject.GridData[i]["Type"]) == 5
                        && !(this.ScreenObject.Preferences.ContainsKey("SameBatchtoall") && this.ScreenObject.Preferences["SameBatchtoall"].toLowerCase() == "true")
                        && !(IgnoreBatches && this.ScreenObject.Preferences.ContainsKey("BatchBasedon") && this.ScreenObject.Preferences["BatchBasedon"] != "")
                        && ((!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) > 0)
                            || qt > 0 || this.DocumentType == 32 || (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(this.ScreenObject.GridData[i]["FreeQTY"]) && parseFloat(this.ScreenObject.GridData[i]["FreeQTY"]) > 0))) {

                        if (this.VoucherType == -1 && ((this.ScreenObject.Preferences.ContainsKey("AutoBatches") && this.ScreenObject.Preferences["AutoBatches"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["AutoBatches"])
                            && (Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"]) || parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) == 0)) || (AutoBatches && Util.IsEmpty(this.ScreenObject.GridData[i]["ExtraXML"])))) {
                            let div = 0, loc = 0;
                            if (this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])) {
                                let ccfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
                                if (ccfld && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0)
                                    loc = ccfld.SelectedValue;
                                else if (this.ScreenObject.GridDataColumns.Contains("dcCCNID2_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID2_Key"]))
                                    loc = parseInt(this.ScreenObject.GridData[i]["dcCCNID2_Key"]);
                            }
                            else if (this.ScreenObject.LocationID > 0)
                                loc = this.ScreenObject.LocationID;
                            else
                                loc = BaseService.SessionManager.LocationID;
                            if (this.ScreenObject.DivisionID > 0)
                                div = this.ScreenObject.DivisionID;
                            else
                                div = BaseService.SessionManager.DivisionID;


                            if (qt == 0) {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) > 0)
                                    qt = parseFloat(this.ScreenObject.GridData[i]["Quantity"]);
                                if (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(this.ScreenObject.GridData[i]["FreeQTY"])
                                    && parseFloat(this.ScreenObject.GridData[i]["FreeQTY"]) > 0)
                                    qt = parseFloat(this.ScreenObject.GridData[i]["FreeQTY"]);


                                if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && !Util.IsEmpty(this.ScreenObject.GridData[i]["UOMConversion"]))
                                    qt = qt * parseFloat(this.ScreenObject.GridData[i]["UOMConversion"]);
                            }

                            let objbat = new BatchNumberViewModel(this.ScreenObject.GridDataObj)
                            objbat.BatchNumberViewModel_3(this, this.VoucherType, qt, parseInt(this.ScreenObject.GridData[i]["ProductID_Key"]), this.ScreenObject.GridData[i]["ProductName"].toString(), loc, div, this.ScreenObject.GridData[i])
                            {
                                objbat.ChkFifo = true;
                                objbat.OnSave("AutoSave");
                                if (objbat.count > 1)
                                    this.ScreenObject.UpdateSequence();

                                qt = 0;

                                if (this.ScreenObject.Preferences.ContainsKey("ExcludeHold") && this.ScreenObject.Preferences["ExcludeHold"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["ExcludeHold"])
                                    && this.ScreenObject.GridDataColumns.Contains("HoldQuantity")) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["HoldQuantity"]) && parseFloat(this.ScreenObject.GridData[i]["HoldQuantity"]) > 0)
                                        qt = parseFloat(this.ScreenObject.GridData[i]["HoldQuantity"]);
                                    else
                                        qt = 0;
                                }

                                if (this.ScreenObject.Preferences.ContainsKey("ExcludeReserve") && this.ScreenObject.Preferences["ExcludeReserve"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["ExcludeReserve"])
                                    && this.ScreenObject.GridDataColumns.Contains("ReserveQuantity")) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ReserveQuantity"]) && parseFloat(this.ScreenObject.GridData[i]["ReserveQuantity"]) > 0)
                                        qt = parseFloat(this.ScreenObject.GridData[i]["ReserveQuantity"]);
                                    else
                                        qt = 0;
                                }

                                if (this.DocumentType == 32) {
                                    let VarFldName = "";
                                    let fld = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["VarienceField"]);
                                    if (fld)
                                        VarFldName = fld.DisplayMember;
                                    if (VarFldName != "" && this.ScreenObject.GridDataColumns.Contains(VarFldName) && !Util.IsEmpty(this.ScreenObject.GridData[i][VarFldName]))
                                        qt = parseFloat(this.ScreenObject.GridData[i][VarFldName].toString().replace("-", ""));
                                }
                            }
                        }

                        if (qt == 0) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"].toString()) > 0)
                                qt = parseFloat(this.ScreenObject.GridData[i]["Quantity"].toString());
                            if (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(this.ScreenObject.GridData[i]["FreeQTY"])
                                && parseFloat(this.ScreenObject.GridData[i]["FreeQTY"].toString()) > 0)
                                qt = parseFloat(this.ScreenObject.GridData[i]["FreeQTY"].toString());


                            if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && !Util.IsEmpty(this.ScreenObject.GridData[i]["UOMConversion"]))
                                qt = qt * parseFloat(this.ScreenObject.GridData[i]["UOMConversion"].toString());
                        }


                        if (!IgnoreBatches) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ExtraXML"])) {
                                xDoc.LoadXml(this.ScreenObject.GridData[i]["ExtraXML"]);

                                let xList = xDoc.SelectNodes("xml/Row");
                                // XmlNode xNode = xList[0];
                                if (qt == 0) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) > 0)
                                        qt = parseFloat(this.ScreenObject.GridData[i]["Quantity"]);
                                    if (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(this.ScreenObject.GridData[i]["FreeQTY"])
                                        && parseFloat(this.ScreenObject.GridData[i]["FreeQTY"]) > 0)
                                        qt = parseFloat(this.ScreenObject.GridData[i]["FreeQTY"]);


                                    if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && !Util.IsEmpty(this.ScreenObject.GridData[i]["UOMConversion"]))
                                        qt = qt * parseFloat(this.ScreenObject.GridData[i]["UOMConversion"]);
                                }
                                for (let iRow = 0; iRow < xList.length; iRow++) {
                                    if (xList[iRow].attributes["ProductID"].value != null && xList[iRow].attributes["ProductID"].value != ""
                                        && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])
                                        && parseInt(xList[iRow].attributes["ProductID"].value) != parseInt(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                                        this.DisplayMessage = BaseService.GetResource("Doc_BatchQtyMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();

                                        return false;
                                    }

                                    if (xList[iRow].attributes["Quantity"].value != null && xList[iRow].attributes["Quantity"].value != "")
                                        batchQty += parseFloat(xList[iRow].attributes["Quantity"].value);

                                    if (this.ScreenObject.DocumentType == 30 && this.ScreenObject.GridDataColumns.Contains("VoucherType") && this.ScreenObject.GridData[i]["VoucherType"].toString() == "-1"
                                        && xList[iRow].attributes["Release"] != null && xList[iRow].attributes["Release"].value != null && xList[iRow].attributes["Release"].value != "") {
                                        this.DisplayMessage = BaseService.GetResource("Doc_BatchQtyMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();

                                        return false;
                                    }

                                    if (xList[iRow].attributes["dcCCNID1"] != null && !Util.IsEmpty(xList[iRow].attributes["dcCCNID1"].value)) {
                                        if (this.ScreenObject.DivisionID > 0 && parseInt(xList[iRow].attributes["dcCCNID1"].value) != this.ScreenObject.DivisionID) {
                                            this.DisplayMessage = BaseService.GetResource("Doc_BatchQtyMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                            this.MessageVisibility = true;
                                            return false;
                                        }
                                    }
                                    if (xList[iRow].attributes["dcCCNID2"] != null && !Util.IsEmpty(xList[iRow].attributes["dcCCNID2"].value)) {
                                        if (this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && !Util.IsEmpty(this.ScreenObject.Preferences["Donotuselocation"]) && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])) {
                                            let ccfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
                                            if (ccfld != undefined && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0 && parseInt(xList[iRow].attributes["dcCCNID2"].value) != ccfld.SelectedValue) {
                                                this.DisplayMessage = BaseService.GetResource("Doc_BatchQtyMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                                this.MessageVisibility = true;
                                                return false;
                                            }
                                            else if (this.ScreenObject.GridDataColumns.Contains("dcCCNID2_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID2_Key"])
                                                && this.ScreenObject.GridData[i]["dcCCNID2_Key"].toString() != xList[iRow].attributes["dcCCNID2"].value) {
                                                this.DisplayMessage = BaseService.GetResource("Doc_BatchQtyMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                                this.MessageVisibility = true;
                                                return false;
                                            }
                                        }
                                        else if (this.ScreenObject.LocationID > 0 && parseInt(xList[iRow].attributes["dcCCNID2"].value) != this.ScreenObject.LocationID) {
                                            this.DisplayMessage = BaseService.GetResource("Doc_BatchQtyMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                            this.MessageVisibility = true;
                                            return false;
                                        }
                                    }
                                    if (BatDim > 50000 && xList[iRow].attributes["DimID"] != null && !Util.IsEmpty(xList[iRow].attributes["DimID"].value)) {
                                        let ccfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid" + (BatDim - 50000));
                                        if (ccfld != undefined && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0 && parseInt(xList[iRow].attributes["DimID"].value) != ccfld.SelectedValue) {
                                            this.DisplayMessage = BaseService.GetResource("Doc_BatchQtyMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                            this.MessageVisibility = true;
                                            return false;
                                        }
                                        else if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (BatDim - 50000) + "_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID" + (BatDim - 50000) + "_Key"])
                                            && this.ScreenObject.GridData[i]["dcCCNID" + (BatDim - 50000) + "_Key"].toString() != xList[iRow].attributes["DimID"].value) {
                                            this.DisplayMessage = BaseService.GetResource("Doc_BatchQtyMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                            this.MessageVisibility = true;
                                            return false;
                                        }
                                    }

                                }

                                if (qt.ToString("N" + DecimalsinQty) != batchQty.ToString("N" + DecimalsinQty)) {
                                    this.DisplayMessage = BaseService.GetResource("Doc_BatchQtyMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();

                                    return false;
                                }

                            }
                            else if (this.DocumentType != 32 || qt > 0) {
                                this.DisplayMessage = BaseService.GetResource("Doc_BatchQtyMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();

                                return false;
                            }
                        }
                    }
                    else if (Validate && Util.String(this.ScreenObject.GridData[i]["Type"]) == "5" && Util.String(this.ScreenObject.GridData[i]["ExtraXML"]) != "") {
                        if (Util.String(this.ScreenObject.GridData[i]["Quantity"]) == "" || parseFloat(Util.String(this.ScreenObject.GridData[i]["Quantity"])) == 0)
                            this.ScreenObject.GridData[i]["ExtraXML"] = '';
                    }
                    if ((sender.toString() == "CheckoutPrint" || sender.toString() == "CheckoutSave" || !Validate) && this.POSPayModes != null) {
                        if (RowCount == 1) {
                            this.POSPayModes.RedeemPoints = 0;
                            this.POSpayXml = "";
                            let dtpay: any[] = []//this.POSPayModes.GridData.Clone();
                            if (this.POSPayModes.GridData.length > 0) {
                                let drrow: any;
                                for (let k = 0; k < this.POSPayModes.GridData.length; k++) {
                                    if (Util.IsEmpty(this.POSPayModes.GridData[k]["ColumnName"]))
                                        continue;

                                    if (this.POSPayModes.GridData[k]["Type"].toString() == "13")
                                        this.POSPayModes.RedeemPoints = parseFloat(this.POSPayModes.GridData[k]["Amount"]);

                                    let drpayrows = dtpay.filter(x => x.ColumnName == this.POSPayModes.GridData[k]["ColumnName"]);
                                    if (drpayrows.length == 0) {
                                        drrow = {};// dtpay.NewRow();
                                        drrow["Name"] = this.POSPayModes.GridData[k]["Name"].toString();
                                        drrow["ColumnName"] = this.POSPayModes.GridData[k]["ColumnName"].toString();
                                        drrow["Amount"] = this.POSPayModes.GridData[k]["Amount"].toString();
                                        drrow["Description"] = Util.StringValue(this.POSPayModes.GridData[k]["Description"]);
                                        drrow["Details"] = this.POSPayModes.GridData[k]["Details"].toString();
                                        drrow["Denomination"] = Util.StringValue(this.POSPayModes.GridData[k]["Denomination"]);
                                        dtpay.push(drrow);
                                    }
                                    else {
                                        drrow = drpayrows[0];
                                        drrow["Amount"] = parseFloat(drrow["Amount"]) + parseFloat(this.POSPayModes.GridData[k]["Amount"]);
                                        drrow["Details"] = drrow["Details"].toString() + this.POSPayModes.GridData[k]["Details"].toString();
                                        drrow["Denomination"] = Util.StringValue(drrow["Denomination"]) + Util.StringValue(this.POSPayModes.GridData[k]["Denomination"]);
                                    }
                                }
                                if (!Util.IsEmpty(this.POSPayModes.Return) && Util.IsNum(this.POSPayModes.Return)
                                    && !Util.IsEmpty(this.POSPayModes.Returnfld)) {
                                    drrow = {};// dtpay.NewRow();
                                    drrow["Name"] = this.POSPayModes.ReturnLabel;
                                    drrow["ColumnName"] = this.POSPayModes.Returnfld;
                                    drrow["Amount"] = this.POSPayModes.Return.replace("-", "");

                                    this.POSpayXml = "<XML Amount=\"" + drrow["Amount"].toString() + "\" DBColumnName=\"" + this.POSPayModes.Returnfld + "\" ";
                                    this.POSpayXml += " RegisterID=\"" + this.ScreenObject.RegisterNodeID + "\" ";
                                    this.POSpayXml += " ShiftID=\"" + this.ScreenObject.ShiftNodeID + "\" ";
                                    this.POSpayXml += " DocDate=\"" + this.DocumentDate.ToString("dd/MMM/yyyy") + "\" ";
                                    this.POSpayXml += " Type=\"12\" />";
                                    drrow["Details"] = this.POSpayXml;
                                    dtpay.push(drrow);
                                    this.POSpayXml = "";
                                }
                            }
                            for (let k = 0; k < dtpay.length; k++) {
                                sbNumeric += dtpay[k]["ColumnName"].toString() + "=" + dtpay[k]["Amount"].toString() + ", ";
                                sbNumeric += "dcCalc" + dtpay[k]["ColumnName"].toString().replace("dc", "") + "=" + dtpay[k]["Amount"].toString() + ", ";
                                this.POSpayXml += Util.StringValue(dtpay[k]["Details"]);
                                this.POSpayXml += Util.StringValue(dtpay[k]["Denomination"]);

                                let SrcCol = new DgColumn();
                                let drsyscol = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == dtpay[k]["ColumnName"]);

                                SrcCol.Header = drsyscol[0]["ResourceData"].toString();

                                SrcCol.DisplayMember = drsyscol[0]["SysColumnName"];

                                if (!Util.IsEmpty(drsyscol[0]["PostingType"]))
                                    SrcCol.PostingType = parseInt(drsyscol[0]["PostingType"]);

                                if (!Util.IsEmpty(drsyscol[0]["DebitAccount"]))
                                    SrcCol.DebitAccount = parseInt(drsyscol[0]["DebitAccount"]);
                                if (!Util.IsEmpty(drsyscol[0]["CreditAccount"]))
                                    SrcCol.CreditAcount = parseInt(drsyscol[0]["CreditAccount"]);

                                SrcCol.DefCreditAcount = SrcCol.CreditAcount;
                                SrcCol.DefDebitAccount = SrcCol.DebitAccount;

                                if (!Util.IsEmpty(drsyscol[0]["CRSysColumnName"]))
                                    SrcCol.CrRefColName = drsyscol[0]["CRSysColumnName"].toString();

                                if (!Util.IsEmpty(drsyscol[0]["CrRefColID"]))
                                    SrcCol.CrRefColID = parseInt(drsyscol[0]["CrRefColID"]);

                                if (!Util.IsEmpty(drsyscol[0]["CrRefID"]))
                                    SrcCol.CrRefID = parseInt(drsyscol[0]["CrRefID"]);

                                if (!Util.IsEmpty(drsyscol[0]["CRSection"]))
                                    SrcCol.CrRefSection = parseInt(drsyscol[0]["CRSection"]);

                                if (!Util.IsEmpty(drsyscol[0]["DRSysColumnName"]))
                                    SrcCol.DrRefColName = drsyscol[0]["DRSysColumnName"].toString();

                                if (!Util.IsEmpty(drsyscol[0]["DrRefColID"]))
                                    SrcCol.DrRefColID = parseInt(drsyscol[0]["DrRefColID"]);
                                if (!Util.IsEmpty(drsyscol[0]["DrRefID"]))
                                    SrcCol.DrRefID = parseInt(drsyscol[0]["DrRefID"]);
                                if (!Util.IsEmpty(drsyscol[0]["DrSection"]))
                                    SrcCol.DrRefSection = parseInt(drsyscol[0]["DrSection"]);

                                if (!Util.IsEmpty(drsyscol[0]["Decimal"]) && parseInt(drsyscol[0]["Decimal"].toString()) >= 0)
                                    SrcCol.DecimalPoints = drsyscol[0]["Decimal"].toString();
                                else if (BaseService.SessionManager.Preferences.ContainsKey("DecimalsinExtraFields") && BaseService.SessionManager.Preferences["DecimalsinExtraFields"] != "")
                                    SrcCol.DecimalPoints = BaseService.SessionManager.Preferences["DecimalsinExtraFields"];

                                if (!DonotUpdateAccounts && (SrcCol.PostingType == 3 || SrcCol.PostingType == 4) && !Util.IsEmpty(dtpay[k]["Amount"]) && parseFloat(dtpay[k]["Amount"]) != 0) {
                                    let outObj = { DBAcc: 0, CrACC: 0, PostingXml: "" }
                                    if (!this.FillAccountPosting(SrcCol, this.ScreenObject.GridData[0], dtpay[k]["Amount"].toString(), 1, 1, outObj))
                                        return false;
                                    sbRows += outObj.PostingXml;
                                    this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.CrACC.toString(), dtpay[k]["Amount"].toString(), true, 1, 1, 1, SrcCol.DecimalPoints);
                                    this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.DBAcc.toString(), dtpay[k]["Amount"].toString(), false, 1, 1, 1, SrcCol.DecimalPoints);
                               
                                    this.FillPaytermDt(accid, outObj.CrACC, outObj.DBAcc, dtpay[k]["Amount"].toString(), this.ScreenObject.GridData[0], SrcCol.DisplayMember, SrcCol.DecimalPoints);
                                    }
                                
                            }

                            if (this.ScreenObject.DocID > 0) {
                                this.POSPayModes.PayModes.forEach(item => {
                                    if (!sbNumeric.toString().Contains(item.DBColumnName)) {
                                        sbNumeric += item.DBColumnName + "=0, ";
                                        sbNumeric += "dcCalc" + item.DBColumnName.replace("dc", "") + "=0, ";
                                    }
                                });

                                if (!Util.IsEmpty(this.POSPayModes.Returnfld) && !sbNumeric.toString().Contains(this.POSPayModes.Returnfld)) {
                                    sbNumeric += this.POSPayModes.Returnfld + "=0, ";
                                    sbNumeric += "dcCalc" + this.POSPayModes.Returnfld.replace("dc", "") + "=0, ";
                                }
                            }

                            if (this.POSpayXml.length > 0) {
                                this.POSpayXml = "<PosPayModes>" + this.POSpayXml + "</PosPayModes>";
                            }

                            if (sender.toString() == "CheckoutPrint")
                                sender = "SaveAndPrint";
                            else
                                sender = "Save";
                        }
                        else if (this.ScreenObject.DocID > 0) {
                            this.POSPayModes.PayModes.forEach(item => {
                                sbNumeric += item.DBColumnName + "=0, ";
                                sbNumeric += "dcCalc" + item.DBColumnName.replace("dc", "") + "=0, ";
                            });

                            if (!Util.IsEmpty(this.POSPayModes.Returnfld) && !sbNumeric.toString().Contains(this.POSPayModes.Returnfld)) {
                                sbNumeric += this.POSPayModes.Returnfld + "=0, ";
                                sbNumeric += "dcCalc" + this.POSPayModes.Returnfld.replace("dc", "") + "=0, ";
                            }
                        }
                    }
                    let IsProductIDAdded = false;
                    let IsEnableRevise = false;
                    if (this.ScreenObject.Preferences.ContainsKey("EnableRevision") && this.ScreenObject.Preferences["EnableRevision"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableRevision"]))
                       IsEnableRevise = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "EnableReviseButton");
                    let sDisplayMember, sQueryAttribute;
                    for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                        sDisplayMember = this.ScreenObject.ColumnSource[j].DisplayMember;
                        if (sDisplayMember.toLowerCase().Contains("exchangerate") || sDisplayMember == "AppRemarks" || sDisplayMember == "FreeQTY" || sDisplayMember.toLowerCase().Contains("currencyid")
                            || (this.ScreenObject.ColumnSource[j].CostCenterID > 0 && sDisplayMember.endsWith("Code")))
                            continue;
                        sQueryAttribute = sDisplayMember;
                        if (sDisplayMember == "RefNo")
                            sQueryAttribute = "RefNO";
                        let CurrID = this.GetCurrencyID(i);
                        let ExhgRate = this.GetExchRate(i);

                        if (Validate && this.ScreenObject.ColumnSource[j].Mandatory && !Util.IsEmpty(this.ScreenObject.GridData[i]["Type"]) && parseInt(this.ScreenObject.GridData[i]["Type"]) != 8 && !IsSchemeRow) {
                            if (this.ScreenObject.ColumnSource[j].CostCenterID != 0 && this.ScreenObject.ColumnSource[j].DataType != "SELECTIONBOX" && (Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) || (parseInt(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) < 1 && !(this.ScreenObject.ColumnSource[j].CostCenterID == 3 && this.ScreenObject.GridData[i]["Type"].toString() == "8")))) {
                                this.DisplayMessage = BaseService.GetResource("Doc_Select") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"];
                                return false;
                            }
                            else if (this.ScreenObject.ColumnSource[j].DataType == "ComboBox" && Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding])) {
                                this.DisplayMessage = BaseService.GetResource("Doc_Select") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                return false;
                            }
                            else if (this.ScreenObject.ColumnSource[j].DataType == "PactComboBox" && Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding + "_Key"])) {
                                this.DisplayMessage = BaseService.GetResource("Doc_Select") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();

                                return false;
                            }
                            else if (this.ScreenObject.ColumnSource[j].DataType == "LINK" && sDisplayMember.toLowerCase().Contains("dcalpha")) {
                                let att = this.ViewAttachments.AttachmentsList.find(a => a.RowID == this.ScreenObject.GridData[i] && a.ColID == sDisplayMember);
                                if (att == null) {
                                    this.DisplayMessage = BaseService.GetResource("Doc_Select") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                    return false;
                                }
                            }
                            else if (this.ScreenObject.ColumnSource[j].DataType != "PactComboBox" && this.ScreenObject.ColumnSource[j].DataType != "ComboBox" && this.ScreenObject.ColumnSource[j].DataType != "LISTBOX"
                                && (Util.IsEmpty(this.ScreenObject.GridData[i][sDisplayMember]) ||
                                    (this.ScreenObject.ColumnSource[j].DataType == "FLOAT" && !Util.IsEmpty(this.ScreenObject.GridData[i][sDisplayMember]) &&
                                        parseFloat(this.ScreenObject.GridData[i][sDisplayMember]) == 0))) {
                                if (this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("Quantity") && this.ScreenObject.GridDataColumns.Contains("FreeQTY") && this.ScreenObject.ColumnSource[j].DataType == "FLOAT"
                                    && !Util.IsEmpty(this.ScreenObject.GridData[i]["FreeQTY"]) && Util.Double(this.ScreenObject.GridData[i]["FreeQTY"]) > 0
                                    && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && Util.Double(this.ScreenObject.GridData[i]["Quantity"]) == 0) {
                                    this.DisplayMessage = "";
                                    this.MessageVisibility = false;
                                }
                                else {
                                    this.DisplayMessage = BaseService.GetResource("Doc_Enter") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                    return false;
                                }
                            }
                        }

                        if (Validate) {
                            this.DisplayMessage = this.ValidateMinMax(this.ScreenObject.ColumnSource[j], this.ScreenObject.GridData[i]);
                            if (this.DisplayMessage.ToString() != "") {
                                this.MessageVisibility = true;
                                return false;
                            }
                        }

                        if (this.ScreenObject.IsPayrollDocument) {
                            if (Validate && !this.ValidateDataonSave_col_dr(this.ScreenObject.ColumnSource[j], this.ScreenObject.GridData[i]))
                                return false;
                        }
                        else {
                            if (Validate && !Util.IsEmpty(this.ScreenObject.GridData[i]["Type"]) && parseInt(this.ScreenObject.GridData[i]["Type"]) != 8 && !this.ValidateDataonSave_col_dr(this.ScreenObject.ColumnSource[j], this.ScreenObject.GridData[i]))
                                return false;
                        }

                        if (this.ScreenObject.ColumnSource[j].DistributeColName == "FillGUID" && !(!Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"]) && parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) > 0))
                            this.ScreenObject.GridData[i][sDisplayMember] = Util.NewGuid();

                        if (this.ScreenObject.ColumnSource[j].IsColumnUserDefined) {
                            if (this.ScreenObject.ColumnSource[j].linkData == 56671 || sDisplayMember.toLowerCase().Contains("dcexchrt") || sDisplayMember.toLowerCase().Contains("dccurrid"))
                                continue;

                            if (sDisplayMember.toLowerCase().Contains("dcnum")) {
                                if (this.ScreenObject.Preferences.ContainsKey("JobRemainingQty") && this.ScreenObject.GridDataColumns.Contains("RemQty") && sDisplayMember.toLowerCase() == this.ScreenObject.Preferences["JobRemainingQty"].toLowerCase())
                                    continue;
                                if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                                    if (this.ScreenObject.ColumnSource[j].DefaultValue == "-2") {
                                        if (this.ScreenObject.ColumnSource[j].SectionID == 4) {
                                            let drrows = this.ScreenObject.FooterGridData.filter(x => x.ColumnName == sDisplayMember);
                                            if (drrows.length > 0) {
                                                if (!Util.IsEmpty(drrows[0]["dcCurrID_Key"])) {
                                                    CurrID = parseInt(drrows[0]["dcCurrID_Key"]);
                                                    if (!Util.IsEmpty(drrows[0]["dcExchRT"]))
                                                        ExhgRate = parseFloat(drrows[0]["dcExchRT"]);
                                                    else
                                                        ExhgRate = 1;
                                                }
                                            }
                                        }
                                        else {
                                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCurrID" + sDisplayMember.toLowerCase().replace("dcnum", "") + "_Key"]))
                                                CurrID = parseInt(this.ScreenObject.GridData[i]["dcCurrID" + sDisplayMember.toLowerCase().replace("dcnum", "") + "_Key"]);
                                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcExchRT" + sDisplayMember.toLowerCase().replace("dcnum", "")]))
                                                ExhgRate = parseFloat(this.ScreenObject.GridData[i]["dcExchRT" + sDisplayMember.toLowerCase().replace("dcnum", "")]);
                                        }
                                    }
                                    else {
                                        let def = Util.Int(this.ScreenObject.ColumnSource[j].DefaultValue);
                                        if (def > 0 && this.ScreenObject.ColumnSource[j].CurrID > 0) {
                                            CurrID = this.ScreenObject.ColumnSource[j].CurrID;
                                            ExhgRate = this.ScreenObject.ColumnSource[j].ExhcgRt;
                                        }
                                    }
                                }


                                let tempval = 0;

                                if (this.savebulk) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[i][sDisplayMember])) {
                                        sbNumeric += sDisplayMember + "=\"" + this.ScreenObject.GridData[i][sDisplayMember].toString() + "\" ";
                                        tempval = 0;
                                        tempval = Util.Double(this.ScreenObject.GridData[i]["dcCalc" + sDisplayMember]);
                                        if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                                            sbNumeric += "dcCurrID" + sDisplayMember.toLowerCase().Replace("dcnum", "") + "=\"" + CurrID + "\" ";
                                            sbNumeric += "dcExchRT" + sDisplayMember.toLowerCase().Replace("dcnum", "") + "=\"" + ExhgRate + "\" ";
                                            sbNumeric += "dcCalcNumFC" + sDisplayMember.toLowerCase().Replace("dcnum", "") + "=\"" + tempval + "\" ";
                                        }
                                        sbNumeric += "dcCalc" + sDisplayMember.Replace("dc", "") + "=\"" + tempval * ExhgRate + "\" ";

                                    }
                                }
                                else {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[i][sDisplayMember]))
                                        sbNumeric += sDisplayMember + "=" + this.ScreenObject.GridData[i][sDisplayMember].toString() + ", ";
                                    else
                                        sbNumeric += sDisplayMember + "=0, ";

                                    tempval = 0;
                                    tempval = Util.Double(this.ScreenObject.GridData[i]["dcCalc" + sDisplayMember]);

                                    if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                                        sbNumeric += "dcCurrID" + sDisplayMember.toLowerCase().Replace("dcnum", "") + "=" + CurrID + ", ";
                                        sbNumeric += "dcExchRT" + sDisplayMember.toLowerCase().Replace("dcnum", "") + "=" + ExhgRate + ", ";
                                        sbNumeric += "dcCalcNumFC" + sDisplayMember.toLowerCase().Replace("dcnum", "") + "=" + tempval + ", ";
                                    }
                                    sbNumeric += "dcCalc" + sDisplayMember.Replace("dc", "") + "=" + tempval * ExhgRate + ", ";
                                }
                            }
                            else if (sDisplayMember == "Name" || sDisplayMember == "Year" || sDisplayMember.toLowerCase().Contains("dcalpha") || (this.ScreenObject.ColumnSource[j].DataType == "PactComboBox" && this.ScreenObject.ColumnSource[j].ValueBinding.toLowerCase().Contains("dcalpha"))) {
                                let refObj = { sbText: sbText }
                                this.GetRowValue(refObj, i, j);
                                sbText = refObj.sbText
                                if (this.ScreenObject.ColumnSource[j].DataType == "DATE" && Util.hasprop(this.ScreenObject.GridData[i], this.ScreenObject.ColumnSource[j].DisplayMember + "_Key") && Util.String(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]) != ""//added by khasim need to checkonce hasprop condition
                                    && this.ScreenObject.Preferences.ContainsKey("BUDGET_BudgetDateField") && !Util.IsEmpty(this.ScreenObject.Preferences["BUDGET_BudgetDateField"]) && this.ScreenObject.ColumnSource[j].DisplayMember == this.ScreenObject.Preferences["BUDGET_BudgetDateField"])
                                    sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + Util.ParseDate(Util.String(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"])).ToString("dd/MMM/yyyy") + "\" ";
                                if (this.ScreenObject.ColumnSource[j].DataType == "LISTBOX" && this.ScreenObject.ColumnSource[j].CostCenterID != 0
                                    && this.ScreenObject.Preferences.ContainsKey("BUDGET_BudgetAccountField") && !Util.IsEmpty(this.ScreenObject.Preferences["BUDGET_BudgetAccountField"]) && this.ScreenObject.ColumnSource[j].DisplayMember == this.ScreenObject.Preferences["BUDGET_BudgetAccountField"])
                                    sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember] + "\" ";
                            }
                            else if (this.ScreenObject.ColumnSource[j].CostCenterID != 0) {
                                if (this.ScreenObject.DocumentType == 5 && FromTOCount == 1) {
                                    if (this.ScreenObject.ColumnSource[j].DisplayMember.Contains("TO") && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) && parseInt(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) > 0) {
                                        sbCC += this.ScreenObject.ColumnSource[j].DisplayMember.replace("TO", "") + "=" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember] + ", ";
                                    }
                                    else if (!this.ScreenObject.ColumnSource[j].DisplayMember.Contains("TO")) {
                                        let cfld = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "TO" + this.ScreenObject.ColumnSource[j].DisplayMember);
                                        if (!cfld && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) && parseInt(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) > 0) {
                                            sbCC += this.ScreenObject.ColumnSource[j].DisplayMember + "=" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember] + ", ";
                                        }
                                    }
                                }
                                else if (this.ScreenObject.DocumentType == 5 && FromTOCount == 0 && !this.ScreenObject.ColumnSource[j].DisplayMember.Contains("TO") && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) && parseInt(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) > 0) {
                                    sbCC += this.ScreenObject.ColumnSource[j].DisplayMember + "=" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember] + ", ";
                                }
                                else if (this.ScreenObject.DocumentType != 5) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) && parseInt(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) > 0) {
                                        if (this.savebulk)
                                            sbCC += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember] + "\" ";
                                        else
                                            sbCC += this.ScreenObject.ColumnSource[j].DisplayMember + "=" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember] + ", ";
                                    }
                                    else if (!this.savebulk)
                                        sbCC += this.ScreenObject.ColumnSource[j].DisplayMember + "=1, ";
                                }
                            }
                            else if (!this.savebulk)
                                sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) + "', ";

                        }
                        else {
                            if (this.ScreenObject.ColumnSource[j].CostCenterID == 3) {
                                if (!IsProductIDAdded)
                                    sbStatic += "ProductID=\"" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember] + "\" ";
                                IsProductIDAdded = true;
                            }
                            else if (this.ScreenObject.ColumnSource[j].CostCenterID != 0) {

                                if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) && parseInt(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) > 0 && this.ScreenObject.ColumnSource[j].DisplayMember != "CurrencyID")
                                    sbStatic += this.ScreenObject.ColumnSource[j].ValueMember.substr(0, this.ScreenObject.ColumnSource[j].ValueMember.length - 4) + "=\"" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember] + "\" ";

                                if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "unit") {
                                    if (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(this.ScreenObject.GridData[i]["FreeQTY"]) && parseFloat(this.ScreenObject.GridData[i]["FreeQTY"]) > 0) {
                                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["UOMConversion"]))
                                            this.ScreenObject.GridData[i]["UOMConvertedQty"] = parseFloat(this.ScreenObject.GridData[i]["FreeQTY"]) * parseFloat(this.ScreenObject.GridData[i]["UOMConversion"]);
                                        else
                                            this.ScreenObject.GridData[i]["UOMConvertedQty"] = this.ScreenObject.GridData[i]["FreeQTY"].toString();
                                    }
                                    sbStatic += "UOMConversion=\"" + this.ScreenObject.GridData[i]["UOMConversion"].toString() + "\" ";
                                    if (this.ScreenObject.DocumentType == 5 && FromTOCount == 1 && this.ScreenObject.GridDataColumns.Contains("RecievedQty")) {
                                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["RecievedQty"])) {
                                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["UOMConversion"]))
                                                sbStatic += "UOMConvertedQty=\"" + parseFloat(this.ScreenObject.GridData[i]["UOMConversion"]) * parseFloat(this.ScreenObject.GridData[i]["RecievedQty"]) + "\" ";
                                            else
                                                sbStatic += "UOMConvertedQty=\"" + this.ScreenObject.GridData[i]["RecievedQty"].toString() + "\" ";
                                        }
                                        else
                                            sbStatic += "UOMConvertedQty=\"0\" ";
                                    }
                                    else {
                                        if (this.ScreenObject.DocumentType == 38 && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) < 0)
                                            sbStatic += "UOMConvertedQty=\"" + this.ScreenObject.GridData[i]["UOMConvertedQty"].toString().replace("-", "") + "\" ";
                                        else
                                            sbStatic += "UOMConvertedQty=\"" + this.ScreenObject.GridData[i]["UOMConvertedQty"].toString() + "\" ";
                                    }
                                }
                            }
                            else {
                                if (this.ScreenObject.ColumnSource[j].DisplayMember == "DocDetailsID") {

                                    if (this.ScreenObject.DocumentType == 5 && FromTOCount == 1) {
                                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["TODocDetailsID"]) && (parseInt(this.ScreenObject.GridData[i]["TODocDetailsID"]) > 0 || parseInt(this.ScreenObject.GridData[i]["TODocDetailsID"]) < -10000))
                                            DocDetailsID += "~" + this.ScreenObject.GridData[i]["TODocDetailsID"].toString();

                                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["TODocDetailsID"]))
                                            sbStatic += " DocDetailsID=\"" + this.ScreenObject.GridData[i]["TODocDetailsID"].toString() + "\" ";
                                        else
                                            sbStatic += " DocDetailsID=\"0\" ";
                                    }
                                    else {
                                        if (IsEnableRevise && this.ScreenObject.DocID > 0 && this.ScreenObject.DocPrefix.RevisionCombo.Visible && this.ScreenObject.DocPrefix.RevisionCombo.Items.length > 1 &&
                                            this.ScreenObject.DocPrefix.RevisionCombo.SelectedValue != this.ScreenObject.DocPrefix.RevisionCombo.Items[this.ScreenObject.DocPrefix.RevisionCombo.Items.length - 1].Value
                                            && !Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"]) && (parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) > 0 || parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) < -10000)) {
                                            this.ScreenObject.GridData[i]["DocDetailsID"] = "0";
                                        }
                                        else {

                                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"]) && (parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) > 0 || parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) < -10000))
                                                DocDetailsID += "~" + this.ScreenObject.GridData[i]["DocDetailsID"].toString();

                                            if (this.ScreenObject.GridData[i]["DocDetailsID"] == undefined) {
                                                this.ScreenObject.GridData[i]["DocDetailsID"] = 0;
                                            }
                                            sbStatic += " DocDetailsID=\"" + this.ScreenObject.GridData[i]["DocDetailsID"] + "\" ";
                                            if (this.savebulk) {
                                                sbCC += " DocDetailsID=\"" + this.ScreenObject.GridData[i]["DocDetailsID"] + "\" ";
                                                sbText += " DocDetailsID=\"" + this.ScreenObject.GridData[i]["DocDetailsID"] + "\" ";
                                                sbNumeric += " DocDetailsID=\"" + this.ScreenObject.GridData[i]["DocDetailsID"] + "\" ";
                                            }
                                        }
                                    }
                                }
                                else if (this.ScreenObject.ColumnSource[j].DataType == "ComboBox")
                                    sbStatic += this.ScreenObject.ColumnSource[j].ValueBinding + "=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding]) + "\" ";
                                else if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "quantity") {
                                    if (this.ScreenObject.DocumentType == 5 && FromTOCount == 1 && this.ScreenObject.GridDataColumns.Contains("RecievedQty")) {
                                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["RecievedQty"]))
                                            sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.GridData[i]["RecievedQty"]) + "\" ";
                                        else
                                            sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"0\" ";
                                    }
                                    else if (!Util.IsEmpty(this.ScreenObject.GridData[i]["SchemeID"]) && parseInt(this.ScreenObject.GridData[i]["SchemeID"]) > 0
                                        && this.ScreenObject.GridDataColumns.Contains("FreeQTY") && this.ScreenObject.GridData[i]["IsScheme"].toString() == "Y")
                                        sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.GridData[i]["FreeQTY"]) + "\" ";
                                    else {
                                        if (this.ScreenObject.DocumentType == 38 && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) < 0) {
                                            sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + this.ScreenObject.GridData[i]["Quantity"].toString().replace("-", "") + "\" ";
                                            sbStatic += " VoucherType=\"1\" ";
                                        }
                                        else
                                            sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.GridData[i]["Quantity"]) + "\" ";
                                    }
                                }
                                else if (this.ScreenObject.ColumnSource[j].DataType == "DATE") {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]))
                                        sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("dd/MMM/yyyy") + "\" ";
                                }
                                else if (this.ScreenObject.ColumnSource[j].DisplayMember == "DocSeqNo") {

                                    if (this.EnableCrossDimPostingXML)
                                        sbStatic += "DocOrder" + "=\"" + this.ScreenObject.GridData[i]["DocOrder"] + "\" ";

                                    this.ScreenObject.GridData[i]["DocSeqNo"] = RowCount;
                                    sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + RowCount + "\" ";
                                    if (this.savebulk) {
                                        sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + RowCount + "\" ";
                                        sbNumeric += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + RowCount + "\" ";
                                        sbCC += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + RowCount + "\" ";
                                    }
                                }
                                else {
                                    if (this.ScreenObject.DocumentType == 38 && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) < 0
                                        && sDisplayMember.toLowerCase() == "gross")
                                        sbStatic += sQueryAttribute + "=\"" + this.ScreenObject.GridData[i][sDisplayMember].toString().replace("-", "") + "\" ";
                                    else
                                        sbStatic += sQueryAttribute + "=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) + "\" ";
                                    if (sender != null && sender.toString() == "SaveonHold" && sDisplayMember.toLowerCase() == "quantity") {
                                        let holdcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "holdquantity");
                                        if (!holdcol) {
                                            sbStatic += "HoldQuantity" + "=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.GridData[i][sDisplayMember]) + "\" ";
                                        }
                                    }
                                }
                            }
                        }

                        let PostingValue = "";
                        if (this.ScreenObject.ColumnSource[j].DataType != "ComboBox" && this.ScreenObject.ColumnSource[j].PostingType > 0)
                            PostingValue = Util.String(this.ScreenObject.GridData[i][sDisplayMember]);
                        if (sDisplayMember.toLowerCase().Contains("dcnum"))
                            PostingValue = Util.String(this.ScreenObject.GridData[i]["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember]);

                        if (this.DocumentType == 5 && FromTOCount == 0 && this.ScreenObject.ColumnSource[j].Dependancy == 2)
                            PostingValue = "";
                        else if (this.DocumentType == 5 && FromTOCount == 1 && this.ScreenObject.ColumnSource[j].Dependancy == 3)
                            PostingValue = "";
                        if (this.ScreenObject.Preferences.ContainsKey("KitAccPosting") && this.ScreenObject.Preferences["KitAccPosting"] == "True" &&
                            (Util.String(this.ScreenObject.GridData[i]["Type"]) == "8" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "3" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "11" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "12"))
                            PostingValue = "";
                        if (sender != null && sender.toString() != "SaveonHold" && !DonotUpdateAccounts && (this.ScreenObject.ColumnSource[j].PostingType == 3 || this.ScreenObject.ColumnSource[j].PostingType == 4) && PostingValue != "" && Util.Double(PostingValue) != 0) {
                            let outObj = { DBAcc: 0, CrACC: 0, PostingXml: "" };
                            if (!this.FillAccountPosting(this.ScreenObject.ColumnSource[j], this.ScreenObject.GridData[i], PostingValue, CurrID, ExhgRate, outObj, 0, RowCount))
                                return false;
                            let DBAcc = outObj.DBAcc, CrACC = outObj.CrACC;
                            this.FillPaytermDt(accid, CrACC, DBAcc, PostingValue, this.ScreenObject.GridData[i], this.ScreenObject.ColumnSource[j].DisplayMember, this.ScreenObject.ColumnSource[j].DecimalPoints);
                            if (costDims != null || this.ScreenObject.ColumnSource[j].distDim > 0) {
                                let refObjCost = { CostXML: '' };//, docextra:''}
                                let tempXML = '', ExtraTemp;
                                if (this.FillCostPosting(DBAcc, CrACC, parseFloat(PostingValue), this.ScreenObject.GridData[i], costDims, CurrID, ExhgRate, this.ScreenObject.ColumnSource[j], refObjCost)) {
                                    CostXMl += refObjCost.CostXML;;
                                }
                                else
                                    sbRows += outObj.PostingXml;
                                if (!this.IgnoreOnSave.ContainsKey('BillWisedt')) {
                                    this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.CrACC.toString(), PostingValue, true, CurrID, ExhgRate, FromTOCount, (this.ScreenObject.ColumnSource[j].NoRoundOff) ? "6" : this.ScreenObject.ColumnSource[j].DecimalPoints, RowCount);
                                    this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.DBAcc.toString(), PostingValue, false, CurrID, ExhgRate, FromTOCount, (this.ScreenObject.ColumnSource[j].NoRoundOff) ? "6" : this.ScreenObject.ColumnSource[j].DecimalPoints, RowCount);
                                }
                            }
                            else if (DistCost && (accid == CrACC || accid == DBAcc) && (ToAccid == CrACC || ToAccid == DBAcc)) {
                                if (!this.IgnoreOnSave.ContainsKey('BillWisedt')) {
                                    if (accid == CrACC)
                                        this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.CrACC.toString(), PostingValue, true, CurrID, ExhgRate, FromTOCount, (this.ScreenObject.ColumnSource[j].NoRoundOff) ? "6" : this.ScreenObject.ColumnSource[j].DecimalPoints, RowCount);
                                    else
                                        this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.DBAcc.toString(), PostingValue, false, CurrID, ExhgRate, FromTOCount, (this.ScreenObject.ColumnSource[j].NoRoundOff) ? "6" : this.ScreenObject.ColumnSource[j].DecimalPoints, RowCount);
                                }
                            }
                            else if (this.ScreenObject.Preferences.ContainsKey("DistributeCost") && this.ScreenObject.Preferences["DistributeCost"].toString() == "True" && (accid == outObj.CrACC || accid == outObj.DBAcc)) {
                                if (accid == outObj.CrACC) {
                                    if (this.ScreenObject.DocID == 0)
                                        this.ScreenObject.DistributeCostXML += "<Row AccountID=\"" + outObj.DBAcc.toString() + "\" Amount=\"" + PostingValue + "\" />";
                                    this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.CrACC.toString(), PostingValue, true, CurrID, ExhgRate, FromTOCount, (this.ScreenObject.ColumnSource[j].NoRoundOff) ? "6" : this.ScreenObject.ColumnSource[j].DecimalPoints, RowCount);
                                }
                                else {
                                    if (this.ScreenObject.DocID == 0)
                                        this.ScreenObject.DistributeCostXML += "<Row AccountID=\"" + outObj.CrACC.toString() + "\" Amount=\"" + PostingValue + "\" />";
                                    if (!this.IgnoreOnSave.ContainsKey('BillWisedt')) {
                                        this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.DBAcc.toString(), PostingValue, false, CurrID, ExhgRate, FromTOCount, (this.ScreenObject.ColumnSource[j].NoRoundOff) ? "6" : this.ScreenObject.ColumnSource[j].DecimalPoints, RowCount);
                                    }
                                }
                            }
                            else {
                                sbRows += outObj.PostingXml;
                                if (!this.IgnoreOnSave.ContainsKey('BillWisedt')) {
                                    this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.CrACC.toString(), PostingValue, true, CurrID, ExhgRate, FromTOCount, (this.ScreenObject.ColumnSource[j].NoRoundOff) ? "6" : this.ScreenObject.ColumnSource[j].DecimalPoints, RowCount);
                                    this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.DBAcc.toString(), PostingValue, false, CurrID, ExhgRate, FromTOCount, (this.ScreenObject.ColumnSource[j].NoRoundOff) ? "6" : this.ScreenObject.ColumnSource[j].DecimalPoints, RowCount);
                                }
                            }
                            if (this.ScreenObject.ColumnSource[j].SectionID == 4 && (this.ScreenObject.ColumnSource[j].Remarks != "" || this.ScreenObject.ColumnSource[j].CreditAcount == outObj.CrACC || this.ScreenObject.ColumnSource[j].DebitAccount == outObj.DBAcc)) {
                                if (Util.IsEmpty(NumXml))
                                    NumXml += "<XML>";
                                NumXml += "<Row ";
                                if (this.ScreenObject.ColumnSource[j].CreditAcount == outObj.CrACC)
                                    NumXml += " CreditAcount=\"" + outObj.CrACC + "\"";
                                if (this.ScreenObject.ColumnSource[j].DebitAccount == outObj.DBAcc)
                                    NumXml += " DebitAccount=\"" + outObj.DBAcc + "\"";
                                if (this.ScreenObject.ColumnSource[j].linkData == 23094 || this.ScreenObject.ColumnSource[j].linkData == 23095)
                                    NumXml += " PosDiscUserName=\"" + this.PosDiscUserName + "\"";
                                NumXml += " Columnname=\"" + this.ScreenObject.ColumnSource[j].DisplayMember + "\"";
                                NumXml += " Remarks=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.ColumnSource[j].Remarks) + "\" />";
                            }
                        }
                        else if (this.ScreenObject.ColumnSource[j].SectionID == 4 && (this.ScreenObject.ColumnSource[j].Remarks != "" || this.ScreenObject.ColumnSource[j].CreditAcount > 0 || this.ScreenObject.ColumnSource[j].DebitAccount > 0)) {
                            if (Util.IsEmpty(NumXml))
                                NumXml += "<XML>";
                            NumXml += "<Row ";
                            if (this.ScreenObject.ColumnSource[j].CreditAcount > 0)
                                NumXml += " CreditAcount=\"" + this.ScreenObject.ColumnSource[j].CreditAcount + "\"";
                            if (this.ScreenObject.ColumnSource[j].DebitAccount > 0)
                                NumXml += " DebitAccount=\"" + this.ScreenObject.ColumnSource[j].DebitAccount + "\"";
                            if (this.ScreenObject.ColumnSource[j].linkData == 23094 || this.ScreenObject.ColumnSource[j].linkData == 23095)
                                NumXml += " PosDiscUserName=\"" + this.PosDiscUserName + "\"";
                            NumXml += " Columnname=\"" + this.ScreenObject.ColumnSource[j].DisplayMember + "\"";
                            NumXml += " Remarks=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.ColumnSource[j].Remarks) + "\" />";
                        }
                        if ((this.ScreenObject.ColumnSource[j].PostingType == 2 || this.ScreenObject.ColumnSource[j].PostingType == 4) && Util.Double(PostingValue) != 0)
                            StockValue += parseFloat(PostingValue) * ExhgRate;
                        if ((this.ScreenObject.ColumnSource[j].PostingType == 3 || this.ScreenObject.ColumnSource[j].PostingType == 4) && Util.Double(PostingValue) != 0)
                            NetValue += parseFloat(PostingValue) * ExhgRate;

                        if (this.ScreenObject.ColumnSource[j].distDim > 0) {
                            let xtraDoc: any = new XmlDocument();
                            if (this.ScreenObject.ColumnSource[j].distLineWise && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "DistXML"]))
                                xtraDoc.LoadXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "DistXML"].toString());
                            else if (!Util.IsEmpty(this.ScreenObject.ColumnSource[j].distxml))
                                xtraDoc.LoadXml(this.ScreenObject.ColumnSource[j].distxml);

                            let xList: any = xtraDoc.SelectNodes("XML/Rows");
                            for (let l = 0; l < xList.length; l++) {
                                if (!Util.IsEmpty(xList[l].attributes["Percent"]) && !Util.IsEmpty(xList[l].attributes["DCCCNID" + (this.ScreenObject.ColumnSource[j].distDim - 50000)])) {
                                    DOcExtraXml += "<DocExtraXML><Row  RefID=\"" + xList[l].attributes["DCCCNID" + (this.ScreenObject.ColumnSource[j].distDim - 50000)].value + "\" ";
                                    DOcExtraXml += " Label=\"" + this.ScreenObject.ColumnSource[j].DisplayMember;
                                    DOcExtraXml += "\" Qty=\"" + xList[l].attributes["Percent"].value;
                                    DOcExtraXml += "\"  Type=\"50\"  ></Row></DocExtraXML>";
                                }
                            }
                        }
                    }

                    if (this.ScreenObject.Preferences.ContainsKey("JobRemainingQty") && this.ScreenObject.GridDataColumns.Contains("RemQty")) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["RemQty"])) {
                            sbNumeric += "dcCalc" + this.ScreenObject.Preferences["JobRemainingQty"].Replace("dc", "") + "=" + this.ScreenObject.GridData[i]["RemQty"].toString().Replace(",", "") + ", ";
                            sbNumeric += this.ScreenObject.Preferences["JobRemainingQty"] + "=" + this.ScreenObject.GridData[i]["RemQty"].toString().Replace(",", "") + ", ";
                        }
                        else {
                            sbNumeric += "dcCalc" + this.ScreenObject.Preferences["JobRemainingQty"].Replace("dc", "") + "=0,";
                            sbNumeric += this.ScreenObject.Preferences["JobRemainingQty"] + "=0,";
                        }
                    }

                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["LinkedFieldName"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["LinkedInvDocDetailsID"])
                        && Util.IsValidID(parseInt(this.ScreenObject.GridData[i]["LinkedInvDocDetailsID"])) && FromTOCount == 0
                        && this.ScreenObject.GridDataColumns.Contains(Util.String(this.ScreenObject.GridData[i]["LinkedFieldName"]))) {
                        if (this.ScreenObject.GridData[i]["LinkedFieldName"].toString().toLowerCase() == "quantity" && this.ScreenObject.GridDataColumns.Contains("FreeQTY")
                            && !Util.IsEmpty(this.ScreenObject.GridData[i]["FreeQTY"]) && parseFloat(this.ScreenObject.GridData[i]["FreeQTY"]) > 0)
                            sbStatic += "LinkedFieldValue=\"" + this.ScreenObject.GridData[i]["FreeQTY"].toString() + "\" ";
                        else
                            sbStatic += "LinkedFieldValue=\"" + this.ScreenObject.GridData[i][this.ScreenObject.GridData[i]["LinkedFieldName"].toString()].toString() + "\" ";
                    }
                    if ((sender != null && sender.toString() == "SaveonHold") || this.DonotUpdateInventory || (!Util.IsEmpty(this.ScreenObject.GridData[i]["Type"]) && (parseInt(this.ScreenObject.GridData[i]["Type"]) == 6 || parseInt(this.ScreenObject.GridData[i]["Type"]) == 8 || parseInt(this.ScreenObject.GridData[i]["Type"]) == 3 || parseInt(this.ScreenObject.GridData[i]["Type"]) == 11)))
                        sbStatic += " IsQtyIgnored=\"1\" ";
                    else {
                        if (this.ScreenObject.Preferences.ContainsKey("StockBasedon") && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["StockBasedon"]) &&
                            this.ScreenObject.GridData[i][this.ScreenObject.Preferences["StockBasedon"]].toString() != "1")
                            sbStatic += " IsQtyIgnored=\"1\" ";
                        else if (this.DonotUpdateSchemeQty && this.ScreenObject.GridDataColumns.Contains("FreeQTY")
                            && Util.Double(this.ScreenObject.GridData[i]["FreeQTY"]) > 0)
                            sbStatic += " IsQtyIgnored=\"1\" ";
                        else if (this.ScreenObject.Preferences.ContainsKey("ConsBatch") && this.ScreenObject.Preferences["ConsBatch"] == "True"
                            && this.ScreenObject.GridData[i]["Type"].toString() == "5")
                            sbStatic += " IsQtyIgnored=\"1\" BatchQtyIgnored=\"0\" ";
                        else
                            sbStatic += " IsQtyIgnored=\"0\" ";
                    }

                    sbStatic += "AverageRate=\"" + Util.String(this.ScreenObject.GridData[i]["AVGRATE"]) + "\" ";

                    if (this.ScreenObject.GridDataColumns.Contains("ParentSeqNo"))
                        sbStatic += "ParentSeqNo=\"" + this.ScreenObject.GridData[i]["ParentSeqNo"].toString() + "\" ";

                    if (this.ScreenObject.DocumentType == 38 && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) < 0)
                        StockValue = StockValue * -1;

                    sbStatic += "StockValue=\"" + StockValue.toString() + "\" ";
                    sbStatic += "Net=\"" + this.NetAmount.Replace(",", "") + "\" ";

                    if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                        sbStatic += "StockValueFC=\"" + StockValue / parseFloat(this.Currency.ExchangeRate.Text) + "\" ";
                    else
                        sbStatic += "StockValueFC=\"" + StockValue + "\" ";

                    let drlinkedrows = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 56671);
                    if (drlinkedrows.length > 0) {
                        StockValue = StockValue / parseFloat(this.ScreenObject.GridData[i]["UOMConvertedQty"]);
                        if (BaseService.SessionManager.Preferences.ContainsKey("DecimalsinAmount") && BaseService.SessionManager.Preferences["DecimalsinAmount"] != "")
                            StockValue = parseFloat(StockValue.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));
                        if (drlinkedrows[0]["SysColumnName"].toLowerCase().Contains("dcnum")) {
                            if (this.savebulk)
                                sbNumeric += drlinkedrows[0]["SysColumnName"] + "=\"" + StockValue + "\" " + "dcCalc" + drlinkedrows[0]["SysColumnName"].replace("dc", "") + "=\"" + StockValue + "\" ";
                            else
                                sbNumeric += drlinkedrows[0]["SysColumnName"] + "=" + StockValue + "," + "dcCalc" + drlinkedrows[0]["SysColumnName"].replace("dc", "") + "=" + StockValue + ", ";
                        }
                        else {
                            if (this.savebulk)
                                sbText += drlinkedrows[0]["SysColumnName"] + "=\"" + StockValue + "\" ";
                            else
                                sbText += drlinkedrows[0]["SysColumnName"] + "='" + StockValue + "', ";
                        }
                        if (this.ScreenObject.GridDataColumns.Contains(drlinkedrows[0]["SysColumnName"]))
                            this.ScreenObject.GridData[i][drlinkedrows[0]["SysColumnName"]] = StockValue;

                        if (this.ScreenObject.GridDataColumns.Contains("dcCalc" + drlinkedrows[0]["SysColumnName"]))
                            this.ScreenObject.GridData[i]["dcCalc" + drlinkedrows[0]["SysColumnName"]] = StockValue;
                    }

                    if (this.Currency != null && this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue != "")
                        sbStatic += "CurrencyID=\"" + this.Currency.Currency.SelectedValue.toString() + "\" ";
                    else
                        sbStatic += "CurrencyID=\"" + this.GetCurrencyID(i) + "\" ";

                    if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                        sbStatic += "ExchangeRate=\"" + this.Currency.ExchangeRate.Text.toString() + "\" ";
                    else
                        sbStatic += "ExchangeRate=\"" + this.GetExchRate(i) + "\" ";

                    if (this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 8 || this.ScreenObject.DocumentType == 13) {
                        if (this.ScreenObject.DocumentType == 3) {
                            if (!sbStatic.toString().Contains("DebitAccount=") && !this.ScreenObject.strStaticFields.Contains("DebitAccount="))
                                sbStatic += "DebitAccount=\"" + BaseService.SessionManager.ReservedOSAccount + "\" ";
                            if (!sbStatic.toString().Contains("CreditAccount=") && !this.ScreenObject.strStaticFields.Contains("CreditAccount="))
                                sbStatic += " CreditAccount=\"" + BaseService.SessionManager.ReservedOSAccount + "\" ";
                        }
                        else if (this.ScreenObject.DocumentType == 13) {
                            if (!sbStatic.toString().Contains("DebitAccount=") && !this.ScreenObject.strStaticFields.Contains("DebitAccount="))
                                sbStatic += "DebitAccount=\"" + BaseService.SessionManager.ReservedESAccount + "\" ";
                            if (!sbStatic.toString().Contains("CreditAccount=") && !this.ScreenObject.strStaticFields.Contains("CreditAccount="))
                                sbStatic += " CreditAccount=\"" + BaseService.SessionManager.ReservedESAccount + "\" ";
                        }
                        else if (this.ScreenObject.DocumentType == 8) {
                            if (!sbStatic.toString().Contains("DebitAccount=") && !this.ScreenObject.strStaticFields.Contains("DebitAccount="))
                                sbStatic += "DebitAccount=\"" + BaseService.SessionManager.ReservedSSAccount + "\" ";
                            if (!sbStatic.toString().Contains("CreditAccount=") && !this.ScreenObject.strStaticFields.Contains("CreditAccount="))
                                sbStatic += " CreditAccount=\"" + BaseService.SessionManager.ReservedSSAccount + "\" ";
                        }
                    }



                    sbNumeric += this.ScreenObject.strnumericFields;
                    if (this.savebulk)
                        sbNumeric += " >";
                    else {
                        sbNumeric += "\" >";
                        if (!Util.IsEmpty(NumXml)) {
                            NumXml += "</XML>";
                            sbNumeric += NumXml.toString();
                        }
                    }
                    sbNumeric += "</Numeric>";
                    if (this.savebulk)
                        sbText += this.ScreenObject.strTextFields + " ></Alpha>";
                    else
                        sbText += this.ScreenObject.strTextFields + "\" ></Alpha>";
                    if (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True" && !sbCC.toString().Contains("dcCCNID1=") && !this.ScreenObject.strCCFields.Contains("dcCCNID1=")) {
                        if (this.savebulk) {
                            if (this.ScreenObject.DivisionID > 0)
                                sbCC += " dcCCNID1=\" " + this.ScreenObject.DivisionID.toString() + "\" ";
                            else if (BaseService.SessionManager.DivisionID > 0)
                                sbCC += " dcCCNID1=\" " + BaseService.SessionManager.DivisionID.toString() + "\" ";
                        }
                        else {
                            if (this.ScreenObject.DivisionID > 0)
                                sbCC += " dcCCNID1=" + this.ScreenObject.DivisionID.toString() + ", ";
                            else if (BaseService.SessionManager.DivisionID > 0)
                                sbCC += " dcCCNID1=" + BaseService.SessionManager.DivisionID.toString() + ", ";
                        }

                    }
                    if (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True" && !sbCC.toString().Contains("dcCCNID2=") && !this.ScreenObject.strCCFields.Contains("dcCCNID2=")) {
                        if (this.savebulk) {
                            if (this.ScreenObject.LocationID > 0)
                                sbCC += " dcCCNID2=\" " + this.ScreenObject.LocationID.toString() + "\" ";
                            else if (BaseService.SessionManager.LocationID > 0)
                                sbCC += " dcCCNID2=\" " + BaseService.SessionManager.LocationID.toString() + "\" ";
                        }
                        else {
                            if (this.ScreenObject.LocationID > 0)
                                sbCC += " dcCCNID2=" + this.ScreenObject.LocationID.toString() + ", ";
                            else if (BaseService.SessionManager.LocationID > 0)
                                sbCC += " dcCCNID2=" + BaseService.SessionManager.LocationID.toString() + ", ";
                        }

                    }

                    if (!this.savebulk) {
                        if (this.ScreenObject.Preferences.ContainsKey("StageCCID") && this.ScreenObject.Preferences["StageCCID"].toString() != "" && parseInt(this.ScreenObject.Preferences["StageCCID"]) > 50000
                            && !sbCC.toString().Contains("dcCCNID" + (parseInt(this.ScreenObject.Preferences["StageCCID"]) - 50000) + "=") && !this.ScreenObject.strCCFields.Contains("dcCCNID" + (parseInt(this.ScreenObject.Preferences["StageCCID"]) - 50000) + "=")
                            && this.ScreenObject.GridDataColumns.Contains("StageID")) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["StageID"])) {
                                sbCC += " dcCCNID" + (parseInt(this.ScreenObject.Preferences["StageCCID"]) - 50000) + "=" + this.ScreenObject.GridData[i]["StageID"].toString() + ", ";
                            }
                        }
                        if (this.ScreenObject.Preferences.ContainsKey("jobCCID") && this.ScreenObject.Preferences["jobCCID"].toString() != "" && parseInt(this.ScreenObject.Preferences["jobCCID"]) > 50000
                            && !sbCC.toString().Contains("dcCCNID" + (parseInt(this.ScreenObject.Preferences["jobCCID"]) - 50000) + "=") && !this.ScreenObject.strCCFields.Contains("dcCCNID" + (parseInt(this.ScreenObject.Preferences["jobCCID"]) - 50000) + "=")
                            && this.ScreenObject.GridDataColumns.Contains("jobID")) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["jobID"])) {
                                sbCC += " dcCCNID" + (parseInt(this.ScreenObject.Preferences["jobCCID"]) - 50000) + "=" + this.ScreenObject.GridData[i]["jobID"].toString() + ", ";
                            }
                        }

                        if (this.ScreenObject.Preferences.ContainsKey("BomCCID") && this.ScreenObject.Preferences["BomCCID"].toString() != "" && parseInt(this.ScreenObject.Preferences["BomCCID"]) > 50000
                            && !sbCC.toString().Contains("dcCCNID" + (parseInt(this.ScreenObject.Preferences["BomCCID"]) - 50000) + "=") && !this.ScreenObject.strCCFields.Contains("dcCCNID" + (parseInt(this.ScreenObject.Preferences["BomCCID"]) - 50000) + "=")
                            && this.ScreenObject.GridDataColumns.Contains("BOMID")) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["BOMID"])) {
                                sbCC += " dcCCNID" + (parseInt(this.ScreenObject.Preferences["BomCCID"]) - 50000) + "=" + this.ScreenObject.GridData[i]["BOMID"].toString() + ", ";
                            }
                        }
                    }

                    if (Util.String(this.ScreenObject.GridData[i]["LinkedFieldName"]) == "JOB" && this.ScreenObject.GridDataColumns.Contains("NetJobQty")
                        && !Util.IsEmpty(this.ScreenObject.GridData[i]["NetJobQty"]) && Util.Double(this.ScreenObject.GridData[i]["NetJobQty"]) > 0
                        && ((this.ScreenObject.IsPurchase && BaseService.SessionManager.Preferences.ContainsKey("DoNotReceiveMoreThanJobQty") && BaseService.SessionManager.Preferences["DoNotReceiveMoreThanJobQty"].toLowerCase() == "true")
                            || (!this.ScreenObject.IsPurchase && BaseService.SessionManager.Preferences.ContainsKey("DoNotIssueMoreThanJobQty") && BaseService.SessionManager.Preferences["DoNotIssueMoreThanJobQty"].toLowerCase() == "true"))) {
                        sbStatic += " LinkedFieldValue=\"" + this.ScreenObject.GridData[i]["NetJobQty"].toString() + "\" ";

                        if (this.ScreenObject.Preferences.ContainsKey("StageCCID") && this.ScreenObject.Preferences["StageCCID"].toString() != "" && parseInt(this.ScreenObject.Preferences["StageCCID"]) > 50000
                            && this.ScreenObject.Preferences.ContainsKey("jobCCID") && this.ScreenObject.Preferences["jobCCID"].toString() != "" && parseInt(this.ScreenObject.Preferences["jobCCID"]) > 50000) {
                            sbStatic += " LinkedFieldWhere=\"";
                            sbStatic += " and dcccnid" + (parseInt(this.ScreenObject.Preferences["StageCCID"]) - 50000) + "=";
                            if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (parseInt(this.ScreenObject.Preferences["StageCCID"]) - 50000) + "_Key"))
                                sbStatic += this.ScreenObject.GridData[i]["dcCCNID" + (parseInt(this.ScreenObject.Preferences["StageCCID"]) - 50000) + "_Key"].toString();
                            else
                                sbStatic += Util.String(this.ScreenObject.GridData[i]["StageID"]);

                            sbStatic += " and dcccnid" + (parseInt(this.ScreenObject.Preferences["jobCCID"]) - 50000) + "=";
                            sbStatic += Util.String(this.ScreenObject.GridData[i]["jobID"]);
                            sbStatic += "\" ";

                            sbStatic += " JobWhere=\"";
                            sbStatic += " and StageNodeID=";
                            if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (parseInt(this.ScreenObject.Preferences["StageCCID"]) - 50000) + "_Key"))
                                sbStatic += this.ScreenObject.GridData[i]["dcCCNID" + (parseInt(this.ScreenObject.Preferences["StageCCID"]) - 50000) + "_Key"].toString();
                            else
                                sbStatic += Util.String(this.ScreenObject.GridData[i]["StageID"]);

                            sbStatic += " and NodeID=" + Util.String(this.ScreenObject.GridData[i]["jobID"]) + "\" ";

                        }
                    }

                    if (IsQtyBudLineWise) {
                        let LnWhere = QtyWhere;
                        for (let k = 0; k < QtyDim.length; k++) {
                            if (QtyDim[k] == "3")
                                LnWhere += " and ProductID=" + this.ScreenObject.GridData[i]["ProductID_Key"].toString();
                            else {
                                LnWhere += " and dcccnid" + (parseInt(QtyDim[k]) - 50000) + "=" + this.ScreenObject.GridData[i]["dcCCNID" + (parseInt(QtyDim[k]) - 50000) + "_Key"].toString();
                            }
                        }

                        sbStatic += " BudQtyWhere=\"" + LnWhere + "\" ";
                        sbStatic += " BudID=\"" + BudID + "\" ";
                        sbStatic += " BudStartDate=\"" + BudStartDate.ToString("dd/MMM/yyyy") + "\" ";
                    }

                    if (IsValueBudLineWise) {
                        let LnWhere = ValueBudWhere;
                        for (let k = 0; k < ValueDims.length; k++) {
                            if (ValueDims[k] == "3")
                                LnWhere += " and ProductID=" + this.ScreenObject.GridData[i]["ProductID_Key"].toString();
                            else {
                                LnWhere += " and dcccnid" + (parseInt(ValueDims[k]) - 50000) + "=" + this.ScreenObject.GridData[i]["dcCCNID" + (parseInt(ValueDims[k]) - 50000) + "_Key"].toString();
                            }
                        }

                        sbStatic += " ValueBudWhere=\"" + LnWhere + "\" ";
                        sbStatic += " ValueBudID=\"" + ValueBudID + "\" ";
                        sbStatic += " ValueBudStartDate=\"" + ValueBudStartDate.ToString("dd/MMM/yyyy") + "\" ";
                    }

                    if (this.IsLockDimsLineWise) {
                        let outObj = { join: "" };
                        sbStatic += " LockDims=\"" + this.GetLockQuery(this.ScreenObject.GridData[i], outObj) + "\" ";
                        if (outObj.join != "")
                            sbStatic += " LockDimsjoin=\"" + outObj.join + "\" ";
                    }
                    if (BaseService.SessionManager.RegisterCCID > 0 && this.ScreenObject.RegisterNodeID > 0 && !sbCC.toString().Contains("dcCCNID" + (BaseService.SessionManager.RegisterCCID - 50000).toString() + "=") && !this.ScreenObject.strCCFields.Contains("dcCCNID" + (BaseService.SessionManager.RegisterCCID - 50000).toString() + "=")) {
                        if (this.ScreenObject.RegisterNodeID > 0 && !this.savebulk) {
                            sbCC += " dcCCNID" + (BaseService.SessionManager.RegisterCCID - 50000).toString() + "=" + this.ScreenObject.RegisterNodeID.toString() + ", ";
                        }
                    }

                    if ((this.DocumentType == 38 || this.DocumentType == 39) && this.ScreenObject.ShiftNodeID > 0 && !this.savebulk &&
                        BaseService.SessionManager.Preferences.ContainsKey("PosShifts") && BaseService.SessionManager.Preferences["PosShifts"].toString() != "" && parseInt(BaseService.SessionManager.Preferences["PosShifts"]) > 50000
                        && !sbCC.toString().Contains("dcCCNID" + (parseInt(BaseService.SessionManager.Preferences["PosShifts"]) - 50000) + "=") && !this.ScreenObject.strCCFields.Contains("dcCCNID" + (parseInt(BaseService.SessionManager.Preferences["PosShifts"]) - 50000) + "=")) {
                        sbCC += " dcCCNID" + (parseInt(BaseService.SessionManager.Preferences["PosShifts"]) - 50000).toString() + "=" + this.ScreenObject.ShiftNodeID.toString() + ", ";
                    }

                    if (!this.savebulk)
                        sbRows += "</AccountsXML>";

                    if (this.ScreenObject.DocumentType == 5 && FromTOCount == 1) {
                        sbCC += this.ScreenObject.strTOCCFields + "\" ></CostCenters>";
                        sbStatic += " VoucherType=\"1\" ";
                    }
                    else {
                        if (this.savebulk)
                            sbCC += this.ScreenObject.strCCFields + " ></CostCenters>";
                        else
                            sbCC += this.ScreenObject.strCCFields + "\" ></CostCenters>";

                        if (this.ScreenObject.DocumentType == 5)
                            sbStatic += " VoucherType=\"-1\" ";
                    }

                    if (this.LineWiseApproval) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"]) && parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) > 0 &&
                            (Util.String(this.ScreenObject.GridData[i]["IsSelected"]) == "0" || sender.toString() == "NoWorkFlow" || sender.toString() == "NoWorkFlowReSave" || sender.toString() == "NoWorkFlowprint"
                                || (this.ScreenObject.Preferences.ContainsKey("NoWorkflowPostedDocs") && this.ScreenObject.Preferences["NoWorkflowPostedDocs"] != "" && parseBoolean(this.ScreenObject.Preferences["NoWorkflowPostedDocs"])
                                    && this.ScreenObject.GridData[i]["StatusID"].toString() == "369")))
                            sbStatic += " WorkFlowID=\"-1\" ";
                        else if (Util.String(this.ScreenObject.GridData[i]["IsSelected"]) == "2")
                            sbStatic += " WorkFlowID=\"-2\" ";
                        else if (Util.String(this.ScreenObject.GridData[i]["CanEdit"]) != "0")
                            sbStatic += " WorkFlowID=\"" + this.GetWorkFlow(false, this.ScreenObject.GridData[i]) + "\" ";
                        else
                            sbStatic += " WorkFlowID=\"-1\" ";

                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["AppRemarks"]))
                            sbStatic += " AppRemarks=\"" + this.ScreenObject.GridData[i]["AppRemarks"].toString() + "\" ";

                    }

                    let drmat = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 50040);
                    if (drmat.length > 0 && this.ScreenObject.GridDataColumns.Contains(drmat[0]["SysColumnName"])) {
                        sbStatic += " MatIndentIDColumn=\"" + drmat[0]["SysColumnName"] + "\" ";
                        if (this.ScreenObject.GridDataColumns.Contains("IndentID"))
                            sbStatic += " MatIndentID=\"" + this.ScreenObject.GridData[i]["IndentID"].toString() + "\" ";
                        else if (!Util.IsEmpty(this.ScreenObject.GridData[i][drmat[0]["SysColumnName"]]))
                            sbStatic += " MatIndentID=\"" + this.ScreenObject.GridData[i][drmat[0]["SysColumnName"]].toString() + "\" ";
                    }

                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["SchemeID"]) && parseInt(this.ScreenObject.GridData[i]["SchemeID"]) > 0) {
                        sbStatic += " IsQtyFreeOffer=\"" + this.ScreenObject.GridData[i]["SchemeID"].toString() + "\" ";
                        if (this.ScreenObject.GridData[i]["IsScheme"].toString() == "Y") {

                            let drschemes = this.ScreenObject.GridData.filter(x => x.MaxSchemeID == this.ScreenObject.GridData[i]["MaxSchemeID"] && x.IsScheme != 'Y');
                            if (drschemes.length > 0) {
                                let schemeseq = "";
                                drschemes.forEach(item => {
                                    schemeseq += item["DocSeqNo"].toString() + ",";
                                });
                                schemeseq = schemeseq.substr(schemeseq.length - 1, 1);
                                sbStatic += " ParentSchemeID=\"" + schemeseq + "\" ";
                            }
                        }
                    }


                    let ExtraXML = Util.String(this.ScreenObject.GridData[i]["ExtraXML"]);
                    let DynPromXML = "";
                    if (Util.String(this.ScreenObject.GridData[i]["Type"]) == "8" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "3" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "11" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "12")
                        DynPromXML = ExtraXML;
                    else if (this.ScreenObject.GridDataColumns.Contains("PromotionXML"))
                        DynPromXML = Util.String(this.ScreenObject.GridData[i]["PromotionXML"]);
                    if (DynPromXML != "") {
                        let xtraxml = "";
                        xtraxml += "<xml>";
                        let xtraDoc = new XmlDocument();
                        xtraDoc.LoadXml(DynPromXML);
                        if (Validate && !this.ValidateDataonSave_xml(xtraDoc, i))
                            return false;
                        let xList = xtraDoc.SelectNodes("xml/Row/xml");
                        let dyncnt = xList.length, dyni = 0;
                        let Val;
                        if (this.ScreenObject.Data.Tables[15].length > 0) {
                            if (!this.ScreenObject.Data.Columns[15].Contains("PostingVal"))
                                this.ScreenObject.Data.Columns[15].push("PostingVal");
                            for (let l = 0; l < this.ScreenObject.Data.Tables[15].length; l++) {
                                this.ScreenObject.Data.Tables[15][l]["PostingVal"] = 0;
                            }
                        }

                        for (let k = 0; k < xList.length; k++) {
                            let xnode = xList[k]
                            dyni++;

                            xtraxml += "<Row >" + xtraDoc.getNodeXml(xnode).replace("/>", "").replace("CCQuery=\"", "CCQuery=\"" + this.ScreenObject.strCCFields).replace("texQuery=\"", "texQuery=\"" + this.ScreenObject.strTextFields);
                            if ((sender != null && sender.toString() == "SaveonHold") || this.DonotUpdateInventory || (xnode.attributes["Type"] != null && xnode.attributes["Type"].value != "" && parseInt(xnode.attributes["Type"].value) == 6))
                                xtraxml += " IsQtyIgnored=\"1\" ";
                            else
                                xtraxml += " IsQtyIgnored=\"0\" ";

                            if (Validate && !this.DonotUpdateInventory && xnode.attributes["Type"] != null && xnode.attributes["Type"].value != "" && parseInt(xnode.attributes["Type"].value) == 5
                                && xnode.attributes["Quantity"] != null && xnode.attributes["Quantity"].value != "" && parseFloat(xnode.attributes["Quantity"].value) > 0) {
                                if (xnode.attributes["ExtraXML"] == null || xnode.attributes["ExtraXML"].value == "" && !IgnoreBatches) {
                                    this.DisplayMessage = BaseService.GetResource("Doc_BatchQtyMissMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                    return false;
                                }
                            }

                            if (this.Currency != null && this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue != "")
                                xtraxml += "CurrencyID=\"" + this.Currency.Currency.SelectedValue.toString() + "\" ";
                            else
                                xtraxml += "CurrencyID=\"1\" ";
                            if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                                xtraxml += "ExchangeRate=\"" + this.Currency.ExchangeRate.Text.toString() + "\" ";
                            else
                                xtraxml += "ExchangeRate=\"1\" ";
                            xtraxml += this.ScreenObject.strStaticFields;
                            xtraxml += "StockValue=\"##StkVal##\" ";
                            xtraxml += " />";

                            if (sender != null && sender.toString() != "SaveonHold" && !DonotUpdateAccounts
                                && this.ScreenObject.Preferences.ContainsKey("KitAccPosting") && this.ScreenObject.Preferences["KitAccPosting"] == "True") {
                                let dsdyn = new XmlDocument();
                                dsdyn.ReadXml(xtraDoc.getNodeXml(xnode));
                                let StkVal = 0;
                                xtraxml += "<AccountsXML>";
                                let TempVal: number;
                                for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                                    let CurrID = this.GetCurrencyID(i);
                                    let ExhgRate = this.GetExchRate(i);
                                    let dynmaprow = this.ScreenObject.Data.Tables[15].filter(x => x.CostCenterColIDField == this.ScreenObject.ColumnSource[j].ID);
                                    let PostingValue = "";
                                    if (dynmaprow.length > 0 && Util.String(dynmaprow[0]["DistributOn"]) == "No") {
                                        if (dyni == 1 && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]))
                                            PostingValue = this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString();
                                    }
                                    else if (dynmaprow.length > 0 && !Util.IsEmpty(dynmaprow[0]["DistributOn"])
                                        && !(Util.String(this.ScreenObject.GridData[i]["Type"]) != "3" && !Util.IsEmpty(dynmaprow[0]["IgnoreKit"]) && parseBoolean(dynmaprow[0]["IgnoreKit"]))) {
                                        if (Util.String(dynmaprow[0]["DistributOn"]) == "Quantity" && xnode.attributes["totQty"] != null && xnode.attributes["totQty"].value != "" && parseFloat(xnode.attributes["totQty"].value) > 0
                                            && xnode.attributes["Quantity"] != null && xnode.attributes["Quantity"].value != "" && parseFloat(xnode.attributes["Quantity"].value) > 0
                                            && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember])) {
                                            if (dyncnt == dyni)
                                                Val = parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) - parseFloat(dynmaprow[0]["PostingVal"]);
                                            else
                                                Val = (parseFloat(xnode.attributes["Quantity"].value) / parseFloat(xnode.attributes["totQty"].value)) * parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]);
                                            Val = parseFloat(Val.ToString("N" + this.ScreenObject.ColumnSource[j].DecimalPoints));
                                            dynmaprow[0]["PostingVal"] = parseFloat(dynmaprow[0]["PostingVal"]) + Val;
                                            PostingValue = Val.toString();
                                        }
                                        else if (Util.String(dynmaprow[0]["DistributOn"]) == "Gross" && xnode.attributes["totgross"] != null && xnode.attributes["totgross"].value != "" && parseFloat(xnode.attributes["totgross"].value) > 0
                                            && xnode.attributes["Gross"] != null && xnode.attributes["Gross"].value != "" && parseFloat(xnode.attributes["Gross"].value) > 0
                                            && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember])) {
                                            if (dyncnt == dyni)
                                                Val = parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) - parseFloat(dynmaprow[0]["PostingVal"]);
                                            else
                                                Val = (parseFloat(xnode.attributes["Gross"].value) / parseFloat(xnode.attributes["totgross"].value)) * parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]);
                                            Val = parseFloat(Val.ToString("N" + this.ScreenObject.ColumnSource[j].DecimalPoints));
                                            dynmaprow[0]["PostingVal"] = parseFloat(dynmaprow[0]["PostingVal"]) + Val;
                                            PostingValue = Val.toString();
                                        }
                                    }
                                    else if (this.ScreenObject.ColumnSource[j].SectionID == 4) {
                                        if (xnode.attributes["totgross"] != null && xnode.attributes["totgross"].value != "" && parseFloat(xnode.attributes["totgross"].value) > 0
                                            && xnode.attributes["Gross"] != null && xnode.attributes["Gross"].value != "" && parseFloat(xnode.attributes["Gross"].value) > 0
                                            && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]))
                                            PostingValue = ((parseFloat(xnode.attributes["Gross"].value) / parseFloat(xnode.attributes["totgross"].value)) * parseFloat(this.ScreenObject.GridData[i]["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember])).toString();
                                    }
                                    else {
                                        if (this.ScreenObject.ColumnSource[j].DataType != "ComboBox" && this.ScreenObject.ColumnSource[j].PostingType > 0
                                            && xnode.attributes[this.ScreenObject.ColumnSource[j].DisplayMember] && Util.Double(xnode.attributes[this.ScreenObject.ColumnSource[j].DisplayMember].value) > 0)
                                            PostingValue = xnode.attributes[this.ScreenObject.ColumnSource[j].DisplayMember].value;
                                        if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcnum")
                                            && xnode.attributes["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember] != null && xnode.attributes["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember].value != "" && parseFloat(xnode.attributes["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember].value) > 0)
                                            PostingValue = xnode.attributes["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember].value;
                                    }
                                    if ((this.ScreenObject.ColumnSource[j].PostingType == 3 || this.ScreenObject.ColumnSource[j].PostingType == 4) && Util.Double(PostingValue) != 0) {
                                        let outObj = { DBAcc: 0, CrACC: 0, PostingXml: "" };
                                        if (dynmaprow.length > 0 && Util.String(dynmaprow[0]["DistributOn"]) == "No") {
                                            if (!this.FillAccountPosting(this.ScreenObject.ColumnSource[j], this.ScreenObject.GridData[i], PostingValue, CurrID, ExhgRate, outObj, 0, RowCount))
                                                return false;
                                        }
                                        else {
                                            if (!this.FillAccountPosting(this.ScreenObject.ColumnSource[j], dsdyn.Tables[0][0], PostingValue, CurrID, ExhgRate, outObj, 0, RowCount))
                                                return false;
                                        }
                                        xtraxml += outObj.PostingXml;
                                        this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.CrACC.toString(), PostingValue, true, CurrID, ExhgRate, FromTOCount, (this.ScreenObject.ColumnSource[j].NoRoundOff) ? "6" : this.ScreenObject.ColumnSource[j].DecimalPoints, RowCount);
                                        this.ScreenObject.FillBillWiseDt(this.BillWisedt, this.BillWisedtColumns, outObj.DBAcc.toString(), PostingValue, false, CurrID, ExhgRate, FromTOCount, (this.ScreenObject.ColumnSource[j].NoRoundOff) ? "6" : this.ScreenObject.ColumnSource[j].DecimalPoints, RowCount);
 
                                        this.FillPaytermDt(accid, outObj.CrACC, outObj.DBAcc, PostingValue, dsdyn.Tables[0][0], this.ScreenObject.ColumnSource[j].DisplayMember, this.ScreenObject.ColumnSource[j].DecimalPoints);
                                    }
                                    if ((this.ScreenObject.ColumnSource[j].PostingType == 2 || this.ScreenObject.ColumnSource[j].PostingType == 4) && PostingValue != "" && Util.Double(PostingValue) != 0)
                                        StkVal += parseFloat(PostingValue) * ExhgRate;
                                }
                                xtraxml += "</AccountsXML>";
                                xtraxml = xtraxml.Replace("##StkVal##", StkVal.toString());
                            }
                            else {

                                let dsdyn = new XmlDocument();
                                dsdyn.ReadXml(dsdyn.getNodeXml(xnode));
                                let StkVal = 0;
                                let TempVal;
                                for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                                    let CurrID = this.GetCurrencyID(i);
                                    let ExhgRate = this.GetExchRate(i);
                                    var dynmaprow = this.ScreenObject.Data.Tables[15].filter(x => x["CostCenterColIDField"] == this.ScreenObject.ColumnSource[j].ID);
                                    let PostingValue = '';
                                    if (dynmaprow.length > 0 && Util.String(dynmaprow[0]["DistributOn"]) == "No") {
                                        if (dyni == 1 && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]))
                                            PostingValue = this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString().toString();
                                    }
                                    else if (dynmaprow.length > 0 && !Util.IsEmpty(dynmaprow[0]["DistributOn"])
                                        && !(this.ScreenObject.GridData[i]["Type"].toString() != "3" && !Util.IsEmpty(dynmaprow[0]["IgnoreKit"]) && parseBoolean(dynmaprow[0]["IgnoreKit"].toString()))) {
                                        if (dynmaprow[0]["DistributOn"].toString() == "Quantity" && !Util.IsEmpty(xnode.attributes["totQty"]) && !Util.IsEmpty(xnode.attributes["totQty"].value) && parseFloat(xnode.attributes["totQty"].value) > 0
                                            && xnode.attributes["Quantity"] != null && xnode.attributes["Quantity"].value != "" && parseFloat(xnode.attributes["Quantity"].value) > 0
                                            && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember])) {
                                            if (dyncnt == dyni)
                                                Val = parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString()) - parseFloat(dynmaprow[0]["PostingVal"].toString());
                                            else
                                                Val = (parseFloat(xnode.attributes["Quantity"].value) / parseFloat(xnode.attributes["totQty"].value)) * parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString());
                                            Val = parseFloat(Val.ToString("N" + this.ScreenObject.ColumnSource[j].DecimalPoints));
                                            dynmaprow[0]["PostingVal"] = parseFloat(dynmaprow[0]["PostingVal"].toString()) + Val;
                                            PostingValue = Val.toString();
                                        }
                                        else if (dynmaprow[0]["DistributOn"].toString() == "Gross" && xnode.attributes["totgross"] != null && xnode.attributes["totgross"].value != "" && parseFloat(xnode.attributes["totgross"].value) > 0
                                            && xnode.attributes["Gross"] != null && xnode.attributes["Gross"].value != "" && parseFloat(xnode.attributes["Gross"].value) > 0
                                            && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember])) {
                                            if (dyncnt == dyni)
                                                Val = parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString()) - parseFloat(dynmaprow[0]["PostingVal"].toString());
                                            else
                                                Val = (parseFloat(xnode.attributes["Gross"].value) / parseFloat(xnode.attributes["totgross"].value)) * parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString());
                                            Val = parseFloat(Val.ToString("N" + this.ScreenObject.ColumnSource[j].DecimalPoints));
                                            dynmaprow[0]["PostingVal"] = parseFloat(dynmaprow[0]["PostingVal"].toString()) + Val;
                                            PostingValue = Val.toString();
                                        }
                                    }
                                    else if (this.ScreenObject.ColumnSource[j].SectionID == 4) {
                                        if (xnode.attributes["totgross"] != null && xnode.attributes["totgross"].value != "" && parseFloat(xnode.attributes["totgross"].value) > 0
                                            && xnode.attributes["Gross"] != null && xnode.attributes["Gross"].value != "" && parseFloat(xnode.attributes["Gross"].value) > 0
                                            && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]))
                                            PostingValue = ((parseFloat(xnode.attributes["Gross"].value) / parseFloat(xnode.attributes["totgross"].value)) * parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString())).toString();
                                    }
                                    else {
                                        if (this.ScreenObject.ColumnSource[j].DataType != "ComboBox" && this.ScreenObject.ColumnSource[j].PostingType > 0
                                            && xnode.attributes[this.ScreenObject.ColumnSource[j].DisplayMember] != null && xnode.attributes[this.ScreenObject.ColumnSource[j].DisplayMember].value != "" && parseFloat(xnode.attributes[this.ScreenObject.ColumnSource[j].DisplayMember].value) > 0)
                                            PostingValue = xnode.attributes[this.ScreenObject.ColumnSource[j].DisplayMember].value;
                                        if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcnum")
                                            && xnode.attributes["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember] != null && xnode.attributes["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember].value != "" && parseFloat(xnode.attributes["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember].value) > 0)
                                            PostingValue = xnode.attributes["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember].value;
                                    }
                                    if ((this.ScreenObject.ColumnSource[j].PostingType == 2 || this.ScreenObject.ColumnSource[j].PostingType == 4) && PostingValue != "" && Util.Double(PostingValue) > 0 && parseFloat(PostingValue) != 0)
                                        StkVal += parseFloat(PostingValue) * ExhgRate;
                                }
                                xtraxml = xtraxml.Replace("##StkVal##", StkVal.toString());
                            }

                            xtraxml = xtraxml.Replace("##StkVal##", "0");
                            xtraxml += "</Row>";
                        }
                        xtraxml += "</xml>";
                        if (Util.String(this.ScreenObject.GridData[i]["Type"]) == "8" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "3" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "11" || Util.String(this.ScreenObject.GridData[i]["Type"]) == "12") {
                            ExtraXML = xtraxml;
                            DynPromXML = "";
                        }
                        else
                            DynPromXML = xtraxml;
                    }
                    if (this.ScreenObject.DocumentType == 5 && FromTOCount == 1 && this.ScreenObject.GridDataColumns.Contains("RecievedQtyXML") && !this.DonotUpdateInventory && Util.Int(this.ScreenObject.GridData[i]["Type"]) == 2)
                        ExtraXML = Util.String(this.ScreenObject.GridData[i]["RecievedQtyXML"]);

                    if (this.savebulk && !Util.IsEmpty(ExtraXML) && Util.String(this.ScreenObject.GridData[i]["Type"]) == "5") {
                        let xbatchDoc = new XmlDocument();
                        xbatchDoc.LoadXml(ExtraXML);

                        let xList = xbatchDoc.SelectNodes("xml/Row");
                        if (xList.length > 0) {
                            sbStatic += "BatchID=\"" + xList[0].attributes["BatchID"].value + "\" ";
                            sbStatic += "ReleaseQuantity=\"" + Util.String(this.ScreenObject.GridData[i]["UOMConvertedQty"]) + "\" ";
                        }
                    }

                    if (IgnoreBatches && this.ScreenObject.Preferences.ContainsKey("BatchBasedon") && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["BatchBasedon"]))
                        sbStatic += " IgnoreBatches=\"1\" ";

                    sbStatic += this.ScreenObject.strStaticFields + " ></Transactions>";


                    if (this.savebulk && (this.DocumentType == 45 || this.DocumentType == 46)) {
                        ProjectPlanXml += "<ProjectPlan ";
                        ProjectPlanXml += " DocDetailsID=\"" + Util.String(this.ScreenObject.GridData[i]["DocDetailsID"]) + "\" ";
                        ProjectPlanXml += " DocSeqNo =\"" + RowCount + "\" ";

                        if (this.ScreenObject.GridDataColumns.Contains("Dependencies") && !Util.IsEmpty(this.ScreenObject.GridData[i]["Dependencies"]))
                            ProjectPlanXml += "Dependencies=\"" + this.ScreenObject.GridData[i]["Dependencies"] + "\" ";
                        ProjectPlanXml += ">";

                        if (this.ScreenObject.GridDataColumns.Contains("AssignXML") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AssignXML"]))
                            ProjectPlanXml += this.ScreenObject.GridData[i]["AssignXML"];
                        ProjectPlanXml += "</ProjectPlan>";
                    }

                    if (!this.savebulk) {
                        sbRows += sbStatic + sbNumeric + sbText + sbCC + "<EXTRAXML>" + ExtraXML + "</EXTRAXML>";

                        if (DynPromXML != "")
                            sbRows += "<DynPromXML>" + DynPromXML + "</DynPromXML>";
                        else if (this.ScreenObject.Preferences.ContainsKey("BudgetDoc") && this.ScreenObject.Preferences["BudgetDoc"] != "")
                            sbRows += this.GetBudgetXml(this.ScreenObject.GridData[i]);

                        if (this.ScreenObject.GridDataColumns.Contains("QtyXML") && !Util.IsEmpty(this.ScreenObject.GridData[i]["QtyXML"]))
                            sbRows += this.ScreenObject.GridData[i]["QtyXML"];

                        if (this.ScreenObject.GridDataColumns.Contains("DocExtraXML") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DocExtraXML"]))
                            sbRows += this.ScreenObject.GridData[i]["DocExtraXML"];

                        if (DOcExtraXml.length > 0)
                            sbRows += DOcExtraXml.toString();

                        if (this.ScreenObject.GridDataColumns.Contains("PackXML") && !Util.IsEmpty(this.ScreenObject.GridData[i]["PackXML"]))
                            sbRows += this.ScreenObject.GridData[i]["PackXML"];

                        if (this.ScreenObject.GridDataColumns.Contains("TestCaseXML") && !Util.IsEmpty(this.ScreenObject.GridData[i]["TestCaseXML"]))
                            sbRows += this.ScreenObject.GridData[i]["TestCaseXML"];

                        if (this.DocumentType == 45 || this.DocumentType == 46) {
                            sbRows += "<ProjectPlanXML ";
                            if (this.ScreenObject.GridDataColumns.Contains("Dependencies") && !Util.IsEmpty(this.ScreenObject.GridData[i]["Dependencies"]))
                                sbRows += "Dependencies=\"" + this.ScreenObject.GridData[i]["Dependencies"] + "\" ";
                            sbRows += ">";

                            if (this.ScreenObject.GridDataColumns.Contains("AssignXML") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AssignXML"]))
                                sbRows += this.ScreenObject.GridData[i]["AssignXML"];
                            sbRows += "</ProjectPlanXML>";
                        }

                        if (this.POSPayModes != null && RowCount == 1) {
                            let loyaltyon = Util.Int(BaseService.SessionManager.Preferences["LoyaltyOn"]);
                            if (BaseService.SessionManager.Preferences.ContainsKey("LoyaltyOn") && loyaltyon > 50000) {
                                let loyDim = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == loyaltyon);
                                if (loyDim != null && (loyDim as PactListBoxData).SelectedValue > 0)
                                    loyaltyon = (loyDim as PactListBoxData).SelectedValue;
                                else
                                    loyaltyon = 0;
                            }
                            else if (this.ScreenObject.DebitAccount != null)
                                loyaltyon = this.ScreenObject.DebitAccount.SelectedValue;

                            let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference == 79 && x.LinkData == 56569);
                            if (dvCnt.length > 0 && dvCnt[0]["SysColumnName"].toLowerCase().Contains("dcnum") && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                                if (loyaltyon == 0) {
                                    this.DisplayMessage += "select loyalty based on.";
                                    return false;
                                }
                                let objval = this.ScreenObject.GridData.Compute("sum", dvCnt[0]["SysColumnName"].toString());
                                if (objval != null && objval != null) {
                                    sbRows += "<DocExtraXML><Row  RefID=\"1\"  Fld1=\"" + loyaltyon + "\" ";
                                    if (this.DocumentType == 6 || this.DocumentType == 39)
                                        sbRows += " Qty=\"-" + parseInt(objval);
                                    else
                                        sbRows += " Qty=\"" + parseInt(objval);
                                    sbRows += "\"  Type=\"5\"  ></Row></DocExtraXML>";
                                }
                            }
                            else if (this.POSPayModes.points > 0 && ((this.GridNetTotal + this.FooterGridNetTotal) / this.POSPayModes.BillValue) >= 1) {
                                if (loyaltyon == 0) {
                                    this.DisplayMessage += "select loyalty based on.";
                                    return false;
                                }

                                sbRows += "<DocExtraXML><Row  RefID=\"1\"  Fld1=\"" + loyaltyon + "\" ";
                                sbRows += " Qty=\"" + ((this.GridNetTotal + this.FooterGridNetTotal) / this.POSPayModes.BillValue) * this.POSPayModes.points;
                                sbRows += "\"  Type=\"5\"  ></Row></DocExtraXML>";
                            }

                            if (this.POSPayModes.RedeemPoints > 0) {
                                if (loyaltyon == 0) {
                                    this.DisplayMessage += "select loyalty based on.";
                                    return false;
                                }
                                sbRows += "<DocExtraXML><Row  RefID=\"1\"  Fld1=\"" + loyaltyon + "\" ";
                                sbRows += " Qty=\"-" + this.POSPayModes.RedeemPoints;
                                sbRows += "\"  Type=\"5\"  ></Row></DocExtraXML>";
                            }
                        }
                        else if (RowCount == 1 && (this.DocumentType == 6 || this.DocumentType == 39)) {
                            var dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference == 79 && x.LinkData == 56569);
                            if (dvCnt.length > 0 && dvCnt[0]["SysColumnName"].toString().toLowerCase().Contains("dcnum") && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"].toString())) {
                                let objval: any = this.ScreenObject.GridData.Compute("sum", dvCnt[0]["SysColumnName"].toString());//, '');
                                if (objval != null && objval != null) {
                                    let loyaltyon = 0;
                                    loyaltyon = Util.Int(BaseService.SessionManager.Preferences["LoyaltyOn"]);
                                    if (BaseService.SessionManager.Preferences.ContainsKey("LoyaltyOn") && loyaltyon > 50000) {
                                        let loyDim: any = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == loyaltyon);
                                        if (loyDim != undefined && loyDim.SelectedValue > 0)
                                            loyaltyon = loyDim.SelectedValue;
                                        else
                                            loyaltyon = 0;
                                    }
                                    else if (this.ScreenObject.DebitAccount != null)
                                        loyaltyon = this.ScreenObject.DebitAccount.SelectedValue;

                                    if (loyaltyon == 0) {
                                        this.DisplayMessage += "select loyalty based on to return points.";
                                        this.MessageVisibility = true;
                                        return false;
                                    }
                                    sbRows += "<DocExtraXML><Row  RefID=\"1\"  Fld1=\"" + loyaltyon + "\" ";
                                    sbRows += " Qty=\"-" + parseInt(objval);
                                    sbRows += "\"  Type=\"5\"  ></Row></DocExtraXML>";
                                }
                            }
                        }

                        if (this.ScreenObject.DocumentType == 5 && FromTOCount == 1 && this.ScreenObject.GridDataColumns.Contains("TOBinsXML") && !Util.IsEmpty(this.ScreenObject.GridData[i]["TOBinsXML"]))
                            sbRows += this.ScreenObject.GridData[i]["TOBinsXML"];
                        else if (this.ScreenObject.GridDataColumns.Contains("BinsXML") && !Util.IsEmpty(this.ScreenObject.GridData[i]["BinsXML"]))
                            sbRows += this.ScreenObject.GridData[i]["BinsXML"];

                        if (this.ScreenObject.Preferences.ContainsKey("PostAsset") && this.ScreenObject.Preferences["PostAsset"].toLowerCase() == "true") {
                            let AssetQty = 0;
                            let Depr = false;
                            if (this.ScreenObject.Preferences.ContainsKey("AssetBasedOn") && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["AssetBasedOn"])) {
                                if (Util.String(this.ScreenObject.GridData[i][this.ScreenObject.Preferences["AssetBasedOn"]]) == "0")
                                    AssetQty = 0;
                                else if (Util.String(this.ScreenObject.GridData[i][this.ScreenObject.Preferences["AssetBasedOn"]]) == "1" && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"])) {
                                    Depr = true; AssetQty = parseFloat(this.ScreenObject.GridData[i]["Quantity"]);
                                }
                                else if (Util.String(this.ScreenObject.GridData[i][this.ScreenObject.Preferences["AssetBasedOn"]]) == "2" && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]))
                                    AssetQty = parseFloat(this.ScreenObject.GridData[i]["Quantity"]);
                                else if (Util.String(this.ScreenObject.GridData[i][this.ScreenObject.Preferences["AssetBasedOn"]]) == "4") {
                                    Depr = true; AssetQty = 1;
                                }
                                else if (Util.String(this.ScreenObject.GridData[i][this.ScreenObject.Preferences["AssetBasedOn"]]) == "3")
                                    AssetQty = parseFloat(this.ScreenObject.GridData[i]["Quantity"]);
                            }
                            else if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]))
                                AssetQty = parseFloat(this.ScreenObject.GridData[i]["Quantity"]);

                            if (AssetQty > 0) {
                                sbRows += this.getAssetDeprXML(this.ScreenObject.GridData[i], Depr);
                            }
                        }
                        sbRows += "</Row>";
                    }
                    else {
                        if (this.ScreenObject.GridData[i]["Type"].toString() == "2" && !Util.IsEmpty(ExtraXML)) {
                            xDoc.LoadXml(ExtraXML);
                            let xList = xDoc.SelectNodes("xml/Row");
                            xList.forEach(XNode => {
                                let aa = xDoc.CreateAttribute("DocSeqNo");//need to ask from adil bhai
                                aa.Value = RowCount.toString();
                                XNode.attributes += aa;
                            });

                            ExtraXml += xDoc.InnerXml;
                        }
                        if (this.ScreenObject.GridDataColumns.Contains("DocExtraXML") && this.ScreenObject.GridData[i]["DocExtraXML"].toString() != "") {

                            xDoc.LoadXml(this.ScreenObject.GridData[i]["DocExtraXML"].toString());
                            let xList = xDoc.SelectNodes("DocExtraXML/Row");
                            xList.forEach(XNode => {
                                let aa = xDoc.CreateAttribute("DocSeqNo");
                                aa.Value = RowCount.toString();
                                XNode.attributes += aa;
                            });

                            DOcExtraXml += xDoc.InnerXml;
                        }
                    }
                    FromTOCount++;
                } while (this.ScreenObject.DocumentType == 5 && FromTOCount == 1);
            }
            // sbRows+="</DocumentXML>";

            if (RowCount == 0) {
                if (this.isAutoProduce && this.parent != null) {
                    this.parent.AutoProduceXML = "";
                    return false;
                }
                else {
                    this.DisplayMessage = BaseService.GetResource("Doc_BlankData");
                    return false;
                }
            }
            this.DialogResult = false;

            if (Validate) {
                if (this.ScreenObject.DebitAccount != null) {
                    this.res = "No";
                    if ((this.ScreenObject.DocumentType == 7 || this.ScreenObject.DocumentType == 11 || this.ScreenObject.DocumentType == 12)
                        && (Validate && !DonotUpdateAccounts)) {
                        if (!this.CheckCreditLimit(parseInt(this.ScreenObject.DebitAccount.SelectedValue.toString()), parseFloat(this.NetAmount), false))
                            return false;
                    }
                }
                if (this.ScreenObject.CreditAccount != null) {
                    this.res = "No";
                    if ((this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 4)
                        && (Validate && !DonotUpdateAccounts)) {
                        if (!this.CheckCreditLimit(parseInt(this.ScreenObject.CreditAccount.SelectedValue.toString()), -parseFloat(this.NetAmount), true))
                            return false;
                    }
                }

                for (let a = 0; a < this.BillWisedt.length; a++) {
                    if (this.BillWisedt[a]["AccountID"].toString() == accid.toString()) {
                        if (this.ScreenObject.Preferences.ContainsKey("Dontsaveifpartybalancesgoes-ve") && this.ScreenObject.Preferences["Dontsaveifpartybalancesgoes-ve"] != "" && parseBoolean(this.ScreenObject.Preferences["Dontsaveifpartybalancesgoes-ve"])) {
                            if (this.CheckAccountBalance(accid, parseFloat(this.BillWisedt[a]["Amount"]), parseBoolean(this.BillWisedt[a]["IsCredit"]))) {
                                this.DisplayMessage = BaseService.GetResource("PartyBalnceNegative");
                                return false;
                            }
                        }
                        if (!this.IgnoreOnSave.ContainsKey("ChequeReturn")) {
                            this.IgnoreOnSave["ACTION"] = "ChequeReturn";
                            this.ChequeReturn(accid, null, "", parseFloat(this.BillWisedt[a]["Amount"]), parseBoolean(this.BillWisedt[a]["IsCredit"]), parseInt(this.BillWisedt[a]["CurrencyID"]), parseFloat(this.BillWisedt[a]["ExchangeRate"]));
                            if (this.isChequeReturn)
                                return false;
                        }
                        break;
                    }
                }
            }

            if (!Util.IsEmpty(CostXMl))
                sbRows += CostXMl;
            else if (((this.ScreenObject.Preferences.ContainsKey("DistributeCost") && this.ScreenObject.Preferences["DistributeCost"].toString() == "True")
                || DistCost) && this.BillWisedt.length > 0) {
                if (this.BillWisedt.filter(x => x.AccountID == accid).length > 0) {
                    this.DialogResult = false;
                    let showjv = new ShowJVViewModel();
                    showjv.ShowJVViewModel_2(this, accid.toString(), (DistCost) ? 5 : 3)
                    {
                        if (DistCost) {
                            showjv.AccountID = ToAccid;
                            showjv.JVGrid.Columns[0].IsVisible = false;
                        }
                        if (Validate) {
                            //BaseService.page.ShowDialog(showjv, ShowJVComponent, { ShowCenter: true, Title: showjv.Title });
                            if (!this.IgnoreOnSave.ContainsKey("DistributeCost")) {
                                await BaseService.page.openDialog(showjv, ShowJVComponent, { ShowCenter: true, Title: showjv.Title });
                                if (!this.DialogResult)
                                    return false;
                                else {
                                    this.IgnoreOnSave.push("DistributeCost", showjv);
                                }
                            }
                            else {
                                showjv = this.IgnoreOnSave["DistributeCost"] as ShowJVViewModel;
                            }
                        }
                        else {
                            let amt = (DistCost ? showjv.JVGrid.Table.filter(x => x.AccountID_Key > 0) : showjv.JVGrid.Table).Compute("sum", "Amount");

                            if (amt == null || parseFloat(amt).ToString("N" + showjv.decimalpoints) != showjv.TotAmt.ToString("N" + showjv.decimalpoints)) {
                                this.DisplayMessage = "Amount not equal.";
                                return false;
                            }
                        }
                        let prodcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "productid_key");
                        if (!prodcol || Util.IsEmpty(prodcol.DefaultValue) || Util.Int(prodcol.DefaultValue) < 1) {
                            this.DisplayMessage = "Define default product";
                            return false;
                        }
                        sbRows += showjv.getxml(prodcol.DefaultValue);
                    }
                }
            }

            if (BaseService.SessionManager.Preferences.ContainsKey("On") && BaseService.SessionManager.Preferences["On"].toLowerCase() == "true" && this.BillWisedt.length > 0) {
                this.DialogResult = false;
                let objbill: BillWiseViewModel;
                if (this.IgnoreOnSave.ContainsKey("BillWisedt"))
                    this.BillWisedt = this.IgnoreOnSave["BillWisedt"];
                if (this.IgnoreOnSave.ContainsKey("BillWise")) {
                    this.DialogResult = true;
                    objbill = this.IgnoreOnSave["BillWise"] as BillWiseViewModel;
                }
                else {
                    objbill = new BillWiseViewModel()
                    objbill.BillWiseViewModel_1(this, Validate);
                }

                if (!this.DialogResult) {
                    if (Validate && !(this.ScreenObject.Preferences.ContainsKey("Alwaysnewreference") && parseBoolean(this.ScreenObject.Preferences["Alwaysnewreference"]))
                        && !(this.ScreenObject.Preferences.ContainsKey("AdjustFifoBills") && this.ScreenObject.Preferences["AdjustFifoBills"] != "" && parseBoolean(this.ScreenObject.Preferences["AdjustFifoBills"]))
                        && !(this.ScreenObject.IsDocEdit && BaseService.SessionManager.IsActionAssigned(43, "Ignore Billwise on edit"))) {
                        if (!this.IgnoreOnSave.ContainsKey("BillWise")) {
                            this.IgnoreOnSave["ACTION"] = "BillWise";
                            this.IgnoreOnSave.push("BillWise", objbill);
                            BaseService.page.ShowDialog(objbill, BillWiseComponent, { ShowCenter: true })
                        }
                        else
                            this.DialogResult = true;
                    }
                    else {
                        for (let k = 0; k < objbill.Accounts.Items.length; k++) {
                            let item = objbill.Accounts.Items[k]
                            let outObj = { Message: "" };
                            objbill.FillSelectedAccountDetails(item);
                            if (this.DocID == 0 && this.ScreenObject.Preferences.ContainsKey("AdjustFifoBills") && this.ScreenObject.Preferences["AdjustFifoBills"] != "" && parseBoolean(this.ScreenObject.Preferences["AdjustFifoBills"])) {
                                objbill._Fifo = false;
                                objbill.Fifo = true;
                            }
                            if (this.BillWisedtColumns.Contains("DocSeqNo"))
                                this.BillWisedt.filter(x => x.AccountID == item.Value.toString() && x.DocSeqNo == item.Seq && x.IsCredit == item.Status && x.CurrencyID == item.CurrID)[0]["XML"] = objbill.GetXml(false, outObj);
                            else {
                                this.BillWisedt.filter(x => x.AccountID == item.Value.toString() && x.IsCredit == item.Status && x.CurrencyID == item.CurrID)[0]["XML"] = objbill.GetXml(false, outObj);
                                if (objbill.VatAdvanceXML != null && objbill.VatAdvanceXML.length > 0)
                                    this.BillWisedt.filter(x => x.AccountID == item.Value.toString() && x.IsCredit == item.Status && x.CurrencyID == item.CurrID)[0]["DocXML"] = objbill.VatAdvanceXML;
                            }
                            if (outObj.Message != "") {
                                this.DisplayMessage = outObj.Message;
                                return false;
                            }
                        }
                        this.DialogResult = true;
                    }
                    if (!this.IgnoreOnSave.ContainsKey("BillWisedt"))
                        this.IgnoreOnSave.push("BillWisedt", "");
                    this.IgnoreOnSave["BillWisedt"] = this.BillWisedt;
                }

                if (!this.DialogResult)
                    return false;
            }

            this.BillWiseXML = "";
            let BillWiseVatAdvanceXML = "";
            let BillAmt = 0;
            let NewRefNode = null;
            for (let a = 0; a < this.BillWisedt.length; a++) {
                if (!Util.IsEmpty(this.BillWisedt[a]["XML"])) {
                    if (this.ScreenObject.Preferences.ContainsKey("Enable Payment Terms") && parseBoolean(this.ScreenObject.Preferences["Enable Payment Terms"])) {
                        let xDoc = new XmlDocument();
                        xDoc.LoadXml("<BillWise> " + this.BillWisedt[a]["XML"].toString() + " </BillWise>");

                        let xList = xDoc.SelectNodes("BillWise/Row");

                        this.DialogResult = false;
                        for (let x = 0; x < xList.length; x++) {
                            if (xList[x].attributes["AccountID"] != null && xList[x].attributes["AccountID"].value != "" && parseInt(xList[x].attributes["AccountID"].value) == accid) {
                                if (xList[x].attributes["AdjAmount"] != null && xList[x].attributes["AdjAmount"].value != "" &&
                                    xList[x].attributes["IsNewReference"] != null && xList[x].attributes["IsNewReference"].value == "1") {
                                    BillAmt += parseFloat(xList[x].attributes["AdjAmount"].value.replace("-", ""));
                                    NewRefNode = xList[x];
                                }
                                this.DialogResult = true;
                            }
                        }

                        if (this.DialogResult && this.ScreenObject.Preferences.ContainsKey("BillwisePosting") && this.ScreenObject.Preferences["BillwisePosting"] == "2")
                            continue;
                    }

                    if (Util.IsEmpty(this.BillWiseXML))
                        this.BillWiseXML = "<BillWise> ";
                    this.BillWiseXML += this.BillWisedt[a]["XML"].toString();

                    if (!Util.IsEmpty(this.BillWisedt[a]["DocXML"]))
                        BillWiseVatAdvanceXML += this.BillWisedt[a]["DocXML"].toString();
                }
            }

            if (this.BillWiseXML == "" && !Util.IsEmpty(this.ArApBills))
                this.BillWiseXML = "<BillWise>";
            this.BillWiseXML += this.ArApBills;

            if (!Util.IsEmpty(this.BillWiseXML) && !this.BillWiseXML.Contains("</BillWise>"))
                this.BillWiseXML += " </BillWise>";

            let Prepayxml = '';
            if (this.ScreenObject.Preferences.ContainsKey("PrepaymentDoc") && !Util.IsEmpty(this.ScreenObject.Preferences["PrepaymentDoc"]) && parseInt(this.ScreenObject.Preferences["PrepaymentDoc"]) > 40000) {
                var drbill = this.BillWisedt.filter(x => x.AccountID == ToAccid);
                if (drbill.length > 0) {
                    let PrepayVm: pdcGenerateChequeViewModel;
                    if (this.IgnoreOnSave.ContainsKey("PrepayVm")) {
                        PrepayVm = this.IgnoreOnSave["PrepayVm"];
                    }
                    else {
                        PrepayVm = new pdcGenerateChequeViewModel(this, true);

                        if (this.ScreenObject.IsDocEdit)
                            PrepayVm.loadFromxml(this.ScreenObject.GetDescXml(

                            ), drbill[0]["Amount"].toString());

                        if (drbill[0]["Amount"].toString() != "")
                            PrepayVm.Amount.Text = drbill[0]["Amount"].toString();

                        if (!PrepayVm.IsInventoryDoc) {
                            if (PrepayVm.DebitAcc.Visible)
                                PrepayVm.DebitAcc.SelectedValue = ToAccid;

                            if (PrepayVm.CredAcc.Visible)
                                PrepayVm.CredAcc.SelectedValue = ToAccid;
                        }
                        else {
                            if (PrepayVm.DocType == 1 || PrepayVm.DocType == 39 || PrepayVm.DocType == 27 || PrepayVm.DocType == 26 || PrepayVm.DocType == 25 || PrepayVm.DocType == 2 || PrepayVm.DocType == 34 || PrepayVm.DocType == 6 || PrepayVm.DocType == 3 || PrepayVm.DocType == 4 || PrepayVm.DocType == 13) {
                                if (PrepayVm.DebitAcc.Visible)
                                    PrepayVm.DebitAcc.SelectedValue = accid;

                                if (PrepayVm.CredAcc.Visible)
                                    PrepayVm.CredAcc.SelectedValue = ToAccid;
                            }
                            else if (PrepayVm.DocType == 11 || PrepayVm.DocType == 38 || PrepayVm.DocType == 5 || PrepayVm.DocType == 7 || PrepayVm.DocType == 9 || PrepayVm.DocType == 24 || PrepayVm.DocType == 33 || PrepayVm.DocType == 10 || PrepayVm.DocType == 8 || PrepayVm.DocType == 12) {
                                if (PrepayVm.DebitAcc.Visible)
                                    PrepayVm.DebitAcc.SelectedValue = ToAccid;

                                if (PrepayVm.CredAcc.Visible)
                                    PrepayVm.CredAcc.SelectedValue = accid;
                            }
                        }
                        PrepayVm.IsDataSaved = false;
                    }

                    // if (Validate)
                    //     await BaseService.page.openDialog(PrepayVm, PDCGenerateChequeComponent)
                    // else
                    //     PrepayVm.OnSave("OK");

                    // if (PrepayVm.IsDataSaved)
                    //     Prepayxml = PrepayVm.GenerateChequeNos(true);
                    // else {
                    //     if (!Validate)
                    //         this.DisplayMessage = PrepayVm.DisplayMessage;
                    //     return false;
                    // }

                    if (Validate) {
                        if (!this.IgnoreOnSave.ContainsKey("PrepayVm")) {
                            this.IgnoreOnSave["ACTION"] = "PrepayVm";
                            this.IgnoreOnSave.push("PrepayVm", PrepayVm);
                            PrepayVm.IsIgnore = true;
                            BaseService.page.ShowDialog(PrepayVm, PDCGenerateChequeComponent);
                            return false;
                        }
                        //alert("Need TO Implement PrepayVm");
                        ///ShellWindowViewModel.Instance().PopViewModel = PrepayVm;/
                    }
                    else
                        PrepayVm.OnSave("OK");

                    if (PrepayVm.IsDataSaved)
                        Prepayxml = PrepayVm.GenerateChequeNos(true);
                    else {
                        if (!Validate)
                            this.DisplayMessage = PrepayVm.DisplayMessage;
                        return false;
                    }
                }
            }

            let BudgetExceeds = false;//if budjet exceeds 
            this.DisplayMessage = "";
            if (Validate)
                this.BudgetValidation(sbRows.toString());
            if (this.DisplayMessage != null && this.DisplayMessage.length > 0) {
                if (BaseService.SessionManager.Preferences["GBudgetUnapprove"].toLowerCase() == "true" && this.DisplayMessage != " ") {
                    this.DisplayMessage = "";
                    BudgetExceeds = true;
                }
                else
                    return false;
            }
            if (this.ScreenObject.Preferences.ContainsKey("CopyPaymentTerms") && accid > 0 && (BillAmt > 0 || NetValue > 0)
                && parseBoolean(this.ScreenObject.Preferences["CopyPaymentTerms"])
                && !(this.ScreenObject.Preferences.ContainsKey("Enable Payment Terms") && parseBoolean(this.ScreenObject.Preferences["Enable Payment Terms"]))) {
                let linkedid = 0;
                let drlinked = this.ScreenObject.GridData.filter(x => x.LinkedInvDocDetailsID != null && x.LinkedInvDocDetailsID > 0);
                if (drlinked.length > 0) {
                    linkedid = parseInt(drlinked[0]["LinkedInvDocDetailsID"]);
                    let dspay = this.ScreenObject.GetPaymentTerms(accid, linkedid);
                    if (dspay.Tables.length > 3 && dspay.Tables[3].length > 0 && dspay.Columns[3].Contains("Percentage")) {
                        if (BillAmt == 0){
                            BillAmt = NetValue;
                            this.fillPaytermsdt();
                        }
                        let pay = new PaymentTermsViewModel();
                        pay.PaymentTermsViewModel_2(this, BillAmt, accid, dspay, NewRefNode)
                        pay.onSave("Save");
                    }
                }
            }
            if (BillAmt == 0 && accid > 0 && DonotUpdateAccounts && NetValue > 0 && this.ScreenObject.Preferences.ContainsKey("Enable Payment Terms") &&
            this.ScreenObject.Preferences["Enable Payment Terms"] != "" && parseBoolean(this.ScreenObject.Preferences["Enable Payment Terms"])){
                BillAmt = NetValue;
                this.fillPaytermsdt();
            }
            if (BillAmt > 0 && accid > 0 && this.ScreenObject.Preferences.ContainsKey("Enable Payment Terms") &&
                this.ScreenObject.Preferences["Enable Payment Terms"] != "" && parseBoolean(this.ScreenObject.Preferences["Enable Payment Terms"])) {
                let linkedid = 0;
                if (this.ScreenObject.DocID == 0 && this.payTermXml == "") {
                    let drlinked = this.ScreenObject.GridData.filter(x => x.LinkedInvDocDetailsID != null && x.LinkedInvDocDetailsID > 0);
                    if (drlinked.length > 0)
                        linkedid = parseInt(drlinked[0]["LinkedInvDocDetailsID"]);
                }
                let dspay = this.ScreenObject.GetPaymentTerms(accid, linkedid);
                let Canshowpayterms = true;
                if (this.ScreenObject.Preferences.ContainsKey("accountwisePaymentTerms") && this.ScreenObject.Preferences["accountwisePaymentTerms"] != ""
                    && parseBoolean(this.ScreenObject.Preferences["accountwisePaymentTerms"]) && !(BaseService.SessionManager.IsActionAssigned(43, "Override Payment Terms"))) {
                    if (dspay == null || dspay.Tables.length == 0 || dspay.Tables[0].length == 0
                        || !(dspay.Columns[0].Contains("PaymentTerms") &&
                            !Util.IsEmpty(dspay.Tables[0][0]["PaymentTerms"]) && parseInt(dspay.Tables[0][0]["PaymentTerms"]) > 0))
                        Canshowpayterms = false;
                }

                if (this.ScreenObject.IsDocEdit && BaseService.SessionManager.IsActionAssigned(43, "Ignore Payment terms on edit"))
                    Canshowpayterms = false;

                if (sender.toString() == "ReSave")
                    Canshowpayterms = false;
                if (Canshowpayterms) {
                    if (Validate) {
                        if (!this.IgnoreOnSave.ContainsKey("PaymentTerms")) {
                            this.IgnoreOnSave["ACTION"] = "PaymentTerms";
                            let pay = new PaymentTermsViewModel();
                            pay.PaymentTermsViewModel_2(this, BillAmt, accid, dspay, NewRefNode);
                            this.IgnoreOnSave.push("PaymentTerms", pay);
                            BaseService.page.ShowDialog(pay, PaymentTermsComponent);
                            return false;
                        }
                    }
                    else {
                        let pay = new PaymentTermsViewModel()
                        pay.PaymentTermsViewModel_2(this, BillAmt, accid, dspay, NewRefNode)
                        pay.onSave("Save");
                    }
                }
            }
            this.LCBillsXml = "";
            if (accid > 0 && this.ScreenObject.Preferences.ContainsKey("EnableLC") && this.ScreenObject.Preferences["EnableLC"] != ""
                && parseBoolean(this.ScreenObject.Preferences["EnableLC"])) {
                let dsLCBills = this.ScreenObject.GetLCBills(accid, true, this.ScreenObject.VoucherNo, 1, this.DocumentDate);
                if (dsLCBills != null && dsLCBills.Tables.length > 0 && !dsLCBills.Columns[0].Contains("ErrorMessage") && dsLCBills.Tables[0].length > 0) {
                    let CurrID = 1; let ExhgRate = 1;
                    if (this.Currency != null && this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue != "")
                        CurrID = parseInt(this.Currency.Currency.SelectedValue);
                    if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                        ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
                    const { LCBillsComponent } = await import('../lcbills/lcbills.component')
                    const { LCBillsViewModel } = await import('../lcbills/LCBillsViewModel')
                    let lcObj = new LCBillsViewModel(this, (this.GridNetTotal + this.FooterGridNetTotal), accid, true, CurrID, ExhgRate, dsLCBills)
                    await BaseService.page.openDialog(lcObj, LCBillsComponent, { ShowCenter: true })
                    if (this.LCBillsXml != "") {
                        let xDoc = new XmlDocument();
                        xDoc.LoadXml(this.LCBillsXml);
                        let xList = xDoc.SelectNodes("LCBillsXML/Row");
                        let totamt = 0;
                        for (let x = 0; x < xList.length; x++) {
                            if (xList[x].attributes["AdjAmount"] != null && xList[x].attributes["AdjAmount"].value != "") {
                                totamt += parseFloat(xList[x].attributes["AdjAmount"].value.replace("-", ""));
                            }
                        }
                        if ((this.GridNetTotal + this.FooterGridNetTotal) > totamt) {
                            this.DialogResult = false;
                            //  alert("Lc Amount is less than bill.\n Do you want to proceed?")
                            this.res = "";
                            this.res = confirm("Lc Amount is less than bill.\n Do you want to proceed?") ? "Yes" : "No";
                            //if (!this.DialogResult) {
                            if (this.res == "No") {
                                return false;
                            }
                        }
                    }
                }
            }

            if ((this.IsAutoPost && this.parent != null) || this.isSaveXml) {
                this.DisplayMessage = "";
                if (this.savebulk) {
                    sbStatic += "</DocXML>";
                    sbNumeric += "</NumXML>";
                    sbText += "</TextXML>";
                    sbCC += "</CCXML>";
                    sbRows += "</AccXML>";
                    ExtraXml += "</EXTRAXML>";
                    DOcExtraXml += "</DocExtraXML>";
                    ProjectPlanXml += "</ProjectPlanXML>"
                    this.parent.AutoPOstXML = "<AutoPOstXML DocID=\"" + this.ScreenObject.DocID + "\"  DocDetIDs=\"" + DocDetailsID + "\" WOrkFlowID=\"" + this.GetWorkFlow(false, null) + "\" >" + sbRows.toString() + sbStatic.toString() + sbNumeric.toString() + sbCC.toString() + ExtraXml.toString() + sbText.toString() + "<BillXML>" + this.BillWiseXML + "</BillXML><ActXML " + this.getQuery() + "/>";
                }
                else {

                    if (this.isSaveXml)
                        this.AutoPOstXML = "<AutoPOstXML  CCID=\"" + this.ScreenObject.CostCenterID + "\"   DocID=\"" + this.ScreenObject.DocID + "\"  DocDetIDs=\"" + DocDetailsID + "\" WOrkFlowID=\"" + this.GetWorkFlow(false, null) + "\" ><DOCXML>" + sbRows.toString() + "</DOCXML><BillXML>" + this.BillWiseXML + "</BillXML></AutoPOstXML>";
                    else {
                        this.parent.AutoPOstXML = "<AutoPOstXML DocID=\"" + this.ScreenObject.DocID + "\"  DocDetIDs=\"" + DocDetailsID + "\" WOrkFlowID=\"" + this.GetWorkFlow(false, null) + "\" DimensionFor=\"" + this.ScreenObject.DimensionFor + "\"  IsDelete =\"0\" ><DOCXML>" + sbRows.toString() + "</DOCXML><BillXML>" + this.BillWiseXML + "</BillXML>";
                        if (this.AutoProduce != null && this.AutoProduceXML != "")
                            this.parent.AutoPOstXML += this.AutoProduceXML;
                    }
                }

                ;
                if (this.parent != null) {
                    this.parent.AutoPOstXML += "</AutoPOstXML>";
                    BaseService.page.HideDialog(this.PopUpGUID);
                }
                return false;
            }
            if (this.isAutoProduce && this.parent != null) {
                this.DisplayMessage = "";
                this.parent.AutoProduceXML = "<AutoProduceXML DocID=\"" + this.ScreenObject.DocID + "\"  DocDetIDs=\"" + DocDetailsID + "\" CostCenterID=\"" + this.CostCenterID + "\" ><DOCXML>" + sbRows.toString() + "</DOCXML><BillXML>" + this.BillWiseXML + "</BillXML></AutoProduceXML>";
                return false;
            }

            if (!Util.IsEmpty(sender))
                this.commandprarameter = sender.toString();

            let WorkflowID = 0;
            if (!this.LineWiseApproval)
                WorkflowID = this.GetWorkFlow(false, null);
            this.NotifWorkflowID = WorkflowID;

            if (this.DocID == 0 && this.ScreenObject.Preferences.ContainsKey("CreateActDoc") && this.ScreenObject.Preferences["CreateActDoc"] != ""
                && parseBoolean(this.ScreenObject.Preferences["CreateActDoc"])) {
                if (this.ViewActivities == null) {
                    this.ViewActivities = new ViewActivitiesViewModel(this);
                    this.Activities = new ActivitiesViewModel(this, false);
                    this.ViewActivities.Activities = this.Activities;
                    this.ViewActivities.SetColumnsVisibility(this.Activities);
                }
                else {
                    this.Activities = new ActivitiesViewModel(this, false);
                    this.ViewActivities.Activities = this.Activities;
                }

                if (this.ScreenObject.Preferences.ContainsKey("ActSubject") && !Util.IsEmpty(this.ScreenObject.Preferences["ActSubject"])) {
                    let fld: any = this.ScreenObject._TextFields.find(a => a instanceof PactControlData && a.DBColumnName.toLowerCase() == this.ScreenObject.Preferences["ActSubject"].toLowerCase());
                    if (fld != undefined)
                        this.Activities.Subject.Text = this.ScreenObject.GetcontrolValue(fld);
                }
                if (this.ScreenObject.Preferences.ContainsKey("DocActDate") && !Util.IsEmpty(this.ScreenObject.Preferences["DocActDate"])) {
                    let fld = this.ScreenObject._TextFields.find(a => a instanceof PactControlData && a.DBColumnName.toLowerCase() == this.ScreenObject.Preferences["DocActDate"].toLowerCase());
                    if (fld != undefined) {
                        let dt: Date;
                        let date = this.ScreenObject.GetcontrolValue(fld);
                        if (Util.isValidDate(date))
                            this.Activities.StartDate.Date = Util.ParseDate(date);
                    }
                }
                if (this.ScreenObject.Preferences.ContainsKey("DocActTime") && !Util.IsEmpty(this.ScreenObject.Preferences["DocActTime"])) {
                    let fld: any = this.ScreenObject._TextFields.find(a => a instanceof PactControlData && a.DBColumnName.toLowerCase() == this.ScreenObject.Preferences["DocActTime"].toLowerCase());
                    if (fld != undefined) {
                        let date = this.ScreenObject.GetcontrolValue(fld);
                        let dt: Date;
                        if (Util.isValidDate("1/Jan/2020 " + date))
                            this.Activities.StartTime.SelectedValue = date;
                    }
                }
                this.Activities.Status.SelectedValue = "412";
                this.Activities.onSaveActivity("Save");
            }

            let args: string[] = [];
            if (this.savebulk) {
                sbStatic += "</DocXML>";
                sbNumeric += "</NumXML>";
                sbText += "</TextXML>";
                sbCC += "</CCXML>";
                sbRows += "</AccXML>";
                ExtraXml += "</EXTRAXML>";
                DOcExtraXml += "</DocExtraXML>";
                ProjectPlanXml += "</ProjectPlanXML>";

                args.push(sbRows);
                args.push(sbStatic);
                args.push(sbNumeric);
                args.push(DocDetailsID);
                args.push(sbText);
                args.push(sbCC);
                args.push(ExtraXml);
                args.push(DOcExtraXml);
                args.push(this.BillWiseXML);
                args.push(WorkflowID.toString());
                args.push(this.QtyXML);
                args.push(ProjectPlanXml);
            }
            else {

                args.push(sbRows);
                args.push(this.BillWiseXML);
                args.push(this.payTermXml);
                args.push(DocDetailsID);
                args.push(this.LCBillsXml);
                if (this.ScreenObject.DocumentType == 35) {
                    if (this.ViewOrganizationViewModel != null) {
                        args.push(this.ViewOrganizationViewModel.GetXML());
                    }
                }
                else
                    args.push("");
                args.push(this.AutoPOstXML);
                args.push(this.POSpayXml);
                args.push(this.ChkRtnXml);
                args.push(BudgetExceeds.toString());
                if (this.ScreenObject.Preferences.ContainsKey("SkipNegStock") && this.ScreenObject.Preferences["SkipNegStock"].toLowerCase() == "true")
                    args.push("false");
                else
                    args.push(CheckStock.toString());
                args.push(Validate.toString());
                args.push(this.AutoProduceXML);
                if (BillWiseVatAdvanceXML.length > 0)
                    args.push("<AccountingDoc>" + BillWiseVatAdvanceXML + "</AccountingDoc>");
                else
                    args.push("");

                args.push(WorkflowID.toString());
                args.push(Prepayxml);
                args.push(this.QtyXML);
                if (WorkflowID > 0 && this.ScreenObject.Preferences.ContainsKey("L1Remarks") && this.ScreenObject.Preferences["L1Remarks"] == "True"
                    && (sender.toString() == "Save" || sender.toString() == "SaveAndPrint")) {
                    BaseService.page.ShowDialog(new ReviseReasonViewModel(this, 2), ReviseReasonComponent);
                    if (!Util.IsEmpty(this.ReviseReason))
                        args.push(" L1Remarks=\"" + this.ReviseReason + "\"");
                }

                if ((!IsQtyBudLineWise && QtyWhere != "") || (!IsValueBudLineWise && ValueBudWhere != "")) {
                    ValidationMessage = "";
                    if (!IsQtyBudLineWise && QtyWhere != "")
                        ValidationMessage = " BudQtyWhere=\"" + QtyWhere + "\"  BudID=\"" + BudID + "\" BudStartDate=\"" + BudStartDate.ToString("dd/MMM/yyyy") + "\" ";
                    if (!IsValueBudLineWise && ValueBudWhere != "")
                        ValidationMessage += " ValueBudWhere=\"" + QtyWhere + "\"  ValueBudID=\"" + BudID + "\" ValueBudStartDate=\"" + BudStartDate.ToString("dd/MMM/yyyy") + "\" ";
                    args.push(ValidationMessage);
                    ValidationMessage = "";
                }

                if (IgnoreBatches)
                    args.push(" IgnoreBatches=\"1\"");

                this.PoleDisplayMessage(3, null);
                this.PoleDisplaytimer.Enabled = true;
                if (this.strVacXml != null && this.strVacXml != "" && args[0].length > 0) {
                    let vTD = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                    if (vTD) {
                        let strRJD = (vTD as PactExtraFieldDateData).Date.AddDays(1).ToString("dd/MMM/yyyy");
                        args[0] = args[0].replace("dcAlpha1=NULL", "dcAlpha1=N'" + strRJD + "'");

                    }
                    let sbVacXml = "";
                    this.strVacXml = this.strVacXml.replace("LAV", "");
                    sbVacXml += "<AVX><ApplyVacationXML DocID=\"" + 0 + "\" DocDetIDs=\"" + "" + "\" WorkFlowID=\"" + 0 + "\" >";
                    sbVacXml += "<DOCXML>";
                    this.strVacXml = this.strVacXml + sbVacXml.toString();
                    this.strVacXml = this.strVacXml + args[0].toString();
                    this.strVacXml = this.strVacXml + "</DOCXML></ApplyVacationXML></AVX>";
                    this.strVacXml = this.strVacXml.replace("\u0011", "<RowHead/>");
                    return true;
                }
                if (!Util.IsEmpty(this.strPMCXml) && args[0].length > 0) {
                    let xDoc = new XmlDocument();
                    if (BaseService.SessionManager.FMExtraXml != "") {
                        xDoc.LoadXml(BaseService.SessionManager.FMExtraXml);
                        this.iPMCActivity = this.iPMCActivity + 1;
                        let xList = xDoc.SelectNodes("xml/Row");
                        for (let x = 0; x < xList.length; x++) {
                            if (xList[x].attributes["StartDate"].value != "") {
                                let sbPMCXml = '';
                                this.strPMCXml = this.strPMCXml.Replace("PRS", "");
                                sbPMCXml += "<AVX>";
                                sbPMCXml += "<PMCXML DocID=\"" + xList[x].attributes["DocID"].value.toString() + "\" DocDetIDs=\"" + xList[x].attributes["DocDetailsID"].value.toString() + "\" WorkFlowID=\"" + 0 + "\" StartDate=\"" + Util.ParseDate(xList[x].attributes["StartDate"].value).ToString("dd/MMM/yyyy") + "\" DocSeqNo=\"" + this.iPMCActivity + "\" >";
                                sbPMCXml += "<DOCXML>";
                                this.strPMCXml = this.strPMCXml + sbPMCXml.toString();
                                this.strPMCXml = this.strPMCXml + args[0].toString();
                                this.strPMCXml = this.strPMCXml + "</DOCXML></PMCXML>";

                                sbPMCXml = '';
                                sbPMCXml += "<PMCACTIVITYXML>";
                                sbPMCXml += "<DOCACTIVITYXML>" + "#PMCACTIVITYXML#";

                                this.strPMCXml = this.strPMCXml + sbPMCXml.toString();
                                this.strPMCXml = this.strPMCXml + "</DOCACTIVITYXML></PMCACTIVITYXML>";

                                this.strPMCXml = this.strPMCXml + "</AVX>";
                                this.strPMCXml = this.strPMCXml.Replace("\u0011", "<RowHead/>");
                            }
                        }
                        if (this.ViewActivities != null)
                            this.strPMCXml = this.strPMCXml.Replace("#PMCACTIVITYXML#", this.ViewActivities.FMActivitiesXML(this.iPMCActivity - 1));
                        return true;
                    }
                }
                if (this.strADWxml != null && this.strADWxml != "" && args[0].length > 0 && this.IsMPVParent) {
                    let sbADWxml = "";
                    this.strADWxml = this.strADWxml.replace("ADWxml", "");
                    sbADWxml += "<AttendanceDimensionwiseXML DocID=\"" + this.ScreenObject.DocID + "\" DocDetIDs=\"" + DocDetailsID + "\" WorkFlowID=\"" + this.GetWorkFlow(false, null) + "\" >";
                    sbADWxml += "<DOCXML>";
                    this.strADWxml = this.strADWxml + sbADWxml.toString();
                    this.strADWxml = this.strADWxml + args[0].toString();
                    this.strADWxml = this.strADWxml + "</DOCXML></AttendanceDimensionwiseXML>";
                    this.strADWxml = this.strADWxml.replace("\u0011", "<RowHead/>");
                    this.DialogResult = true;
                    BaseService.page.HideDialog(this.PopUpGUID);
                    return true;
                }

                if (this.ScreenObject.DocumentType == 85) {
                    this.sApprUpdate = "";
                    if (!this.BulkAppraisalsInsert()) {
                        return false;
                    }
                }
            }
            //End: Activity Xml for applying the vacation

            if (CallType == "SYNC_SAVE") {
                console.log("SYNC_SAVE in ");
                this.InventorySave_DoWork(null, args);
                console.log("SYNC_SAVE out ");
                //this.SaveComplete(Validate);
            }
            else {/***
                if (this.commandprarameter != "ReSave" && Validate)
                {
                    BackgroundWorker InventorySave = new BackgroundWorker();
                    InventorySave.DoWork += new DoWorkEventHandler(this.InventorySave_DoWork);
                    InventorySave.RunWorkerAsync(args);
                    InventorySave.RunWorkerCompleted += new RunWorkerCompletedEventHandler(this.Save_Completed);
                    return true;
                }
                else
                {
                    this.InventorySave_DoWork(null, args);
                    this.SaveComplete(false);
                }***/
            }

            Logger.InfoLog("AddEditDocumentViewModel::Exiting OnSaveAccount");
        }
        catch (error) {
            if (BaseService.SessionManager.IsWebApplication) {
                this.DisplayMessage = "Save Error";
            }
            Logger.ErrorLog("AddEditDocumentViewModel::" + error.stack, "SaveInventoryDocument", error.message);
            return false;
        }
        return true;
    }

    FillAutoBatchesforDynamic(row: number) {
        let BatchesExists = false;
        let dsvm: any = new DynamicSetViewModel(this, this.ScreenObject.GridData[row], null);
        for (let i = 0; i < dsvm.GridData.length; i++) {
            if (dsvm.GridData[i]["Type"].toString() == "5" && Util.IsEmpty(dsvm.GridData[i]["ExtraXML"])) {
                let div = 0, loc = 0;
                if (this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])) {
                    let ccfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
                    if (ccfld && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0)
                        loc = ccfld.SelectedValue;
                    else if (!Util.IsEmpty(this.ScreenObject.GridData[row]["dcCCNID2_Key"]))
                        loc = parseInt(this.ScreenObject.GridData[row]["dcCCNID2_Key"]);
                }
                else if (this.ScreenObject.LocationID > 0)
                    loc = this.ScreenObject.LocationID;
                else
                    loc = BaseService.SessionManager.LocationID;
                if (this.ScreenObject.DivisionID > 0)
                    div = this.ScreenObject.DivisionID;
                else
                    div = BaseService.SessionManager.DivisionID;
                let qt = Util.Double(dsvm.GridData[i]["Quantity"]);
                if (qt > 0) {
                    BatchesExists = true;
                    let objbat = new BatchNumberViewModel(this.ScreenObject.GridDataObj);
                    objbat.BatchNumberViewModel_3(this, this.VoucherType, qt, parseInt(dsvm.GridData[i]["ProductID_Key"]), dsvm.GridData[i]["ProductName"].toString(), loc, div, dsvm.GridData[i], dsvm.GridData)
                    {
                        objbat.ChkFifo = true;
                        objbat.OnSave("AutoSave");
                        if (objbat.count > 1)
                            this.ScreenObject.UpdateSequence();
                    }
                }
            }
        }
        if (BatchesExists)
            dsvm.OnButtonClick("OK");
    }

    AutoAdjustBOE(i: number) {
        if (this.VoucherType == -1 && this.ScreenObject.Preferences.ContainsKey("AutoBOE") && !Util.IsEmpty(this.ScreenObject.Preferences["AutoBOE"]) && parseBoolean(this.ScreenObject.Preferences["AutoBOE"])) {
            if (!this.ScreenObject.GridDataColumns.Contains("BOEAdjusted"))
                this.ScreenObject.GridDataColumns.push("BOEAdjusted");
        }
        if (i == 0 && this.ScreenObject.GridDataColumns.Contains("BOEAdjusted")) {
            for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                if (this.ScreenObject.GridDataColumns.Contains("landingType") && (this.ScreenObject.GridData[i]["landingType"].toString() == "1" || this.ScreenObject.GridData[i]["landingType"].toString() == "2")
                    && (Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"]) || parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) == 0)) {
                    this.ScreenObject.GridData[k]["DocExtraXML"] = null;
                    this.ScreenObject.GridData[k]["BinsXML"] = null;
                }
                this.ScreenObject.GridData[k]["BOEAdjusted"] = "0";
            }
        }

        if (this.ScreenObject.GridDataColumns.Contains("BOEAdjusted") && this.ScreenObject.GridData[i]["BOEAdjusted"].toString() == "1")
            return;

        if (this.VoucherType == -1 && this.ScreenObject.Preferences.ContainsKey("AutoBOE") && this.ScreenObject.Preferences["AutoBOE"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["AutoBOE"])
            && this.ScreenObject.GridDataColumns.Contains("landingType") && (this.ScreenObject.GridData[i]["landingType"].toString() == "1" || this.ScreenObject.GridData[i]["landingType"].toString() == "2")
            && (Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"]) || parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) == 0)) {

            let objFifo = new FieldCalculatorViewModel(this, 2, this.ScreenObject.GridData[i]);
            let invIDs: string = objFifo.LoadBoes("", this.ScreenObject.GridData[i]);
            objFifo.FillBoeData(invIDs);
            let AmtLeft = 0;
            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["UOMConvertedQty"]))
                AmtLeft = parseFloat(this.ScreenObject.GridData[i]["UOMConvertedQty"]);

            for (let k = 0; k < objFifo.GridData.length; k++) {
                if (!Util.IsEmpty(objFifo.GridData[k]["RefID"]) && AmtLeft > 0) {
                    let due = Util.Double(objFifo.GridData[k]["AvailQty"]);
                    if (AmtLeft >= due) {
                        objFifo.GridData[k]["Qty"] = due;

                        if (this.ScreenObject.GridDataColumns.Contains("BinWise") && this.ScreenObject.GridData[i]["BinWise"].toString() == "True") {
                            let dsbins: any = this.ScreenObject.GetinvBinDetails(objFifo.GridData[k]["RefID"].toString(), this.ScreenObject.GridData[i]["ProductID_Key"].toString(), this.ScreenObject.GridData[i]["LinkedInvDocDetailsID"].toString());
                            objFifo.FillBins(dsbins, 0, objFifo.GridData[k]["RefID"].toString());
                        }

                        AmtLeft = AmtLeft - due;
                    }
                    else {
                        objFifo.GridData[k]["Qty"] = AmtLeft;
                        if (this.ScreenObject.GridDataColumns.Contains("BinWise") && this.ScreenObject.GridData[i]["BinWise"].toString() == "True") {
                            let dsbins: any = this.ScreenObject.GetinvBinDetails(objFifo.GridData[k]["RefID"].toString(), this.ScreenObject.GridData[i]["ProductID_Key"].toString(), this.ScreenObject.GridData[i]["LinkedInvDocDetailsID"].toString());
                            objFifo.FillBins(dsbins, 0, objFifo.GridData[k]["RefID"].toString());
                        }
                        AmtLeft = 0;
                    }
                }
            }
            objFifo.SaveBoe(this.ScreenObject.GridData[i]);
        }
    }

    GetBudgetXml(datarow: any): string {
        if (!this.ScreenObject.Preferences.ContainsKey("BudgetType") || this.ScreenObject.Preferences["BudgetType"] == "")
            return "";

        let AnnualField = "";
        if (this.ScreenObject.Preferences.ContainsKey("BudgetAnnualAmount") && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["BudgetAnnualAmount"]))
            AnnualField = this.ScreenObject.Preferences["BudgetAnnualAmount"];

        let iBudCnt = 12;
        if (this.ScreenObject.Preferences["BudgetType"] == "1")
            iBudCnt = 6;
        else if (this.ScreenObject.Preferences["BudgetType"] == "2")
            iBudCnt = 3;
        else if (this.ScreenObject.Preferences["BudgetType"] == "3")
            iBudCnt = 1;

        let sb = "";
        sb += "<DynPromXML BudgetDoc=\"" + this.ScreenObject.Preferences["BudgetDoc"] + "\" >";
        let tempdbl = Util.Double(datarow[AnnualField]);
        let disttot = 0, distamt = 0;
        if (iBudCnt == 12)
            distamt = parseFloat((tempdbl / 12).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));
        else {
            tempdbl = Util.Double(datarow[this.ScreenObject.Preferences["BudgetField1"]]);
            distamt = parseFloat((tempdbl / iBudCnt).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));
        }

        let dt = this.DocumentDate;
        if (this.ScreenObject.GridDataColumns.Contains("BillDate_Key") && !Util.IsEmpty(datarow["BillDate_Key"]))
            dt = Util.ParseDate(datarow["BillDate_Key"]);
        else {
            let fldbilldate = this.ScreenObject.HeaderFields.find(a => a instanceof PactExtraFieldDateData && a.DBColumnName.toLowerCase() == "billdate") as PactExtraFieldDateData;
            if (fldbilldate != null && fldbilldate.Date)
                dt = fldbilldate.Date;
        }

        for (let i = 1; i <= 12; i++) {
            if ((i % iBudCnt) == 0) {
                if (iBudCnt == 1) {
                    tempdbl = Util.Double(datarow[this.ScreenObject.Preferences["BudgetField" + (i / iBudCnt)]]);
                    distamt = parseFloat((tempdbl / iBudCnt).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));
                    sb += "<Row DocDate=\"" + dt.AddMonths(i - 1).ToString("dd/MMM/yyyy") + "\" Amount=\"" + distamt + "\" />";
                }
                else {
                    sb += "<Row DocDate=\"" + dt.AddMonths(i - 1).ToString("dd/MMM/yyyy") + "\" Amount=\"" + parseFloat((tempdbl - disttot).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"])) + "\" />";
                    if (i == 12)
                        continue;
                    tempdbl = Util.Double(datarow[this.ScreenObject.Preferences["BudgetField" + ((i / iBudCnt) + 1).toString()]]);
                    distamt = parseFloat((tempdbl / iBudCnt).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));
                    disttot = 0;
                }
            }
            else {
                sb += "<Row DocDate=\"" + dt.AddMonths(i - 1).ToString("dd/MMM/yyyy") + "\" Amount=\"" + distamt + "\" />";
                disttot += distamt;
            }
        }
        sb += "</DynPromXML>";
        return sb;
    }

    CheckEmptyGrid() {
        let colName: string = this.GetPrimaryColName();

        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName])) {
                return;
            }
        }

        let prodcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == colName.toLowerCase());
        if (prodcol && colName != "" && !Util.IsEmpty(prodcol.DefaultValue) && prodcol.DefaultValueText != null && Util.IsNum(prodcol.DefaultValue) && (parseInt(prodcol.DefaultValue) > 0 || parseInt(prodcol.DefaultValue) == -100)) {
            let namecode: string[] = prodcol.DefaultValueText.split('\u0011');

            let dr: any = this.ScreenObject.GridData[this.GetEmptyRowPosition(this.ScreenObject.GridDataObj, colName)];
            dr["DocDetailsID"] = 0;

            if (this.IsInventoryVoucher) {
                dr["ProductID_Key"] = prodcol.DefaultValue;
                if (this.ScreenObject.GridDataColumns.Contains("ProductCode") && namecode.length > 1)
                    dr["ProductCode"] = namecode[1];
                if (this.ScreenObject.GridDataColumns.Contains("ProductName") && namecode.length > 0)
                    dr["ProductName"] = namecode[0];

                this.AddProductData(dr, false, false);
            }
            else {
                dr[colName] = prodcol.DefaultValue;
                if (this.ScreenObject.GridDataColumns.Contains("AccountCode") && namecode.length > 1)
                    dr["AccountCode"] = namecode[1];
                if (this.ScreenObject.GridDataColumns.Contains("AccountName") && namecode.length > 0)
                    dr["AccountName"] = namecode[0];
                this.FillDefaultValues(dr);
            }
            this.CalculateTotals(dr, false);
        }
    }

    GetAssetValue(dtasset: any, dr: any, Name: string): string {
        let drrows = dtasset.Tables[1].filter(x => x.SysColumnName == Name);
        if (drrows.length > 0)
            return this.ScreenObject.GetValueBYCOLID(drrows[0]["BatchColID"].toString(), dr);
        else
            return dtasset.Tables[0][0][Name].toString();
    }

    getAssetDeprXML(dr: any, SameMonthDepr: boolean): string {
        let oFormula: any = new DepreciationSchedule(0);

        let dsasset: any = this.ScreenObject.GetAssetDetByProduct(parseInt(dr["ProductID_Key"].toString()));

        if (dsasset != null && dsasset.Tables.length > 1 && dsasset.Columns[0].Contains("IsDeprSchedule") &&
            dsasset.Tables[0].length > 0 && dsasset.Tables[0][0]["IsDeprSchedule"].toString() == "1") {

            let Cost = 0, Sal = 0;
            let Life = "0";
            let stDate: Date, endDate: Date;
            let OUtmessage: string;
            Cost = Util.Double(this.GetAssetValue(dsasset, dr, "PurchaseValue"));
            if (SameMonthDepr)
                Life = "0.1";
            else
                Life = this.GetAssetValue(dsasset, dr, "EstimateLife");
            Sal = Util.Double(this.GetAssetValue(dsasset, dr, "SalvageValue"));
            stDate = Util.ParseDate(this.GetAssetValue(dsasset, dr, "DeprStartDate"));

            if (dsasset.Tables[0][0]["SalvageValueType"].toString() == "2") {
                Sal = (Sal * Cost) / 100;
            }

            let iYears = 0, iMonths = 0, iDays = 0;
            try {
                let arrDec = Life.split('.');
                iYears = Util.Int(arrDec[0]);
                if (arrDec.length > 1)
                    iMonths = Util.Int(arrDec[1]);
                if (arrDec.length > 2)
                    iDays = Util.Int(arrDec[2]);
            }
            catch { }

            if (SameMonthDepr) {
                stDate = new Date(stDate.getFullYear(), stDate.getMonth(), 1);
                endDate = stDate.AddMonths(iMonths).AddDays(-1);
            }
            else {
                endDate = stDate.AddYears(iYears);//.Subtract(TimeSpan.FromDays(1)); //Util.ParseDate(TxtEndDepr.Text);
                endDate = endDate.AddMonths(iMonths);
                endDate = endDate.AddDays(iDays);
                endDate = endDate.AddDays(-1);
            }

            let deprMeth = this.GetAssetValue(dsasset, dr, "DepreciationMethod");
            let AvgMeth = this.GetAssetValue(dsasset, dr, "AveragingMethod");
            let Period = this.GetAssetValue(dsasset, dr, "Period");
            let DeprBookID = this.GetAssetValue(dsasset, dr, "DeprBookID");
            oFormula.GetScheduleData(Cost, iYears, iMonths, 0, null, 0, Sal, deprMeth, Period, 0, AvgMeth,
                stDate, endDate, null, DeprBookID);
            OUtmessage = oFormula.ErrorMessage;
            return oFormula.GetXML().replace("XML", "DeprXML");
        }
        return "";
    }

    PickDbCr(drGrid: any, ReserveAccount: number, IsCred: boolean): number {
        let Acc = 0;
        if (IsCred) {
            if (this.ScreenObject.CreditAccount != null)
                Acc = this.ScreenObject.CreditAccount.SelectedValue;
            else if (Util.Int(drGrid["CreditAccount_Key"]) > 0)
                Acc = parseInt(drGrid["CreditAccount_Key"]);
            else if (this.ScreenObject.GridDataColumns.Contains("CCQuery") && Util.Int(drGrid["CreditAccount"]) > 0)
                Acc = parseInt(drGrid["CreditAccount"]);
            else {
                if (this.ScreenObject.DocumentType == 16 || this.ScreenObject.DocumentType == 17 || this.ScreenObject.DocumentType == 28 || this.ScreenObject.DocumentType == 29) {
                    if (Util.Double(drGrid["CreditAmount"]) != 0 && Util.Int(drGrid["AccountID_Key"]) > 0)
                        Acc = parseInt(drGrid["AccountID_Key"]);
                    else
                        Acc = ReserveAccount;
                }
            }
        }
        else {
            if (this.ScreenObject.DebitAccount != null)
                Acc = this.ScreenObject.DebitAccount.SelectedValue;
            else if (Util.Int(drGrid["DebitAccount_Key"]) > 0)
                Acc = parseInt(drGrid["DebitAccount_Key"]);
            else if (this.ScreenObject.GridDataColumns.Contains("CCQuery") && Util.Int(drGrid["DebitAccount"]) > 0)
                Acc = parseInt(drGrid["DebitAccount"]);
            else {
                if (this.ScreenObject.DocumentType == 16 || this.ScreenObject.DocumentType == 17 || this.ScreenObject.DocumentType == 28 || this.ScreenObject.DocumentType == 29) {
                    if (Util.Double(drGrid["DebitAmount"]) != 0 && Util.Int(drGrid["AccountID_Key"]) > 0)
                        Acc = parseInt(drGrid["AccountID_Key"]);
                    else
                        Acc = ReserveAccount;
                }
            }
        }
        return Acc;
    }

    FillCostPosting(DBAcc: number, CrACC: number, PostingValue: number, dr: any, costdims: string[], currencyid: number, exchrate: number, col: any, refObj: any) {
        let decimalpoints = (col.NoRoundOff) ? "6" : col.DecimalPoints;
        refObj.CostXML = '';
        let where = '';
        let incType = false;
        let dsprof: any = null;
        if (col.distDim > 0) {
            dsprof = new XmlDocument();;
            if (col.distLineWise && !Util.IsEmpty(dr[col.DisplayMember + "DistXML"]))
                dsprof.ReadXml(dr[col.DisplayMember + "DistXML"].toString());
            else if (!Util.IsEmpty(col.distxml))
                dsprof.ReadXml(col.distxml);
            else
                return false;
        }
        else {
            for (let m = 0; m < costdims.length; m++) {
                let item = costdims[m]
                if (parseInt(item) > 50000) {
                    if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (parseInt(item) - 50000) + "_Key")) {
                        if (!Util.IsEmpty(dr["dcCCNID" + (parseInt(item) - 50000) + "_Key"]))
                            where += " and DCCCNID" + (parseInt(item) - 50000) + "=" + dr["dcCCNID" + (parseInt(item) - 50000) + "_Key"].toString();
                    }
                    else {
                        var fld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == parseInt(item)) as PactListBoxData;
                        if (fld && fld.SelectedValue > 0)
                            where += " and DCCCNID" + (parseInt(item) - 50000) + "=" + fld.SelectedValue.toString();
                    }
                }
                else if (parseInt(item) == 2)
                    where += " and AccountID in(" + DBAcc + "," + CrACC + ")";
                else if (parseInt(item) == 502) {
                    incType = true;
                    where += " and (db.AccountID is not null or Cr.AccountID is not null)";
                }
            }

            dsprof = this.ScreenObject.getProfileBasedon(DBAcc, CrACC, incType, where);
        }
        let isneg = false;
        if (PostingValue < 0) {
            PostingValue = PostingValue * -1;
            isneg = true;
        }

        if (dsprof != null && dsprof.Tables.length > 0 && dsprof.Tables[0].length > 0
            && (col.distDim > 0 || dsprof.Columns[0].Contains("ProfileID"))) {
            let sbRows = '';
            let tot = 0;
            let dims: any[];
            if (col.distDim > 0)
                dims.push[0] = col.distDim.toString();//new string[1] { col.distDim.toString() };
            else
                dims = BaseService.SessionManager.Preferences["DistributeCostDims"].split(',');
            let strcc = '';
            this.ScreenObject._CCFields.forEach(oControl => {
                if (oControl instanceof PactListBoxData && oControl.SelectedValue > 0 && !dims.Contains(oControl.CCID.toString()))
                    strcc += oControl.DBColumnName + "=" + oControl.SelectedValue + ", ";
                else if (oControl instanceof PactCodeNameListBoxData && oControl.SelectedValue > 0 && !dims.Contains(oControl.CCID.toString()))
                    strcc += oControl.DBColumnName + "=" + oControl.SelectedValue + ", ";
            });
            for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                if (this.ScreenObject.ColumnSource[j].IsColumnUserDefined && this.ScreenObject.ColumnSource[j].CostCenterID > 50000 && !dims.Contains(this.ScreenObject.ColumnSource[j].CostCenterID.toString())
                    && this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().startsWith("dcccnid") && !Util.IsEmpty(dr[this.ScreenObject.ColumnSource[j].ValueMember]))
                    strcc += this.ScreenObject.ColumnSource[j].DisplayMember + "=" + dr[this.ScreenObject.ColumnSource[j].ValueMember].toString() + ", ";
            }
            let isperc = false;


            let fld: any = this.ScreenObject._StaticFields.find(a => a.DBColumnName.toLowerCase() == "commonnarration");


            for (let i = 0; i < dsprof.Tables[0].length; i++) {

                let Amt = 0;
                if (!Util.IsEmpty(dsprof.Tables[0][i]["Percent"]) && parseFloat(dsprof.Tables[0][i]["Percent"].toString()) > 0) {
                    Amt = parseFloat(((PostingValue * parseFloat(dsprof.Tables[0][i]["Percent"].toString())) / 100).ToString("N" + decimalpoints));
                    isperc = true;
                }
                else if (!Util.IsEmpty(dsprof.Tables[0][i]["Amount"]) && parseFloat(dsprof.Tables[0][i]["Amount"].toString()) > 0)
                    Amt = parseFloat(dsprof.Tables[0][i]["Amount"].toString());

                if (Amt > 0) {
                    if (isperc && (i + 1) == dsprof.Tables[0].length)
                        Amt = parseFloat((PostingValue - tot).ToString("N" + decimalpoints));
                    tot += Amt;

                    sbRows += "\u0011";
                    sbRows += "<Row><Transactions DocDetailsID=\"0\" IsQtyIgnored=\"1\" DocSeqNo=\"" + this.ScreenObject.GridData.length + "\" ";
                    sbRows += "Quantity=\"\" UOMConversion=\"1\" UOMConvertedQty=\"1\" Unit=\"1\" Rate=\"" + Amt + "\" ";
                    sbRows += " CurrencyID=\"" + currencyid + "\" ExchangeRate=\"" + exchrate + "\" ";
                    sbRows += "Gross=\"" + Amt + "\" StockValue=\"" + (Amt * exchrate).ToString("N" + decimalpoints).Replace(",", "") + "\" ";
                    sbRows += " StockValueFC=\"" + Amt + "\" ";
                    sbRows += " DynamicInvDocDetailsID=\"-1\" ProductID=\"" + dr["ProductID_Key"].toString() + "\" ";

                    if (isneg) {
                        sbRows += "  CreditAccount=\"" + DBAcc + "\" ";
                        sbRows += "  DebitAccount=\"" + CrACC.toString() + "\" ";
                    }
                    else {
                        sbRows += "  CreditAccount=\"" + CrACC + "\" ";
                        sbRows += "  DebitAccount=\"" + DBAcc.toString() + "\" ";
                    }
                    if (fld != null && fld != undefined) {
                        if (fld instanceof PactTextBoxData && !Util.IsEmpty(fld.Text))
                            sbRows += " CommonNarration=\"" + PactTextBoxData.GetValidXml(fld.Text) + "\" ";
                        else if (fld instanceof PactTextAreaData && !Util.IsEmpty(fld.Text))
                            sbRows += " CommonNarration=\"" + PactTextBoxData.GetValidXml(fld.Text) + "\" ";
                    }
                    if (this.ScreenObject.GridDataColumns.Contains("LineNarration"))
                        sbRows += " LineNarration=\"" + PactTextBoxData.GetValidXml(dr["LineNarration"].toString()) + "\" ";

                    sbRows += " ></Transactions>";

                    sbRows += "<AccountsXML><Accounts ";
                    if (isneg) {
                        sbRows += "  CreditAccount=\"" + DBAcc + "\" ";
                        sbRows += "  DebitAccount=\"" + CrACC.toString() + "\" ";
                        sbRows += "  IsNegative=\"1\"";
                    }
                    else {
                        sbRows += " CreditAccount=\"" + CrACC + "\" ";
                        sbRows += "  DebitAccount=\"" + DBAcc.toString() + "\" ";
                    }
                    if (fld != null && fld != undefined) {
                        if (fld instanceof PactTextBoxData && !Util.IsEmpty(fld.Text))
                            sbRows += " CommonNarration=\"" + PactTextBoxData.GetValidXml(fld.Text) + "\" ";
                        else if (fld instanceof PactTextAreaData && !Util.IsEmpty(fld.Text))
                            sbRows += " CommonNarration=\"" + PactTextBoxData.GetValidXml(fld.Text) + "\" ";
                    }
                    if (this.ScreenObject.GridDataColumns.Contains("LineNarration"))
                        sbRows += " LineNarration=\"" + PactTextBoxData.GetValidXml(dr["LineNarration"].toString()) + "\" ";

                    sbRows += " CurrencyID=\"" + currencyid + "\" ExchangeRate=\"" + exchrate + "\" ";
                    sbRows += "Amount=\"" + (Amt * exchrate).ToString("N" + decimalpoints).Replace(",", "") + "\" AmtFc=\"" + Amt + "\" ></Accounts></AccountsXML>";
                    sbRows += "<EXTRAXML></EXTRAXML>";

                    sbRows += "<Numeric /><Alpha />";
                    sbRows += "<CostCenters Query=\"" + strcc.toString();

                    dims.forEach(item => {
                        if (parseInt(item) > 50000 && dsprof.Columns[0].Contains("DcCCNID" + (parseInt(item) - 50000))
                            && !Util.IsEmpty(dsprof.Tables[0][i]["DcCCNID" + (parseInt(item) - 50000)]))
                            sbRows += "DcCCNID" + (parseInt(item) - 50000) + "=" + dsprof.Tables[0][i]["DcCCNID" + (parseInt(item) - 50000)].toString() + ",";
                    });
                    sbRows += "\" ></CostCenters>";
                    sbRows += "</Row>";
                }
            }

            tot = PostingValue - tot;
            if (tot > 0.01) {

                sbRows += "\u0011";
                sbRows += "<Row><Transactions DocDetailsID=\"0\" IsQtyIgnored=\"1\" DocSeqNo=\"" + this.ScreenObject.GridData.length + "\" ";
                sbRows += "Quantity=\"\" UOMConversion=\"1\" UOMConvertedQty=\"1\" Unit=\"1\" Rate=\"" + tot + "\" ";
                sbRows += " CurrencyID=\"" + currencyid + "\" ExchangeRate=\"" + exchrate + "\" ";
                sbRows += "Gross=\"" + tot + "\" StockValue=\"" + (tot * exchrate).ToString("N" + decimalpoints).Replace(",", "") + "\" ";
                sbRows += " StockValueFC=\"" + tot + "\" ";
                sbRows += " DynamicInvDocDetailsID=\"-1\" ProductID=\"" + dr["ProductID_Key"].toString() + "\" ";

                if (isneg) {
                    sbRows += "  CreditAccount=\"" + DBAcc + "\" ";
                    sbRows += "  DebitAccount=\"" + CrACC.toString() + "\" ";
                }
                else {
                    sbRows += "  CreditAccount=\"" + CrACC + "\" ";

                    sbRows += "  DebitAccount=\"" + DBAcc.toString() + "\" ";
                }
                if (fld != null && fld != undefined) {
                    if (fld instanceof PactTextBoxData && !Util.IsEmpty(fld.Text))
                        sbRows += " CommonNarration=\"" + PactTextBoxData.GetValidXml(fld.Text) + "\" ";
                    else if (fld instanceof PactTextAreaData && !Util.IsEmpty(fld.Text))
                        sbRows += " CommonNarration=\"" + PactTextBoxData.GetValidXml(fld.Text) + "\" ";
                }
                if (this.ScreenObject.GridDataColumns.Contains("LineNarration"))
                    sbRows += " LineNarration=\"" + PactTextBoxData.GetValidXml(dr["LineNarration"].toString()) + "\" ";

                sbRows += " ></Transactions>";

                sbRows += "<AccountsXML><Accounts ";
                if (isneg) {
                    sbRows += "  CreditAccount=\"" + DBAcc + "\" ";
                    sbRows += "  DebitAccount=\"" + CrACC.toString() + "\" ";
                    sbRows += "  IsNegative=\"1\"";
                }
                else {
                    sbRows += " CreditAccount=\"" + CrACC + "\" ";
                    sbRows += "  DebitAccount=\"" + DBAcc.toString() + "\" ";
                }
                if (fld != null && fld != undefined) {
                    if (fld instanceof PactTextBoxData && !Util.IsEmpty(fld.Text))
                        sbRows += " CommonNarration=\"" + PactTextBoxData.GetValidXml(fld.Text) + "\" ";
                    else if (fld instanceof PactTextAreaData && !Util.IsEmpty(fld.Text))
                        sbRows += " CommonNarration=\"" + PactTextBoxData.GetValidXml(fld.Text) + "\" ";
                }
                if (this.ScreenObject.GridDataColumns.Contains("LineNarration"))
                    sbRows += " LineNarration=\"" + PactTextBoxData.GetValidXml(dr["LineNarration"].toString()) + "\" ";

                sbRows += " CurrencyID=\"" + currencyid + "\" ExchangeRate=\"" + exchrate + "\" ";
                sbRows += "Amount=\"" + (tot * exchrate).ToString("N" + decimalpoints).Replace(",", "") + "\" AmtFc=\"" + tot + "\" ></Accounts></AccountsXML>";
                sbRows += "<EXTRAXML></EXTRAXML>";

                sbRows += "<Numeric /><Alpha />";
                sbRows += "<CostCenters Query=\"" + strcc.toString();

                sbRows += "\" ></CostCenters>";
                sbRows += "</Row>";
            }
            refObj.CostXML = sbRows.toString();
            return true;
        }

        return false;
    }


    FillAccountPosting(SrcCol: DgColumn, drGrid: any, PostingValue: string, CurrID: number, ExhgRate: number
        , outObj: any, ReserveAccount: number = 0, RowCount: number = 0): boolean {//out long DBAcc, out long CrACC, out string PostingXml

        outObj.PostingXml = "";
        let sbAccounts = "";
        sbAccounts += "<Accounts ";
        outObj.DBAcc = 0; outObj.CrACC = 0;

        let IsNeg = false;
        if (parseFloat(PostingValue) < 0)
            IsNeg = true;

        if (SrcCol.DrRefColID == -98 || SrcCol.DrRefColID == -99) {
            let From = 0, To = 0;
            let SysColName = "";
            if (BaseService.SessionManager.Preferences.ContainsKey("CrossDimension") && BaseService.SessionManager.Preferences["CrossDimension"].toString() != "")
                SysColName = "dcCCNID" + (parseInt(BaseService.SessionManager.Preferences["CrossDimension"]) - 50000);

            if (this.ScreenObject.GridDataColumns.Contains(SysColName + "_Key")) {
                if (!Util.IsEmpty(drGrid[SysColName + "_Key"]))
                    From = parseInt(drGrid[SysColName + "_Key"]);
                else {
                    let drcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == SysColName.toLowerCase());
                    this.DisplayMessage = "Select ";
                    if (drcol)
                        this.DisplayMessage += drcol.Header;
                    this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString();

                    return false;
                }
            }
            else {
                let field = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == SysColName.toLowerCase());
                if (field && field instanceof PactListBoxData) {
                    if (field.SelectedValue > 0)
                        From = field.SelectedValue;
                    else {
                        this.DisplayMessage = "Select " + field.Label;

                        return false;
                    }
                }
                else {
                    this.DisplayMessage = "Define Cross Dimension field to use Cross Dimension Debit or Credit.";

                    return false;
                }
            }
            if (this.DocumentType == 5)
                SysColName = "to" + SysColName;
            else {
                let tempint = Util.Int(this.ScreenObject.Preferences["CrossDimField"]);
                if (this.ScreenObject.Preferences.ContainsKey("CrossDimField")) {
                    let drcd = this.ScreenObject.Data.Tables[0].filter(x => x.CostCenterColID == tempint);
                    if (drcd.length > 0)
                        SysColName = Util.String(drcd[0]["SysColumnName"]);
                    else {
                        this.DisplayMessage = "Define To Cross Dimension field to use Cross Dimension Debit or Credit.";
                        this.MessageVisibility = true;
                        return false;
                    }
                }
                else {
                    this.DisplayMessage = "Define To Cross Dimension field to use Cross Dimension Debit or Credit.";
                    this.MessageVisibility = true;
                    return false;
                }
            }
            if (this.ScreenObject.GridDataColumns.Contains(SysColName + "_Key")) {
                if (!Util.IsEmpty(drGrid[SysColName + "_Key"]))
                    To = parseInt(drGrid[SysColName + "_Key"]);
                else {
                    let drcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == SysColName.toLowerCase());
                    this.DisplayMessage = "Select ";
                    if (drcol)
                        this.DisplayMessage += drcol.Header;
                    this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString();
                    return false;
                }
            }
            else {
                let field = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == SysColName.toLowerCase());
                if (field == null)
                    field = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == SysColName.toLowerCase());
                if (field && field instanceof PactListBoxData) {
                    if (field.SelectedValue > 0)
                        To = field.SelectedValue;
                    else {
                        this.DisplayMessage = "Select " + field.Label;

                        return false;
                    }
                }
                else {
                    this.DisplayMessage = "Define Cross Dimension field to use Cross Dimension Debit or Credit.";

                    return false;
                }
            }

            if (From == To)
                outObj.DBAcc = this.PickDbCr(drGrid, ReserveAccount, true);
            else
                outObj.DBAcc = this.ScreenObject.GetAccountByRef(SrcCol.DrRefColID, From, To);

            if (outObj.DBAcc == 0) {
                this.DisplayMessage = "Cross dimension Accounts Not defined";
                return false;
            }
        }
        else if ((this.ScreenObject.DocumentType == 56 || this.ScreenObject.DocumentType == 57) && (SrcCol.DrRefColID == -3001 || SrcCol.DrRefColID == -3002))  // ApplyLoan/LoanRepayment -> EMP_Loan_CrAccount & EMP_Loan_DrAccount
        {
            let iEmpSeqNo = 0, iLoanType = 0;
            let field = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (field && (field instanceof PactListBoxData || field instanceof PactCodeNameListBoxData)) {
                if (field instanceof PactListBoxData && field.SelectedValue > 0)
                    iEmpSeqNo = field.SelectedValue;
                else if (field instanceof PactCodeNameListBoxData && field.SelectedValue > 0)
                    iEmpSeqNo = field.SelectedValue;
            }
            if (this.ScreenObject.DocumentType == 56) {
                field = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
                if (field && field instanceof PactListBoxData) {
                    if (field.SelectedValue > 0)
                        iLoanType = field.SelectedValue;
                }
            }
            else if (this.ScreenObject.DocumentType == 57) {
                let field1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcccnid52");
                if (field1 && this.ScreenObject.GridDataColumns.Contains(field1.DisplayMember + "_key")) {
                    iLoanType = parseInt(drGrid[field1.DisplayMember + "_Key"]);
                }
            }

            let dtEAL: any = BaseService.common.GetDataSet3("DOC008", iEmpSeqNo.toString(), iLoanType.toString());
            if (dtEAL != null && dtEAL.Tables[0].length > 0) {
                if (SrcCol.DrRefColID == -3001)
                    outObj.DBAcc = parseInt(dtEAL.Tables[0][0]["CreditAccountID"]);
                else
                    outObj.DBAcc = parseInt(dtEAL.Tables[0][0]["DebitAccountID"]);
            }

            if (outObj.DBAcc == 0) {
                if (SrcCol.DrRefColID == -3001)
                    this.DisplayMessage = "Credit Account not defined for this Loan Type in Employee Master";
                else
                    this.DisplayMessage = "Debit Account not defined for this Loan Type in Employee Master";

                return false;
            }
        }
        else if (SrcCol.DrRefColID != 0 && SrcCol.DrRefColID != -3003 && SrcCol.DrRefColID != -3004) {
            if (SrcCol.DrRefColID == SrcCol.DrRefID) {
                if (this.ScreenObject.GridDataColumns.Contains(SrcCol.DrRefColName + "_Key")) {
                    var drcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == SrcCol.DrRefColName);

                    if (drcol != null && drcol.CostCenterID == 2 && !Util.IsEmpty(drGrid[SrcCol.DrRefColName + "_Key"]))
                        outObj.DBAcc = parseInt(drGrid[SrcCol.DrRefColName + "_Key"].toString());
                    else {
                        if (drcol != null && drcol.CostCenterID != 2)
                            this.DisplayMessage = "Define  " + drcol.Header + " as account";
                        else {
                            this.DisplayMessage = "Select ";
                            if (drcol != null)
                                this.DisplayMessage += drcol.Header;
                            this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString();
                        }
                        this.MessageVisibility = true;
                        return false;
                    }
                }
                else {
                    let field: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == SrcCol.DrRefColName.toLowerCase());
                    if (field != null && field instanceof PactListBoxData) {
                        if (field.CCID == 2 && field.SelectedValue > 0)
                            outObj.DBAcc = field.SelectedValue;
                        else {
                            this.DisplayMessage = "Select " + field.Label;
                            this.MessageVisibility = true;
                            return false;
                        }
                        if (outObj.DBAcc == 0) {
                            this.DisplayMessage = "Accounts Not defined for " + field.Label + ":" + field.Text;
                            this.MessageVisibility = true;
                            return false;
                        }
                    }
                }
            }
            else if (SrcCol.DrRefColName && SrcCol.DrRefSection == 3
                && (this.ScreenObject.GridDataColumns.Contains(SrcCol.DrRefColName + "_Key") || (this.ScreenObject.GridDataColumns.Contains(SrcCol.DrRefColName) && this.ScreenObject.GridDataColumns.Contains("CCQuery")))) {
                if (this.ScreenObject.GridDataColumns.Contains("CCQuery")) {
                    if (!Util.IsEmpty(drGrid[SrcCol.DrRefColName]))
                        outObj.DBAcc = this.ScreenObject.GetAccountByRef(SrcCol.DrRefID, SrcCol.DrRefColID, parseInt(drGrid[SrcCol.DrRefColName]));
                    else {
                        let drcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == SrcCol.DrRefColName);
                        this.DisplayMessage = "Select ";
                        if (drcol)
                            this.DisplayMessage += drcol.Header;
                        this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString() + " for kit.";

                        return false;
                    }
                }
                else if (!Util.IsEmpty(drGrid[SrcCol.DrRefColName + "_Key"]))
                    outObj.DBAcc = this.ScreenObject.GetAccountByRef(SrcCol.DrRefID, SrcCol.DrRefColID, parseInt(drGrid[SrcCol.DrRefColName + "_Key"]));
                else {
                    let drcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == SrcCol.DrRefColName);
                    this.DisplayMessage = "Select ";
                    if (drcol)
                        this.DisplayMessage += drcol.Header;
                    this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString();

                    return false;
                }

                if (outObj.DBAcc == 0) {
                    let drcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == SrcCol.DrRefColName.toLowerCase() + "_key");
                    this.DisplayMessage = "Accounts Not defined for ";
                    if (drcol) {
                        this.DisplayMessage += drcol.Header;
                        if (this.ScreenObject.GridDataColumns.Contains(drcol.DisplayMember))
                            this.DisplayMessage += " :" + drGrid[drcol.DisplayMember].toString();
                    }
                    this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString();

                    return false;
                }
            }
            else if (SrcCol.DrRefSection == 1 || SrcCol.DrRefSection == 2) {
                if (SrcCol.DrRefColName.toLowerCase() == "debitaccount" && this.ScreenObject.DebitAccount != null)
                    outObj.DBAcc = this.ScreenObject.GetAccountByRef(SrcCol.DrRefID, SrcCol.DrRefColID, this.ScreenObject.DebitAccount.SelectedValue);
                else if (SrcCol.DrRefColName.toLowerCase() == "creditaccount" && this.ScreenObject.CreditAccount != null)
                    outObj.DBAcc = this.ScreenObject.GetAccountByRef(SrcCol.DrRefID, SrcCol.DrRefColID, this.ScreenObject.CreditAccount.SelectedValue);
                else {
                    let field = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == SrcCol.DrRefColName.toLowerCase());
                    if (field && field instanceof PactListBoxData) {
                        if (field.SelectedValue > 0)
                            outObj.DBAcc = this.ScreenObject.GetAccountByRef(SrcCol.DrRefID, SrcCol.DrRefColID, field.SelectedValue);

                        else {
                            this.DisplayMessage = "Select " + field.Label;

                            return false;
                        }
                        if (outObj.DBAcc == 0) {
                            this.DisplayMessage = "Accounts Not defined for " + field.Label + ":" + field.Text;

                            return false;
                        }
                    }
                }
                if (outObj.DBAcc == 0) {
                    if (SrcCol.DrRefColName.toLowerCase() == "debitaccount" && this.ScreenObject.DebitAccount != null)
                        this.DisplayMessage = "Accounts Not defined for " + this.ScreenObject.DebitAccount.Label + ":" + this.ScreenObject.DebitAccount.Text;
                    else if (SrcCol.DrRefColName.toLowerCase() == "creditaccount" && this.ScreenObject.CreditAccount != null)
                        this.DisplayMessage = "Accounts Not defined for " + this.ScreenObject.CreditAccount.Label + ":" + this.ScreenObject.CreditAccount.Text;

                    return false;
                }
            }
        }
        else if (SrcCol.DebitAccount > 0)
            outObj.DBAcc = SrcCol.DebitAccount;
        else {
            if (IsNeg && SrcCol.GridViewID == 1)
                outObj.DBAcc = this.PickDbCr(drGrid, ReserveAccount, true);
            else
                outObj.DBAcc = this.PickDbCr(drGrid, ReserveAccount, false);
            if (outObj.DBAcc == 0) {
                this.DisplayMessage = "Select  DebitAccount";

                return false;
            }
        }


        if (SrcCol.CrRefColID == -98 || SrcCol.CrRefColID == -99) {
            let From = 0, To = 0;
            let SysColName = "";
            if (BaseService.SessionManager.Preferences.ContainsKey("CrossDimension") && BaseService.SessionManager.Preferences["CrossDimension"].toString() != "")
                SysColName = "dcCCNID" + (parseInt(BaseService.SessionManager.Preferences["CrossDimension"]) - 50000);

            if (this.ScreenObject.GridDataColumns.Contains(SysColName + "_Key")) {
                if (!Util.IsEmpty(drGrid[SysColName + "_Key"]))
                    From = parseInt(drGrid[SysColName + "_Key"]);
                else {
                    let drcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == SysColName.toLowerCase());
                    this.DisplayMessage = "Select ";
                    if (drcol)
                        this.DisplayMessage += drcol.Header;
                    this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString();
                    return false;
                }
            }
            else {
                let field = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == SysColName.toLowerCase());
                if (field && field instanceof PactListBoxData) {
                    if (field.SelectedValue > 0)
                        From = field.SelectedValue;
                    else {
                        this.DisplayMessage = "Select " + field.Label;
                        return false;
                    }
                }
                else {
                    this.DisplayMessage = "Define Cross Dimension field to use Cross Dimension Debit or Credit.";
                    return false;
                }
            }
            if (this.DocumentType == 5)
                SysColName = "to" + SysColName;
            else {
                let tempint = Util.Int(this.ScreenObject.Preferences["CrossDimField"]);
                if (this.ScreenObject.Preferences.ContainsKey("CrossDimField")) {
                    let drcd = this.ScreenObject.Data.Tables[0].filter(x => x.CostCenterColID == tempint);
                    if (drcd.length > 0)
                        SysColName = Util.String(drcd[0]["SysColumnName"]);
                    else {
                        this.DisplayMessage = "Define To Cross Dimension field to use Cross Dimension Debit or Credit.";
                        this.MessageVisibility = true;
                        return false;
                    }
                }
                else {
                    this.DisplayMessage = "Define To Cross Dimension field to use Cross Dimension Debit or Credit.";
                    this.MessageVisibility = true;
                    return false;
                }
            }
            if (this.ScreenObject.GridDataColumns.Contains(SysColName + "_Key")) {
                if (!Util.IsEmpty(drGrid[SysColName + "_Key"]))
                    To = parseInt(drGrid[SysColName + "_Key"]);
                else {
                    let drcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == SysColName.toLowerCase());
                    this.DisplayMessage = "Select ";
                    if (drcol)
                        this.DisplayMessage += drcol.Header;
                    this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString();
                    return false;
                }
            }
            else {
                let field = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == SysColName.toLowerCase());
                if (field == null)
                    field = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == SysColName.toLowerCase());

                if (field && field instanceof PactListBoxData) {
                    if (field.SelectedValue > 0)
                        To = field.SelectedValue;
                    else {
                        this.DisplayMessage = "Select " + field.Label;
                        return false;
                    }
                }
                else {
                    this.DisplayMessage = "Define Cross Dimension field to use Cross Dimension Debit or Credit.";
                    return false;
                }
            }

            if (From == To)
                outObj.CrACC = this.PickDbCr(drGrid, ReserveAccount, true);
            else
                outObj.CrACC = this.ScreenObject.GetAccountByRef(SrcCol.CrRefColID, From, To);

            if (outObj.CrACC == 0) {
                this.DisplayMessage = "Cross dimension Accounts Not defined";
                return false;
            }
        }
        else if ((this.ScreenObject.DocumentType == 56 || this.ScreenObject.DocumentType == 57) && (SrcCol.CrRefColID == -3001 || SrcCol.CrRefColID == -3002))  // ApplyLoan/LoanRepayment -> EMP_Loan_CrAccount & EMP_Loan_DrAccount
        {
            let iEmpSeqNo = 0, iLoanType = 0;
            let field = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (field && field instanceof PactListBoxData) {
                if (field.SelectedValue > 0)
                    iEmpSeqNo = field.SelectedValue;
            }
            else if (field && field instanceof PactCodeNameListBoxData) {
                if (field.SelectedValue > 0)
                    iEmpSeqNo = field.SelectedValue;
            }

            if (this.ScreenObject.DocumentType == 56) {
                field = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
                if (field && field instanceof PactListBoxData) {
                    if (field.SelectedValue > 0)
                        iLoanType = field.SelectedValue;
                }
            }
            else if (this.ScreenObject.DocumentType == 57) {
                let field1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcccnid52");
                if (field1 && this.ScreenObject.GridDataColumns.Contains(field1.DisplayMember + "_key")) {
                    iLoanType = parseInt(drGrid[field1.DisplayMember + "_Key"]);
                }
            }

            let dtEAL: any = BaseService.common.GetDataSet3("DOC008", iEmpSeqNo.toString(), iLoanType.toString());
            if (dtEAL && dtEAL.Tables[0].length > 0) {
                if (SrcCol.CrRefColID == -3001)
                    outObj.CrACC = parseInt(dtEAL.Tables[0][0]["CreditAccountID"]);
                else
                    outObj.CrACC = parseInt(dtEAL.Tables[0][0]["DebitAccountID"]);
            }

            if (outObj.CrACC == 0) {
                if (SrcCol.DrRefColID == -3001)
                    this.DisplayMessage = "Credit Account not defined for this Loan Type in Employee Master";
                else
                    this.DisplayMessage = "Debit Account not defined for this Loan Type in Employee Master";
                return false;
            }
        }
        else if (SrcCol.CrRefColID != 0 && SrcCol.CrRefColID != -3003 && SrcCol.CrRefColID != -3004) {
            if (SrcCol.CrRefID == SrcCol.CrRefColID) {
                if (drGrid.Table.Columns.Contains(SrcCol.CrRefColName + "_Key")) {
                    var drcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == SrcCol.CrRefColName);

                    if (drcol != null && drcol.CostCenterID == 2 && !Util.IsEmpty(drGrid[SrcCol.CrRefColName + "_Key"]))
                        outObj.CrACC = parseInt(drGrid[SrcCol.CrRefColName + "_Key"].toString());
                    else {
                        if (drcol != null && drcol.CostCenterID != 2)
                            this.DisplayMessage = "Define  " + drcol.Header + " as account";
                        else {
                            this.DisplayMessage = "Select ";
                            if (drcol != null)
                                this.DisplayMessage += drcol.Header;
                            this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString();
                        }
                        this.MessageVisibility = true;
                        return false;
                    }
                }
                else {
                    var field: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == SrcCol.CrRefColName.toLowerCase());
                    if (field != null && field instanceof PactListBoxData) {
                        if (field.CCID == 2 && field.SelectedValue > 0)
                            outObj.CrACC = field.SelectedValue;
                        else {
                            this.DisplayMessage = "Select " + field.Label;
                            this.MessageVisibility = true;
                            return false;
                        }
                        if (outObj.CrACC == 0) {
                            this.DisplayMessage = "Accounts Not defined for " + field.Label + ":" + field.Text;
                            this.MessageVisibility = true;
                            return false;
                        }
                    }
                }
            }
            else if (SrcCol.CrRefColName != "" && SrcCol.CrRefSection == 3
                && this.ScreenObject.GridDataColumns.Contains(SrcCol.CrRefColName + "_Key") || (this.ScreenObject.GridDataColumns.Contains("CCQuery") && this.ScreenObject.GridDataColumns.Contains(SrcCol.CrRefColName))) {
                if (this.ScreenObject.GridDataColumns.Contains("CCQuery")) {
                    if (!Util.IsEmpty(drGrid[SrcCol.CrRefColName]))
                        outObj.CrACC = this.ScreenObject.GetAccountByRef(SrcCol.CrRefID, SrcCol.CrRefColID, parseInt(drGrid[SrcCol.CrRefColName]));
                    else {
                        let drcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == SrcCol.CrRefColName);
                        this.DisplayMessage = "Select ";
                        if (drcol)
                            this.DisplayMessage += drcol.Header;
                        this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString() + " int kit.";

                        return false;
                    }
                }
                else if (!Util.IsEmpty(drGrid[SrcCol.CrRefColName + "_Key"]))
                    outObj.CrACC = this.ScreenObject.GetAccountByRef(SrcCol.CrRefID, SrcCol.CrRefColID, parseInt(drGrid[SrcCol.CrRefColName + "_Key"]));
                else {
                    let drcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == SrcCol.CrRefColName);
                    this.DisplayMessage = "Select ";
                    if (drcol)
                        this.DisplayMessage += drcol.Header;
                    this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString();

                    return false;
                }

                if (outObj.CrACC == 0) {
                    let drcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == SrcCol.CrRefColName.toLowerCase() + "_key");
                    this.DisplayMessage = "Accounts Not defined for ";
                    if (drcol) {
                        this.DisplayMessage += drcol.Header;
                        if (this.ScreenObject.GridDataColumns.Contains(drcol.DisplayMember))
                            this.DisplayMessage += " :" + drGrid[drcol.DisplayMember].toString();
                    }
                    this.DisplayMessage += " at row:" + drGrid["DocSeqNo"].toString();
                    return false;
                }
            }
            else if (SrcCol.CrRefSection == 1 || SrcCol.CrRefSection == 2) {
                if (SrcCol.CrRefColName.toLowerCase() == "debitaccount" && this.ScreenObject.DebitAccount != null)
                    outObj.CrACC = this.ScreenObject.GetAccountByRef(SrcCol.CrRefID, SrcCol.CrRefColID, this.ScreenObject.DebitAccount.SelectedValue);
                else if (SrcCol.CrRefColName.toLowerCase() == "creditaccount" && this.ScreenObject.CreditAccount != null)
                    outObj.CrACC = this.ScreenObject.GetAccountByRef(SrcCol.CrRefID, SrcCol.CrRefColID, this.ScreenObject.CreditAccount.SelectedValue);
                else {
                    let field = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == SrcCol.CrRefColName.toLowerCase());
                    if (field && field instanceof PactListBoxData) {
                        if (field.SelectedValue > 0)
                            outObj.CrACC = this.ScreenObject.GetAccountByRef(SrcCol.CrRefID, SrcCol.CrRefColID, field.SelectedValue);
                        else {
                            this.DisplayMessage = "Select " + field.Label;
                            return false;
                        }
                        if (outObj.CrACC == 0) {
                            this.DisplayMessage = "Accounts Not defined for " + field.Label + ":" + field.Text;
                            return false;
                        }
                    }
                }
                if (outObj.CrACC == 0) {
                    if (SrcCol.CrRefColName.toLowerCase() == "debitaccount" && this.ScreenObject.DebitAccount != null)
                        this.DisplayMessage = "Accounts Not defined for " + this.ScreenObject.DebitAccount.Label + ":" + this.ScreenObject.DebitAccount.Text;
                    else if (SrcCol.CrRefColName.toLowerCase() == "creditaccount" && this.ScreenObject.CreditAccount != null)
                        this.DisplayMessage = "Accounts Not defined for " + this.ScreenObject.CreditAccount.Label + ":" + this.ScreenObject.CreditAccount.Text;
                    return false;
                }
            }
        }
        else if (SrcCol.CreditAcount > 0)
            outObj.CrACC = SrcCol.CreditAcount;
        else {
            if (IsNeg && SrcCol.GridViewID == 1)
                outObj.CrACC = this.PickDbCr(drGrid, ReserveAccount, false);
            else
                outObj.CrACC = this.PickDbCr(drGrid, ReserveAccount, true);
            if (outObj.CrACC == 0) {
                this.DisplayMessage = "Select  CreditAcount";
                return false;
            }
        }

        if (outObj.DBAcc <= 0 && outObj.CrACC <= 0 && (this.ScreenObject.DocumentType == 16 || this.ScreenObject.DocumentType == 17 || this.ScreenObject.DocumentType == 28 || this.ScreenObject.DocumentType == 29))
            return true;
        if (this.ScreenObject.DocumentType == 30 && this.ScreenObject.GridDataColumns.Contains("VoucherType") && drGrid["VoucherType"].toString() == "1") {
            let tempacc = outObj.DBAcc;
            outObj.DBAcc = outObj.CrACC;
            outObj.CrACC = tempacc;
        }
        sbAccounts += this.ScreenObject.GetAccountTransaction(outObj.DBAcc.toString(), outObj.CrACC.toString(), PostingValue, CurrID, ExhgRate, (SrcCol.NoRoundOff) ? "6" : SrcCol.DecimalPoints);

        let fld = this.ScreenObject._StaticFields.find(a => a.DBColumnName.toLowerCase() == "commonnarration");
        if (fld) {
            if (fld instanceof PactTextBoxData && !Util.IsEmpty(fld.Text))
                sbAccounts += " CommonNarration=\"" + PactTextBoxData.GetValidXml(fld.Text) + "\" ";
            else if (fld instanceof PactTextAreaData && !Util.IsEmpty(fld.Text))
                sbAccounts += " CommonNarration=\"" + PactTextBoxData.GetValidXml(fld.Text) + "\" ";
        }

        sbAccounts += " DocSeqNo=\"" + RowCount + "\" ";


        if (!Util.IsEmpty(drGrid["LineNarration"]))
            sbAccounts += " LineNarration=\"" + PactTextBoxData.GetValidXml(drGrid["LineNarration"]) + "\" ";


        let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 50403);
        if (dvCnt.length > 0 && dvCnt[0]["CostCenterColID"].toString() == SrcCol.ID)
            sbAccounts += " IsExchangeGL=\"1\" ";

        if (this.ScreenObject.Preferences.ContainsKey("UseasCrossDimension") && this.ScreenObject.Preferences["UseasCrossDimension"].toLowerCase() == "true" && (SrcCol.Dependancy == 2 || SrcCol.Dependancy == 3))
            sbAccounts += " FromTo=\"" + SrcCol.Dependancy + "\" ";
        sbAccounts += " ></Accounts>";
        outObj.PostingXml = sbAccounts.toString();
        return true;
    }
    EnableCrossDimPostingXML = false;
    PostCrossDimDOc() {
        let retobj: any = { crxml: "0", ret: true };
        if (this.ScreenObject.Preferences.ContainsKey("CrossDimDocument") && this.ScreenObject.Preferences["CrossDimDocument"] != "" && parseInt(this.ScreenObject.Preferences["CrossDimDocument"]) > 0) {
            let crossDim, tempint;
            let tempdbl;
            let Fromid: number = 0, toid: number = 0;

            if (BaseService.SessionManager.Preferences.ContainsKey("CrossDimension") && BaseService.SessionManager.Preferences["CrossDimension"].toString() != ""
                && Util.DoubleTryParse(BaseService.SessionManager.Preferences["CrossDimension"].toString())) {
                crossDim = parseInt(BaseService.SessionManager.Preferences["CrossDimension"].toString());

                var vFldFrom = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.CostCenterID == crossDim && a.ValueMember.toLowerCase().Contains("dcccnid"));

                var ccfld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == crossDim);
                if (ccfld != null && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0)
                    Fromid = ccfld.SelectedValue;

                if (this.ScreenObject.Preferences.ContainsKey("CrossDimField") && Util.IntTryParse(this.ScreenObject.Preferences["CrossDimField"]) > 0) {
                    tempint = Util.IntTryParse(this.ScreenObject.Preferences["CrossDimField"])

                    var vFldTo = this.ScreenObject.ColumnSource.find(a => a.ID == tempint.ToString());

                    ccfld = this.ScreenObject._TextFields.find(a => a.DBColumnID == tempint);
                    if (ccfld != null && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0)
                        toid = ccfld.SelectedValue;

                    let cddataSet: any = []
                    let sbxml = '';
                    /*** let sb = "";
 
                     if (vFldFrom != null || vFldTo != null)
                     {
                         sbxml+="<Locations>";
                         for(let i = 0; i < this.ScreenObject.GridData.length; i++)
                         {
                             if (this.ScreenObject.GridData[i]["ProductID_Key"] != null && this.ScreenObject.GridData[i]["ProductID_Key"].toString() != "")
                             {
                                 sbxml+="<Loc ";
 
                                 if (vFldFrom == null)
                                     sbxml+=" From=\""+Fromid+"\" ";
                                 else if (vFldFrom != null && this.ScreenObject.GridData[i][vFldFrom.ValueMember] != null && this.ScreenObject.GridData[i][vFldFrom.ValueMember].toString() != "")
                                     sbxml+=" From=\""+this.ScreenObject.GridData[i][vFldFrom.ValueMember].toString()+"\" ";
                                 else
                                 {
                                     this.DisplayMessage = "Please Select " + vFldFrom.DisplayMember + " at Row No " + i + " ";
                                     this.MessageVisibility = true;
                                     retobj.ret = false;
                                     return retobj;
                                 }
 
                                 if (vFldTo == null)
                                     sbxml+=" To=\""+toid+"\" ";
                                 else if (vFldTo != null && this.ScreenObject.GridData[i][vFldTo.ValueMember] != null && this.ScreenObject.GridData[i][vFldTo.ValueMember].toString() != "")
                                     sbxml+=" To=\""+this.ScreenObject.GridData[i][vFldTo.ValueMember].toString()+"\" ";
                                 else
                                 {
                                     this.DisplayMessage = "Please Select " + vFldTo.DisplayMember + " at Row No " + i + " ";
                                     this.MessageVisibility = true;
                                     retobj.ret = false;
                                     return retobj;
                                 }
                                 sbxml+="></Loc>";
                             }
                         }
                         sbxml+="</Locations>";
                         cddataSet = this.ScreenObject.GetCrossDimLinkDetails(Fromid, toid, this.CostCenterID, parseInt(this.ScreenObject.Preferences["CrossDimDocument"]), this.ScreenObject.DocID, sbxml.toString());
                     }
                     else
                     {
                         sbxml = '';
                         cddataSet = this.ScreenObject.GetCrossDimLinkDetails(Fromid, toid, this.CostCenterID, parseInt(this.ScreenObject.Preferences["CrossDimDocument"]), this.ScreenObject.DocID, sbxml.toString());
                     }
 ***/
                    let sb = "";

                    if (vFldFrom != null || vFldTo != null) {
                        sbxml += "<Locations>";
                        let sblocxml = "";
                        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                            if (this.ScreenObject.GridData[i]["ProductID_Key"] != null && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                                let fid = 0, tid = 0;

                                if (vFldFrom == null)
                                    fid = Fromid;
                                else if (vFldFrom != null && this.ScreenObject.GridData[i][vFldFrom.ValueMember] != null && !Util.IsEmpty(this.ScreenObject.GridData[i][vFldFrom.ValueMember]))
                                    fid = parseInt(this.ScreenObject.GridData[i][vFldFrom.ValueMember].toString());
                                else {
                                    this.DisplayMessage = "Please Select From " + vFldFrom.Header + " at Row No " + this.ScreenObject.GridData[i]["DocSeqNo"].toString() + " ";
                                    this.MessageVisibility = true;
                                    retobj.ret = false;
                                    return retobj;
                                }
                                if (vFldTo == null)
                                    tid = toid;
                                else if (vFldTo != null && this.ScreenObject.GridData[i][vFldTo.ValueMember] != null && !Util.IsEmpty(this.ScreenObject.GridData[i][vFldTo.ValueMember]))
                                    tid = parseInt(this.ScreenObject.GridData[i][vFldTo.ValueMember].toString());
                                else {
                                    this.DisplayMessage = "Please Select For " + vFldTo.Header + " at Row No " + this.ScreenObject.GridData[i]["DocSeqNo"].toString() + " ";
                                    this.MessageVisibility = true;
                                    retobj.ret = false;
                                    return retobj;
                                }
                                if (fid == tid)
                                    continue;
                                sblocxml += "<Loc  From=\"" + fid + "\"  To=\"" + tid + "\"></Loc>";
                            }
                        }
                        if (sblocxml == "") {
                            retobj.ret = true;
                            return "";
                        }
                        else
                            sbxml += sblocxml;
                        sbxml += "</Locations>";
                        cddataSet = this.ScreenObject.GetCrossDimLinkDetails(Fromid, toid, this.CostCenterID, parseInt(this.ScreenObject.Preferences["CrossDimDocument"]), this.ScreenObject.DocID, sbxml.toString());
                    }
                    else {
                        if (Fromid == toid) {
                            retobj.ret = true;
                            return "";
                        }
                        sbxml = '';
                        cddataSet = this.ScreenObject.GetCrossDimLinkDetails(Fromid, toid, this.CostCenterID, parseInt(this.ScreenObject.Preferences["CrossDimDocument"]), this.ScreenObject.DocID, sbxml.toString());
                    }

                    if (cddataSet.Tables[0].length == 0) {
                        this.DisplayMessage = "Map Accounts for Cross Dimension";
                        this.MessageVisibility = true;
                        retobj.ret = false;
                        return retobj;
                    }
                    cddataSet.Tables[0].forEach(cdds => {
                        let CDDoc = new AddEditDocumentViewModel(parseInt(this.ScreenObject.Preferences["CrossDimDocument"]), "", true);

                        // CDDoc = new AddEditDocumentViewModel(parseInt(ScreenObject.Preferences["CrossDimDocument"]), "", true);
                        CDDoc.OKCancelVisibility = CDDoc.EnableCrossDimPostingXML = true;

                        CDDoc.ScreenObject.DimensionFor = parseInt(cdds["DimFor"].toString());

                        if (!Util.IsEmpty(cdds["docid"])) {
                            if ((vFldTo != null) && this.ScreenObject.GridData.filter(x => x[vFldTo.ValueMember] == cdds["DimFor"]).length == 0) {
                                sb += "<CrossDimXML DocID=\"" + cdds["docid"].toString() + "\"  IsDelete =\"1\"></CrossDimXML>";
                                return;
                            }

                            CDDoc.ScreenObject.DocID = parseInt(cdds["docid"].toString());
                            let dsdata = CDDoc.ScreenObject.GetEditDataByDOCID();
                            if (dsdata != null && dsdata.Tables.length > 0 && dsdata.Tables[0].length > 0) {
                                CDDoc.ScreenObject.LoadEditData(dsdata, false);
                                CDDoc.ScreenObject.VoucherNo = dsdata.Tables[0][0]["VoucherNo"].toString();
                            }
                        }
                        let CCDim = 0;
                        ccfld = CDDoc.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == crossDim);
                        if (ccfld != null && ccfld instanceof PactListBoxData && Util.DoubleTryParse(cdds["DimFor"].toString()) > 0) {
                            CCDim = parseInt(cdds["DimFor"].toString())
                            ccfld.SelectedValue = parseInt(cdds["DimFor"].toString());
                        }
                        this.LoadLinkFieldsData(cddataSet.Tables[1], CDDoc.ScreenObject._StaticFields);
                        this.LoadLinkFieldsData(cddataSet.Tables[1], CDDoc.ScreenObject._TextFields);
                        this.LoadLinkFieldsData(cddataSet.Tables[1], CDDoc.ScreenObject._numericFields);
                        this.LoadLinkFieldsData(cddataSet.Tables[1], CDDoc.ScreenObject._CCFields);

                        if (cdds != null) {
                            if (CDDoc.ScreenObject.CreditAccount != null && !Util.IsEmpty(cdds["CrAccount"]))
                                CDDoc.ScreenObject.CreditAccount.SelectedValue = parseInt(cdds["CrAccount"].toString());
                            if (CDDoc.ScreenObject.DebitAccount != null && !Util.IsEmpty(cdds["DrAccount"]))
                                CDDoc.ScreenObject.DebitAccount.SelectedValue = parseInt(cdds["DrAccount"].toString());
                        }
                        if (CDDoc.ScreenObject.DocID > 0) {
                            if (!CDDoc.ScreenObject.GridDataColumns.Contains("IsChecked"))
                                CDDoc.ScreenObject.GridDataColumns.push("IsChecked");
                            for (let i = 0; i < CDDoc.ScreenObject.GridData.length; i++) {
                                CDDoc.ScreenObject.GridData[i]["IsChecked"] = 0;
                            }

                        }
                        let drrgrid = null;

                        if (vFldFrom != null || vFldTo != null) {
                            if (vFldTo != null)
                                drrgrid = this.ScreenObject.GridData.filter(x => x[vFldTo.ValueMember] == cdds["DimFor"]);
                        }
                        else
                            drrgrid = this.ScreenObject.GridData;

                        drrgrid.forEach(dr => {
                            let drr = null;
                            if (CDDoc.ScreenObject.DocID > 0 && !Util.IsEmpty(dr["DocDetailsID"])) {
                                var linkedrows = CDDoc.ScreenObject.GridData.filter(x => x["LinkedInvDocDetailsID"] == Util.String(dr["DocDetailsID"]));
                                if (linkedrows.length > 0)
                                    drr = linkedrows[0];
                            }
                            if (drr == null)
                                drr = CDDoc.ScreenObject.GridData[this.GetEmptyRowPosition(CDDoc.ScreenObject.GridDataObj, "ProductID_Key")];
                            drr["DocSeqNo"] = dr["DocSeqNo"].toString();
                            drr["DocOrder"] = dr["DocSeqNo"].toString();
                            if (cdds != null) {
                                if (CDDoc.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(cdds["CrAccount"]))
                                    drr["CreditAccount_Key"] = parseInt(cdds["CrAccount"].toString());
                                if (CDDoc.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(cdds["DrAccount"]))
                                    drr["DebitAccount_Key"] = parseInt(cdds["DrAccount"].toString());
                            }

                            if (CDDoc.ScreenObject.GridDataColumns.Contains("IsChecked"))
                                drr["IsChecked"] = 1;
                            for (let j = 0; j < CDDoc.ScreenObject.ColumnSource.length; j++) {
                                if (CDDoc.ScreenObject.ColumnSource[j].DisplayMember == "DocDetailsID" || CDDoc.ScreenObject.ColumnSource[j].DisplayMember == "RefNo" || CDDoc.ScreenObject.ColumnSource[j].DisplayMember == "LinkedFieldName")
                                    continue;
                                else if (CDDoc.ScreenObject.ColumnSource[j].DataType == "LINK" && CDDoc.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcalpha"))
                                    drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember] = "...";

                                let drrrows = null;
                                if (CDDoc.ScreenObject.ColumnSource[j].CostCenterID == 3 && !CDDoc.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("alpha")) {
                                    drrrows = cddataSet.Tables[1].filter(x => x["BASECOL"] == 'ProductID');
                                }
                                else if (CDDoc.ScreenObject.ColumnSource[j].CostCenterID > 0 && CDDoc.ScreenObject.ColumnSource[j].ValueMember != null) {
                                    drrrows = cddataSet.Tables[1].filter(x => x["BASECOL"] == CDDoc.ScreenObject.ColumnSource[j].ValueMember.Replace("_Key", ""));
                                }
                                else if (CDDoc.ScreenObject.ColumnSource[j].DataType == "ComboBox" || CDDoc.ScreenObject.ColumnSource[j].DataType == "PactComboBox") {
                                    drrrows = cddataSet.Tables[1].filter(x => x["BASECOL"] == CDDoc.ScreenObject.ColumnSource[j].ValueBinding);
                                }
                                else {
                                    drrrows = cddataSet.Tables[1].filter(x => x["BASECOL"] == CDDoc.ScreenObject.ColumnSource[j].DisplayMember);
                                }
                                if (drrrows.length > 0) {
                                    let Resvalue = this.ScreenObject.GetValueBYCOLID(drrrows[0]["CostCenterColIDLinked"].toString(), dr);
                                    if (Resvalue == '')
                                        continue;
                                    if (CDDoc.ScreenObject.ColumnSource[j].CostCenterID != 0) {
                                        if (CDDoc.ScreenObject.ColumnSource[j].DataType == "SELECTIONBOX") {
                                            drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember] = Resvalue;
                                        }
                                        else {
                                            let TempId = 0;
                                            if (Util.IntTryParse(Resvalue) > 0) {
                                                TempId = Util.IntTryParse(Resvalue);
                                                drr[CDDoc.ScreenObject.ColumnSource[j].ValueMember] = Resvalue;
                                                if (!Util.IsEmpty(drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember]))
                                                    drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember] = null;
                                            }
                                        }
                                    }
                                    else {
                                        if (CDDoc.ScreenObject.ColumnSource[j].DataType == "ComboBox") {
                                            drr[CDDoc.ScreenObject.ColumnSource[j].ValueBinding] = Resvalue;
                                        }
                                        else if (CDDoc.ScreenObject.ColumnSource[j].DataType == "PactComboBox") {
                                            drr[CDDoc.ScreenObject.ColumnSource[j].ValueBinding] = Resvalue;
                                            drr[CDDoc.ScreenObject.ColumnSource[j].ValueBinding + "_Key"] = Resvalue;
                                        }
                                        else if (CDDoc.ScreenObject.ColumnSource[j].DataType == "DATE") {
                                            let dtValue: Date = new Date();
                                            if (Util.isValidDate(Resvalue)) {
                                                dtValue = Util.ParseDate(Resvalue);
                                                drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember] = new Date(Resvalue).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember + "_Key"] = new Date(dtValue);
                                            }
                                        }
                                        else if (CDDoc.ScreenObject.ColumnSource[j].DataType == "DATETIME" || CDDoc.ScreenObject.ColumnSource[j].DataType == "TIME") {
                                            let dtValue: Date = new Date();
                                            if (Util.isValidDate(Resvalue)) {
                                                dtValue = Util.ParseDate(Resvalue);
                                                drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember + "_Key"] = new Date(Resvalue);
                                                drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember] = new Date(Resvalue).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                                            }
                                        }
                                        else if (CDDoc.ScreenObject.ColumnSource[j].DataType.toUpperCase() == "TIME2") {
                                            let dtValue: Date = new Date();
                                            if (Util.isValidDate(Resvalue)) {
                                                dtValue = Util.ParseDate(Resvalue);
                                                drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember + "_Key"] = new Date(Resvalue);
                                                drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember] = new Date(Resvalue).ToString("HH:mm");
                                            }
                                        }
                                        else if (CDDoc.ScreenObject.ColumnSource[j].DataType.toLowerCase() == "double") {
                                            if (Util.DoubleTryParse(Resvalue) > 0) {
                                                tempdbl = Util.DoubleTryParse(Resvalue)
                                                drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember] = tempdbl;
                                            }
                                        }
                                        else
                                            drr[CDDoc.ScreenObject.ColumnSource[j].DisplayMember] = Resvalue;
                                    }
                                }
                            }
                            drr["Type"] = Util.StringValue(dr["Type"]);
                            if (Util.StringValue(drr["Type"]) == "5" && !Util.IsEmpty(dr["Extraxml"])) {
                                let xDoc: any = new XmlDocument();
                                xDoc.LoadXml(dr["Extraxml"].toString());
                                var att = xDoc.FirstChild.FirstChild.attributes["RefInvID"];
                                if (att != null)
                                    xDoc.FirstChild.FirstChild.Attributes.Remove(att);

                                att = xDoc.FirstChild.FirstChild.attributes["Release"];

                                if (att != null)
                                    att.value = xDoc.FirstChild.FirstChild.attributes["Quantity"].value;
                                else {
                                    att = xDoc.CreateAttribute("Release");
                                    att.value = xDoc.FirstChild.FirstChild.attributes["Quantity"].value;
                                    xDoc.FirstChild.FirstChild.Attributes += att;
                                }
                                drr["Extraxml"] = xDoc.OuterXml;
                            }

                            CDDoc.CalculateTotals(drr, false, "Quantity");
                        });
                        if (CDDoc.ScreenObject.DocID > 0 && CDDoc.ScreenObject.GridDataColumns.Contains("IsChecked")) {
                            for (let i = 0; i < CDDoc.ScreenObject.GridData.length; i++) {
                                if (Util.StringValue(CDDoc.ScreenObject.GridData[i]["IsChecked"]) == "0") {
                                    CDDoc.ScreenObject.GridDataObj.removeRowAt(i);
                                    i--;
                                }
                            }
                        }
                        CDDoc.parent = this;
                        CDDoc.IsAutoPost = true;
                        CDDoc.SaveInventoryDocument("Save", false);
                        if (!Util.IsEmpty(CDDoc.DisplayMessage)) {
                            this.DisplayMessage = " Cross Dimension: " + CDDoc.DisplayMessage;
                            this.MessageVisibility = true;
                            retobj.ret = false;
                            return retobj;
                        }

                        sb += this.AutoPOstXML.Replace("AutoPOstXML", "CrossDimXML");

                    });
                    retobj.ret = true;
                    retobj.crxml = sb;
                    return retobj;
                }
            }
        }
        retobj.ret = true;
        return retobj;
    }

    LoadLinkFieldsData(dt, lst: any[]) {
        if (dt != null) {
            lst.forEach((oControl: any) => {
                var dv = dt.filter(x => x["BASECOL"] == oControl.DBColumnName);
                if (dv.length > 0) {
                    let Val: string = this.ScreenObject.GetValueBYCOLID(dv[0]["CostCenterColIDLinked"].toString(), null);
                    this.ScreenObject.fillcontrolValue(oControl, Val);
                }
            });
        }
    }

    RetValue = 0;
    commandprarameter = "";
    InventorySave_DoWork(sender: any, args: string[]) {
        //sw.Start();
        //ProgressVisbility = true;
        //ProgressMax = 100;
        this.DisplayMessage = BaseService.GetResource("SavingDocumentPleasewait");
        console.log("InventorySave_DoWork In");
        //ProgressValue = 5;
        //System.Threading.Timer tt = new System.Threading.Timer(new System.Threading.TimerCallback(tick));
        //tt.Change(1000, 1000);
        if (args.length > 4) {
            this.RetValue = 0;
            let XML = "<XML   ";
            if (this.commandprarameter != null && this.commandprarameter == "SaveonHold")
                XML += " status=\"" + this.commandprarameter + "\"";

            else if (this.commandprarameter != null && this.commandprarameter == "Revise") {
                XML += " IsRevision=\"1\"";
                XML += " ReviseReason=\"" + this.ReviseReason + "\"";
            }
            else if (this.commandprarameter != null && (this.commandprarameter == "Approve" || this.commandprarameter == "ApproveandPrint")) {
                XML += " AppRejDate=\"" + this.AppRejDate.Date.ToString("dd/MMM/yyyy") + "\"";
                XML += " Remarks=\"" + PactTextBoxData.GetValidXml(this.Remarks.Text) + "\"";
                if (this.IsLocked && BaseService.SessionManager.Preferences.ContainsKey("PostLockedDocs") && parseBoolean(BaseService.SessionManager.Preferences["PostLockedDocs"]))
                    XML += " LockedPosting=\"1\"";
            }
            if (!this.IsLockDimsLineWise && this.LockDims != null) {
                let outObj = { join: "" };
                XML += " LockDims=\"" + this.GetLockQuery(null, outObj) + "\" ";
                if (outObj.join != "")
                    XML += " LockDimsjoin=\"" + outObj.join + "\" ";
            }

            if (this.GenratePrefix)
                XML += " GenratePrefix=\"1\" ";

            XML += this.attendancePunchInfo + " SysInfo=\"" + BaseService.SessionManager.GetSysInfo() + "\" AP=\"" + BaseService.SessionManager.GetAccessPoint() + "\" ";

            if (this.IsPOs && parseBoolean(args[11]))
                XML += " PosSessionID=\"" + this.PosSessionID + "\"";

            if (!this.savebulk && args.length > 10)
                XML += " CheckStock=\"" + args[10] + "\" ";


            if (!this.savebulk && args.length > 17)
                XML += args[17];
            if (!this.savebulk && args.length > 18)
                XML += args[18];
            if (!this.savebulk && args.length > 19)
                XML += args[19];

            if ((this.commandprarameter != null && (this.commandprarameter == "NoWorkFlow" || this.commandprarameter == "NoWorkFlowReSave" || this.commandprarameter == "NoWorkFlowprint"))
                || (this.ScreenObject.Preferences.ContainsKey("NoWorkflowPostedDocs") && this.ScreenObject.Preferences["NoWorkflowPostedDocs"] != "" && parseBoolean(this.ScreenObject.Preferences["NoWorkflowPostedDocs"])
                    && this.StatusID == 369))
                XML += " WorkFlow=\"NO\"";

            if (this.ScreenObject.IsDocEdit)
                XML += " Guid=\"" + Util.String(this.ScreenObject.guid) + "\"";

            if (this.LineWiseApproval)
                XML += " LineWiseApproval=\"1\"";

            XML += " CCGuid=\"" + Util.String(this.ScreenObject.CCguid) + "\"";
            let Schedrecurxml = ''
            //If it is recur document
            if (this.ScheduleID > 0) {
                if (this.ScreenObject.GridDataColumns.Contains("ScheduleID"))
               {
                   for(let k = 0; k < this.ScreenObject.GridData.length; k++)
                   {
                       if (this.ScreenObject.GridData[k]["ScheduleID"].toString() != "")
                           Schedrecurxml += "<Row ScheduleID=\"" + this.ScreenObject.GridData[k]["ScheduleID"].toString() + "\"  SchGUID=\"" + this.ScreenObject.GridData[k]["SchGUID"].toString() + "\" />";
                   }
               }
               else
                   XML += " ScheduleID=\"" + this.ScheduleID + "\"  SchGUID=\"" + this.SchGUID + "\" ";
            }
            if (!this.savebulk && args.length > 9 && parseBoolean(args[9]))
                XML += " SaveUnapproved=\"1\"";

            if (BaseService.SessionManager.AccountingFromMonth > BaseService.SessionManager.AccountingToMonth) {
                let Frmdate = "", Todate = "";
                if (this.DocumentDate.iMonth() >= BaseService.SessionManager.AccountingFromMonth)
                    Frmdate = "1/" + this.ScreenObject.GetMonthName(BaseService.SessionManager.AccountingFromMonth, false) + "/" + this.DocumentDate.getFullYear();
                else
                    Frmdate = "1/" + this.ScreenObject.GetMonthName(BaseService.SessionManager.AccountingFromMonth, false) + "/" + (this.DocumentDate.getFullYear() - 1).toString();

                if (this.DocumentDate.iMonth() < BaseService.SessionManager.AccountingFromMonth)
                    Todate = Util.DaysInMonth(this.DocumentDate.getFullYear(), BaseService.SessionManager.AccountingToMonth - 1) + "/" + this.ScreenObject.GetMonthName(BaseService.SessionManager.AccountingToMonth, false) + "/" + (this.DocumentDate.getFullYear());
                else
                    Todate = Util.DaysInMonth(this.DocumentDate.getFullYear() + 1, BaseService.SessionManager.AccountingToMonth - 1) + "/" + this.ScreenObject.GetMonthName(BaseService.SessionManager.AccountingToMonth, false) + "/" + (this.DocumentDate.getFullYear() + 1).toString();

                XML += " FinancialSartDate=\"" + Frmdate + "\"";
                XML += " FinancialEndDate=\"" + Todate + "\"";
            }
            else {
                XML += " FinancialSartDate=\"1/" + this.ScreenObject.GetMonthName(BaseService.SessionManager.AccountingFromMonth, false) + "/" + this.DocumentDate.getFullYear() + "\"";
                XML += " FinancialEndDate=\"" + Util.DaysInMonth(this.DocumentDate.getFullYear(), BaseService.SessionManager.AccountingToMonth - 1) + "/" + this.ScreenObject.GetMonthName(BaseService.SessionManager.AccountingToMonth, false) + "/" + this.DocumentDate.getFullYear() + "\"";
            }

            if (args[3].length > 1)
                XML += " DetailIds=\"" + args[3].substr(1) + "\"";

            if (this.ScreenObject.Preferences.ContainsKey("Enable Hold") && parseBoolean(this.ScreenObject.Preferences["Enable Hold"])) {
                let hldcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "HoldQuantity");
                if (hldcol && hldcol.Expression != null && hldcol.Expression != "") {
                    XML += " HoldCheck=\"1\"";
                }
            }

            if (this.savebulk)
                XML += this.getQuery();

            XML += " >";
            if (this.ViewActivities != null)
                XML += this.ViewActivities.ActivitiesXML();
            else
                XML += "<ScheduleActivityXml></ScheduleActivityXml>";

                if(Schedrecurxml!='')
               XML += "<Schedrecurxml>" + Schedrecurxml + "</Schedrecurxml>";


            XML += this.DocFlowXMl;

            if (!Util.IsEmpty(this.ScreenObject.HistoryCCXML))
                XML += "<History>" + this.ScreenObject.HistoryCCXML + "</History>";

            if (this.ScreenObject.Preferences.ContainsKey("CrossDimDocument") && !Util.IsEmpty(this.ScreenObject.Preferences["CrossDimDocument"]) && parseInt(this.ScreenObject.Preferences["CrossDimDocument"]) > 0) {
                let retObj: any = this.PostCrossDimDOc();
                if (!retObj.ret)
                    return;
                if (retObj.crxml == "0")
                    return;
                XML += "<CrossDimXMLNODES>" + retObj.crxml + " </CrossDimXMLNODES>";
            }

            if (this.ScreenObject.DocumentType == 32) {
                let VarFldName = "";
                let fld = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["VarienceField"]);
                if (fld)
                    VarFldName = fld.DisplayMember;
                if (this.ScreenObject.Preferences.ContainsKey("ShortageDOC") && this.ScreenObject.Preferences["ShortageDOC"] != "" && VarFldName != ""
                    && this.ScreenObject.GridDataColumns.Contains(VarFldName)) {
                    let ShortageDoc = new AddEditDocumentViewModel(parseInt(this.ScreenObject.Preferences["ShortageDOC"]), "", true)
                    {
                        ShortageDoc.CheckStockDimensions();
                        let drGrid;
                        ShortageDoc.ScreenObject.GridDataColumns.push("ParentSeqNo");

                        ShortageDoc.ScreenObject._CCFields.forEach(cc => {
                            if (cc instanceof PactListBoxData) {
                                let ccfld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == cc.CCID);
                                if (ccfld instanceof PactListBoxData) {
                                    cc.SelectedValue = ccfld.SelectedValue;

                                    if (ShortageDoc.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == cc.DBColumnID).length > 0
                                        || ShortageDoc.ScreenObject.DefaultBasedOn.ContainsKey((cc.CCID.toString()))) {
                                        ShortageDoc.ScreenObject.GetLinkReferenceData(cc.DBColumnID, ShortageDoc.ScreenObject.CostCenterID, cc.SelectedValue, this.DocumentDate, cc.DBColumnName, cc.CCID, null);
                                    }
                                }
                            }
                        });
                        let cnt = 0;
                        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i][VarFldName])
                                && parseFloat(this.ScreenObject.GridData[i][VarFldName]) < 0) {
                                cnt++;
                                drGrid = ShortageDoc.ScreenObject.GridDataObj.NewRow();
                                ShortageDoc.ScreenObject.ColumnSource.forEach(cccol => {
                                    if (cccol.CostCenterID > 50000) {
                                        if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (cccol.CostCenterID - 50000))) {
                                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID" + (cccol.CostCenterID - 50000) + "_Key"])) {
                                                drGrid["dcCCNID" + (cccol.CostCenterID - 50000) + "_Key"] = this.ScreenObject.GridData[i]["dcCCNID" + (cccol.CostCenterID - 50000) + "_Key"].toString();
                                                drGrid["dcCCNID" + (cccol.CostCenterID - 50000)] = this.ScreenObject.GridData[i]["dcCCNID" + (cccol.CostCenterID - 50000)].toString();
                                            }
                                        }
                                        else {
                                            let ccfld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == cccol.CostCenterID);
                                            if (ccfld instanceof PactListBoxData)
                                                drGrid["dcCCNID" + (cccol.CostCenterID - 50000) + "_Key"] = ccfld.SelectedValue;
                                        }
                                    }
                                });
                                drGrid["ProductID_Key"] = this.ScreenObject.GridData[i]["ProductID_Key"].toString();
                                drGrid["QOH"] = this.ScreenObject.GridData[i]["QOH"].toString();
                                drGrid["ParentSeqNo"] = this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                if (ShortageDoc.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                    drGrid["ProductCode"] = this.ScreenObject.GridData[i]["ProductCode"];
                                if (ShortageDoc.ScreenObject.GridDataColumns.Contains("ProductName"))
                                    drGrid["ProductName"] = this.ScreenObject.GridData[i]["ProductName"];

                                drGrid["Type"] = this.ScreenObject.GridData[i]["Type"];
                                drGrid["Unit"] = this.ScreenObject.GridData[i]["Unit"];
                                drGrid["Unit_Key"] = this.ScreenObject.GridData[i]["Unit_Key"];
                                drGrid["Rate"] = this.ScreenObject.GridData[i]["Rate"];

                                if (!(this.ScreenObject.Preferences.ContainsKey("DontCalcQOH") && !Util.IsEmpty(this.ScreenObject.Preferences["DontCalcQOH"])
                                    && parseBoolean(this.ScreenObject.Preferences["DontCalcQOH"])))
                                    ShortageDoc.AddProductData(drGrid, false, true);

                                drGrid["Quantity"] = this.ScreenObject.GridData[i][VarFldName].toString().replace("-", "");
                                if (!Util.IsEmpty(drGrid["UOMConversion"])) {
                                    drGrid["UOMConvertedQty"] = parseFloat(drGrid["Quantity"]) * parseFloat(drGrid["UOMConversion"]);
                                }
                                else {
                                    drGrid["UOMConversion"] = "1";
                                    drGrid["UOMConvertedQty"] = drGrid["Quantity"];
                                }

                                //if (Util.Int(this.ScreenObject.GridData[i]["Type"]) == 5) {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Type"]) && (parseInt(this.ScreenObject.GridData[i]["Type"].toString()) == 5 || parseInt(this.ScreenObject.GridData[i]["Type"].toString()) == 2)) {
                                    drGrid["ExtraXML"] = this.ScreenObject.GridData[i]["ExtraXML"];
                                }
                                ShortageDoc.ScreenObject.GridData.push(drGrid);

                                ShortageDoc.CalculateTotals(drGrid, false, "", false);
                            }
                        }
                        if (cnt > 0) {
                            ShortageDoc.parent = this;
                            ShortageDoc.IsAutoPost = true;
                            ShortageDoc.savebulk = true;
                            ShortageDoc.SaveInventoryDocument("Save", false);
                            if (!Util.IsEmpty(ShortageDoc.DisplayMessage)) {
                                this.DisplayMessage = " Shortage of stock" + ShortageDoc.DisplayMessage;

                                return;
                            }
                            XML += this.AutoPOstXML.replace("AutoPOstXML", "ShortageXML");
                            this.AutoPOstXML = "";
                        }
                    }
                }

                if (this.ScreenObject.Preferences.ContainsKey("ExcessDOC") && this.ScreenObject.Preferences["ExcessDOC"] != "" && VarFldName != ""
                    && this.ScreenObject.GridDataColumns.Contains(VarFldName)) {
                    let ExcessDoc = new AddEditDocumentViewModel(parseInt(this.ScreenObject.Preferences["ExcessDOC"]), "", true)
                    {
                        ExcessDoc.CheckStockDimensions();
                        ExcessDoc.ScreenObject._CCFields.forEach(cc => {
                            if (cc instanceof PactListBoxData) {
                                let ccfld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == cc.CCID);
                                if (ccfld instanceof PactListBoxData) {
                                    cc.SelectedValue = ccfld.SelectedValue;

                                    if (ExcessDoc.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == cc.DBColumnID).length > 0
                                        || ExcessDoc.ScreenObject.DefaultBasedOn.ContainsKey((cc.CCID.toString()))) {
                                        ExcessDoc.ScreenObject.GetLinkReferenceData(cc.DBColumnID, ExcessDoc.ScreenObject.CostCenterID, cc.SelectedValue, this.DocumentDate, cc.DBColumnName, cc.CCID, null);
                                    }
                                }

                            }
                        });
                        let cnt = 0;
                        let drGrid;
                        ExcessDoc.ScreenObject.GridDataColumns.push("ParentSeqNo");
                        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i][VarFldName])
                                && parseFloat(this.ScreenObject.GridData[i][VarFldName]) > 0) {
                                cnt++;
                                drGrid = ExcessDoc.ScreenObject.GridDataObj.NewRow();
                                ExcessDoc.ScreenObject.ColumnSource.forEach(cccol => {
                                    if (cccol.CostCenterID > 50000) {
                                        if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (cccol.CostCenterID - 50000))) {
                                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID" + (cccol.CostCenterID - 50000) + "_Key"])) {
                                                drGrid["dcCCNID" + (cccol.CostCenterID - 50000) + "_Key"] = this.ScreenObject.GridData[i]["dcCCNID" + (cccol.CostCenterID - 50000) + "_Key"].toString();
                                                drGrid["dcCCNID" + (cccol.CostCenterID - 50000)] = this.ScreenObject.GridData[i]["dcCCNID" + (cccol.CostCenterID - 50000)].toString();
                                            }
                                        }
                                        else {
                                            let ccfld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == cccol.CostCenterID);
                                            if (ccfld instanceof PactListBoxData)
                                                drGrid["dcCCNID" + (cccol.CostCenterID - 50000) + "_Key"] = ccfld.SelectedValue;
                                        }
                                    }
                                });
                                drGrid["ProductID_Key"] = this.ScreenObject.GridData[i]["ProductID_Key"].toString();
                                drGrid["QOH"] = this.ScreenObject.GridData[i]["QOH"].toString();
                                drGrid["ParentSeqNo"] = this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                if (ExcessDoc.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                    drGrid["ProductCode"] = this.ScreenObject.GridData[i]["ProductCode"];
                                if (ExcessDoc.ScreenObject.GridDataColumns.Contains("ProductName"))
                                    drGrid["ProductName"] = this.ScreenObject.GridData[i]["ProductName"];
                                drGrid["Type"] = this.ScreenObject.GridData[i]["Type"];
                                drGrid["Unit"] = this.ScreenObject.GridData[i]["Unit"];
                                drGrid["Unit_Key"] = this.ScreenObject.GridData[i]["Unit_Key"];
                                drGrid["Rate"] = this.ScreenObject.GridData[i]["Rate"];

                                if (!(this.ScreenObject.Preferences.ContainsKey("DontCalcQOH") && !Util.IsEmpty(this.ScreenObject.Preferences["DontCalcQOH"])
                                    && parseBoolean(this.ScreenObject.Preferences["DontCalcQOH"])))
                                    ExcessDoc.AddProductData(drGrid, false, true);

                                drGrid["Quantity"] = this.ScreenObject.GridData[i][VarFldName].toString();

                                if (!Util.IsEmpty(drGrid["UOMConversion"])) {
                                    drGrid["UOMConvertedQty"] = parseFloat(drGrid["Quantity"]) * parseFloat(drGrid["UOMConversion"]);
                                }
                                else {
                                    drGrid["UOMConversion"] = "1";
                                    drGrid["UOMConvertedQty"] = drGrid["Quantity"];
                                }
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Type"]) && (parseInt(this.ScreenObject.GridData[i]["Type"].toString()) == 5 || parseInt(this.ScreenObject.GridData[i]["Type"].toString()) == 2)) {
                                    drGrid["ExtraXML"] = this.ScreenObject.GridData[i]["ExtraXML"];
                                }
                                ExcessDoc.ScreenObject.GridData.push(drGrid);

                                ExcessDoc.CalculateTotals(drGrid, false, "", false);
                            }
                        }
                        if (cnt > 0) {
                            ExcessDoc.parent = this;
                            ExcessDoc.IsAutoPost = true;
                            ExcessDoc.savebulk = true;
                            ExcessDoc.SaveInventoryDocument("Save", false);
                            if (!Util.IsEmpty(ExcessDoc.DisplayMessage)) {
                                this.DisplayMessage = " Excess of stock" + ExcessDoc.DisplayMessage;
                                return;
                            }
                            XML += this.AutoPOstXML.Replace("AutoPOstXML", "ExcessXML");
                            this.AutoPOstXML = "";
                        }
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 73)//Leave Adjusted As Vacation
            {
                let oDocument = new AddEditDocumentViewModel(40072, "Apply Vacation", false);
                oDocument.strVacXml = "LAV";
                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (this.ScreenObject.GridData[i]["dcAlpha4"] != null && this.ScreenObject.GridData[i]["dcAlpha1"] != null && this.ScreenObject.GridData[i]["dcAlpha4"].toString() == "Yes") {
                        let DimLTfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (DimLTfld instanceof PactListBoxData && DimLTfld.SelectedValue > 0)
                            (oDocument.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51") as PactCodeNameListBoxData).SelectedValue = DimLTfld.SelectedValue;
                        else if (DimLTfld instanceof PactCodeNameListBoxData && DimLTfld.SelectedValue > 0)
                            (oDocument.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51") as PactCodeNameListBoxData).SelectedValue = DimLTfld.SelectedValue;

                        oDocument.DimensionSelectedvalueData();

                        (oDocument.ScreenObject._StaticFields.find(a => a.DBColumnName.toLowerCase() == "commonnarration") as PactTextBoxData).Text = "Leave Adjusted as Vacation";
                        (oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2") as PactExtraFieldDateData).Date = Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]);

                        let fldAPV = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                        if (fldAPV != undefined && fldAPV instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV.Date))
                            oDocument.onDateChanged(fldAPV);

                        (oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3") as PactExtraFieldDateData).Date = Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha3_Key"]);
                        fldAPV = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                        if (fldAPV != undefined && fldAPV instanceof PactExtraFieldDateData && fldAPV.Date)
                            oDocument.ApplyVacation(fldAPV);

                        oDocument.ButtonsEnabled = true;
                        oDocument.SaveInventoryDocument_1("Save");
                    }
                }
                if (oDocument.strVacXml != "") {
                    if (oDocument.strVacXml.Contains("LAV")) {
                        this.DisplayMessage = oDocument.strVacXml.toString().replace("LAV", "");

                        return;
                    }
                    else {
                        //XML = "<XML>";
                        XML += oDocument.strVacXml.toString();
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 202)//Preventive Maintenance Contract
            {
                let oDocument = new AddEditDocumentViewModel(40203, "Preventive Service Request", false);
                oDocument.strPMCXml = "PRS";

                oDocument.ScreenObject.DocDate.Date = this.ScreenObject.DocDate.Date;

                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID154_Key"]) && parseFloat(this.ScreenObject.GridData[i]["dcCCNID154_Key"].toString()) > 0) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[0]["ExtraXML"]))
                            BaseService.SessionManager.FMExtraXml = this.ScreenObject.GridData[0]["ExtraXML"].toString();
                        oDocument.ScreenObject._CCFields.forEach(cc => {
                            if (cc instanceof PactListBoxData && cc.CCID > 0) {
                                if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (cc.CCID - 50000))) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID" + (cc.CCID - 50000) + "_Key"])) {
                                        let ccfld = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == cc.DBColumnName);;// ScreenObject._CCFields.find(a => a instanceof PactListBoxData && ((PactListBoxData)a).CCID == cc.CCID);
                                        if (ccfld != undefined && cc instanceof PactListBoxData && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID" + (cc.CCID - 50000) + "_Key"]))
                                            cc.SelectedValue = parseInt(this.ScreenObject.GridData[i]["dcCCNID" + (cc.CCID - 50000) + "_Key"].toString());
                                        else
                                            cc.SelectedValue = 0;
                                    }
                                }
                            }
                        });

                        oDocument.ScreenObject._TextFields.forEach(cc => {
                            let fld = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == cc.DBColumnName);
                            if (fld != undefined && (fld.DataType.toLowerCase().toString() == "text" || fld.DataType.toLowerCase().toString() == "string")) {

                                if (cc instanceof PactTextBoxData) {
                                    if (cc.DBColumnName.toLowerCase().toString() == "dcalpha1")
                                        cc.Text = BaseService.SessionManager.UserName;
                                    else
                                        cc.Text = this.ScreenObject.GridData[i][cc.DBColumnName].toString();
                                }
                                else if (cc instanceof PactTextAreaData)
                                    cc.Text = this.ScreenObject.GridData[i][cc.DBColumnName].toString();
                            }
                            else if (fld != null && (fld.DataType.toLowerCase().toString() == "date" || fld.DataType.toLowerCase().toString() == "datetime")) {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i][cc.DBColumnName + "_Key"]))
                                    (cc as PactExtraFieldDateData).Date = Util.ParseDate(this.ScreenObject.GridData[i][cc.DBColumnName + "_Key"].toString());
                            }

                            let fldtxt: any = this.ScreenObject.HeaderFields.find(a => a instanceof PactControlData && a.DBColumnName.toString() == cc.DBColumnName) as PactControlData;
                            if (fldtxt != undefined && (fldtxt.DataType.toLowerCase().toString() == "text" || fldtxt.DataType.toLowerCase().toString() == "string")) {
                                if (cc instanceof PactTextBoxData)
                                    cc.Text = fldtxt.Text;
                                else if (cc instanceof PactTextAreaData)
                                    cc.Text = fldtxt.Text;
                            }
                        });
                        oDocument.ButtonsEnabled = true;
                        oDocument.SaveInventoryDocument("Save");
                    }
                }

                if (!Util.IsEmpty(oDocument.strPMCXml)) {
                    if (oDocument.strPMCXml.Contains("PRS")) {
                        this.DisplayMessage = oDocument.strPMCXml.toString().Replace("PMC", "");
                        this.MessageVisibility = true;
                        return;
                    }
                    else {
                        //XML = "<XML>";
                        XML += oDocument.strPMCXml.toString();
                        BaseService.SessionManager.FMExtraXml = "";
                        this.iPMCActivity = 0;
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 56)//Apply Loan -> Assgning Loan Guarantees
            {
                if (this.LoanGuaranteeVisible && this.dtLoanGuarantees != null && this.dtLoanGuarantees.length > 0) {
                    //#region Loan Guarantees XML
                    let sbLG = "";
                    sbLG += "<LoanGuaranteesXML>";
                    sbLG += "<Rows>";
                    for (let i = 0; i < this.dtLoanGuarantees.length; i++) {
                        sbLG += "<Row EmpSeqNo=\"" + this.dtLoanGuarantees[i]["GEmpSeqNo"].toString();
                        +"\" SNo=\"" + (i + 1);
                        sbLG += "\" />";
                    }
                    sbLG += "</Rows>";
                    sbLG += "</LoanGuaranteesXML>";

                    XML += sbLG.toString();
                    //#endregion
                }
            }
            else if (this.ScreenObject.DocumentType == 61)//Vacation Management -> Define Days
            {
                if (this.dtVacDefineDays != null && this.dtVacDefineDays.length > 0) {
                    //#region Vacation Define Days XML
                    let sbVDD = "";
                    sbVDD += "<VacManageDefineDays>";
                    sbVDD += "<Rows>";
                    for (let i = 0; i < this.dtVacDefineDays.length; i++) {
                        sbVDD += "<Row SNo=\"" + this.dtVacDefineDays[i]["SNo"].toString()
                            + "\" FromMonth=\"" + this.dtVacDefineDays[i]["FromMonth"].toString()
                            + "\" ToMonth=\"" + this.dtVacDefineDays[i]["ToMonth"].toString()
                            + "\" DaysPerMonth=\"" + this.dtVacDefineDays[i]["DaysPerMonth"].toString()
                            + "\" ApplyToPrevMonths=\"" + this.dtVacDefineDays[i]["ApplyToPrevMonths"].toString();
                        sbVDD += "\" />";
                    }
                    sbVDD += "</Rows>";
                    sbVDD += "</VacManageDefineDays>";

                    XML += sbVDD;
                    //#endregion
                }
            }
            else if (this.ScreenObject.DocumentType == 85) //Bulk Appraisals
            {
                if (this.sApprUpdate.length > 0) {
                    if (this.ScreenObject.Preferences.ContainsKey("UpdateGradeandAppraisalData") && this.ScreenObject.Preferences["UpdateGradeandAppraisalData"] == "True") {
                        let sGradeID = "0", sEmpID = "0";
                        let dtToDate = new Date();

                        var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid53");
                        if (vFld != undefined && vFld != null) {
                            if (vFld instanceof PactListBoxData)
                                sGradeID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sGradeID = vFld.SelectedValue.toString();
                        }

                        vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (vFld != undefined && vFld != null) {
                            if (vFld instanceof PactListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                        }

                        var fldAPV1 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                        if (fldAPV1 != undefined && fldAPV1 != null && fldAPV1 instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV1.Date))
                            dtToDate = fldAPV1.Date;

                        XML += "<PayrollBulkAppraisals Grade=\"" + sGradeID + "\" EmpID=\"" + sEmpID + "\" EffectFrom=\"" + dtToDate.ToString("dd/MMM/yyyy") + "\" Query=\"" + PactTextBoxData.GetValidXml(this.sApprUpdate) + "\"></PayrollBulkAppraisals>";
                    }
                    else {
                        XML += "<PayrollBulkAppraisals Query=\"" + PactTextBoxData.GetValidXml(this.sApprUpdate) + "\"></PayrollBulkAppraisals>";
                    }

                }
            }
            else if (this.ScreenObject.DocumentType == 97) //Lates Processing - Deduction of Leaves
            {
                //#region Lates Processing - Leaves Posting

                if (this.ScreenObject.GridData.length > 0) {
                    let sPME = "";
                    let dtPM = new Date(), dtPMS = new Date(), dtPME = new Date();
                    let txtDatefld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha33"); //Payrol Month
                    if (txtDatefld && txtDatefld instanceof PactExtraFieldDateData && txtDatefld.Date) {
                        dtPM = txtDatefld.Date;
                        let refObj = { PayrollMonth: dtPM, PayrollMonthStart: dtPMS, PayrollMonthEnd: dtPME }
                        Util.SetPayrollDate(dtPM, refObj);
                        dtPM = refObj.PayrollMonth
                        dtPMS = refObj.PayrollMonthStart
                        dtPME = refObj.PayrollMonthEnd
                        sPME = dtPME.ToString("dd MMM yyyy");
                    }

                    let dsLT = BaseService.common.GetDataSet("PAY050", this.DocID.toString());
                    let dtAvalLeaves = null;

                    let sbL = "";
                    let sbV = "";
                    for (let r = 0; r < this.ScreenObject.GridData.length; r++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[r]["dcAlpha27"]) && parseFloat(this.ScreenObject.GridData[r]["dcAlpha27"]) > 0) {
                            let dLDed = parseFloat(this.ScreenObject.GridData[r]["dcAlpha27"]);
                            let dLAvl = 0, dD = 0;
                            let sEmpSeqNo = this.ScreenObject.GridData[r]["dcCCNID51_Key"].toString();
                            let sLTSeqNo = "";
                            let isVacLT = false, isLopLT = false;
                            let sLeaveTypes = this.ScreenObject.GridData[r]["dcAlpha28"].toString();
                            let sLT = sLeaveTypes.split(';');
                            if (sLT != null && sLT.length > 0) {
                                for (let l = 0; l < sLT.length; l++) {
                                    if (sLT[l] != null && sLT[l] != "" && dLDed > 0) {
                                        isVacLT = false;
                                        isLopLT = false;

                                        sLTSeqNo = dsLT.Tables[0].filter(x => x.ComponentName == sLT[l])[0]["ComponentID"].toString();

                                        if (BaseService.SessionManager.Preferences.ContainsKey("ConsiderLOPBasedOn")) {
                                            let sLOPBsdOn = BaseService.SessionManager.Preferences["ConsiderLOPBasedOn"].split(',');
                                            if (sLOPBsdOn != null && sLOPBsdOn.length > 0) {
                                                for (let b = 0; b < sLOPBsdOn.length; b++) {
                                                    if (sLOPBsdOn[b] != null && sLOPBsdOn[b] == sLTSeqNo) {
                                                        isLopLT = true;
                                                        break;
                                                    }
                                                }
                                            }
                                        }

                                        if (dsLT.Tables[1] != null && dsLT.Tables[1].length > 0) {
                                            if (dsLT.Tables[1][0]["VacationComponentID"] != null && dsLT.Tables[1][0]["VacationComponentID"] != null &&
                                                dsLT.Tables[1][0]["VacationComponentID"].toString() == sLTSeqNo)
                                                isVacLT = true;
                                        }

                                        if (isVacLT) //Vacation Leave Type
                                        {

                                            // let dOP = 0, dCr = 0;

                                            // AddEditDocumentViewModel oDocument = new AddEditDocumentViewModel(40072, "Apply Vacation", false);
                                            // oDocument.strVacXml = "LAV";
                                            // let DimFld = oDocument.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                                            // if (DimFld instanceof PactCodeNameListBoxData)
                                            // {
                                            //     ((PactCodeNameListBoxData)DimFld).Code.SelectedValue = parseInt(sEmpSeqNo);
                                            //     ((PactCodeNameListBoxData)DimFld).Name.SelectedValue = parseInt(sEmpSeqNo);

                                            //     ((PactCodeNameListBoxData)DimFld).Name.SelectedValueText = this.ScreenObject.GridData[r]["dcCCNID51"].toString();
                                            //     ((PactCodeNameListBoxData)DimFld).Code.Text = this.ScreenObject.GridData[r]["dcCCNID51"].toString();
                                            //     ((PactCodeNameListBoxData)DimFld).Name.Text = this.ScreenObject.GridData[r]["dcCCNID51"].toString();
                                            // }
                                            // else
                                            // {
                                            //     ((PactListBoxData)DimFld).SelectedValue = parseInt(sEmpSeqNo);
                                            //     ((PactListBoxData)DimFld).Text = this.ScreenObject.GridData[r]["dcCCNID51"].toString();
                                            //     ((PactListBoxData)DimFld).SelectedValueText = this.ScreenObject.GridData[r]["dcCCNID51"].toString();
                                            // }
                                            // oDocument.DimensionSelectedvalueData();

                                            // ((PactTextBoxData)oDocument.ScreenObject._StaticFields.find(a => a.DBColumnName.toLowerCase() == "commonnarration")).Text = "POSTED FROM LATES PROCESSING DOCUMENT";
                                            // ((PactExtraFieldDateData)oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2")).Date = Util.ParseDate(dtPME.Date);
                                            // ((PactExtraFieldDateData)oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3")).Date = Util.ParseDate(dtPME.Date);

                                            // let fldAPV = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                                            // if (fldAPV instanceof PactExtraFieldDateData && fldAPV.Date)
                                            //     oDocument.ApplyVacation(fldAPV);

                                            // fldAPV = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha22");
                                            // if (fldAPV instanceof PactTextBoxData)
                                            //     dOP = parseFloat(fldAPV.Text);

                                            // fldAPV = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha7");
                                            // if (fldAPV instanceof PactTextBoxData)
                                            //     dCr = parseFloat(fldAPV.Text);

                                            // dLAvl = dOP + dCr;
                                            // if (dLAvl <= 0)
                                            //     continue;

                                            // if (dLDed <= dLAvl)
                                            // {
                                            //     dD = dLDed;
                                            //     dLDed = 0;
                                            // }
                                            // else
                                            // {
                                            //     dD = dLAvl;
                                            //     dLDed = dLDed - dLAvl;
                                            // }

                                            // fldAPV = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                                            // if (fldAPV instanceof PactTextBoxData)
                                            //     fldAPV.Text = dD.toString();

                                            // fldAPV = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha8");
                                            // if (fldAPV instanceof PactTextBoxData)
                                            //     fldAPV.Text = dD.toString();

                                            // fldAPV = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha9");
                                            // if (fldAPV instanceof PactTextBoxData)
                                            //     fldAPV.Text = dD.toString();

                                            // fldAPV = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha10");
                                            // if (fldAPV instanceof PactTextBoxData)
                                            //     fldAPV.Text = dD.toString();

                                            // oDocument.ButtonsEnabled = true;
                                            // oDocument.SaveInventoryDocument("Save");


                                            // if (oDocument.strVacXml != "")
                                            // {
                                            //     if (oDocument.strVacXml.Contains("LAV"))
                                            //     {
                                            //         DisplayMessage = oDocument.strVacXml.toString().replace("LAV", "") + " - EmpCode :" + this.ScreenObject.GridData[r]["dcCCNID51Code"] + " at Row No. " + r;
                                            //         
                                            //         return;
                                            //     }
                                            //     else
                                            //     {
                                            //         sbV+=oDocument.strVacXml.toString();
                                            //     }
                                            // }
                                        }
                                        else //Normal Leave Type
                                        {
                                            let drc;
                                            let sCrAccount = "", sDrAccount = "", sProdID = "";

                                            if (BaseService.SessionManager.dtDocDefAccs != null) {
                                                drc = BaseService.SessionManager.dtDocDefAccs.filter(x => x.CostCenterID == 40062 && x.SysColumnName == 'ProductID');
                                                if (drc != null && drc.length > 0 && !Util.IsEmpty(drc[0]["UserDefaultValue"]) && drc[0]["UserDefaultValue"].toString().trim() != "")
                                                    sProdID = drc[0]["UserDefaultValue"].toString();

                                                drc = BaseService.SessionManager.dtDocDefAccs.filter(x => x.CostCenterID == 40062 && x.SysColumnName == 'CreditAccount');
                                                if (drc != null && drc.length > 0 && !Util.IsEmpty(drc[0]["UserDefaultValue"]) && drc[0]["UserDefaultValue"].toString().trim() != "")
                                                    sCrAccount = drc[0]["UserDefaultValue"].toString();

                                                drc = BaseService.SessionManager.dtDocDefAccs.filter(x => x.CostCenterID == 40062 && x.SysColumnName == 'DebitAccount');
                                                if (drc != null && drc.length > 0 && !Util.IsEmpty(drc[0]["UserDefaultValue"]) && drc[0]["UserDefaultValue"].toString().trim() != "")
                                                    sDrAccount = drc[0]["UserDefaultValue"].toString();
                                            }

                                            let sLDocID = "0";
                                            let drcL;
                                            if (dsLT.Tables[2] != null && dsLT.Tables[2].length > 0) {
                                                drcL = dsLT.Tables[2].filter(x => x.EmpSeqNo == sEmpSeqNo && x.LeaveComponentID == sLTSeqNo);
                                                if (drcL != null && drcL.length > 0)
                                                    sLDocID = drcL[0]["DocID"].toString();
                                            }

                                            let al = [];
                                            al.push(sEmpSeqNo);
                                            al.push(sLTSeqNo);
                                            al.push(sPME);
                                            al.push(sLDocID);
                                            al.push(BaseService.SessionManager.UserID);
                                            al.push(BaseService.SessionManager.LanguageID);
                                            dtAvalLeaves = BaseService.common.GetDataSet_SP(al, "spPAY_ExtGetAssignedLeaves").Tables[0];
                                            if (dtAvalLeaves != null && dtAvalLeaves.length > 0) {
                                                dLAvl = parseFloat(dtAvalLeaves[0]["AvailableLeaves"]);
                                                if (!isLopLT && dLAvl <= 0)
                                                    continue;

                                                sbL += "<LatesLeaves DocID=\"" + sLDocID + "\" DocDetIDs=\"" + "" + "\" WorkFlowID=\"" + 0 + "\" >";
                                                sbL += "<DOCXML>";
                                                sbL += "<RowHead/>";
                                                sbL += "<Row>";
                                                sbL += "<Transactions DocSeqNo=\"1\"  DocDetailsID=\"0\" LinkedInvDocDetailsID=\"0\" LinkedFieldName=\"\" IsScheme=\"\" ProductID=\"" + sProdID + "\" Quantity=\"1\" Unit=\"1\" UOMConversion=\"1\" UOMConvertedQty=\"1\" Rate=\"0\" Gross=\"\" RefNO=\"\" LineNarration=\"Remarks\" IsQtyIgnored=\"1\" AverageRate=\"0\" StockValue=\"0\" Net=\"0\" StockValueFC=\"0\" CurrencyID=\"1\" ExchangeRate=\"1.0\" CommonNarration=\"POSTED FROM LATES PROCESSING DOCUMENT\"  DebitAccount=\"" + sDrAccount + "\"  CreditAccount=\"" + sCrAccount + "\"  ></Transactions>";
                                                sbL += "<Numeric Query=\"\" ></Numeric>";

                                                if (isLopLT) {
                                                    sbL += "<Alpha Query=\"dcAlpha2=N'0', dcAlpha3=N'0', dcAlpha4=N'" + sPME + "', dcAlpha5=N'" + sPME + "', dcAlpha6=N'Both', dcAlpha8=N'-1', dcAlpha7=N'" + dLDed + "', dcAlpha9=N'-1', dcAlpha10=N'0', dcAlpha14=N'0', dcAlpha16=N'LatesProcessing', \" ></Alpha>";
                                                    sbL += "<CostCenters Query=\"dcCCNID52=" + sLTSeqNo + ", dcCCNID51=" + sEmpSeqNo + ", \" ></CostCenters>";
                                                }
                                                else {
                                                    if (dLDed <= dLAvl) {
                                                        dD = dLDed;
                                                        dLDed = 0;
                                                    }
                                                    else {
                                                        dD = dLAvl;
                                                        dLDed = dLDed - dLAvl;
                                                    }
                                                    sbL += "<Alpha Query=\"dcAlpha2=N'" + dtAvalLeaves[0]["AssignedLeaves"].toString() + "', dcAlpha3=N'" + dtAvalLeaves[0]["AvailableLeaves"].toString() + "', dcAlpha4=N'" + sPME + "', dcAlpha5=N'" + sPME + "', dcAlpha6=N'Both', dcAlpha8=N'100', dcAlpha7=N'" + dD + "', dcAlpha9=N'" + dtAvalLeaves[0]["MaxLeaves"].toString() + "', dcAlpha10=N'0', dcAlpha14=N'" + dtAvalLeaves[0]["ActualAvailableLeaves"].toString() + "', dcAlpha16=N'LatesProcessing', \" ></Alpha>";
                                                    sbL += "<CostCenters Query=\"dcCCNID52=" + sLTSeqNo + ", dcCCNID51=" + sEmpSeqNo + ", \" ></CostCenters>";
                                                }
                                                sbL += "</Row>";
                                                sbL += "</DOCXML>";
                                                sbL += "</LatesLeaves>";
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    if (sbL.length > 0) {
                        // sbL = sbL.Insert(0, "<LPL>");
                        // sbL += "</LPL>"; 
                        sbL = "<LPL>" + sbL + "</LPL>";

                        XML += sbL.toString();
                    }

                    //if (sbV.length > 0)
                    //{
                    //    XML += sbV.toString();
                    //}
                }
                //#endregion

            }
            else if (this.ScreenObject.DocumentType == 72)//Apply Vacation -> Contract
            {

                //#region Vacation Auto ReJoin
                if (this.ScreenObject.Preferences.ContainsKey("AutoRejoinVacation") && !Util.IsEmpty(this.ScreenObject.Preferences["AutoRejoinVacation"]) && parseBoolean(this.ScreenObject.Preferences["AutoRejoinVacation"])) {

                    let sbL = '';
                    let sbV = '';

                    let drc: any;
                    let sCrAccount = "", sDrAccount = "", sProdID = "", sEmpID = "", sFromDate = "", sToDate = "", sRejoinDate = "", sComponentID = "";

                    let vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if (vFld != undefined) {
                        if (vFld instanceof PactListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                        else if (vFld instanceof PactCodeNameListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                    }

                    vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
                    if (vFld != undefined) {
                        if (vFld instanceof PactListBoxData)
                            sComponentID = vFld.SelectedValue.toString();
                        else if (vFld instanceof PactCodeNameListBoxData)
                            sComponentID = vFld.SelectedValue.toString();
                    }

                    if (!Util.IsEmpty(sEmpID) && parseInt(sEmpID) > 0 && !Util.IsEmpty(sComponentID) && parseInt(sComponentID) > 0) {
                        let fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                        if (fldAPV2 != undefined && fldAPV2 instanceof PactExtraFieldDateData && Util.String(fldAPV2.Date) != "") {
                            sFromDate = new Date(fldAPV2.Date).ToString("dd MMM yyyy");
                        }

                        fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                        if (fldAPV2 != undefined && fldAPV2 instanceof PactExtraFieldDateData && Util.String(fldAPV2.Date) != "") {
                            sToDate = new Date(fldAPV2.Date).ToString("dd MMM yyyy");
                            sRejoinDate = new Date(fldAPV2.Date).AddDays(1).ToString("dd MMM yyyy");
                        }

                        if (sFromDate != "" && sToDate != "") {

                            let dtLT: any = BaseService.common.GetDataTable("DOC073", this.DocID.toString());

                            let sLDocID = "0";
                            let drcL: any;

                            if (dtLT != null && dtLT.length > 0) {
                                drcL = dtLT.filter(x => x.EmpSeqNo == sEmpID && x.LeaveComponentID == sComponentID);
                                if (drcL != null && drcL.length > 0) {
                                    sLDocID = drcL[0]["DocID"].toString();

                                    if (drcL[0]["ReJoin"] != null && drcL[0]["ReJoin"].toString() != "") {
                                        if (new Date(drcL[0]["ReJoin"]) != new Date(sRejoinDate)) {
                                            this.DisplayMessage = "Cannot Post this Document...Rejoin date is changed";
                                            this.MessageVisibility = true;
                                            return;
                                        }
                                    }
                                }
                            }

                            if (BaseService.SessionManager.dtDocDefAccs != null) {
                                drc = BaseService.SessionManager.dtDocDefAccs.filter(x => x.CostCenterID == 40065 && x.SysColumnName == 'ProductID');
                                if (drc != null && drc.length > 0 && drc[0]["UserDefaultValue"] != null && drc[0]["UserDefaultValue"].toString().trim() != "")
                                    sProdID = drc[0]["UserDefaultValue"].toString();

                                drc = BaseService.SessionManager.dtDocDefAccs.filter(x => x.CostCenterID == 40065 && x.SysColumnName == 'CreditAccount');
                                if (drc != null && drc.length > 0 && drc[0]["UserDefaultValue"] != null && drc[0]["UserDefaultValue"].toString().trim() != "")
                                    sCrAccount = drc[0]["UserDefaultValue"].toString();

                                drc = BaseService.SessionManager.dtDocDefAccs.filter(x => x.CostCenterID == 40065 && x.SysColumnName == 'DebitAccount');
                                if (drc != null && drc.length > 0 && drc[0]["UserDefaultValue"] != null && drc[0]["UserDefaultValue"].toString().trim() != "")
                                    sDrAccount = drc[0]["UserDefaultValue"].toString();
                            }


                            sbL += "<VacRejoin DocID=\"" + sLDocID + "\" DocDetIDs=\"" + "" + "\" WorkFlowID=\"" + 0 + "\" >";
                            sbL += "<DOCXML>";
                            sbL += "<RowHead/>";
                            sbL += "<Row>";
                            sbL += "<Transactions DocSeqNo=\"1\"  DocDetailsID=\"0\" LinkedInvDocDetailsID=\"0\" LinkedFieldName=\"\" IsScheme=\"\" ProductID=\"" + sProdID + "\" Quantity=\"1\" Unit=\"1\" UOMConversion=\"1\" UOMConvertedQty=\"1\" Rate=\"0\" Gross=\"\" RefNO=\"\" LineNarration=\"\" IsQtyIgnored=\"1\" AverageRate=\"0\" StockValue=\"0\" Net=\"0\" StockValueFC=\"0\" CurrencyID=\"1\" ExchangeRate=\"1.0\" CommonNarration=\"AutoPosted From Vacation\"  DebitAccount=\"" + sDrAccount + "\"  CreditAccount=\"" + sCrAccount + "\"  ></Transactions>";
                            sbL += "<Numeric Query=\"\" ></Numeric>";

                            sbL += "<Alpha Query=\"dcAlpha1=N'" + sFromDate + "', dcAlpha2=N'" + sToDate + "', dcAlpha3=N'" + sRejoinDate + "', dcAlpha4=N'0', dcAlpha6=N'AutoRejoin', \" ></Alpha>";
                            sbL += "<CostCenters Query=\"dcCCNID52=" + sComponentID + ", dcCCNID51=" + sEmpID + ", \" ></CostCenters>";
                            sbL += "</Row>";
                            sbL += "</DOCXML>";
                            sbL += "</VacRejoin>";

                            if (sbL.length > 0) {
                                sbL = "<VRJ>" + sbL + "</VRJ>";
                                // sbL.Insert(0, "<VRJ>");
                                // sbL += "</VRJ>";

                                XML += sbL.toString();
                            }
                        }
                    }
                }
                //#endregion

                if (this.dtVacContract != null && this.dtVacContract.length > 0) {
                    //  #region Vacation Contract XML

                    let sbVC: string = '';
                    sbVC += "<VacContract>";
                    sbVC += "<Rows>";
                    for (let i = 0; i < this.dtVacContract.length; i++) {
                        sbVC += "<Row SNo=\"" + this.dtVacContract[i]["SNo"].toString()
                            + "\" ContractNodeID=\"" + this.dtVacContract[i]["ContractNodeID"].toString()
                            + "\" ContractFrom=\"" + this.dtVacContract[i]["ContractFrom"].toString()
                            + "\" ContractTo=\"" + this.dtVacContract[i]["ContractTo"].toString()
                            + "\" CreditedDays=\"" + this.dtVacContract[i]["CreditedDays"].toString()
                            + "\" PrevTakenDays=\"" + this.dtVacContract[i]["PrevTakenDays"].toString()
                            + "\" BalanceDays=\"" + this.dtVacContract[i]["BalanceDays"].toString()
                            + "\" CanAvail=\"" + this.dtVacContract[i]["CanAvail"].toString();
                        sbVC += ("\" />");
                    }
                    sbVC += ("</Rows>");
                    sbVC += "</VacContract>";

                    XML += sbVC.toString();

                    // #endregion
                }
            }
            else if (this.ScreenObject.DocumentType == 62) {
                //#region Leave Auto ReJoin
                if (this.ScreenObject.Preferences.ContainsKey("AutoRejoinLeave") && !Util.IsEmpty(this.ScreenObject.Preferences["AutoRejoinLeave"]) && parseBoolean(this.ScreenObject.Preferences["AutoRejoinLeave"])) {
                    for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                        if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && this.ScreenObject.GridData[k]["ProductID_Key"] != null && this.ScreenObject.GridData[k]["ProductID_Key"].toString() != "") {
                            let sbL = '';
                            let sbV = '';

                            let drc: any;
                            let sCrAccount = "", sDrAccount = "", sProdID = "", sEmpID = "", sFromDate = "", sToDate = "", sRejoinDate = "", sComponentID = "";

                            let vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                            if (vFld != undefined) {
                                if (vFld instanceof PactListBoxData)
                                    sEmpID = vFld.SelectedValue.toString();
                                else if (vFld instanceof PactCodeNameListBoxData)
                                    sEmpID = vFld.SelectedValue.toString();
                            }
                            else {
                                let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                                if (vFld2 != undefined && this.ScreenObject.GridData[k][vFld2.ValueMember] != null && this.ScreenObject.GridData[k][vFld2.ValueMember] != null && this.ScreenObject.GridData[k][vFld2.ValueMember].toString() != "")
                                    sEmpID = this.ScreenObject.GridData[k][vFld2.ValueMember].toString();
                            }

                            vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
                            if (vFld != undefined) {
                                if (vFld instanceof PactListBoxData)
                                    sComponentID = vFld.SelectedValue.toString();
                                else if (vFld instanceof PactCodeNameListBoxData)
                                    sComponentID = vFld.SelectedValue.toString();
                            }
                            else {
                                let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid52_key");
                                if (vFld2 != undefined && this.ScreenObject.GridData[k][vFld2.ValueMember] != null && this.ScreenObject.GridData[k][vFld2.ValueMember] != null && this.ScreenObject.GridData[k][vFld2.ValueMember].toString() != "")
                                    sComponentID = this.ScreenObject.GridData[k][vFld2.ValueMember].toString();
                            }

                            if (!Util.IsEmpty(sEmpID) && parseInt(sEmpID) > 0 && !Util.IsEmpty(sComponentID) && parseInt(sComponentID) > 0) {

                                if (this.ScreenObject.GridData[k]["dcAlpha4_Key"] != null) {
                                    sFromDate = new Date(this.ScreenObject.GridData[k]["dcAlpha4_Key"]).ToString("dd MMM yyyy");
                                }

                                if (this.ScreenObject.GridData[k]["dcAlpha5_Key"] != null) {
                                    sToDate = new Date(this.ScreenObject.GridData[k]["dcAlpha5_Key"]).ToString("dd MMM yyyy");
                                    sRejoinDate = new Date(this.ScreenObject.GridData[k]["dcAlpha5_Key"]).AddDays(1).ToString("dd MMM yyyy");
                                }

                                if (sFromDate != "" && sToDate != "") {
                                    let dsStr = Util.GetPayrollStructureBasedonEmployee(parseInt(sEmpID), new Date(sFromDate));
                                    let drStr: any = dsStr.Tables[0].filter(x => x.Type == 4 && x.ComponentID == sComponentID && x.LeaveOthFeatures.Contains('#REJOIN#'));// LIKE '%#REJOIN#%'");
                                    if (drStr != null && drStr.length > 0) {

                                        let dtLT: any = BaseService.common.GetDataTable("DOC074", this.DocID.toString());

                                        let sLDocID = "0";
                                        let drcL: any;

                                        if (dtLT != null && dtLT.length > 0) {
                                            drcL = dtLT.filter(x => x.EmpSeqNo == sEmpID && x.LeaveComponentID == sComponentID);
                                            if (drcL != null && drcL.length > 0) {
                                                sLDocID = drcL[0]["DocID"].toString();

                                                if (drcL[0]["ReJoin"] != null && drcL[0]["ReJoin"].toString() != "") {
                                                    if (new Date(drcL[0]["ReJoin"]) != new Date(sRejoinDate)) {
                                                        this.DisplayMessage = "Cannot Post this Document...Rejoin date is changed";
                                                        this.MessageVisibility = true;
                                                        return;
                                                    }
                                                }
                                            }
                                        }

                                        if (BaseService.SessionManager.dtDocDefAccs != null) {
                                            drc = BaseService.SessionManager.dtDocDefAccs.filter(x => x.CostCenterID == 40065 && x.SysColumnName == 'ProductID');
                                            if (drc != null && drc.length > 0 && drc[0]["UserDefaultValue"] != null && drc[0]["UserDefaultValue"].toString().trim() != "")
                                                sProdID = drc[0]["UserDefaultValue"].toString();

                                            drc = BaseService.SessionManager.dtDocDefAccs.filter(x => x.CostCenterID == 40065 && x.SysColumnName == 'CreditAccount');
                                            if (drc != null && drc.length > 0 && drc[0]["UserDefaultValue"] != null && drc[0]["UserDefaultValue"].toString().trim() != "")
                                                sCrAccount = drc[0]["UserDefaultValue"].toString();

                                            drc = BaseService.SessionManager.dtDocDefAccs.filter(x => x.CostCenterID == 40065 && x.SysColumnName == 'DebitAccount');
                                            if (drc != null && drc.length > 0 && drc[0]["UserDefaultValue"] != null && drc[0]["UserDefaultValue"].toString().trim() != "")
                                                sDrAccount = drc[0]["UserDefaultValue"].toString();
                                        }


                                        sbL += "<LeaveAutoRejoin DocID=\"" + sLDocID + "\" DocDetIDs=\"" + "" + "\" WorkFlowID=\"" + 0 + "\" >";
                                        sbL += "<DOCXML>";
                                        sbL += "<RowHead/>";
                                        sbL += "<Row>";
                                        sbL += "<Transactions DocSeqNo=\"1\"  DocDetailsID=\"0\" LinkedInvDocDetailsID=\"0\" LinkedFieldName=\"\" IsScheme=\"\" ProductID=\"" + sProdID + "\" Quantity=\"1\" Unit=\"1\" UOMConversion=\"1\" UOMConvertedQty=\"1\" Rate=\"0\" Gross=\"\" RefNO=\"\" LineNarration=\"\" IsQtyIgnored=\"1\" AverageRate=\"0\" StockValue=\"0\" Net=\"0\" StockValueFC=\"0\" CurrencyID=\"1\" ExchangeRate=\"1.0\" CommonNarration=\"AutoPosted From Leave\"  DebitAccount=\"" + sDrAccount + "\"  CreditAccount=\"" + sCrAccount + "\"  ></Transactions>";
                                        sbL += "<Numeric Query=\"\" ></Numeric>";

                                        sbL += "<Alpha Query=\"dcAlpha1=N'" + sFromDate + "', dcAlpha2=N'" + sToDate + "', dcAlpha3=N'" + sRejoinDate + "', dcAlpha4=N'0', dcAlpha6=N'AutoRejoin', \" ></Alpha>";
                                        sbL += "<CostCenters Query=\"dcCCNID52=" + sComponentID + ", dcCCNID51=" + sEmpID + ", \" ></CostCenters>";
                                        sbL += "</Row>";
                                        sbL += "</DOCXML>";
                                        sbL += "</LeaveAutoRejoin>";

                                        if (sbL.length > 0) {
                                            // sbL.Insert(0, "<LRJ>");
                                            // sbL+="</LRJ>";
                                            sbL = "<LRJ>" + sbL + "</LRJ>";

                                            XML += sbL.toString();
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                //#endregion
            }




            let sAttachXML = (this.ViewAttachments != null) ? this.ViewAttachments.GetXML() : "";
            if (sAttachXML == "ERROR") {
                this.DisplayMessage = "Error Occurred while uploading the Attachments";
                this.MessageVisibility = true;
                return;
            }

            let sExtAttXML = this.ScreenObject.GetExtraAttachmentXML();
            if (sExtAttXML == "ERROR") {
                this.DisplayMessage = "Error Occurred while uploading the Attachments";
                this.MessageVisibility = true;
                return;
            }

            sAttachXML += sExtAttXML;

            if (this.savebulk) {
                alert('Bulk Save Pending')
                XML += args[10];
                XML += "</XML>";
                let ObjArray = [];
                ObjArray.push(args[0]);
                ObjArray.push(args[1]);
                ObjArray.push(args[2]);
                ObjArray.push(args[4]);
                ObjArray.push(args[5]);
                ObjArray.push(args[6]);
                ObjArray.push(args[7]);
                ObjArray.push(args[8]);
                let outObj = { stat: 0, RetVal: 0 };
                this.DisplayMessage = this.ScreenObject.SaveBulkInvDoc(ObjArray, (this.ViewNotes != null) ? this.ViewNotes.GetXML() : "", sAttachXML, this.DocumentDate, args[8], (this.AssignAddress != null) ? this.AssignAddress.GetXML() : "", XML,args[11], outObj);
                this.StatusID = outObj.stat;
                this.RetValue = outObj.RetVal;
            }
            else {
                XML += args[2];
                XML += args[4];
                XML += args[5];
                XML += args[6];
                XML += args[7];
                XML += args[8];
                XML += args[12];
                XML += args[13];
                XML += args[15];
                XML += args[16];
                XML += "</XML>";

                this.PrevDocID = this.ScreenObject.DocID;

                if (Util.IsEmpty(this.APIAddressXML)) {
                    if (this.AssignAddress != null) {
                        this.APIAddressXML = this.AssignAddress.GetXML();
                        if (this.AssignAddress.PrimMandatory && !this.APIAddressXML.Contains("TypeID=\"1\"")) {
                            this.DisplayMessage = "Primary Address Mandatory";
                            return;
                        }
                        if (this.AssignAddress.BillsMandatory && !this.APIAddressXML.Contains("TypeID=\"2\"")) {
                            this.DisplayMessage = "Billing Address Mandatory";
                            return;
                        }
                        if (this.AssignAddress.ShipMandatory && !this.APIAddressXML.Contains("TypeID=\"3\"")) {
                            this.DisplayMessage = "Shipping Address Mandatory";
                            return;
                        }
                    }
                    else
                        this.APIAddressXML = "";
                }
                this.ScreenObject.SaveInventoryDocument(args[0], args[1], (this.ViewNotes != null) ? this.ViewNotes.GetXML() : "", sAttachXML, this.DocumentDate, args[14], this.APIAddressXML, XML, args);
                this.APIAddressXML = "";
            }

            if (this.ScreenObject.DocumentType == 72 && !this.ReevaluateFutureVac && this.StatusID == 369) {
                this.ReevaluateFutureVacation();
            }

            // if (this.DocumentType == 67 && this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && !Util.IsEmpty(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"]) && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
            //     if (this.sBioErrLogs != null && this.sBioErrLogs.length > 0) {
            //         Util.WriteErrorsToFile(this.sBioErrLogs, "BiometricDocPostErrors");
            //         this.DisplayMessage = "Posted with Errors. Check for the Logs @ BiometricDocPostErrors.txt in application folder ";
            //         this.MessageVisibility = true;
            //     }
            // }

            this.MessageVisibility = true;
            //For Worksheet Data
            //if (IsMPVParent)
            //{
            //    this.DialogResult = true;
            //    ShellWindowViewModel.Instance().PopViewModel = null;
            //    return;
            //}
            if (this.IsFrmFS_LoanBal) {
                let dblAmt = 0;
                var fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                if (fldAPV != null && fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                    dblAmt = parseFloat(fldAPV.Text);
                }

                this.dFS_LoanAmt = dblAmt;
                this.DialogResult = true;
                BaseService.page.HideDialog(this.PopUpGUID);
                return;
            }
        }
    }

    SaveInventoryDocument_CallBack(args: any) {
        if (this.ScreenObject.Preferences.ContainsKey("AutoAttachDocumentPdf") && this.ScreenObject.Preferences["AutoAttachDocumentPdf"] != "" && parseBoolean(this.ScreenObject.Preferences["AutoAttachDocumentPdf"]) && this.RetValue > 0) {
            let sTempdis: any = this.DisplayMessage;

            this.Export(this.RetValue, "", false, -1, false, true);
            this.DisplayMessage = sTempdis;
        }
        this.Save_Completed();
        if (this.RetValue == -407 && parseBoolean(args[11])) {
            alert(this.DisplayMessage)
        }
    }

    // private string GetJoinFromVacationXML()
    // {
    //     string sb = "";
    //     sb+="<JoinFromVacationXML DocID=\""+""+"\" DocDetIDs=\""+""+"\" WorkFlowID=\""+0+"\" >";
    //     sb+="<DOCXML>";
    //     sb+="<RowHead/>";
    //     sb+="<Row>";
    //     sb+="<AccountsXML></AccountsXML>";
    //     sb+="<Transactions DocSeqNo=\""+1+"\"  DocDetailsID=\""+0+"\" LinkedInvDocDetailsID=\""+0+"\" LinkedFieldName=\""+""+"\" LineNarration=\""+""+"\" CommonNarration=\""+"CREATED FROM Leave Adjustment as Vacation Document")
    //                    +=("\" ProductID=\""+-100+"\" IsScheme=\""+""+"\" Quantity=\""+1+"\" Unit=\""+1+"\" UOMConversion=\""+1+"\" UOMConvertedQty=\""+1)
    //                   +=d("\" Rate=\""+0+"\" Gross=\""+0+"\" RefNO=\""+0+"\" IsQtyIgnored=\""+1+"\" AverageRate=\""+0)
    //                  +=nd("\" StockValue=\""+0+"\" StockValueFC=\""+0+"\" CurrencyID=\""+1+"\" ExchangeRate=\""+1+"\"  DebitAccount=\""+2+"\"  CreditAccount=\""+2+"\"  ></Transaction;

    //     sb+="<Numeric Query=\""+"\" ></Numeric>";
    //     sb+="<Alpha Query=\""+"dcAlpha1=N'" + Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy") + "',dcAlpha2=N'" + Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha3_Key"]).ToString("dd/MMM/yyyy") + "', dcAlpha2=N'" + Math.Abs(parseFloat(NetSalary.Text)) + "', dcAlpha4=N'1', dcAlpha3=N'" + Math.Abs(parseFloat(NetSalary.Text)) + "',dcAlpha5=N'" + BaseService.SessionManager.PayrollMonth.AddMonths(1).ToString("dd/MMM/yyyy") + "',dcAlpha7=N'" + BaseService.SessionManager.PayrollMonth.ToString("dd/MMM/yyyy") + "', "+"\" ></Alpha>";
    //     sb+="<CostCenters Query=\""+"dcCCNID51=" + SelectedEmpID + ", dcCCNID52=" + BaseService.SessionManager.Preferences["CreateLoanType"] + ", "+"\" ></CostCenters>";
    //     sb+="<EXTRAXML></EXTRAXML>";
    //     sb+="</Row>";
    //     sb+="</DOCXML>";
    //     sb+="<BillXML></BillXML></JoinFromVacationXML>";
    //     return sb;
    // }

    public ReevaluateFutureVacation() {
        let sEmpID = "";

        var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
        if (vFld != null && vFld != undefined) {
            if (vFld instanceof PactListBoxData)
                sEmpID = vFld.SelectedValue.toString();
            else if (vFld instanceof PactCodeNameListBoxData)
                sEmpID = vFld.SelectedValue.toString();
        }

        var fldAPV4 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
        if (fldAPV4 != undefined && fldAPV4 instanceof PactExtraFieldDateData && fldAPV4.Date.toString() != "") {

            let dt1: any = BaseService.common.GetDataTable("PAY080", sEmpID + "~" + fldAPV4.Date.ToString("dd/MMM/yyyy"));

            if (dt1 != null && dt1.length > 0) {
                if (this.ScreenObject.DocID > 0) {
                    let sResp: any = BaseService.common.ExecuteQuery_ReturnString("PAY081", this.ScreenObject.DocID.toString());
                    if (sResp.Trim().length > 0) {
                        this.DisplayMessage = "Error : " + sResp;
                        this.MessageVisibility = true;
                        return;
                    }
                }
                else
                    return;



                for (let i = 0; i < dt1.length; i++) {
                    let oDocument = new AddEditDocumentViewModel(40072, "Apply Vacation", true);
                    oDocument.ReevaluateFutureVac = true;
                    let ref_Ddate = { value: this._Ddate }
                    oDocument.ScreenObject.OnDocPrefixChanged("lostFocus", 0, parseInt(dt1[i]["DocID"]), ref_Ddate, true);
                    this._Ddate = ref_Ddate.value
                    oDocument.DimensionSelectedvalueData();

                    let VacGridDt: any = [];
                    VacGridDt = oDocument.ScreenObject.GridData.Copy();

                    var per = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha2");
                    if (per != null && per != undefined)
                        oDocument.onDateChanged(per);

                    var per1 = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha3");
                    if (per1 != null && per1 != undefined)
                        oDocument.onDateChanged(per);

                    //for(let k = 0; k < oDocument.ScreenObject.GridData.length; k++)
                    //{
                    //    for(let j = 0; j < VacGridDt.length; j++)
                    //    {
                    //        if (oDocument.ScreenObject.GridData[k]["dcAlpha20"].toString() == VacGridDt[j]["dcAlpha20"].toString())
                    //        {
                    //            oDocument.ScreenObject.GridData[k]["DocDetailsID"] = VacGridDt[j]["DocDetailsID"];
                    //            oDocument.ScreenObject.GridData[k]["Unit_key"] = 1;

                    //            if (parseFloat(oDocument.ScreenObject.GridData[k]["dcAlpha23"]) < 0)
                    //            {
                    //                oDocument.ScreenObject.GridData[k]["dcNum1"] = VacGridDt[j]["dcNum1"];
                    //                oDocument.ScreenObject.GridData[k]["dcCalcdcNum1"] = VacGridDt[j]["dcCalcdcNum1"];
                    //                oDocument.ScreenObject.GridData[k]["dcNum2"] = VacGridDt[j]["dcNum2"];
                    //                oDocument.ScreenObject.GridData[k]["dcCalcdcNum2"] = VacGridDt[j]["dcCalcdcNum2"];
                    //                oDocument.ScreenObject.GridData[k]["dcNum3"] = VacGridDt[j]["dcNum3"];
                    //                oDocument.ScreenObject.GridData[k]["dcCalcdcNum3"] = VacGridDt[j]["dcCalcdcNum3"];
                    //            }
                    //        }
                    //    }

                    //}

                    //bool isSaved = oDocument.SaveInventoryDocument("Save", true);
                    //if (!isSaved)
                    //{
                    //    DisplayMessage = " Reevaluate future vacation " + oDocument.DisplayMessage;
                    //    MessageVisibility = true;
                    //    return;
                    //}

                    let rCreditedDays = 0, rOpeningDays = 0, rRmdays = 0, rEnCashRmdays = 0, rExcessDays = 0, rPaidLeave = 0;

                    var val = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha7");
                    if (val != null && val != undefined && val instanceof PactTextBoxData)
                        rCreditedDays = parseFloat(val.Text);

                    val = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha22");
                    if (val != null && val != undefined && val instanceof PactTextBoxData)
                        rOpeningDays = parseFloat(val.Text);

                    val = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha12");
                    if (val != null && val != undefined && val instanceof PactTextBoxData)
                        rRmdays = parseFloat(val.Text);

                    val = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha14");
                    if (val != null && val != undefined && val instanceof PactTextBoxData && !Util.IsEmpty(val.Text))
                        rEnCashRmdays = parseFloat(val.Text);

                    val = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha11");
                    if (val != null && val instanceof PactTextBoxData && !Util.IsEmpty(val.Text))
                        rExcessDays = parseFloat(val.Text);

                    val = oDocument.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha10");
                    if (val != null && val != undefined && val instanceof PactTextBoxData && !Util.IsEmpty(val.Text))
                        rPaidLeave = parseFloat(val.Text);

                    let sResp: any = BaseService.common.ExecuteQuery_ReturnString("PAY082", rCreditedDays + "~" + rRmdays + "~" + rOpeningDays + "~" + rEnCashRmdays + "~" + rExcessDays + "~" + rPaidLeave + "~" + oDocument.ScreenObject.DocID.toString());

                    if (sResp.Trim().length > 0) {
                        this.DisplayMessage = "Error : " + sResp;
                        this.MessageVisibility = true;
                        return;
                    }

                    //ShellWindowViewModel.Instance().PopViewModel = (WorkspaceViewModel)oDocument;
                    //oDocument.ButtonCloseVisibility = true;
                    //oDocument.OKCancelVisibility = true;
                }
            }
        }
    }

    getQuery(): string {
        let sb = "";
        let sbNUm = "";
        let sbcc = "";
        let sbtext = "";

        let sbNUm1 = "";
        let sbcc1 = "";
        let sbtext1 = "";

        let sbNUmu = "";
        let sbccu = "";
        let sbtextu = "";

        for (let i = 0; i < this.ScreenObject.Data.Tables[0].length; i++) {
            let colName = this.ScreenObject.Data.Tables[0][i]["SysColumnName"].toLowerCase();
            if (colName.startsWith("dcnum")) {
                sbNUm += this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + ",";
                if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                    sbNUm += "dcCurrID" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + ",";
                    sbNUm += "dcExchRT" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + ",";
                    sbNUm += "dcCalcNumFC" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + ",";
                }
                sbNUm += "dcCalc" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dc", "") + ",";

                sbNUm1 += "X.value('@" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + "','Float'),";
                if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                    sbNUm1 += "X.value('@dcCurrID" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + "','Float'),";
                    sbNUm1 += "X.value('@dcExchRT" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + "','Float'),";
                    sbNUm1 += "X.value('@dcCalcNumFC" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + "','Float'),";
                }
                sbNUm1 += "X.value('@dcCalc" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dc", "") + "','Float'),";

                if (this.ScreenObject.DocID > 0) {
                    sbNUmu += this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + "=";
                    sbNUmu += "X.value('@" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + "','Float'),";
                    if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                        sbNUmu += "dcCurrID" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + "=";
                        sbNUmu += "X.value('@dcCurrID" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + "','Float'),";

                        sbNUmu += "dcExchRT" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + "=";
                        sbNUmu += "X.value('@dcExchRT" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + "','Float'),";

                        sbNUmu += "dcCalcNumFC" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + "=";
                        sbNUmu += "X.value('@dcCalcNumFC" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dcNum", "") + "','Float'),";
                    }
                    sbNUmu += "dcCalc" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dc", "") + "=";
                    sbNUmu += "X.value('@dcCalc" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].replace("dc", "") + "','Float'),";
                }

            }
            else if (colName.startsWith("dcalpha")) {
                sbtext += this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + ",";
                sbtext1 += "X.value('@" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + "','Nvarchar(max)'),";
                if (this.ScreenObject.DocID > 0) {
                    sbtextu += this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + "=";
                    sbtextu += "X.value('@" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + "','Nvarchar(max)'),";
                }
            }
            else if (colName.startsWith("dcCCNID")) {
                sbcc += this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + ",";
                //sbcc1 += "X.value('@" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + "','BIGINT'),";
                sbcc1 += "isnull(X.value('@" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].toString() + "','BIGINT'),1),";
                if (this.ScreenObject.DocID > 0) {
                    sbccu += this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + "=";
                    //sbccu += "X.value('@" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"] + "','BIGINT'),";
                    sbccu += "isnull(X.value('@" + this.ScreenObject.Data.Tables[0][i]["SysColumnName"].toString() + "','BIGINT'),1),";
                }
            }
        }

        sb += " NumCols=\"" + sbNUm.toString() + "\" ";
        sb += " TextCols=\"" + sbtext.toString() + "\" ";
        sb += " CCCols=\"" + sbcc.toString() + "\" ";
        sb += " NumSelCols=\"" + sbNUm1.toString() + "\" ";
        sb += " TextSelCols=\"" + sbtext1.toString() + "\" ";
        sb += " CCSelCols=\"" + sbcc1.toString() + "\" ";

        if (this.ScreenObject.DocID > 0) {
            sb += " NumUpdateCols=\"" + sbNUmu.toString() + "\" ";
            sb += " TextUpdateCols=\"" + sbtextu.toString() + "\" ";
            sb += " CCUpdateCols=\"" + sbccu.toString() + "\" ";
        }

        return sb;
    }

    ConvertHoursToMinutes(Totalhours: string): number {
        let TotalMinutes = 0;
        let minutes = 0, hours = 0;
        hours = Util.Int(Totalhours.split('.')[0]);
        if (Totalhours.split('.').length > 1) {
            minutes = Util.Int(Totalhours.split('.')[1]);
            //if (minutes.toString().length == 1)
            //{
            //    minutes = parseInt(minutes.toString() + "0");
            //}
        }
        TotalMinutes = hours * 60 + minutes;
        return TotalMinutes;
    }

    attendancePunchInfo = ''//used to send the xml to take the time from the sql server to punch(in and out)

    AccountingSave_DoWork(sender: any, args: any[]) {
        //sw.Start();
        //ProgressVisbility = true;
        //ProgressMax = 100;
        this.DisplayMessage = "Saving Document.Please wait...";
        this.ButtonsEnabled = false;
        //ProgressValue = 5;
        //System.Threading.Timer tt = new System.Threading.Timer(new System.Threading.TimerCallback(tick));
        //tt.Change(1000, 1000);
        if (args.length > 1) {
            let XML = "<XML ";
            if ((this.ScreenObject.Preferences.ContainsKey("UseAsLC") && this.ScreenObject.Preferences["UseAsLC"] != "" && parseBoolean(this.ScreenObject.Preferences["UseAsLC"]))
                || (this.ScreenObject.Preferences.ContainsKey("UseAsTR") && this.ScreenObject.Preferences["UseAsTR"] != "" && parseBoolean(this.ScreenObject.Preferences["UseAsTR"]))) {
                if (this.commandprarameter != null && (this.commandprarameter == "Approve" || this.commandprarameter == "NoWorkFlow"))
                    XML += " LCStatus=\"approved\"";
                else
                    XML += " LCStatus=\"open\"";
            }
            else if (this.commandprarameter != null && (this.commandprarameter == "Approve" || this.commandprarameter == "ApproveandPrint")) {
                XML += " AppRejDate=\"" + this.AppRejDate.Date.ToString("dd/MMM/yyyy") + "\"";
                XML += " Remarks=\"" + PactTextBoxData.GetValidXml(this.Remarks.Text) + "\"";

                if (this.IsLocked && BaseService.SessionManager.Preferences.ContainsKey("PostLockedDocs") && parseBoolean(BaseService.SessionManager.Preferences["PostLockedDocs"]))
                    XML += " LockedPosting=\"1\"";

                if (this.RecurDocsWithApproval.Visible)
                    XML += " RecurDocsWithApproval=\"" + (Util.IsEmpty(this.RecurDocsWithApproval.SelectedValue) ? "1" : this.RecurDocsWithApproval.SelectedValue) + "\"";
            }

            if ((this.commandprarameter != null && (this.commandprarameter == "NoWorkFlow" || this.commandprarameter == "NoWorkFlowprint"))
                || (this.ScreenObject.Preferences.ContainsKey("NoWorkflowPostedDocs") && this.ScreenObject.Preferences["NoWorkflowPostedDocs"] != "" && parseBoolean(this.ScreenObject.Preferences["NoWorkflowPostedDocs"])
                    && this.StatusID == 369))
                XML += " WorkFlow=\"NO\"";

            if (this.GenratePrefix)
                XML += " GenratePrefix=\"1\" ";

            XML += this.attendancePunchInfo + " SysInfo=\"" + BaseService.SessionManager.GetSysInfo() + "\"  AP=\"" + BaseService.SessionManager.GetAccessPoint() + "\" ";

            if (this.ScreenObject.Preferences.ContainsKey("CrossDimDocument") && this.ScreenObject.Preferences["CrossDimDocument"] != ""
                && Util.IsNum(this.ScreenObject.Preferences["CrossDimDocument"]) && parseInt(this.ScreenObject.Preferences["CrossDimDocument"]) > 40000)
                XML += " ChildWorkFlowID=\"" + this.GetWorkFlow(true, null) + "\"";

            if (!Util.IsEmpty(this.ScreenObject.guid)) {
                XML += " Guid=\"" + Util.String(this.ScreenObject.guid) + "\"";
            }

            XML += " CCGuid=\"" + Util.String(this.ScreenObject.CCguid) + "\"";

            //If it is recur document
            if (this.ScheduleID > 0) {
                XML += " ScheduleID=\"" + this.ScheduleID + "\"";
                XML += " SchGUID=\"" + this.SchGUID + "\"";
            }

            if (parseBoolean(args[1]))
                XML += " SaveUnapproved=\"1\"";


            if (!this.IsLockDimsLineWise && this.LockDims != null) {
                let outObj = { join: "" };
                XML += " LockDims=\"" + this.GetLockQuery(null, outObj) + "\" ";
                if (outObj.join != "")
                    XML += " LockDimsjoin=\"" + outObj.join + "\" ";
            }
            if (this.ScreenObject.RefCCId == 95 || this.ScreenObject.RefCCId == 104)
                XML += " IsRef=\"Yes\"";

            if (args.length > 3)
                XML += args[3];

            XML += " >";
            if (this.ViewActivities)
                XML += this.ViewActivities.ActivitiesXML();
            else
                XML += "<ScheduleActivityXml></ScheduleActivityXml>";

            if (!Util.IsEmpty(this.ScreenObject.HistoryCCXML))
                XML += "<History>" + this.ScreenObject.HistoryCCXML + "</History>";

            if (this.ScreenObject.GridDataColumns.Contains("FieldType"))
                XML += this.GetpaymentModes();

            XML += "</XML>";

            let sAttachXML = (this.ViewAttachments != null) ? this.ViewAttachments.GetXML() : "";
            sAttachXML += this.ScreenObject.GetExtraAttachmentXML();
            this.RetValue = 0;
            this.PrevDocID = this.ScreenObject.DocID;
            let message = "";
            this.ScreenObject.SaveAccountingDocument(args[0], (this.ViewNotes != null) ? this.ViewNotes.GetXML() : "", sAttachXML, XML, this.DocumentDate, args[2], this.IsReplaced).subscribe(
                (response: any) => {

                    this.RetValue = response.obj
                    let returnds = response
                    if (returnds != null && returnds.Tables.length > 0 && returnds.Tables[returnds.Tables.length - 1].length > 0 && returnds.Columns[returnds.Tables.length - 1].Contains("ErrorMessage"))
                        message = returnds.Tables[returnds.Tables.length - 1][0]["ErrorMessage"].toString();
                    else
                        message = "Problem in processing your request,Please contact administrator.";

                    if (this.RetValue > 0) {

                        if (returnds != null && returnds.Tables.length > 0 && returnds.Tables[returnds.Tables.length - 1].length > 0 && returnds.Columns[returnds.Tables.length - 1].Contains("VoucherNo")) {
                            this.ScreenObject.VoucherNo = returnds.Tables[returnds.Tables.length - 1][0]["VoucherNo"].toString();
                        }

                        this.ScreenObject.DocID = this.RetValue;
                        if (this.ScreenObject.DraftID > 0) {
                            BaseService.document.DeleteDocumentDraft(this.ScreenObject.DraftID);
                            this.ScreenObject.DraftID = 0;
                        }
                    }
                    this.DisplayMessage = message;
                    this.MessageVisibility = true;

                    if (this.ScreenObject.Preferences.ContainsKey("AutoAttachDocumentPdf") && this.ScreenObject.Preferences["AutoAttachDocumentPdf"] != "" && parseBoolean(this.ScreenObject.Preferences["AutoAttachDocumentPdf"]) && this.RetValue > 0) {
                        let sTempdis: any = this.DisplayMessage;

                        this.Export(this.RetValue, "", false, -1, false, true);
                        this.DisplayMessage = sTempdis;
                    }

                    this.Save_Completed();
                    Logger.InfoLog("VoucherGenerator:: Exiting SaveDocument");
                },
                (error) => {
                    console.log(error);
                    this.DisplayMessage = "Error in save"
                });
        }
    }

    GetpaymentModes(): string {
        let sb = "";
        if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key"))
            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"])) {
                    let drows = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == this.ScreenObject.GridData[i]["FieldType"]);
                    sb += "<XML Type=\"" + drows[0]["SectionID"].toString() + "\" Amount=\"" + this.ScreenObject.GridData[i]["Amount"].toString() + "\"   DBColumnName=\"" + this.ScreenObject.GridData[i]["FieldType"].toString() + "\" ";
                    if (this.ScreenObject.GridDataColumns.Contains("ChequeNumber"))
                        sb += " CardNo=\"" + this.ScreenObject.GridData[i]["ChequeNumber"].toString() + "\" ";
                    if (this.ScreenObject.GridDataColumns.Contains("ChequeBankName"))
                        sb += " CardName=\"" + this.ScreenObject.GridData[i]["ChequeBankName"].toString() + "\" ";
                    if (this.ScreenObject.GridDataColumns.Contains("ChequeDate_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ChequeDate_Key"]))
                        sb += " CardName=\"" + Util.ParseDate(this.ScreenObject.GridData[i]["ChequeDate_Key"]).ToString("dd/MMM/yyyy") + "\" ";

                    sb += " RegisterID=\"" + this.ScreenObject.RegisterNodeID + "\" ShiftID=\"" + this.ScreenObject.ShiftNodeID + "\" DocDate=\"" + this.DocumentDate.ToString("dd/MMM/yyyy") + "\" />";
                }
            }

        if (sb.length > 0) {
            sb = "<PosPayModes>" + sb + "</PosPayModes>";
        }
        return sb;
    }

    GetpayModesNumericData(rowno: number): string {
        let flds = "";
        if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key"))
            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["FieldType"])) {
                    if (rowno == i && !Util.IsEmpty(this.ScreenObject.GridData[i]["Amount"]))
                        flds += this.ScreenObject.GridData[i]["FieldType"].toString() + "=" + this.ScreenObject.GridData[i]["Amount"].toString() + "," + "dcCalc" + this.ScreenObject.GridData[i]["FieldType"].toString().replace("dc", "") + "=" + this.ScreenObject.GridData[i]["Amount"].toString() + ",";
                    else
                        flds += this.ScreenObject.GridData[i]["FieldType"].toString() + "=0," + "dcCalc" + this.ScreenObject.GridData[i]["FieldType"].toString().replace("dc", "") + "=0,";
                }
            }

        return flds;
    }

    GetLockQuery(dr: any, outObj: any): string {
        outObj.join = "";
        if (!this.IsLockDimsLineWise && dr != null)
            return "";
        else if (this.IsLockDimsLineWise && dr == null)
            return "";
        let i = 0;
        let Query = "";
        if (this.LockDims != null && this.LockDims.keys.length > 0) {
            this.LockDims.keys.forEach(key => {
                let item = { Key: key, Value: this.LockDims[key] }
                i++;
                if (item.Value) {
                    outObj.join += " left join " + this.ScreenObject.GetTableName(item.Key) + " CC" + i + " with(nolock) on C." + AddEditDocumentViewModel.GetPrimarkyKey(item.Key, true) + "=CC" + i + "." + AddEditDocumentViewModel.GetPrimarkyKey(item.Key) + `
                            left join ` + this.ScreenObject.GetTableName(item.Key) + " CJ" + i + " with(nolock) on CJ" + i + ".lft between CC" + i + ".lft and CC" + i + ".rgt";

                }

                if (item.Key > 50000) {
                    if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (item.Key - 50000)) && !Util.IsEmpty(dr["dcCCNID" + (item.Key - 50000) + "_Key"]))
                        Query += " and (" + (item.Value ? "CJ" + i + ".NodeID" : "c.ccnid" + (item.Key - 50000)) + " =" + dr["dcCCNID" + (item.Key - 50000) + "_Key"].toString() + " or c.ccnid" + (item.Key - 50000) + "=0)";
                    else {
                        let fld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid" + (item.Key - 50000));
                        if (fld && fld instanceof PactListBoxData && fld.SelectedValue > 0)
                            Query += " and (" + (item.Value ? "CJ" + i + ".NodeID" : "c.ccnid" + (item.Key - 50000)) + " =" + fld.SelectedValue.toString() + " or c.ccnid" + (item.Key - 50000) + "=0)";
                        else
                            Query += " and c.ccnid" + (item.Key - 50000) + "=0";
                    }
                }
                else if (item.Key == 2) {
                    let acc = "0";

                    if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(dr["DebitAccount_Key"]))
                        acc += "," + dr["DebitAccount_Key"].toString();
                    if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(dr["CreditAccount_Key"]))
                        acc += "," + dr["CreditAccount_Key"].toString();

                    if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(dr["AccountID_Key"]))
                        acc += "," + dr["AccountID_Key"].toString();

                    if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0)
                        acc += "," + this.ScreenObject.CreditAccount.SelectedValue.toString();

                    if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0)
                        acc += "," + this.ScreenObject.DebitAccount.SelectedValue.toString();

                    if (!this.IsLockDimsLineWise && this.IsInventoryVoucher && this.BillWisedt != null && this.BillWisedt.length > 0) {
                        for (let a = 0; a < this.BillWisedt.length; a++) {
                            if (!Util.IsEmpty(this.BillWisedt[a]["AccountID"]) && !Util.IsEmpty(this.BillWisedt[a]["Amount"]) && parseFloat(this.BillWisedt[a]["Amount"].toString()) > 0) {
                                acc += "," + this.BillWisedt[a]["AccountID"].toString();
                            }
                        }
                    }

                    Query += " and (" + (item.Value ? "CJ" + i : "c") + ".AccountID in(" + acc + ") or c.AccountID=0)";
                }
                else if (item.Key == 3 && this.IsInventoryVoucher && dr != null)
                    Query += " and (" + (item.Value ? "CJ" + i : "c") + ".ProductID =" + dr["ProductID_Key"].toString() + " or c.ProductID=0)";
                else if (item.Key == 400)
                    Query += " and DocumentID in(" + this.CostCenterID.toString() + ",1)";
            });
        }
        return Query.toString();
    }
    SetLockDims() {
        if (BaseService.SessionManager.Preferences["UseDimWiseLock"].toLowerCase() == "true" && BaseService.SessionManager.Preferences["DimensionWiseLockData Customize Screen"] != ""
            && BaseService.SessionManager.Preferences["DimensionWiseLockData Customize Screen"] != "<XML></XML>") {
            this.ScreenObject.LockWhere = "";

            let where = "", join = "";
            this.LockDims = new DictionaryNumKey<boolean>();
            let cc = 0, i = 0;
            let Ldoc = new XmlDocument();
            Ldoc.LoadXml(BaseService.SessionManager.Preferences["DimensionWiseLockData Customize Screen"]);
            Ldoc.SelectNodes("XML/Row").forEach(item => {
                if (item.attributes["ID"] != null && !Util.IsEmpty(item.attributes["ID"].value)) {
                    i++;
                    let isgroupExists = false;
                    cc = parseInt(item.attributes["ID"].value);
                    if (cc > 50000 && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (cc - 50000)))
                        this.IsLockDimsLineWise = true;
                    else if (cc == 2 && (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") || this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")
                        || this.ScreenObject.GridDataColumns.Contains("AccountID_Key")))
                        this.IsLockDimsLineWise = true;
                    else if (cc == 3 && this.IsInventoryVoucher)
                        this.IsLockDimsLineWise = true;

                    if (this.ScreenObject.Data.Tables.length > 2 && this.ScreenObject.Data.Tables[2].length > 0 &&
                        this.ScreenObject.Data.Tables[2].filter(x => x.DefType == 3 && x.CostCenterID == cc && x.isgroupExists == 1).length > 0)
                        isgroupExists = true;

                    this.LockDims.push(cc, isgroupExists);

                    if (isgroupExists) {
                        join += " left join " + this.ScreenObject.GetTableName(cc) + " CC" + i + " with(nolock) on C." + AddEditDocumentViewModel.GetPrimarkyKey(cc, true) + "=CC" + i + "." + AddEditDocumentViewModel.GetPrimarkyKey(cc) + `
                            left join ` + this.ScreenObject.GetTableName(cc) + " CJ" + i + " with(nolock) on CJ" + i + ".lft between CC" + i + ".lft and CC" + i + ".rgt";

                        if (cc > 50000)
                            where += " and (b.dcCCNID" + (cc - 50000) + "=CJ" + i + ".NodeID or c.CCNID" + (cc - 50000) + "=0)";
                        else if (cc == 3 && this.IsInventoryVoucher)
                            where += " and (a.ProductID=CJ" + i + ".ProductID or c.ProductID=0)";
                        else if (cc == 2)
                            where += " and (a.DebitAccount=CJ" + i + ".AccountID or a.CreditAccount=CJ" + i + ".AccountID or c.AccountID=0)";
                    }
                    else {
                        if (cc > 50000)
                            where += " and (b.dcCCNID" + (cc - 50000) + "=c.CCNID" + (cc - 50000) + " or c.CCNID" + (cc - 50000) + "=0)";
                        else if (cc == 3 && this.IsInventoryVoucher)
                            where += " and (a.ProductID=c.ProductID or c.ProductID=0)";
                        else if (cc == 2)
                            where += " and (a.DebitAccount=c.AccountID or a.CreditAccount=c.AccountID or c.AccountID=0)";
                        else if (cc == 400)
                            where += " and (a.CostCenterID=c.DocumentID or c.DocumentID=1)";
                    }
                }
            });
            if (join != "")
                this.ScreenObject.LockWhere = "<XML where=\"" + where + "\" join=\"" + join + "\"></XML>";
            else
                this.ScreenObject.LockWhere = where;
        }
    }
    /**
        System.Diagnostics.Stopwatch sw = new System.Diagnostics.Stopwatch();
    **/
    SaveCallBackMethod = new Delegate();
    Save_Completed()//object sender, RunWorkerCompletedEventArgs e)
    {/**
        Logger.PerfLog("      PERF :::: Document Saving LOAD TIME FOR CostCenterid:" + this.CostCenterID + " :::: " + sw.Elapsed.toString());
        sw.Stop();**/
        if (this.SaveCallReq.sender == "ReSave") {
            this.SaveComplete(false);
        }
        else
            this.SaveComplete(this.SaveCallReq.Validate);
        if (this.SaveCallBackMethod)
            setTimeout(() => { this.SaveCallBackMethod.Call(); }, 20)
    }

    ReSaveLinkedDocs() {
        let ds: any = BaseService.common.GetDataSet("DOC061", this.RetValue.toString());
        {
            let objViewModel: AddEditDocumentViewModel = null;
            for (let i = 0; i < ds.Tables[0].length; i++) {
                if (objViewModel == null || objViewModel.CostCenterID != parseInt(ds.Tables[0][i]["Costcenterid"].toString()))
                    objViewModel = new AddEditDocumentViewModel(parseInt(ds.Tables[0][i]["Costcenterid"].toString()), '', true);

                objViewModel.ScreenObject.DocID = parseInt(ds.Tables[0][i]["docid"].toString());
                let DS: any = objViewModel.ScreenObject.GetEditDataByDOCID();
                if (DS != null && DS.Tables.length > 0 && DS.Tables[0].length > 0 && DS.Columns[0].Contains("DocPrefix")) {
                    if (objViewModel.ScreenObject.DocPrefix.ComboBox != null && objViewModel.ScreenObject.DocPrefix.ComboBox.Items != null) {
                        var exists = objViewModel.ScreenObject.DocPrefix.ComboBox.Items.find(a => a.Value == DS.Tables[0][0]["DocPrefix"].toString());
                        if (exists == null) {
                            objViewModel.ScreenObject.DocPrefix.ComboBox.Items.push(ComboBoxItems.ComboBoxItems_2(DS.Tables[0][0]["DocPrefix"].toString(), DS.Tables[0][0]["DocPrefix"].toString()));
                        }
                    }
                    if (objViewModel.ScreenObject.DocPrefix.TextBox != null) {
                        objViewModel.ScreenObject.DocPrefix.TextBox.Text = DS.Tables[0][0]["DocNumber"].toString();
                    }
                }
                objViewModel.ScreenObject.LoadEditData(DS, false);

                if (!Util.IsEmpty(DS.Tables[0][0]["DocDate"]))
                    objViewModel.DocumentDate = Util.ParseDate(DS.Tables[0][0]["DocDate"]);
                if (!Util.IsEmpty(DS.Tables[0][0]["VoucherNo"]))
                    objViewModel.ScreenObject.VoucherNo = DS.Tables[0][0]["VoucherNo"].toString();
                if (!Util.IsEmpty(DS.Tables[0][0]["GUID"]))
                    objViewModel.ScreenObject.guid = DS.Tables[0][0]["GUID"].toString();
                if (DS.Columns[0].Contains("RefNodeid") && !Util.IsEmpty(DS.Tables[0][0]["RefNodeid"]))
                    objViewModel.ScreenObject.RefNodeID = parseInt(DS.Tables[0][0]["RefNodeid"].toString());
                if (DS.Columns[0].Contains("RefCCId") && !Util.IsEmpty(DS.Tables[0][0]["RefCCId"]))
                    objViewModel.ScreenObject.RefCCId = parseInt(DS.Tables[0][0]["RefCCId"].toString());

                if (DS.Tables.length > 1 && DS.Tables[1].length > 0) {
                    if (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True" && !Util.IsEmpty(DS.Tables[1][0]["dcCCNID2"]))
                        objViewModel.ScreenObject.LocationID = parseInt(DS.Tables[1][0]["dcCCNID2"].toString());

                    if (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True" && !Util.IsEmpty(DS.Tables[1][0]["dcCCNID1"]))
                        objViewModel.ScreenObject.DivisionID = parseInt(DS.Tables[1][0]["dcCCNID1"].toString());
                }
                for (let j = 0; j < objViewModel.ScreenObject.GridData.length; j++) {
                    if (!Util.IsEmpty(objViewModel.ScreenObject.GridData[j]["ProductID_Key"])) {
                        objViewModel.CalculateTotals(objViewModel.ScreenObject.GridData[j], true);
                    }
                }
                objViewModel.RetValue = 0;

                objViewModel.SaveInventoryDocument("NoWorkFlowReSave", false, false, null, false, false);
            }
        }
    }

    callbacksubject = new Subject<any>();
    async SaveComplete(Validate: boolean) {
        this.ButtonsEnabled = true;
        if (this.RetValue > 0 || this.RetValue < -10000) {
            if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "API"))
                this.GenerateAPIRequest(9);
            this.ScreenObject.IsDirty = false;
            if (this.IsExpressionAvailable("ServerDate")) {
                let ds: any = BaseService.common.GetDataSet("DOC001", "")
                if (ds != null && ds.Tables.length > 0 && !ds.Columns[0].Contains("ErrorMessage") && ds.Tables[0].length > 0 && this.fldDict != null) {
                    this.fldDict["ServerDate"].setFieldValue(ds.Tables[0][0]["dt"].toString());
                    this.FooterDics["ServerDate"].setFieldValue(ds.Tables[0][0]["dt"].toString());
                }
            }
            this.SetVisibiltiFalse();
            if (!this.IsPOs)
                this.SetDefaultRightPanel();

            if (this.ChequeBook != null) {
                this.ChequeBook.Items.Clear();
                this.ChequeBook.SelectedValue = "";
            }

            if (this.ScheduleID > 0)//To change document recurring event status
            {
                if (this["objGeneralDashboard"])
                    this["objGeneralDashboard"].RefreshData();
                this.ScheduleID = 0;
                this.RecurDocumentVoucherNo = "";
            }
            if (this.ScreenObject.Preferences.ContainsKey("ReSaveLinkDoc") && this.ScreenObject.Preferences["ReSaveLinkDoc"] == "True")
                this.ReSaveLinkedDocs();
            if (this.ScreenObject.Preferences.ContainsKey("Open Cash Drawer") && this.ScreenObject.Preferences["Open Cash Drawer"] == "True") {
                if (this.ScreenObject.Data.Tables.length > 18 && this.ScreenObject.Data.Tables[18].length > 0) {
                    let drRow = this.ScreenObject.Data.Tables[18][0];
                    if (this.ScreenObject.RegisterNodeID > 0) {
                        let drRows = this.ScreenObject.Data.Tables[18].filter(x => x.NodeID == this.ScreenObject.RegisterNodeID);
                        if (drRows.length > 0 && !Util.IsEmpty(drRows[0]["CashDrawerName"]) && !Util.IsEmpty(drRows[0]["CashDrawerCommand"]))
                            this.OpenCashDrawer(drRows[0]["CashDrawerName"].toString(), drRows[0]["CashDrawerCommand"].toString());
                        else
                            return;
                    }
                    else if (drRow != null) {
                        this.OpenCashDrawer(drRow["CashDrawerName"].toString(), drRow["CashDrawerCommand"].toString());
                    }
                }
            }

            if (this.SaveCallReq.sender == "Approve" || this.SaveCallReq.sender == "ApproveandPrint")
                BaseService.SessionManager.RefreshNotification();

            if (this.ScreenObject.IsResave != 3 && Validate && this.StatusID == 369 && this.ScreenObject.Preferences.ContainsKey("PostVoucherDocument") && this.ScreenObject.Preferences["PostVoucherDocument"] != "" && Util.IsNum(this.ScreenObject.Preferences["PostVoucherDocument"])
                && parseInt(this.ScreenObject.Preferences["PostVoucherDocument"]) > 40000) {
                let CanPostDoc = true;
                if (this.ScreenObject.Preferences.ContainsKey("PostDocumentCondition") && this.ScreenObject.Preferences["PostDocumentCondition"] != "") {
                    CanPostDoc = false;
                    try {
                        let temp = this.fldDict;
                        let result = BaseService.eval.EvaluateExpression(this.ScreenObject.Preferences["PostDocumentCondition"], temp).toString();
                        if (result != null && result.toString() == "1")
                            CanPostDoc = true;
                    }
                    catch {

                    }
                }

                if (CanPostDoc) {
                    let accid = 0; let amt = 0;
                    if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 39 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 6 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 13) {
                        if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0)
                            accid = this.ScreenObject.CreditAccount.SelectedValue;
                    }
                    else if (this.ScreenObject.DocumentType == 11 || this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 5 || this.ScreenObject.DocumentType == 7 || this.ScreenObject.DocumentType == 9 || this.ScreenObject.DocumentType == 24 || this.ScreenObject.DocumentType == 33 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 8 || this.ScreenObject.DocumentType == 12) {
                        if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0)
                            accid = this.ScreenObject.DebitAccount.SelectedValue;
                    }
                    let CurrID = 1; let ExhgRate = 1; let IsBillwise = false;
                    if (this.Currency != null && !Util.IsEmpty(this.Currency.Currency.SelectedValue))
                        CurrID = parseInt(this.Currency.Currency.SelectedValue);
                    if (this.Currency != null && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
                        ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);

                    for (let a = 0; a < this.BillWisedt.length; a++) {
                        if (!Util.IsEmpty(this.BillWisedt[a]["AccountID"]) && !Util.IsEmpty(this.BillWisedt[a]["Amount"]) && parseInt(this.BillWisedt[a]["AccountID"]) == accid) {
                            amt = parseFloat(this.BillWisedt[a]["Amount"]);
                            if (!Util.IsEmpty(this.BillWisedt[a]["CurrencyID"]))
                                CurrID = parseInt(this.BillWisedt[a]["CurrencyID"]);
                            if (!Util.IsEmpty(this.BillWisedt[a]["ExchangeRate"]))
                                ExhgRate = parseFloat(this.BillWisedt[a]["ExchangeRate"]);

                            if (!Util.IsEmpty(this.BillWisedt[a]["XML"])) {
                                IsBillwise = true;

                                let xDoc = new XmlDocument();
                                xDoc.LoadXml("<BillWise> " + this.BillWisedt[a]["XML"].toString() + "</BillWise> ");

                                let xList = xDoc.SelectNodes("BillWise/Row");
                                let val = 0;
                                for (let x = 0; x < xList.length; x++) {
                                    if (xList[x].attributes["AmountFC"].value != "" && xList[x].attributes["IsNewReference"].value == "0")
                                        val += parseFloat(xList[x].attributes["AmountFC"].value.replace("-", ""));
                                }
                                amt = amt - val;
                            }
                        }
                    }
                    if (amt > 0 && accid > 0) {
                        let pvs = new PostVoucherSaveViewModel(this, parseInt(this.ScreenObject.Preferences["PostVoucherDocument"]), amt, accid, CurrID, ExhgRate, IsBillwise, false)
                        if (this.ScreenObject.Preferences.ContainsKey("DisplayBeforepost") && this.ScreenObject.Preferences["DisplayBeforepost"] != "" && parseBoolean(this.ScreenObject.Preferences["DisplayBeforepost"]))
                            BaseService.page.ShowDialog(pvs, PostVoucherSaveComponent);
                        else {
                            pvs.OnButtonClick("OK");
                            this.DisplayMessage = this.DisplayMessage + "\n" + pvs.DisplayMessage;
                        }
                    }
                }
            }

            if (this.ScreenObject.GridDataColumns.Contains("NextStageID"))
                this.OpenNextStage();

            for (let h = 0; h < this.Shortcuts.length; h++) {
                if (this.Shortcuts[h] instanceof DgColumn && this.Shortcuts[h].Mode == 6 && this.ScreenObject.GridData.length > 0 && this.ValidateData_Column(this.Shortcuts[h] as DgColumn, this.ScreenObject.GridData[0], true))
                    this.ScreenObject.GetExternalFuncData(this.Shortcuts[h].Mode, this.Shortcuts[h].SPName, this.Shortcuts[h].IPParams, this.Shortcuts[h].OPParams, this.ScreenObject.GridData[0], true);
                else if (this.Shortcuts[h] instanceof PactControlData && this.Shortcuts[h].Mode == 6)
                    this.ScreenObject.GetExternalFuncData(this.Shortcuts[h].Mode, this.Shortcuts[h].ToolTipFooterTitle, this.Shortcuts[h].ToolTipFooterDescription, this.Shortcuts[h].ToolTipDescription, null, true);
            }
            //Added on 07-Feb-2017
            if (!Util.IsEmpty(this.ScreenObject.ExternalFuncErrorMessage)) {
                this.DisplayMessage = this.DisplayMessage + "\r\n " + this.ScreenObject.ExternalFuncErrorMessage;
            }

            if (this.SaveCallBack != null)
                this.SaveCallBack.Call({ CostCenterID: this.ScreenObject.CostCenterID, DocID: this.ScreenObject.DocID });
            if (this.commandprarameter == "SaveAndPrint" || this.commandprarameter == "ApproveandPrint" || this.commandprarameter == "NoWorkFlowprint") {
                let msgprint = "";
                let selPrn = "Default";
                if (BaseService.SessionManager.selectedPrinter == "Always ask") {
                    let PrList = new PrinterList();
                    const { POSRegisterComponent } = await import('../../pos/POSRegister/register.component');
                    await BaseService.page.openDialog(PrList, POSRegisterComponent, { HideClose: true, ShowCenter: true, Title: BaseService.GetResource("Select Printer") });
                    selPrn = PrList.SelectedPrinter;
                }
                else {
                    selPrn = BaseService.SessionManager.selectedPrinter;
                }

                if (this.commandprarameter == "SaveAndPrint" && selPrn == "Bluetooth") {

                    try {
                        await this.StartBluetoothPrint(this.ScreenObject.DocID);
                    }
                    catch (error) {
                    }
                }
                else {
                    msgprint = await this.PrintVoucher(false, this.ScreenObject.DocID.toString(), true, null)
                }
                this.DisplayMessage = this.DisplayMessage + "\r\n " + msgprint;


            }
            /***
                        if (this.commandprarameter == "SaveAndBarcode")
                        {
                            this.DisplayMessage = this.DisplayMessage + "\r\n " + PrintBarcode(this.ScreenObject.DocID.toString(), null);
                        }***/

            // Bid Extension count.
            if (this.IsReverseBidding && this.AutoExtendBeforeMin != 0 && this.MinToExtend != 0 && this.MaxExtensions != 0) {
                if (this.MaxExtensionCount < this.MaxExtensions) {
                    //this.MaxExtensionCount = this.MaxExtensionCount + 1;
                    if (this.CheckMinutsBeforeTime <= this.AutoExtendBeforeMin) {
                        let dsBid = BaseService.common.GetDataSet3("DOC092", this.parentBiddingDocID.toString(),
                            this.RetValue.toString(), this.BidEndTime);
                    }
                }
            }

            if (this.ScreenObject.IsResave != 3 && !this.IgnoreOnSave.ContainsKey("PostVoucherSave")) {
                if (this.ScreenObject.Preferences.ContainsKey("onSaveNextVoucher") && parseBoolean(this.ScreenObject.Preferences["onSaveNextVoucher"])) {
                    let Message = this.DisplayMessage;
                    this.GetData("NEXT");
                    this.DisplayMessage = Message;
                }
                else if (this.ScreenObject.Preferences.ContainsKey("ShowCurrentPostedVoucher") && parseBoolean(this.ScreenObject.Preferences["ShowCurrentPostedVoucher"])) {
                    let Message = this.DisplayMessage;
                    let ref_Ddate = { value: this._Ddate }
                    this.ScreenObject.OnDocPrefixChanged("lostFocus", 1, 0, ref_Ddate, true);
                    this.DocumentDate = ref_Ddate.value
                    this.QuickInfoVisibility = false;
                    this.DQuickInfoVisibility = false;
                    this.DisplayMessage = Message;
                }
                else {
                    if (this.IsPOs && this.PrevDocID == 0) {
                        let Prefixlength = 0;

                        if (this.ScreenObject.DocPrefix.ComboBox.SelectedItem != null && this.ScreenObject.DocPrefix.ComboBox.SelectedItem.Aliasname != "")
                            Prefixlength = parseInt(this.ScreenObject.DocPrefix.ComboBox.SelectedItem.Aliasname);

                        let number = (parseInt(this.ScreenObject.DocPrefix.TextBox.Text) + 1).toString();
                        while (number.length < Prefixlength) {
                            number = "0" + number;
                        }
                        this.ScreenObject.DocPrefix.TextBox.Text = number;
                    }
                    else {
                        let ref_Ddate = { value: this._Ddate }
                        this.ScreenObject.OnDocPrefixChanged(this.ScreenObject.Prefix, 0, 0, ref_Ddate, false);
                        this._Ddate = ref_Ddate.value

                        if (this.AutoPostViewModel != null) {
                            ref_Ddate = { value: this.AutoPostViewModel._Ddate }
                            this.AutoPostViewModel.ScreenObject.OnDocPrefixChanged(this.AutoPostViewModel.ScreenObject.Prefix, 0, 0, ref_Ddate, false);
                            this.AutoPostViewModel._Ddate = ref_Ddate.value
                        }
                    }
                    //#region POS Last bill amount Detail based on prefrencess and Return amount is greaterthan zero.
                    if (this.RetValue > 0 && this.POSPayModes != null && this.POSPayModes.Return != "" && parseFloat(this.POSPayModes.Return) > 0 && this.ScreenObject.Preferences.ContainsKey("ShowLastBillDetailsIfCashReturnExist") && this.ScreenObject.Preferences["ShowLastBillDetailsIfCashReturnExist"] != "" && parseBoolean(this.ScreenObject.Preferences["ShowLastBillDetailsIfCashReturnExist"])) {
                        const { POSLastBillDetailsComponent } = await import('../poslast-bill-details/poslast-bill-details.component')
                        const { POSLastBillDetailsViewModel } = await import('../poslast-bill-details/POSLastBillDetailsViewModel')
                        let POSLastBill = new POSLastBillDetailsViewModel();
                        POSLastBill.VoucherNo = this.ScreenObject.VoucherNo;
                        POSLastBill.BillAmount = this.POSPayModes.NetAmount;
                        POSLastBill.PaidAmount = this.POSPayModes.paidAmount;
                        POSLastBill.CashReturn = this.POSPayModes.Return;
                        BaseService.page.ShowDialog(POSLastBill, POSLastBillDetailsComponent, { ShowCenter: true, Title: "Last Bill Details" });
                    }
                    //#endregion
                    this.clear(2);
                    this.ScreenObject.GridDataObj.UpdateFooter();
                    if (this.ClassName == "POSDocumentViewModel" || BaseService.SessionManager.Preferences.ContainsKey("DisableAutoLoad") && BaseService.SessionManager.Preferences["DisableAutoLoad"].toLowerCase() == "true")
                        this.ScreenObject.FillListViews(false);
                }
            }
            this.PoleDisplayMessage(1, null);

            if (this.ScreenObject.IsResave == 3)
                BaseService.page.HideDialog(this.PopUpGUID);

            //Bidding Document Updating IsBidRevision, BidType and inserting value in COM_BidPriceDetails    
            if (this.parentBiddingDocID > 0) {

                let strRank = "";
                if (this.ReverseBiddingDocDetailsID > 0 && this.BidEvaluationType == "Line item wise") {
                    //BidRankSysColName

                    let dsBid = BaseService.common.GetDataSet3("DOC083", this.parentBiddingDocID.toString(), this.BidProductID_Key.toString(), "");
                    if (dsBid != null && dsBid.Tables.length > 0 && dsBid.Tables[0].length > 0) {
                        //dsBid.Tables[0].sort((a, b) => a.Rate - b.Rate);

                        let CurrentRank = 1;
                        let PreviousAmount = "";

                        let dv = dsBid.Tables[0].filter(x => x.DocSeqNo == this.BidDocSeqNo);
                        for (let i = 0; i < dv.length; i++) {
                            if (PreviousAmount == "" || PreviousAmount != Util.String(dv[i]["Rate"])) {
                                PreviousAmount = Util.String(dv[i]["Rate"]);
                                if (i !== 0)
                                    CurrentRank++;
                            }
                            let iRateCount = dv.filter(x => x.Rate == Util.String(dv[i]["Rate"]));
                            if (iRateCount.length == 1) {
                                dv[i]["Rank"] = "L" + CurrentRank;// + " (" + 1 + ")";
                            }
                            else
                                dv[i]["Rank"] = "L" + CurrentRank + " (" + iRateCount.length + ")";
                        }
                        let RankData = dv.filter(x => x.DocID == this.RetValue);
                        if (RankData.length > 0) {
                            strRank = RankData[0]["Rank"];
                        }
                    }
                    dsBid = BaseService.common.GetDataSet3("DOC085", this.ReverseBiddingDocDetailsID.toString(),
                        this.BidRankSysColName, strRank
                    );
                }



                if (this.isBidding) {

                    let Message = this.DisplayMessage;
                    let ref_Ddate = { value: this._Ddate }
                    this.ScreenObject.OnDocPrefixChanged("lostFocus", 1, this.RetValue, ref_Ddate, true);
                    //this.ScreenObject.OnDocPrefixChanged("lostFocus", 1,  0, ref_Ddate, true);
                    this.DocumentDate = ref_Ddate.value
                    this.QuickInfoVisibility = false;
                    this.DQuickInfoVisibility = false;
                    this.DisplayMessage = Message;
                    if (this.BidType == 4 && this.BidEvaluationType == "Line item wise") {
                        let rateDr = this.ScreenObject.GridData.find(x => x.DocDetailsID == this.ReverseBiddingDocDetailsID);
                        if (rateDr) {
                            let dsBid = BaseService.common.GetDataSet3("DOC079", this.parentBiddingDocID.toString() + "~" + this.RetValue.toString()
                                + "~" + this.parentMRDocID.toString() + "~" + this.BidPreviousRank.toString() + "~" + strRank,
                                this.ReverseBiddingDocDetailsID + "~" + rateDr["Rate"], BaseService.SessionManager.UserName + "~" + this.BidType);
                        }
                    }

                    if (this.BidEvaluationType == "Basket Price") { //If EvaluationType is "Basket Price" then updating rank in linewise and inserting record in Com_BidPriceDetails
                        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                            const dr = this.ScreenObject.GridData[i];

                            if (!Util.IsEmpty(dr["ProductID_Key"])) {
                                let dsBid = BaseService.common.GetDataSet3("DOC083", this.parentBiddingDocID.toString(), dr["ProductID_Key"].toString(), "");
                                if (dsBid != null && dsBid.Tables.length > 0 && dsBid.Tables[0].length > 0) {
                                    let CurrentRank = 1;
                                    let PreviousAmount = "";

                                    let dv = dsBid.Tables[0].filter(x => x.DocSeqNo == dr["DocSeqNo"]);
                                    for (let i = 0; i < dv.length; i++) {
                                        if (PreviousAmount == "" || PreviousAmount != Util.String(dv[i]["Rate"])) {
                                            PreviousAmount = Util.String(dv[i]["Rate"]);
                                            if (i !== 0)
                                                CurrentRank++;
                                        }
                                        let iRateCount = dv.filter(x => x.Rate == Util.String(dv[i]["Rate"]));
                                        if (iRateCount.length == 1) {
                                            dv[i]["Rank"] = "L" + CurrentRank;// + " (" + 1 + ")";
                                        }
                                        else
                                            dv[i]["Rank"] = "L" + CurrentRank + " (" + iRateCount.length + ")";
                                    }
                                    let RankData = dv.filter(x => x.DocID == this.RetValue);
                                    if (RankData.length > 0) {
                                        strRank = RankData[0]["Rank"];
                                    }
                                }
                                dsBid = BaseService.common.GetDataSet3("DOC085", dr["DocDetailsID"].toString(),
                                    this.BidRankSysColName, strRank
                                );

                                let rateDr = this.ScreenObject.GridData.find(x => x.DocDetailsID == dr["DocDetailsID"]);
                                if (rateDr) {
                                    let dsBid = BaseService.common.GetDataSet3("DOC079", this.parentBiddingDocID.toString() + "~" + this.RetValue.toString()
                                        + "~" + this.parentMRDocID.toString() + "~" + Util.String(dr[this.BidRankSysColName]) + "~" + strRank,
                                        dr["DocDetailsID"] + "~" + rateDr["Rate"], BaseService.SessionManager.UserName + "~" + this.BidType);
                                }

                                dr[this.BidRankSysColName] = strRank;
                                this.ScreenObject.GridDataObj.updateRow(dr)
                            }
                        }
                    }
                }
                if (BaseService.SessionManager.RoleType == 2) {
                    this.parentRptRefresh.OnButtonClick("Refresh")
                }
            }

            // let dsBid = BaseService.common.GetDataSet3("DOC081", Util.Double(this.BiddingGrid.SelectedItem["NewRate"]).toString(), this.BiddingGrid.SelectedItem["DocDetailsID"].toString()
            //     , BaseService.SessionManager.UserName);
        }
        else {
            if (Validate) {
                if (this.DisplayMessage == "Problem in processing your request, Please contact administrator.") {
                    if (confirm("Do you want to report issue?"))
                        BaseService.page.ShowDialog(new SendEmailSMSViewModel(true, -999, 0, null), SendEmailSMSComponent);
                }
            }
        }
        this.commandprarameter = "";
        this.IgnoreOnSave.Clear();

        if (this.callbacksubject != undefined)
            this.callbacksubject.next('');

    }

    SelectedPrinter: string;
    OpenNextStage() {
        let cnt = 0;
        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["NextStageID"])) {
                cnt++;
                break;
            }
        }

        if (cnt > 0 && this.ScreenObject.Preferences["Autopostdocument"] != "") {
            let ExcessDoc = new AddEditDocumentViewModel(parseInt(this.ScreenObject.Preferences["Autopostdocument"]), "", true)
            {
                let AutoPoststages: string[] = [];
                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["NextStageID"]) && !AutoPoststages.Contains(this.ScreenObject.GridData[i]["NextStageID"])) {
                        let sel = ExcessDoc.ScreenObject.Link.LinkCombo.Items.find(a => !Util.IsEmpty(a.Parent) && a.Parent == "158");
                        if (sel) {
                            ExcessDoc.ScreenObject.Link.LinkCombo.SelectedValue = sel.Value;
                            ExcessDoc.OLinkSelectionChanged(sel.Value);
                            let seljob = this.ScreenObject.Link.DocumentList.Items.find(a => a.IsChecked);
                            seljob = ExcessDoc.ScreenObject.Link.DocumentList.Items.find(a => a.Value == seljob.Value);
                            if (seljob != null) {
                                seljob.IsChecked = true;
                                let linkdoc = new LinkDocument(ExcessDoc, seljob.Name, parseInt(sel.Value), parseInt(seljob.Value), false);
                                let rows = linkdoc.ds.Tables[3].sort((a, b) => a.lft - b.lft);
                                for (let k = 0; k < rows.length; k++) {
                                    if (rows[k]["StageNodeID"].toString() == this.ScreenObject.GridData[i]["NextStageID"].toString()
                                        && rows.length > k + 1) {
                                        let drBoms: any = linkdoc.ds.Tables[0].filter(x => x.BOMID == rows[k + 1]["BOMID"] && x.StageID == rows[k + 1]["StageID"]);
                                        if (drBoms.length > 0) {
                                            if (Util.IsEmpty(linkdoc.Boms.SelectedValue) || linkdoc.Boms.SelectedValue != rows[k + 1]["BOMID"].toString()) {
                                                linkdoc.Boms.SelectedValue = rows[k + 1]["BOMID"].toString();
                                                linkdoc.onBomChanged(linkdoc.Boms.SelectedValue);
                                            }
                                            linkdoc.Boms.SelectedItem = linkdoc.Boms.GetselectedItem();
                                            if (Util.IsEmpty(linkdoc.Stages.SelectedValue) || linkdoc.Stages.SelectedValue != rows[k + 1]["StageID"].toString()) {
                                                linkdoc.Stages.SelectedValue = rows[k + 1]["StageID"].toString();
                                                linkdoc.FillJobProducts();
                                            }
                                            linkdoc.Stages.SelectedItem = linkdoc.Stages.GetselectedItem();
                                            let prodrow = linkdoc.GridData.filter(x => x.ProductID_Key == this.ScreenObject.GridData[i]["ProductID_Key"]);
                                            if (prodrow.length > 0) {
                                                AutoPoststages.push(this.ScreenObject.GridData[i]["NextStageID"].toString());

                                                if (Util.IsNum(prodrow[0]["ActualQty"]) && Util.IsNum(this.ScreenObject.GridData[i]["Quantity"])) {
                                                    linkdoc.RemQTY.Text = (parseFloat(this.ScreenObject.GridData[i]["Quantity"]) / parseFloat(prodrow[0]["ActualQty"])).ToString("N" + linkdoc.decimalpoints);
                                                    linkdoc.CalcRemQty();

                                                    linkdoc.GridData.forEach(dr => {
                                                        if (!Util.IsEmpty(dr["Select"]))
                                                            dr["Select"] = true;
                                                    });
                                                    linkdoc.OnSave("Add");
                                                    linkdoc.OnSave("OKNoClose");
                                                }
                                            }
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
                if (AutoPoststages.length > 0) {
                    ExcessDoc.OKCancelVisibility = true;
                    BaseService.page.ShowDialog(ExcessDoc, AddEditDocumentComponent);
                }
            }
        }
    }

    SetFocusForHeader(Fields: any[]): boolean {
        for (let i = 0; i < Fields.length; i++) {
            let item = Fields[i]
            if (item instanceof PactListBoxData) {
                if (item.IsTabStop && item.Visible) {
                    item.SetFocus = true;
                    return true;
                }
            }
            else if (item instanceof PactCodeNameListBoxData) {
                if (item.IsTabStop && item.Visible) {
                    if (item.Code.Visible)
                        item.Code.SetFocus = true;
                    else
                        item.Name.SetFocus = true;
                    return true;
                }
            }
            else if (item instanceof PactVoucherDateData) {
                if (item.IsTabStop && item.Visible) {
                    item.SetFocus = true;
                    return true;
                }
            }
            else if (item instanceof PactExtraFieldDateData) {
                if (item.IsTabStop && item.Visible) {
                    item.SetFocus = true;
                    return true;
                }
            }
            else if (item instanceof PactComboTextData) {
                if (item.IsTabStop && item.Visible) {
                    item.TextBox.SetFocus = true;
                    return true;
                }
            }
            else if (item instanceof PactTextBoxData) {
                if (item.IsTabStop && item.Visible) {
                    item.SetFocus = true;
                    return true;
                }
            }
        }
        return false;
    }

    // Set Focus on control.
    SetFocus() {
        if ((this.DocumentType == 38 || this.DocumentType == 39) && this.SKU != null && this.SKU.Visible && this.SKU.IsTabStop) {
            this.SKU.SetFocus = true;
            return;
        }
        if (this.SetFocusForHeader(this.ScreenObject.HeaderFields))
            return;
        if (this.ScreenObject.CustomTab.Pages.length > 0) {
            if (this.SetFocusForHeader(this.ScreenObject.CustomTab.Pages[0].Fields))
                return;
        }

        this.LineNo = 1;
        this.SetFocusongrid = true;
        let colName = this.GetPrimaryColName();

        if (colName != "") {
            let tempcol = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.ValueMember) && a.IsVisible && !a.DisableTab && a.ValueMember.toLowerCase() == colName.toLowerCase());
            if (tempcol) {
                this.ColumnNo = this.ScreenObject.ColumnSource.indexOf(tempcol) + 1;
            }
            else {
                tempcol = this.ScreenObject.ColumnSource.find(a => a.IsVisible && !a.DisableTab);
                if (tempcol) {
                    this.ColumnNo = this.ScreenObject.ColumnSource.indexOf(tempcol) + 1;
                }
            }
        }
    }
    isChequeReturn = false;
    ChequeReturn(AccountID: number, dr: any, path: string, amt: number, IsCredit: boolean, CurrID: number, ExRate: number) {
        let Amount: number = amt;
        if (dr != null && path != "")
            Amount = parseFloat(dr[path]);
        if (BaseService.SessionManager.Preferences.ContainsKey("enableChequeReturnHistory") && BaseService.SessionManager.Preferences["enableChequeReturnHistory"] != "" && parseBoolean(BaseService.SessionManager.Preferences["enableChequeReturnHistory"])) {
            let DocSeqNo = 1;
            let drgrid: any = null;
            if (!this.IsInventoryVoucher && this.SelectedRow)// != null && SelectedRow instanceof DataRowView)
            {
                drgrid = this.SelectedRow;
                DocSeqNo = parseInt(this.SelectedRow["DocSeqNo"]);
            }
            let ds: any = this.ScreenObject.GetChequeReturnDetails(AccountID, IsCredit, this.ScreenObject.VoucherNo, DocSeqNo, drgrid, this.DocumentDate);
            if (ds != null && ds.Tables.length > 0 && !ds.Columns[0].Contains("ErrorMessage") && ds.Tables[0].length > 0) {
                let drSelected: any = (!this.IsInventoryVoucher && this.SelectedRow) ? this.SelectedRow : null;
                let VoucherNo: string = (this.ScreenObject.IsDocEdit) ? this.ScreenObject.VoucherNo : "";
                let objCh = new ChequeReturnViewModel(this, drSelected, VoucherNo, Amount, AccountID, IsCredit, CurrID, ExRate, ds);
                this.IgnoreOnSave.push("ChequeReturn", objCh);
                this.isChequeReturn = true;
                BaseService.page.ShowDialog(objCh, ChequeReturnComponent, { HideClose: true });
            }
        }
    }
    CheckDistCosts(AccountID: number, dr: any, amt: number, path: string, isfrmSc: boolean = false) {
        if ((!Util.IsEmpty(dr["DocDetailsID"]) && parseFloat(dr["DocDetailsID"].toString()) > 0)
            || (this.ScreenObject.GridDataColumns.Contains("IsDistributed") && Util.String(dr["IsDistributed"]) == "1"))
            return;
        if (BaseService.SessionManager.Preferences.ContainsKey("DistributeCost") && BaseService.SessionManager.Preferences["DistributeCost"] == "True"
            && BaseService.SessionManager.Preferences.ContainsKey("CostBasedON") && BaseService.SessionManager.Preferences["CostBasedON"] == "True"
            && BaseService.SessionManager.Preferences.ContainsKey("CostBasedONDims") && BaseService.SessionManager.Preferences["CostBasedONDims"] != "") {
            var costDims = BaseService.SessionManager.Preferences["CostBasedONDims"].split(',');

            let where = '';
            let incType = false;
            for (let m = 0; m < costDims.length; m++) {
                let item = costDims[m]
                if (parseInt(item) > 50000) {
                    if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (parseInt(item) - 50000) + "_Key")) {
                        if (!Util.IsEmpty(dr["dcCCNID" + (parseInt(item) - 50000) + "_Key"]))
                            where += " and dcCCNID" + (parseInt(item) - 50000) + "=" + dr["dcCCNID" + (parseInt(item) - 50000) + "_Key"].toString();
                    }
                    else {
                        var fld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == parseInt(item)) as PactListBoxData;
                        if (fld && fld.SelectedValue > 0)
                            where += " and dcCCNID" + (parseInt(item) - 50000) + "=" + fld.SelectedValue.toString();
                    }
                }
                else if (parseInt(item) == 2)
                    where += " and AccountID in(" + AccountID + "," + 0 + ")";
                else if (parseInt(item) == 502) {
                    incType = true;
                    where += " and (db.AccountID is not null or Cr.AccountID is not null)";
                }
            }
            let dsprof = this.ScreenObject.getProfileBasedon(AccountID, 0, incType, where);
            if (dsprof != null && dsprof.Tables.length > 0 && dsprof.Columns[0].Contains("ProfileID") && dsprof.Tables[0].length > 0) {
                if (!this.ScreenObject.GridDataColumns.Contains("IsDistributed"))
                    this.ScreenObject.GridDataColumns.push("IsDistributed");
                let cnt = 0;
                let DistAmt = 0; let Ustot = 0;
                var dims = BaseService.SessionManager.Preferences["DistributeCostDims"].split(',');
                for (let i = 0; i < dsprof.Tables[0].length; i++) {

                    if ((i + 1) == dsprof.Tables[0].length)
                        DistAmt = parseFloat(((amt) - Ustot).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"].toString()));
                    else if (!Util.IsEmpty(dsprof.Tables[0][i]["Percent"]) && parseFloat(dsprof.Tables[0][i]["Percent"].toString()) > 0)
                        DistAmt = parseFloat((((amt) * parseFloat(dsprof.Tables[0][i]["Percent"].toString())) / 100).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"].toString()));
                    else if (!Util.IsEmpty(dsprof.Tables[0][i]["Amount"]) && parseFloat(dsprof.Tables[0][i]["Amount"].toString()) > 0)
                        DistAmt = parseFloat(dsprof.Tables[0][i]["Amount"].toString());
                    if (BaseService.SessionManager.Preferences.ContainsKey("ExclZerodist") && BaseService.SessionManager.Preferences["ExclZerodist"] == "True" && DistAmt == 0)
                        continue;

                    cnt++;
                    let drgrid: any;
                    if (cnt == 1)
                        drgrid = dr;
                    else {
                        drgrid = this.ScreenObject.GridDataObj.NewRow();
                        for (let h = 0; h < this.ScreenObject.GridDataColumns.length; h++) {
                            if (this.ScreenObject.GridDataColumns[h].toLowerCase() != "docseqno"
                                && this.ScreenObject.GridDataColumns[h].toLowerCase() != "docdetailsid")
                                drgrid[h] = dr[h];
                        }
                        this.ScreenObject.GridDataObj.insertRowAt(drgrid, this.ScreenObject.GridData.indexOf(dr) + 1);
                    }

                    Ustot += DistAmt;

                    drgrid["IsDistributed"] = 1;
                    drgrid[path] = DistAmt;
                    dims.forEach(item => {
                        if (parseInt(item) > 50000 && dsprof.Columns[0].Contains("DcCCNID" + (parseInt(item) - 50000))
                            && dsprof.Tables[0][i]["DcCCNID" + (parseInt(item) - 50000)].toString() != ""
                            && this.ScreenObject.GridDataColumns.Contains("DcCCNID" + (parseInt(item) - 50000) + "_Key")) {
                            drgrid["dcCCNID" + (parseInt(item) - 50000)] = null;
                            drgrid["dcCCNID" + (parseInt(item) - 50000) + "_Key"] = dsprof.Tables[0][i]["DcCCNID" + (parseInt(item) - 50000)].toString();
                        }
                    });
                    this.CalculateTotals(drgrid, false);
                }
                //if (cnt > 1) {
                this.ScreenObject.UpdateSequence();
                this.RefreshGrid = true;
                //}

                //#region 
                // let showjv = new ShowJVViewModel();
                // showjv.ShowJVViewModel_2(this, AccountID.toString(), 5)
                // {
                //     showjv.Amount.Text = amt.toString();
                //     showjv.TotAmt = amt;
                //     if (this.ScreenObject.GridDataColumns.Contains("AccountName"))
                //         showjv.AccountName.Text = dr["AccountName"].toString();
                //     else if (this.ScreenObject.GridDataColumns.Contains("AccountCode"))
                //         showjv.AccountName.Text = dr["AccountCode"].toString();
                //     this.DialogResult = false;
                //     showjv.Profile.SelectedValue = dsprof.Tables[0][0]["ProfileID"].toString();
                //     showjv.fillpostinggrid(dsprof);

                //     BaseService.page.ShowDialog(showjv, ShowJVComponent);
                //     if (this.DialogResult)
                //     {
                //         if (showjv.JVGrid.Table.length > 0 && !this.ScreenObject.GridDataColumns.Contains("DistCost"))
                //             this.ScreenObject.GridDataColumns.push("DistCost");
                //         let cnt = 0;
                //         for(let i = 0; i < showjv.JVGrid.Table.length; i++)
                //         {
                //             if (!Util.IsEmpty(showjv.JVGrid.Table[i]["Amount"]) && parseFloat(showjv.JVGrid.Table[i]["Amount"].toString()) > 0)
                //             {
                //                 cnt++;
                //                 let drgrid;
                //                 if (cnt == 1)
                //                     drgrid = dr;
                //                 else
                //                 {
                //                     drgrid = this.ScreenObject.GridDataObj.NewRow();
                //                     for(let h = 0; h < this.ScreenObject.GridDataColumns.length; h++)
                //                     {
                //                         if (this.ScreenObject.GridDataColumns[h].toLowerCase() != "docseqno"
                //                             && this.ScreenObject.GridDataColumns[h].toLowerCase() != "docdetailsid")
                //                             drgrid[h] = dr[h];
                //                     }
                //                     this.ScreenObject.GridDataObj.insertRowAt(drgrid, this.ScreenObject.GridData.indexOf(dr) + 1);
                //                 }

                //                 drgrid["DistCost"] = 1;
                //                 drgrid[path] = showjv.JVGrid.Table[i]["Amount"].toString();
                //                 for(let k = 2; k < showjv.JVGrid.Columns.length; k++)
                //                 {
                //                     if (this.ScreenObject.GridDataColumns.Contains(showjv.JVGrid.Columns[k].ValueMember) && !Util.IsEmpty(showjv.JVGrid.Table[i][showjv.JVGrid.Columns[k].ValueMember]))
                //                     {
                //                         drgrid[showjv.JVGrid.Columns[k].ValueMember] = showjv.JVGrid.Table[i][showjv.JVGrid.Columns[k].ValueMember].toString();
                //                         drgrid[showjv.JVGrid.Columns[k].DisplayMember] = showjv.JVGrid.Table[i][showjv.JVGrid.Columns[k].DisplayMember].toString();
                //                     }
                //                 }
                //                 this.CalculateTotals(drgrid, false);
                //             }
                //         }
                //         if (cnt > 1)
                //             this.ScreenObject.UpdateSequence();
                //     }
                // }
                //#endregion
            }
        }
    }

    CheckIsBillWise(AccountID: number, dr: any, path: string, amt: number, IsCredit: boolean, CurrID: number, ExRate: number, Vno: string = "", DbCrNetFld: string = "", callback = null) {
        ;
        let Amount = 0;
        if ((path == "CreditAmount" || path == "DebitAmount" || path == "Amount" || DbCrNetFld != "") && !Util.IsEmpty(dr[path]))
            Amount = parseFloat(dr[path]);
        let exchgl = "", exchheader = "";
        if (this.ScreenObject.Data.Tables[0].length > 0) {
            let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 50403);
            if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                exchgl = dvCnt[0]["SysColumnName"];
                exchheader = dvCnt[0]["ResourceData"].toString().Replace(" ", "");
            }
        }
        for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
            if (this.ScreenObject.ColumnSource[i].DisplayMember.toLowerCase().Contains("dcnum") && this.ScreenObject.ColumnSource[i].IsColumnUserDefined &&
                (this.ScreenObject.ColumnSource[i].PostingType == 3 || this.ScreenObject.ColumnSource[i].PostingType == 4) &&
                ((IsCredit && this.ScreenObject.ColumnSource[i].CreditAcount == 0 && this.ScreenObject.ColumnSource[i].CrRefColID == 0)
                    || (!IsCredit && this.ScreenObject.ColumnSource[i].DebitAccount == 0 && this.ScreenObject.ColumnSource[i].DrRefColID == 0))
                && !Util.IsEmpty(dr["dcCalc" + this.ScreenObject.ColumnSource[i].DisplayMember]) && exchgl != this.ScreenObject.ColumnSource[i].DisplayMember
                && !(exchheader != "" && !Util.IsEmpty(this.ScreenObject.ColumnSource[i].Formula) && this.ScreenObject.ColumnSource[i].Formula.Contains(exchheader))) {
                //if (Currency != null && Currency.ExchangeRate.Text != null && Currency.ExchangeRate.Text != "")
                //    ExhgRate = parseFloat(Currency.ExchangeRate.Text);
                //else if (this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ExchangeRate"]))
                //    ExhgRate = parseFloat(this.ScreenObject.GridData[i]["ExchangeRate"]);

                //if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"]))
                //{
                //    if (this.ScreenObject.ColumnSource[j].DefaultValue == "-2")
                //    {
                //        if (this.ScreenObject.GridData[i]["dcExchRT" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "")].toString() != "")
                //            ExhgRate = parseFloat(this.ScreenObject.GridData[i]["dcExchRT" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "")]);
                //    }
                //    else
                //    {
                //        let def = 0;
                //        Util.Int(this.ScreenObject.ColumnSource[i].DefaultValue, out def);
                //        if (def > 0 && this.ScreenObject.ColumnSource[i].CurrID > 0)
                //        {

                //            ExhgRate = this.ScreenObject.ColumnSource[i].ExhcgRt;
                //        }
                //    }
                //}
                let PostingValue: number = parseFloat(dr["dcCalc" + this.ScreenObject.ColumnSource[i].DisplayMember]);
                Amount += PostingValue;
            }
        }

        Logger.InfoLog("AddEditDocumentViewModel::Entering CheckIsBillWise");
        if (BaseService.SessionManager.Preferences.ContainsKey("On") && BaseService.SessionManager.Preferences["On"] == "True" && AccountID > 0) {

            if (amt == 0)
                Amount = 0;
            else if ((path == "CreditAmount" || path == "DebitAmount" || path == "Amount") && Amount == 0) {
                return;
            }
            if ((path == "CreditAmount" || path == "DebitAmount" || path == "Amount") && !this.IsInventoryVoucher && Amount < 0) {
                IsCredit = !IsCredit;
                Amount = Amount * -1;
            }
            if ((path == "CreditAmount" || path == "DebitAmount") &&
                this.ScreenObject.Preferences.ContainsKey("Valueonbillwise") && this.ScreenObject.Preferences["Valueonbillwise"] != "" && parseBoolean(this.ScreenObject.Preferences["Valueonbillwise"])) {
                if (path == "CreditAmount")
                    IsCredit = true;
                else
                    IsCredit = false;
                Amount = 0;
            }

            this.DialogResult = false;
            let objbill: BillWiseViewModel = new BillWiseViewModel();
            objbill.BillWiseViewModel_2(this, Amount, AccountID, IsCredit, CurrID, ExRate, true, DbCrNetFld)
            if (!this.DialogResult) {
                //, CallBack:[this,"DocNumberCallBack"]
                //HideClose:true,
                if (Vno != '') {
                    var drbill = objbill.GridData.filter(x => x.DocNo == Vno);
                    if (drbill.length > 0 && !Util.IsEmpty(drbill[0]["Due"])) {
                        drbill[0]["AmountPaidLC"] = drbill[0]["Due"];
                        let egl = 0, totval = 0;
                        if (!Util.IsEmpty(drbill[0]["CurrID"]) && parseInt(drbill[0]["CurrID"].toString()) == CurrID && drbill[0]["ExchgRate"].toString() != "" && parseFloat(drbill[0]["ExchgRate"].toString()) != ExRate) {
                            totval = (parseFloat(drbill[0]["AmountPaidLC"].toString()) / parseFloat(drbill[0]["ExchgRate"].toString()));
                            egl = parseFloat(drbill[0]["AmountPaid"].toString()) * (parseFloat(drbill[0]["ExchgRate"].toString()) - ExRate);
                        }
                        else {
                            totval = (parseFloat(drbill[0]["AmountPaidLC"].toString()) / ExRate);
                        }
                        objbill.AmtToAdjust.Text = totval.ToString("N" + objbill.decimalpoints);
                        objbill.NewReference.Text = "0";
                        drbill[0]["AmountPaid"] = totval.ToString("N" + objbill.decimalpoints);
                        if (this.ScreenObject.GridDataColumns.Contains("Amount"))
                            dr["Amount"] = totval.ToString("N" + objbill.decimalpoints);
                        this.Celleditend(dr, "DocSeqNo", 0);
                        drbill[0]["exchgl"] = egl;
                        objbill.PaidChange("AmountPaid", drbill[0], false);
                        objbill.OnSave("autosave");
                    }
                }
                else if (Util.IsEmpty(dr["ExtraXML"]) && this.ScreenObject.Preferences.ContainsKey("Billwise Fifo") && parseBoolean(this.ScreenObject.Preferences["Billwise Fifo"])) {
                    objbill.Fifo = true;
                    objbill.OnSave("autosave");
                }
                else
                    BaseService.page.ShowDialog(objbill, BillWiseComponent, { ShowCenter: true }, () => {
                        callback();
                    })
            }
            else
                this.CheckDistCosts(AccountID, dr, amt, path, false);
        }
        Logger.InfoLog("AddEditDocumentViewModel::Exiting CheckIsBillWise");
    }

    CheckAccountBalance(AccountID: number, Amount: number, IsCredit: boolean): boolean {
        if (!this.IsInventoryVoucher || (BaseService.SessionManager.Preferences.ContainsKey("DontSaveCahsBankBalanceNegative") && BaseService.SessionManager.Preferences["DontSaveCahsBankBalanceNegative"] != "" && parseBoolean(BaseService.SessionManager.Preferences["DontSaveCahsBankBalanceNegative"]))) {
            let DS: any = this.ScreenObject.GetAccBalance(AccountID, this.DocumentDate, this.ScreenObject.LocationID, this.ScreenObject.DivisionID);

            if (!this.IsInventoryVoucher && DS != null && DS.Tables.length > 0 && DS.Tables[0].length > 0 && DS.Columns[0].Contains("IsBillwise")
                && !Util.IsEmpty(DS.Tables[0][0]["IsBillwise"]) && parseBoolean(DS.Tables[0][0]["IsBillwise"])
                && (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 15 || this.ScreenObject.DocumentType == 20 || this.ScreenObject.DocumentType == 23
                    || this.ScreenObject.DocumentType == 18 || this.ScreenObject.DocumentType == 19 || this.ScreenObject.DocumentType == 21 || this.ScreenObject.DocumentType == 22)) {
                if (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 15 || this.ScreenObject.DocumentType == 20 || this.ScreenObject.DocumentType == 23)
                    this.DisplayMessage = "Can not select billwise account in payment Mode";
                else
                    this.DisplayMessage = "Can not select billwise account in reciept Mode";

                return true;
            }

            if ((this.IsInventoryVoucher || (BaseService.SessionManager.Preferences.ContainsKey("DontSaveCahsBankBalanceNegative") && BaseService.SessionManager.Preferences["DontSaveCahsBankBalanceNegative"] != "" && parseBoolean(BaseService.SessionManager.Preferences["DontSaveCahsBankBalanceNegative"])))
                && DS != null && DS.Tables.length > 0 && DS.Tables[0].length > 0 && DS.Columns[0].Contains("BalDocDate") && !Util.IsEmpty(DS.Tables[0][0]["BalDocDate"])) {
                let balance = parseFloat(DS.Tables[0][0]["BalDocDate"]);
                if (!this.IsInventoryVoucher) {
                    balance = -balance;
                    if (IsCredit)
                        balance -= Amount;
                    else
                        balance += Amount;
                    balance = parseFloat(balance.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));
                    if (balance < 0) {
                        if (DS.Columns[0].Contains("AccountTypeID") &&
                            DS.Tables[0][0]["AccountTypeID"].toString() != "1" && DS.Tables[0][0]["AccountTypeID"].toString() != "2" && DS.Tables[0][0]["AccountTypeID"].toString() != "10")
                            return false;
                        if (BaseService.SessionManager.IsActionAssigned(43, "OverrideNegativeBalance")) {
                            if (confirm("Balance goes negative do you want to proceed?"))
                                return false;
                            else
                                return true;
                        }
                        return true;
                    }
                }
                else {
                    if (IsCredit)
                        balance += Amount;
                    else
                        balance -= Amount;
                    if (balance < 0)
                        return true;
                }
            }
        }
        return false;
    }

    CheckCreditLimit(AccountID: number, Amount: number, IsCredit: boolean): boolean {
        if (Amount === 0)
            return true;
        // return false; //by Ikram Need to check SP Entering infinite loop
        Logger.InfoLog("AddEditDocumentViewModel::Entering CheckCreditLimit");
        if (IsCredit && ((BaseService.SessionManager.Preferences.ContainsKey("Warn if balance exceeds Credit Limit") && BaseService.SessionManager.Preferences["Warn if balance exceeds Credit Limit"] == "True")
            || (BaseService.SessionManager.Preferences.ContainsKey("Warncreditdays") && BaseService.SessionManager.Preferences["Warncreditdays"] == "True"))) {
            let DimensionID = 0;
            if (BaseService.SessionManager.Preferences.ContainsKey("DimWiseCreditDebit") && BaseService.SessionManager.Preferences["DimWiseCreditDebit"] != "" && parseInt(BaseService.SessionManager.Preferences["DimWiseCreditDebit"]) > 0) {
                let Dimfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid" + (parseInt(BaseService.SessionManager.Preferences["DimWiseCreditDebit"]) - 50000));
                if (Dimfld && Dimfld instanceof PactListBoxData && Dimfld.SelectedValue > 0)
                    DimensionID = Dimfld.SelectedValue;
            }
            let DS: any = this.ScreenObject.CheckCreditLimit(AccountID, Amount, this.DocumentDate, DimensionID);
            if (BaseService.SessionManager.Preferences.ContainsKey("Warn if balance exceeds Credit Limit") && BaseService.SessionManager.Preferences["Warn if balance exceeds Credit Limit"] == "True") {
                if (DS != null && DS.Tables.length > 0 && DS.Tables[0].length > 0 && DS.Tables[0][0][DS.Columns[0][0]].toString() == "1") {
                    if (BaseService.SessionManager.IsActionAssigned(43, "OverrideCreditLimit")) {
                        this.res = "";
                        if (!confirm("Credit limit exceeds do you want to proceed ? "))
                            return false;
                    }
                    else {
                        this.DisplayMessage = "Balance exceeds Credit limit";

                        return false;
                    }
                }
            }
            if (BaseService.SessionManager.Preferences.ContainsKey("Warncreditdays") && BaseService.SessionManager.Preferences["Warncreditdays"] == "True") {
                if (DS != null && DS.Tables.length > 1 && DS.Tables[1].length > 0) {
                    if (BaseService.SessionManager.IsActionAssigned(43, "OverrideCreditDays")) {
                        this.res = "";
                        if (!confirm("Credit Days Exceeds for" + DS.Tables[1][0][DS.Columns[1][0]].toString() + ".Do you want to proceed ? "))
                            return false;
                    }
                    else {
                        this.DisplayMessage = "Credit Days Exceeds for " + DS.Tables[1][0][DS.Columns[1][0]].toString();
                        return false;
                    }
                }
            }
        }
        else if (!IsCredit && ((BaseService.SessionManager.Preferences.ContainsKey("Warn if balance exceeds debit Limit") && BaseService.SessionManager.Preferences["Warn if balance exceeds debit Limit"] == "True")
            || (BaseService.SessionManager.Preferences.ContainsKey("Warndebitdays") && BaseService.SessionManager.Preferences["Warndebitdays"] == "True"))) {
            let DimensionID = 0;
            if (BaseService.SessionManager.Preferences.ContainsKey("DimWiseCreditDebit") && BaseService.SessionManager.Preferences["DimWiseCreditDebit"] != "" && parseInt(BaseService.SessionManager.Preferences["DimWiseCreditDebit"]) > 0) {
                let Dimfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid" + (parseInt(BaseService.SessionManager.Preferences["DimWiseCreditDebit"]) - 50000));
                if (Dimfld && Dimfld instanceof PactListBoxData && Dimfld.SelectedValue > 0)
                    DimensionID = Dimfld.SelectedValue;
            }
            let DS: any = this.ScreenObject.CheckCreditLimit(AccountID, Amount, this.DocumentDate, DimensionID);
            if (BaseService.SessionManager.Preferences.ContainsKey("Warn if balance exceeds debit Limit") && BaseService.SessionManager.Preferences["Warn if balance exceeds debit Limit"] == "True") {
                if (DS != null && DS.Tables.length > 0 && DS.Tables[0].length > 0 && DS.Tables[0][0][DS.Columns[0][0]].toString() == "1") {
                    if (BaseService.SessionManager.IsActionAssigned(43, "OverrideCreditLimit")) {
                        this.res = "";
                        if (!confirm("Credit limit exceeds do you want to proceed ? "))
                            return false;
                    }
                    else {
                        this.DisplayMessage = "Balance exceeds Credit limit";
                        return false;
                    }
                }
            }
            if (BaseService.SessionManager.Preferences.ContainsKey("Warndebitdays") && BaseService.SessionManager.Preferences["Warndebitdays"] == "True") {
                if (DS != null && DS.Tables.length > 1 && DS.Tables[1].length > 0) {
                    if (BaseService.SessionManager.IsActionAssigned(43, "OverrideCreditDays")) {
                        this.res = "";
                        if (!confirm("Credit Days Exceeds for" + DS.Tables[1][0][DS.Columns[1][0]].toString() + ".Do you want to proceed ? "))
                            return false;
                    }
                    else {
                        this.DisplayMessage = "Credit Days Exceeds for " + DS.Tables[1][0][DS.Columns[1][0]].toString();
                        return false;
                    }
                }
            }
        }
        return true;
    }

    LoadDOcument() {
        let loc = 0, DIv = 0, regID = 0;
        if (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True") {
            if (this.ScreenObject.DivisionID > 0)
                DIv = this.ScreenObject.DivisionID;
            else if (BaseService.SessionManager.DivisionID > 0)
                DIv = BaseService.SessionManager.DivisionID;
        }
        if (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True") {
            if (this.ScreenObject.LocationID > 0)
                loc = this.ScreenObject.LocationID;
            else if (BaseService.SessionManager.LocationID > 0)
                loc = BaseService.SessionManager.LocationID;
        }

        let tempint = 0;
        if (BaseService.SessionManager.IsActionAssigned(43, "Dimension wise Documents")) {
            if (BaseService.SessionManager.Preferences.ContainsKey("DimensionwiseDocuments") && Util.IsNum(BaseService.SessionManager.Preferences["DimensionwiseDocuments"]))
                tempint = parseInt(BaseService.SessionManager.Preferences["DimensionwiseDocuments"]);
            if (tempint > 50000) {
                let drexist: any[] = this.ScreenObject.Data.Tables[0].filter(x => x.ColumnCostCenterID == tempint);
                if (drexist.length == 0)
                    tempint = 0;
            }
        }
        if (this.IsPOs)
            regID = this.ScreenObject.RegisterNodeID;

        let obj = new PreviousTextDialog();
        obj.PreviousTextDialog_1(this.CostCenterID, this.IsInventoryVoucher, loc, DIv, tempint, this.ScreenObject.Data.Tables[3][0]["DocumentAbbr"].toString(), this.ScreenObject.CostCentersValues)
        BaseService.page.ShowDialog(obj, PreviousTextDialogComponent, { ShowCenter: true, NoWidth: true }).subscribe(() => {
            if (Util.IsValidID(obj.DocID)) {
                let ref_Ddate = { value: this._Ddate }
                this.ScreenObject.OnDocPrefixChanged("lostFocus", 0, obj.DocID, ref_Ddate, true);
                this._Ddate = ref_Ddate.value
            }
        });
    }

    GetData(sender: any) {
        Logger.InfoLog("AddEditDocumentViewModel::Entering GetData");

        if (!this.ConfirmDirtyRead())
            return;

        if (sender.toString() == "Next" && ((BaseService.SessionManager.Preferences.ContainsKey("ConfirmonNext") && BaseService.SessionManager.Preferences["ConfirmonNext"].toUpperCase() == "TRUE") ||
            (this.ScreenObject.Preferences.ContainsKey("ConfirmonNext") && this.ScreenObject.Preferences["ConfirmonNext"].toUpperCase() == "TRUE"))) {
            if (!confirm("Do you want Next Document?"))
                return;
        }
        if (sender.toString() == "Previous" && ((BaseService.SessionManager.Preferences.ContainsKey("ConfirmonPrevious") && BaseService.SessionManager.Preferences["ConfirmonPrevious"].toUpperCase() == "TRUE") ||
            (this.ScreenObject.Preferences.ContainsKey("ConfirmonPrevious") && this.ScreenObject.Preferences["ConfirmonPrevious"].toUpperCase() == "TRUE"))) {
            if (!confirm("Do you want Previous Document?"))
                return;
        }

        this.MessageVisibility = false;
        this.ReportDimension.SelectedValue = 0;

        if (this.ScreenObject.DocumentType == 72) {
            this.isVacContractedit = true;
            this.dtVacContract = null;
            this.ShowVacationCreditDaysDetail(0);
        }

        if (this.ScreenObject.DocPrefix.TextBox.Text != "") {
            try {
                let Prefixlength: number = 0;

                if (this.ScreenObject.DocPrefix.ComboBox.SelectedItem != null && this.ScreenObject.DocPrefix.ComboBox.SelectedItem.Aliasname != "")
                    Prefixlength = parseInt(this.ScreenObject.DocPrefix.ComboBox.SelectedItem.Aliasname);
                if (sender.toString() == "LoadDocument")
                    this.LoadDOcument();
                else if (sender.toString().toUpperCase() == "NEXT") {
                    let number: string = (parseInt(this.ScreenObject.DocPrefix.TextBox.Text) + 1).toString();
                    while (number.length < Prefixlength) {
                        number = "0" + number;
                    }
                    this.ScreenObject.DocPrefix.TextBox.Text = number;

                    let ref_Ddate = { value: this._Ddate }
                    this.ScreenObject.OnDocPrefixChanged("lostFocus", 2, 0, ref_Ddate, true);
                    this._Ddate = ref_Ddate.value
                    this.QuickInfoVisibility = false;
                    this.DQuickInfoVisibility = false;
                }
                else {
                    if (parseInt(this.ScreenObject.DocPrefix.TextBox.Text) > 1) {
                        let number = (parseInt(this.ScreenObject.DocPrefix.TextBox.Text) - 1).toString();
                        while (number.length < Prefixlength) {
                            number = "0" + number;
                        }
                        this.ScreenObject.DocPrefix.TextBox.Text = number;
                        let ref_Ddate = { value: this._Ddate }
                        this.ScreenObject.OnDocPrefixChanged("lostFocus", 1, 0, ref_Ddate, true);
                        this._Ddate = ref_Ddate.value
                        this.QuickInfoVisibility = false;
                        this.DQuickInfoVisibility = false;
                    }
                }

                if (this.ScreenObject.DocumentType == 72) {
                    let lngEmpCode = 0;
                    let fldAPV: PactControlData = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if (fldAPV && fldAPV instanceof PactListBoxData && fldAPV.SelectedValue > 0)
                        lngEmpCode = fldAPV.SelectedValue;
                    else if (fldAPV && fldAPV instanceof PactCodeNameListBoxData && fldAPV.SelectedValue > 0)
                        lngEmpCode = fldAPV.SelectedValue;
                    this.ShowVacationCreditDaysDetail(lngEmpCode);
                    this.isVacContractedit = false;
                }

                if (!this.ScreenObject.IsDocEdit)
                    this.clear(4);

            }
            catch (error) {
                this.DisplayMessage = "Error Loading document try again";

                Logger.ErrorLog("Addeditdocumentviewmodel", "OnDocPrefixChanged", error);

            }
        }
        if (this.ScreenObject.Preferences.ContainsKey("HideBody") && !Util.IsEmpty(this.ScreenObject.Preferences["HideBody"]) && parseBoolean(this.ScreenObject.Preferences["HideBody"].toString()))
            this.BodyVisible = false;

        if (!this.IsPOs)
            this.SetDefaultRightPanel();
        Logger.InfoLog("AddEditDocumentViewModel::Exiting GetData");
    }

    SortGrid(IsLinking: boolean) {
        let arrSort: any[] = []

        if (!IsLinking) {
            for (let i = 0; i < this.DtImport.length; i++) {
                if (!Util.IsEmpty(this.DtImport[i]["FieldName"])) {
                    let s = { name: this.DtImport[i]["FieldName"], desc: false }
                    if (Util.String(this.DtImport[i]["Order"]) == "Desc" || Util.String(this.DtImport[i]["Order"]).toLowerCase() == "numdesc")
                        s.desc = true;
                    arrSort.push(s);
                }
            }
        }

        if (IsLinking) {
            if (!this.IsInventoryVoucher)
                return;
            if (this.ScreenObject.Preferences.ContainsKey("Sortbasedon") && !Util.IsEmpty(this.ScreenObject.Preferences["Sortbasedon"])) {
                let col = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["Sortbasedon"]);
                if (col && !Util.IsEmpty(col.ValueBinding) && this.ScreenObject.GridDataColumns.Contains(col.ValueBinding))
                    arrSort.push({ name: col.ValueBinding, desc: true });
                else if (col && !Util.IsEmpty(col.DisplayMember) && this.ScreenObject.GridDataColumns.Contains(col.DisplayMember))
                    arrSort.push({ name: col.DisplayMember, desc: true });
            }
            else
                arrSort.push({ name: "ProductID_Key", desc: true });
        }
        else {

            if (arrSort.length > 0) {
                let PK = '';
                if (this.IsInventoryVoucher)
                    PK = "ProductID_key";
                else if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key"))
                    PK = "CreditAccount_Key";
                else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key"))
                    PK = "DebitAccount_Key";
                else if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key"))
                    PK = "AccountID_Key";
                if (PK.length > 0) {
                    arrSort.InsertAt("EmptySort", 0);
                    this.ScreenObject.GridData.map(x => x["EmptySort"] = (Util.IsEmpty(x[PK]) ? 1 : 0))
                }
            }
            else
                return;
        }
        console.log(arrSort);
        this.ScreenObject.GridData.SortBy(arrSort)

        for (let k = 0; k < this.ScreenObject.GridData.length; k++)
            this.ScreenObject.GridData[k]["DocSeqNo"] = k + 1;
        this.ScreenObject.GridDataObj.refreshDatawithIDs();
    }

    public schRowsCnt: number = 0;
    LoadLinkData(ds: any, ids: any[], RowPos: number, cols: string[], CopyDt: any[], Labels: string[] = null) {
        if (ds.Tables.length == 1 && ds.Columns[0].Contains("ErrorMessage")) {
            return;
        }
        let drr: any;
        let unq: any = null;
        try {
            let dtValue = new Date();
            this.ScreenObject.AttachDetach(false);

            if (this.ScreenObject.Preferences.ContainsKey("SameserialNo") && this.ScreenObject.Preferences["SameserialNo"] != "" && parseBoolean(this.ScreenObject.Preferences["SameserialNo"])
                && CopyDt == null && ds.Tables[0].length > 0) {
                this.ScreenObject.DocPrefix.TextBox.Text = ds.Tables[0][0]["DocNumber"].toString();
            }
            if (CopyDt == null) {
                var drdocdate = ds.Tables[4].filter(x => x["BASECOL"] == 'DocDate');
                if (drdocdate.length > 0 && ds.Tables[0].length > 0) {
                    if (drdocdate[0]["LINKCOL"].toString() != "" && ds.Columns[0].Contains(drdocdate[0]["LINKCOL"].toString())
                        && Util.isValidDate(ds.Tables[0][0][drdocdate[0]["LINKCOL"].toString()])) {
                        dtValue = Util.ParseDate(ds.Tables[0][0][drdocdate[0]["LINKCOL"]]);
                        this.DocumentDate = Util.diffparseDate(dtValue.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a"));
                    }
                    else if (drdocdate[0]["LINKCOL"].toString() != "" && ds.Columns[3].Contains(drdocdate[0]["LINKCOL"].toString())
                        && Util.isValidDate(ds.Tables[3][0][drdocdate[0]["LINKCOL"].toString()])) {
                        dtValue = Util.ParseDate(ds.Tables[3][0][drdocdate[0]["LINKCOL"]]);
                        this.DocumentDate = Util.diffparseDate(dtValue.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a"));
                    }
                }
            }
            this.ScreenObject.LoadLinkFieldsData_3(ds, CopyDt, ids);

            let NodeIDs: DictionaryNumKey<number> = new DictionaryNumKey<number>();
            if (CopyDt == null && this.ScreenObject.Preferences.ContainsKey("DimensionWise") && this.ScreenObject.Preferences["DimensionWise"] != "") {
                let ccids = this.ScreenObject.Preferences["DimensionWise"].split(',');
                ccids.forEach(item => {
                    if (item != "") {
                        let ccid = parseInt(item);
                        if (ccid == 3) {
                            for (let m = 0; m < this.ScreenObject._TextFields.length; m++) {
                                let cc = this.ScreenObject._TextFields[m]
                                if (cc instanceof PactListBoxData && cc.CCID == ccid) {
                                    if (cc.SelectedValue > 0)
                                        NodeIDs.push(ccid, cc.SelectedValue);
                                    break;
                                }
                            }
                        }
                        else if (ccid > 50000) {
                            for (let m = 0; m < this.ScreenObject._CCFields.length; m++) {
                                let cc = this.ScreenObject._CCFields[m]
                                if (cc instanceof PactListBoxData && cc.CCID == ccid) {
                                    if (cc.SelectedValue > 0)
                                        NodeIDs.push(ccid, cc.SelectedValue);
                                    break;
                                }
                            }
                        }
                    }
                });
            }
            let TempId: number;
            let RecordsCount = 0;
            this.schRowsCnt = 0;
            let Packids = "";

            let schemes = false;
            if (this.ScreenObject.Preferences.ContainsKey("EnableSchemes") && parseBoolean(this.ScreenObject.Preferences["EnableSchemes"]))
                schemes = parseBoolean(this.ScreenObject.Preferences["EnableSchemes"]);

            let prodDics: any = null;

            if (this.IsInventoryVoucher && this.ScreenObject.Preferences.ContainsKey("CopyProductdata") && this.ScreenObject.Preferences["CopyProductdata"] != "" && parseBoolean(this.ScreenObject.Preferences["CopyProductdata"]))
                prodDics = new Dictionary<any>();//new Dictionary<long, DataSet>();
            let i;
            let drsoted: any = null;
            if (ds.Columns[0].Contains("sno")) {
                //drsoted = ds.Tables[0].Select("", "sno");
                drsoted = ds.Tables[0].sort((a, b) => a.sno - b.sno);
            }
            for (let m = 0; m < ds.Tables[0].length; m++) {
                if (drsoted && drsoted != null)
                    i = ds.Tables[0].IndexOf(drsoted[m]);
                else
                    i = m;

                if (this.ScreenObject.Preferences.ContainsKey("linkSingleline") && this.ScreenObject.Preferences["linkSingleline"] != ""
                    && parseBoolean(this.ScreenObject.Preferences["linkSingleline"]) && i > 0)
                    break;

                if (this.ScreenObject.Preferences.ContainsKey("LinkOnlyFreeQTY") && parseBoolean(this.ScreenObject.Preferences["LinkOnlyFreeQTY"]) &&
                    ds.Columns[0].Contains("IsQtyFreeOffer") && Util.Int(ds.Tables[0][i]["IsQtyFreeOffer"]) > 0 &&
                    !(ds.Columns[0].Contains("ParentSchemeID") && Util.Int(ds.Tables[0][i]["ParentSchemeID"]) > 0))
                    continue;

                let drrecord: any = null;
                if (ids && ids.length > 0) {
                    let Exists = false;
                    for (let h = 0; h < ids.length; h++) {
                        if (parseInt(ids[h]["InvDocDetailsID"]) == parseInt(ds.Tables[0][i]["DocDetailsID"])) {
                            drrecord = ids[h];
                            Exists = true;
                            break;
                        }
                    }
                    if (!Exists)
                        continue;
                }

                if (ds.Columns[0].Contains("DynamicInvDocDetailsID") && !Util.IsEmpty(ds.Tables[0][i]["DynamicInvDocDetailsID"]) && Util.IsValidID(parseInt(ds.Tables[0][i]["DynamicInvDocDetailsID"])))
                    continue;

                for (let m = 0; m < NodeIDs.keys.length; m++) {
                    let item = { Key: NodeIDs.keys[m], Value: NodeIDs.values[m] };
                    if (item.Key == 3) {
                        if (ds.Columns[0].Contains("ProductColName") && !Util.IsEmpty(ds.Tables[0][i]["ProductColName"])
                            && ds.Columns[3].Contains(ds.Tables[0][i]["ProductColName"].toString()) && !Util.IsEmpty(ds.Tables[3][i][ds.Tables[0][i]["ProductColName"].toString()])
                            && Util.IsNum(ds.Tables[3][i][ds.Tables[0][i]["ProductColName"].toString()]) && parseInt(ds.Tables[3][i][ds.Tables[0][i]["ProductColName"].toString()]) != item.Value)
                            continue;
                    }
                    else if (item.Key > 50000) {
                        if (ds.Columns[1].Contains("dcCCNID" + (item.Key - 50000).toString()) && !Util.IsEmpty(ds.Tables[1][i]["dcCCNID" + (item.Key - 50000).toString()]) && parseInt(ds.Tables[1][i]["dcCCNID" + (item.Key - 50000).toString()]) != item.Value)
                            continue;
                    }
                }

                if (this.ScreenObject.Preferences.ContainsKey("ClubSameProds") && this.ScreenObject.Preferences["ClubSameProds"] != ""
                    && parseBoolean(this.ScreenObject.Preferences["ClubSameProds"]) && !Util.IsEmpty(ds.Tables[0][i]["ProductID"])) {
                    let SamePrdRow = this.ScreenObject.GridData.filter(x => x.ProductID_Key == ds.Tables[0][i]["ProductID"].toString());

                    if (SamePrdRow.length > 0) {
                        if (!Util.IsEmpty(SamePrdRow[0]["Quantity"]))
                            SamePrdRow[0]["defaultQuantity"] = SamePrdRow[0]["Quantity"] = parseFloat(SamePrdRow[0]["Quantity"]) + parseFloat(ds.Tables[0][i]["Quantity"]);

                        if (!Util.IsEmpty(SamePrdRow[0]["UOMConversion"]) && !Util.IsEmpty(SamePrdRow[0]["Quantity"])) {
                            SamePrdRow[0]["UOMConvertedQty"] = parseFloat(SamePrdRow[0]["Quantity"]) * parseFloat(SamePrdRow[0]["UOMConversion"]);
                        }
                        else if (!Util.IsEmpty(SamePrdRow[0]["Quantity"]))
                            SamePrdRow[0]["UOMConvertedQty"] = SamePrdRow[0]["Quantity"];

                        this.CalculateTotals(SamePrdRow[0], false, "", false);
                        continue;
                    }
                }

                let GrRows: any[] = null;
                drr = this.ScreenObject.GridDataObj.NewRow();
                this.FillDefaultValues(drr);
                for (let j = 0, ColumnNO = 0; j < this.ScreenObject.ColumnSource.length; j++, ColumnNO++) {
                    if (this.ScreenObject.ColumnSource[j].DisplayMember == "DocDetailsID" || this.ScreenObject.ColumnSource[j].DisplayMember == "RefNo" || this.ScreenObject.ColumnSource[j].DisplayMember == "LinkedFieldName")
                        continue;
                    else if (this.ScreenObject.ColumnSource[j].DataType == "LINK" && this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcalpha"))
                        drr[this.ScreenObject.ColumnSource[j].DisplayMember] = "...";
                    this.ScreenObject.SetLinkValues(ds, this.ScreenObject.ColumnSource[j], i, drr, CopyDt, "");
                }

                if (CopyDt == null && this.ScreenObject.Preferences.ContainsKey("GrouptoFilterfield") && this.ScreenObject.Preferences["GrouptoFilterfield"].toLowerCase() == "true"
                    && this.ScreenObject.Preferences.ContainsKey("ProductFilterField") && this.ScreenObject.Preferences["ProductFilterField"] != ""
                    && ds.Columns[0].Contains("IsGroup") && ds.Columns[0].Contains("ParentID")) {
                    let Gflcol = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["ProductFilterField"]);
                    if (Gflcol && Gflcol.DataType == "LISTBOX" && this.ScreenObject.GridDataColumns.Contains(Gflcol.ValueMember)) {
                        if (parseBoolean(ds.Tables[0][i]["IsGroup"])) {
                            drr["ProductID_Key"] = null;
                            if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                drr["ProductCode"] = null;
                            if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                                drr["ProductName"] = null;
                            drr[Gflcol.ValueMember] = ds.Tables[0][i]["ProductID"].toString();

                        }
                        else
                            drr[Gflcol.ValueMember] = ds.Tables[0][i]["ParentID"].toString();
                    }
                }
                if (this.IsInventoryVoucher && CopyDt == null && ds.Tables.length > 15 && ds.Tables[15].length > 0) {
                    let drPrs = ds.Tables[15].filter(x => x.DocDetailsID == ds.Tables[0][i]["DocDetailsID"]);
                    if (drPrs.length > 1 && this.ScreenObject.Preferences.ContainsKey("PopulateMultiple") && parseBoolean(this.ScreenObject.Preferences["PopulateMultiple"])) {
                        if (!this.ScreenObject.GridDataColumns.Contains("Row_Background"))
                            this.ScreenObject.GridDataColumns.push("Row_Background");
                        GrRows = [];
                        for (let k = 0; k < drPrs.length; k++) {
                            if (k == 0) {
                                drr["ProductID_Key"] = drPrs[k]["ProductID"];
                                if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                    drr["ProductCode"] = drPrs[k]["ProductCode"];
                                if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                                    drr["ProductName"] = drPrs[k]["ProductName"];

                                drr["Row_Background"] = "#c8D7D0";
                            }
                            else {
                                let grdr = this.ScreenObject.GridDataObj.NewRow();
                                grdr["ProductID_Key"] = drPrs[k]["ProductID"];
                                if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                    grdr["ProductCode"] = drPrs[k]["ProductCode"];
                                if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                                    grdr["ProductName"] = drPrs[k]["ProductName"];
                                grdr["Row_Background"] = "#c8D7D0";
                                GrRows.push(grdr);
                            }
                        }
                    }
                    else if (drPrs.length > 0) {
                        drr["ProductID_Key"] = drPrs[0]["ProductID"];
                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                            drr["ProductCode"] = drPrs[0]["ProductCode"];
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                            drr["ProductName"] = drPrs[0]["ProductName"];

                        if (drPrs.length > 1) {
                            if (!this.ScreenObject.GridDataColumns.Contains("Row_Background"))
                                this.ScreenObject.GridDataColumns.push("Row_Background");
                            drr["Row_Background"] = "#c8D7D0";
                        }
                    }
                    else {
                        if (!this.ScreenObject.GridDataColumns.Contains("Row_Background"))
                            this.ScreenObject.GridDataColumns.push("Row_Background");

                        drr["Row_Background"] = "#c9c9c9";

                        drr["ProductID_Key"] = ds.Tables[0][i]["ProductID"];
                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                            drr["ProductCode"] = ds.Tables[0][i]["ProductCode"];
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                            drr["ProductName"] = ds.Tables[0][i]["ProductName"];
                    }
                }

                if (cols.length > 0 && drrecord != null) {
                    for (let m = 0; m < cols.length; m++) {
                        let descol: string = cols[m]
                        if (this.ScreenObject.GridDataColumns.Contains(descol)) {
                            let descc = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != "Name" && a.DisplayMember == descol);
                            if (!descc)
                                descc = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Name" && a.ValueBinding == descol);
                            if (descc) {
                                if (descc.CostCenterID > 0 && !Util.IsEmpty(drrecord[descc.ValueMember]) && !Util.IsEmpty(drrecord[descc.ValueMember]))
                                    drr[descc.ValueMember] = drrecord[descc.ValueMember];
                                else if ((descc.DataType == "DATE" || descc.DataType == "DateTime" || descc.DataType.toLowerCase() == "time") && !Util.IsEmpty(drrecord[descc.DisplayMember + "_Key"]) && !Util.IsEmpty(drrecord[descc.DisplayMember + "_Key"])) {
                                    if (Util.isValidDate(drrecord[descc.DisplayMember + "_Key"])) {
                                        if (descc.DataType == "DateTime") {
                                            drr[descc.DisplayMember] = Util.ParseDate(drrecord[descc.DisplayMember]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");
                                            drr[descc.DisplayMember + "_Key"] = Util.ParseDate(drrecord[descc.DisplayMember + "_Key"]);
                                        }
                                        else if (descc.DataType == "time") {
                                            drr[descc.DisplayMember] = Util.ParseDate(drrecord[descc.DisplayMember]).ToString("hh:mm:ss tt");
                                            drr[descc.DisplayMember + "_Key"] = Util.ParseDate(drrecord[descc.DisplayMember + "_Key"]);
                                        }
                                        else {
                                            drr[descc.DisplayMember] = drrecord[descc.DisplayMember].toString();
                                            drr[descc.DisplayMember + "_Key"] = Util.ParseDate(drrecord[descc.DisplayMember + "_Key"]);
                                        }
                                    }
                                }
                                else if (descc.DisplayMember == "Name" && !Util.IsEmpty(drrecord[descc.ValueBinding]) && !Util.IsEmpty(drrecord[descc.ValueBinding]))
                                    drr[descc.ValueBinding] = drrecord[descc.ValueBinding].toString();
                                else if (!Util.IsEmpty(drrecord[descc.DisplayMember]))
                                    drr[descc.DisplayMember] = drrecord[descc.DisplayMember].toString();
                            }
                        }
                        else {
                            let fld = this.ScreenObject._TextFields.find(a => a.DBColumnName == descol);
                            if (fld == null)
                                fld = this.ScreenObject._CCFields.find(a => a.DBColumnName == descol);
                            if (fld == null)
                                fld = this.ScreenObject._StaticFields.find(a => a.DBColumnName == descol);
                            if (fld) {
                                if (fld instanceof PactExtraFieldDateData) {
                                    if (!Util.IsEmpty(drrecord[descol + "_Key"]))
                                        this.ScreenObject.fillcontrolValue(fld, drrecord[descol + "_Key"]);
                                }
                                else if (fld instanceof PactDatePickerData) {
                                    if (!Util.IsEmpty(drrecord[descol + "_Key"]))
                                        this.ScreenObject.fillcontrolValue(fld, drrecord[descol + "_Key"]);
                                }
                                else if (fld instanceof PactListBoxData || fld instanceof PactCodeNameListBoxData) {
                                    if (!Util.IsEmpty(drrecord[descol + "_Key"]))
                                        this.ScreenObject.fillcontrolValue(fld, drrecord[descol + "_Key"].toString());
                                    if (fld instanceof PactListBoxData)
                                        this.ScreenObject.GetLinkReferenceData(fld.DBColumnID, this.CostCenterID, fld.SelectedValue, this.DocumentDate, (fld).DBColumnName, fld.CCID, null);
                                    else
                                        this.ScreenObject.GetLinkReferenceData(fld.DBColumnID, this.CostCenterID, fld.SelectedValue, this.DocumentDate, (fld).DBColumnName, fld.CCID, null);

                                }
                                else if (!Util.IsEmpty(drrecord[descol]))
                                    this.ScreenObject.fillcontrolValue(fld, drrecord[descol].toString());
                            }
                        }
                    }
                }
                if (this.IsInventoryVoucher) {
                    if (CopyDt == null && !this.ScreenObject.RWFieldsExists.Contains("QOH") &&
                        ((this.ScreenObject.Preferences.ContainsKey("CheckStock") && this.ScreenObject.Preferences["CheckStock"].toString() != ""
                            && parseBoolean(this.ScreenObject.Preferences["CheckStock"]))
                            || (this.ScreenObject.Preferences.ContainsKey("CheckFifoQOH") && this.ScreenObject.Preferences["CheckFifoQOH"].toString() != ""
                                && parseBoolean(this.ScreenObject.Preferences["CheckFifoQOH"]))
                            || (this.ScreenObject.Preferences.ContainsKey("LinkPartial") && this.ScreenObject.Preferences["LinkPartial"].toString() != ""
                                && parseBoolean(this.ScreenObject.Preferences["LinkPartial"]))))
                        this.ScreenObject.RWFieldsExists.push("QOH");

                    let DsAvg: any = null;
                    if (prodDics != null && prodDics.ContainsKey(parseInt(drr["ProductID_Key"].toString())))
                        DsAvg = this.GetProductValues(drr, 0, true, null, false, prodDics[parseInt(drr["ProductID_Key"].toString())]);
                    else
                        DsAvg = this.GetProductValues(drr, 0, true);

                    if (prodDics != null && !prodDics.ContainsKey(parseInt(drr["ProductID_Key"].toString())))
                        prodDics.push(parseInt(drr["ProductID_Key"].toString()), DsAvg);
                    if (DsAvg != null && DsAvg.Tables.length > 0 && DsAvg.Tables[0].length > 0 && !DsAvg.Columns[0].Contains("ErrorMessage") &&
                        DsAvg.Columns[0].Contains("ProductTypeID") && ds.Tables[0][i]["ProductTypeID"].toString() != "8") {
                        if (ds.Columns[0].Contains("FileGUID")) {
                            drr["FileGUID"] = DsAvg.Tables[0][0]["FileGUID"].toString();
                            drr["FileExtension"] = DsAvg.Tables[0][0]["FileExtension"].toString();
                        }
                        if (parseInt(drr["ProductID_Key"]) != this.ScreenObject.TempProductID) {
                            let QOH = 0;
                            if (DsAvg.Columns[0].Contains("QOH") && !Util.IsEmpty(DsAvg.Tables[0][0]["QOH"]))
                                drr["QOH"] = DsAvg.Tables[0][0]["QOH"].toString();
                            else
                                drr["QOH"] = 0;

                            if (!Util.IsEmpty(drr["QOH"]))
                                QOH = parseFloat(drr["QOH"]);

                            if (CopyDt == null && this.ScreenObject.Preferences.ContainsKey("CheckFifoQOH") && this.ScreenObject.Preferences["CheckFifoQOH"].toString() != ""
                                && parseBoolean(this.ScreenObject.Preferences["CheckFifoQOH"])
                                && ds.Columns[0].Contains("Fifo") && !Util.IsEmpty(ds.Tables[0][i]["Fifo"]))
                                QOH -= parseFloat(ds.Tables[0][i]["Fifo"]);

                            if (CopyDt == null && this.ScreenObject.Preferences.ContainsKey("CheckStock") && this.ScreenObject.Preferences["CheckStock"].toString() != ""
                                && parseBoolean(this.ScreenObject.Preferences["CheckStock"])) {
                                if (!Util.IsEmpty(ds.Tables[0][i][ds.Columns[0][0]]) && parseFloat(ds.Tables[0][i][ds.Columns[0][0]]) > QOH)
                                    continue;
                            }

                            if (CopyDt == null && this.ScreenObject.Preferences.ContainsKey("LinkPartial") && this.ScreenObject.Preferences["LinkPartial"].toString() != ""
                                && parseBoolean(this.ScreenObject.Preferences["LinkPartial"])) {
                                if (!Util.IsEmpty(ds.Tables[0][i][ds.Columns[0][0]]) && QOH <= 0)
                                    continue;
                                else if (!Util.IsEmpty(ds.Tables[0][i][ds.Columns[0][0]]) && QOH < parseFloat(ds.Tables[0][i][ds.Columns[0][0]]))
                                    ds.Tables[0][i][ds.Columns[0][0]] = QOH;
                            }

                            if (DsAvg.Columns[0].Contains("BalQOH") && !Util.IsEmpty(DsAvg.Tables[0][0]["BalQOH"]))
                                drr["BalQOH"] = DsAvg.Tables[0][0]["BalQOH"].toString();
                            else
                                drr["BalQOH"] = 0;

                            if (DsAvg.Columns[0].Contains("HOLDQTY") && !Util.IsEmpty(DsAvg.Tables[0][0]["HOLDQTY"]))
                                drr["HOLDQTY"] = DsAvg.Tables[0][0]["HOLDQTY"].toString();
                            else
                                drr["HOLDQTY"] = 0;

                            if (DsAvg.Columns[0].Contains("CommittedQty") && !Util.IsEmpty(DsAvg.Tables[0][0]["CommittedQty"]))
                                drr["CommittedQty"] = DsAvg.Tables[0][0]["CommittedQty"].toString();
                            else
                                drr["CommittedQty"] = 0;
                            if (DsAvg.Columns[0].Contains("RESERVEQTY") && !Util.IsEmpty(DsAvg.Tables[0][0]["RESERVEQTY"]))
                                drr["RESERVEQTY"] = DsAvg.Tables[0][0]["RESERVEQTY"].toString();
                            else
                                drr["RESERVEQTY"] = 0;
                            if (DsAvg.Columns[0].Contains("TotalReserve") && !Util.IsEmpty(DsAvg.Tables[0][0]["TotalReserve"]))
                                drr["TotalReserve"] = DsAvg.Tables[0][0]["TotalReserve"].toString();
                            else
                                drr["TotalReserve"] = 0;
                        }

                        if (DsAvg.Tables.length > 0 && DsAvg.Tables[0].length > 0 && !DsAvg.Columns[0].Contains("ErrorMessage")
                            && !Util.IsEmpty(DsAvg.Tables[0][0]["DrAccount"]) && parseInt(DsAvg.Tables[0][0]["DrAccount"]) > 0) {
                            if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key")) {
                                drr["DebitAccount_Key"] = DsAvg.Tables[0][0]["DrAccount"].toString();
                                if (this.ScreenObject.GridDataColumns.Contains("DebitAccount"))
                                    drr["DebitAccount"] = DsAvg.Tables[0][0]["DrName"].toString();
                                else {
                                    let col = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "debitaccount_key");
                                    if (col)
                                        drr[col.DisplayMember] = DsAvg.Tables[0][0]["DrName"].toString();
                                }
                            }
                            else if (this.ScreenObject.DebitAccount != null) {
                                this.ScreenObject.DebitAccount.SelectedValue = parseInt(DsAvg.Tables[0][0]["DrAccount"]);
                                if (BaseService.SessionManager.Preferences.ContainsKey("DisableAutoLoad") && BaseService.SessionManager.Preferences["DisableAutoLoad"].toLowerCase() == "true")
                                    this.ScreenObject.DebitAccount.Name.SelectedValueText = DsAvg.Tables[0][0]["DrName"].toString();
                            }
                        }
                        if (DsAvg.Tables.length > 0 && DsAvg.Tables[0].length > 0 && !DsAvg.Columns[0].Contains("ErrorMessage")
                            && !Util.IsEmpty(DsAvg.Tables[0][0]["CrAccount"]) && parseInt(DsAvg.Tables[0][0]["CrAccount"]) > 0) {
                            if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")) {
                                drr["CreditAccount_Key"] = DsAvg.Tables[0][0]["CrAccount"].toString();
                                if (this.ScreenObject.GridDataColumns.Contains("CreditAccount"))
                                    drr["CreditAccount"] = DsAvg.Tables[0][0]["CrName"].toString();
                                else {
                                    let col = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "creditaccount_key");
                                    if (col)
                                        drr[col.DisplayMember] = DsAvg.Tables[0][0]["CrName"].toString();
                                }
                            }
                            else if (this.ScreenObject.CreditAccount != null) {
                                this.ScreenObject.CreditAccount.SelectedValue = parseInt(DsAvg.Tables[0][0]["CrAccount"]);
                                if (BaseService.SessionManager.Preferences.ContainsKey("DisableAutoLoad") && BaseService.SessionManager.Preferences["DisableAutoLoad"].toLowerCase() == "true")
                                    this.ScreenObject.CreditAccount.Name.SelectedValueText = DsAvg.Tables[0][0]["CrName"].toString();
                            }
                        }
                        if (DsAvg.Columns[0].Contains("LastPurchaseRate") && !Util.IsEmpty(DsAvg.Tables[0][0]["LastPurchaseRate"]))
                            drr["LASTPURCHASERATE"] = DsAvg.Tables[0][0]["LastPurchaseRate"].toString();
                        else
                            drr["LASTPURCHASERATE"] = 0;
                        if (DsAvg.Tables.length > 8 && DsAvg.Tables[8].length > 1 && !DsAvg.Columns[8].Contains("ErrorMessage")
                            && this.ScreenObject.Preferences.ContainsKey("EnableSubtitutes") && this.ScreenObject.Preferences["EnableSubtitutes"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["EnableSubtitutes"])) {
                            drr["Subexists"] = "1";
                        }
                        else
                            drr["Subexists"] = "0";
                        let drCCRate: any = null;
                        if (DsAvg.Tables.length > 3 && DsAvg.Tables[3].length > 0)
                            drCCRate = DsAvg.Tables[3][0];

                        let dv = null, dvDt;
                        if (CopyDt != null)
                            dvDt = CopyDt;
                        else
                            dvDt = ds.Tables[4];

                        dv = dvDt.filter(x => x.BASECOL == 'Rate');
                        if (CopyDt == null && ds.Columns[4].Contains("CostCenterIDLinked") && ds.Columns[0].Contains("CostCenterID")
                            && ds.Tables[0].length > 0)
                            dv = dvDt.filter(x => x.BASECOL == 'Rate' && x.CostCenterIDLinked == ds.Tables[0][0]["CostCenterID"]);
                        else
                            dv = dvDt.filter(x => x.BASECOL == 'Rate');
                        if (dv.length == 0) {
                            let RateCol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Rate");

                            let strRateColumn: string = "";
                            if (drCCRate != null)//prices
                            {
                                if (!Util.IsEmpty(RateCol.Formula) && !Util.IsEmpty(drCCRate[strRateColumn])) {
                                    strRateColumn = RateCol.Formula;
                                }
                                if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                                    strRateColumn = "PurchaseRate";
                                }
                                else
                                    strRateColumn = "SellingRate";
                                if (strRateColumn != "" && !Util.IsEmpty(drCCRate[strRateColumn])) {
                                    drr["Rate"] = drCCRate[strRateColumn].toString();
                                    drr["default" + "Rate"] = drCCRate[strRateColumn].toString();
                                }
                            }
                            else if (DsAvg.Tables.length > 0 && DsAvg.Tables[0].length > 0 && DsAvg.Columns[0].Contains("ProdBaseUOM")
                                && DsAvg.Tables[0][0]["ProdBaseUOM"].toString() != DsAvg.Tables[0][0]["uomid"].toString()) {
                                let dsunitpr: any = this.ScreenObject.GetPriceofUnit(drr["ProductID_Key"].toString(), this.DocumentDate, parseInt(drr["Unit_Key"]), drr);

                                if (!Util.IsEmpty(RateCol.Formula) && dsunitpr.Columns[1].Contains(strRateColumn)) {
                                    strRateColumn = RateCol.Formula;
                                }
                                if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                                    strRateColumn = "PurchaseRate";
                                }
                                else
                                    strRateColumn = "SellingRate";
                                let Conv = 0, tempdbl = 0;
                                if (dsunitpr.Tables.length > 0 && dsunitpr.Tables[0].length > 0 && !Util.IsEmpty(dsunitpr.Tables[0][0]["Conversion"]))
                                    Conv = parseFloat(dsunitpr.Tables[0][0]["Conversion"]);

                                if (dsunitpr.Tables.length > 1 && dsunitpr.Tables[1].length > 0 && dsunitpr.Columns[1].Contains(strRateColumn) && !Util.IsEmpty(dsunitpr.Tables[1][0][strRateColumn])) {
                                    if (dsunitpr.Columns[1].Contains("UOMID"))
                                        tempdbl = Conv * parseFloat(dsunitpr.Tables[1][0][strRateColumn]);
                                    else
                                        tempdbl = parseFloat(dsunitpr.Tables[1][0][strRateColumn]);
                                    drr["Rate"] = tempdbl.ToString("N" + RateCol.DecimalPoints);
                                    drr["default" + "Rate"] = tempdbl.ToString("N" + RateCol.DecimalPoints);
                                }
                            }
                            else if (DsAvg.Tables.length > 0 && DsAvg.Tables[0].length > 0 && !DsAvg.Columns[0].Contains("ErrorMessage")) {
                                if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                                    if (!Util.IsEmpty(DsAvg.Tables[0][0]["PurchaseRate"])) {
                                        drr["Rate"] = DsAvg.Tables[0][0]["PurchaseRate"].toString();
                                        drr["default" + "Rate"] = DsAvg.Tables[0][0]["PurchaseRate"].toString();
                                    }
                                    else
                                        drr["Rate"] = 0;
                                }
                                else if (!Util.IsEmpty(DsAvg.Tables[0][0]["SellingRate"])) {
                                    drr["Rate"] = DsAvg.Tables[0][0]["SellingRate"].toString();
                                    drr["default" + "Rate"] = DsAvg.Tables[0][0]["SellingRate"].toString();
                                }
                            }
                        }
                        this.FillLinkRefereceProducts(drr, DsAvg.Tables[0], drCCRate);

                        let NumColt = this.ScreenObject.ColumnSource.filter(a => a.DisplayMember.Contains("dcNum") && a.SectionID != 4);
                        if (DsAvg.Tables.length > 4)//Extra Fields
                        {
                            for (let n = 0; n < NumColt.length; n++) {
                                let item = NumColt[n];
                                if (item.linkData > 0)
                                    continue;
                                if (CopyDt == null && dv.length > 0 && !Util.IsEmpty(dv[0]["CostCenterIDLinked"]) && ds.Columns[0].Contains("CostCenterID")
                                    && ds.Tables[0].length > 0)
                                    dv = dvDt.filter(x => x.BASECOL == item.DisplayMember && x.CostCenterIDLinked == ds.Tables[0][0]["CostCenterID"]);
                                else
                                    dv = dvDt.filter(x => x.BASECOL == item.DisplayMember);
                                if (dv.length == 0) {
                                    let drrTaxFld = DsAvg.Tables[4].filter(x => x.SysColumnName == item.DisplayMember);
                                    if (drrTaxFld.length > 0) {
                                        drr[item.DisplayMember] = drrTaxFld[0]["Value"].toString();
                                        drr["default" + item.DisplayMember] = drrTaxFld[0]["Value"].toString();
                                    }
                                    //else if (DsAvg.Tables.length > 5)
                                    //{
                                    //    drrTaxFld = DsAvg.Tables[5].filter(x=>x.SysColumnName==item.DisplayMember);
                                    //    if (drrTaxFld.length > 0)
                                    //    {
                                    //        drr[item.DisplayMember] = drrTaxFld[0]["Value"].toString();
                                    //        drr["default" + item.DisplayMember] = drrTaxFld[0]["Value"].toString();
                                    //    }
                                    //}
                                }
                            }
                        }
                        if (DsAvg.Tables.length > 10 && DsAvg.Columns[10].Contains("BinId") && DsAvg.Tables[10].length > 0 && DsAvg.Tables[10][0]["BinId"].toString() != "0" && this.ScreenObject.Preferences.ContainsKey("BinsDimension") && parseInt(this.ScreenObject.Preferences["BinsDimension"]) > 50000) {
                            let bincol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == parseInt(this.ScreenObject.Preferences["BinsDimension"]));
                            if (bincol && this.ScreenObject.GridDataColumns.Contains(bincol.DisplayMember)) {
                                drr[bincol.DisplayMember] = DsAvg.Tables[10][0]["BinName"].toString();
                                drr[bincol.ValueMember] = DsAvg.Tables[10][0]["BinId"].toString();
                            }
                        }
                    }

                    let productcolumns = this.ScreenObject.ColumnSource.filter(a => a.ValueMember != null && a.ValueMember.toString().toLowerCase() == "productid_key");
                    if (productcolumns != null) {
                        let dvCnt, dvCntDt = this.ScreenObject.Data.Tables[0];
                        let Callexists = false;

                        if (this.ScreenObject.Preferences.ContainsKey("FillLocalRef") && this.ScreenObject.Preferences["FillLocalRef"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["FillLocalRef"])) {
                            let lref = this.ScreenObject.Preferences["LocalRefflds"].toString().split(',');

                            this.ScreenObject.ColumnSource.forEach(prodcol => {
                                if (prodcol.CostCenterID == 3 && !(this.ScreenObject.Preferences["LocalRefflds"].toString().length > 0 && !lref.Contains(prodcol.ID))) {
                                    if (prodcol.ValueMember != "" && drr[prodcol.ValueMember] != null && !Util.IsEmpty(drr[prodcol.ValueMember])
                                        && (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && (x.LocalReference == prodcol.ID || (x.LocalReference == 79 && (x.LinkData == 26585 || x.LinkData == 53529 || x.LinkData == 53589 || x.LinkData == 53530)))).length > 0)) {
                                        this.ScreenObject.GetLinkReferenceData(parseInt(prodcol.ID), this.DocumentID, parseInt(drr[prodcol.ValueMember]), Date.Today(), "", prodcol.CostCenterID, drr, null, false);
                                    }
                                }
                                else if (prodcol.CostCenterID != 3 && lref.Contains(prodcol.ID)) {
                                    if (prodcol.ValueMember != "" && drr[prodcol.ValueMember] != null && !Util.IsEmpty(drr[prodcol.ValueMember])
                                        && (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == prodcol.ID).length > 0)) {
                                        this.ScreenObject.GetLinkReferenceData(parseInt(prodcol.ID), this.DocumentID, parseInt(drr[prodcol.ValueMember]), Date.Today(), "", prodcol.CostCenterID, drr, null, false);
                                    }
                                }
                            });
                        }
                        else {
                            productcolumns.forEach(prodcol => {
                                if (prodcol.CostCenterID > 0 && !Callexists) {
                                    dvCnt = dvCntDt.filter(x => x.LocalReference == 79 && (x.LinkData == 26585 || x.LinkData == 54306 || x.LinkData == 54307 || x.LinkData == 53529 || x.LinkData == 53589 || x.LinkData == 53530));
                                    if (dvCnt.length > 0 && !Util.IsEmpty(prodcol.ValueMember) && !Util.IsEmpty(drr[prodcol.ValueMember])) {
                                        Callexists = true;
                                        this.ScreenObject.GetLinkReferenceData(parseInt(prodcol.ID), this.DocumentID, parseInt(drr[prodcol.ValueMember]), Date.Today(), "", prodcol.CostCenterID, drr, null, false);
                                    }
                                }
                            });
                        }
                    }

                    if (CopyDt == null) {
                        drr[ds.Tables[0][i][ds.Columns[0][3]].toString()] = ds.Tables[0][i][ds.Columns[0][0]];

                        drr["defaultQuantity"] = drr["Quantity"];

                        drr["TolVal"] = ds.Tables[0][i]["ToleranceLimitsValue"].toString();
                        drr["TolPer"] = ds.Tables[0][i]["PercentValue"].toString();
                        drr["LinkedInvDocDetailsID"] = ds.Tables[0][i]["DocDetailsID"].toString();
                        drr["RefNo"] = ds.Tables[0][i]["VoucherNO"].toString();

                        drr["LinkedFieldName"] = ds.Tables[0][i][ds.Columns[0][3]].toString();

                        let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference == 79 && x.LinkData == 53735);
                        if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                            if (ds.Columns[0].Contains("Executed"))
                                drr[dvCnt[0]["SysColumnName"]] = ds.Tables[0][i]["Executed"].toString();
                            else
                                drr[dvCnt[0]["SysColumnName"]] = parseFloat(ds.Tables[0][i]["Quantity"]) - parseFloat(ds.Tables[0][i][ds.Columns[0][0]]);
                        }

                        if (ds.Tables[0].length > 0 && ds.Columns[0].Contains("IsQtyFreeOffer") && !Util.IsEmpty(ds.Tables[0][i]["IsQtyFreeOffer"])
                            && parseInt(ds.Tables[0][i]["IsQtyFreeOffer"]) > 0 && this.ScreenObject.GridDataColumns.Contains("FreeQTY")) {

                            if (ds.Columns[0].Contains("ParentSchemeID") && !Util.IsEmpty(ds.Tables[0][i]["ParentSchemeID"])
                                && ds.Tables[0][i]["ParentSchemeID"].toString() != "0" && this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(ds.Tables[0][i]["IsQtyFreeOffer"])
                                && parseInt(ds.Tables[0][i]["IsQtyFreeOffer"]) > 0) {
                                drr["FreeQTY"] = ds.Tables[0][i]["Quantity"];
                                drr["Quantity"] = 0;
                            }

                            drr["SchemeID"] = ds.Tables[0][i]["IsQtyFreeOffer"].toString();
                            let schpr = this.ScreenObject.GridData.filter(x => x.SchemeID != 1 && x.SchemeID == ds.Tables[0][i]["IsQtyFreeOffer"]);
                            if (schpr.length > 0)
                                drr["MaxSchemeID"] = schpr[0]["MaxSchemeID"];
                            else {
                                let MaxSchemeID = 0;
                                let templink = this.ScreenObject.GridData.Compute("max", "MaxSchemeID");
                                if (templink != null)
                                    MaxSchemeID = Util.Int(templink);
                                MaxSchemeID++;
                                drr["MaxSchemeID"] = MaxSchemeID;
                            }
                            if (drr["SchemeID"].toString() == "1") {
                                drr["IsScheme"] = "Y";
                                drr["FreeQTY"] = drr["quantity"];
                                drr["quantity"] = 0;
                            }
                            else if (ds.Columns[0].Contains("ParentSchemeID") && !Util.IsEmpty(ds.Tables[0][i]["ParentSchemeID"])
                                && ds.Tables[0][i]["ParentSchemeID"].toString() != "0")
                                drr["IsScheme"] = "Y";
                            else
                                drr["IsScheme"] = "N";

                        }
                    }
                    if (Util.IsEmpty(drr["Unit_Key"]) && DsAvg != null && DsAvg.Tables.length > 0 && DsAvg.Columns[0].Contains("uomid") && !Util.IsEmpty(DsAvg.Tables[0][0]["uomid"])) {
                        drr["Unit"] = DsAvg.Tables[0][0]["UnitName"].toString();
                        drr["Unit_Key"] = DsAvg.Tables[0][0]["uomid"].toString();
                        if (DsAvg.Columns[0].Contains("UOMConversion")) {
                            drr["UOMConversion"] = DsAvg.Tables[0][i]["UOMConversion"].toString();
                            if (!Util.IsEmpty(DsAvg.Tables[0][i]["UOMConversion"]) && !Util.IsEmpty(drr["Quantity"])) {
                                drr["UOMConvertedQty"] = parseFloat(drr["Quantity"]) * parseFloat(DsAvg.Tables[0][i]["UOMConversion"]);
                            }
                            else if (!Util.IsEmpty(drr["Quantity"]))
                                drr["UOMConvertedQty"] = drr["Quantity"];

                        }
                        else {
                            drr["UOMConversion"] = 1;
                            if (!Util.IsEmpty(drr["Quantity"]))
                                drr["UOMConvertedQty"] = drr["Quantity"];
                        }
                    }
                    else {
                        if (ds.Columns[0].Contains("UOMConversion")) {
                            drr["UOMConversion"] = ds.Tables[0][i]["UOMConversion"].toString();
                            if (!Util.IsEmpty(ds.Tables[0][i]["UOMConversion"]) && !Util.IsEmpty(drr["Quantity"])) {
                                drr["UOMConvertedQty"] = parseFloat(drr["Quantity"]) * parseFloat(ds.Tables[0][i]["UOMConversion"]);
                            }
                            else if (!Util.IsEmpty(drr["Quantity"]))
                                drr["UOMConvertedQty"] = drr["Quantity"];

                        }
                        else {
                            drr["UOMConversion"] = 1;
                            if (!Util.IsEmpty(drr["Quantity"]))
                                drr["UOMConvertedQty"] = drr["Quantity"];
                        }
                    }
                    if (ds.Columns[0].Contains("ProductTypeID")) {
                        if (DsAvg != null && DsAvg.Tables.length > 0 && DsAvg.Columns[0].Contains("ProductTypeID") && DsAvg.Tables[0].length > 0)
                            drr["Type"] = DsAvg.Tables[0][0]["ProductTypeID"].toString();
                        else
                            drr["Type"] = ds.Tables[0][i]["ProductTypeID"].toString();

                        if (DsAvg != null && DsAvg.Tables.length > 0 && DsAvg.Columns[0].Contains("BinWise") && DsAvg.Tables[0].length > 0)
                            drr["BinWise"] = DsAvg.Tables[0][0]["BinWise"];

                        if (this.ScreenObject.GridDataColumns.Contains("QtyType") && ds.Columns[0].Contains("QtyAdjustType"))
                            drr["QtyType"] = ds.Tables[0][i]["QtyAdjustType"];

                        if (this.ScreenObject.GridDataColumns.Contains("PackType") && ds.Columns[0].Contains("IsPacking"))
                            drr["PackType"] = ds.Tables[0][i]["IsPacking"];

                        if (this.ScreenObject.GridDataColumns.Contains("IsTestCase") && DsAvg.Columns[0].Contains("TestCaseExists"))
                            drr["IsTestCase"] = DsAvg.Tables[0][0]["TestCaseExists"];

                        if (this.ScreenObject.GridDataColumns.Contains("landingType") && ds.Columns[0].Contains("IsBillOfEntry"))
                            drr["landingType"] = ds.Tables[0][i]["IsBillOfEntry"];

                        if (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(drr["FreeQTY"]) && parseFloat(drr["FreeQTY"]) > 0) {
                            if (!Util.IsEmpty(drr["UOMConversion"]))
                                drr["UOMConvertedQty"] = parseFloat(drr["FreeQTY"]) * parseFloat(drr["UOMConversion"]);
                            else
                                drr["UOMConvertedQty"] = drr["FreeQTY"];
                        }
                    }
                    if (CopyDt == null) {
                        if (!Util.IsEmpty(ds.Tables[0][i]["ProductTypeID"]) && (parseInt(ds.Tables[0][i]["ProductTypeID"]) == 8 || parseInt(ds.Tables[0][i]["ProductTypeID"]) == 3 || parseInt(ds.Tables[0][i]["ProductTypeID"]) == 11 || parseInt(ds.Tables[0][i]["ProductTypeID"]) == 12)) {

                            let dtkitprds: any = null;
                            if (parseInt(ds.Tables[0][i]["ProductTypeID"].toString()) == 11 || parseInt(ds.Tables[0][i]["ProductTypeID"].toString()) == 12)
                                dtkitprds = DsAvg;

                            let drset = ds.Tables[0].filter(x => x.DynamicInvDocDetailsID == ds.Tables[0][i]["DocDetailsID"]);
                            if (drset.length == 0)
                                continue;
                            else {
                                let dynsb = "";
                                dynsb += "<xml>";
                                for (let d = 0; d < drset.length; d++) {
                                    dynsb += "<Row ><xml ";

                                    let dynsbRow = "";
                                    let CCQuery = "";
                                    let NumQuery = "";

                                    let IsProductIDAdded = false;
                                    for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                                        if (this.ScreenObject.ColumnSource[j].DisplayMember == "DocDetailsID" || this.ScreenObject.ColumnSource[j].DisplayMember == "DocSeqNo" || this.ScreenObject.ColumnSource[j].DisplayMember == "LinkedInvDocDetailsID" || this.ScreenObject.ColumnSource[j].DisplayMember == "RefNo" || this.ScreenObject.ColumnSource[j].DisplayMember == "LinkedFieldName" || this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == ds.Tables[0][i][Object.keys(ds.Tables[0][i])[3]].toString().toLowerCase())
                                            continue;
                                        if (this.ScreenObject.ColumnSource[j].CostCenterID == 3) {
                                            if (IsProductIDAdded)
                                                continue;
                                            else
                                                IsProductIDAdded = true;
                                        }
                                        dynsbRow += this.ScreenObject.SetDynamicsetLinkValues(ds, this.ScreenObject.ColumnSource[j], ds.Tables[0].indexOf(drset[d]), CopyDt);
                                        if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcccnid"))
                                            CCQuery += this.ScreenObject.SetDynamicsetNumLinkValues(ds, this.ScreenObject.ColumnSource[j], ds.Tables[0].indexOf(drset[d]), CopyDt);
                                        if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcnum"))
                                            NumQuery += this.ScreenObject.SetDynamicsetNumLinkValues(ds, this.ScreenObject.ColumnSource[j], ds.Tables[0].indexOf(drset[d]), CopyDt);
                                    }

                                    let qqty: number = 1;
                                    let unit = 0;
                                    qqty = Util.Double(drset[d]["Quantity"]);
                                    if (qqty == 0)
                                        qqty = 1;
                                    if (!Util.IsEmpty(drset[d]["Unit"]))
                                        unit = parseInt(drset[d]["Unit"]);

                                    if (!Util.IsEmpty(drset[d]["ProductID"]))
                                        DsAvg = this.ScreenObject.GetProductTypeDetails(drset[d]["ProductID"].toString(), this.DocumentDate, unit, qqty, "0", ds.Tables[1][ds.Columns[1][ds.Tables[0].indexOf(drset[d])]], true, null, false, 0, this.Currency);
                                    if (DsAvg != null && DsAvg.Tables.length > 0 && DsAvg.Tables[0].length > 0) {
                                        if (DsAvg.Columns[0].Contains("AvgRate") && !Util.IsEmpty(DsAvg.Tables[0][0]["AvgRate"]))
                                            dynsbRow += " AverageRate=\"" + DsAvg.Tables[0][0]["AvgRate"].toString() + "\" ";
                                    }

                                    if (DsAvg.Tables.length > 0 && DsAvg.Tables[0].length > 0 && !DsAvg.Columns[0].Contains("ErrorMessage")) {
                                        if (DsAvg.Columns[0].Contains("QOH") && !Util.IsEmpty(DsAvg.Tables[0][0]["QOH"]))
                                            dynsbRow += " QOH=\"" + DsAvg.Tables[0][0]["QOH"].toString() + "\" ";

                                        if (DsAvg.Columns[0].Contains("BalQOH") && !Util.IsEmpty(DsAvg.Tables[0][0]["BalQOH"]))
                                            dynsbRow += " BalQOH=\"" + DsAvg.Tables[0][0]["BalQOH"].toString() + "\" ";

                                        if (DsAvg.Columns[0].Contains("HOLDQTY") && !Util.IsEmpty(DsAvg.Tables[0][0]["HOLDQTY"]))
                                            dynsbRow += " HOLDQTY=\"" + DsAvg.Tables[0][0]["HOLDQTY"].toString() + "\" ";

                                        if (DsAvg.Columns[0].Contains("CommittedQty") && !Util.IsEmpty(DsAvg.Tables[0][0]["CommittedQty"]))
                                            dynsbRow += " CommittedQty=\"" + DsAvg.Tables[0][0]["CommittedQty"].toString() + "\" ";

                                        if (DsAvg.Columns[0].Contains("RESERVEQTY") && !Util.IsEmpty(DsAvg.Tables[0][0]["RESERVEQTY"]))
                                            dynsbRow += " RESERVEQTY=\"" + DsAvg.Tables[0][0]["RESERVEQTY"].toString() + "\" ";

                                        if (DsAvg.Columns[0].Contains("TotalReserve") && !Util.IsEmpty(DsAvg.Tables[0][0]["TotalReserve"]))
                                            dynsbRow += " TotalReserve=\"" + DsAvg.Tables[0][0]["TotalReserve"].toString() + "\" ";

                                        if (DsAvg.Columns[0].Contains("LastPurchaseRate") && !Util.IsEmpty(DsAvg.Tables[0][0]["LastPurchaseRate"]))
                                            dynsbRow += " LASTPURCHASERATE=\"" + DsAvg.Tables[0][0]["LastPurchaseRate"].toString() + "\" ";

                                        this.FillLinkRefereceProducts_2(dynsbRow, DsAvg.Tables[0]);
                                        if (DsAvg.Tables.length > 10 && DsAvg.Columns[10].Contains("BinId") && DsAvg.Tables[10].length > 0 && DsAvg.Tables[10][0]["BinId"].toString() != "0" && this.ScreenObject.Preferences.ContainsKey("BinsDimension") && parseInt(this.ScreenObject.Preferences["BinsDimension"]) > 50000) {
                                            let bincol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == parseInt(this.ScreenObject.Preferences["BinsDimension"]));
                                            if (bincol && this.ScreenObject.GridDataColumns.Contains(bincol.DisplayMember)) {
                                                dynsbRow += " " + bincol.DisplayMember + "=\"" + DsAvg.Tables[10][0]["BinName"].toString() + "\" ";
                                                dynsbRow += " " + bincol.ValueMember + "=\"" + DsAvg.Tables[10][0]["BinId"].toString() + "\" ";
                                            }
                                        }
                                    }

                                    dynsbRow += " DocDetailsID=\"0\" ";
                                    if (CopyDt == null) {
                                        dynsbRow += " LinkedInvDocDetailsID=\"" + drset[d]["DocDetailsID"].toString() + "\" ";
                                        dynsbRow += " LinkedFieldName=\"" + drset[d][Object.keys(drset[d])[3]].toString() + "\" ";
                                        dynsbRow += " LinkedFieldValue=\"" + drset[d][Object.keys(drset[d])[0]].toString() + "\" ";
                                        dynsbRow += " RefNo=\"" + Util.String(drset[d]["VoucherNo"]) + "\" ";
                                        dynsbRow += " " + Util.String(ds.Tables[0][i][ds.Columns[0][3]]) + "=\"" + Util.String(drset[d][0]) + "\" ";
                                        if (Util.IsEmpty(ds.Tables[0][i][ds.Columns[0][3]]) && ds.Tables[0][i][ds.Columns[0][3]].toString().toLowerCase().Contains("dcnum"))
                                            NumQuery += Util.String(ds.Tables[0][i][ds.Columns[0][3]]) + "=" + Util.String(drset[d][Object.keys(drset[d])[0]]) + ",";

                                    }
                                    dynsbRow += " DocSeqNo" + "=\"" + (d + 1).toString() + "\" ";
                                    dynsb += " CCQuery=\"" + CCQuery + "\" ";
                                    dynsb += " NumQuery=\"" + NumQuery + "\" ";


                                    if (ds.Columns[0].Contains("ProductTypeID")) {
                                        dynsbRow += " Type=\"" + drset[d]["ProductTypeID"].toString() + "\" ";

                                        if (ds.Tables[0][i]["ProductTypeID"].toString() == "3") {
                                            if (!Util.IsEmpty(drset[d]["Quantity"]) && !Util.IsEmpty(ds.Tables[0][i]["Quantity"]))
                                                dynsbRow += " defaultQuantity=\"" + parseFloat(drset[d]["Quantity"]) / parseFloat(ds.Tables[0][i]["Quantity"]) + "\" ";
                                            else
                                                dynsbRow += " defaultQuantity=\"" + drset[d]["Quantity"].toString() + "\" ";
                                        }
                                        if (ds.Columns[0].Contains("UOMConversion"))
                                            dynsbRow += " UOMConversion=\"" + drset[d]["UOMConversion"].toString() + "\" ";
                                        else
                                            dynsbRow += " UOMConversion=\"1\" ";

                                        if (!dynsbRow.toString().toLowerCase().Contains("unit_key=") && DsAvg.Tables.length > 0 && DsAvg.Columns[0].Contains("uomid") && !Util.IsEmpty(DsAvg.Tables[0][0]["uomid"])) {
                                            dynsbRow += " Unit_key=\"" + DsAvg.Tables[0][0]["uomid"].toString() + "\" ";
                                        }
                                    }
                                    dynsb += dynsbRow.toString() + " /></Row>";
                                }
                                dynsb += "</xml>";
                                drr["ExtraXML"] = dynsb;

                                let dsvm = new DynamicSetViewModel(this, drr, dtkitprds);
                                let splitcnt = 0;
                                for (let k = 0; k < dsvm.GridData.length; k++) {
                                    if (!Util.IsEmpty(dsvm.GridData[k]["ProductID_Key"])) {
                                        this.CalculateTotals(dsvm.GridData[k], false, "", false);
                                        splitcnt++;
                                    }
                                }
                                dsvm.OnButtonClick("AutoSave");
                                if (this.ScreenObject.Preferences.ContainsKey("SplitKit") && this.ScreenObject.Preferences["SplitKit"].toLowerCase() == "true") {
                                    if (splitcnt > 1)
                                        RecordsCount = RecordsCount + splitcnt - 1;
                                }
                            }
                        }
                        else if (!Util.IsEmpty(ds.Tables[0][i]["ProductTypeID"]) && parseInt(ds.Tables[0][i]["ProductTypeID"]) == 5 && ds.Tables[5].length > 0) {
                            let drrow = ds.Tables[5].filter(x => x.InvDocDetailsID == ds.Tables[0][i]["DocDetailsID"] || x.DynamicInvDocDetailsID == ds.Tables[0][i]["DocDetailsID"]);

                            if (drrow.length > 0 && ((ds.Columns[5].Contains("IsQtyIgnored") && drrow[0]["IsQtyIgnored"].toString() == "1") ||
                                (this.ScreenObject.Preferences.ContainsKey("CopyBatches") && !Util.IsEmpty(this.ScreenObject.Preferences["CopyBatches"]) && parseBoolean(this.ScreenObject.Preferences["CopyBatches"]))
                                || (this.ScreenObject.Preferences.ContainsKey("ConsBatch") && this.ScreenObject.Preferences["ConsBatch"] == "True"))) {
                                let sb = "";
                                let TotQty = 0;
                                sb += "<xml>";
                                for (let b = 0; b < drrow.length; b++) {
                                    sb += "<Row ";
                                    sb += " BatchID" + "=\"" + drrow[b]["BatchID"].toString() + "\" ";
                                    sb += " ProductID=\"" + drr["ProductID_Key"].toString() + "\" ";
                                    if (ds.Columns[5].Contains("RefInvDocDetailsID") && !Util.IsEmpty(drrow[b]["RefInvDocDetailsID"]))
                                        sb += " RefInvID" + "=\"" + drrow[b]["RefInvDocDetailsID"].toString() + "\" ";

                                    if (this.ScreenObject.Preferences.ContainsKey("ConsBatch") && this.ScreenObject.Preferences["ConsBatch"] == "True")
                                        sb += " LinkedID=\"" + drrow[b]["InvDocDetailsID"].toString() + "\" ";
                                    if (drrow.length > 1) {
                                        sb += " Quantity" + "=\"" + drrow[b]["Quantity"].toString() + "\" ";
                                        sb += " Hold" + "=\"0\" ";
                                        sb += " Release" + "=\"" + drrow[b]["Quantity"].toString() + "\" ";
                                        TotQty += parseFloat(drrow[b]["Quantity"]);
                                    }
                                    else {
                                        if (!Util.IsEmpty(drr["SchemeID"]) && parseInt(drr["SchemeID"]) > 0
                                            && drr["IsScheme"].toString() == "Y" && this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(drr["FreeQTY"])) {
                                            sb += " Quantity" + "=\"" + drr["FreeQTY"].toString() + "\" ";
                                            sb += " Hold" + "=\"0\" ";
                                            sb += " Release" + "=\"" + drr["FreeQTY"].toString() + "\" ";
                                        }
                                        else {
                                            // sb += " Quantity" + "=\"" + drr["Quantity"].toString() + "\" ";
                                            // sb += " Hold" + "=\"0\" ";
                                            // sb += " Release" + "=\"" + drr["Quantity"].toString() + "\" ";
                                            if (!Util.IsEmpty(drr["UOMConversion"]) && !Util.IsEmpty(drr["Quantity"])) {
                                                sb += " Quantity" + "=\"" + (parseFloat(drr["UOMConversion"].toString()) * parseFloat(drr["Quantity"].toString())).toString() + "\" ";
                                                sb += " Hold" + "=\"0\" ";
                                                sb += " Release" + "=\"" + (parseFloat(drr["UOMConversion"].toString()) * parseFloat(drr["Quantity"].toString())).toString() + "\" ";
                                            }
                                        }
                                    }
                                    sb += " ></Row>";
                                }
                                sb += "</xml>";
                                drr["ExtraXML"] = sb;
                                if (TotQty > 0) {
                                    drr["Quantity"] = TotQty;
                                    drr["UOMConvertedQty"] = drr["Quantity"].toString();
                                }
                            }
                        }
                        else if (!Util.IsEmpty(ds.Tables[0][i]["ProductTypeID"]) && (parseInt(ds.Tables[0][i]["ProductTypeID"]) == 2 || parseInt(ds.Tables[0][i]["ProductTypeID"]) == 10)
                            && ds.Tables.length > 8 && ds.Tables[8].length > 0 && this.ScreenObject.Preferences.ContainsKey("CopySerialNos") && this.ScreenObject.Preferences["CopySerialNos"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["CopySerialNos"])) {
                            let drrow = ds.Tables[8].filter(x => x.InvDocDetailsID == ds.Tables[0][i]["DocDetailsID"]);
                            if (drrow.length > 0) {
                                let sb = "";
                                sb += "<xml>";

                                let cnt = 0;
                                if (!Util.IsEmpty(drr["Quantity"]))
                                    cnt = parseFloat(drr["Quantity"]);

                                if (drrow.length < cnt)
                                    cnt = drrow.length;

                                for (let s = 0; s < cnt; s++) {
                                    sb += "<Row ";
                                    sb += " SerialProductID" + "=\"0\" ";
                                    sb += " SerialNumber" + "=\"" + Util.String(drrow[s]["SerialNumber"]) + "\" ";
                                    sb += " StockCode" + "=\"" + Util.String(drrow[s]["StockCode"]) + "\" ";
                                    sb += " Quantity" + "=\"" + Util.String(drrow[s]["Quantity"]) + "\" ";
                                    sb += " Narration" + "=\"\" ";
                                    if (this.VoucherType == 1) {
                                        sb += " IsIssue" + "=\"0\" ";
                                        sb += " StatusID" + "=\"157\" ";
                                        sb += " RefInvDocDetailsID" + "=\"0\" ";
                                        sb += " IsAvailable" + "=\"1\" ";
                                        sb += " SerialGUID" + "=\"" + Util.NewGuid() + "\" ";
                                    }
                                    else {
                                        sb += " IsIssue" + "=\"1\" ";
                                        sb += " StatusID" + "=\"158\" ";
                                        sb += " RefInvDocDetailsID=\"" + Util.String(drrow[s]["InvDocDetailsID"]) + "\" ";
                                        sb += " IsAvailable" + "=\"0\" ";
                                        sb += " SerialGUID" + "=\"" + Util.String(drrow[s]["SerialGUID"]) + "\" ";
                                    }
                                    sb += " ></Row>";
                                }
                                sb += "</xml>";
                                drr["ExtraXML"] = sb;
                            }
                        }
                    }

                    if (ds.Tables.length > 9 && ds.Columns[9].Contains("InvDocDetailsID") &&
                        this.ScreenObject.GridDataColumns.Contains("QtyType") && ds.Tables[9].length > 0) {
                        let sb = "";
                        let batches = ds.Tables[9].filter(x => x.InvDocDetailsID == ds.Tables[0][i]["DocDetailsID"]);

                        if (batches.length > 0) {
                            sb += "<QtyAdjustments>";
                            batches.forEach(item => {
                                sb += "<Row ";
                                for (let l = 0; l < ds.Columns[9].length; l++) {
                                    if (ds.Columns[9][l].Contains("Fld") && !Util.IsEmpty(item[ds.Columns[9][l]]))
                                        sb += ds.Columns[9][l] + "=\"" + PactTextBoxData.GetValidTextXml(item[ds.Columns[9][l]].toString()) + "\" ";
                                }
                                sb += "Islinked=\"1\" ";
                                sb += " ></Row>";
                            });
                            sb += "</QtyAdjustments>";
                            drr["QtyXML"] = sb;
                        }
                    }

                    if (this.ScreenObject.Preferences.ContainsKey("CopyBins") && this.ScreenObject.Preferences["CopyBins"].toLowerCase() == "true" && ds.Tables.length > 12 && ds.Columns[12].Contains("BinID") &&
                        this.ScreenObject.GridDataColumns.Contains("BinWise") && drr["BinWise"].toString() == "True" && ds.Tables[12].length > 0) {
                        let sb = "";
                        let bins = ds.Tables[12].filter(x => x.InvDocDetailsID == ds.Tables[0][i]["DocDetailsID"]);
                        if (bins.length > 0) {
                            sb += "<BinsXML>";
                            bins.forEach(item => {
                                sb += "<Row ";
                                sb += " NodeID=\"" + item["BinID"].toString() + "\" ";
                                sb += " Allocate" + "=\"" + item["Quantity"].toString() + "\" ";
                                sb += " Vol" + "=\"" + ds.Tables[0][i]["Volume"].toString() + "\" ";
                                sb += " Waist" + "=\"" + ds.Tables[0][i]["Wastage"].toString() + "\" ";

                                if (ds.Tables.length > 13 && ds.Tables[13].length > 0
                                    && !(this.ScreenObject.Preferences.ContainsKey("DonotCopyBOE") && this.ScreenObject.Preferences["DonotCopyBOE"].toLowerCase() == "true")) {
                                    var boes = ds.Tables[13].filter(x => x.Type == 1 && x.InvDocDetailsID == Util.String(ds.Tables[0][i]["DocDetailsID"]));
                                    if (boes.length > 0 && this.ScreenObject.GridDataColumns.Contains("DocExtraXML")) {
                                        sb += " RefID=\"" + Util.String(boes[0]["RefID"]) + "\" ";
                                    }
                                }

                                sb += " ></Row>";
                            });
                            sb += "</BinsXML>";
                            drr["BinsXML"] = sb;
                        }
                    }

                    if (ds.Tables.length > 13 && ds.Tables[13].length > 0) {
                        let sb = "";
                        let bins = ds.Tables[13].filter(x => x.Type == 1 && x.InvDocDetailsID == ds.Tables[0][i]["DocDetailsID"]);
                        if (!(this.ScreenObject.Preferences.ContainsKey("DonotCopyBOE") && this.ScreenObject.Preferences["DonotCopyBOE"].toLowerCase() == "true")) {
                            if (bins.length > 0 && this.ScreenObject.GridDataColumns.Contains("DocExtraXML")) {
                                sb += "<DocExtraXML>";
                                bins.forEach(item => {
                                    sb += "<Row ";
                                    sb += " RefID=\"" + item["RefID"].toString() + "\" ";
                                    sb += " Qty" + "=\"" + item["Quantity"].toString() + "\" ";
                                    sb += " Type" + "=\"" + item["Type"].toString() + "\" ";
                                    sb += " ></Row>";
                                    drr["BOEID"] = item["RefID"].toString();
                                });
                                sb += "</DocExtraXML>";
                                drr["DocExtraXML"] = sb;
                            }
                        }
                        else if (bins.length > 0 && this.ScreenObject.GridDataColumns.Contains("DocExtraXML")) {
                            if (!this.ScreenObject.GridDataColumns.Contains("LinkedBoe"))
                                this.ScreenObject.GridDataColumns.push("LinkedBoe");
                            drr["LinkedBoe"] = bins[0]["RefID"].toString();
                        }

                        let boerow = ds.Tables[4].filter(x => x.CostCenterColIDLinked == -5);
                        if (boerow.length > 0 && bins.length > 0 && this.ScreenObject.GridDataColumns.Contains(boerow[0]["BASECOL"].toString()))
                            drr[boerow[0]["BASECOL"].toString()] = bins[0]["RefID"].toString();

                        bins = ds.Tables[13].filter(x => x.Type == 2 && x.InvDocDetailsID == ds.Tables[0][i]["DocDetailsID"]);
                        if (bins.length > 0 && this.ScreenObject.GridDataColumns.Contains("PackXML")) {
                            if (this.DtPack == null) {
                                this.DtPack = [];//new DataTable()
                                this.DtPackColumns = []
                                this.DtPackColumns.push("ID");
                                this.DtPackColumns.push("Name");
                                this.DtPackColumns.push("Label");
                                this.DtPackColumns.push("cWeight");
                                this.DtPackColumns.push("cVolume");
                                this.DtPackColumns.push("Weight");
                                this.DtPackColumns.push("Volume");
                                this.DtPackColumns.push("Height");
                                this.DtPackColumns.push("length");
                                this.DtPackColumns.push("Width");
                                this.DtPackColumns.push("ActualWeight");//, typeof(double));
                                this.DtPackColumns.push("ActualVolume")//, typeof(double));

                                if ((this.ScreenObject.Preferences.ContainsKey("PackWiseProds") && this.ScreenObject.Preferences["PackWiseProds"].toLowerCase() == "true")
                                    || (this.ScreenObject.Preferences.ContainsKey("LineWisePacking") && this.ScreenObject.Preferences["LineWisePacking"].toLowerCase() == "true"))
                                    this.DtPackColumns.push("Data");


                                if ((this.ScreenObject.Preferences.ContainsKey("ScanwithPack") && this.ScreenObject.Preferences["ScanwithPack"].toLowerCase() == "true")
                                    || (this.ScreenObject.Preferences.ContainsKey("AllowDuplLbls") && this.ScreenObject.Preferences["AllowDuplLbls"].toLowerCase() == "true")) {
                                    this.DtPackColumns.push("ReportNo");
                                    this.DtPackColumns.push("LabID");
                                }
                            }

                            if (!this.ScreenObject.GridDataColumns.Contains("Unq"))
                                this.ScreenObject.GridDataColumns.push("Unq")//, typeof(int));

                            if (unq == null) {
                                unq = this.ScreenObject.GridData.Compute("max", "Unq");
                                if (unq != null)
                                    unq = parseInt(unq) + 1;
                                else
                                    unq = 0;
                            }

                            drr["Unq"] = unq;
                            unq = parseInt(unq) + 1;

                            sb = "";
                            sb += "<DocExtraXML>";
                            for (let b = 0; b < bins.length; b++) {
                                let item = bins[b]
                                if (Labels != null && !Labels.Contains(item["label"].toString()))
                                    continue;

                                if (Packids != "")
                                    Packids += ",";
                                Packids += item["RefID"].toString();

                                sb += "<Row ";
                                sb += " RefID=\"" + item["RefID"].toString() + "\" ";
                                sb += " Qty" + "=\"" + item["Quantity"].toString() + "\" ";
                                sb += " Type" + "=\"" + item["Type"].toString() + "\" ";
                                sb += " Label" + "=\"" + item["label"].toString() + "\" ";
                                sb += " Volume" + "=\"" + ds.Tables[0][i]["Volume"].toString() + "\" ";
                                sb += " Weight" + "=\"" + ds.Tables[0][i]["Weight"].toString() + "\" ";
                                if (!Util.IsEmpty(item["Fld1"]))
                                    sb += " Fld1=\"" + item["Fld1"].toString() + "\" ";
                                if (!Util.IsEmpty(item["Fld2"]))
                                    sb += " Fld2=\"" + item["Fld2"].toString() + "\" ";
                                if (!Util.IsEmpty(item["fld3"]))
                                    sb += " Fld3=\"" + item["fld3"].toString() + "\" ";
                                if (!Util.IsEmpty(item["fld4"]))
                                    sb += " Fld4=\"" + item["fld4"].toString() + "\" ";
                                if (!Util.IsEmpty(item["fld5"]))
                                    sb += " Fld5=\"" + item["fld5"].toString() + "\" ";
                                sb += " ReportNo=\"" + ds.Tables[0][i]["VoucherNO"].toString() + "\" ";
                                sb += " ></Row>";

                                let drpkss = null;
                                if (this.ScreenObject.Preferences.ContainsKey("AllowDuplLbls") && this.ScreenObject.Preferences["AllowDuplLbls"].toLowerCase() == "true")
                                    drpkss = this.DtPack.filter(x => x.ReportNo == item["VoucherNO"] && x.Label == item["label"]);
                                else
                                    drpkss = this.DtPack.filter(x => x.Label == item["label"]);

                                let drpk;
                                if (drpkss.length == 0) {
                                    drpk = {};//this.DtPack.NewRow();
                                    drpk["ID"] = item["RefID"].toString();
                                    drpk["Label"] = item["label"].toString();
                                    if (this.DtPackColumns.Contains("ReportNo"))
                                        drpk["ReportNo"] = ds.Tables[0][i]["VoucherNO"].toString();
                                    this.DtPack.push(drpk);
                                }
                                else
                                    drpk = drpkss[0];

                                if (ds.Columns[0].Contains("Volume")) {
                                    let tmpdbl = 0;
                                    if (!Util.IsEmpty(ds.Tables[0][i]["Volume"]))
                                        tmpdbl = parseFloat(ds.Tables[0][i]["Volume"]) * parseFloat(item["Quantity"]);
                                    if (!Util.IsEmpty(drpk["cVolume"]))
                                        drpk["cVolume"] = parseFloat(drpk["cVolume"]) + tmpdbl;
                                    else
                                        drpk["cVolume"] = tmpdbl;

                                    tmpdbl = 0;
                                    if (!Util.IsEmpty(ds.Tables[0][i]["Weight"]))
                                        tmpdbl = parseFloat(ds.Tables[0][i]["Weight"]) * parseFloat(item["Quantity"]);
                                    if (!Util.IsEmpty(drpk["cWeight"]))
                                        drpk["cWeight"] = parseFloat(drpk["cWeight"]) + tmpdbl;
                                    else
                                        drpk["cWeight"] = tmpdbl;
                                }

                                if (this.DtPackColumns.Contains("Data")) {
                                    if (!Util.IsEmpty(drpk["Data"]))
                                        drpk["Data"] = drpk["Data"].toString() + "," + drr["Unq"].toString() + "~" + item["Quantity"].toString();
                                    else
                                        drpk["Data"] = drr["Unq"].toString() + "~" + item["Quantity"].toString();
                                }
                            }
                            sb += "</DocExtraXML>";
                            drr["PackXML"] = sb;
                        }
                    }
                    //PackLbl
                    try {
                        if (this.ScreenObject.GridDataColumns.Contains("PackXML") && ds.Columns[0].Contains("PackLbl")
                            && !Util.IsEmpty(ds.Tables[0][i]["PackLbl"])) {
                            if (this.DtPack == null) {
                                this.DtPack = [];//new DataTable()
                                this.DtPackColumns = []
                                this.DtPackColumns.push("ID");
                                this.DtPackColumns.push("Name");
                                this.DtPackColumns.push("Label");
                                this.DtPackColumns.push("cWeight");
                                this.DtPackColumns.push("cVolume");
                                this.DtPackColumns.push("Weight");
                                this.DtPackColumns.push("Volume");
                                this.DtPackColumns.push("Height");
                                this.DtPackColumns.push("length");
                                this.DtPackColumns.push("Width");
                                this.DtPackColumns.push("ActualWeight");//, typeof(double));
                                this.DtPackColumns.push("ActualVolume")//, typeof(double));

                                if ((this.ScreenObject.Preferences.ContainsKey("PackWiseProds") && this.ScreenObject.Preferences["PackWiseProds"].toLowerCase() == "true")
                                    || (this.ScreenObject.Preferences.ContainsKey("LineWisePacking") && this.ScreenObject.Preferences["LineWisePacking"].toLowerCase() == "true"))
                                    this.DtPackColumns.push("Data");


                                if ((this.ScreenObject.Preferences.ContainsKey("ScanwithPack") && this.ScreenObject.Preferences["ScanwithPack"].toLowerCase() == "true")
                                    || (this.ScreenObject.Preferences.ContainsKey("AllowDuplLbls") && this.ScreenObject.Preferences["AllowDuplLbls"].toLowerCase() == "true")) {
                                    this.DtPackColumns.push("ReportNo");
                                    this.DtPackColumns.push("LabID");
                                }
                            }

                            if (!this.ScreenObject.GridDataColumns.Contains("Unq"))
                                this.ScreenObject.GridDataColumns.push("Unq")//, typeof(int));

                            if (unq == null) {
                                unq = this.ScreenObject.GridData.Compute("max", "Unq");
                                if (unq != null)
                                    unq = parseInt(unq) + 1;
                                else
                                    unq = 0;
                            }

                            drr["Unq"] = unq;
                            unq = parseInt(unq) + 1;

                            let sbxml = '';
                            sbxml += "<DocExtraXML>";

                            let dsr = new XmlDocument();
                            dsr.ReadXml("<XML>" + ds.Tables[0][i]["PackLbl"].toString() + "</XML>");
                            if (dsr.Tables.length > 0 && dsr.Columns[0].Contains("packlbl") && dsr.Tables[0].length > 0) {
                                this.RemoveDupl(dsr);
                                for (let k = 0; k < dsr.Tables[0].length; k++) {

                                    sbxml += "<Row ";
                                    sbxml += " RefID=\"1\" ";
                                    sbxml += " Qty" + "=\"" + dsr.Tables[0][k]["Qty"].toString() + "\" ";
                                    sbxml += " Type" + "=\"2\" ";
                                    if (dsr.Tables[0][k]["Warehouse"].toString() != "")
                                        sbxml += " LabID" + "=\"" + dsr.Tables[0][k]["Warehouse"].toString() + "\" ";

                                    sbxml += " ReportNo" + "=\"" + ds.Tables[0][i]["VoucherNO"].toString() + "\" ";

                                    sbxml += " Label" + "=\"" + dsr.Tables[0][k]["packlbl"].toString() + "\" ";
                                    sbxml += " ></Row>";

                                    let drpkss = null;
                                    drpkss = this.DtPack.filter(x => x.Label = dsr.Tables[0][k]["packlbl"].toString());

                                    let drpk;
                                    if (drpkss.length == 0) {
                                        drpk = {};
                                        drpk["ID"] = 1;
                                        drpk["Label"] = dsr.Tables[0][k]["packlbl"].toString();
                                        drpk["LabID"] = dsr.Tables[0][k]["Warehouse"].toString();
                                        drpk["ReportNo"] = ds.Tables[0][i]["VoucherNO"].toString();
                                        this.DtPack.push(drpk);
                                    }
                                    else
                                        drpk = drpkss[0];


                                    if (this.DtPackColumns.Contains("Data")) {
                                        if (drpk["Data"].toString() != "")
                                            drpk["Data"] = drpk["Data"].toString() + "," + drr["Unq"].toString() + "~" + dsr.Tables[0][k]["Qty"].toString();
                                        else
                                            drpk["Data"] = drr["Unq"].toString() + "~" + dsr.Tables[0][k]["Qty"].toString();
                                    }
                                }
                                sbxml += "</DocExtraXML>";
                                drr["PackXML"] = sbxml;
                            }

                        }
                    }
                    catch (error) {
                        Logger.ErrorLog("VoucherGenerator", "LoadEditData", error.stack);
                    }
                    //PackLbl

                }
                if (this.ScreenObject.Preferences.ContainsKey("BarcodeField") && this.ScreenObject.Preferences["BarcodeField"].toString() != "" && ds.Columns[0].Contains("ScannedBarcodes")) {
                    let bfld = this.ScreenObject.ColumnSource.find(a => a.ID != null && a.ID == this.ScreenObject.Preferences["BarcodeField"]);
                    if (bfld && this.ScreenObject.GridDataColumns.Contains(bfld.DisplayMember))//&& this.ScreenObject.GridDataColumns[bfld.DisplayMember].DataType==)
                        drr[bfld.DisplayMember] = ds.Tables[0][i]["ScannedBarcodes"].toString();
                }

                if (BaseService.SessionManager.Preferences["BudgetAccount"].length > 0 && BaseService.SessionManager.Preferences["BudgetDimension"].length > 0) {
                    var bfld = this.ScreenObject.ColumnSource.find(a => a.ID != null && a.CostCenterID == this.BudgetObj.iBudgetDimension);
                    if (bfld != null && this.ScreenObject.GridDataColumns.Contains(bfld.ValueMember) && (Util.IsEmpty(drr[bfld.ValueMember]) || parseInt(Util.String(drr[bfld.ValueMember])) <= 1))
                        this.BudgetObj.AutoLoadBudgetDimension(drr, null);
                }

                this.ScreenObject.GridDataObj.insertRowAt(drr, RowPos + RecordsCount);

                if (GrRows != null) {
                    for (let k = 0; k < GrRows.length; k++, RecordsCount++) {
                        for (let c = 0; c < this.ScreenObject.GridDataColumns.length; c++) {
                            if (this.ScreenObject.GridDataColumns[c] == "ProductName" || this.ScreenObject.GridDataColumns[c] == "ProductID_Key"
                                || this.ScreenObject.GridDataColumns[c] == "ProductCode" || this.ScreenObject.GridDataColumns[c] == "DocDetailsID"
                                || this.ScreenObject.GridDataColumns[c] == "TODocDetailsID" || this.ScreenObject.GridDataColumns[c] == "Row_Background")
                                continue;

                            GrRows[k][c] = drr[c];
                        }
                        this.ScreenObject.GridDataObj.insertRowAt(GrRows[k], RowPos + RecordsCount);

                        let DsAvg = this.GetProductValues(GrRows[k], 0, true);
                        if (DsAvg.Tables.length > 0 && DsAvg.Tables[0].length > 0 && !DsAvg.Columns[0].Contains("ErrorMessage") &&
                            DsAvg.Columns[0].Contains("ProductTypeID") && ds.Tables[0][i]["ProductTypeID"].toString() != "8") {
                            if (ds.Columns[0].Contains("FileGUID")) {
                                GrRows[k]["FileGUID"] = DsAvg.Tables[0][0]["FileGUID"].toString();
                                GrRows[k]["FileExtension"] = DsAvg.Tables[0][0]["FileExtension"].toString();
                            }
                            if (parseInt(drr["ProductID_Key"]) != this.ScreenObject.TempProductID) {
                                if (DsAvg.Columns[0].Contains("QOH") && !Util.IsEmpty(DsAvg.Tables[0][0]["QOH"]))
                                    GrRows[k]["QOH"] = DsAvg.Tables[0][0]["QOH"].toString();
                                else
                                    GrRows[k]["QOH"] = 0;


                                if (DsAvg.Columns[0].Contains("BalQOH") && !Util.IsEmpty(DsAvg.Tables[0][0]["BalQOH"]))
                                    GrRows[k]["BalQOH"] = DsAvg.Tables[0][0]["BalQOH"].toString();
                                else
                                    GrRows[k]["BalQOH"] = 0;

                                if (DsAvg.Columns[0].Contains("HOLDQTY") && !Util.IsEmpty(DsAvg.Tables[0][0]["HOLDQTY"]))
                                    GrRows[k]["HOLDQTY"] = DsAvg.Tables[0][0]["HOLDQTY"].toString();
                                else
                                    GrRows[k]["HOLDQTY"] = 0;

                                if (DsAvg.Columns[0].Contains("CommittedQty") && !Util.IsEmpty(DsAvg.Tables[0][0]["CommittedQty"]))
                                    GrRows[k]["CommittedQty"] = DsAvg.Tables[0][0]["CommittedQty"].toString();
                                else
                                    GrRows[k]["CommittedQty"] = 0;
                                if (DsAvg.Columns[0].Contains("RESERVEQTY") && !Util.IsEmpty(DsAvg.Tables[0][0]["RESERVEQTY"]))
                                    GrRows[k]["RESERVEQTY"] = DsAvg.Tables[0][0]["RESERVEQTY"].toString();
                                else
                                    GrRows[k]["RESERVEQTY"] = 0;

                                if (DsAvg.Columns[0].Contains("TotalReserve") && !Util.IsEmpty(DsAvg.Tables[0][0]["TotalReserve"]))
                                    GrRows[k]["TotalReserve"] = DsAvg.Tables[0][0]["TotalReserve"].toString();
                                else
                                    GrRows[k]["TotalReserve"] = 0;
                            }

                            if (DsAvg.Columns[0].Contains("LastPurchaseRate") && !Util.IsEmpty(DsAvg.Tables[0][0]["LastPurchaseRate"]))
                                GrRows[k]["LASTPURCHASERATE"] = DsAvg.Tables[0][0]["LastPurchaseRate"].toString();
                            else
                                GrRows[k]["LASTPURCHASERATE"] = 0;
                            if (DsAvg.Tables.length > 8 && DsAvg.Tables[8].length > 1 && !DsAvg.Columns[8].Contains("ErrorMessage")
                                && this.ScreenObject.Preferences.ContainsKey("EnableSubtitutes") && this.ScreenObject.Preferences["EnableSubtitutes"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["EnableSubtitutes"])) {
                                GrRows[k]["Subexists"] = "1";
                            }
                            else
                                GrRows[k]["Subexists"] = "0";
                            let drCCRate = null;
                            if (DsAvg.Tables.length > 3 && DsAvg.Tables[3].length > 0)
                                drCCRate = DsAvg.Tables[3][0];

                            let dv;
                            if (CopyDt == null && dv.length > 0 && !Util.IsEmpty(dv[0]["CostCenterIDLinked"]) && ds.Columns[0].Contains("CostCenterID")
                                && ds.Tables[0].length > 0)
                                dv = ds.Tables[4].filter(x => x.BASECOL == 'Rate' && x.CostCenterIDLinked == ds.Tables[0][0]["CostCenterID"]);
                            else
                                dv = ds.Tables[4].filter(x => x.BASECOL = 'Rate');
                            if (dv.length == 0) {
                                let RateCol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Rate");
                                let strRateColumn = "";
                                if (drCCRate != null)//prices
                                {
                                    if (!Util.IsEmpty(RateCol.Formula) && DsAvg.Columns[3].Contains(strRateColumn)) {
                                        strRateColumn = RateCol.Formula;
                                    }
                                    if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                                        strRateColumn = "PurchaseRate";
                                    }
                                    else
                                        strRateColumn = "SellingRate";
                                    if (strRateColumn != "" && !Util.IsEmpty(drCCRate[strRateColumn])) {
                                        GrRows[k]["Rate"] = drCCRate[strRateColumn].toString();
                                        GrRows[k]["default" + "Rate"] = drCCRate[strRateColumn].toString();
                                    }
                                }
                                else if (DsAvg.Tables.length > 0 && DsAvg.Tables[0].length > 0 && DsAvg.Columns[0].Contains("ProdBaseUOM")
                                    && DsAvg.Tables[0][0]["ProdBaseUOM"].toString() != DsAvg.Tables[0][0]["uomid"].toString()) {
                                    let dsunitpr = this.ScreenObject.GetPriceofUnit(drr["ProductID_Key"].toString(), this.DocumentDate, parseInt(drr["Unit_Key"]), drr);

                                    if (!Util.IsEmpty(RateCol.Formula) && dsunitpr.Columns[1].Contains(strRateColumn)) {
                                        strRateColumn = RateCol.Formula;
                                    }
                                    if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                                        strRateColumn = "PurchaseRate";
                                    }
                                    else
                                        strRateColumn = "SellingRate";
                                    let Conv = 0, tempdbl = 0;
                                    if (dsunitpr.Tables.length > 0 && dsunitpr.Tables[0].length > 0 && !Util.IsEmpty(dsunitpr.Tables[0][0]["Conversion"]))
                                        Conv = parseFloat(dsunitpr.Tables[0][0]["Conversion"]);

                                    if (dsunitpr.Tables.length > 1 && dsunitpr.Tables[1].length > 0 && dsunitpr.Columns[1].Contains(strRateColumn) && !Util.IsEmpty(dsunitpr.Tables[1][0][strRateColumn])) {
                                        if (dsunitpr.Columns[1].Contains("UOMID"))
                                            tempdbl = Conv * parseFloat(dsunitpr.Tables[1][0][strRateColumn]);
                                        else
                                            tempdbl = parseFloat(dsunitpr.Tables[1][0][strRateColumn]);
                                        GrRows[k]["Rate"] = tempdbl.ToString("N" + RateCol.DecimalPoints);
                                        GrRows[k]["default" + "Rate"] = tempdbl.ToString("N" + RateCol.DecimalPoints);
                                    }
                                }
                                else if (DsAvg.Tables.length > 0 && DsAvg.Tables[0].length > 0 && !DsAvg.Columns[0].Contains("ErrorMessage")) {
                                    if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                                        if (!Util.IsEmpty(DsAvg.Tables[0][0]["PurchaseRate"])) {
                                            GrRows[k]["Rate"] = DsAvg.Tables[0][0]["PurchaseRate"].toString();
                                            GrRows[k]["default" + "Rate"] = DsAvg.Tables[0][0]["PurchaseRate"].toString();
                                        }
                                        else
                                            GrRows[k]["Rate"] = 0;
                                    }
                                    else if (!Util.IsEmpty(DsAvg.Tables[0][0]["SellingRate"])) {
                                        GrRows[k]["Rate"] = DsAvg.Tables[0][0]["SellingRate"].toString();
                                        GrRows[k]["default" + "Rate"] = DsAvg.Tables[0][0]["SellingRate"].toString();
                                    }
                                }
                            }
                            this.FillLinkRefereceProducts(GrRows[k], DsAvg.Tables[0], drCCRate);

                            let NumColt = this.ScreenObject.ColumnSource.filter(a => a.DisplayMember.Contains("dcNum") && a.SectionID != 4);
                            if (DsAvg.Tables.length > 4)//Extra Fields
                            {
                                for (let n = 0; n < NumColt.length; n++) {
                                    let item = NumColt[n]
                                    if (item.linkData > 0)
                                        continue;
                                    dv = ds.Tables[4].filter(x => x.BASECOL == item.DisplayMember);
                                    if (CopyDt == null && dv.length > 0 && !Util.IsEmpty(dv[0]["CostCenterIDLinked"]) && ds.Columns[0].Contains("CostCenterID")
                                        && ds.Tables[0].length > 0)
                                        dv = dv.filter(x => x.CostCenterIDLinked == ds.Tables[0][0]["CostCenterID"]);

                                    if (dv.length == 0) {
                                        let drrTaxFld = DsAvg.Tables[4].filter(x => x.SysColumnName == item.DisplayMember);
                                        if (drrTaxFld.length > 0) {
                                            GrRows[k][item.DisplayMember] = drrTaxFld[0]["Value"].toString();
                                            GrRows[k]["default" + item.DisplayMember] = drrTaxFld[0]["Value"].toString();
                                        }
                                        //else if (DsAvg.Tables.length > 5)
                                        //{
                                        //    drrTaxFld = DsAvg.Tables[5].filter(x=>x.SysColumnName==item.DisplayMember);
                                        //    if (drrTaxFld.length > 0)
                                        //    {
                                        //        drr[item.DisplayMember] = drrTaxFld[0]["Value"].toString();
                                        //        drr["default" + item.DisplayMember] = drrTaxFld[0]["Value"].toString();
                                        //    }
                                        //}
                                    }
                                }
                            }
                        }

                        let productcolumns = this.ScreenObject.ColumnSource.filter(a => a.ValueMember != null && a.ValueMember.toString().toLowerCase() == "productid_key");
                        if (productcolumns.length > 0) {
                            let dvCnt = this.ScreenObject.Data.Tables[0];
                            let Callexists = false;

                            if (this.ScreenObject.Preferences.ContainsKey("FillLocalRef") && this.ScreenObject.Preferences["FillLocalRef"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["FillLocalRef"])) {
                                let h = productcolumns.length;
                                productcolumns.forEach(prodcol => {
                                    h--;
                                    if (prodcol.CostCenterID > 0 && !Callexists) {
                                        if (h == 0)
                                            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && (x.LocalReference == prodcol.ID || (x.LocalReference == 79 && (x.LinkData == 26585 || x.LinkData == 54306 || x.LinkData == 54307 || x.LinkData == 53529 || x.LinkData == 53589 || x.LinkData == 53530))));
                                        else
                                            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && (x.LocalReference == prodcol.ID));

                                        if (dvCnt.length > 0 && !Util.IsEmpty(prodcol.ValueMember) && !Util.IsEmpty(GrRows[k][prodcol.ValueMember])) {
                                            Callexists = true;
                                            this.ScreenObject.GetLinkReferenceData(parseInt(prodcol.ID), this.DocumentID, parseInt(GrRows[k][prodcol.ValueMember]), Date.Today(), "", prodcol.CostCenterID, GrRows[k]);
                                        }
                                    }
                                });
                            }
                        }
                        if (ds.Columns[0].Contains("ProductTypeID")) {
                            if (DsAvg != null && DsAvg.Tables.length > 0 && DsAvg.Columns[0].Contains("ProductTypeID") && DsAvg.Tables[0].length > 0)
                                GrRows[k]["Type"] = DsAvg.Tables[0][0]["ProductTypeID"].toString();
                            else
                                GrRows[k]["Type"] = ds.Tables[0][i]["ProductTypeID"].toString();

                            if (DsAvg != null && DsAvg.Tables.length > 0 && DsAvg.Columns[0].Contains("BinWise") && DsAvg.Tables[0].length > 0)
                                GrRows[k]["BinWise"] = DsAvg.Tables[0][0]["BinWise"].toString();

                            if (this.ScreenObject.GridDataColumns.Contains("QtyType") && ds.Columns[0].Contains("QtyAdjustType"))
                                GrRows[k]["QtyType"] = ds.Tables[0][i]["QtyAdjustType"].toString();

                            if (this.ScreenObject.GridDataColumns.Contains("PackType") && ds.Columns[0].Contains("IsPacking"))
                                GrRows[k]["PackType"] = ds.Tables[0][i]["IsPacking"].toString();

                            if (this.ScreenObject.GridDataColumns.Contains("IsTestCase") && DsAvg.Columns[0].Contains("TestCaseExists"))
                                GrRows[k]["IsTestCase"] = DsAvg.Tables[0][0]["TestCaseExists"].toString();

                            if (this.ScreenObject.GridDataColumns.Contains("landingType") && ds.Columns[0].Contains("IsBillOfEntry"))
                                GrRows[k]["landingType"] = ds.Tables[0][i]["IsBillOfEntry"].toString();

                            if (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(drr["FreeQTY"]) && parseFloat(drr["FreeQTY"]) > 0) {
                                if (!Util.IsEmpty(drr["UOMConversion"]))
                                    GrRows[k]["UOMConvertedQty"] = parseFloat(drr["FreeQTY"]) * parseFloat(drr["UOMConversion"]);
                                else
                                    GrRows[k]["UOMConvertedQty"] = drr["FreeQTY"].toString();
                            }
                        }

                        if (schemes) {
                            if (!Util.IsEmpty(GrRows[k]["ProductID_Key"]) && parseInt(GrRows[k]["ProductID_Key"]) > 0) {
                                let dsscheme = this.ScreenObject.GetSchemes(this.DocumentDate, GrRows[k]);
                                if (dsscheme.Tables.length > 0 && dsscheme.Columns[0].Contains("SchemeID")) {
                                    this.fillSchemevalues(dsscheme.Tables[0], dsscheme.Columns[0], GrRows[k]);
                                    this.ApplySchemes(GrRows[k]);
                                }
                            }
                        }
                        if (this.ScreenObject.GridDataColumns.Contains(ds.Tables[0][i][ds.Columns[0][3]].toString()))
                            this.CalculateTotals(GrRows[k], false, ds.Tables[0][i][ds.Columns[0][3]].toString(), false);
                        else
                            this.CalculateTotals(GrRows[k], false, "", false);
                    }
                }

                if (this.ScreenObject.Preferences.ContainsKey("ExpandStages") && this.ScreenObject.Preferences["ExpandStages"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["ExpandStages"])
                    && ds.Tables.length > 14 && ds.Tables[14].length > 0) {
                    let drStRows = ds.Tables[14].filter(x => x.Nodeid == ds.Tables[1][i]["Dcccnid" + (parseInt(BaseService.SessionManager.Preferences["PaytermLinkDim"]) - 50000)]);
                    if (drStRows.length > 0) {
                        for (let k = 0; k < drStRows.length; k++) {
                            let dr: any;
                            if (k == 0)
                                dr = drr;
                            else {
                                dr = this.ScreenObject.GridDataObj.NewRow();
                                for (let c = 0; c < this.ScreenObject.GridDataColumns.length; c++) {
                                    if (this.ScreenObject.GridDataColumns[c] == "DocDetailsID"
                                        || this.ScreenObject.GridDataColumns[c] == "TODocDetailsID")
                                        dr[c] = 0;
                                    else
                                        dr[c] = drr[c];
                                }
                                this.ScreenObject.GridDataObj.insertRowAt(dr, RowPos + RecordsCount + k);
                            }
                            let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference == 79 && x.LinkData == 50000);
                            if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"]))
                                dr[dvCnt[0]["SysColumnName"]] = drStRows[k]["percentage"].toString();

                            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference == 79 && x.LinkData == 50001);
                            if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"]))
                                dr[dvCnt[0]["SysColumnName"]] = drStRows[k]["Days"].toString();

                            if (!Util.IsEmpty(drStRows[k]["dimccid"]) && !Util.IsEmpty(drStRows[k]["dimNodeID"])
                                && this.ScreenObject.GridDataColumns.Contains("Dcccnid" + (parseInt(drStRows[k]["dimccid"]) - 50000) + "_Key")) {
                                dr["Dcccnid" + (parseInt(drStRows[k]["dimccid"]) - 50000) + "_Key"] = drStRows[k]["dimNodeID"].toString();

                                if (this.ScreenObject.Preferences.ContainsKey("FillLocalRef") && this.ScreenObject.Preferences["FillLocalRef"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["FillLocalRef"])
                                    && this.ScreenObject.Preferences["LocalRefflds"].toString() != "") {
                                    let lref = this.ScreenObject.Preferences["LocalRefflds"].toString().split(',');
                                    let Stagcol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == parseInt(drStRows[k]["dimccid"]));
                                    if (lref.Contains(Stagcol.ID))
                                        this.ScreenObject.GetLinkReferenceData(parseInt(Stagcol.ID), this.DocumentID, parseInt(drr[Stagcol.ValueMember]), Date.Today(), "", Stagcol.CostCenterID, dr, null, false);
                                }
                            }
                            if (k > 0) {
                                if (this.ScreenObject.GridDataColumns.Contains(ds.Tables[0][i][ds.Columns[0][3]].toString()))
                                    this.CalculateTotals(dr, false, ds.Tables[0][i][ds.Columns[0][3]].toString(), false);
                                else
                                    this.CalculateTotals(dr, false, "", false);
                            }
                        }
                        if (drStRows.length > 1)
                            RecordsCount = RecordsCount + drStRows.length - 1;
                    }
                }


                if (!Util.IsEmpty(drr["Type"]) && parseInt(drr["Type"]) == 5 &&
                    ((!Util.IsEmpty(drr["Quantity"]) && parseFloat(drr["Quantity"]) > 0) || (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(drr["FreeQTY"]) && parseFloat(drr["FreeQTY"]) > 0))
                    && ((this.VoucherType == -1 && this.ScreenObject.Preferences.ContainsKey("AutoBatchesLinking") && this.ScreenObject.Preferences["AutoBatchesLinking"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["AutoBatchesLinking"]))
                        || !Util.IsEmpty(ds.Tables[0][i]["BatchXML"]))) {
                    let div = 0, loc = 0;

                    if (this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])) {
                        let ccfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
                        if (ccfld && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0)
                            loc = ccfld.SelectedValue;
                        else if (drr != null && this.ScreenObject.GridDataColumns.Contains("dcCCNID2_Key") && !Util.IsEmpty(drr["dcCCNID2_Key"]))
                            loc = parseInt(drr["dcCCNID2_Key"]);
                    }
                    else if (this.ScreenObject.LocationID > 0)
                        loc = this.ScreenObject.LocationID;
                    else
                        loc = BaseService.SessionManager.LocationID;
                    if (this.ScreenObject.DivisionID > 0)
                        div = this.ScreenObject.DivisionID;
                    else
                        div = BaseService.SessionManager.DivisionID;
                    let qt = 0;
                    if (!Util.IsEmpty(drr["Quantity"]) && parseFloat(drr["Quantity"]) > 0)
                        qt = parseFloat(drr["Quantity"]);
                    else if (this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(drr["FreeQTY"]) && parseFloat(drr["FreeQTY"]) > 0)
                        qt = parseFloat(drr["FreeQTY"]);

                    if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && !Util.IsEmpty(drr["UOMConversion"]))
                        qt = qt * parseFloat(drr["UOMConversion"]);

                    let objbat = new BatchNumberViewModel(this.ScreenObject.GridDataObj)
                    objbat.BatchNumberViewModel_3(this, this.VoucherType, qt, parseInt(drr["ProductID_Key"]), drr["ProductName"].toString(), loc, div, drr)
                    {
                        if (ds.Columns[0].Contains("BatchXML") && !Util.IsEmpty(ds.Tables[0][i]["BatchXML"])) {
                            let dsr = new XmlDocument();
                            {
                                dsr.ReadXml("<XML>" + ds.Tables[0][i]["BatchXML"].toString() + "</XML>");
                                if (dsr.Tables.length > 0 && dsr.Columns[0].Contains("QTY") && dsr.Tables[0].length > 0) {
                                    for (let k = 0; k < dsr.Tables[0].length; k++) {
                                        let drbatchrows: any[] = null;
                                        if (dsr.Columns[0].Contains("BatchNo") && !Util.IsEmpty(dsr.Tables[0][k]["BatchNo"]))
                                            drbatchrows = objbat.GridData.filter(x => x.BATCHNUMBER == dsr.Tables[0][k]["BatchNo"].toString());
                                        else if (dsr.Columns[0].Contains("BatchCode") && !Util.IsEmpty(dsr.Tables[0][k]["BatchCode"]))
                                            drbatchrows = objbat.GridData.filter(x => x.BatchCode == dsr.Tables[0][k]["BatchCode"].toString());
                                        if (drbatchrows != null && drbatchrows.length > 0 && !Util.IsEmpty(dsr.Tables[0][k]["QTY"])) {
                                            if (objbat.GridDataColumns.Contains("QtyUom")) {
                                                if (!Util.IsEmpty(drbatchrows[0]["QtyUom"]))
                                                    drbatchrows[0]["QtyUom"] = parseFloat(drbatchrows[0]["QtyUom"].toString()) + parseFloat(dsr.Tables[0][k]["QTY"].toString());
                                                else
                                                    drbatchrows[0]["QtyUom"] = dsr.Tables[0][k]["QTY"].toString();

                                                if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && !Util.IsEmpty(drr["UOMConversion"]))
                                                    drbatchrows[0]["Quantity"] = parseFloat(drbatchrows[0]["QtyUom"].toString()) * parseFloat(drr["UOMConversion"].toString());
                                                else
                                                    drbatchrows[0]["Quantity"] = drbatchrows[0]["QtyUom"];
                                            }
                                            else {
                                                if (!Util.IsEmpty(drbatchrows[0]["Quantity"]))
                                                    drbatchrows[0]["Quantity"] = parseFloat(drbatchrows[0]["Quantity"].toString()) + parseFloat(dsr.Tables[0][k]["QTY"].toString());
                                                else
                                                    drbatchrows[0]["Quantity"] = dsr.Tables[0][k]["QTY"].toString();
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else
                            objbat.ChkFifo = true;
                        objbat.OnSave("AutoSave");
                        if (objbat.count > 1)
                            RecordsCount = RecordsCount + objbat.count - 1;
                    }
                }

                if (this.ScreenObject.Preferences.ContainsKey("AutoAdjustBinLinking") && this.ScreenObject.Preferences["AutoAdjustBinLinking"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["AutoAdjustBinLinking"]))
                    this.AddBins(drr, false, false, null, true);

                RecordsCount++;
                //if(i == ds.Tables[0].length- 1)
                //    this.ScreenObject.GridDataObj.removeRowAt(RowPos + i +1);
                if (this.AutoPostViewModel != null && ds.Tables.length > 16 && ds.Tables[16].length > 0) {
                    this.AutoPostViewModel.ScreenObject._CCFields.forEach(item => {
                        let cfld = this.ScreenObject._CCFields.find(a => a.DBColumnName == item.DBColumnName);
                        if (cfld && item instanceof PactListBoxData && cfld instanceof PactListBoxData) {
                            item.SelectedValue = cfld.SelectedValue;
                            item.SelectedValueText = cfld.Text;
                        }
                    });
                    this.AutoPostViewModel.ScreenObject._TextFields.forEach(item => {
                        if (item instanceof PactListBoxData && item.CCID == 3 && !Util.IsEmpty(drr["ProductID_Key"])) {
                            item.SelectedValue = parseInt(drr["ProductID_Key"]);
                            if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                                item.SelectedValueText = drr["ProductName"].toString();
                        }
                    });
                    let Newid: string = Util.NewGuid();
                    for (let a = 0; a < ds.Tables[16].length; a++) {
                        let drBom = this.AutoPostViewModel.ScreenObject.GridDataObj.NewRow();
                        drBom["ProductID_Key"] = ds.Tables[16][a]["ProductID"].toString();
                        drBom["defaultQuantity"] = ds.Tables[16][a]["Quantity"].toString();
                        drBom["Quantity"] = parseFloat(drr["Quantity"]) * parseFloat(ds.Tables[16][a]["Quantity"]);
                        if (this.AutoPostViewModel.ScreenObject.GridDataColumns.Contains("Unit"))
                            drBom["Unit"] = ds.Tables[16][a]["UnitName"].toString();
                        if (this.AutoPostViewModel.ScreenObject.GridDataColumns.Contains("Unit_Key"))
                            drBom["Unit_Key"] = ds.Tables[16][a]["Unit"].toString();
                        if (this.AutoPostViewModel.ScreenObject.GridDataColumns.Contains("ProductCOde"))
                            drBom["ProductCOde"] = ds.Tables[16][a]["ProductCOde"].toString();
                        if (this.AutoPostViewModel.ScreenObject.GridDataColumns.Contains("ProductName"))
                            drBom["ProductName"] = ds.Tables[16][a]["ProductName"].toString();
                        drBom["RefSeqNo"] = Newid;
                        this.AutoPostViewModel.ScreenObject.GridDataObj.insertRowAt(drBom, i);
                        this.AutoPostViewModel.AddProductData(drBom, false, true, true);
                        this.AutoPostViewModel.CalculateTotals(drBom, false, "", false);
                    }
                    drr["RefSeqNo"] = Newid;
                    let drbomdetails = this.AutoPostViewModel.ScreenObject.GridData.filter(x => x.RefSeqNo = Newid);
                    let gr = 0;
                    drbomdetails.forEach(dd => {
                        if (!Util.IsEmpty(dd["Gross"]))
                            gr += parseFloat(dd["Gross"]);
                    });
                    drr["Rate"] = gr / parseFloat(drr["Quantity"]);
                }

                for (let h = 0; h < this.Shortcuts.length; h++) {
                    if (this.Shortcuts[h] instanceof DgColumn && this.Shortcuts[h].Mode == 5 && this.ValidateData_Column(this.Shortcuts[h] as DgColumn, drr, true))
                        this.ScreenObject.GetExternalFuncData(this.Shortcuts[h].Mode, this.Shortcuts[h].SPName, this.Shortcuts[h].IPParams, this.Shortcuts[h].OPParams, drr);
                }

                if (schemes && ds.Columns[0].Contains("IsQtyFreeOffer") &&
                    !(!Util.IsEmpty(ds.Tables[0][i]["IsQtyFreeOffer"]) && parseInt(ds.Tables[0][i]["IsQtyFreeOffer"]) > 0)) {
                    if (!Util.IsEmpty(drr["ProductID_Key"]) && parseInt(drr["ProductID_Key"]) > 0) {
                        let dsscheme = this.ScreenObject.GetSchemes(this.DocumentDate, drr);
                        if (dsscheme.Tables.length > 0 && dsscheme.Columns[0].Contains("SchemeID"))
                            this.fillSchemevalues(dsscheme.Tables[0], dsscheme.Columns[0], drr);
                    }
                    this.ApplySchemes(drr);
                }

                if (this.ScreenObject.GridDataColumns.Contains(ds.Tables[0][i][ds.Columns[0][3]].toString()))
                    this.CalculateTotals(drr, false, ds.Tables[0][i][ds.Columns[0][3]].toString(), false);
                else
                    this.CalculateTotals(drr, false, "", false);

                for (let h = 0; h < this.Shortcuts.length; h++) {
                    if (this.Shortcuts[h] instanceof DgColumn && this.Shortcuts[h].Mode == 10 && this.ValidateData_Column(this.Shortcuts[h] as DgColumn, drr, true))
                        this.ScreenObject.GetExternalFuncData(this.Shortcuts[h].Mode, this.Shortcuts[h].SPName, this.Shortcuts[h].IPParams, this.Shortcuts[h].OPParams, drr);
                }

                //Link Previous Executed Qty
                let dvlink = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference == 79 && x.LinkData == 7810);
                if (dvlink.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvlink[0]["SysColumnName"])) {
                    if (ds.Columns[0].Contains("Executed"))
                        drr[dvlink[0]["SysColumnName"]] = ds.Tables[0][i]["Executed"].toString();
                }

                if (ds.Columns[0].Contains("DocumentType") && ds.Tables[0][i]["DocumentType"].toString() == "5")
                    m++;

                //this.ScreenObject.GridDataObj.updateRow(drr);
            }

            if (ds.Tables.length > 9 && ds.Columns[9].Contains("InvDocDetailsID") &&
                ds.Tables[9].length > 0 && this.ScreenObject.Preferences.ContainsKey("DocQtyAdjustment") && this.ScreenObject.Preferences["DocQtyAdjustment"] != "" && parseBoolean(this.ScreenObject.Preferences["DocQtyAdjustment"])) {
                let sb = "";
                let batches = ds.Tables[9].filter(x => x.InvDocDetailsID == 0);

                if (batches.length > 0) {
                    sb += "<QtyAdjustments>";

                    if (!Util.IsEmpty(this.QtyXML)) {
                        let xDoc = new XmlDocument();
                        let xList = xDoc.SelectNodes("XML/Row");
                        xDoc = new XmlDocument();
                        xDoc.LoadXml(this.QtyXML);
                        xList = xDoc.SelectNodes("QtyAdjustments/Row");
                        for (let j = 0; j < xList.length; j++) {
                            sb += "<Row ";
                            for (let l = 0; l < ds.Columns[9].length; l++) {
                                if (ds.Columns[9][l].Contains("Fld") && !Util.IsEmpty(xList[j].attributes[ds.Columns[9][l]]) && !Util.IsEmpty(xList[j].attributes[ds.Columns[9][l]].value))
                                    sb += ds.Columns[9][l] + "=\"" + PactTextBoxData.GetValidTextXml(xList[j].attributes[ds.Columns[9][l]].value) + "\" ";
                            }

                            sb += "Islinked=\"1\" ";

                            if (!Util.IsEmpty(xList[j].attributes["RefVoucherNo"]))
                                sb += "RefVoucherNo=\"" + xList[j].attributes["RefVoucherNo"].value.toString() + "\" ";
                            sb += " ></Row>";
                        }
                    }

                    batches.forEach(item => {
                        sb += "<Row ";
                        for (let l = 0; l < ds.Columns[9].length; l++) {
                            if (ds.Columns[9][l].Contains("Fld") && !Util.IsEmpty(item[ds.Columns[9][l]]))
                                sb += ds.Columns[9][l] + "=\"" + PactTextBoxData.GetValidTextXml(item[ds.Columns[9][l]].toString()) + "\" ";
                        }
                        sb += "Islinked=\"1\" ";

                        if (!Util.IsEmpty(item["VoucherNo"]))
                            sb += "RefVoucherNo=\"" + item["VoucherNo"].ToString() + "\" ";
                        sb += " ></Row>";
                    });
                    sb += "</QtyAdjustments>";
                    this.QtyXML = sb;
                }
            }

            if (RecordsCount > 0 && !this.IsSelectAll)
                this.ScreenObject.GridDataObj.removeRowAt(RowPos + RecordsCount + this.schRowsCnt);

            if (Packids != "") {
                let dspk: any = this.ScreenObject.GetPackDetails(Packids);
                if (dspk != null && dspk.Tables.length > 0 && dspk.Columns[0].Contains("Name") && dspk.Tables[0].length > 0) {
                    dspk.Tables[0].forEach(dsdr => {
                        let drpkrows = this.DtPack.filter(x => x.ID == dsdr["Nodeid"]);
                        drpkrows.forEach(drpk => {
                            drpk["Name"] = dsdr["Name"];
                            drpk["Volume"] = dsdr["Volume"];
                            drpk["Weight"] = dsdr["Weight"];
                            drpk["length"] = dsdr["length"];
                            drpk["Width"] = dsdr["width"];
                            drpk["Height"] = dsdr["height"];
                        });
                    });
                }
            }

            if (this.IsInventoryVoucher && this.ScreenObject.DocumentType == 30 && this.ScreenObject.Preferences.ContainsKey("UseasAssemble/DisAssembly") && parseBoolean(this.ScreenObject.Preferences["UseasAssemble/DisAssembly"])
                && ds.Tables.length > 18 && ds.Tables[18].length > 0) {
                let drkit = this.ScreenObject.GridData.filter(x => x.ProductID_key == ds.Tables[18][0]["ParentProductID"]);
                if (drkit.length > 0) {
                    if (!this.ScreenObject.GridDataColumns.Contains("IsKit"))
                        this.ScreenObject.GridDataColumns.push("IsKit");

                    drkit[0]["IsKit"] = 1;

                    for (i = 0; i < this.ScreenObject.GridData.length; i++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                            drkit = ds.Tables[18].filter(x => x.ProductID == this.ScreenObject.GridData[i]["ProductID_Key"]);
                            if (drkit.length > 0) {
                                this.ScreenObject.GridData[i]["IsKit"] = 2;
                                this.ScreenObject.GridData[i]["DefaultQuantity"] = drkit[0]["Quantity"];
                            }
                        }
                    }
                }
            }

            if (this.ScreenObject.Preferences.ContainsKey("FillLocalRef") && this.ScreenObject.Preferences["FillLocalRef"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["FillLocalRef"])
                && this.ScreenObject.Preferences["LocalRefflds"].toString() != "") {
                let lref = this.ScreenObject.Preferences["LocalRefflds"].toString().split(',');

                this.ScreenObject._CCFields.forEach(oControl => {
                    if (lref.Contains(oControl.DBColumnID.toString())) {
                        if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == oControl.DBColumnID).length > 0
                            || this.ScreenObject.DefaultBasedOn.ContainsKey((oControl as PactListBoxData).CCID.toString()))
                            this.ScreenObject.GetLinkReferenceData(oControl.DBColumnID, this.ScreenObject.CostCenterID, (oControl as PactListBoxData).SelectedValue, this.DocumentDate, oControl.DBColumnName, (oControl as PactListBoxData).CCID, null);
                    }
                });

                this.ScreenObject._TextFields.forEach(oControl => {
                    if (oControl instanceof PactListBoxData && lref.Contains(oControl.DBColumnID.toString())) {
                        if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == oControl.DBColumnID).length > 0)
                            this.ScreenObject.GetLinkReferenceData(oControl.DBColumnID, this.ScreenObject.CostCenterID, (oControl as PactListBoxData).SelectedValue, this.DocumentDate, oControl.DBColumnName, (oControl as PactListBoxData).CCID, null);
                    }
                });

                if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0) {
                    if (lref.Contains(this.ScreenObject.DebitAccount.DBColumnID.toString())) {
                        if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == this.ScreenObject.DebitAccount.DBColumnID.toString()).length > 0)
                            this.ScreenObject.GetLinkReferenceData(this.ScreenObject.DebitAccount.DBColumnID, this.ScreenObject.CostCenterID, this.ScreenObject.DebitAccount.SelectedValue, this.DocumentDate, this.ScreenObject.DebitAccount.DBColumnName, 2, null);
                    }
                }
                if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0) {
                    if (lref.Contains(this.ScreenObject.CreditAccount.DBColumnID.toString())) {
                        if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == this.ScreenObject.CreditAccount.DBColumnID.toString()).length > 0)
                            this.ScreenObject.GetLinkReferenceData(this.ScreenObject.CreditAccount.DBColumnID, this.ScreenObject.CostCenterID, this.ScreenObject.CreditAccount.SelectedValue, this.DocumentDate, this.ScreenObject.CreditAccount.DBColumnName, 2, null);
                    }
                }
            }

            if (ds.Tables.length > 19 && ds.Tables[19].length > 0 && !Util.IsEmpty(ds.Tables[19][0][ds.Columns[19][0]])) {
                let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference == 79 && x.LinkData == 55478);

                if (dvCnt.length > 0) {
                    let c0 = ds.Columns[19][0]
                    if (this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"]) && this.ScreenObject.GridData.length > 0)
                        this.ScreenObject.GridData[0][dvCnt[0]["SysColumnName"]] = ds.Tables[19][0][c0].toString();
                    else {
                        let fld = this.ScreenObject._TextFields.find(a => a.DBColumnID == dvCnt[0]["CostCenterColID"]);
                        if (fld)
                            this.ScreenObject.fillcontrolValue(fld, ds.Tables[19][0][c0].toString());
                    }
                }
            }

            if (this.IsInventoryVoucher && this.FooterVisible) {
                let footerxml = new XmlDocument();
                if (ds.Columns[2].Contains("Remarks") && ds.Tables[2].length > 0 && !Util.IsEmpty(ds.Tables[2][0]["Remarks"])
                    && this.ScreenObject.Preferences.ContainsKey("CopyFooterDetails") && this.ScreenObject.Preferences["CopyFooterDetails"] != "" && parseBoolean(this.ScreenObject.Preferences["CopyFooterDetails"])) {
                    footerxml.LoadXml(ds.Tables[2][0]["Remarks"]);
                }
                if (this.ScreenObject.FooterColumnSource[1].ReadOnly) {
                    for (i = 0; i < this.ScreenObject.FooterGridData.length; i++) {
                        let dv = null, dvDt;
                        if (CopyDt == null)
                            dvDt = ds.Tables[4];
                        else
                            dvDt = CopyDt;
                        dv = dvDt.filter(x => x.BASECOL == this.ScreenObject.FooterGridData[i]["ColumnName"]);

                        let fieldName = "";
                        if (dv.length > 0 && !Util.IsEmpty(dv[0]["LINKCOL"])) {
                            fieldName = dv[0]["LINKCOL"].toString();
                            let Resvalue = "";
                            let ResCalcvalue = "";
                            if (ds.Tables.length > 2 && ds.Columns[2].Contains(fieldName) && (fieldName.toLowerCase().Contains("dcnum") || fieldName.toLowerCase().Contains("dccalcnum") || fieldName.toLowerCase().Contains("dccurrid") || fieldName.toLowerCase().Contains("dcexchrt"))) {
                                let TotVal = null;
                                if (ds.Tables[2].length > 0)
                                    TotVal = ds.Tables[2][0][fieldName].toString();
                                if (TotVal != null)
                                    Resvalue = TotVal.toString();

                                let TotCalcVal = ds.Tables[2].Compute("sum", "dcCalc" + fieldName.replace("dc", ""));
                                if (TotCalcVal != null)
                                    ResCalcvalue = TotCalcVal.toString();
                            }

                            if ((Resvalue == "" || !Util.IsNum(Resvalue) || parseFloat(Resvalue) == 0)
                                && (ResCalcvalue == "" || !Util.IsNum(ResCalcvalue) || parseFloat(ResCalcvalue) == 0))
                                continue;

                            if (this.ScreenObject.FooterGridDataColumns.Contains("dcCurrID_Key") && !Util.IsEmpty(this.ScreenObject.FooterGridData[i]["dcCurrID_Key"])
                                && parseInt(this.ScreenObject.FooterGridData[i]["dcCurrID_Key"].toString()) != -3 && parseInt(this.ScreenObject.FooterGridData[i]["dcCurrID_Key"].toString()) != -1) {
                                if (fieldName.toLowerCase().Contains("dcnum") && ds.Columns[2].Contains("dcCurrID" + fieldName.toLowerCase().Replace("dcnum", ""))
                                    && !Util.IsEmpty(ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dcnum", "")]))
                                    this.ScreenObject.FooterGridData[i]["dcCurrID_Key"] = ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dcnum", "")].toString();
                                if (fieldName.toLowerCase().Contains("dcnum") && ds.Columns[2].Contains("dcExchRT" + fieldName.toLowerCase().Replace("dcnum", ""))
                                    && !Util.IsEmpty(ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dcnum", "")]))
                                    this.ScreenObject.FooterGridData[i]["dcExchRT"] = ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dcnum", "")].toString();

                                if (fieldName.toLowerCase().Contains("dccalcnum") && ds.Columns[2].Contains("dcCurrID" + fieldName.toLowerCase().Replace("dccalcnum", ""))
                                    && !Util.IsEmpty(ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dccalcnum", "")]))
                                    this.ScreenObject.FooterGridData[i]["dcCurrID_Key"] = ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dccalcnum", "")].toString();
                                if (fieldName.toLowerCase().Contains("dccalcnum") && ds.Columns[2].Contains("dcExchRT" + fieldName.toLowerCase().Replace("dccalcnum", ""))
                                    && !Util.IsEmpty(ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dccalcnum", "")]))
                                    this.ScreenObject.FooterGridData[i]["dcExchRT"] = ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dccalcnum", "")].toString();
                            }
                            if (Resvalue != "" && Util.IsNum(Resvalue)) {
                                if (this.ScreenObject.Preferences.ContainsKey("ClubFooter") && this.ScreenObject.Preferences["ClubFooter"] != "" && parseBoolean(this.ScreenObject.Preferences["ClubFooter"])
                                    && !Util.IsEmpty(this.ScreenObject.FooterGridData[i]["Amount"]) && Util.IsNum(this.ScreenObject.FooterGridData[i]["Amount"]))
                                    this.ScreenObject.FooterGridData[i]["Amount"] = parseFloat(this.ScreenObject.FooterGridData[i]["Amount"]) + parseFloat(Resvalue);
                                else
                                    this.ScreenObject.FooterGridData[i]["Amount"] = Resvalue;
                                this.FooterCellEditEnd("Amount", this.ScreenObject.FooterGridData[i]);
                            }
                            else if (ResCalcvalue != "" && Util.IsNum(ResCalcvalue)) {
                                if (this.ScreenObject.Preferences.ContainsKey("ClubFooter") && this.ScreenObject.Preferences["ClubFooter"] != "" && parseBoolean(this.ScreenObject.Preferences["ClubFooter"])
                                    && !Util.IsEmpty(this.ScreenObject.FooterGridData[i]["CalcAmount"]) && Util.IsNum(this.ScreenObject.FooterGridData[i]["CalcAmount"]))
                                    this.ScreenObject.FooterGridData[i]["CalcAmount"] = parseFloat(this.ScreenObject.FooterGridData[i]["CalcAmount"]) + parseFloat(ResCalcvalue);
                                else
                                    this.ScreenObject.FooterGridData[i]["CalcAmount"] = ResCalcvalue;

                                this.FooterCellEditEnd("CalcAmount", this.ScreenObject.FooterGridData[i]);
                            }

                            let remarkslist = footerxml.SelectNodes("XML/Row");
                            for (let k = 0; k < remarkslist.length; k++) {
                                let xnode = remarkslist[k]
                                if (xnode.attributes["Columnname"] != null && xnode.attributes["Columnname"].value.toLowerCase() == fieldName.toLowerCase()) {
                                    if (xnode.attributes["DebitAccount"] != null && xnode.attributes["DebitAccount"].value != "")
                                        this.ScreenObject.FooterGridData[i]["DebitAccount"] = xnode.attributes["DebitAccount"].value;
                                    if (xnode.attributes["CreditAcount"] != null && xnode.attributes["CreditAcount"].value != "")
                                        this.ScreenObject.FooterGridData[i]["CreditAccount"] = xnode.attributes["CreditAcount"].value;
                                    if (xnode.attributes["Remarks"] != null && xnode.attributes["Remarks"].value != "")
                                        this.ScreenObject.FooterGridData[i]["Remarks"] = xnode.attributes["Remarks"].value;
                                    break;
                                }
                            }
                        }
                    }
                }
                else {
                    if (this.ScreenObject.FooterColumnSource[1].ComboData instanceof DataView) {
                        this.ScreenObject.FooterColumnSource[1].SetComboData(this.ScreenObject.FooterColumnSource[1].ComboDataTable)
                        for (i = 0; i < this.ScreenObject.FooterColumnSource[1].ComboData.length; i++) {
                            let dvDt = null;
                            if (CopyDt == null)
                                dvDt = ds.Tables[4];
                            else
                                dvDt = CopyDt;
                            let dv = dvDt.filter(x => x.BASECOL == this.ScreenObject.FooterColumnSource[1].ComboData[i]["ColumnName"]);
                            let fieldName = "";
                            if (dv.length > 0 && !Util.IsEmpty(dv[0]["LINKCOL"])) {
                                fieldName = dv[0]["LINKCOL"].toString();
                                let Resvalue = "";
                                let ResCalcvalue = "";
                                if (ds.Tables.length > 2 && ds.Columns[2].Contains(fieldName) && (fieldName.toLowerCase().Contains("dcnum") || fieldName.toLowerCase().Contains("dccalcnum") || fieldName.toLowerCase().Contains("dccurrid") || fieldName.toLowerCase().Contains("dcexchrt"))) {
                                    let TotVal = null;
                                    if (ds.Tables[2].length > 0)
                                        TotVal = ds.Tables[2][0][fieldName].toString();
                                    if (TotVal != null)
                                        Resvalue = TotVal.toString();
                                    else
                                        Resvalue = "0";
                                    let TotCalcVal = ds.Tables[2].Compute("sum", "dcCalc" + fieldName.replace("dc", ""));
                                    if (TotCalcVal != null)
                                        ResCalcvalue = TotCalcVal.toString();
                                }
                                if ((Resvalue == "" || !Util.IsNum(Resvalue) || parseFloat(Resvalue) == 0)
                                    && (ResCalcvalue == "" || !Util.IsNum(ResCalcvalue) || parseFloat(ResCalcvalue) == 0))
                                    continue;

                                let drarr = this.ScreenObject.FooterGridData.filter(x => x.ColumnName == this.ScreenObject.FooterColumnSource[1].ComboData[i]["ColumnName"]);
                                let footerdr;
                                if (drarr.length > 0) {
                                    footerdr = drarr[0];

                                    if (this.ScreenObject.FooterGridDataColumns.Contains("dcCurrID_Key") && !Util.IsEmpty(footerdr["dcCurrID_Key"])
                                        && parseInt(footerdr["dcCurrID_Key"].toString()) != -3 && parseInt(footerdr["dcCurrID_Key"].toString()) != -1) {
                                        if (fieldName.toLowerCase().Contains("dcnum") && ds.Columns[2].Contains("dcCurrID" + fieldName.toLowerCase().Replace("dcnum", ""))
                                            && !Util.IsEmpty(ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dcnum", "")]))
                                            footerdr["dcCurrID_Key"] = ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dcnum", "")].toString();
                                        if (fieldName.toLowerCase().Contains("dcnum") && ds.Columns[2].Contains("dcExchRT" + fieldName.toLowerCase().Replace("dcnum", ""))
                                            && !Util.IsEmpty(ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dcnum", "")]))
                                            footerdr["dcExchRT"] = ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dcnum", "")].toString();

                                        if (fieldName.toLowerCase().Contains("dccalcnum") && ds.Columns[2].Contains("dcCurrID" + fieldName.toLowerCase().Replace("dccalcnum", ""))
                                            && !Util.IsEmpty(ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dccalcnum", "")]))
                                            footerdr["dcCurrID_Key"] = ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dccalcnum", "")].toString();
                                        if (fieldName.toLowerCase().Contains("dccalcnum") && ds.Columns[2].Contains("dcExchRT" + fieldName.toLowerCase().Replace("dccalcnum", ""))
                                            && !Util.IsEmpty(ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dccalcnum", "")]))
                                            footerdr["dcExchRT"] = ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dccalcnum", "")].toString();
                                    }

                                    if (Resvalue != "") {
                                        if (this.ScreenObject.Preferences.ContainsKey("ClubFooter") && parseBoolean(this.ScreenObject.Preferences["ClubFooter"])
                                            && Util.IsNum(drarr[0]["Amount"]))
                                            drarr[0]["Amount"] = parseFloat(drarr[0]["Amount"]) + parseFloat(Resvalue);
                                        else
                                            drarr[0]["Amount"] = Resvalue;
                                        this.FooterCellEditEnd("Amount", drarr[0]);
                                    }
                                    else if (ResCalcvalue != "") {
                                        if (this.ScreenObject.Preferences.ContainsKey("ClubFooter") && parseBoolean(this.ScreenObject.Preferences["ClubFooter"])
                                            && Util.IsNum(drarr[0]["CalcAmount"]))
                                            drarr[0]["CalcAmount"] = parseFloat(drarr[0]["CalcAmount"]) + parseFloat(ResCalcvalue);
                                        else
                                            drarr[0]["CalcAmount"] = ResCalcvalue;
                                        this.FooterCellEditEnd("CalcAmount", drarr[0]);
                                    }
                                }
                                else {
                                    let FooterRowpos = this.GetEmptyRowPosition(this.ScreenObject.FooterGridDataObj, "ColumnName");
                                    if (FooterRowpos > -1)
                                        footerdr = this.ScreenObject.FooterGridData[FooterRowpos];
                                    else {
                                        footerdr = this.ScreenObject.FooterGridDataObj.NewRow();
                                        this.ScreenObject.FooterGridData.push(footerdr);
                                    }

                                    footerdr["ColumnName"] = this.ScreenObject.FooterColumnSource[1].ComboData[i]["ColumnName"].toString();
                                    this.FooterCellEditEnd("ColumnName", footerdr);

                                    if (this.ScreenObject.FooterGridDataColumns.Contains("StyleHeightZero")) {
                                        if (parseBoolean(footerdr["IsVisible"]))
                                            footerdr["StyleHeightZero"] = 0;
                                        else {
                                            footerdr["StyleHeightZero"] = 1;
                                            if (FooterRowpos > -1) {
                                                footerdr = this.ScreenObject.FooterGridDataObj.NewRow();
                                                this.ScreenObject.FooterGridData.push(footerdr);
                                                footerdr["ColumnName"] = this.ScreenObject.FooterColumnSource[1].ComboData[i]["ColumnName"].toString();
                                                this.FooterCellEditEnd("ColumnName", footerdr);
                                                footerdr["StyleHeightZero"] = 1;
                                                this.ScreenObject.FooterGridDataObj.removeRowAt(FooterRowpos);
                                            }
                                        }
                                    }

                                    if (Resvalue != "") {
                                        if (this.ScreenObject.FooterGridDataColumns.Contains("dcCurrID_Key") && !Util.IsEmpty(footerdr["dcCurrID_Key"])
                                            && parseInt(footerdr["dcCurrID_Key"].toString()) != -3 && parseInt(footerdr["dcCurrID_Key"].toString()) != -1) {
                                            if (fieldName.toLowerCase().Contains("dcnum") && ds.Columns[2].Contains("dcCurrID" + fieldName.toLowerCase().Replace("dcnum", ""))
                                                && !Util.IsEmpty(ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dcnum", "")]))
                                                footerdr["dcCurrID_Key"] = ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dcnum", "")].toString();
                                            if (fieldName.toLowerCase().Contains("dcnum") && ds.Columns[2].Contains("dcExchRT" + fieldName.toLowerCase().Replace("dcnum", ""))
                                                && !Util.IsEmpty(ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dcnum", "")]))
                                                footerdr["dcExchRT"] = ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dcnum", "")].toString();

                                            if (fieldName.toLowerCase().Contains("dccalcnum") && ds.Columns[2].Contains("dcCurrID" + fieldName.toLowerCase().Replace("dccalcnum", ""))
                                                && !Util.IsEmpty(ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dccalcnum", "")]))
                                                footerdr["dcCurrID_Key"] = ds.Tables[2][0]["dcCurrID" + fieldName.toLowerCase().Replace("dccalcnum", "")].toString();
                                            if (fieldName.toLowerCase().Contains("dccalcnum") && ds.Columns[2].Contains("dcExchRT" + fieldName.toLowerCase().Replace("dccalcnum", ""))
                                                && !Util.IsEmpty(ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dccalcnum", "")]))
                                                footerdr["dcExchRT"] = ds.Tables[2][0]["dcExchRT" + fieldName.toLowerCase().Replace("dccalcnum", "")].toString();
                                        }
                                        if (this.ScreenObject.Preferences.ContainsKey("ClubFooter") && parseBoolean(this.ScreenObject.Preferences["ClubFooter"])
                                            && Util.IsNum(footerdr["Amount"]))
                                            footerdr["Amount"] = parseFloat(footerdr["Amount"]) + parseFloat(Resvalue);
                                        else
                                            footerdr["Amount"] = Resvalue;
                                        this.FooterCellEditEnd("Amount", footerdr);
                                    }
                                    else if (ResCalcvalue != "") {
                                        if (this.ScreenObject.Preferences.ContainsKey("ClubFooter") && parseBoolean(this.ScreenObject.Preferences["ClubFooter"])
                                            && Util.Double(footerdr["CalcAmount"]))
                                            footerdr["CalcAmount"] = parseFloat(footerdr["CalcAmount"]) + parseFloat(ResCalcvalue);
                                        else
                                            footerdr["CalcAmount"] = ResCalcvalue;
                                        this.FooterCellEditEnd("CalcAmount", footerdr);
                                    }
                                }

                                let remarkslist = footerxml.SelectNodes("XML/Row");
                                for (let k = 0; k < remarkslist.length; k++) {
                                    let xnode = remarkslist[k]
                                    if (xnode.attributes["Columnname"] != null && xnode.attributes["Columnname"].value.toLowerCase() == fieldName.toLowerCase()) {
                                        if (xnode.attributes["DebitAccount"] != null && xnode.attributes["DebitAccount"].value != "")
                                            footerdr["DebitAccount"] = xnode.attributes["DebitAccount"].value;
                                        if (xnode.attributes["CreditAcount"] != null && xnode.attributes["CreditAcount"].value != "")
                                            footerdr["CreditAccount"] = xnode.attributes["CreditAcount"].value;
                                        if (xnode.attributes["Remarks"] != null && xnode.attributes["Remarks"].value != "")
                                            footerdr["Remarks"] = xnode.attributes["Remarks"].value;
                                        break;
                                    }
                                }
                            }
                        }
                        this.ScreenObject.FooterColumnSource[1].SetComboData(this.ScreenObject.FooterColumnSource[1].ComboDataTable.filter(x => x.IsVisible == true));
                    }
                    this.GetEmptyRowPosition(this.ScreenObject.FooterGridDataObj, "ColumnName");
                    this.ScreenObject.UpdateSequenceFoot();
                }
                this.RefreshGridFooter = true;
            }

            if (ds.Tables.length > 10 && ds.Tables[10].length > 0 && this.ScreenObject.Preferences.ContainsKey("CopyAddresses") && this.ScreenObject.Preferences["CopyAddresses"] != "" && parseBoolean(this.ScreenObject.Preferences["CopyAddresses"])) {
                this.AddAddress(ds);
            }
            if (ds.Tables.length > 7 && ds.Tables[7].length > 0 && this.ScreenObject.Preferences.ContainsKey("LinkAttachments") && this.ScreenObject.Preferences["LinkAttachments"] != "" && parseBoolean(this.ScreenObject.Preferences["LinkAttachments"])) {
                let dratt = null;
                if (ds.Columns[7].Contains("DocID")) {
                    let DocIDids: number[] = [];
                    for (i = 0; i < ds.Tables[0].length; i++) {
                        DocIDids.push(ds.Tables[0][i]["DocID"]);
                    }
                    if (DocIDids.length > 0) {
                        dratt = ds.Tables[7].filter(x => DocIDids.Contains(x.DocID));
                    }
                }
                else
                    dratt = ds.Tables[7];

                if (dratt != null && dratt.length > 0 && this.ViewAttachments != null) {
                    let drc11: any = null;
                    let sLinkCol = "", sBaseCol = "";
                    for (let p = 0; p < dratt.length; p++) {
                        sLinkCol = sBaseCol = "";
                        let addatt = new AddAttachmentViewModel();
                        addatt.AddAttachmentViewModel_2(this);
                        {
                            addatt.ActualFileName = Util.String(dratt[p]["ActualFileName"]);
                            addatt.FileExtension = Util.String(dratt[p]["FileExtension"]);
                            addatt.guid = Util.String(dratt[p]["GUID"]);
                            addatt.FileDescription = Util.String(dratt[p]["FileDescription"]);
                            addatt.FilePath = PactFile.GetLogPath(Util.String(dratt[p]["GUID"]) + "." + Util.String(dratt[p]["FileExtension"]));
                            addatt.RelativeFileName = Util.String(dratt[p]["RelativeFileName"]);
                            addatt.AllowInPrint = parseBoolean(dratt[p]["AllowInPrint"]);
                            addatt.isfrmProduct = true;

                            if (!Util.IsEmpty(dratt[p]["ColName"])) {
                                sLinkCol = Util.String(dratt[p]["ColName"]);
                                drc11 = ds.Tables[4].filter(x => x.LINKCOL == sLinkCol);
                                if (drc11 != null && drc11.length > 0)
                                    sBaseCol = Util.String(drc11[0]["BASECOL"]);

                                if (!Util.IsEmpty(sBaseCol))
                                    addatt.ColID = sBaseCol;
                                if (!Util.IsEmpty(dratt[p]["InvDocDetailsID"])) {
                                    drc11 = this.ScreenObject.GridData.filter(x => x.LinkedInvDocDetailsID == dratt[p]["InvDocDetailsID"].toString());
                                    if (drc11 != null && drc11.length > 0)
                                        addatt.RowID = drc11[0];
                                }
                            }
                            else {
                                addatt.ColID = '';
                                addatt.RowID = null;
                            }
                            addatt.RefNo = Util.String(ds.Tables[0][0]["VoucherNO"]);
                            this.ViewAttachments.AttachmentsListObj.addRow(addatt);

                            if (!Util.IsEmpty(dratt[p]["ColName"])) {
                                let index = this.ScreenObject.AttachmentFields.findIndex(x => x.DBColumnName == dratt[p]["ColName"])
                                if (index != -1) {
                                    this.ScreenObject.AttachmentFields[index].ActualFileName = addatt.ActualFileName.toString();
                                    this.ScreenObject.AttachmentFields[index].guid = dratt[p]["GUID"].toString();
                                    this.ScreenObject.AttachmentFields[index].FileExtension = dratt[p]["FileExtension"].toString();

                                }
                            }


                        }
                    }
                }
            }

            if (this.ScreenObject.DocumentType == 57) {
                let dblBalAmount = 0;
                for (i = 0; i < ds.Tables[0].length; i++) {
                    if (!Util.IsEmpty(ds.Tables[0][0][ds.Columns[0][0]]))
                        dblBalAmount += parseFloat(ds.Tables[0][0][ds.Columns[0][0]]);
                }
                for (i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["RefNo"]) && Util.String(this.ScreenObject.GridData[i]["dcAlpha2"]) == "") {
                        if (this.ScreenObject.GridData[i]["RefNo"].toString() == ds.Tables[0][0]["VoucherNO"].toString())
                            this.ScreenObject.GridData[i]["dcAlpha2"] = dblBalAmount;
                    }
                }
            }

            for (i = 0; i < this.Shortcuts.length; i++) {
                if (this.Shortcuts[i] instanceof PactControlData && this.Shortcuts[i].Mode == 5 && this.ValidateData(this.Shortcuts[i] as PactControlData, true))
                    this.ScreenObject.GetExternalFuncData(this.Shortcuts[i].Mode, this.Shortcuts[i].ToolTipFooterTitle, this.Shortcuts[i].ToolTipFooterDescription, this.Shortcuts[i].ToolTipDescription, null);
            }
            if (ids != null && ids.length == 0 && ds.Tables[0].length > 0 && !this.IsSelectAll) {
                this.RefreshGrid = true;
                this.ScreenObject.FillListViews(false);
            }
            else if (BaseService.SessionManager.Preferences.ContainsKey("DisableAutoLoad") && BaseService.SessionManager.Preferences["DisableAutoLoad"].toLowerCase() == "true")
                this.ScreenObject.FillListViews(false);

            this.ScreenObject.SetDefaultValuesforCostCenters(2);
            if (CopyDt == null && this.ScreenObject.Preferences.ContainsKey("SortbyProduct") && this.ScreenObject.Preferences["SortbyProduct"].toLowerCase() == "true")
                this.SortGrid(true);
            if (ds.Tables[0].length < 500) {
                if (RowPos > 100) {
                    for (i = RowPos; i < this.ScreenObject.GridData.length; i++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]))
                            this.CalculateTotals(this.ScreenObject.GridData[i], false, "", false);
                    }
                }
                else {
                    this.ScreenObject.GridData.forEach(dr => {
                        if (!Util.IsEmpty(dr["ProductID_Key"])) {
                            this.CalculateTotals(dr, false, "", false);
                        }
                    });

                }
            }
            this.CalculateTotals(null, false);
        }
        catch (error) {
            Logger.ErrorLog("VoucherGenerator", "LoadEditData", error.stack);
        }
        finally {
            this.ScreenObject.AttachDetach(true);
        }
    }

    RemoveDupl(dsr: any) {
        let drr = dsr.Tables[0].SortBy([{ name: "packlbl", desc: false }])
        let PVal = '';
        let torem: any[] = [];
        let drmain = null;
        for (let k = 0; k < drr.length; k++) {
            if (k > 0 && Util.String(drr[k]["packlbl"]) == PVal && drmain != null) {
                drmain["Qty"] = parseFloat(drmain["Qty"]) + parseFloat(Util.String(drr[k]["Qty"]));
                torem.push(drr[k]);
            }
            else
                drmain = drr[k];
            PVal = drr[k]["packlbl"].toString();
        }
        for (let i = 0; i < torem.length; i++) {
            dsr.Tables[0].Remove(torem[i]);
        }
    }

    FillLinkRefereceProducts_2(SB: string, dt: any[]) {
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 23819 }, "AvgRate");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 25398 }, "QOH");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 52638 }, "QOH");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 52637 }, "BalQOH");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 26421 }, "HOLDQTY");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 50454 }, "CommittedQty");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 26422 }, "RESERVEQTY");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 499943 }, "TotalReserve");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 23820 }, "LastPurchaseRate");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 24062 }, "PWLastPRate");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 50051 }, "LastPCost");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 23821 }, "PWLastPCost");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 50494 }, "UnitProductCode");
        this.FillDatarow_4(SB, dt, { LocalReference: 79, LinkData: 50493 }, "VendorProductCode");

        this.FillDatarow_4(SB, dt, { LinkData: 22821 }, "SellingRate");
        this.FillDatarow_4(SB, dt, { LinkData: 22793 }, "SellingRateA");
        this.FillDatarow_4(SB, dt, { LinkData: 22794 }, "SellingRateB");
        this.FillDatarow_4(SB, dt, { LinkData: 22795 }, "SellingRateC");
        this.FillDatarow_4(SB, dt, { LinkData: 22796 }, "SellingRateD");
        this.FillDatarow_4(SB, dt, { LinkData: 22797 }, "SellingRateE");
        this.FillDatarow_4(SB, dt, { LinkData: 22798 }, "SellingRateF");
        this.FillDatarow_4(SB, dt, { LinkData: 22799 }, "SellingRateG");

        this.FillDatarow_4(SB, dt, { LinkData: 22820 }, "PurchaseRate");
        this.FillDatarow_4(SB, dt, { LinkData: 22786 }, "PurchaseRateA");
        this.FillDatarow_4(SB, dt, { LinkData: 22787 }, "PurchaseRateB");
        this.FillDatarow_4(SB, dt, { LinkData: 22788 }, "PurchaseRateC");
        this.FillDatarow_4(SB, dt, { LinkData: 22789 }, "PurchaseRateD");
        this.FillDatarow_4(SB, dt, { LinkData: 22790 }, "PurchaseRateE");
        this.FillDatarow_4(SB, dt, { LinkData: 22791 }, "PurchaseRateF");
        this.FillDatarow_4(SB, dt, { LinkData: 22792 }, "PurchaseRateG");

        this.FillDatarow_4(SB, dt, { LinkData: 277 }, "ReorderQty");
        this.FillDatarow_4(SB, dt, { LinkData: 276 }, "ReorderLevel");

    }

    FillDatarow_4(SB: string, dt: any[], objFilter: any, ColName: string) {
        let dvCnt: any;
        if (objFilter.LocalReference)
            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference == objFilter.LocalReference && x.LinkData == objFilter.LinkData);
        else
            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LinkData == objFilter.LinkData);
        if (dvCnt.length > 0) {
            if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                if (!Util.IsEmpty(dt[0][ColName])) {
                    if (SB.toString().Contains(dvCnt[0]["SysColumnName"] + "=\"")) {
                        let ind = SB.toString().indexOf(dvCnt[0]["SysColumnName"] + "=\"");
                        let nextind = SB.toString().indexOf("\"", ind + dvCnt[0]["SysColumnName"].length + 2);
                        SB = SB.Remove(ind, nextind + 1 - ind);
                    }
                    SB += " " + dvCnt[0]["SysColumnName"] + "=\"" + dt[0][ColName].toString() + "\" ";
                }
            }
        }
    }

    GetEmptyRowPosition(grdObj: PactGridViewModel, VerifyFieldName: string): number {
        let Position = -1;
        let Dt: any[] = grdObj.Table;
        let DtColumns: any[] = grdObj.Columns;
        for (let i = 0; i < Dt.length; i++) {
            if (Util.String(Dt[i][VerifyFieldName]) == "") {
                Position = i;
                break;
            }
        }
        if (Position == -1) {
            Dt.push({});
            Position = Dt.length - 1;
            if (DtColumns.Contains("Sno"))
                Dt[Position]["Sno"] = Dt.length;
            if (DtColumns.Contains("DocSeqNo"))
                Dt[Position]["DocSeqNo"] = Dt.length;
        }
        return Position;
    }

    FillLink(VoucherNo: string, DocumentLinkDefID: number, ids: any[], cols: string[]) {
        let ds: any = this.ScreenObject.GetLinkDocDetails(VoucherNo, DocumentLinkDefID);
        if (BaseService.IsNativeMobile && BaseService.IsMobile) {
            this.ScreenObject.GridDataObj.addEmptyRow();
        }

        let RowPos = 0;
        for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
            if (Util.IsEmpty(this.ScreenObject.GridData[k]["ProductID_Key"])
                && (!this.ScreenObject.GridDataColumns.Contains("RefNo") || Util.IsEmpty(this.ScreenObject.GridData[k]["RefNo"]))) {
                RowPos = k;
                break;
            }
        }

        for (let i = 0; i < ds.Tables[0].length; i++) {
            let linkedRows = this.ScreenObject.GridData.filter(x => x.LinkedInvDocDetailsID == ds.Tables[0][i]["DocDetailsID"]);
            if (linkedRows.length > 0) {
                let UsedValue = 0;
                for (let l = 0; l < linkedRows.length; l++) {
                    if (!Util.IsEmpty(linkedRows[l][ds.Tables[0][i][ds.Columns[0][3]].toString()]) && Util.IsNum(linkedRows[l][ds.Tables[0][i][ds.Columns[0][3]].toString()])) {
                        UsedValue += parseFloat(linkedRows[l][ds.Tables[0][i][ds.Columns[0][3]]]);
                    }
                }

                if (!Util.IsEmpty(ds.Tables[0][i][ds.Columns[0][0]]) && Util.IsNum(ds.Tables[0][i][ds.Columns[0][0]]) && (parseFloat(ds.Tables[0][i][ds.Columns[0][0]]) - UsedValue) > 0)
                    ds.Tables[0][i][ds.Columns[0][0]] = parseFloat(ds.Tables[0][i][ds.Columns[0][0]]) - UsedValue;
                else {
                    ds.Tables[0].RemoveAt(i);
                    ds.Tables[1].RemoveAt(i);
                    ds.Tables[2].RemoveAt(i);
                    ds.Tables[3].RemoveAt(i);
                    i--;
                    continue;
                }
            }
        }

        //Remove unselected ids
        if (ids != null && ids.length > 0) {
            for (let i = ds.Tables[0].length - 1; i >= 0; i--) {
                if (!ids.find(x => x["InvDocDetailsID"] == ds.Tables[0][i]["DocDetailsID"])) {
                    ds.Tables[0].RemoveAt(i);
                    ds.Tables[1].RemoveAt(i);
                    ds.Tables[2].RemoveAt(i);
                    ds.Tables[3].RemoveAt(i);
                }
            }

            if (VoucherNo.Contains(',')) {
                for (let i = ds.Tables[7].length - 1; i >= 0; i--) {
                    if (ds.Tables[0].filter(x => x.DocID == ds.Tables[7][i]["FeaturePK"]).length == 0)
                        ds.Tables[7].RemoveAt(i);
                }
            }
        }
        this.LoadLinkData(ds, ids, RowPos, cols, null);
    }
    IsSelectAll: boolean = false;
    onselectall(sender: string) {
        if (this.ScreenObject.Link != null && this.ScreenObject.Link.LinkCombo != null && this.ScreenObject.Link.LinkCombo.SelectedValue != null && this.ScreenObject.Link.LinkCombo.SelectedValue != "" && this.ScreenObject.Link.DocumentList != null) {
            if (this.ScreenObject.Preferences.ContainsKey("SameserialNo") && this.ScreenObject.Preferences["SameserialNo"] != "" && parseBoolean(this.ScreenObject.Preferences["SameserialNo"])) {
                this.DisplayMessage = "Can not select all when same Serial No in linking";
                return;
            }
            this.IsSelectAll = true;
            for (let i = 0; i < this.ScreenObject.Link.DocumentList.Items.length; i++) {
                if (!this.ScreenObject.Link.DocumentList.Items[i].IsChecked) {
                    this.ScreenObject.Link.DocumentList.Items[i].IsChecked = true;
                    this.FillLinkDocument(this.ScreenObject.Link.DocumentList.Items[i]);
                }
            }
            this.IsSelectAll = false;
        }
        this.RefreshGrid = true;
        this.CheckVendorWiseLinkingPref();
    }

    FillLinkDocument(sender: any) {
        if (this.ScreenObject.Link.LinkCombo.SelectedValue != null && this.ScreenObject.Link.LinkCombo.SelectedValue != "") {
            if ((this.ScreenObject.Link.LinkCombo.SelectedItem != null && (this.ScreenObject.Link.LinkCombo.SelectedItem.Parent == "158" || this.ScreenObject.Link.LinkCombo.SelectedItem.Parent == "76"))
                || (this.ScreenObject.Preferences.ContainsKey("Selective") && parseBoolean(this.ScreenObject.Preferences["Selective"]))) {
                let NodeID = 0; let isbom = false;
                if (this.ScreenObject.Link.LinkCombo.SelectedItem != null && (this.ScreenObject.Link.LinkCombo.SelectedItem.Parent == "158" || this.ScreenObject.Link.LinkCombo.SelectedItem.Parent == "76")
                    && (sender as CheckedListBoxItem).Value != null && (sender as CheckedListBoxItem).Value != "")
                    NodeID = parseInt((sender as CheckedListBoxItem).Value);
                if (this.ScreenObject.Link.LinkCombo.SelectedItem != null && this.ScreenObject.Link.LinkCombo.SelectedItem.Parent == "76")
                    isbom = true;
                let objLink = new LinkDocument(this, (sender as CheckedListBoxItem).Name, parseInt(this.ScreenObject.Link.LinkCombo.SelectedValue), NodeID, isbom);
                BaseService.page.ShowDialog(objLink, LinkSelectiveComponent, { ShowCenter: true && !BaseService.IsMobile });
                /*** if (BaseService.IsNativeMobile && BaseService.IsMobile) {
                      this.ScreenObject.GridDataObj.addEmptyRow();
                  }***/
                let RowPos = 0;
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (Util.IsEmpty(this.ScreenObject.GridData[k]["ProductID_Key"])) {
                        RowPos = k;
                        break;
                    }
                }
                if (RowPos > 0)
                    this.LineNo = RowPos;
                else
                    this.LineNo = 1;
                this.SetFocusongrid = true;
            }
            else {
                this.FillLink(sender.Name, parseInt(this.ScreenObject.Link.LinkCombo.SelectedValue), [], []);
            }
        }
    }

    OnLinkDocumentCheckedChanged(args: any) {
        if (this.IsSelectAll)
            return;
        let sender: any = args.item ? args.item : args;
        Logger.InfoLog("AddEditDocumentViewModel::Entering OnLinkDocumentCheckedChanged");
        if (sender instanceof CheckedListBoxItem) {
            if (sender.IsChecked) {
                if (((this.ScreenObject.Preferences.ContainsKey("SameserialNo") && this.ScreenObject.Preferences["SameserialNo"] != "" && parseBoolean(this.ScreenObject.Preferences["SameserialNo"]))
                    || (this.ScreenObject.Preferences.ContainsKey("Linksingledoc") && this.ScreenObject.Preferences["Linksingledoc"] != "" && parseBoolean(this.ScreenObject.Preferences["Linksingledoc"])))
                    && this.ScreenObject.GridData.filter(x => x.LinkedInvDocDetailsID > 0).length > 0) {
                    if (this.ScreenObject.Preferences.ContainsKey("SameserialNo") && this.ScreenObject.Preferences["SameserialNo"] != "" && parseBoolean(this.ScreenObject.Preferences["SameserialNo"]))
                        this.DisplayMessage = "Can not select multiple when same Serial No in linking";
                    else
                        this.DisplayMessage = "Can link only one document";

                    this.IsSelectAll = true;
                    sender.IsChecked = false;
                    this.IsSelectAll = false;
                    return;
                }
                /***
                                MessageBlinkDialog ImportStatus = new MessageBlinkDialog();
                                ImportStatus.SleepTime = 50;***/
                this.DisplayMessage = "Linking data please wait."; //ImportStatus.ShowMessage("Linking data please wait.");
                this.FillLinkDocument(sender);
                this.DisplayMessage = "";
                //let linkedrows = this.ScreenObject.GridData.filter(x=>x.RefNo=='" + sender.Name + "'");
                //if (linkedrows.length == 0)
                //{
                //    IsSelectAll = true;
                //    sender.IsChecked = false;
                //    IsSelectAll = false;
                //    return;
                //}

                this.ScreenObject.GridDataObj.refreshDataView();
            }
            else {
                let BarcodeExists: boolean = false;
                let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 55489);
                if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                    let rowstoremove: any[] = this.ScreenObject.GridData.filter(x => x.RefNo = sender.Name);
                    for (let i = 0; i < rowstoremove.length; i++) {
                        let item = rowstoremove[i]
                        if (!Util.IsEmpty(item[dvCnt[0]["SysColumnName"]]) && !Util.IsEmpty(item["DocDetailsID"]) && parseInt(item["DocDetailsID"]) > 0) {
                            BarcodeExists = true;
                            break;
                        }
                    }
                }
                this.res = "No";
                if (confirm("Do you want to unlink " + sender.Name + "? (Y/N)" + ((BarcodeExists) ? "\n Barcodes will also be removed." : "")))
                    this.res = 'Yes';

                if (this.res != "Yes") {
                    this.IsSelectAll = true;
                    sender.IsChecked = true;
                    this.IsSelectAll = false;
                    return;
                }
                if (this.ScreenObject.Link.LinkCombo.SelectedItem != null && (this.ScreenObject.Link.LinkCombo.SelectedItem.Parent == "158" || this.ScreenObject.Link.LinkCombo.SelectedItem.Parent == "76")) {
                    if (this.ScreenObject.GridDataColumns.Contains("jobID")) {
                        let rowstoremove: any[] = this.ScreenObject.GridData.filter(x => x.jobID == sender.Value);
                        rowstoremove.forEach(item => {
                            if (this.AutoPostViewModel != null) {
                                let roremove = this.AutoPostViewModel.ScreenObject.GridData.filter(x => x.RefSeqNo == item["RefSeqNo"]);
                                roremove.forEach(citem => {
                                    this.AutoPostViewModel.ScreenObject.GridDataObj.removeRow(citem);
                                });
                                this.AutoPostViewModel.CalculateTotals(null, false);
                            }
                            this.ScreenObject.GridDataObj.removeRow(item);
                        });
                    }
                }
                else {
                    let rowstoremove = this.ScreenObject.GridData.filter(x => x.RefNo == sender.Name);
                    rowstoremove.forEach(item => {
                        if (this.AutoPostViewModel != null) {
                            let roremove = this.AutoPostViewModel.ScreenObject.GridData.filter(x => x.RefSeqNo == item["RefSeqNo"]);
                            roremove.forEach(citem => {
                                this.AutoPostViewModel.ScreenObject.GridDataObj.removeRow(citem);
                            });
                            this.AutoPostViewModel.CalculateTotals(null, false);
                        }
                        if (this.ScreenObject.GridDataColumns.Contains("MaxSchemeID") && !Util.IsEmpty(item["MaxSchemeID"])) {
                            let drschemes = this.ScreenObject.GridData.filter(x => x["MaxSchemeID"] == item["MaxSchemeID"].toString() && x.IsScheme == 'Y');
                            drschemes.forEach((ddel) => {
                                this.ScreenObject.GridData.Remove(ddel);
                            });
                        }
                        this.CheckPackingWtVol(item);
                        this.ScreenObject.GridDataObj.removeRow(item);
                    });

                    if (this.ScreenObject.Preferences.ContainsKey("DocQtyAdjustment") && this.ScreenObject.Preferences["DocQtyAdjustment"] != "" && parseBoolean(this.ScreenObject.Preferences["DocQtyAdjustment"])) {
                        let objFifo = new FieldCalculatorViewModel(this, -1);
                        objFifo.DelinkDocQtyAdjustment(sender.Name);
                    }

                    if (this.ScreenObject.Preferences.ContainsKey("LinkAttachments") && this.ScreenObject.Preferences["LinkAttachments"] != "" && parseBoolean(this.ScreenObject.Preferences["LinkAttachments"])) {
                        let files = this.ViewAttachments.AttachmentsList.filter(x => !Util.IsEmpty(x.RefNo) && x.RefNo == sender.Name);
                        if (files.length > 0) {
                            files.forEach(att => {
                                this.ViewAttachments.AttachmentsListObj.removeRow(att);
                            });
                        }
                    }
                }
                this.CalculateTotals(null, false);
            }
            this.ScreenObject.UpdateSequence();
            this.CheckVendorWiseLinkingPref();
        }
        Logger.InfoLog("AddEditDocumentViewModel::Exiting OnLinkDocumentCheckedChanged");
    }

    CheckPackingWtVol(dr: any) {

        if (this.ScreenObject.GridDataColumns.Contains("PackXML") && !Util.IsEmpty(dr["PackXML"])) {
            let xDoc = new XmlDocument();
            xDoc.LoadXml(dr["PackXML"]);
            let xList = xDoc.SelectNodes("DocExtraXML/Row");
            let invIDs = "";
            for (let i = 0; i < xList.length; i++) {
                if (xList[i].attributes["Label"] != null && !Util.IsEmpty(xList[i].attributes["Label"].value)
                    && xList[i].attributes["RefID"] != null && !Util.IsEmpty(xList[i].attributes["RefID"].value)) {
                    let drqt = this.DtPack.filter(x => x.Label == xList[i].attributes["Label"].value);
                    let tmpdbl = 0;
                    if (drqt.length > 0 && xList[i].attributes["Qty"] != null && !Util.IsEmpty(xList[i].attributes["Qty"].value)) {
                        if (Util.IsNum(xList[i].attributes["Weight"].value)) {
                            tmpdbl = parseFloat(xList[i].attributes["Weight"].value) * parseFloat(xList[i].attributes["Qty"].value);
                            if (!Util.IsEmpty(drqt[0]["cWeight"]))
                                drqt[0]["cWeight"] = parseFloat(drqt[0]["cWeight"]) - tmpdbl;
                        }

                        if (Util.IsNum(xList[i].attributes["Volume"].value)) {
                            tmpdbl = parseFloat(xList[i].attributes["Volume"].value) * parseFloat(xList[i].attributes["Qty"].value);
                            if (!Util.IsEmpty(drqt[0]["cVolume"]))
                                drqt[0]["cVolume"] = parseFloat(drqt[0]["cVolume"]) - tmpdbl;
                        }
                    }
                }
            }
        }
    }


    CheckVendorWiseLinkingPref() {
        if (this.ScreenObject.DocumentType == 6 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 39) {
            if (this.ScreenObject.Preferences.ContainsKey("Debit Account") && parseBoolean(this.ScreenObject.Preferences["Debit Account"]) && this.ScreenObject.DebitAccount != null) {
                if (this.ScreenObject.DebitAccount.SelectedValue > 0 && this.ScreenObject.GridData.filter(x => x.LinkedInvDocDetailsID > 0).length > 0)
                    this.ScreenObject.DebitAccount.Enable = false;
                else
                    this.ScreenObject.DebitAccount.Enable = true;
            }
            else if (this.ScreenObject.DebitAccount != null)
                this.ScreenObject.DebitAccount.Enable = true;
            if (this.ScreenObject.Preferences.ContainsKey("Credit Account") && parseBoolean(this.ScreenObject.Preferences["Credit Account"]) && this.ScreenObject.CreditAccount != null) {
                if (this.ScreenObject.CreditAccount.SelectedValue > 0 && this.ScreenObject.GridData.filter(x => x.LinkedInvDocDetailsID > 0).length > 0)
                    this.ScreenObject.CreditAccount.Enable = false;
                else
                    this.ScreenObject.CreditAccount.Enable = true;
            }
            else if (this.ScreenObject.CreditAccount != null)
                this.ScreenObject.CreditAccount.Enable = true;
        }
        else {
            if (this.ScreenObject.Preferences.ContainsKey("Debit Account") && parseBoolean(this.ScreenObject.Preferences["Debit Account"]) && this.ScreenObject.DebitAccount != null) {
                if (this.ScreenObject.DebitAccount.SelectedValue > 0 && this.ScreenObject.GridData.filter(x => x.LinkedInvDocDetailsID > 0).length > 0)
                    this.ScreenObject.DebitAccount.Enable = false;
                else
                    this.ScreenObject.DebitAccount.Enable = true;
            }
            else if (this.ScreenObject.DebitAccount != null)
                this.ScreenObject.DebitAccount.Enable = true;
            if (this.ScreenObject.Preferences.ContainsKey("Credit Account") && parseBoolean(this.ScreenObject.Preferences["Credit Account"]) && this.ScreenObject.CreditAccount != null) {
                if (this.ScreenObject.CreditAccount.SelectedValue > 0 && this.ScreenObject.GridData.filter(x => x.LinkedInvDocDetailsID > 0).length > 0)
                    this.ScreenObject.CreditAccount.Enable = false;
                else
                    this.ScreenObject.CreditAccount.Enable = true;
            }
            else if (this.ScreenObject.CreditAccount != null)
                this.ScreenObject.CreditAccount.Enable = true;
        }

        if (this.ScreenObject.Preferences.ContainsKey("DimensionWise") && this.ScreenObject.Preferences["DimensionWise"] != "") {
            let ccids = this.ScreenObject.Preferences["DimensionWise"].split(',');
            ccids.forEach(item => {
                if (item != "") {
                    let ccid = parseInt(item);
                    if (this.ScreenObject.Data.Tables[8].filter(x => x["CCID"] == ccid).length > 0)
                        return;
                    for (let m = 0; m < this.ScreenObject._CCFields.length; m++) {
                        let cc = this.ScreenObject._CCFields[m]
                        if (cc instanceof PactListBoxData && cc.CCID == ccid) {
                            if (cc.SelectedValue > 0 && this.ScreenObject.GridData.filter(x => x.LinkedInvDocDetailsID > 0).length > 0)
                                cc.Enable = false;
                            else
                                cc.Enable = true;
                            break;
                        }
                    }
                }
            });
        }
    }

    OLinkSelectionChanged(sender: string) {
        if (this.ScreenObject.Link.LinkCombo.SelectedValue != "") {
            this.ScreenObject.Link.DocumentList.Visible = true;
            this.ScreenObject.Link.VouchersList = null;
            let linkds: any;
            if (this.ScreenObject.DueDate != null && this.ScreenObject.DueDate.Date)
                linkds = this.ScreenObject.GetLinkDetails(parseInt(this.ScreenObject.Link.LinkCombo.SelectedValue), this.ScreenObject.DocDate.Date.ToString("dd/MMM/yyyy"), this.ScreenObject.DueDate.Date.ToString("dd/MMM/yyyy"));
            else
                linkds = this.ScreenObject.GetLinkDetails(parseInt(this.ScreenObject.Link.LinkCombo.SelectedValue), this.ScreenObject.DocDate.Date.ToString("dd/MMM/yyyy"), "");
            if (linkds.Tables.length > 0 && linkds.Columns[0].Contains("voucherno")) {
                this.ScreenObject.Link.VouchersList = linkds.Tables[0];
                this.ScreenObject.FillPendingList(true);
            }
        }
        else
            this.ScreenObject.Link.DocumentList.Visible = false;
    }
    GetReserveAccount(): string {
        switch (this.ScreenObject.DocumentType) {
            case 16:
                return BaseService.SessionManager.ReservedOPAccount.toString();
            case 17:
                return BaseService.SessionManager.ReservedJVAccount.toString();
            case 28:
                return BaseService.SessionManager.ReservedCNAccount.toString();
            case 29:
                return BaseService.SessionManager.ReservedDNAccount.toString();
        }
        return "";
    }

    ValidateHeaderSave(): boolean {
        for (let i = 0; i < this.ScreenObject._TextFields.length; i++) {
            let item = this.ScreenObject._TextFields[i];
            if ((item instanceof PactTextBoxData || item instanceof PactComboBoxData || item instanceof PactListBoxData || item instanceof PactHistoryData || item instanceof PactSelectionBoxData || item instanceof PactExtraFieldDateData) && !this.ValidateDataonSave_Ctrl(item))
                return false;
        }
        for (let i = 0; i < this.ScreenObject.HeaderFields.length; i++) {
            let item = this.ScreenObject.HeaderFields[i];
            if (item instanceof PactControlData && !Util.IsEmpty(item.Lbl) && this.fldDict.ContainsKey(item.Lbl)) {
                if (!this.ValidateDataonSave_Ctrl(item))
                    return false;
            }
        }
        for (let i = 0; i < this.ScreenObject._CCFields.length; i++) {
            let item = this.ScreenObject._CCFields[i];
            if (this.fldDict.ContainsKey(item.Lbl)) {
                if ((item instanceof PactListBoxData || item instanceof PactCodeNameListBoxData || item instanceof PactHistoryData) && !this.ValidateDataonSave_Ctrl(item))
                    return false;
            }
        }

        return this.ValidateDataonSave();
    }

    GetCurrencyID(i: number): number {
        let CurrID = 1;
        if (this.Currency && !Util.IsEmpty(this.Currency.Currency.SelectedValue))
            CurrID = parseInt(this.Currency.Currency.SelectedValue);
        else if (this.ScreenObject.GridDataColumns.Contains("CurrencyID") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CurrencyID_Key"]))
            CurrID = parseInt(this.ScreenObject.GridData[i]["CurrencyID_Key"]);
        return CurrID;
    }

    GetExchRate(i: number): number {
        let ExhgRate = 1;
        if (this.Currency && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
            ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
        else if (this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ExchangeRate"]))
            ExhgRate = parseFloat(this.ScreenObject.GridData[i]["ExchangeRate"]);
        return ExhgRate;
    }
    public GetPrimaryColName() {
        if (this.IsInventoryVoucher)
            return "ProductID_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key"))
            return "CreditAccount_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key"))
            return "DebitAccount_Key";
        else if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key"))
            return "AccountID_Key";
        return "";
    }

    MandaotryValidation(i: number, j: number): boolean {
        if (this.ScreenObject.ColumnSource[j].CostCenterID != 0 && (!Util.IsEmpty(this.ScreenObject.ColumnSource[j].ValueMember) && Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) || parseInt(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) < 1)) {
            this.DisplayMessage = BaseService.GetResource("Doc_Select") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
            return false;
        }
        else if (this.ScreenObject.ColumnSource[j].DataType == "SELECTIONBOX" && Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember])) {
            this.DisplayMessage = BaseService.GetResource("Doc_Select") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
            return false;
        }
        else if (this.ScreenObject.ColumnSource[j].DataType == "ComboBox" && Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding])) {
            this.DisplayMessage = BaseService.GetResource("Doc_Select") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
            return false;
        }
        else if (this.ScreenObject.ColumnSource[j].DataType == "PactComboBox" && Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding + "_Key"])) {
            this.DisplayMessage = BaseService.GetResource("Doc_Select") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
            return false;
        }
        else if (this.ScreenObject.ColumnSource[j].DataType == "LISTBOX" && Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember])) {
            this.DisplayMessage = BaseService.GetResource("Doc_Select") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();

            return false;
        }
        else if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "debitamount" || this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "creditamount") {
            if ((Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAmount"]) && Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAmount"])) ||
                ((!Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAmount"]) && parseFloat(this.ScreenObject.GridData[i]["DebitAmount"]) == 0)
                    && (!Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAmount"]) && parseFloat(this.ScreenObject.GridData[i]["CreditAmount"]) == 0))) {
                this.DisplayMessage = BaseService.GetResource("Doc_Enter") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                return false;
            }
        }
        else if (this.ScreenObject.ColumnSource[j].DataType != "LISTBOX" && this.ScreenObject.ColumnSource[j].DataType != "PactComboBox" && this.ScreenObject.ColumnSource[j].DataType != "ComboBox" &&
            (Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) ||
                (this.ScreenObject.ColumnSource[j].DataType == "FLOAT" && !Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) &&
                    parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) == 0))) {
            this.DisplayMessage = BaseService.GetResource("Doc_Enter") + this.ScreenObject.ColumnSource[j].Header + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
            return false;
        }
        return true;
    }
    /// <summary>
    /// Saves the accounting document.  This method is invoked by the SaveCommand.
    /// </summary>
    SaveAccountingDocument(sender: any) {
        this.IgnoreOnSave.Clear();
        if (!this.ButtonsEnabled)
            return;
        if (this.ScreenObject.DocID > 0 && this.IsUserLock) {
            this.DisplayMessage = "Document is Locked";
            return;
        }
        this.ButtonsEnabled = false;
        if (!this.SaveAccountingDocument_Validate(sender, true))
            this.ButtonsEnabled = true;
    }
    SaveAccountingDocument_Validate(sender: any, validate: boolean): boolean {
        if ((sender != null && sender.toString() != "Approve" && sender.toString() != "ApproveandPrint" && sender.toString() != "NoWorkFlow" && sender.toString() != "NoWorkFlowprint") && !(this.ButtonRevise.Visible && sender.toString() == "Revise") && (!this.ButtonSave.Visible || !this.ButtonSave.Enable))
            return false;

        if (this.ScreenObject.Preferences.ContainsKey("NoWorkflowPostedDocs") && this.ScreenObject.Preferences["NoWorkflowPostedDocs"] != "" && parseBoolean(this.ScreenObject.Preferences["NoWorkflowPostedDocs"])
            && this.StatusID == 369 && sender.toString() == "Save")
            sender = "NoWorkFlow";

        if (this.ScreenObject.RefNodeID != 0 && this.StatusID == 429) {
            this.DisplayMessage = BaseService.GetResource("RefDocument");
            return false;
        }

        if (this.ScreenObject.RefNodeID != 0 && !(this.ScreenObject.RefCCId == 86 || this.ScreenObject.RefCCId == 73 || this.ScreenObject.RefCCId == 89 || this.ScreenObject.IsRefLCTR || BaseService.SessionManager.IsActionAssigned(43, "Edit Reference Documents") || BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Reference Documents"))) {
            this.DisplayMessage = BaseService.GetResource("RefDocument");
            return false;
        }
        if (this.ScreenObject.Preferences.ContainsKey("LineWisePDC") && this.ScreenObject.Preferences["LineWisePDC"] != "" && parseBoolean(this.ScreenObject.Preferences["LineWisePDC"]) && this.PDCSCleared) {
            this.DisplayMessage = "One or more pdc converted document can not be edited";
            return false;
        }

        if (validate && this.ScreenObject.Preferences.ContainsKey("MadatoryAttachments") && this.ScreenObject.Preferences["MadatoryAttachments"] != "" && parseBoolean(this.ScreenObject.Preferences["MadatoryAttachments"])
            && (this.ViewAttachments == null || this.ViewAttachments.AttachmentsList.length == 0)) {
            this.DisplayMessage = "No Attachments added.";
            return false;
        }

        if (this.ScreenObject.IsBouncedorPdcPosted && !(this.ScreenObject.Preferences.ContainsKey("LineWisePDC") && this.ScreenObject.Preferences["LineWisePDC"] != "" && parseBoolean(this.ScreenObject.Preferences["LineWisePDC"]))) {
            this.DisplayMessage = this.ScreenObject.BouncedorPdcMessage;
            return false;
        }

        if (this.StatusID == 439) {
            this.DisplayMessage = "Discounted PDC can not be changed";
            return false;
        }
        Logger.InfoLog("AddEditDocumentViewModel::Entering SaveInventoryDocument");
        try {

            //foreach (DataRow dr in this.ScreenObject.GridData)
            //{
            //    if (int.Parse(dr["DocDEtailsID"]) > 0)
            //    {
            //        if (dr["ChequeNumber"] != null)
            //        {
            //            if (dr["ChequeNumber"].toString().trim() == "" || dr["ChequeDate"].toString().trim() == "" || dr["ChequeBankName"].toString().trim() == "")
            //            {
            //                ShellWindowViewModel.Instance().PopViewModel = new MessageDialogViewModel("Can't Leave  Cheque Date,Cheque Bank Name,Cheque Number Empty at row Number "+dr["DocSeqNo"].toString().trim(), "OK");

            //                return false;
            //            }
            //        }
            //    }
            //    return false; 
            //}

            let DonotUpdateAccounts = true;
            if (this.ScreenObject.Preferences.ContainsKey("DonotupdateAccounts")) {
                if (this.ScreenObject.Preferences["DonotupdateAccounts"] != "")
                    DonotUpdateAccounts = parseBoolean(this.ScreenObject.Preferences["DonotupdateAccounts"]);
            }
            let ReservedAccount = this.GetReserveAccount();

            let TotalDebitAmout = 0, TotalCreditAmout = 0, TotalBillWiseAmout = 0;
            let BillWiseAccount = 0;
            let isCredit = false;

            this.FillHeaderDictionary();

            if (validate && !this.ValidateHeaderSave())
                return false;

            if (validate)
                this.FillCreatedByDate(sender.toString());

            let outmess = { message: "" }
            let Footer: string = this.ScreenObject.GenerateQuery(outmess, false, this.DocumentDate, true);
            if (outmess.message != "") {
                this.DisplayMessage = outmess.message;
                return false;
            }

            if (!this.BodyVisible || this.ReadOnlyBody)
                this.CheckEmptyGrid();

            let sbRows = "";
            let sbAccounts = "";
            let sbStatic: string, sbNumeric: string, sbText: string, sbCC: string;
            let RowCount = 0;
            sbRows += "<DocumentXML";
            if (sender != null && sender == "Revise") {
                sbRows += " IsRevision=\"1\"";
                sbRows += " ReviseReason=\"" + this.ReviseReason + "\"";
            }
            sbRows += ">";

            let AccColName = this.GetPrimaryColName();

            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (Util.IsEmpty(this.ScreenObject.GridData[i][AccColName])) {
                    if (validate && !this.ScreenObject.GridDataColumns.Contains("FieldType")) {
                        let c;
                        for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                            c = this.ScreenObject.ColumnSource[j];
                            if (c.IsVisible && c.DisplayMember != "DocSeqNo") {
                                if (((c.DataType == "INT" || c.DataType == "FLOAT") && Util.Double(this.ScreenObject.GridData[i][c.DisplayMember]) != 0)
                                    || (c.DataType == "LISTBOX" && Util.Int(this.ScreenObject.GridData[i][c.ValueMember]) > 0)
                                    || ((c.DataType == "SELECTIONBOX" || c.DataType == "String" || c.DataType == "TextBlock" || c.DataType == "TEXT") && !Util.IsEmpty(this.ScreenObject.GridData[i][c.DisplayMember]))
                                    || ((c.DataType == "DATE" || c.DataType == "DATETIME") && !Util.IsEmpty(this.ScreenObject.GridData[i][c.DisplayMember + "_Key"]))) {
                                    this.DisplayMessage = "Account not selected at row no." + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                    return false;
                                }
                            }
                        }
                    }
                    continue;
                }

                RowCount++;

                sbAccounts = "";
                sbRows += "<Row>";
                sbAccounts += "<AccountsXML>";
                sbStatic = "";
                sbNumeric = "";
                sbText = "";
                sbCC = "";

                sbStatic += "<Transactions ";

                sbNumeric += "<Numeric Query=\"";
                sbCC += "<CostCenters Query=\"";
                sbText += "<Alpha Query=\"";

                //string strIndex = "";
                for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                    let CurrID: number = this.GetCurrencyID(i);
                    let ExhgRate: number = this.GetExchRate(i);

                    if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("exchangerate") || this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("currencyid")
                        || (this.ScreenObject.ColumnSource[j].CostCenterID > 0 && this.ScreenObject.ColumnSource[j].DisplayMember.endsWith("Code")))
                        continue;
                    if (this.ScreenObject.ColumnSource[j].Mandatory) {
                        if (!this.MandaotryValidation(i, j))
                            return false;
                    }

                    this.DisplayMessage = this.ValidateMinMax(this.ScreenObject.ColumnSource[j], this.ScreenObject.GridData[i]);
                    if (this.DisplayMessage.ToString() != "") {
                        this.MessageVisibility = true;
                        return false;
                    }

                    if (!this.ValidateDataonSave_col_dr(this.ScreenObject.ColumnSource[j], this.ScreenObject.GridData[i]))
                        return false;

                    if (this.ScreenObject.ColumnSource[j].IsColumnUserDefined) {
                        if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dccurrid") || this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcexchrt"))
                            continue;
                        if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcnum")) {
                            if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                                let IsCrDimCUrr = false;
                                let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 50403);
                                if (dvCnt.length > 0 && this.ScreenObject.ColumnSource[j].DisplayMember == dvCnt[0]["SysColumnName"]) {
                                    let crossDim = 0, ccid = 0;
                                    ccid = Util.Int(BaseService.SessionManager.Preferences["DimensionwiseCurrency"])
                                    if (ccid > 50000) {
                                        if (this.ScreenObject.Preferences.ContainsKey("UseasCrossDimension") && this.ScreenObject.Preferences["UseasCrossDimension"].toLowerCase() == "true" && BaseService.SessionManager.Preferences.ContainsKey("CrossDimension") && BaseService.SessionManager.Preferences["CrossDimension"].toString() != ""
                                            && Util.IsNum(BaseService.SessionManager.Preferences["CrossDimension"]))
                                            crossDim = parseInt(BaseService.SessionManager.Preferences["CrossDimension"]);

                                        if (crossDim == ccid) {
                                            IsCrDimCUrr = true;
                                            if (this.ScreenObject.Preferences.ContainsKey("CrossDimField") && Util.IsNum(this.ScreenObject.Preferences["CrossDimField"])) {
                                                let ccfld = this.ScreenObject._TextFields.find(a => a.DBColumnID == parseInt(this.ScreenObject.Preferences["CrossDimField"]));
                                                if (ccfld && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0) {
                                                    CurrID = this.ScreenObject.GetCurrency(ccfld.SelectedValue, ccfld.CCID);
                                                    ExhgRate = 1;
                                                }
                                            }
                                        }
                                    }
                                }

                                if (!IsCrDimCUrr) {
                                    if (this.ScreenObject.ColumnSource[j].DefaultValue == "-2") {
                                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCurrID" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "") + "_Key"]))
                                            CurrID = parseInt(this.ScreenObject.GridData[i]["dcCurrID" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "") + "_Key"]);
                                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcExchRT" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "")]))
                                            ExhgRate = parseFloat(this.ScreenObject.GridData[i]["dcExchRT" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "")]);
                                    }
                                    else {
                                        let def = Util.Int(this.ScreenObject.ColumnSource[j].DefaultValue);
                                        if (def > 0 && this.ScreenObject.ColumnSource[j].CurrID > 0) {
                                            CurrID = this.ScreenObject.ColumnSource[j].CurrID;
                                            ExhgRate = this.ScreenObject.ColumnSource[j].ExhcgRt;
                                        }
                                    }
                                }
                            }

                            let tempval = 0;

                            if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]))
                                sbNumeric += this.ScreenObject.ColumnSource[j].DisplayMember + "=" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString() + ", ";
                            else
                                sbNumeric += this.ScreenObject.ColumnSource[j].DisplayMember + "=0, ";

                            tempval = Util.Double(this.ScreenObject.GridData[i]["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember]);
                            if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                                sbNumeric += "dcCurrID" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "") + "=" + CurrID + ", ";
                                sbNumeric += "dcExchRT" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "") + "=" + ExhgRate + ", ";
                                sbNumeric += "dcCalcNumFC" + this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().replace("dcnum", "") + "=" + tempval + ", ";
                            }
                            sbNumeric += "dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember.replace("dc", "") + "=" + tempval * ExhgRate + ", ";

                            let PostingValue = "";
                            if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcnum") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember]))
                                PostingValue = this.ScreenObject.GridData[i]["dcCalc" + this.ScreenObject.ColumnSource[j].DisplayMember].toString();
                            if ((this.ScreenObject.ColumnSource[j].PostingType == 3 || this.ScreenObject.ColumnSource[j].PostingType == 4) && PostingValue != "" && Util.IsNum(PostingValue) && parseFloat(PostingValue) != 0) {
                                let DBAcc = 0, CrACC = 0;
                                let PostingXml = "";
                                let outObj = { DBAcc: DBAcc, CrACC: CrACC, PostingXml: PostingXml }
                                if (!this.FillAccountPosting(this.ScreenObject.ColumnSource[j], this.ScreenObject.GridData[i], PostingValue, CurrID, ExhgRate,
                                    outObj, (ReservedAccount != "") ? parseInt(ReservedAccount) : 0)) {
                                    return false;
                                }
                                DBAcc = outObj.DBAcc;
                                CrACC = outObj.CrACC;
                                PostingXml = outObj.PostingXml
                                if (this.ScreenObject.DocumentType == 16 || this.ScreenObject.DocumentType == 17 || this.ScreenObject.DocumentType == 28 || this.ScreenObject.DocumentType == 29) {
                                    if (CrACC == parseInt(ReservedAccount) && DBAcc > 0)
                                        TotalDebitAmout += parseFloat(PostingValue) * ExhgRate;
                                    else if (DBAcc == parseInt(ReservedAccount) && CrACC > 0)
                                        TotalCreditAmout += parseFloat(PostingValue) * ExhgRate;
                                }
                                sbAccounts += PostingXml;
                            }
                        }
                        else if (this.ScreenObject.ColumnSource[j].DisplayMember == "Name" || this.ScreenObject.ColumnSource[j].DisplayMember == "Year" || this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("dcalpha")) {
                            let refObj = { sbText: sbText }
                            this.GetRowValue(refObj, i, j);
                            sbText = refObj.sbText
                        }
                        else if (this.ScreenObject.ColumnSource[j].CostCenterID != 0) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) && parseInt(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) > 0) {
                                if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "batchid")
                                    sbStatic += "BatchID=\"" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember].toString() + "\" ";
                                else
                                    sbCC += this.ScreenObject.ColumnSource[j].DisplayMember + "=" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember].toString() + ", ";
                            }
                            else {
                                if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase() == "batchid")
                                    sbStatic += "BatchID=\"1\" ";
                                else
                                    sbCC += this.ScreenObject.ColumnSource[j].DisplayMember + "=1, ";
                            }
                        }
                        else
                            sbText += this.ScreenObject.ColumnSource[j].DisplayMember + "=N'" + PactTextBoxData.GetValidTextXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString()) + "', ";

                    }
                    else {
                        if ((this.ScreenObject.DocumentType == 16 || this.ScreenObject.DocumentType == 17 || this.ScreenObject.DocumentType == 28 || this.ScreenObject.DocumentType == 29)
                            && (this.ScreenObject.ColumnSource[j].ValueMember == "AccountID_Key" || this.ScreenObject.ColumnSource[j].DisplayMember == "DebitAmount" || this.ScreenObject.ColumnSource[j].DisplayMember == "CreditAmount")) {
                            if (this.ScreenObject.ColumnSource[j].ValueMember == "AccountID_Key") {
                                if (Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"])) {
                                    this.DisplayMessage = this.ScreenObject.DebitAccount.Label + "Required";
                                    return false;
                                }
                                continue;
                            }
                            else if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) && this.ScreenObject.ColumnSource[j].DisplayMember == "CreditAmount" && parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) != 0) {
                                sbStatic += this.ScreenObject.GetAccountTransaction(ReservedAccount, this.ScreenObject.GridData[i]["AccountID_Key"].toString(), this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString(), CurrID, ExhgRate, this.ScreenObject.ColumnSource[j].DecimalPoints);
                                TotalCreditAmout += parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) * ExhgRate;
                            }
                            else if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) && this.ScreenObject.ColumnSource[j].DisplayMember == "DebitAmount" && parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) != 0) {
                                sbStatic += this.ScreenObject.GetAccountTransaction(this.ScreenObject.GridData[i]["AccountID_Key"].toString(), ReservedAccount, this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString(), CurrID, ExhgRate, this.ScreenObject.ColumnSource[j].DecimalPoints);
                                TotalDebitAmout += parseFloat(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) * ExhgRate;
                            }
                        }
                        else if (this.ScreenObject.ColumnSource[j].ValueMember == "DebitAccount_Key" || this.ScreenObject.ColumnSource[j].ValueMember == "CreditAccount_Key") {
                            continue;
                        }
                        else if (this.ScreenObject.ColumnSource[j].DataType == "SELECTIONBOX") {
                            sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember].toString() + "\" ";

                        }
                        else if (this.ScreenObject.ColumnSource[j].DisplayMember == "Amount") {
                            let DBAcc = "", CrACC = "";
                            if (this.ScreenObject.DebitAccount != null)
                                DBAcc = this.ScreenObject.DebitAccount.SelectedValue.toString();
                            else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                                DBAcc = this.ScreenObject.GridData[i]["DebitAccount_Key"].toString();

                            if (this.ScreenObject.CreditAccount != null)
                                CrACC = this.ScreenObject.CreditAccount.SelectedValue.toString();
                            else if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                                CrACC = this.ScreenObject.GridData[i]["CreditAccount_Key"].toString();

                            if (sender != null && sender.toString() == "Bounce")
                                sbStatic += this.ScreenObject.GetAccountTransaction(CrACC, DBAcc, Util.String(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]), CurrID, ExhgRate, this.ScreenObject.ColumnSource[j].DecimalPoints);
                            else
                                sbStatic += this.ScreenObject.GetAccountTransaction(DBAcc, CrACC, Util.String(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]), CurrID, ExhgRate, this.ScreenObject.ColumnSource[j].DecimalPoints);
                        }
                        else if (this.ScreenObject.ColumnSource[j].CostCenterID != 0) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) && parseInt(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember]) > 0)
                                sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueMember].toString() + "\" ";
                        }
                        else {
                            if (this.ScreenObject.ColumnSource[j].DataType == "DATE") {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]))
                                    sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("dd/MMM/yyyy") + "\" ";

                            }
                            else if (this.ScreenObject.ColumnSource[j].DataType.toLowerCase() == "datetime" || this.ScreenObject.ColumnSource[j].DataType.toLowerCase() == "time") {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]))
                                    sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember + "_Key"]).ToString("dd/MMM/yyyy hh:mm:ss a") + "\" ";//tt") + "\" ";
                            }
                            else if (this.ScreenObject.ColumnSource[j].DataType == "ComboBox") {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding]))
                                    sbStatic += this.ScreenObject.ColumnSource[j].ValueBinding + "=\"" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].ValueBinding].toString() + "\" ";
                            }
                            else if (this.ScreenObject.ColumnSource[j].DisplayMember == "DocSeqNo")
                                sbStatic += "DocSeqNo=\"" + RowCount + "\" ";
                            else {
                                if (sender != null && sender.toString() == "Bounce")
                                    sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + "0" + "\" ";
                                else
                                    sbStatic += this.ScreenObject.ColumnSource[j].DisplayMember + "=\"" + PactTextBoxData.GetValidXml(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[j].DisplayMember]) + "\" ";
                            }
                        }
                    }
                }

                //#region Commented

                //if (this.ScreenObject.GridDataColumns.Contains("DebitAmount"))
                //{
                //    if (this.ScreenObject.GridData[i]["DebitAmount"] != null)
                //    {
                //        dblAmt = parseFloat(this.ScreenObject.GridData[i]["DebitAmount"]);
                //        if (dblAmt > 0)
                //        {
                //            sbStatic+=" Amount=\""+dblAmt+"\" ";
                //        }
                //        else if (dblAmt < 0)
                //        {
                //            sbStatic+=" Amount=\""+dblAmt+"\" ";
                //        }
                //    }
                //}
                //if (this.ScreenObject.GridDataColumns.Contains("CreditAmount"))
                //{
                //    if (this.ScreenObject.GridData[i]["CreditAmount"] != null)
                //    {
                //        dblAmt = parseFloat(this.ScreenObject.GridData[i]["CreditAmount"]);
                //        if (dblAmt > 0)
                //        {
                //            sbStatic+=" Amount=\"-"+dblAmt+"\" ";
                //        }
                //        else if (dblAmt < 0)
                //        {
                //            sbStatic+=" Amount=\""+-dblAmt+"\" ";
                //        }
                //    }
                //}
                //    if (PGrid.CreditIndex != -1)
                //    {
                //        if (PGrid[i].Cells[PGrid.CreditIndex].Value != null && PGrid[i].Cells[PGrid.CreditIndex].Value.toString() != "")
                //        {
                //            Amt = parseFloat(PGrid[i].Cells[PGrid.CreditIndex].Value);
                //            if (Amt > 0)
                //            {
                //                TranXml+=" Amount=\"-"+Amt+"\"";
                //            }
                //            else if (Amt < 0)
                //            {
                //                TranXml+=" Amount=\""+-Amt+"\"";
                //            }
                //        }
                //    }

                //#endregion

                if (this.IsLockDimsLineWise) {
                    let outObj = { join: "" };
                    sbStatic += " LockDims=\"" + this.GetLockQuery(this.ScreenObject.GridData[i], outObj) + "\" ";
                    if (outObj.join != "")
                        sbStatic += " LockDimsjoin=\"" + outObj.join + "\" ";
                }
                if (this.GetButton("Pre Payments") != null && this.pdcGCVM != null && this.pdcGCVM.IsDataSaved && RowCount == 1) {
                    if (!this.pdcGCVM.Validate(this.ScreenObject.GridData[i]["Amount"].toString()))
                        return false;

                    sbStatic += " Description=\"" + this.pdcGCVM.GetXML() + "\" ";
                }

                if (this.ScreenObject.GridDataColumns.Contains("oppdc") && !Util.IsEmpty(this.ScreenObject.GridData[i]["oppdc"]))
                    sbStatic += " PostPDC=\"1\" ";

                if (this.ScreenObject.GridDataColumns.Contains("FieldType"))
                    sbNumeric += this.GetpayModesNumericData(i);

                sbStatic += this.ScreenObject.strStaticFields + " ></Transactions>";
                sbNumeric += this.ScreenObject.strnumericFields + "\" ></Numeric>";
                sbText += this.ScreenObject.strTextFields + "\" ></Alpha>";

                if (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True" && !sbCC.toString().Contains("dcCCNID1=") && !this.ScreenObject.strCCFields.Contains("dcCCNID1=")) {
                    if (this.ScreenObject.DivisionID > 0)
                        sbCC += " dcCCNID1=" + this.ScreenObject.DivisionID.toString() + ", ";
                    else if (BaseService.SessionManager.DivisionID > 0)
                        sbCC += " dcCCNID1=" + BaseService.SessionManager.DivisionID.toString() + ", ";
                }
                if (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True" && !sbCC.toString().Contains("dcCCNID2=") && !this.ScreenObject.strCCFields.Contains("dcCCNID2=")) {
                    if (this.ScreenObject.LocationID > 0)
                        sbCC += " dcCCNID2=" + this.ScreenObject.LocationID.toString() + ", ";
                    else if (BaseService.SessionManager.LocationID > 0)
                        sbCC += " dcCCNID2=" + BaseService.SessionManager.LocationID.toString() + ", ";
                }
                if (BaseService.SessionManager.RegisterCCID > 0 && this.ScreenObject.RegisterNodeID > 0 && !sbCC.toString().Contains("dcCCNID" + (BaseService.SessionManager.RegisterCCID - 50000).toString() + "=") && !this.ScreenObject.strCCFields.Contains("dcCCNID" + (BaseService.SessionManager.RegisterCCID - 50000).toString() + "=")) {

                    if (this.ScreenObject.RegisterNodeID > 0) {
                        sbCC += " dcCCNID" + (BaseService.SessionManager.RegisterCCID - 50000).toString() + "=" + this.ScreenObject.RegisterNodeID.toString() + ", ";
                    }
                }

                sbCC += this.ScreenObject.strCCFields + "\" ></CostCenters>";
                sbAccounts += "</AccountsXML>";


                TotalBillWiseAmout = 0;
                BillWiseAccount = 0;
                let SkipBIllwise = false;
                let IsImpACCBillWise = false;
                if (this.ScreenObject.Preferences.ContainsKey("LineWisePDC") && parseBoolean(this.ScreenObject.Preferences["LineWisePDC"])
                    && this.ScreenObject.GridDataColumns.Contains("RefStatusID") && !Util.IsEmpty(this.ScreenObject.GridData[i]["RefStatusID"]) && parseInt(this.ScreenObject.GridData[i]["RefStatusID"]) != 370
                    && !Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"]) && parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) > 0) {
                    SkipBIllwise = true;
                }
                if (BaseService.SessionManager.Preferences.ContainsKey("On") && BaseService.SessionManager.Preferences["On"] != "True")
                    SkipBIllwise = true;

                if (this.ScreenObject.DocumentType == 16 && Util.IsEmpty(this.ScreenObject.GridData[i]["Type"]) && this.ImportVisiblity && !SkipBIllwise) {
                    if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"]) && parseInt(this.ScreenObject.GridData[i]["AccountID_Key"]) > 0) {
                        if (this.IsAccBillWise(parseInt(this.ScreenObject.GridData[i]["AccountID_Key"])))
                            IsImpACCBillWise = true;
                    }
                }

                // if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Type"]) && parseBoolean(this.ScreenObject.GridData[i]["Type"]) == true && !SkipBIllwise) {
                if ((!Util.IsEmpty(this.ScreenObject.GridData[i]["Type"]) && parseBoolean(this.ScreenObject.GridData[i]["Type"]) == true && !SkipBIllwise) || (!SkipBIllwise && IsImpACCBillWise)) {
                    let ColName = "";
                    if (this.ScreenObject.GridDataColumns.Contains("Amount"))
                        ColName = "Amount";

                    if (this.ScreenObject.DocumentType == 18 || this.ScreenObject.DocumentType == 19 || this.ScreenObject.DocumentType == 21 || this.ScreenObject.DocumentType == 22) {
                        if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"])) {
                            BillWiseAccount = parseInt(this.ScreenObject.GridData[i]["CreditAccount_Key"]);
                            isCredit = true;
                        }
                    }
                    else if (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 15 || this.ScreenObject.DocumentType == 20 || this.ScreenObject.DocumentType == 23) {
                        if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"])) {
                            BillWiseAccount = parseInt(this.ScreenObject.GridData[i]["DebitAccount_Key"]);
                            isCredit = false;
                        }
                    }
                    else if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"])) {
                        BillWiseAccount = parseInt(this.ScreenObject.GridData[i]["AccountID_Key"]);

                        if (this.ScreenObject.GridDataColumns.Contains("CreditAmount") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAmount"])
                            && parseFloat(this.ScreenObject.GridData[i]["CreditAmount"]) > 0) {
                            isCredit = true;
                            ColName = "CreditAmount";
                        }
                        if (this.ScreenObject.GridDataColumns.Contains("DebitAmount") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAmount"])
                            && parseFloat(this.ScreenObject.GridData[i]["DebitAmount"]) > 0) {
                            ColName = "DebitAmount";
                            isCredit = false;
                        }
                    }

                    if (ColName != "" && Util.Double(this.ScreenObject.GridData[i][ColName]) != 0) {
                        if (parseFloat(this.ScreenObject.GridData[i][ColName]) < 0)
                            isCredit = !isCredit;

                        ;
                        let xDoc: XmlDocument = new XmlDocument();
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ExtraXML"]))
                            xDoc.LoadXml(this.ScreenObject.GridData[i]["ExtraXML"]);

                        let xList = xDoc.SelectNodes("/BillWise/Row");
                        let Localval = 0;
                        let Containsminus = false;
                        for (let x = 0; x < xList.length; x++) {
                            if (xList[x].attributes["AccountID"].value == "" || (xList[x].attributes["AccountID"].value != "" && parseInt(xList[x].attributes["AccountID"].value) != BillWiseAccount)) {
                                this.DisplayMessage = "Invalid BillWise Details at Row No." + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                return false;
                            }
                            //if (xList[x].attributes["AmountFC"].value != "")
                            //    val += parseFloat(xList[x].attributes["AmountFC"].value.replace("-", ""));
                            if (xList[x].attributes["AdjAmount"].value != "")
                                Localval += parseFloat(xList[x].attributes["AdjAmount"].value.replace("-", ""));
                            if (xList[x].attributes["AdjAmount"].value.Contains("-"))
                                Containsminus = true;
                            //if (xList[x].attributes["AmountFC"].value != "" && xList[x].attributes["IsNewReference"].value == "1")
                            //    NewRef = parseFloat(xList[x].attributes["AmountFC"].value.replace("-", ""));
                        }

                        xList = xDoc.SelectNodes("BillWise/Row/AccountsXML");
                        if (xList != null) {
                            for (let x = 0; x < xList.length; x++) {
                                if (xList[x].attributes["Amount"] != null && xList[x].attributes["Amount"].value != "") {
                                    if ((isCredit && xList[x].attributes["DebitAccount"] != null && xList[x].attributes["DebitAccount"].value != "" && parseInt(xList[x].attributes["DebitAccount"].value) == BillWiseAccount)
                                        || (!isCredit && xList[x].attributes["CreditAccount"] != null && xList[x].attributes["CreditAccount"].value != "" && parseInt(xList[x].attributes["CreditAccount"].value) == BillWiseAccount))
                                        Localval += parseFloat(xList[x].attributes["Amount"].value.replace("-", ""));
                                    else
                                        Localval -= parseFloat(xList[x].attributes["Amount"].value.replace("-", ""));
                                }
                            }
                        }


                        xDoc.LoadXml(sbAccounts);

                        xList = xDoc.SelectNodes("AccountsXML/Accounts");

                        let ExhgRate = this.GetExchRate(i);

                        if (this.ScreenObject.Preferences.ContainsKey("DecimalsBillWise") && this.ScreenObject.Preferences["DecimalsBillWise"] != ""
                            && Util.Int(this.ScreenObject.Preferences["DecimalsBillWise"]) > 0)
                            TotalBillWiseAmout = parseFloat((parseFloat(this.ScreenObject.GridData[i][ColName].toString().replace("-", "")) * ExhgRate).ToString("N" + this.ScreenObject.Preferences["DecimalsBillWise"]));
                        else if (BaseService.SessionManager.Preferences.ContainsKey("DecimalsinAmount"))
                            TotalBillWiseAmout = parseFloat((parseFloat(this.ScreenObject.GridData[i][ColName].toString().replace("-", "")) * ExhgRate).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));
                        else
                            TotalBillWiseAmout = parseFloat(this.ScreenObject.GridData[i][ColName].toString().replace("-", "")) * ExhgRate;

                        for (let x = 0; x < xList.length; x++) {
                            if (xList[x].attributes["DebitAccount"] != null && xList[x].attributes["DebitAccount"].value != ""
                                && parseInt(xList[x].attributes["DebitAccount"].value) == BillWiseAccount
                                && xList[x].attributes["Amount"] != null && xList[x].attributes["Amount"].value != "") {
                                if (isCredit)
                                    TotalBillWiseAmout -= parseFloat(xList[x].attributes["Amount"].value);
                                else
                                    TotalBillWiseAmout += parseFloat(xList[x].attributes["Amount"].value);
                            }
                            else if (xList[x].attributes["CreditAccount"] != null && xList[x].attributes["CreditAccount"].value != ""
                                && parseInt(xList[x].attributes["CreditAccount"].value) == BillWiseAccount
                                && xList[x].attributes["Amount"] != null && xList[x].attributes["Amount"].value != "") {
                                if (isCredit)
                                    TotalBillWiseAmout += parseFloat(xList[x].attributes["Amount"].value);
                                else
                                    TotalBillWiseAmout -= parseFloat(xList[x].attributes["Amount"].value);
                            }
                        }

                        if (!Util.IsEmpty(this.ScreenObject.GridData[i][ColName]) && Math.abs(TotalBillWiseAmout - Localval) > 0.5) {
                            this.DisplayMessage = BaseService.GetResource("Doc_BillWiseMisMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                            return false;
                        }

                        if ((isCredit && !Containsminus) || (!isCredit && Containsminus)) {
                            this.DisplayMessage = BaseService.GetResource("Doc_BillWiseMisMatch") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                            return false;
                        }

                        //if (AccColName != "" && parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) > 0)
                        //{

                        //    DataSet billwiseds = this.ScreenObject.GetBillWiseDetails(parseInt(this.ScreenObject.GridData[i][AccColName]), true, this.ScreenObject.VoucherNo, parseInt(this.ScreenObject.GridData[i]["DocSeqNo"]), this.ScreenObject.GridData[i], DocumentDate);

                        //    if (billwiseds.Tables.length > 1)
                        //    {
                        //        let Paidval = billwiseds.Tables[1].Compute("Sum(AdjAmount)", "");
                        //        if (Paidval != null)
                        //            Paidval = Paidval.toString().replace("-", "");

                        //        if (Paidval != null && parseFloat(Paidval) > NewRef)
                        //        {
                        //            DisplayMessage = BaseService.GetResource("Doc_BillWiseNewRef") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                        //            
                        //            return false;
                        //        }
                        //    }
                        //}
                    }
                    // else {
                    //     this.DisplayMessage = BaseService.GetResource("Doc_BillWiseNOTdEF") + " " + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                    //     return false;
                    // }
                }
                else {
                    this.ScreenObject.GridData[i]["ExtraXML"] = "";
                }

                if (this.ScreenObject.DocumentType == 18 || this.ScreenObject.DocumentType == 19 || this.ScreenObject.DocumentType == 21 || this.ScreenObject.DocumentType == 22) {
                    if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0) {
                        if (this.CheckAccountBalance(this.ScreenObject.DebitAccount.SelectedValue, this.GridNetTotal, false)) {
                            return false;
                        }
                    }
                    else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"])) {
                        let xDoc: XmlDocument = new XmlDocument();
                        xDoc.LoadXml(sbAccounts);

                        let xList = xDoc.SelectNodes("AccountsXML/Accounts");

                        TotalBillWiseAmout = parseFloat(this.ScreenObject.GridData[i]["Amount"]) * this.GetExchRate(i);
                        for (let x = 0; x < xList.length; x++) {
                            if (xList[x].attributes["DebitAccount"] != null && xList[x].attributes["DebitAccount"].value != ""
                                && parseInt(xList[x].attributes["DebitAccount"].value) == parseInt(this.ScreenObject.GridData[i]["DebitAccount_Key"])
                                && xList[x].attributes["Amount"] != null && xList[x].attributes["Amount"].value != "") {
                                TotalBillWiseAmout += parseFloat(xList[x].attributes["Amount"].value);
                            }
                            else if (xList[x].attributes["CreditAccount"] != null && xList[x].attributes["CreditAccount"].value != ""
                                && parseInt(xList[x].attributes["CreditAccount"].value) == parseInt(this.ScreenObject.GridData[i]["DebitAccount_Key"])
                                && xList[x].attributes["Amount"] != null && xList[x].attributes["Amount"].value != "") {
                                TotalBillWiseAmout -= parseFloat(xList[x].attributes["Amount"].value);
                            }
                        }
                        if (this.CheckAccountBalance(parseInt(this.ScreenObject.GridData[i]["DebitAccount_Key"]), TotalBillWiseAmout, false)) {
                            if (this.DisplayMessage == null || this.DisplayMessage == "")
                                this.DisplayMessage = "Balance goes -ve for " + this.ScreenObject.GridData[i]["CreditAccount"].toString() + "at row no:" + this.ScreenObject.GridData[i]["DocSeqNo"].toString();

                            return false;
                        }
                    }
                }
                else if (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 15 || this.ScreenObject.DocumentType == 20 || this.ScreenObject.DocumentType == 23) {
                    if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0) {
                        this.DisplayMessage = "";
                        if (this.CheckAccountBalance(this.ScreenObject.CreditAccount.SelectedValue, this.GridNetTotal, true)) {
                            if (this.DisplayMessage == "") {
                                this.DisplayMessage = "Balance goes -ve for ";
                                if (this.ScreenObject.CreditAccount.Text != "")
                                    this.DisplayMessage += this.ScreenObject.CreditAccount.Text;
                                else
                                    this.DisplayMessage += "pament mode";
                            }

                            return false;
                        }
                    }
                    else if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"])) {
                        let xDoc: XmlDocument = new XmlDocument();
                        xDoc.LoadXml(sbAccounts);

                        let xList = xDoc.SelectNodes("AccountsXML/Accounts");

                        TotalBillWiseAmout = parseFloat(this.ScreenObject.GridData[i]["Amount"]) * this.GetExchRate(i);
                        for (let x = 0; x < xList.length; x++) {
                            if (xList[x].attributes["CreditAccount"] != null && xList[x].attributes["CreditAccount"].value != ""
                                && parseInt(xList[x].attributes["CreditAccount"].value) == parseInt(this.ScreenObject.GridData[i]["CreditAccount_Key"])
                                && xList[x].attributes["Amount"] != null && xList[x].attributes["Amount"].value != "") {
                                TotalBillWiseAmout += parseFloat(xList[x].attributes["Amount"].value);
                            }
                            else if (xList[x].attributes["DebitAccount"] != null && xList[x].attributes["DebitAccount"].value != ""
                                && parseInt(xList[x].attributes["DebitAccount"].value) == parseInt(this.ScreenObject.GridData[i]["CreditAccount_Key"])
                                && xList[x].attributes["Amount"] != null && xList[x].attributes["Amount"].value != "") {
                                TotalBillWiseAmout -= parseFloat(xList[x].attributes["Amount"].value);
                            }
                        }
                        if (this.CheckAccountBalance(parseInt(this.ScreenObject.GridData[i]["CreditAccount_Key"]), TotalBillWiseAmout, true)) {
                            if (this.DisplayMessage == null || this.DisplayMessage == "")
                                this.DisplayMessage = "Balance goes -ve for " + this.ScreenObject.GridData[i]["CreditAccount"].toString() + "at row no:" + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                            return false;
                        }
                    }
                }
                else if (BaseService.SessionManager.Preferences.ContainsKey("DontSaveCahsBankBalanceNegative") && BaseService.SessionManager.Preferences["DontSaveCahsBankBalanceNegative"] != "" && parseBoolean(BaseService.SessionManager.Preferences["DontSaveCahsBankBalanceNegative"])) {
                    if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"])) {
                        if (this.ScreenObject.GridDataColumns.Contains("DebitAmount") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAmount"])
                            && parseFloat(this.ScreenObject.GridData[i]["DebitAmount"]) > 0) {
                            if (this.CheckAccountBalance(parseInt(this.ScreenObject.GridData[i]["AccountID_Key"]), parseFloat(this.ScreenObject.GridData[i]["DebitAmount"]), false)) {
                                if ((this.DisplayMessage == null || this.DisplayMessage == "") && this.ScreenObject.GridDataColumns.Contains("AccountName"))
                                    this.DisplayMessage = "Balance goes -ve for " + this.ScreenObject.GridData[i]["AccountName"].toString() + "at row no:" + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                else if ((this.DisplayMessage == null || this.DisplayMessage == "") && this.ScreenObject.GridDataColumns.Contains("Accountcode"))
                                    this.DisplayMessage = "Balance goes -ve for " + this.ScreenObject.GridData[i]["Accountcode"].toString() + "at row no:" + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                return false;
                            }
                        }
                        else if (this.ScreenObject.GridDataColumns.Contains("CreditAmount") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAmount"])
                            && parseFloat(this.ScreenObject.GridData[i]["CreditAmount"]) > 0) {
                            if (this.CheckAccountBalance(parseInt(this.ScreenObject.GridData[i]["AccountID_Key"]), parseFloat(this.ScreenObject.GridData[i]["CreditAmount"]), true)) {
                                if ((this.DisplayMessage == null || this.DisplayMessage == "") && this.ScreenObject.GridDataColumns.Contains("AccountName"))
                                    this.DisplayMessage = "Balance goes -ve for " + this.ScreenObject.GridData[i]["AccountName"].toString() + "at row no:" + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                else if ((this.DisplayMessage == null || this.DisplayMessage == "") && this.ScreenObject.GridDataColumns.Contains("Accountcode"))
                                    this.DisplayMessage = "Balance goes -ve for " + this.ScreenObject.GridData[i]["Accountcode"].toString() + "at row no:" + this.ScreenObject.GridData[i]["DocSeqNo"].toString();
                                return false;
                            }
                        }
                    }
                }

                sbRows += sbAccounts.toString();
                if (sender != null && sender.toString() == "Bounce") {
                    if (this.ScreenObject.DocumentType == 18 && this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"])) {
                        if (this.IsAccBillWise(parseInt(this.ScreenObject.GridData[i]["CreditAccount_Key"])))
                            sbRows += sbStatic.toString() + sbNumeric.toString() + sbText.toString() + sbCC.toString() + "<EXTRAXML>" + this.BillXMLBounce(this.ScreenObject.GridData[i]["CreditAccount_Key"].toString(), this.ScreenObject.GridData[i]["Amount"].toString(), false) + "</EXTRAXML>";
                        else
                            sbRows += sbStatic.toString() + sbNumeric.toString() + sbText.toString() + sbCC.toString() + "<EXTRAXML> </EXTRAXML>";
                    }
                    else if (this.ScreenObject.DocumentType == 15 && this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"])) {
                        if (this.IsAccBillWise(parseInt(this.ScreenObject.GridData[i]["DebitAccount_Key"])))
                            sbRows += sbStatic.toString() + sbNumeric.toString() + sbText.toString() + sbCC.toString() + "<EXTRAXML>" + this.BillXMLBounce(this.ScreenObject.GridData[i]["DebitAccount_Key"].toString(), this.ScreenObject.GridData[i]["Amount"].toString(), true) + "</EXTRAXML>";
                        else
                            sbRows += sbStatic.toString() + sbNumeric.toString() + sbText.toString() + sbCC.toString() + "<EXTRAXML> </EXTRAXML>";
                    }
                    else
                        sbRows += sbStatic.toString() + sbNumeric.toString() + sbText.toString() + sbCC.toString() + "<EXTRAXML> </EXTRAXML>";
                }
                else {
                    sbRows += sbStatic.toString() + sbNumeric.toString() + sbText.toString() + sbCC.toString() + "<EXTRAXML>" + Util.String(this.ScreenObject.GridData[i]["ExtraXML"]) + Util.String(this.ScreenObject.GridData[i]["ExtraBillWiseXML"]) + "</EXTRAXML>";
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["DiscXML"]))
                        sbRows += this.ScreenObject.GridData[i]["DiscXML"].toString();
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ReturnXML"]))
                        sbRows += "<ReturnXML>" + this.ScreenObject.GridData[i]["ReturnXML"].toString() + "</ReturnXML>";
                    if (this.ScreenObject.GridDataColumns.Contains("DenominationsXML") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DenominationsXML"]))
                        sbRows += "<PosPayModes>" + this.ScreenObject.GridData[i]["DenominationsXML"].toString() + "</PosPayModes>";

                    if (this.GetButton("Pre Payments") != null && this.pdcGCVM && this.pdcGCVM.IsDataSaved && RowCount == 1) {
                        if (this.ScreenObject.Preferences.ContainsKey("Prepaymentdate") && this.ScreenObject.Preferences["Prepaymentdate"] == "True"
                            && this.pdcGCVM.CheqStartDate.Date < this.DocumentDate) {
                            this.DisplayMessage = "Pre Payments Start date can not be less than document date.";
                            this.MessageVisibility = true;
                            return false;
                        }
                        sbRows += this.pdcGCVM.GenerateChequeNos();
                    }

                }

                sbRows += "</Row>";
            }
            sbRows += "</DocumentXML>";

            if (RowCount == 0) {
                this.DisplayMessage = BaseService.GetResource("Doc_BlankData");
                return false;
            }

            if ((this.ScreenObject.DocumentType == 17 || this.ScreenObject.DocumentType == 28 || this.ScreenObject.DocumentType == 29)) {
                let fld = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "creditamount");
                if (fld && !Util.IsEmpty(fld.DecimalPoints)) {
                    if (TotalCreditAmout.ToString("N" + fld.DecimalPoints) != TotalDebitAmout.ToString("N" + fld.DecimalPoints)) {
                        this.DisplayMessage = BaseService.GetResource("DebitCreditarenotEqual");
                        return false;
                    }
                }
                else if (TotalCreditAmout != TotalDebitAmout) {
                    this.DisplayMessage = BaseService.GetResource("DebitCreditarenotEqual");
                    return false;
                }
            }

            if (this.ScreenObject.IsRefLCTR) {
                let amt = this.ScreenObject.GridData.Compute("sum", "Amount");
                if (amt != null && parseFloat(amt) > this.LCDueAmt) {
                    this.DisplayMessage = "Can not pay more than due";
                    return false;
                }
            }
            let BudgetExceeds = false;
            this.DisplayMessage = "";
            this.BudgetValidation(sbRows.toString()); //Commented by Ikram not to validate

            if (this.DisplayMessage != null && this.DisplayMessage.length > 0) {
                if (BaseService.SessionManager.Preferences["GBudgetUnapprove"].toLowerCase() == "true" && this.DisplayMessage != " ") {
                    this.DisplayMessage = "";
                    BudgetExceeds = true;
                }
                else
                    return false;
            }
            if (this.IsAutoPost) {
                this.DisplayMessage = "";
                this.AutoPOstXML = sbRows.toString();
                BaseService.page.HideDialog(this.PopUpGUID);
                return false;
            }
            let RetValu = 0;
            if (sender != null && sender.toString() == "Bounce") {
                if (this.ScreenObject.Data.Tables.length > 3 && this.ScreenObject.Data.Tables[3].length > 0) {
                    if (Util.Double(this.ScreenObject.Data.Tables[3][0]["Bounce"]) > 0) {
                        if (this.Bounce && this.Bounce.TerminationDate && this.Bounce.TerminationDate.Date) {
                            let dt: Date = this.Bounce.TerminationDate.Date;
                            this.DocumentDate = dt;
                        }
                        this.ScreenObject.PostAccountingDocument(sbRows.toString(), (this.ViewNotes) ? this.ViewNotes.GetXML() : "", (this.ViewAttachments != null) ? this.ViewAttachments.GetXML() : "", this.DocumentDate, this.GetWorkFlow(false, null), this.ScreenObject.Data.Tables[3][0]["Bounce"].toString()).subscribe(
                            (response: any) => {
                                this.DisplayMessage = response.Message;
                                this.ScreenObject.DocID = response.RetValue
                                if (this.RetValue > 0) {
                                    this.ScreenObject.DocID = this.RetValue;
                                    if (this.ScreenObject.DraftID > 0) {
                                        BaseService.document.DeleteDocumentDraft(this.ScreenObject.DraftID);
                                        this.ScreenObject.DraftID = 0;
                                    }
                                }
                                Logger.InfoLog("VoucherGenerator:: Exiting SaveDocument");
                            },
                            (error) => {
                                console.log(error);
                                this.DisplayMessage = "Error in save"
                            });
                        //ButtonBounce.Visible = false;
                        this.ButtonSave.Visible = false;
                        this.ButtonsEnabled = true;
                    }
                    else {
                        this.DisplayMessage = " Please set 'Bounce' for this Document ";
                        return false;
                    }
                }
            }
            else {
                let args: string[] = [];
                args.push(sbRows);
                args.push(BudgetExceeds.toString());

                if (!Util.IsEmpty(sender.toString()))
                    this.commandprarameter = sender.toString();

                let WID = this.GetWorkFlow(false, null);
                args.push(WID.toString());
                if (WID > 0 && this.ScreenObject.Preferences.ContainsKey("L1Remarks") && this.ScreenObject.Preferences["L1Remarks"] == "True"
                    && (sender.toString() == "Save" || sender.toString() == "SaveAndPrint")) {
                    BaseService.page.ShowDialog(new ReviseReasonViewModel(this, 2), ReviseReasonComponent);
                    if (!Util.IsEmpty(this.ReviseReason))
                        args.push(" L1Remarks=\"" + this.ReviseReason + "\"");
                }


                if (sender.toString() == "ReSave") {
                    this.AccountingSave_DoWork(null, args);
                    this.SaveComplete(false);
                }
                else {
                    this.AccountingSave_DoWork(null, args);
                    /**
                                        BackgroundWorker AccountingSave = new BackgroundWorker();
                                        AccountingSave.DoWork += new DoWorkEventHandler(this.AccountingSave_DoWork);
                                        AccountingSave.RunWorkerAsync(args);
                                        AccountingSave.RunWorkerCompleted += new RunWorkerCompletedEventHandler(Save_Completed);***/
                    return true;
                }
                Logger.InfoLog("AddEditDocumentViewModel::Exiting OnSaveAccount");

            }

            Logger.InfoLog("AddEditDocumentViewModel::Exiting SaveAccountingDocument");
        }
        catch (error) {
            this.DisplayMessage = "Error in Save."
            Logger.ErrorLog("AddEditDocumentViewModel:: SaveAccountingDocument" + error.stack);
            return false;
        }

        return true;
    }

    IsAccBillWise(AccountID: number): boolean {
        if (BaseService.SessionManager.Preferences.ContainsKey("On") && BaseService.SessionManager.Preferences["On"] == "True") {
            let DS: any = BaseService.document.IsBillWiseAccount(AccountID);
            if (DS != null && DS.Tables.length > 0 && DS.Tables[0].length > 0) {
                if (parseBoolean(DS.Tables[0][0]["IsBillwise"])) {
                    return true;
                }
            }
        }
        return false;
    }
    BillXMLBounce(AccID: string, Amount: string, IsCredit: boolean): string {
        let CurrID = 1; let ExhgRate = 1;
        if (this.Currency != null && !Util.IsEmpty(this.Currency.Currency.SelectedValue))
            CurrID = parseInt(this.Currency.Currency.SelectedValue);
        if (this.Currency != null && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
            ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);

        let sb = "";
        sb += "<BillWise><Row ";
        sb += "DocSeqNo=\"1\" ";

        sb += "AccountID=\"" + AccID + "\" ";
        if (IsCredit) {
            sb += "AmountFC=\"" + "-" + Amount + "\" ";
            sb += "AdjAmount=\"" + "-" + (parseFloat(Amount) * ExhgRate) + "\" ";
        }
        else {
            sb += "AmountFC=\"" + Amount + "\" ";
            sb += "AdjAmount=\"" + parseFloat(Amount) * ExhgRate + "\" ";
        }
        sb += "AdjCurrID=\"" + CurrID.toString() + "\" ";
        sb += "AdjExchRT=\"" + ExhgRate.toString() + "\" ";
        sb += "IsNewReference=\"" + "1" + "\" ";
        sb += "Narration=\"" + "" + "\" ";
        sb += "IsDocPDC=\"" + "0" + "\" ";
        sb += " ></Row></BillWise>";
        return sb;
    }

    OnDocPrefixChanged(sender: any) {
        if (this.ScreenObject != null && sender != null && sender.toString() == "lostFocus" && !this.ConfirmDirtyRead())
            return;
        this.OnDocPrefixChanged_2(sender, false);

        if (this.ScreenObject != null && sender != null && sender.toString() == "lostFocus" && !this.ScreenObject.IsDocEdit)
            this.clear(4);
        else if (sender != null && sender.toString() != "lostFocus" && !this.isFromDate) {
            this.clear(3);
        }
    }
    OnDocPrefixChanged_2(sender: any, clear: boolean = false) {
        if (this.ScreenObject == null)
            return;
        Logger.InfoLog("AddEditDocumentViewModel::Entering OnDocPrefixChanged");
        if (sender != null) {
            try {
                let ref_Ddate = { value: this._Ddate }
                this.ScreenObject.OnDocPrefixChanged(sender, 0, 0, ref_Ddate, clear, (this.isFromDate) ? this.ScheduleID : 0);
                this._Ddate = ref_Ddate.value
            }
            catch (error) {
                this.DisplayMessage = "Error Loading document try again";

                Logger.ErrorLog("Addeditdocumentviewmodel", "OnDocPrefixChanged", error.stack);
            }
        }
        Logger.InfoLog("AddEditDocumentViewModel::Exiting OnDocPrefixChanged");
    }

    OnGridSelectionChanged(sender: any, selectedRow: any = null) {
        let col = sender.column.DgCol;
        let bindingpath = col.DisplayMember;
        if (col.DataType == "LISTBOX")
            bindingpath = col.ValueMember;
        // let args=objEditCell.args;
        //let CurrentRow:any = objEditCell.args.item;

        Logger.InfoLog("AddEditDocumentViewModel::Entering OnGridSelectionChanged");
        if (col.DataType == "LISTBOX" && col.CostCenterID == 2) {
            try {
                let id = 0;
                if (this.ScreenObject.GridDataColumns.Contains(bindingpath)) {
                    if (!Util.IsEmpty(this.SelectedRow[bindingpath]))
                        id = parseInt(this.SelectedRow[bindingpath]);
                }
                // else
                //  id = parseInt(sender.AddedItems[0].Row[0]);

                if (!(this.ccid == 2 && this.PrAccID == id)) {
                    this.t.Enabled = false;
                    this.ccid = 2; this.PrAccID = id;
                    this.t.Enabled = true;
                }

                if (!this.IsInventoryVoucher) {
                    this.ReportDimension.SelectedValue = id;
                    //alert(this.ReportDimension.SelectedValue)
                    if (this.ReportDimension.SelectedValue > 0) {
                        let drlist = BaseService.SessionManager.ListViewDef.Tables[0].filter(x => x.CostCenterID == this.ReportDimension.CCID && x.ListViewTypeID == this.ReportDimension.TypeID);
                        if (drlist.length > 0) {
                            if (drlist[0]["SysColumnName"].toLowerCase() == "accountcode" && Util.hasprop(sender.item, "AccountCode")) {
                                this.ReportDimension.SelectedValueText = this.SelectedRow["AccountCode"].toString();
                            }
                            else if (drlist[0]["SysColumnName"].toLowerCase() == "accountname" && Util.hasprop(sender.item, "AccountName")) {
                                this.ReportDimension.SelectedValueText = this.SelectedRow["AccountName"].toString();
                            }
                        }
                    }
                }
            }
            catch {

            }
        }
        else if (col.DataType == "LISTBOX" && col.CostCenterID == 3) {
            try {
                let prodid = 0;
                if (((this.ScreenObject.Preferences.ContainsKey("ShowProductImage") && this.ScreenObject.Preferences["ShowProductImage"] != "" && parseBoolean(this.ScreenObject.Preferences["ShowProductImage"])) || this.ProductImageVisibility))
                    this.ShowProductImage(sender.item, selectedRow);

                if (this.ScreenObject.GridDataColumns.Contains(bindingpath)) {
                    if (!Util.IsEmpty(this.SelectedRow[bindingpath]))
                        prodid = parseInt(this.SelectedRow[bindingpath]);
                }
                // else
                //  prodid = parseInt(sender.AddedItems[0].Row[0]);

                if (!(this.ccid == 3 && this.PrAccID == prodid)) {
                    this.t.Enabled = false;
                    this.ccid = 3; this.PrAccID = prodid;
                    this.t.Enabled = true;
                }
                if (this.IsInventoryVoucher) {
                    this.ReportDimension.SelectedValue = prodid;

                    if (this.ReportDimension.SelectedValue > 0) {
                        let drlist = BaseService.SessionManager.ListViewDef.Tables[0].filter(x => x.CostCenterID == this.ReportDimension.CCID && x.ListViewTypeID == this.ReportDimension.TypeID);

                        if (drlist.length > 0) {
                            if (drlist[0]["SysColumnName"].toLowerCase() == "productcode" && Util.hasprop(sender.item, "ProductCode")) {
                                this.ReportDimension.SelectedValueText = this.SelectedRow["ProductCode"].toString();
                            }
                            else if (drlist[0]["SysColumnName"].toLowerCase() == "productname" && Util.hasprop(sender.item, "ProductName")) {
                                this.ReportDimension.SelectedValueText = this.SelectedRow["ProductName"].toString();
                            }
                        }
                    }
                }
            }
            catch {
            }
        }
        else if (col != null && col.DataType == "LISTBOX" && col.CostCenterID >= 50001) {
            try {

                let Dimid = 0;
                if (this.ScreenObject.GridDataColumns.Contains(bindingpath)) {
                    if (!Util.IsEmpty(this.SelectedRow[bindingpath]))
                        Dimid = parseInt(this.SelectedRow[bindingpath]);
                }
                // else
                //  Dimid = parseInt(sender.AddedItems[0].Row[0]);

                if (this.ScreenObject.Preferences.ContainsKey("QuickViewDimensions") && this.ScreenObject.Preferences["QuickViewDimensions"] != "" && this.ScreenObject.Preferences["QuickViewDimensions"].toString().Contains(col.CostCenterID.toString())) {
                    if (!(this.ccid == col.CostCenterID && this.PrAccID == Dimid)) {
                        this.t.Enabled = false;
                        this.ccid = col.CostCenterID; this.PrAccID = Dimid;
                        this.t.Enabled = true;
                    }
                }
                else {
                    if (this.ScreenObject.Preferences.ContainsKey("MapDocsFilterDim") && !Util.IsEmpty(this.ScreenObject.Preferences["MapDocsFilterDim"])) {
                        this.DocsList = [];
                        if (parseInt(this.ScreenObject.Preferences["MapDocsFilterDim"]) == col.CostCenterID) {
                            if (this.ScreenObject.Data != null && this.ScreenObject.Data.Tables.length > 21 && this.ScreenObject.Data.Tables[21].length > 0) {
                                let dsDocsAssigned = BaseService.common.GetDataSet3("DOC087", col.CostCenterID.toString(), Dimid.toString());
                                let dtDocsAssigned = dsDocsAssigned.Tables[0];
                                if (dtDocsAssigned != null && dtDocsAssigned.length > 0) {
                                    for (let r = 0; r < this.ScreenObject.Data.Tables[21].length; r++) {
                                        let dr = this.ScreenObject.Data.Tables[21][r];
                                        let ldocs = dtDocsAssigned.filter(a => a.NodeID == parseInt(dr["ReportID"]));
                                        if (dr["Type"].toString() == "2" && ldocs != null && ldocs.length > 0) {
                                            let link = new PactButtonData();
                                            link.DBColumnID = parseInt(dr["ReportID"]);
                                            link.Label = dr["ReportName"].toString();
                                            if (this.ScreenObject.Data.Columns[21].Contains("Shortcut"))
                                                link.KeyTip = dr["Shortcut"].toString();
                                            if (this.ScreenObject.Data.Columns[21].Contains("DisplayAsPopup") && !Util.IsEmpty(dr["DisplayAsPopup"]))
                                                link.Dependancy = Util.Int(dr["DisplayAsPopup"]);
                                            this.DocsList.push(link);
                                        }
                                    }
                                }
                            }
                        }
                        this.SetVisibiltiFalse();
                        this.MappedDocsVisibility = true;
                    }
                }
            }
            catch {
            }
        }
        else if (this.SelectedRow != null) {
            if (this.IsInventoryVoucher && !Util.IsEmpty(this.SelectedRow["ProductID_Key"]) && parseInt(this.SelectedRow["ProductID_Key"]) > 0) {
                this.ReportDimension.SelectedValue = parseInt(this.SelectedRow["ProductID_Key"]);
            }
            else if (!this.IsInventoryVoucher && !Util.IsEmpty(this.SelectedRow["DebitAccount_Key"]) && parseInt(this.SelectedRow["DebitAccount_Key"]) > 0) {
                this.ReportDimension.SelectedValue = parseInt(this.SelectedRow["DebitAccount_Key"]);
            }
            else if (!this.IsInventoryVoucher && !Util.IsEmpty(this.SelectedRow["CreditAccount_Key"]) && parseInt(this.SelectedRow["CreditAccount_Key"]) > 0) {
                this.ReportDimension.SelectedValue = parseInt(this.SelectedRow["CreditAccount_Key"]);
            }
            else if (!this.IsInventoryVoucher && !Util.IsEmpty(this.SelectedRow["AccountID_Key"]) && parseInt(this.SelectedRow["AccountID_Key"]) > 0) {
                this.ReportDimension.SelectedValue = parseInt(this.SelectedRow["AccountID_Key"]);
            }
            //alert( this.ReportDimension.SelectedValue)
        }
        Logger.InfoLog("AddEditDocumentViewModel::Exiting OnGridSelectionChanged");
    }

    t_Tick() {
        if ((this.ccid == 2 || this.ccid == 3 || (this.ccid >= 50001)) && this.PrAccID > 0) {
            if (this.SelectedRow != null)// && SelectedRow instanceof DataRowView
                this.ShowQuickView(this.ccid, this.PrAccID, this.SelectedRow, null);
            else
                this.ShowQuickView(this.ccid, this.PrAccID, null, null);
        }
    }

    ShowQuickViewCallBack(obj) {
        this.ShowQuickView(obj.CCID, obj.NodeID, obj.datarow, obj.ctrl);
    }

    ShowQuickView(CCID: number, NodeID: number, datarow: any, ctrl: PactControlData) {
        if (CCID == 0 && ctrl != null) {
            this.ScreenObject._CCFields.forEach(item => {
                if (item instanceof PactListBoxData) {
                    if (item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                        this.fldDict[item.Lbl].setFieldValue(item.Text);
                    else
                        this.fldDict[item.Lbl].setFieldValue("");
                }
            });
            this.ScreenObject._TextFields.forEach(item => {
                if (this.fldDict.ContainsKey(item.Lbl)) {
                    if (item instanceof PactTextBoxData) {
                        if (item.DataType == "FLOAT") {
                            if (item.Text != null && item.Text != "" && item.ValidateData() == "")
                                this.fldDict[item.Lbl].setFieldValue(item.Text);
                            else
                                this.fldDict[item.Lbl].setFieldValue(0);
                        }
                        else
                            this.fldDict[item.Lbl].setFieldValue(item.Text);
                    }
                    else if (item instanceof PactComboBoxData)
                        this.fldDict[item.Lbl].setFieldValue(item.SelectedValue);
                    else if (item instanceof PactSelectionBoxData)
                        this.fldDict[item.Lbl].setFieldValue(item.Text);
                    else if (item instanceof PactListBoxData) {
                        if (item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                            this.fldDict[item.Lbl].setFieldValue(item.Text);
                        else
                            this.fldDict[item.Lbl].setFieldValue("");
                    }
                }
            });
            this.ValidateData(ctrl);
            return;
        }
        let tempQuickInfoVisibility = this.QuickInfoVisibility, tempDQuickInfoVisibility = this.DQuickInfoVisibility;
        this.t.Enabled = false;
        if (NodeID <= 0) {
            this.SetVisibiltiFalse();
            if (this.IsPOs)
                this.ProductSearchVisibility = true;
            else
                this.SetDefaultRightPanel();
            return;
        }
        this.SetVisibiltiFalse();
        if (!this.IsPOs)
            this.SetDefaultRightPanel();
        if (this.IgnoreQuickViews.Contains(CCID)) {
            this.QuickInfoVisibility = false;
            this.DQuickInfoVisibility = false;
            return;
        }
        let prmoise = null;
        if (CCID == 2) {
            if (!this.QuickInfoView)
                this.QuickInfoView = new QuickViewScreenViewModel();
            prmoise = this.QuickInfoView.QuickViewScreenViewModel_3(CCID, NodeID, this.CostCenterID, this.DocumentDate, 0, "");
        }
        else if (CCID == 3) {
            let AccountID = 0;
            let DocumentType = this.ScreenObject.DocumentType;
            if (this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0 && (this.DocumentType == 1 || DocumentType == 2 || DocumentType == 10 || DocumentType == 26 || DocumentType == 27 || DocumentType == 3 || DocumentType == 4 || DocumentType == 25 || DocumentType == 13))
                AccountID = this.ScreenObject.CreditAccount.SelectedValue;
            else if (this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0 && (this.DocumentType == 11 || DocumentType == 6 || DocumentType == 7 || DocumentType == 8 || DocumentType == 9 || DocumentType == 12 || DocumentType == 24))
                AccountID = this.ScreenObject.DebitAccount.SelectedValue;
            let cc = "<XML>";
            this.ScreenObject._CCFields.forEach(item => {
                if (item instanceof PactListBoxData && item.DBColumnName.Contains("TO") && DocumentType == 5)
                    return;
                if (item instanceof PactListBoxData && item.SelectedValue > 0)
                    cc += "<Row CostCenterID=\"" + item.CCID + "\" NODEID=\"" + item.SelectedValue.toString() + "\" />";
            });
            if (datarow != null)
                this.ScreenObject.ColumnSource.forEach(item => {
                    if (item.CostCenterID > 50000 && this.ScreenObject.GridDataColumns.Contains(item.ValueMember)) {
                        if (!Util.IsEmpty(datarow[item.ValueMember]))
                            cc += "<Row CostCenterID=\"" + item.CostCenterID + "\" NODEID=\"" + datarow[item.ValueMember].toString() + "\" />";
                        else if (!Util.IsEmpty(datarow[item.DisplayMember]))
                            cc += "<Row CostCenterID=\"" + item.CostCenterID + "\" NODEID=\"" + datarow[item.DisplayMember].toString() + "\" />";
                    }
                });

            if ((DocumentType == 1 || DocumentType == 2 || DocumentType == 10 || DocumentType == 26 || DocumentType == 27 || DocumentType == 3 || DocumentType == 4 || DocumentType == 25 || DocumentType == 13) && this.ScreenObject.CreditAccount != null && this.ScreenObject.CreditAccount.SelectedValue > 0)
                cc += "<Row CostCenterID=\"2\" NODEID=\"" + this.ScreenObject.CreditAccount.SelectedValue.toString() + "\" />";
            else if ((DocumentType == 11 || DocumentType == 6 || DocumentType == 7 || DocumentType == 8 || DocumentType == 9 || DocumentType == 12 || DocumentType == 24) && this.ScreenObject.DebitAccount != null && this.ScreenObject.DebitAccount.SelectedValue > 0)
                cc += "<Row CostCenterID=\"2\" NODEID=\"" + this.ScreenObject.DebitAccount.SelectedValue.toString() + "\" />";

            cc += "</XML>";
            if (!this.QuickInfoView)
                this.QuickInfoView = new QuickViewScreenViewModel();
            prmoise = this.QuickInfoView.QuickViewScreenViewModel_3(CCID, NodeID, this.CostCenterID, this.DocumentDate, AccountID, cc.toString());
        }
        else if (CCID >= 50001) {
            if (!this.DQuickInfoView)
                this.DQuickInfoView = new QuickViewScreenViewModel();
            prmoise = this.DQuickInfoView.QuickViewScreenViewModel_3(CCID, NodeID, this.CostCenterID, this.DocumentDate, 0, "");
        }
        else {
            if (!this.QuickInfoView)
                this.QuickInfoView = new QuickViewScreenViewModel();
            prmoise = this.QuickInfoView.QuickViewScreenViewModel_3(CCID, NodeID, CCID, this.DocumentDate, 0, "");
        }
        if (prmoise) {
            prmoise.then(() => {
                if (CCID >= 50001) {
                    this.DQuickInfoVisibility = !this.DQuickInfoView.IsError;
                    this.QuickInfoVisibility = tempQuickInfoVisibility;
                    if (this.DQuickInfoView.IsError)
                        this.IgnoreQuickViews.push(CCID);
                }
                else {
                    this.QuickInfoVisibility = !this.QuickInfoView.IsError;
                    this.DQuickInfoVisibility = tempDQuickInfoVisibility;
                    if (this.QuickInfoView.IsError)
                        this.IgnoreQuickViews.push(CCID);
                }
            });
        }
    }

    ShowProductImage(dr: any, gridSelectedRow: any = null) {
        this.SetVisibiltiFalse();
        this.ProductImageVisibility = true;
        if (this.ScreenObject.GridDataColumns.Contains("FileGUID") && this.ScreenObject.GridDataColumns.Contains("FileExtension") && !Util.IsEmpty(dr["FileGUID"])) {
            //         PhotoTextVisibility = false;
            //         this.ProductPhoto = PactFile.GetLogPath(dr["FileGUID"].toString() + "." + dr["FileExtension"].toString());
            //         if (!Util.IsEmpty(r.guid)) {
            let fileGuid = dr["FileGUID"]
            dr.guid = dr["FileGUID"];
            this.ProductPhoto = Util.GetPath(dr["FileGUID"].toString() + "." + dr["FileExtension"].toString());

            if (BaseService.IsMobile)
                gridSelectedRow["ProductPhoto"] = this.ProductPhoto;

            // BaseService.page.ShowDialog(dr, PactImageComponent, { ShowCenter: true, Title: "Preview Image" })
            //}
        }
        else {
            // this.PhotoTextVisibility = true;
            // this.ProductPhoto = "";
        }
    }

    BindDivisionorLocation(datarow: any) {
        if (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True") {
            let col = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50001);
            if (col && col.ReadOnly) {
                if (this.ScreenObject.DivisionID > 0) {
                    datarow[col.DisplayMember + "_Key"] = this.ScreenObject.DivisionID;
                    datarow[col.DisplayMember] = this.ScreenObject.DivisionName;
                }
                else if (BaseService.SessionManager.DivisionID > 0) {
                    datarow[col.DisplayMember + "_Key"] = BaseService.SessionManager.DivisionID;
                    datarow[col.DisplayMember] = BaseService.SessionManager.DivisionName;
                }
            }
        }
        if (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True") {
            let col = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50002);
            if (col && col.ReadOnly) {
                if (this.ScreenObject.LocationID > 0) {
                    datarow[col.DisplayMember + "_Key"] = this.ScreenObject.LocationID;
                    datarow[col.DisplayMember] = this.ScreenObject.LocationName;
                }
                else if (BaseService.SessionManager.LocationID > 0) {
                    datarow[col.DisplayMember + "_Key"] = BaseService.SessionManager.LocationID;
                    datarow[col.DisplayMember] = BaseService.SessionManager.LocationName;
                }
            }
        }
    }



    //#region  /* Khasim Comments Starts  */
    //this method will invoke while on cell click,on Begin Edit 
    //COMMON
    onFooterBeginEdit(objEditCell) {
        let args = objEditCell.args;  //storing Begin Edit arguments local object args 
        let CurrentRow: any = objEditCell.args.item; //Current Selected Row in Footer grid object
        let column = objEditCell.args.column//Current Selected Column on cell in Footer grid object
        let col: DgColumn = column.DgCol//Current Selected Column on cell from column source Model Object DgColumn
        let ename = column.className; //this class name maintaining in model for instaceOf checking purpose 

        if (!parseBoolean(CurrentRow["IsVisible"]) && CurrentRow["StyleHeightZero"] == 1) { // here we are checking selected Row is Visible and its Height is Zero then we are Cancelling Its Begin Edit Arguments 
            args.Cancel = true;
            return;
        }
        // here we are checking condition of Text Box editor ReadOnly then we are Cancelling Its Begin Edit Arguments 
        if (this.IsInventoryVoucher && ename == "PactTextBoxEditor" && (col.DisplayMember == "Amount" || col.DisplayMember == "CalcAmount")
            && this.ScreenObject.GridDataColumns.Contains("ReadOnly") && !Util.IsEmpty(CurrentRow["ReadOnly"]) && parseBoolean(CurrentRow["ReadOnly"])) {
            args.Cancel = true;
            return;
        }
        // here we are checking condition of DataGridPactListBoxColumn of Currency Id key -3 || -1 then we are Cancelling Its Begin Edit Arguments 
        if (this.IsInventoryVoucher && ename == "DataGridPactListBoxColumn" && col.DisplayMember == "dcCurrID"
            && this.ScreenObject.GridDataColumns.Contains("dcCurrID_Key") && !Util.IsEmpty(CurrentRow["dcCurrID_Key"]) && (parseInt(CurrentRow["dcCurrID_Key"]) == -3 || parseInt(CurrentRow["dcCurrID_Key"]) == -1)) {
            args.Cancel = true;
            return;
        }
        // here we are checking condition of PactTextBoxEditor of Exchange Rate of Currency Id key -3 || -1 then we are Cancelling Its Begin Edit Arguments 
        if (this.IsInventoryVoucher && ename == "PactTextBoxEditor" && col.DisplayMember == "dcExchRT"
            && this.ScreenObject.GridDataColumns.Contains("dcCurrID_Key") && !Util.IsEmpty(CurrentRow["dcCurrID_Key"]) && (parseInt(CurrentRow["dcCurrID_Key"]) == -3 || parseInt(CurrentRow["dcCurrID_Key"]) == -1)) {
            args.Cancel = true;
            return;
        }
        //ename == "Microsoft.Windows.Controls.DataGridComboBoxColumn" && 
        // if column model object  Display Member is  ColumnName we are storing to Footer Column Property 
        if ((col.DisplayMember == "ColumnName" || col.ValueBinding == "ColumnName") && this.ScreenObject.GridDataColumns.Contains("ColumnName") && !Util.IsEmpty(CurrentRow["ColumnName"]))
            this.FooterColumn = CurrentRow["ColumnName"].toString();
        else
            this.FooterColumn = ""; //otherWise we are storing Empty string


        //here we are checking if current Document POSDocumentViewModel and cell begin edit From PactTextBoxEditor
        if (this.ClassName == "POSDocumentViewModel" && ename == "PactTextBoxEditor") {
            this.NUmpadBindingPath = col.DisplayMember; // storing in NUmpadBindingPath property of column model object DisplayMember
            if (!Util.IsEmpty(CurrentRow[col.DisplayMember]))
                this.NumPadText = CurrentRow[col.DisplayMember].toString(); //here taking NumPadText data from NUmpadBindingPath from CurrentRow object
            else
                this.NumPadText = "";// otherwise storing string Empty
        }
    }

    //this property maintains FooterColumn From CurrentRow Object
    //COMMON
    FooterColumn = "";

    //here this Method Will Invoke when Footer Grid Cell Edit End after lost focus from cell 
    //COMMON
    OnFooterCellEditEnding(sender: any) {
        if (!sender.column) //if sender arguments column empty returning 
            return;
        let datarow: any = sender.item; // here storing selected row object in local variable
        let Column: DgColumn = sender.column.DgCol // here storing selected column Model object in local variable

        let strBindingPaths: string = sender.column.field;// here storing selected column field in strBindingPaths local variable

        //here Cell Edit From combobox taking Binding path from Column Value Member
        if (sender.column.className == "DataGridComboBoxColumn" || sender.column.className == "DataGridPactComboBoxColumn")
            strBindingPaths = Column.ValueMember;
        else
            strBindingPaths = Column.DisplayMember;//Otherwise taking Binding path from Column Display Member

        this.FooterCellEditEnd(strBindingPaths, datarow); // here Calling FooterCellEditEnd and passing Binding Path & Selected Row Object 

        //after FooterCellEditEnd validating Footer Data if Binding path From AMount Column
        if (strBindingPaths == "CalcAmount" || strBindingPaths == "Amount") {
            this.ValidateFooterData(datarow);
        }
    }

    //here we are calling this Method From Celledit end event in FooterGrid Cell edit
    //COMMON
    public FooterCellEditEnd(strBindingPaths: string, datarow: any) {
        //here we are checking if current cell binding from ColumnName then we are adding in Datarow object initializing data from FooterDataBind Table 
        if (strBindingPaths == "ColumnName" && this.ScreenObject.FooterGridDataColumns.Contains("ColumnName") && !Util.IsEmpty(datarow["ColumnName"]) && datarow["ColumnName"].toString() != this.FooterColumn) {
            let dvFooter = this.ScreenObject.FooterDataBind.filter(x => x.ColumnName == datarow["ColumnName"].toString());
            if (dvFooter.length > 0) {
                datarow["Name"] = dvFooter[0]["Name"];
                datarow["PostingType"] = dvFooter[0]["PostingType"];
                datarow["IsCalculated"] = dvFooter[0]["IsCalculated"];
                datarow["Formula"] = dvFooter[0]["Formula"];
                datarow["Decimals"] = dvFooter[0]["Decimals"];
                datarow["DebitAccount"] = dvFooter[0]["DebitAccount"];
                datarow["DebitAccountName"] = dvFooter[0]["DebitAccountName"];
                datarow["CreditAccount"] = dvFooter[0]["CreditAccount"];
                datarow["CreditAccountName"] = dvFooter[0]["CreditAccountName"];
                datarow["BasedOnXml"] = dvFooter[0]["BasedOnXml"];
                datarow["Message"] = dvFooter[0]["Message"];
                datarow["Action"] = dvFooter[0]["Action"];
                datarow["Expression"] = dvFooter[0]["Expression"];
                datarow["ReadOnly"] = dvFooter[0]["ReadOnly"];
                datarow["IsVisible"] = dvFooter[0]["IsVisible"];

                datarow["DrRefColID"] = dvFooter[0]["DrRefColID"];
                datarow["CrRefColID"] = dvFooter[0]["CrRefColID"];

                datarow["dcCurrID"] = dvFooter[0]["CurrencyName"];
                datarow["dcCurrID_Key"] = dvFooter[0]["Currency"];

                if (this.Currency != null) {
                    let cid = this.Currency.Currency.Getvalue(Util.String(datarow["dcCurrID"]));
                    if (cid != "")
                        datarow["dcExchRT"] = this.ScreenObject.GetExchangeRate(parseInt(cid), this.DocumentDate);
                }
            }
        }

        //here we are checking FooterGridDataColumns contains Currency Column and Binding path from Currency 
        if (this.ScreenObject.FooterGridDataColumns.Contains("dcCurrID_Key") && !Util.IsEmpty(datarow["ColumnName"]) && strBindingPaths == "dcCurrID") {
            if (!Util.IsEmpty(datarow["dcCurrID_Key"]) && parseInt(datarow["dcCurrID_Key"]) > 0)
                datarow["dcExchRT"] = this.ScreenObject.GetExchangeRate(parseInt(datarow["dcCurrID_Key"]), this.DocumentDate); //here we are Calculating ExchangeRate From ScreenObject GetExchangeRate method by passing Document Date & dataRow Currency Id 
        }


        //here checking binding from Amount column cell edit then CalculateFooter with passing Data row object Otherwise -1
        if (strBindingPaths == "CalcAmount")
            this.CalculateFooter(this.ScreenObject.FooterGridData.indexOf(datarow));
        else
            this.CalculateFooter(-1);


        if (Util.String(datarow["IsCalculated"]) == "3") {
            let FooterVal = 0;
            var FCol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == Util.String(datarow["ColumnName"]));
            FooterVal = Util.Double(datarow["Amount"]);
            if (FCol != null) {
                for (let h = 0; h < this.ScreenObject.GridData.length; h++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[h]["ProductID_Key"])) {
                        this.ScreenObject.GridData[h][FCol.DisplayMember] = FooterVal;
                    }
                }
                FooterVal = Util.Double(datarow["CalcAmount"]);
                this.DistributeValues("dcCalc" + FCol.DisplayMember, FooterVal, (!Util.IsEmpty(FCol.DistributeColName)) ? FCol.DistributeColName : "Gross", true);
            }
        }
    }

    //OnCellEditCommit will invoke body cell focus lost & on Cell Edit Ending 
    //COMMON
    public OnCellEditCommit(sender: any) {
        try {
            if (this.ScreenObject == null || !sender.column) //here checking ScreenObject null & cell arguments column null returning method
                return;
            let dr: any = sender.item; // storing Selected datarow object from the arguments of celleditend 
            let Col: DgColumn = sender.column.DgCol// storing Selected Column of the Cell Column Model Object 

            //here we are checking cell editor from ComboBox and not a payrollDocument & ChequeBookNo Column exists in columnSource  
            if (sender.column.className == "DataGridPactComboBoxColumn" && (this.ScreenObject.DocumentType != 62 && this.ScreenObject.DocumentType != 63 && !this.ScreenObject.IsPayrollDocument)) {
                if (Col.DisplayMember == "ChequeBookNo" && !Util.IsEmpty(dr["ChequeBookNo"]) && dr["ChequeBookNo"].toString() != this.PrevValue
                    && this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(dr["CreditAccount_Key"])) {
                    if (this.ScreenObject.Preferences.ContainsKey("AutoChequeonPost") && this.ScreenObject.Preferences["AutoChequeonPost"] == "True") // here if AutoChequeonPost preference is enabled then return OnCellEditCommit
                        return;
                    let chkcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != null && a.DisplayMember == "ChequeNumber");
                    if (chkcol)
                        dr[chkcol.DisplayMember] = BaseService.document.GetChequeNumbers(parseInt(dr["CreditAccount_Key"]), dr["ChequeBookNo"].toString()); //here getting ChequeBookNo by calling GetChequeNumbers passing Credit account ID & Grid Selected Datarow Object
                }
                this.CalculateTotals(dr, false); //and Re Evaluating Totals And ColumnSource Formulas 
                return;
            }

            let Bindingpath = sender.column.field; //getting Binding path from Column Field  and storing local Variable Bindingpath
            let Costcnterid = 0; // local variable default value is 0

            if (sender.column.className != "DataGridComboBoxColumn") {
                Bindingpath = Col.DisplayMember; // initialize BindingPath if Editor is not a ComboBox and taking From Column Model DisplayMember
                if (sender.column.className == "DataGridPactListBoxColumn")
                    Costcnterid = Col.CostCenterID; // and assigning column CostCenterID to local variable
            }
            else if (sender.column.className == "DataGridComboBoxColumn")// && this.ScreenObject.DocumentType == 62) 
            {
                Bindingpath = sender.model.SelectedValueBinding;// "Session"; //otherwise it is Combobox assigning Binding path from Model SelectedValueBinding Property
                Costcnterid = 0;
            }

            //here checking cell Binding Path Column Exist on GridData Table and Having Data On Selected Row then We are Calling FillDefaultProd method  
            if (this.ScreenObject.GridDataColumns.Contains(Bindingpath) && !Util.IsEmpty(dr[Bindingpath]))
                this.FillDefaultProd(dr, Bindingpath); // In this Method Initializing Default Product and their Values to Data Row Object 

            //checking if DocumentType id Attendance && Time Sheet we are Calculating No Of days Hours Definition and their Calculation 
            if (this.DocumentType == 89 || this.DocumentType == 90) //Payroll - Attendance & Time Sheet
            {
                if (Bindingpath == "dcAlpha1" || Bindingpath == "dcAlpha2") { // here checking  if Selected Cell Column Binding dcAlpha1 or dcAlpha2 (Strat Date & Start Time External Fields )
                    if (Util.IsEmpty(dr["dcAlpha1"])) {
                        dr["dcAlpha2"] = null; //initializing null for StartTime (dcAlpha2) && dcAlpha2_Key
                        dr["dcAlpha2_Key"] = null;
                    }
                    else {
                        if (Util.IsEmpty(dr["dcAlpha2"])) {
                            dr["dcAlpha2"] = new Date().ToString("HH:mm");
                            dr["dcAlpha2_Key"] = new Date();
                        }
                    }
                }
                else if (Bindingpath == "dcAlpha3" || Bindingpath == "dcAlpha4") {// here checking  if Selected Cell Column Binding dcAlpha3 or dcAlpha4 (End Date & End Time External Fields )
                    if (Util.IsEmpty(dr["dcAlpha3"])) {
                        dr["dcAlpha4"] = null;//initializing null for EndTime (dcAlpha4) && dcAlpha4_Key
                        dr["dcAlpha4_Key"] = null;
                    }
                    else {
                        if (Util.IsEmpty(dr["dcAlpha4"])) {
                            dr["dcAlpha4"] = new Date().ToString("HH:mm");
                            dr["dcAlpha4_Key"] = new Date();
                        }
                    }
                }
            }
            //here We are Calling Celleditend Method by passing Data row dr, Bindingpath,and CostenterId From On CellEditCommit
            this.Celleditend(dr, Bindingpath, Costcnterid);
            //let dd=s.d.f.c;
            //After Cell Edit End Completing The dr object will change and here we are Updating Datarow to Slickgrid DataView Object By Calling updateRow Method
            this.ScreenObject.GridDataObj.updateRow(dr);
            //
            this.PoleDisplayMessage(2, dr);
            //here calling OnGridSelectionChanged Method While grid Selection Changes  Calling External purpose 
            this.OnGridSelectionChanged(sender, dr);
        } catch (error) {
            if (error.message == "PactException") {
                throw new Error("PactException");
            }
        }

    }
    //this method will invoke callParentObjMethod from Delegate
    //COMMON
    CallfromgridObj(dr) {
        this.CalculateTotals(dr, false);
    }
    //this method will initialize selected Row Deafault Product 
    //COMMON
    FillDefaultProd(dr: any, path: string) {
        if (this.IsInventoryVoucher && Util.IsEmpty(dr["ProductID_Key"])) { //here checking if Document from Inventory && empty on Product SelectedRow
            let prodcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "productid_key"); //getting Product Column from Column Source 
            if (prodcol && !Util.IsEmpty(prodcol.DefaultValue) && !Util.IsEmpty(prodcol.DefaultValueText) && Util.IsNum(prodcol.DefaultValue)) //&& parseInt(prodcol.DefaultValue) > 0 // checking if Product column has any DefaultValue 
            {
                let val = "";
                if (!Util.IsEmpty(path))
                    val = Util.String(dr[path]);

                //assigning Default Product Values From Product Column Data DefaultValueText ,ProductCode,ProductName
                let namecode: string[] = prodcol.DefaultValueText.split('\u0011');
                dr["ProductID_Key"] = prodcol.DefaultValue;
                if (this.ScreenObject.GridDataColumns.Contains("ProductCode") && namecode.length > 1)
                    dr["ProductCode"] = namecode[1];
                if (this.ScreenObject.GridDataColumns.Contains("ProductName") && namecode.length > 0)
                    dr["ProductName"] = namecode[0];
                this.ProdID = 0;
                //calling Add Product Data  method
                this.AddProductData(dr, false, false, false, null, null);
                if (!Util.IsEmpty(path))
                    dr[path] = val;
            }
        }
        else if (!this.IsInventoryVoucher && ((this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && Util.IsEmpty(dr["DebitAccount_Key"])) //otherwise Accounting Document adding Default Debit & Credit Accounts && Checking its ColumnSource Debit & Credit 
            || (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && Util.IsEmpty(dr["CreditAccount_Key"])))) {
            if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")) {
                let prodcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "creditaccount_key");
                if (prodcol && !Util.IsEmpty(prodcol.DefaultValue) && !Util.IsEmpty(prodcol.DefaultValueText) && Util.IsNum(prodcol.DefaultValue as any) && parseInt(prodcol.DefaultValue) > 0) {
                    let val = "";
                    if (!Util.IsEmpty(path))
                        val = dr[path].toString();
                    //here getting deafault Values From Column model Data & adding to Selected row data AccountCode,AccountName
                    let namecode: string[] = prodcol.DefaultValueText.split('\u0011');
                    dr["CreditAccount_Key"] = prodcol.DefaultValue;
                    if (this.ScreenObject.GridDataColumns.Contains("AccountCode") && namecode.length > 1)
                        dr["AccountCode"] = namecode[1];
                    if (this.ScreenObject.GridDataColumns.Contains("AccountName") && namecode.length > 0)
                        dr["AccountName"] = namecode[0];
                    if (!Util.IsEmpty(path))
                        dr[path] = val;
                    this.FillDefaultValues(dr);//here calling FillDefault Values Method for Reference Values fill to datarow object
                    this.ScreenObject.GridDataObj.updateRow(dr);//Updating Datarow object to Slickgrid Dataview
                }
            }
            else if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key")) {
                let prodcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "debitaccount_key");
                if (prodcol && !Util.IsEmpty(prodcol.DefaultValue) && !Util.IsEmpty(prodcol.DefaultValueText) && Util.IsNum(prodcol.DefaultValue) && parseInt(prodcol.DefaultValue) > 0) {
                    let val = "";
                    if (!Util.IsEmpty(path))
                        val = dr[path].toString();
                    //here getting deafault Values From Column model Data & adding to Selected row data AccountCode,AccountName
                    let namecode: string[] = prodcol.DefaultValueText.split('\u0011');
                    dr["DebitAccount_Key"] = prodcol.DefaultValue;
                    if (this.ScreenObject.GridDataColumns.Contains("AccountCode") && namecode.length > 1)
                        dr["AccountCode"] = namecode[1];
                    if (this.ScreenObject.GridDataColumns.Contains("AccountName") && namecode.length > 0)
                        dr["AccountName"] = namecode[0];
                    if (!Util.IsEmpty(path))
                        dr[path] = val;
                    this.FillDefaultValues(dr);//here calling FillDefault Values Method for Reference Values fill to datarow object
                    this.ScreenObject.GridDataObj.updateRow(dr);//Updating Datarow object to Slickgrid Dataview
                }
            }
        }
    }

    public SetUserLocationDivsion(dvRow: any[]) {

        let dt = this.ScreenObject.GetUserLocationDivsion();
        for (let j = 0; j < dvRow.length; j++) {
            if (Util.String(dvRow[j]["LocalReference"]) == "79" && Util.String(dvRow[j]["LinkData"]) == "7802") // Division
            {
                if (dt != null && dt.length > 0 && Util.String(dt[0]["DivisionName"]) != "" && parseInt(dt[0]["DivisionID"].toString()) > 0) {
                    if (this.ScreenObject.GridDataColumns.Contains(dvRow[j]["SysColumnName"].toString())) {
                        var item = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == Util.String(dvRow[j]["SysColumnName"]));
                        if (item != null) {
                            if (item.DataType == "TEXT") {
                                item.DefaultValue = dt[0]["DivisionName"].toString();

                            }
                            else if (item.DataType == "LISTBOX") {
                                item.DefaultValue = dt[0]["DivisionID"].toString();
                                item.DefaultValueText = dt[0]["DivisionName"].toString();
                            }
                        }
                    }
                    else {
                        let uDiv = this.ScreenObject._TextFields.find(a => a.DBColumnName == Util.String(dvRow[j]["SysColumnName"]));
                        if (uDiv != undefined && uDiv instanceof PactTextBoxData) {
                            uDiv.Text = dt[0]["DivisionName"].toString();
                            uDiv.DefaultValue = dt[0]["DivisionName"].toString();
                        }
                        if (uDiv != null && uDiv instanceof PactListBoxData) {
                            uDiv.SelectedValue = parseInt(dt[0]["DivisionID"].toString());
                            uDiv.SelectedValueText = dt[0]["DivisionName"].toString();
                            uDiv.DefaultValue = dt[0]["DivisionID"].toString();
                            uDiv.DefaultValueText = dt[0]["DivisionID"].toString();
                        }

                        uDiv = this.ScreenObject._CCFields.find(a => a.DBColumnName == dvRow[j]["SysColumnName"].toString());
                        if (uDiv != null && uDiv instanceof PactListBoxData) {
                            uDiv.SelectedValue = parseInt(dt[0]["DivisionID"].toString());
                            uDiv.SelectedValueText = dt[0]["DivisionName"].toString();
                            uDiv.DefaultValue = dt[0]["DivisionID"].toString();
                            uDiv.DefaultValueText = dt[0]["DivisionName"].toString();
                        }
                    }
                }
            }
            if (Util.String(dvRow[j]["LocalReference"]) == "79" && Util.String(dvRow[j]["LinkData"]) == "7803") // Location
            {
                if (dt != null && dt.length > 0 && Util.String(dt[0]["LocationName"]) != "" && parseInt(dt[0]["LocationID"].toString()) > 0) {
                    if (this.ScreenObject.GridDataColumns.Contains(Util.String(dvRow[j]["SysColumnName"]))) {
                        var item = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == Util.String(dvRow[j]["SysColumnName"]));
                        if (item != null) {
                            if (item.DataType == "TEXT") {
                                item.DefaultValue = dt[0]["LocationName"].toString();
                            }
                            else if (item.DataType == "LISTBOX") {
                                item.DefaultValue = dt[0]["LocationID"].toString();
                                item.DefaultValueText = dt[0]["LocationName"].toString();
                            }
                        }
                    }
                    else {
                        var uLoc = this.ScreenObject._TextFields.find(a => a.DBColumnName == dvRow[j]["SysColumnName"].toString());
                        if (uLoc != null && uLoc instanceof PactTextBoxData) {
                            uLoc.Text = dt[0]["LocationName"].toString();
                            uLoc.DefaultValue = dt[0]["LocationName"].toString();
                        }
                        if (uLoc != null && uLoc instanceof PactListBoxData) {
                            uLoc.SelectedValue = parseInt(dt[0]["LocationID"].toString());
                            uLoc.SelectedValueText = dt[0]["LocationName"].toString();
                            uLoc.DefaultValue = dt[0]["LocationID"].toString();
                            uLoc.DefaultValueText = dt[0]["LocationName"].toString();
                        }

                        uLoc = this.ScreenObject._CCFields.find(a => a.DBColumnName == dvRow[j]["SysColumnName"].toString());
                        if (uLoc != null && uLoc instanceof PactListBoxData) {
                            uLoc.SelectedValue = parseInt(dt[0]["LocationID"].toString());
                            uLoc.SelectedValueText = dt[0]["LocationName"].toString();
                            uLoc.DefaultValue = dt[0]["LocationID"].toString();
                            uLoc.DefaultValueText = dt[0]["LocationName"].toString();
                        }
                    }
                }
            }
        }
    }

    //this Method will invoke while initializing Datarow Values and thier Local Reference ,Mapped & Reverse Mapped Data
    //COMMON
    FillDefaultValues(dr: any) {
        let dt: Date;// temporary Date Variable
        let templng;
        for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++)  //here iterating Column Source to fill their Local Reference Values and their Default Values On cell Edit 
        {
            const item = this.ScreenObject.ColumnSource[i]; //here Item is Column Model Data 
            if (Util.IsEmpty(item.ID))
                continue;
            let drr: any[] = this.ScreenObject.Data.Tables[0].filter(x => x.CostCenterColID == item.ID && x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 53580); // here checking  ScreenObject.Data.Tables[0] Tables Consists of LocalReference Definition Of Column And LocalReference =79 and LinkData == 53580
            let drr1: any[] = this.ScreenObject.Data.Tables[0].filter(x => x.CostCenterColID == item.ID && x.LocalReference != null && x.LocalReference == 79 && (x.LinkData == 55496 || x.LinkData == 55495));// here  this.ScreenObject.Data.Tables[0] Tables Consists of LocalReference Definition Of Column And LocalReference =79 and LinkData 55496 or 55495

            if (item.CostCenterID > 0 && item.CostCenterID != 3 && !Util.IsEmpty(item.LocalRefDefaultValue) && Util.IsNum(item.LocalRefDefaultValue) && !Util.IsEmpty(item.ValueMember) && !Util.IsEmpty(item.LocalRefDefaultValueText)) {//here checking LocalRefDefaultValueText exists in Column Data (Item)
                //assigning LocalRefDefaultValueText to datarow 
                dr[item.DisplayMember] = item.LocalRefDefaultValueText;
                dr[item.ValueMember] = item.LocalRefDefaultValue;
                this.FillLinkRef(dr, item); //here calling FillLinkref method to fill the Referenced Data by passing datarow,item
            }
            else if (item.CostCenterID > 0 && item.CostCenterID != 3 && !Util.IsEmpty(item.DefaultValue) && !Util.IsEmpty(item.ValueMember) && Util.IsEmpty(dr[item.ValueMember]) && !Util.IsEmpty(item.DefaultValueText)) {//otherwise checking any Default Value && DefaultValueText in Column Data
                //here we are assigning default value to datarow & calling FillLinkRef
                if (Util.IsNum(item.DefaultValue)) {
                    let namecode = item.DefaultValueText.split('\u0011');
                    if (namecode.length > 1)
                        dr[item.DisplayMember] = namecode[1];
                    else if (namecode.length > 0)
                        dr[item.DisplayMember] = namecode[0];
                    dr[item.ValueMember] = item.DefaultValue;
                    this.FillLinkRef(dr, item);
                }
            }
            else if (!Util.IsEmpty(item.DefaultValue) && !Util.IsEmpty(item.ValueBinding) && item.ValueBinding.toLowerCase().Contains("dcalpha")) {//here checking Value Binding is alpha field & Default Value exists then directly assigning to its DataRow
                if (Util.IsEmpty(dr[item.ValueBinding]))
                    dr[item.ValueBinding] = item.DefaultValue;//here directly assignining colum defaultvalue datarow 
            }
            else if (!Util.IsEmpty(item.DefaultValue) && !Util.IsEmpty(item.DisplayMember) && item.DisplayMember.toLowerCase().Contains("dcalpha")) {//here checking DisplayMember is alpha field & Default Value exists then directly assigning to its DataRow
                if (Util.IsEmpty(dr[item.DisplayMember])) {//checking if datarow Displaymember value empty to fill datarow of displaymember with default values
                    if (item.DataType.toUpperCase() == "DATETIME") {//here column (item) DATETIME Object then 
                        if (!Util.IsEmpty(item.DefaultValue) && item.DefaultValue.toLowerCase() == "today") {//if DefaultValue is 'today' then 
                            dr[item.DisplayMember] = new Date().ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");//assigning datarow Displaymember to creating Util.ParseDate with DATETIME of CustomFormat From global Preferences
                            dr[item.DisplayMember + "_Key"] = new Date();//assinging datarow to Displaymember Key Value it consists Date Object 
                        }
                        else if (Util.isValidDate(item.DefaultValue)) { //
                            dr[item.DisplayMember] = dt.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                            dr[item.DisplayMember + "_Key"] = dt;
                        }
                    }
                    else if (item.DataType.toUpperCase() == "TIME") {//assigning Default Values to TIME Column if exists otherwise assigning temporary Date dt 
                        if (!Util.IsEmpty(item.DefaultValue) && item.DefaultValue.toLowerCase() == "today") {
                            dr[item.DisplayMember] = new Date().ToString("hh:mm:ss tt");
                            dr[item.DisplayMember + "_Key"] = new Date();
                        }
                        else if (Util.isValidDate(item.DefaultValue)) {
                            dr[item.DisplayMember] = dt.ToString("hh:mm:ss tt");
                            dr[item.DisplayMember + "_Key"] = dt;
                        }
                    }
                    else if (item.DataType.toUpperCase() == "TIME2") {//assigning Default Values to TIME2 Column if exists otherwise assigning temporary Date dt 
                        if (!Util.IsEmpty(item.DefaultValue) && item.DefaultValue.toLowerCase() == "today") {
                            dr[item.DisplayMember] = new Date().ToString("HH:mm");
                            dr[item.DisplayMember + "_Key"] = new Date();
                        }
                        else if (Util.isValidDate(item.DefaultValue)) {
                            dr[item.DisplayMember] = dt.ToString("HH:mm");
                            dr[item.DisplayMember + "_Key"] = dt;
                        }
                    }
                    else if (item.DataType.toUpperCase() == "DATE") {
                        if (!Util.IsEmpty(item.DefaultValue) && item.DefaultValue.toLowerCase() == "today") {//if DefaultValue is 'today' then 
                            dr[item.DisplayMember] = Date.Today().ToString(BaseService.SessionManager.Preferences["Date Format"]);//here checking DisplayMember is alpha field & Default Value exists then directly assigning to its DataRow
                            dr[item.DisplayMember + "_Key"] = Date.Today();
                        }
                        else if (Util.isValidDate(item.DefaultValue)) {
                            dr[item.DisplayMember] = dt.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            dr[item.DisplayMember + "_Key"] = dt;
                        }
                    }
                    else
                        dr[item.DisplayMember] = item.DefaultValue;
                }
            }
            else if (drr.length > 0) { //here drr length checked and which is Filtered this.ScreenObject.Data.Tables[0] on LocalReference && LinkData
                if (this.fldDict != null && Util.isValidDate(this.fldDict["ServerDate"].fieldResult)) { //checking ServerDate exists in Field Dictionary 
                    if (item.DataType == "DATE" || item.DataType == "DATETIME" || item.DataType == "TIME") { // checking DataType DATE,DATETIME,TIME assigning ServerDate Value to datarow from fldDict
                        if (item.DataType == "DATETIME")
                            dr[item.DisplayMember] = Util.ParseDate(this.fldDict["ServerDate"].fieldResult).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");
                        else if (item.DataType == "TIME")
                            dr[item.DisplayMember] = Util.ParseDate(this.fldDict["ServerDate"].fieldResult).ToString("hh:mm:ss tt");
                        else
                            dr[item.DisplayMember] = Util.ParseDate(this.fldDict["ServerDate"].fieldResult).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        if (item.DataType == "TIME") {
                            let tempdt = Util.ParseDate(this.fldDict["ServerDate"].fieldResult);
                            dr[item.DisplayMember + "_Key"] = new Date(1900, 1, 1, tempdt.getHours(), tempdt.getMinutes(), tempdt.getSeconds(), tempdt.getMilliseconds());
                        }
                        else
                            dr[item.DisplayMember + "_Key"] = Util.ParseDate(this.fldDict["ServerDate"].fieldResult);
                    }
                }
            }
            else if (drr1.length > 0) {//here drr length checked and which is Filtered this.ScreenObject.Data.Tables[0] on LocalReference && LinkData
                if (item.DataType == "DATE" || item.DataType == "DATETIME" || item.DataType == "TIME") { //here assigning Date & Time Datatype columns to todays Date from CustomFormat from Global Preferences
                    if (item.DataType == "DATETIME")
                        dr[item.DisplayMember] = new Date().ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");
                    else if (item.DataType == "TIME")
                        dr[item.DisplayMember] = new Date().ToString("hh:mm:ss tt");
                    else
                        dr[item.DisplayMember] = new Date().ToString(BaseService.SessionManager.Preferences["Date Format"]);

                    if (item.DataType == "TIME")
                        dr[item.DisplayMember + "_Key"] = new Date(1900, 1, 1, new Date().getHours(), new Date().getMinutes(), new Date().getSeconds(), new Date().getMilliseconds());
                    else
                        dr[item.DisplayMember + "_Key"] = new Date();
                }
            }
        }
    }

    //FillLinkRef this method will invoke on cell edit end to fill the reference values 
    //COMMON
    FillLinkRef(dr: any, item: DgColumn) {
        if (this.ScreenObject.Data.Tables.length > 0) {
            if (this.ScreenObject.Data.Tables[0].length > 0) {//here checking Column Definition table length greter than 0
                if (item != null && item.CostCenterID > 0) {//checking column costcenterid >0 
                    let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == item.ID);
                    if (dvCnt.length > 0 && !Util.IsEmpty(item.ValueMember) && !Util.IsEmpty(dr[item.ValueMember])) {//here column reference dvCnt >0 and ValueMember is not empty
                        this.ScreenObject.GetLinkReferenceData(parseInt(item.ID), this.DocumentID, parseInt(dr[item.ValueMember]), Date.Today(), "", item.CostCenterID, dr);//here calling GetLinkReferenceData method of Vouchergenerator by passing dr,column model data
                    }
                }
            }
        }
    }

    //#region Bins & fill batches concepts
    IsBinwise: boolean = null; IsToBinwise: boolean = null;
    IsWarehouseBinwise(Rowno: number, fromto: number, outObj: any): boolean {
        outObj.DimensionID = 0;
        let IsBinWise = true;
        let dimid = 0;
        if (BaseService.SessionManager.Preferences.ContainsKey("DimensionwiseBins") && BaseService.SessionManager.Preferences["DimensionwiseBins"].toString() != "") {
            dimid = Util.Int(BaseService.SessionManager.Preferences["DimensionwiseBins"]);
            if (dimid > 0) {
                if (dimid > 50000 && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (dimid - 50000).toString() + "_Key")) {
                    outObj.DimensionID = 1;
                    if (fromto == 1) {
                        if (this.ScreenObject.GridDataColumns.Contains("TOdcCCNID" + (dimid - 50000).toString() + "_Key")) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[Rowno]["TOdcCCNID" + (dimid - 50000).toString() + "_Key"]) && parseInt(this.ScreenObject.GridData[Rowno]["TOdcCCNID" + (dimid - 50000).toString() + "_Key"]) > 0)
                                outObj.DimensionID = parseInt(this.ScreenObject.GridData[Rowno]["TOdcCCNID" + (dimid - 50000).toString() + "_Key"]);
                        }
                        else if (!Util.IsEmpty(this.ScreenObject.GridData[Rowno]["dcCCNID" + (dimid - 50000).toString() + "_Key"]) && parseInt(this.ScreenObject.GridData[Rowno]["dcCCNID" + (dimid - 50000).toString() + "_Key"]) > 0)
                            outObj.DimensionID = parseInt(this.ScreenObject.GridData[Rowno]["dcCCNID" + (dimid - 50000).toString() + "_Key"]);
                    }
                    else if (!Util.IsEmpty(this.ScreenObject.GridData[Rowno]["dcCCNID" + (dimid - 50000).toString() + "_Key"]) && parseInt(this.ScreenObject.GridData[Rowno]["dcCCNID" + (dimid - 50000).toString() + "_Key"]) > 0)
                        outObj.DimensionID = parseInt(this.ScreenObject.GridData[Rowno]["dcCCNID" + (dimid - 50000).toString() + "_Key"]);
                    return this.ScreenObject.IsBinWise(dimid, outObj.DimensionID);
                }
                else {
                    if (fromto == 1) {
                        if (this.IsToBinwise != null) {
                            for (let i = 0; i < this.ScreenObject._CCFields.length; i++) {
                                let item = this.ScreenObject._CCFields[i];
                                if (item instanceof PactListBoxData && item.CCID == dimid) {
                                    if (item.DBColumnName.Contains("TO")) {
                                        if (item.SelectedValue > 0)
                                            outObj.DimensionID = item.SelectedValue;
                                    }
                                    else {
                                        let cfld = this.ScreenObject._CCFields.find(a => a.DBColumnName == "TO" + item.DBColumnName);
                                        if (cfld instanceof PactListBoxData) {
                                            if (cfld.SelectedValue > 0)
                                                outObj.DimensionID = cfld.SelectedValue;
                                        }
                                        else {
                                            if (item.SelectedValue > 0)
                                                outObj.DimensionID = item.SelectedValue;
                                        }
                                    }
                                    return this.IsToBinwise;
                                }
                            }
                            return this.IsToBinwise;
                        }
                        outObj.DimensionID = 1;
                        for (let i = 0; i < this.ScreenObject._CCFields.length; i++) {
                            let item = this.ScreenObject._CCFields[i]
                            if (item instanceof PactListBoxData && item.CCID == dimid) {
                                if (item.DBColumnName.Contains("TO")) {
                                    if (item.SelectedValue > 0)
                                        outObj.DimensionID = item.SelectedValue;
                                }
                                else {
                                    let cfld = this.ScreenObject._CCFields.find(a => a.DBColumnName == "TO" + item.DBColumnName);
                                    if (cfld instanceof PactListBoxData) {
                                        if (cfld.SelectedValue > 0)
                                            outObj.DimensionID = cfld.SelectedValue;
                                    }
                                    else {
                                        if (item.SelectedValue > 0)
                                            outObj.DimensionID = item.SelectedValue;
                                    }
                                }
                                this.IsToBinwise = this.ScreenObject.IsBinWise(dimid, outObj.DimensionID);
                                return this.IsToBinwise;
                            }
                        }
                    }
                    else {
                        //if (IsBinWise != null) {
                        if (this.IsBinwise != null) {
                            let fld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == dimid) as PactListBoxData;
                            if (fld)
                                outObj.DimensionID = fld.SelectedValue;

                            return this.IsBinwise;
                        }

                        outObj.DimensionID = 1;
                        for (let i = 0; i < this.ScreenObject._CCFields.length; i++) {
                            let item = this.ScreenObject._CCFields[i]
                            if (item instanceof PactListBoxData && item.CCID == dimid) {
                                if (item.SelectedValue > 0)
                                    outObj.DimensionID = item.SelectedValue;

                                this.IsBinwise = this.ScreenObject.IsBinWise(dimid, outObj.DimensionID);
                                return this.IsBinwise;
                            }
                        }
                    }
                }
            }
        }

        return IsBinWise;
    }

    GetDimValue(dimid: number, dr: any): number {
        let DimensionID = 1;
        let Exists = false;
        for (let i = 0; i < this.ScreenObject._CCFields.length; i++) {
            let item = this.ScreenObject._CCFields[i]
            if (item instanceof PactListBoxData && item.CCID == dimid) {
                if (item.SelectedValue > 0)
                    DimensionID = item.SelectedValue;
                Exists = true;
                break;
            }
        }
        if (!Exists) {
            if (dr != null && dimid > 50000 && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (dimid - 50000).toString() + "_Key")
                && !Util.IsEmpty(dr["dcCCNID" + (dimid - 50000).toString() + "_Key"]) && parseInt(dr["dcCCNID" + (dimid - 50000).toString() + "_Key"]) > 0) {
                DimensionID = parseInt(dr["dcCCNID" + (dimid - 50000).toString() + "_Key"]);
            }
        }
        return DimensionID;
    }

    GetBOEIDS(datarow: any): string {
        let InvIds = "";
        if (BaseService.SessionManager.IsActionAssigned(43, "Show only BOE Bins if fifo") && this.VoucherType == -1
            && this.ScreenObject.GridDataColumns.Contains("landingType") && Util.String(datarow["landingType"]) == "2") {
            if (!Util.IsEmpty(datarow["DocExtraXML"])) {
                let xDoc = new XmlDocument();
                xDoc.LoadXml(datarow["DocExtraXML"]);
                let xList = xDoc.SelectNodes("DocExtraXML/Row");
                for (let h = 0; h < xList.length; h++) {
                    if (xList[h].attributes["RefID"] != null && !Util.IsEmpty(xList[h].attributes["RefID"].value)) {
                        if (InvIds != "")
                            InvIds += ",";
                        InvIds += xList[h].attributes["RefID"].value;
                    }
                }
            }
            else
                InvIds += "0";

        }
        else if (BaseService.SessionManager.IsActionAssigned(43, "Show only BOE Bins") && this.VoucherType == -1
            && this.ScreenObject.GridDataColumns.Contains("landingType") && (Util.String(datarow["landingType"]) == "2" || Util.String(datarow["landingType"]) == "1")) {
            if (!Util.IsEmpty(datarow["DocExtraXML"])) {
                let xDoc = new XmlDocument();
                xDoc.LoadXml(datarow["DocExtraXML"]);
                let xList = xDoc.SelectNodes("DocExtraXML/Row");
                for (let h = 0; h < xList.length; h++) {
                    if (xList[h].attributes["RefID"] != null && !Util.IsEmpty(xList[h].attributes["RefID"].value)) {
                        if (InvIds != "")
                            InvIds += ",";
                        InvIds += xList[h].attributes["RefID"].value;
                    }
                }
            }
            else
                InvIds += "0";
        }
        return InvIds;
    }

    public AddBins(datarow: any, IsAuto: boolean, IsQtyLeave: boolean, dsbins: any, AutoAdjust: boolean = false) {
        let dtbins: any[] = null
        let dtbinsColumns: string[] = null
        if (dsbins != null) {
            dtbins = dsbins.Tables[0];
            dtbinsColumns = dsbins.Columns[0];
        }

        if (BaseService.page.DialogModel instanceof FieldCalculatorViewModel)
            return;

        if (IsQtyLeave && this.ScreenObject.GridDataColumns.Contains("landingType")
            && (Util.String(datarow["landingType"]) == "1" || Util.String(datarow["landingType"]) == "2")) {
            if (BaseService.page.DialogModel instanceof DocBinsViewModel)
                return;
            BaseService.page.ShowDialog(new FieldCalculatorViewModel(this, 2), FieldCalculatorComponent);
            return;
        }

        let qty = 0;
        if ((this.ScreenObject.Preferences.ContainsKey("ExcludeHoldBins") && this.ScreenObject.Preferences["ExcludeHoldBins"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["ExcludeHoldBins"]))
            && (this.ScreenObject.GridDataColumns.Contains("ReserveQuantity") || this.ScreenObject.GridDataColumns.Contains("HoldQuantity"))) {
            if (this.ScreenObject.GridDataColumns.Contains("ReserveQuantity")) {
                let holdcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "ReserveQuantity");
                if (holdcol && !Util.IsEmpty(holdcol.Formula))
                    this.CalculateTotals(datarow, false);

                if (!Util.IsEmpty(datarow["ReserveQuantity"]) && parseFloat(datarow["ReserveQuantity"]) > 0)
                    qty = parseFloat(datarow["ReserveQuantity"]);
            }
            if (this.ScreenObject.GridDataColumns.Contains("HoldQuantity")) {
                let holdcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "HoldQuantity");
                if (holdcol && !Util.IsEmpty(holdcol.Formula))
                    this.CalculateTotals(datarow, false);

                if (!Util.IsEmpty(datarow["HoldQuantity"]) && parseFloat(datarow["HoldQuantity"]) > 0)
                    qty = parseFloat(datarow["HoldQuantity"]);
            }
        }
        else if ((this.ScreenObject.Preferences.ContainsKey("ShowBins") && this.ScreenObject.Preferences["ShowBins"] != "" && parseBoolean(this.ScreenObject.Preferences["ShowBins"]))
            || !this.DonotUpdateInventory) {
            if (!Util.IsEmpty(datarow["SchemeID"]) && parseInt(datarow["SchemeID"]) > 0
                && datarow["IsScheme"].toString() == "Y" && this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(datarow["FreeQTY"]))
                qty = parseFloat(datarow["FreeQTY"]);
            else
                qty = parseFloat(datarow["Quantity"]);

            if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && !Util.IsEmpty(datarow["UOMConversion"]))
                qty = qty * parseFloat(datarow["UOMConversion"]);

        }

        if (qty == 0)
            return;

        if (this.ScreenObject.DocumentType == 30) {
            if (this.ScreenObject.GridDataColumns.Contains("VoucherType") && !Util.IsEmpty(datarow["VoucherType"]))
                this.VoucherType = parseInt(datarow["VoucherType"]);
            else
                this.VoucherType = 0;
        }

        if (this.VoucherType != 0) {
            if (qty > 0) {
                let DimensionID = 0, dimid = 0, DimNodeID = 0, dimccid = 0, DocDetailsId = 0;

                if (BaseService.SessionManager.Preferences.ContainsKey("DimensionwiseBins") && BaseService.SessionManager.Preferences["DimensionwiseBins"].toString() != "") {
                    dimid = Util.Int(BaseService.SessionManager.Preferences["DimensionwiseBins"]);
                    if (dimid > 0)
                        DimensionID = this.GetDimValue(dimid, datarow);
                }

                if (this.ScreenObject.Preferences.ContainsKey("BinFilterDim") && this.ScreenObject.Preferences["BinFilterDim"].toString() != "") {
                    dimccid = Util.Int(this.ScreenObject.Preferences["BinFilterDim"]);
                    if (dimccid > 0)
                        DimNodeID = this.GetDimValue(dimccid, datarow);
                }

                if (!Util.IsEmpty(datarow["DocDetailsID"]))
                    DocDetailsId = parseInt(datarow["DocDetailsID"]);

                if (!(!IsAuto && dimid > 50000 && !this.ScreenObject.IsBinWise(dimid, DimensionID))) {
                    let Linkedinvid = 0;

                    let batchid = 0, RefInvID = 0;
                    if (this.VoucherType == -1 && Util.String(datarow["Type"]) == "5" && Util.String(datarow["ExtraXML"]) != "") {
                        let xDoc = new XmlDocument();
                        xDoc.LoadXml(datarow["ExtraXML"].toString());
                        let xList = xDoc.SelectNodes("xml/Row");

                        if (xList.length > 0 && xList[0].attributes["BatchID"] != null)
                            batchid = parseInt(xList[0].attributes["BatchID"].value);
                        if (xList.length > 0 && xList[0].attributes["RefInvID"] != null && !Util.IsEmpty(xList[0].attributes["RefInvID"].value))
                            RefInvID = parseInt(xList[0].attributes["RefInvID"].value);
                    }

                    if (this.VoucherType == -1 && !Util.IsEmpty(datarow["LinkedInvDocDetailsID"]))
                        Linkedinvid = Util.Int(datarow["LinkedInvDocDetailsID"]);

                    let dsBins = this.ScreenObject.GetProductwiseBins(parseInt(datarow["ProductID_Key"]), this.ScreenObject.DocID, this.VoucherType, this.DocumentDate, dimid, DimensionID, dimccid, DimNodeID, Linkedinvid, batchid, RefInvID, this.GetBOEIDS(datarow),datarow);

                    let bins = new DocBinsViewModel(this, this.VoucherType, qty, parseInt(datarow["ProductID_Key"]), datarow["ProductName"].toString(), dsBins, datarow, batchid, RefInvID)
                    {
                        if (AutoAdjust) {
                            bins.ChkFifo = true;
                            bins.OnSave("AutoSave");
                        }
                        else if (this.ScreenObject.Preferences.ContainsKey("AutoSelectBins") && this.ScreenObject.Preferences["AutoSelectBins"].toLowerCase() == "true"
                            && dsBins != null && dsBins.Tables.length > 0 && dsBins.Tables[0].length == 1 && bins.BinsGrid.Table.length > 0) {
                            bins.BinsGrid.Table[0]["Allocate"] = qty;
                            bins.celledtiend(bins.BinsGrid.Table[0]);
                            bins.DisplayMessage = "";
                            bins.OnSave("AutoSave");
                            if (bins.DisplayMessage != "" && !IsAuto)
                                BaseService.page.ShowDialog(bins, DocBinsComponent);
                        }
                        else if (dtbins != null) {
                            for (let k = 0; k < dtbins.length; k++) {
                                let actualbin;
                                if (dtbinsColumns.Contains("InvDocDetailsID") && bins.BinsGrid.TableColumns.Contains("InvID"))
                                    actualbin = bins.BinsGrid.Table.filter(x => x.NodeID == dtbins[k]["BinID"] && x.InvID == dtbins[k]["InvDocDetailsID"]);
                                else
                                    actualbin = bins.BinsGrid.Table.filter(x => x.NodeID == dtbins[k]["BinID"]);
                                if (actualbin.length > 0 && qty > 0) {
                                    if (qty > parseFloat(dtbins[k]["Quantity"])) {
                                        actualbin[0]["Allocate"] = dtbins[k]["Quantity"].toString();
                                        bins.celledtiend(bins.BinsGrid.Table[0]);

                                        qty -= parseFloat(dtbins[k]["Quantity"]);
                                    }
                                    else {
                                        actualbin[0]["Allocate"] = qty;
                                        bins.celledtiend(bins.BinsGrid.Table[0]);
                                        qty = 0;
                                    }
                                }
                            }
                            bins.OnSave("AutoSave");
                        }
                        else
                            BaseService.page.ShowDialog(bins, DocBinsComponent);
                    }
                }
                else if (this.ScreenObject.DocumentType == 5 && !this.ScreenObject.GridDataColumns.Contains("RecievedQty")) {
                    if (dimid > 0) {
                        this.AddToWarehouseBins(dimid, datarow, qty, IsAuto);
                    }
                }
                //#region stocktransferbins

                //if (this.ScreenObject.DocumentType == 5 && !this.ScreenObject.GridDataColumns.Contains("RecievedQty"))
                //{
                //    if (dimid > 0)
                //    {
                //        DimensionID = 1;
                //        Exists = false;
                //        foreach (let item in this.ScreenObject._CCFields)
                //        {
                //            if (item instanceof PactListBoxData && item.CCID == dimid)
                //            {
                //                if (item.DBColumnName.Contains("TO"))
                //                {
                //                    if (item.SelectedValue > 0)
                //                        DimensionID = item.SelectedValue;
                //                }
                //                else
                //                {
                //                    let cfld = this.ScreenObject._CCFields.find(a => a.DBColumnName == "TO" + item.DBColumnName);
                //                    if (cfld)
                //                    {
                //                        if (cfld.SelectedValue > 0)
                //                            DimensionID = cfld.SelectedValue;
                //                    }
                //                    else
                //                    {
                //                        if (item.SelectedValue > 0)
                //                            DimensionID = item.SelectedValue;
                //                    }
                //                }
                //                Exists = true;
                //                break;
                //            }
                //        }
                //        if (!Exists)
                //        {
                //            if (SelectedRow != null && dimid > 50000 && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (dimid - 50000).toString() + "_Key"))
                //            {
                //                if (this.ScreenObject.GridDataColumns.Contains("TOdcCCNID" + (dimid - 50000).toString() + "_Key"))
                //                {
                //                    if (!Util.IsEmpty(datarow["TOdcCCNID" + (dimid - 50000).toString() + "_Key"]) && parseInt(datarow["TOdcCCNID" + (dimid - 50000).toString() + "_Key"]) > 0)
                //                        DimensionID = parseInt(datarow["TOdcCCNID" + (dimid - 50000).toString() + "_Key"]);
                //                }
                //                else if (!Util.IsEmpty(datarow["dcCCNID" + (dimid - 50000).toString() + "_Key"]) && parseInt(datarow["dcCCNID" + (dimid - 50000).toString() + "_Key"]) > 0)
                //                    DimensionID = parseInt(datarow["dcCCNID" + (dimid - 50000).toString() + "_Key"]);
                //            }
                //        }
                //    }

                //    if (datarow["TODocDetailsID"] != null && !Util.IsEmpty(datarow["TODocDetailsID"]))
                //        DocDetailsId = parseInt(datarow["TODocDetailsID"]);

                //    if (!IsAuto && dimid > 50000 && !this.ScreenObject.IsBinWise(parseInt(dimid), DimensionID))
                //        return;
                //    DataSet dsBins = this.ScreenObject.GetProductwiseBins(parseInt(datarow["ProductID_Key"]), DocDetailsId, this.ScreenObject.DocID, 1, DocumentDate, dimid, DimensionID, 0, 0);

                //    using (DocBinsViewModel bins = new DocBinsViewModel(this, 1, qty, parseInt(datarow["ProductID_Key"]), datarow["ProductName"].toString(), dsBins))
                //    {
                //        if (this.ScreenObject.Preferences.ContainsKey("AutoSelectBins") && this.ScreenObject.Preferences["AutoSelectBins"].toLowerCase() == "true"
                //           && dsBins != null && dsBins.Tables.length > 0 && dsBins.Tables[0].length == 1 && bins.BinsGrid.Table.length > 0)
                //        {
                //            bins.BinsGrid.Table[0]["Allocate"] = qty;
                //            bins.celledtiend(bins.BinsGrid.Table[0]);
                //            bins.DisplayMessage = "";
                //            bins.OnSave("AutoSave");
                //            if (bins.DisplayMessage != "" && !IsAuto)
                //                ShellWindowViewModel.Instance().PopViewModel = bins;
                //        }
                //        else
                //            ShellWindowViewModel.Instance().PopViewModel = bins;
                //    }
                //}
                //#endregion
            }
        }
    }

    AddToWarehouseBins(dimid: number, datarow: any, qty: number, IsAuto: boolean) {
        let DimensionID = 1; let Exists = false; let DocDetailsId = 0, DimNodeID = 0, dimccid = 0;
        if (dimid == 0)
            DimensionID = 0;
        if (dimid > 0) {
            for (let i = 0; i < this.ScreenObject._CCFields.length; i++) {
                let item = this.ScreenObject._CCFields[i]
                if (item instanceof PactListBoxData && item.CCID == dimid) {
                    if (item.DBColumnName.Contains("TO")) {
                        if (item.SelectedValue > 0)
                            DimensionID = item.SelectedValue;
                    }
                    else {
                        let cfld = this.ScreenObject._CCFields.find(a => a.DBColumnName == "TO" + item.DBColumnName);
                        if (cfld instanceof PactListBoxData) {
                            if (cfld.SelectedValue > 0)
                                DimensionID = cfld.SelectedValue;
                        }
                        else {
                            if (item.SelectedValue > 0)
                                DimensionID = item.SelectedValue;
                        }
                    }
                    Exists = true;
                    break;
                }
            }
            if (!Exists) {
                if (datarow != null && dimid > 50000 && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (dimid - 50000).toString() + "_Key")) {
                    if (this.ScreenObject.GridDataColumns.Contains("TOdcCCNID" + (dimid - 50000).toString() + "_Key")) {
                        if (!Util.IsEmpty(datarow["TOdcCCNID" + (dimid - 50000).toString() + "_Key"]) && parseInt(datarow["TOdcCCNID" + (dimid - 50000).toString() + "_Key"]) > 0)
                            DimensionID = parseInt(datarow["TOdcCCNID" + (dimid - 50000).toString() + "_Key"]);
                    }
                    else if (!Util.IsEmpty(datarow["dcCCNID" + (dimid - 50000).toString() + "_Key"]) && parseInt(datarow["dcCCNID" + (dimid - 50000).toString() + "_Key"]) > 0)
                        DimensionID = parseInt(datarow["dcCCNID" + (dimid - 50000).toString() + "_Key"]);
                }
            }
        }

        if (this.ScreenObject.Preferences.ContainsKey("BinFilterDim") && this.ScreenObject.Preferences["BinFilterDim"].toString() != "") {
            dimccid = Util.Int(this.ScreenObject.Preferences["BinFilterDim"]);
            if (dimccid > 0)
                DimNodeID = this.GetDimValue(dimccid, datarow);
        }

        if (!(dimid > 50000 && !this.ScreenObject.IsBinWise(dimid, DimensionID))) {
            if (!Util.IsEmpty(datarow["TODocDetailsID"]))
                DocDetailsId = parseInt(datarow["TODocDetailsID"]);

            let dsBins: any = this.ScreenObject.GetProductwiseBins(parseInt(datarow["ProductID_Key"]), this.ScreenObject.DocID, 1, this.DocumentDate, dimid, DimensionID, dimccid, DimNodeID, 0, 0, 0, this.GetBOEIDS(datarow),datarow);
            let bins = new DocBinsViewModel(this, 1, qty, parseInt(datarow["ProductID_Key"]), datarow["ProductName"].toString(), dsBins, datarow)
            {
                if (this.ScreenObject.Preferences.ContainsKey("AutoSelectBins") && this.ScreenObject.Preferences["AutoSelectBins"].toLowerCase() == "true"
                    && dsBins != null && dsBins.Tables.length > 0 && dsBins.Tables[0].length == 1 && bins.BinsGrid.Table.length > 0) {
                    bins.BinsGrid.Table[0]["Allocate"] = qty;
                    bins.celledtiend(bins.BinsGrid.Table[0]);
                    bins.DisplayMessage = "";
                    bins.OnSave("AutoSave");
                    if (bins.DisplayMessage != "" && !IsAuto)
                        BaseService.page.ShowDialog(bins, DocBinsComponent);
                }
                else
                    BaseService.page.ShowDialog(bins, DocBinsComponent);
            }
        }
    }

    fillbatches(datarow: any, fldName: string = "", AjustFifo: boolean = false) {
        if (this.ScreenObject.Preferences.ContainsKey("SameBatchtoall") && this.ScreenObject.Preferences["SameBatchtoall"].toLowerCase() == "true")
            return;

        if (this.ScreenObject.Preferences.ContainsKey("BatchBasedon") && this.ScreenObject.Preferences["BatchBasedon"] != "") {
            if (this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["BatchBasedon"]) && datarow[this.ScreenObject.Preferences["BatchBasedon"]].toString() == "1")
                return;
            let txtfld = this.ScreenObject._TextFields.find(a => a instanceof PactTextBoxData && a.DBColumnName.toLowerCase() == this.ScreenObject.Preferences["BatchBasedon"].toLowerCase());
            if (txtfld && (txtfld as PactTextBoxData).Text == "1")
                return;
        }

        let vtype = this.VoucherType;

        if (this.ScreenObject.DocumentType == 38 && !Util.IsEmpty(datarow["Quantity"]) && parseFloat(datarow["Quantity"].toString()) < 0)
            vtype = 1;

        if (this.ScreenObject.DocumentType == 30) {
            if (this.ScreenObject.GridDataColumns.Contains("VoucherType") && !Util.IsEmpty(datarow["VoucherType"]))
                vtype = parseInt(datarow["VoucherType"]);
            else
                vtype = 0;
        }

        let VarFldName = "";
        if (this.DocumentType == 32) {
            vtype = 0;
            let fld = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["VarienceField"]);
            if (fld)
                VarFldName = fld.DisplayMember;

            if (VarFldName != "" && !Util.IsEmpty(datarow[VarFldName])) {
                if (parseFloat(datarow[VarFldName]) < 0)
                    vtype = -1;
                else if (parseFloat(datarow[VarFldName]) > 0)
                    vtype = 1;
            }
        }
        else if (this.DocumentType == 31 && fldName != "") {
            vtype = 1;
            VarFldName = fldName;
        }

        let Ds: any = null;
        if (vtype == -1) {
            let DetailsID = 0;
            if (!Util.IsEmpty(datarow["DocDetailsID"]))
                DetailsID = parseInt(datarow["DocDetailsID"]);

            if (BaseService.SessionManager.Preferences.ContainsKey("Maintain Dimensionwise Batches") && BaseService.SessionManager.Preferences["Maintain Dimensionwise Batches"].toString() != "") {
                let tempin = 0;
                if (Util.Int(BaseService.SessionManager.Preferences["Maintain Dimensionwise Batches"].toString()) > 0) {
                    tempin = parseInt(BaseService.SessionManager.Preferences["Maintain Dimensionwise Batches"].toString());
                    let fld: any = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == tempin);
                    if (fld != undefined) {
                        if (fld.SelectedValue < 1) {
                            this.DisplayMessage = BaseService.GetResource("Select") + " " + fld.Label;
                            this.MessageVisibility = true;
                            return;
                        }
                    }
                    else {
                        if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (tempin - 50000).toString() + "_Key")) {
                            if (datarow["dcCCNID" + (tempin - 50000).toString() + "_Key"].toString() == "") {
                                var col = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == tempin);
                                if (col != undefined) {
                                    this.DisplayMessage = BaseService.GetResource("Select") + " " + col.Header;
                                    this.MessageVisibility = true;
                                    return;
                                }
                            }
                        }
                    }
                }
            }
            Ds = this.ScreenObject.GetProductwiseBatches(parseInt(datarow["ProductID_Key"]), DetailsID, vtype, datarow, 0, false);
            if (Ds != null && Ds.Tables.length > 0) {
                if (Ds.Tables.length > 1 && Ds.Tables[1].length > 0 && Ds.Columns[1].Contains("ErrorMessage")) {
                    this.DisplayMessage = Ds.Tables[1][0]["ErrorMessage"].toString();
                    return;
                }
                if (Ds.Tables[0].length > 0 && Ds.Columns[0].Contains("BalQty")) {
                }
                else {
                    this.DisplayMessage = BaseService.GetResource("Batch_PrdNoBtch").toString();
                    return;
                }
            }
            else {
                this.DisplayMessage = BaseService.GetResource("Batch_PrdNoBtch").toString();
                return;
            }
        }
        let div = 0, loc = 0;

        if (this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])) {
            let ccfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
            if (ccfld && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0)
                loc = ccfld.SelectedValue;
            else if (datarow != null && !Util.IsEmpty(datarow["dcCCNID2_Key"]))
                loc = parseInt(datarow["dcCCNID2_Key"]);
        }
        else if (this.ScreenObject.LocationID > 0)
            loc = this.ScreenObject.LocationID;
        else
            loc = BaseService.SessionManager.LocationID;
        if (this.ScreenObject.DivisionID > 0)
            div = this.ScreenObject.DivisionID;
        else
            div = BaseService.SessionManager.DivisionID;
        if (vtype != 0) {
            let qty: any = 0;
            if (VarFldName != "" && !Util.IsEmpty(datarow[VarFldName])) {
                qty = parseFloat(datarow[VarFldName].toString().replace("-", ""));
            }
            else {
                if (!Util.IsEmpty(datarow["SchemeID"]) && parseInt(datarow["SchemeID"]) > 0
                    && datarow["IsScheme"].toString() == "Y" && this.ScreenObject.GridDataColumns.Contains("FreeQTY") && !Util.IsEmpty(datarow["FreeQTY"]))
                    qty = parseFloat(datarow["FreeQTY"]);
                else
                    qty = parseFloat(datarow["Quantity"]);

                let Qtycol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Quantity");
                if (Qtycol != undefined && !Util.IsEmpty(Qtycol.DecimalPoints))
                    qty = parseFloat(qty.ToString("N" + Qtycol.DecimalPoints));
            }

            if (!Util.IsEmpty(datarow["UOMConversion"]))
                qty = qty * parseFloat(datarow["UOMConversion"]);
            if (this.ScreenObject.DocumentType == 38 && !Util.IsEmpty(datarow["Quantity"]) && parseFloat(datarow["Quantity"].toString()) < 0)
                qty = qty * -1;
            if (this.ScreenObject.Preferences.ContainsKey("ExcludeHold") && !Util.IsEmpty(this.ScreenObject.Preferences["ExcludeHold"]) && parseBoolean(this.ScreenObject.Preferences["ExcludeHold"])
                && this.ScreenObject.GridDataColumns.Contains("HoldQuantity")) {
                let holdcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "HoldQuantity");
                if (holdcol && !Util.IsEmpty(holdcol.Formula))
                    this.CalculateTotals(datarow, false);

                if (!Util.IsEmpty(datarow["HoldQuantity"]) && parseFloat(datarow["HoldQuantity"]) > 0)
                    qty = parseFloat(datarow["HoldQuantity"]);
                else
                    qty = 0;
            }

            if (this.ScreenObject.Preferences.ContainsKey("ExcludeReserve") && this.ScreenObject.Preferences["ExcludeReserve"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["ExcludeReserve"])
                && this.ScreenObject.GridDataColumns.Contains("ReserveQuantity")) {
                let holdcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "ReserveQuantity");
                if (holdcol && !Util.IsEmpty(holdcol.Formula))
                    this.CalculateTotals(datarow, false);

                if (!Util.IsEmpty(datarow["ReserveQuantity"]) && parseFloat(datarow["ReserveQuantity"]) > 0)
                    qty = parseFloat(datarow["ReserveQuantity"]);
                else
                    qty = 0;
            }
            if (vtype == -1 && this.DocumentType != 31 && this.DocumentType != 32 && Ds.Tables[0].length > 0 && Ds.Columns[0].Contains("BalQty")) {
                var tot = Ds.Tables[0].Compute("sum", "BalQty");
                if (tot != null) {
                    tot = parseFloat(tot).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinQty"]);
                    qty = parseFloat(parseFloat(qty).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinQty"]));
                    if (parseFloat(tot) < qty) {
                        this.DisplayMessage = "Allocated batch quantity is less than document quantity.";
                        this.MessageVisibility = true;
                        return;
                    }
                }
            }
            if (qty > 0 || (this.ScreenObject.Preferences.ContainsKey("QtyonBatch") && this.ScreenObject.Preferences["QtyonBatch"] != "" && parseBoolean(this.ScreenObject.Preferences["QtyonBatch"]))) {
                let batch = new BatchNumberViewModel(this.ScreenObject.GridDataObj)
                batch.BatchNumberViewModel_4(this, vtype, qty, Ds, parseInt(datarow["ProductID_Key"]), datarow["ProductName"].toString(), loc, div, VarFldName, datarow)
                {
                    if (AjustFifo) {
                        batch.AdjusFifo(true);
                        batch.OnSave("AutoSave");
                    }
                    else if (qty > 0 && this.ScreenObject.Preferences.ContainsKey("Autobatchifsingle") && parseBoolean(this.ScreenObject.Preferences["Autobatchifsingle"])
                        && Ds.Tables[0].length == 1 && fldName == "") {
                        batch.AdjusFifo(true);
                        batch.OnSave("AutoSave");
                        if (batch.count > 1)
                            this.ScreenObject.UpdateSequence();
                    }
                    else
                        BaseService.page.ShowDialog(batch, BatchNumberComponent).subscribe(() => {
                            if (batch.count > 1)
                                this.ScreenObject.UpdateSequence();
                        });
                }
            }
            //if (batch.count > 1)
            //{
            //    bool schemes = false;
            //    if (this.ScreenObject.Preferences.ContainsKey("EnableSchemes") && parseBoolean(this.ScreenObject.Preferences["EnableSchemes"], out schemes))
            //        schemes = parseBoolean(this.ScreenObject.Preferences["EnableSchemes"]);
            //    if (schemes)
            //    {
            //        string GrossFld = "GROSS";
            //        if (this.ScreenObject.Preferences.ContainsKey("SchemesNumericFields") && this.ScreenObject.Preferences["SchemesNumericFields"] != "")
            //        {
            //            let Col = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["SchemesNumericFields"]);
            //            if (Col   && Col.DisplayMember != "")
            //                GrossFld = Col.DisplayMember;
            //        }

            //        int index = 0;
            //        if (datarow != null)
            //            index = this.ScreenObject.GridData.indexOf(datarow);

            //        for(let i = 1; i < batch.count; i++)
            //        {
            //            index = index + i;
            //            if (i == 1)
            //            {
            //                DataSet ds = this.ScreenObject.GetSchemes(DocumentDate, this.ScreenObject.GridData[index]);
            //                if (ds.Tables.length > 0 && ds.Columns[0].Contains("SchemeID"))
            //                    fillSchemevalues(ref DtTempSchemes, ds.Tables[0], this.ScreenObject.GridData[index]);
            //            }
            //            ApplySchemes(this.ScreenObject.GridData[index]);
            //        }
            //    }
            //}
        }

    }
    GetExcRate(dr)
   {
       if (this.Currency != null && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
           return this.Currency.ExchangeRate.Textd;
       else if (this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && dr != null && Util.String(dr["ExchangeRate"]) != "")
           return parseFloat(dr["ExchangeRate"].toString());

       return 1;
   }
    //#endregion
    public dsProjWOffHol: any = null;

    //this method will invoke from Oncelleditend the main functionality of the grid on edit end of the Datagrid Body object,  arguments of grid are datarow,CostCenterID,CallType,strBindingPaths
    //COMMON
    async Celleditend(datarow: any, strBindingPaths: string, CostCenterID: number, CallType: number = 0) {
        try {
            let Temppath: string = strBindingPaths; // storing local variable of string  Temppath of strBindingPaths it is a Column Databinding property
            let strValidationMsg = ""; //strValidationMsg taking local variable and initialized with empty string
            Logger.InfoLog("AddEditDocumentViewModel::Entering OnCellEditEnding");

            let CurrID = 1; let ExhgRate = this.GetExcRate(datarow); //here taking currency ID && Exchange Rate ID local variables and  setting Default values 
            if (this.Currency && this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue != "") //if PACTCurrencyData SelectedValue is not empty then assigning currID from PACTCurrencyData object && if not exists then Checking GRIDCOlumns and assigning to it
                CurrID = parseInt(this.Currency.Currency.SelectedValue);
            else if (this.ScreenObject.GridDataColumns.Contains("CurrencyID") && !Util.IsEmpty(datarow["CurrencyID_Key"]))
                CurrID = parseInt(datarow["CurrencyID_Key"]);
            if (this.Currency && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
                ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
            else if (this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && !Util.IsEmpty(datarow["ExchangeRate"]))//if PACTCurrencyData ExchangeRate is not empty then assigning currID from PACTCurrencyData ExchangeRate object && if not exists then Checking GRIDCOlumns and assigning to it
                ExhgRate = parseFloat(datarow["ExchangeRate"]);

            //Budget Annual Amount Distribute
            //if  Preferce BudgetAnnualAmount is Enabled in Document && strBindingPaths is Equal to BudgetAnnualAmount then will calculate 
            if (this.ScreenObject.Preferences.ContainsKey("BudgetAnnualAmount") && this.ScreenObject.Preferences["BudgetAnnualAmount"] == strBindingPaths) {
                if (this.ScreenObject.Preferences["BudgetType"] != "0") { // here Checking BudgetType From Document Preferences ,1,2 and assigning iBudCnt to 12 by default 
                    let iBudCnt = 12;
                    if (this.ScreenObject.Preferences["BudgetType"] == "1") // if BudgetType is 1 then assignig iBudCnt to 2
                        iBudCnt = 2;
                    else if (this.ScreenObject.Preferences["BudgetType"] == "2")// if BudgetType is 2 then assignig iBudCnt to 4
                        iBudCnt = 4;
                    let tempdbl = 0, prevtempdbl = 0;// taking 2 temporary variables 
                    tempdbl = Util.Double(datarow[strBindingPaths]); // assigning tempdbl and taking from datatrow value 
                    prevtempdbl = Util.Double(this.PrevValue); // assigning prevtempdbl and taking from previous data value 
                    if (tempdbl != prevtempdbl) { // and checking previous value tempdbl value not equal thrn 
                        let disttot = 0;// taking Distribute total amount local variable 
                        let distamt = parseFloat((tempdbl / iBudCnt).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));// taking distamt distributed amount tempdbl/iBudCnt assigning local variable
                        for (let i = 1; i < iBudCnt; i++) {// initializing variable iBudCnt
                            datarow[this.ScreenObject.Preferences["BudgetField" + i]] = distamt; //and adding to data row to every period of amount in BudgetFields slab wise (iBudCnt)
                            if (this.ScreenObject.Preferences["BudgetField" + i].startsWith("dcNum"))
                                datarow["dcCalc" + this.ScreenObject.Preferences["BudgetField" + i]] = distamt;//and adding to data row to every period of amount in dcCalc BudgetFields slab wise (iBudCnt)
                            disttot += distamt;// and adding to disttot amount 
                        }
                        datarow[this.ScreenObject.Preferences["BudgetField" + iBudCnt]] = parseFloat((tempdbl - disttot).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));//here adding datarow to BudgetField+"iBudCnt" amount which is added in Datarow of Column tempdbl - amount which is Distributed Total disttot
                        if (this.ScreenObject.Preferences["BudgetField" + iBudCnt].startsWith("dcNum")) //if BudgetField start with dcNum Numeric column 
                            datarow["dcCalc" + this.ScreenObject.Preferences["BudgetField" + iBudCnt]] = distamt; //adding to dcCalc of the Field
                    }
                }
                return; // otherwise returning if BudgetType is 0
            }

            //taking Column model data from Column Source which Cell Emitted data filtering from Column source and assigning it to  col local variable 
            let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == strBindingPaths);

            if (!col && strBindingPaths)// checking Binding Paths of the column is not empty and it exists then 
                col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Name" && a.ValueBinding == strBindingPaths); // and taking if Display member is Name then re assigning it col

            //here checking Document From DocumentTyep DailyAttendance=67,RecordingOfData = 68 ,CheckList=70,Dues Entry=80
            if (this.ScreenObject.DocumentType == 68 || this.ScreenObject.DocumentType == 70 || this.ScreenObject.DocumentType == 80 || this.ScreenObject.DocumentType == 67) {
                if (strBindingPaths && strBindingPaths.endsWith("_Key")) {//checking binding path ending _Key 
                    strBindingPaths = strBindingPaths.replace("_Key", ""); // then replacing with empty string 
                    col = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == strBindingPaths) // taking col from columnsource with updated bindingPath strBindingPaths 
                }

                if (this.ScreenObject.DocumentType == 70 || this.ScreenObject.DocumentType == 67)
                    this.FillDefaultValues(datarow); // it is from  DailyAttendance or CheckList document calling Fill DefaultValues of the Columns 
            }

            if (strBindingPaths == "ProductName" || strBindingPaths == "ProductCode") {// if strBindingPaths consists of ProductName or ProductCode
                strBindingPaths = "ProductID"; // assigning PRODUCTID to strBindingPaths

            }
            if (strBindingPaths == "DueDate" && this.ScreenObject.DocumentType == 31 && !Util.IsEmpty(datarow["DueDate_Key"])) { // if cell edit from DueDate and selected DueDate not empty  
                let dsqoh: any = this.GetProductValues(datarow, 0); // and getting Product Values from GetProductValues  and assigning to its datarow like QOH,AverageRate,UOM...etc
            }

            //#region commentedHoldReserveQtyValidation

            //if ((strBindingPaths == "HoldQuantity" || strBindingPaths == "ReserveQuantity") && !Util.IsEmpty(datarow[strBindingPaths]) && parseFloat(datarow[strBindingPaths]) > 0)
            //{
            //    double tempQty = 0;
            //    Util.Double(datarow["Quantity"].toString(), out tempQty);
            //    if (tempQty < parseFloat(datarow[strBindingPaths]))
            //    {
            //        datarow[strBindingPaths] = tempQty;
            //        DisplayMessage = col.Header + " can not be greater than qty.";
            //        
            //    }
            //    tempQty = 0;
            //    Util.Double(datarow["QOH"].toString(), out tempQty);
            //    if (tempQty < parseFloat(datarow[strBindingPaths]))
            //    {
            //        datarow[strBindingPaths] = tempQty;
            //        DisplayMessage = col.Header + " can not be greater than qty on hand";
            //        
            //    }
            //}

            //#endregion

            if (strBindingPaths == "Quantity") {//checking cell Binding (strBindingPaths) is on Quantity
                //here we are checking if datarow of quantity not empty and Grid Columns Contains ProductID_Key and Preference is Enabled DuplicateProduct_IncrementQuantity
                if (!Util.IsEmpty(datarow["Quantity"]) && this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && this.ScreenObject.Preferences.ContainsKey("DuplicateProduct_IncrementQuantity") && this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"] != "" && parseBoolean(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"])
                    && !Util.IsEmpty(datarow["ProductID_Key"]) && parseInt(datarow["ProductID_Key"]) != this.ScreenObject.TempProductID
                    && (Util.IsEmpty(datarow["LinkedInvDocDetailsID"]) || datarow["LinkedInvDocDetailsID"].toString() == "0")) {
                    this.AddProductQty(datarow, true);//then we are adding duplicate product Incrementing Quantity and checking Club Products preference Enabled Functionality will also execute
                }

                if (!Util.IsEmpty(datarow["Quantity"]) && !Util.IsEmpty(datarow["UOMConversion"]) && Util.IsNum(datarow["UOMConversion"])) {//here checking UOMConversion  is not empty and Calculating UOMConverted Quantity 
                    datarow["UOMConvertedQty"] = Util.Double(datarow["UOMConversion"]) * parseFloat(datarow["Quantity"]);//here calculating UOMConverted Quantity based on UOMConversion * Quantity
                }
                else if (!Util.IsEmpty(datarow["Quantity"])) //here UOMConversion is empty then directly adding UOMConvertedQty 
                    datarow["UOMConvertedQty"] = datarow["Quantity"];


                if (Util.String(datarow["Quantity"]) != this.PrevValue) {//here checking PrevValue is not equal to datarow Quantity 
                    this.GetProductValues(datarow, 0, false, null, true); // and getting Product Values from GetProductValues  and assigning to its datarow like QOH,AverageRate,UOM...etc
                    if (Util.String(datarow["Type"]) == "3") {//checking Product Type is Kit on above we got Product Definintion and assigned values to datarow
                        let dsvm = new DynamicSetViewModel(this, datarow, null); // type is kit we call DynamicSetViewModel and invoke 
                        if (dsvm.FooterGridData.length > 0)
                            dsvm.OnfooterQtyChanged(dsvm.FooterGridData[0]); // calling OnfooterQtyChanged if DynamicSetViewModel consits FooterGridData 
                        dsvm.OnButtonClick("AutoSave"); // calling AutoSave of DynamicSetViewModel
                    }
                    if (!Util.IsEmpty(datarow["LinkedInvDocDetailsID"]) && datarow["LinkedFieldName"].toString() == "Quantity") { //here checking datarow consists of LinkedInvDocDetailsID not empty and LinkedFieldName is Quantity
                        let Partialcols: any = this.ScreenObject.ColumnSource.filter(a => a.IsPartialLinking);//then we are getting IsPartialLinking columns from Column Source Object 
                        if (Partialcols.length > 0) {//if Partialcols exists then we are getting Datatable of by passing LinkedInvDocDetailsID to GetDetailsByInvDetID
                            let dt: any = this.ScreenObject.GetDetailsByInvDetID(datarow["LinkedInvDocDetailsID"].toString());
                            Partialcols.forEach(oCol => {//after getting details set Link Values method will invoke forEach Partialcols and it will add to Datarow 
                                this.ScreenObject.SetLinkValues(dt, oCol, 0, datarow, null, datarow["Quantity"].toString());
                            });
                        }
                    }
                }
                if (!Util.IsEmpty(datarow["Quantity"]) && parseFloat(datarow["Quantity"]) > 0 && this.ScreenObject.GridDataColumns.Contains("FreeQTY")
                    && Util.Int(datarow["SchemeID"]) == 1) {//here checking FreeQTY column exists on Data table columns & SchemeID is 1
                    //then initializing default values of the row ,columns FreeQTY,IsScheme,MaxSchemeID,SchemeID
                    datarow["FreeQTY"] = 0;
                    datarow["IsScheme"] = null;
                    datarow["MaxSchemeID"] = null;
                    datarow["SchemeID"] = null;
                }

                //In Document Preferences SubstituteOnQty exists && Grid Data table Columns contains SubstituteOnQty column & data row contains Product ID and Quantity && in datarow SubstituteOnQty column data not empty && Quantity > SubstituteOnQty 
                if (this.ScreenObject.Preferences.ContainsKey("SubstituteOnQty") && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["SubstituteOnQty"]) && !Util.IsEmpty(datarow["ProductID_Key"])
                    && !Util.IsEmpty(datarow["Quantity"]) && !Util.IsEmpty(datarow[this.ScreenObject.Preferences["SubstituteOnQty"]]) && parseFloat(datarow["Quantity"]) > parseFloat(datarow[this.ScreenObject.Preferences["SubstituteOnQty"]])) {
                    // we are getting their Substitute Products by calling GetSubtituteProducts method by passing Product ID as parameter ,DocumentDate,DocDetailsID of the Datarow  
                    let dssubdata: any = this.ScreenObject.GetSubtituteProducts(parseInt(datarow["ProductID_Key"]), this.DocumentDate, datarow["DocDetailsID"].toString(), datarow);

                    // after getting Substitutes Products Data here validating Tables exists and there is no ErrorMessage 
                    if (dssubdata.Tables.length > 0 && !dssubdata.Columns[0].Contains("ErrorMessage") && dssubdata.Tables[0].length > 0) {
                        // here we are creating Object for the SubsituteProductsViewModel by passing Substitutes Data  
                        let sb = new SubsituteProductsViewModel(this, dssubdata.Tables[0], dssubdata.Columns[0], dssubdata.Tables[1], datarow["ProductName"].toString(), datarow["ProductCode"].toString(), datarow["ProductID_Key"].toString())
                        if (sb.GridData.length > 0)//validating GridData length >0
                            BaseService.page.ShowDialog(sb, SubsituteProductsComponent, { ShowCenter: true });// showing as a Popup to select the Substitues Of the Product 
                    }
                }
                // here document Preferences contains UseQtyAdjustment and Columns Contains QtyType && QtyType is 1 (Quantity Adjustment Mandatory ) //3 for not applicable from Product Master
                if (this.ScreenObject.Preferences.ContainsKey("UseQtyAdjustment") && this.ScreenObject.Preferences["UseQtyAdjustment"] != "" && parseBoolean(this.ScreenObject.Preferences["UseQtyAdjustment"])
                    && this.ScreenObject.GridDataColumns.Contains("QtyType") && Util.Int(datarow["QtyType"]) == 1) {
                    let fc = new FieldCalculatorViewModel(this, 1);// here we are calculating Net Total with Adjusted Quantity &  creating object of class FieldCalculatorViewModel
                    BaseService.page.ShowDialog(fc, FieldCalculatorComponent, { ShowCenter: true });// Service Component Pop up showing 
                }
            }
            else if (strBindingPaths == "FreeQTY") {//checking strBindingPaths is FreeQTY 
                if (Util.Double(datarow["FreeQTY"]) > 0 && Util.IsEmpty(datarow["IsScheme"])) {//FreeQTY >0 && IsScheme empty
                    if (Util.Double(datarow["Quantity"]) > 0) {//here checking Quantity column data exists and greater than zero 
                        this.DisplayMessage = "Can not enter both qty and free qty";// then validating "Can not enter both qty and free qty"
                        return;
                    }
                    else {
                        datarow["IsScheme"] = "Y";// adding IsScheme data to "Y"
                        let MaxSchemeID = 0;//taking local variable MaxSchemeID 
                        let templink: any = this.ScreenObject.GridData.Compute("max", "MaxSchemeID");//calculating MaxSchemeID Column from Griddata
                        if (templink != null)
                            MaxSchemeID = Util.Int(templink);// here setting templink to a MaxSchemeID property
                        MaxSchemeID++; //here incrementing MaxSchemeID to assign in selected Datarow
                        datarow["MaxSchemeID"] = MaxSchemeID;//and assigning MaxSchemeID to datarow
                        datarow["SchemeID"] = 1; //and assigning SchemeID to datarow by default adding 1
                        //below Calculating UOMConvertedQty from FreeQty * UOMConversion and asiigning to datarow UOMConvertedQty
                        if (Util.Double(datarow["FreeQTY"]) > 0) {
                            if (!Util.IsEmpty(datarow["UOMConversion"]))
                                datarow["UOMConvertedQty"] = parseFloat(datarow["FreeQTY"]) * parseFloat(datarow["UOMConversion"]);
                            else
                                datarow["UOMConvertedQty"] = datarow["FreeQTY"].toString();
                        }
                    }
                }
            }

            //here QtyAdjustmentField Contains in Document Preferences && is strBindingPaths or dcNum
            if (this.ScreenObject.Preferences.ContainsKey("QtyAdjustmentField") && (this.ScreenObject.Preferences["QtyAdjustmentField"] == strBindingPaths
                || (strBindingPaths == "Gross" && this.ScreenObject.Preferences["QtyAdjustmentField"] == "dcNum")))
                BaseService.page.ShowDialog(new FieldCalculatorViewModel(this, 1), FieldCalculatorComponent, { ShowCenter: true })// creating object for FieldCalculatorViewModel and showing as popup dailog

            if (CostCenterID > 0)// sender.OriginalSource.Column.GetType().FullName == "PACT.COMMON.DataGridPactListBoxColumn")
            {
                if (CostCenterID == 11) {
                    this.OnProductUnitChange(datarow);
                }
                else if (CostCenterID == 12) {
                    let CurrentCol: string = strBindingPaths;
                    CurrentCol = CurrentCol.substr(8, CurrentCol.length - 8);
                    //
                    if (this.ScreenObject.GridDataColumns.Contains(strBindingPaths + "_Key") && !Util.IsEmpty(datarow[strBindingPaths + "_Key"])) {
                        if (strBindingPaths.toLowerCase().toString() == "currencyid" && this.ScreenObject.GridDataColumns.Contains("ExchangeRate"))
                            datarow["ExchangeRate"] = this.ScreenObject.GetExchangeRate(parseInt(datarow[strBindingPaths + "_Key"]), this.DocumentDate.OnlyDate());
                        else if (this.ScreenObject.GridDataColumns.Contains("dcExchRT" + CurrentCol))
                            datarow["dcExchRT" + CurrentCol] = this.ScreenObject.GetExchangeRate(parseInt(datarow[strBindingPaths + "_Key"]), this.DocumentDate.OnlyDate());
                    }
                }
                else if (CostCenterID == 2) {
                    if (col && !Util.IsEmpty(datarow[col.ValueMember])) {
                        if (!this.IsInventoryVoucher && this.ScreenObject.IsDocEdit && datarow[col.ValueMember].toString() != this.PrevValue) {
                            if (this.IsAccBillWise(parseInt(datarow[col.ValueMember])))
                                datarow["Type"] = true;
                            else
                                datarow["Type"] = null;
                        }

                        if (!this.IsInventoryVoucher && !this.ScreenObject.IsDocEdit && datarow[col.ValueMember].toString() != this.PrevValue)
                            this.FillDefaultValues(datarow);
                        if ((this.DocumentType == 5 || this.DocumentType == 8 || this.DocumentType == 13) && this.ScreenObject.Preferences.ContainsKey("BudgetFeild") && !Util.IsEmpty(this.ScreenObject.Preferences["BudgetFeild"])
                            && datarow[col.ValueMember].toString() != this.PrevValue) {
                            var txt = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == this.ScreenObject.Preferences["BudgetFeild"].toLowerCase()) as PactListBoxData;
                            if (txt != undefined && txt.SelectedValue > 0) {
                                let dsbud: any = null;
                                let drbudget: any = null;
                                if (this.DocumentType == 8 || this.DocumentType == 13) {
                                    if (col.ValueMember.toLowerCase().Contains("creditaccount") || col.ValueMember.toLowerCase().Contains("debitaccount"))
                                        dsbud = this.ScreenObject.FillBudgetDims(true, txt.SelectedValue, datarow, datarow[col.ValueMember].toString());
                                }
                                else {
                                    if (col.ValueMember.toLowerCase().Contains("creditaccount"))
                                        dsbud = this.ScreenObject.FillBudgetDims(false, txt.SelectedValue, datarow, datarow[col.ValueMember].toString());
                                    else if (col.ValueMember.toLowerCase().Contains("debitaccount"))
                                        dsbud = this.ScreenObject.FillBudgetDims(true, txt.SelectedValue, datarow, datarow[col.ValueMember].toString());
                                }

                                if (dsbud.Tables[0].length == 1)
                                    drbudget = dsbud.Tables[0][0];
                                else {
                                    let RatePicker: ProductRatePickerViewModel = new ProductRatePickerViewModel(this)
                                    {
                                        if (col.ValueMember.toLowerCase().Contains("creditaccount") && this.DocumentType == 5)
                                            RatePicker.LoadData(dsbud.Tables[0], '', 4);
                                        else
                                            RatePicker.LoadData(dsbud.Tables[0], '', 3);
                                        await BaseService.page.openDialog(RatePicker, ProductRatePickerComponent, { ShowCenter: true })
                                        if (RatePicker.RateGrid.SelectedItem != null) {
                                            drbudget = RatePicker.RateGrid.SelectedItem;
                                        }
                                    }
                                }

                                if (drbudget != null) {
                                    for (let i = 0; i < Object.keys(drbudget).length; i++) {
                                        if (this.ScreenObject.GridDataColumns.Contains(Object.keys(drbudget)[i]) && !Util.IsEmpty(drbudget[Object.keys(drbudget)[i]]))
                                            datarow[Object.keys(drbudget)[i]] = drbudget[Object.keys(drbudget)[i]].toString();
                                    }
                                }
                            }
                        }
                        this.ScreenObject.GridDataObj.updateRow(datarow);
                    }
                }
                else if (this.IsInventoryVoucher && CostCenterID > 50000 && this.ScreenObject.PriceTaxcc.ContainsKey(CostCenterID) && this.ScreenObject.GridDataColumns.Contains(strBindingPaths + "_Key") && Util.String(datarow[strBindingPaths + "_Key"]) != this.PrevValue
                    && !Util.IsEmpty(datarow["ProductID_Key"]) && parseInt(datarow["ProductID_Key"]) > 0) {
                    this.ReEvaluatePriceTax_3(datarow, CostCenterID);
                }
                else if ((this.ScreenObject.DocumentType == 38 || this.ScreenObject.DocumentType == 39) && BaseService.SessionManager.Preferences.ContainsKey("POSItemCodeDimension") && BaseService.SessionManager.Preferences["POSItemCodeDimension"] == CostCenterID.toString()
                    && Util.String(datarow[strBindingPaths + "_Key"]) != this.PrevValue && !(!Util.IsEmpty(datarow["ProductID_Key"]) && parseInt(datarow["ProductID_Key"]) > 0)) {
                    this.AddProductData(datarow, false, false, false, null, datarow[strBindingPaths].toString());
                }


                if (this.ScreenObject.Preferences.ContainsKey("DimWiseAttachments") && this.ScreenObject.Preferences["DimWiseAttachments"] == CostCenterID.toString() && col
                    && col.ValueMember && !Util.IsEmpty(datarow[col.ValueMember]) && parseInt(datarow[col.ValueMember]) > 0 && datarow[col.ValueMember].toString() != this.PrevValue) {
                    let drdims = this.ScreenObject.GridData.find(x => x[col.DisplayMember + "_Key"] == datarow[col.ValueMember]);
                    if (drdims.length == 1) {
                        let dsfiles = this.ScreenObject.GetFiles(CostCenterID, parseInt(datarow[col.ValueMember]));
                        if (dsfiles.Tables.length > 0 && dsfiles.Tables[0].length > 0)
                            this.DimWiseAttachment(dsfiles.Tables[0], datarow[col.DisplayMember].toString());
                    }
                }

                if (this.DocumentType == 45 && this.ProjDims != null && this.ProjDims.Contains(CostCenterID))
                    this.FillWBS(false);
            }

            if (this.DocumentType == 45 || this.DocumentType == 46) {

                //let dtmpVal = 0;
                //////
                if (strBindingPaths.startsWith("dcCCNID") || strBindingPaths.toLowerCase() == "dcalpha15" || strBindingPaths.toLowerCase() == "dcalpha16") {
                    if (strBindingPaths.toLowerCase() == "dcalpha15" && Object.keys(datarow).Contains("dcAlpha15_Key") && !Util.IsEmpty(datarow["dcAlpha15_Key"]))
                        datarow["dcAlpha15"] = Util.ParseDate(datarow["dcAlpha15_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");

                    if (strBindingPaths.toLowerCase() == "dcalpha16" && Object.keys(datarow).Contains("dcAlpha16_Key") && !Util.IsEmpty(datarow["dcAlpha16_Key"]))
                        datarow["dcAlpha16"] = Util.ParseDate(datarow["dcAlpha16_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");

                    if (strBindingPaths.toLowerCase() == "dcalpha22" && Object.keys(datarow).Contains("dcAlpha22_Key") && !Util.IsEmpty(datarow["dcAlpha22_Key"]))
                        datarow["dcAlpha22"] = Util.ParseDate(datarow["dcAlpha22_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");

                    if (strBindingPaths.toLowerCase() == "dcalpha23" && Object.keys(datarow).Contains("dcAlpha23_Key") && !Util.IsEmpty(datarow["dcAlpha23_Key"]))
                        datarow["dcAlpha23"] = Util.ParseDate(datarow["dcAlpha23_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");

                    if (this.dsProjWOffHol == null)
                        this.InitProjWOffsHolidays();

                        if (this.dsProjWOffHol != null)
                        {
                          
                       if (this.ScreenObject.GridDataColumns.Contains("dcAlpha15_Key") && !Util.IsEmpty(datarow["dcAlpha15_Key"]) &&
                           this.ScreenObject.GridDataColumns.Contains("dcAlpha16_Key") && !Util.IsEmpty(datarow["dcAlpha16_Key"]) &&
                           datarow[strBindingPaths + "_Key"].toString() != this.PrevValue) {
                                let dWHrs = 0, dHrsPerDay = 0;

                                if (this.DocumentType == 46)
                                {
                                    if ((new Date(datarow["dcAlpha16_key"]) < new Date(datarow["dcAlpha15_key"])))
                                    {
                                        datarow["dcAlpha15"] = new Date(datarow["dcAlpha16_key"]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");
                                        datarow["dcAlpha15_key"] = new Date(datarow["dcAlpha16_key"]);
                                        this.DisplayMessage = "Todate should be greater than or equal to Fromdate" + "\r\n";
                                        this.MessageVisibility = true;
                                        return;
                                    }
                                    let refObj = { odWHrs: dWHrs, odHrsPerDay: dHrsPerDay };
                                    let dDays = Util.GetNoOfDays(this.dsProjWOffHol, Util.ParseDate(datarow["dcAlpha15_Key"]), Util.ParseDate(datarow["dcAlpha16_Key"]), this.bProjMgmtConsWH, datarow, this.DocumentDate, refObj, false, true);
                                    datarow["dcAlpha24"] = dDays.toString();

                                    if (parseFloat(datarow["dcAlpha30"]) < dHrsPerDay)
                                    {
                                        this.DisplayMessage = "Actual Hours should be less than or equal to Planned Hours" + "\r\n";
                                        this.MessageVisibility = true;
                                        return;
                                    }
                                    else
                                        datarow["dcAlpha33"] = dHrsPerDay.ToString("0.00");
                        
                                    if (datarow["dcAlpha33"] != null && datarow["dcAlpha33"] != null && datarow["dcAlpha33"].toString().Trim() != "")
                                        datarow["dcAlpha34"] = dWHrs.ToString("0.00");//(parseFloat(datarow["dcAlpha30"]) * parseFloat(datarow["dcAlpha17"]));
                                    else
                                        datarow["dcAlpha34"] = "0";
                                }
                                else
                                {
                                   let refObj = { odWHrs: dWHrs, odHrsPerDay: dHrsPerDay };
                                   let dDays = Util.GetNoOfDays(this.dsProjWOffHol, Util.ParseDate(datarow["dcAlpha15_Key"]), Util.ParseDate(datarow["dcAlpha16_Key"]), this.bProjMgmtConsWH, datarow, this.DocumentDate, refObj);
                                    datarow["dcAlpha17"] = dDays.toString();
                                    datarow["dcAlpha30"] = dHrsPerDay.ToString("0.00");
                        
                                    if (datarow["dcAlpha30"] != null && datarow["dcAlpha30"] != null && datarow["dcAlpha30"].toString().Trim() != "")
                                        datarow["dcAlpha31"] = dWHrs.ToString("0.00");//(parseFloat(datarow["dcAlpha30"]) * parseFloat(datarow["dcAlpha17"]));
                                    else
                                        datarow["dcAlpha31"] = "0";
                        
                                    if (datarow["dcAlpha30"] != null && datarow["dcAlpha30"] != null && datarow["dcAlpha30"].toString().Trim() != "" &&
                                    datarow["dcAlpha31"] != null && datarow["dcAlpha31"] != null && datarow["dcAlpha31"].toString().Trim() != "")
                                    {
                                        if (parseFloat(datarow["dcAlpha30"]) > 0)
                                            datarow["dcAlpha32"] = (parseFloat(datarow["dcAlpha31"]) / parseFloat(datarow["dcAlpha30"])).ToString("0.00");
                                        else
                                            datarow["dcAlpha32"] = "0";
                                    }
                                }
                            }
                        }
                }

                /*if (strBindingPaths.toLowerCase() == "dcalpha31")
                {
                    if (!Util.IsEmpty(datarow["dcAlpha30"]) &&
                    !Util.IsEmpty(datarow["dcAlpha31"]) && 
                    datarow[strBindingPaths].toString() != this.PrevValue )
                    {
                        if (parseFloat(datarow["dcAlpha30"]) > 0)
                            datarow["dcAlpha32"] = (parseFloat(datarow["dcAlpha31"]) / parseFloat(datarow["dcAlpha30"])).ToString("0.00");
                        else
                            datarow["dcAlpha32"] = "0";
                    }
                }

                if (strBindingPaths.toLowerCase() == "dcalpha32")
                {
                    if (!Util.IsEmpty(datarow["dcAlpha30"]) &&
                    !Util.IsEmpty(datarow["dcAlpha32"]) && 
                    datarow[strBindingPaths].toString() != this.PrevValue )
                    {
                        datarow["dcAlpha31"] = parseFloat(datarow["dcAlpha32"]) * parseFloat(datarow["dcAlpha30"]);
                    }
                }*/
                /**datarow.AcceptChanges();**/

                //////
                if (this.DocumentType == 46 && BaseService.SessionManager.Preferences.ContainsKey("OverWriteTimings") && BaseService.SessionManager.Preferences["OverWriteTimings"] != "" && parseBoolean(BaseService.SessionManager.Preferences["OverWriteTimings"])) {
                    this.CalculateGroupPhaseDates(datarow);
                }
                else if (this.DocumentType == 45) {
                    if ((this.ScreenObject.GridDataColumns.Contains(strBindingPaths + "_Key") && Util.String(datarow[strBindingPaths + "_Key"]) != this.PrevValue
                        && !Util.IsEmpty(datarow[strBindingPaths + "_Key"])
                        && (strBindingPaths.toLowerCase() == "dcalpha15" || strBindingPaths.toLowerCase() == "dcalpha16"))
                        || (strBindingPaths.toLowerCase() == "dcalpha18" || strBindingPaths.toLowerCase() == "dcalpha30" || strBindingPaths.toLowerCase() == "dcalpha31" || strBindingPaths.toLowerCase() == "dcalpha32" && datarow[strBindingPaths].toString() != this.PrevValue))
                    this.FillWBS(false);
                }
            }

            this.NumFieldEditOptionValidation(col, datarow);

            if (this.ScreenObject.Data.Tables.length > 0) {
                let dvCnt = this.ScreenObject.Data.Tables[0];

                if (dvCnt.length > 0) {
                    if (col && col.CostCenterID > 0) {
                        if (col.CostCenterID != 3) {
                            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == col.ID);
                            if ((dvCnt.length > 0 || ((BaseService.SessionManager.Preferences.ContainsKey("LW CreditDebit") && BaseService.SessionManager.Preferences["LW CreditDebit"] != "" && parseBoolean(BaseService.SessionManager.Preferences["LW CreditDebit"]) && col.CostCenterID == 50002)
                                || (BaseService.SessionManager.Preferences.ContainsKey("DW CreditDebit") && BaseService.SessionManager.Preferences["DW CreditDebit"] != "" && parseBoolean(BaseService.SessionManager.Preferences["DW CreditDebit"]) && col.CostCenterID == 50001)
                                || (BaseService.SessionManager.Preferences.ContainsKey("DimWiseCreditDebit") && BaseService.SessionManager.Preferences["DimWiseCreditDebit"] != "" && parseInt(BaseService.SessionManager.Preferences["DimWiseCreditDebit"]) == col.CostCenterID))
                                || (col.CostCenterID == 2 && this.ScreenObject.DocumentType == 17 &&
                                    this.ScreenObject.Preferences.ContainsKey("Use Account-wise Currency") && this.ScreenObject.Preferences["Use Account-wise Currency"] != "" && parseBoolean(this.ScreenObject.Preferences["Use Account-wise Currency"])
                                    && !this.IsInventoryVoucher) || (col.CostCenterID == 2 && (this.DocumentType == 15 || this.DocumentType == 14) && !this.IsInventoryVoucher && strBindingPaths == "CreditAccount")
                                || (col.CostCenterID == 2 && !this.IsInventoryVoucher &&
                                    this.ScreenObject.Preferences.ContainsKey("Account-wiseAttachments") && this.ScreenObject.Preferences["Account-wiseAttachments"] != "" && parseBoolean(this.ScreenObject.Preferences["Account-wiseAttachments"]))
                                || (col.Filter > 0 && this.IsInventoryVoucher)
                                || (this.ScreenObject.Preferences.ContainsKey("DefaultProfileID") && this.ScreenObject.Preferences["DefaultProfileID"] != ""
                                    && this.ScreenObject.DefaultBasedOn.ContainsKey(col.CostCenterID.toString()))) && col.ValueMember && !Util.IsEmpty(datarow[col.ValueMember])
                                && parseInt(datarow[col.ValueMember]) > 0 && datarow[col.ValueMember].toString() != this.PrevValue) {
                                this.ScreenObject.GetLinkReferenceData(parseInt(col.ID), this.DocumentID, parseInt(datarow[col.ValueMember]), Date.Today(), strBindingPaths, col.CostCenterID, datarow);
                            }
                            if (col.CostCenterID == 2) {
                                let ProdExtracol = this.ScreenObject.ColumnSource.filter(a => !Util.IsEmpty(a.ValueMember) && a.ValueMember.toLowerCase() == col.ValueMember.toLowerCase());

                                if (ProdExtracol.length > 1 && col.ValueMember != "" && datarow[col.ValueMember] && !Util.IsEmpty(datarow[col.ValueMember])) {
                                    if (ProdExtracol[0] == col) {
                                        dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == ProdExtracol[ProdExtracol.length - 1].ID);
                                        if (dvCnt.length > 0)
                                            this.ScreenObject.GetLinkReferenceData(parseInt(ProdExtracol[ProdExtracol.length - 1].ID), this.DocumentID, parseInt(datarow[col.ValueMember]), Date.Today(), "", col.CostCenterID, datarow);
                                    }
                                    else {
                                        dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == ProdExtracol[0].ID);

                                        if (dvCnt.length > 0)
                                            this.ScreenObject.GetLinkReferenceData(parseInt(ProdExtracol[0].ID), this.DocumentID, parseInt(datarow[col.ValueMember]), Date.Today(), "", col.CostCenterID, datarow);
                                    }
                                }
                            }
                        }
                        if (strBindingPaths == "ProductID") {
                            if (this.ScreenObject.Data.Tables.length > 6 && this.ScreenObject.Data.Tables[6].length > 0 && (this.ScreenObject.Preferences.ContainsKey("Productwise") && this.ScreenObject.Preferences["Productwise"] != null && parseBoolean(this.ScreenObject.Preferences["Productwise"]))) {
                                if (!Util.IsEmpty(datarow["ProductID_Key"])) {
                                    let dslinkdata = this.ScreenObject.GetProductLinkDetails(this.DocumentID, parseInt(datarow["ProductID_Key"]), this.ScreenObject.DocDate.Date.ToString("dd/MMM/yyyy"), ((this.ScreenObject.DueDate && this.ScreenObject.DueDate.Date) ? this.ScreenObject.DueDate.Date.ToString("dd/MMM/yyyy") : ""), datarow)
                                    {
                                        if (dslinkdata != null && dslinkdata.Tables.length > 0 && dslinkdata.Tables[0].length > 0) {
                                            for (let i = 0; i < dslinkdata.Tables[0].length; i++) {
                                                let linkedRows = this.ScreenObject.GridData.filter(x => x.DocDetailsID == 0 && x.LinkedInvDocDetailsID == dslinkdata.Tables[0][i]["DocDetailsID"]);
                                                if (linkedRows.length > 0) {
                                                    let c0 = dslinkdata.Columns[0][0]
                                                    let c1 = dslinkdata.Columns[0][1]
                                                    let UsedValue = 0;
                                                    for (let l = 0; l < linkedRows.length; l++) {
                                                        if (Util.IsNum(linkedRows[l][dslinkdata.Tables[0][i][c1].toString()])) {
                                                            UsedValue += parseFloat(linkedRows[l][dslinkdata.Tables[0][i][c1].toString()]);
                                                        }
                                                    }

                                                    if (Util.IsNum(dslinkdata.Tables[0][i][c0]) && (parseFloat(dslinkdata.Tables[0][i][c0]) - UsedValue) > 0)
                                                        dslinkdata.Tables[0][i][c0] = parseFloat(dslinkdata.Tables[0][i][c0]) - UsedValue;
                                                    else {
                                                        dslinkdata.Tables[0].RemoveAt(i);
                                                        dslinkdata.Tables[1].RemoveAt(i);
                                                        dslinkdata.Tables[2].RemoveAt(i);
                                                        dslinkdata.Tables[3].RemoveAt(i);
                                                        i--;
                                                        continue;
                                                    }
                                                }
                                            }
                                        }
                                        if (dslinkdata != null && dslinkdata.Tables.length > 0 && dslinkdata.Tables[0].length > 0) {
                                            BaseService.page.ShowDialog(new LinkProdWiseViewModel(this, datarow["ProductID_Key"].toString(), dslinkdata, this.ScreenObject.GridData.indexOf(datarow))
                                                , LinkProductWiseComponent);
                                            return;
                                        }
                                    }
                                }
                            }


                        }
                    }
                }

            }

            if (this.IsInventoryVoucher) {

                if (strBindingPaths == "Quantity" && this.ScreenObject.GridDataColumns.Contains("landingType")
                    && (Util.String(datarow["landingType"]) == "1" || Util.String(datarow["landingType"]) == "2")) {
                    //ShellWindowViewModel.Instance().PopViewModel = new FieldCalculatorViewModel(this, 2);
                    if (BaseService.page.DialogCount == 0)
                        BaseService.page.ShowDialog(new FieldCalculatorViewModel(this, 2), FieldCalculatorComponent, { ShowCenter: true });
                }

                if (!this.DonotUpdateInventory && (strBindingPaths == "Quantity" || strBindingPaths == "RecievedQty" || strBindingPaths == "FreeQTY")
                    && Util.String(datarow["Type"]) != "" && parseInt(Util.String(datarow["Type"])) == 2) {
                    if (this.ScreenObject.DocumentType == 30) {
                        if (this.ScreenObject.GridDataColumns.Contains("VoucherType") && !Util.IsEmpty(datarow["VoucherType"]))
                            this.VoucherType = parseInt(datarow["VoucherType"]);
                        else
                            this.VoucherType = 0;
                    }
                    if (!Util.IsEmpty(datarow[strBindingPaths]) && parseFloat(datarow[strBindingPaths]) > 0) {
                        let ObjSerialNumber = new SerialNumberViewModel(this, strBindingPaths, this.VoucherType, 0, datarow);
                        if (this.VoucherType == 1 && ObjSerialNumber.ds != null && ObjSerialNumber.ds.Tables.length > 3 && ObjSerialNumber.ds.Tables[3].length > 0 && !Util.IsEmpty(ObjSerialNumber.ds.Tables[3][0][0]))
                            this.AutoSerialNumber(datarow, ObjSerialNumber);
                        else
                            BaseService.page.ShowDialog(ObjSerialNumber, SerialNumberComponent);
                    }
                }

                if (!this.DonotUpdateInventory && strBindingPaths == "Quantity" && Util.String(datarow["Type"]) != "" && parseInt(Util.String(datarow["Type"])) == 4) {
                    const { ProductAttributeNewViewModel } = await import('../../inventory/master-tabs/product-attribute/ProductAttributeNewViewModel')
                    const { ProductAttributeComponent } = await import('../../inventory/master-tabs/product-attribute/product-attribute.component')
                    let PAVM: any = new ProductAttributeNewViewModel(this);
                    if (!PAVM.MessageVisibility) {
                        await BaseService.page.openDialog(PAVM, ProductAttributeComponent, { ShowCenter: true });
                    }
                }
                if (this.ScreenObject.Preferences.ContainsKey("EnableAssetSerialNo") && this.ScreenObject.Preferences["EnableAssetSerialNo"].toLowerCase() == "true"
                    && strBindingPaths == "Quantity") {
                    let AssetQty = 0;
                    if (this.ScreenObject.Preferences.ContainsKey("AssetBasedOn") && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["AssetBasedOn"])) {
                        if (datarow[this.ScreenObject.Preferences["AssetBasedOn"]].toString() == "0")
                            AssetQty = 0;
                        else if ((datarow[this.ScreenObject.Preferences["AssetBasedOn"]].toString() == "2" || datarow[this.ScreenObject.Preferences["AssetBasedOn"]].toString() == "1")
                            && !Util.IsEmpty(datarow["Quantity"]))
                            AssetQty = parseFloat(datarow["Quantity"]);
                        else if (datarow[this.ScreenObject.Preferences["AssetBasedOn"]].toString() == "3" || datarow[this.ScreenObject.Preferences["AssetBasedOn"]].toString() == "4")
                            AssetQty = 1;
                    }
                    else if (!Util.IsEmpty(datarow["Quantity"]))
                        AssetQty = parseFloat(datarow["Quantity"]);

                    if (AssetQty > 0) {
                        let ObjSerialNumber = new SerialNumberViewModel(this, strBindingPaths, 1, AssetQty, datarow);
                        if (ObjSerialNumber.ds != null && ObjSerialNumber.ds.Tables.length > 3 && ObjSerialNumber.ds.Tables[3].length > 0 && !Util.IsEmpty(ObjSerialNumber.ds.Tables[3][0][0]))
                            this.AutoSerialNumber(datarow, ObjSerialNumber);
                        else
                            BaseService.page.ShowDialog(ObjSerialNumber, SerialNumberComponent);
                    }
                }

                if (this.VoucherType == -1 && this.ScreenObject.Preferences.ContainsKey("AutoBatches") && this.ScreenObject.Preferences["AutoBatches"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["AutoBatches"]))
                    CallType = 1;

                if (CallType != 1 && ((this.ScreenObject.Preferences.ContainsKey("ShowBatches") && this.ScreenObject.Preferences["ShowBatches"] != "" && parseBoolean(this.ScreenObject.Preferences["ShowBatches"]))
                    || !this.DonotUpdateInventory || this.DocumentType == 32 ||
                    (this.ScreenObject.Preferences.ContainsKey("ExcludeReserve") && this.ScreenObject.Preferences["ExcludeReserve"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["ExcludeReserve"])
                        && this.ScreenObject.GridDataColumns.Contains("ReserveQuantity"))
                    || (this.ScreenObject.Preferences.ContainsKey("ExcludeHold") && this.ScreenObject.Preferences["ExcludeHold"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["ExcludeHold"])
                        && this.ScreenObject.GridDataColumns.Contains("HoldQuantity")))) {

                    if (this.DocumentType == 32 && !Util.IsEmpty(datarow["Type"]) && parseInt(Util.String(datarow["Type"])) == 5) {
                        let VarFldName = "";
                        let fld = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["VarienceField"]);
                        if (fld)
                            VarFldName = fld.DisplayMember;

                        if (strBindingPaths == VarFldName)
                            this.fillbatches(datarow);
                    }
                    else if (strBindingPaths == "Quantity" && !Util.IsEmpty(datarow["Type"]) && parseInt(datarow["Type"]) == 5 &&
                        (!Util.IsEmpty(datarow["Quantity"]) || (this.ScreenObject.Preferences.ContainsKey("QtyonBatch") && this.ScreenObject.Preferences["QtyonBatch"] != "" && parseBoolean(this.ScreenObject.Preferences["QtyonBatch"])))) {
                        this.fillbatches(datarow);
                    }
                    else if (strBindingPaths == "FreeQTY" && !Util.IsEmpty(datarow["Type"]) && parseInt(datarow["Type"]) == 5 && !Util.IsEmpty(datarow["FreeQTY"])) {
                        this.fillbatches(datarow);
                    }
                }

                if (strBindingPaths == "Quantity" && this.ScreenObject.GridDataColumns.Contains("landingType")
                    && (Util.String(datarow["landingType"]) == "1" || Util.String(datarow["landingType"]) == "2")) {

                }
                else if (strBindingPaths == "Quantity" && Util.String(datarow["Type"]) != "2" &&
                    (Util.String(datarow["Type"]) != "5" || (this.ScreenObject.Preferences.ContainsKey("SameBatchtoall") && this.ScreenObject.Preferences["SameBatchtoall"].toLowerCase() == "true"))
                    && Util.LowerCase(datarow["BinWise"]) == "true" && !Util.IsEmpty(datarow["Quantity"])) {
                    this.AddBins(datarow, false, true, null);
                }
                else if (strBindingPaths == "RecievedQty" && Util.String(datarow["Type"]) != "2" && !Util.IsEmpty(datarow["BinWise"])
                    && Util.LowerCase(datarow["BinWise"]) == "true" && !Util.IsEmpty(datarow["RecievedQty"])) {
                    let dimid = 0;
                    if (BaseService.SessionManager.Preferences.ContainsKey("DimensionwiseBins") && BaseService.SessionManager.Preferences["DimensionwiseBins"].toString() != "")
                        dimid = Util.Int(BaseService.SessionManager.Preferences["DimensionwiseBins"]);
                    let qt: number;
                    if (parseFloat(datarow["RecievedQty"]) > 0)
                        qt = parseFloat(datarow["RecievedQty"]);
                    else
                        qt = 0;

                    if (this.ScreenObject.GridDataColumns.Contains("UOMConversion") && !Util.IsEmpty(datarow["UOMConversion"]))
                        qt = qt * parseFloat(datarow["UOMConversion"]);

                    this.AddToWarehouseBins(dimid, datarow, qt, false);
                }

                if ((Temppath == "ProductName" || Temppath == "ProductCode") && datarow["ProductID_Key"] != null && !Util.IsEmpty(datarow["ProductID_Key"])) {
                    if (!(this.ScreenObject.Preferences.ContainsKey("Dontresetvaluesonproductchange") && this.ScreenObject.Preferences["Dontresetvaluesonproductchange"] != "" && parseBoolean(this.ScreenObject.Preferences["Dontresetvaluesonproductchange"])
                        && this.ProdID > 0)) {
                        this.AddProductData(datarow, false, false);

                        if (this.ScreenObject.GridDataColumns.Contains("SchemeProductID"))
                            datarow["SchemeProductID"] = null;

                        if (this.barcodeValues != null && this.barcodeValues.length > 0) {
                            this.barcodeValues.keys.forEach(dKey => {
                                let item: any = { Key: dKey, Value: this.barcodeValues[dKey] };
                                if (this.ScreenObject.GridDataColumns.Contains(item.Key)) {
                                    if (this.ScreenObject.GridDataColumns.Contains(item.Key + "_Key")) {
                                        let tempcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == item.Key.toLowerCase());
                                        if (tempcol && tempcol.CostCenterID > 0) {
                                            let tempds: any = this.ScreenObject.GetCCListViewDataID(tempcol.CostCenterID, tempcol.TypeID, item.Value.toString())
                                            if (tempds != null && tempds.Tables.length > 0 && tempds.Tables[0].length > 0
                                                && tempds.Columns[0].Contains("NodeID") && !Util.IsEmpty(tempds.Tables[0][0]["NodeID"])) {
                                                datarow[item.Key + "_Key"] = tempds.Tables[0][0]["NodeID"].toString();
                                                datarow[item.Key] = item.Value;
                                            }
                                        }
                                        else if (tempcol.DataType == "DATE" || tempcol.DataType == "DATETIME") {
                                            let tempdt: Date;
                                            if (Util.isValidDate(item.Value)) {
                                                tempdt = Util.ParseDate(item.Value)
                                                datarow[item.Key + "_Key"] = tempdt;
                                                if (tempcol.DataType == "DATE")
                                                    datarow[item.Key] = tempdt.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                else
                                                    datarow[item.Key] = tempdt.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                                            }
                                        }
                                    }
                                    else
                                        datarow[item.Key] = item.Value;
                                }
                                else {
                                    let tempcol = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.ValueMember) && a.ValueMember.toLowerCase() == item.Key.toLowerCase() + "_key");
                                    if (tempcol && tempcol.CostCenterID > 0) {
                                        let tempds: any = this.ScreenObject.GetCCListViewDataID(tempcol.CostCenterID, tempcol.TypeID, item.Value.toString())
                                        if (tempds != null && tempds.Tables.length > 0 && tempds.Tables[0].length > 0
                                            && tempds.Columns[0].Contains("NodeID") && !Util.IsEmpty(tempds.Tables[0][0]["NodeID"])) {
                                            datarow[tempcol.ValueMember] = tempds.Tables[0][0]["NodeID"].toString();
                                            datarow[tempcol.DisplayMember] = item.Value;
                                        }
                                    }
                                }
                            });

                            if (this.barcodeValues.ContainsKey("INVID")) {
                                if (this.ScreenObject.GridDataColumns.Contains("DocExtraXML")) {
                                    datarow["DocExtraXML"] = "<DocExtraXML><Row RefID=\"" + this.barcodeValues["INVID"] + "\" Qty=\"" + datarow["Quantity"].toString() + "\" Type=\"1\" ></Row></DocExtraXML>";
                                    datarow["BOEID"] = this.barcodeValues["INVID"].toString();
                                    let dsbins = this.ScreenObject.GetinvBinDetails(this.barcodeValues["INVID"].toString(), datarow["ProductID_Key"].toString(), datarow["LinkedInvDocDetailsID"].toString());
                                    if (dsbins != null && dsbins.Tables.length > 0 && dsbins.Tables[0].length > 0)
                                        this.AddBins(datarow, false, false, dsbins);
                                }
                            }
                            if (this.VoucherType == -1 && Util.String(datarow["Type"]) == "5" && (this.barcodeValues.ContainsKey("Batch_Code") || this.barcodeValues.ContainsKey("Batch_No"))) {
                                let div = 0, loc = 0;
                                if (this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])) {
                                    let ccfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
                                    if (ccfld && ccfld instanceof PactListBoxData && ccfld.SelectedValue > 0)
                                        loc = ccfld.SelectedValue;
                                    else if (datarow != null && !Util.IsEmpty(datarow["dcCCNID2_Key"]))
                                        loc = parseInt(datarow["dcCCNID2_Key"]);
                                }
                                else if (this.ScreenObject.LocationID > 0)
                                    loc = this.ScreenObject.LocationID;
                                else
                                    loc = BaseService.SessionManager.LocationID;
                                if (this.ScreenObject.DivisionID > 0)
                                    div = this.ScreenObject.DivisionID;
                                else
                                    div = BaseService.SessionManager.DivisionID;
                                let qt = 0;
                                if (!Util.IsEmpty(datarow["Quantity"]) && parseFloat(datarow["Quantity"]) > 0)
                                    qt = parseFloat(datarow["Quantity"]);
                                else if (!Util.IsEmpty(datarow["FreeQTY"]) && parseFloat(datarow["FreeQTY"]) > 0)
                                    qt = parseFloat(datarow["FreeQTY"]);
                                if (!Util.IsEmpty(datarow["UOMConversion"]))
                                    qt = qt * parseFloat(datarow["UOMConversion"]);
                                let objbat = new BatchNumberViewModel(this.ScreenObject.GridDataObj)
                                objbat.BatchNumberViewModel_3(this, this.VoucherType, qt, parseInt(datarow["ProductID_Key"]), datarow["ProductName"].toString(), loc, div, datarow)
                                {
                                    for (let k = 0; k < objbat.GridData.length; k++) {
                                        if (this.barcodeValues.ContainsKey("Batch_Code") && objbat.GridData[k]["BatchCode"].toString().toLowerCase() == this.barcodeValues["Batch_Code"].toString().toLowerCase()) {
                                            objbat.SelectQty(objbat.GridData[k]);
                                            break;
                                        }
                                        else if (this.barcodeValues.ContainsKey("Batch_No") && objbat.GridData[k]["BATCHNUMBER"].toString().toLowerCase() == this.barcodeValues["Batch_No"].toString().toLowerCase()) {
                                            objbat.SelectQty(objbat.GridData[k]);
                                            break;
                                        }
                                    }
                                    objbat.DisplayMessage = "";
                                    objbat.OnSave("AutoSave");
                                    if (objbat.DisplayMessage != "")
                                        BaseService.page.ShowDialog(objbat, BatchNumberComponent);
                                }
                            }
                            this.barcodeValues.Clear();
                        }
                    }
                    else if (this.ProdID != parseInt(datarow["ProductID_Key"]) && parseInt(datarow["ProductID_Key"]) != 0) {
                        let ds = this.GetProductValues(datarow, 0);
                        if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0 && !ds.Columns[0].Contains("ErrorMessage")) {
                            datarow["Type"] = ds.Tables[0][0]["ProductTypeID"].toString();
                            if (this.ScreenObject.GridDataColumns.Contains("BinWise") && ds.Columns[0].Contains("BinWise"))
                                datarow["BinWise"] = Util.String(ds.Tables[0][0]["BinWise"]);
                            if (this.ScreenObject.GridDataColumns.Contains("QtyType") && ds.Columns[0].Contains("QtyAdjustType"))
                                datarow["QtyType"] = Util.String(ds.Tables[0][0]["QtyAdjustType"]);
                            if (this.ScreenObject.GridDataColumns.Contains("PackType") && ds.Columns[0].Contains("IsPacking"))
                                datarow["PackType"] = Util.String(ds.Tables[0][0]["IsPacking"]);
                            if (this.ScreenObject.GridDataColumns.Contains("IsTestCase") && ds.Columns[0].Contains("TestCaseExists"))
                                datarow["IsTestCase"] = Util.String(ds.Tables[0][0]["TestCaseExists"]);
                            if (this.ScreenObject.GridDataColumns.Contains("landingType") && ds.Columns[0].Contains("IsBillOfEntry"))
                                datarow["landingType"] = Util.String(ds.Tables[0][0]["IsBillOfEntry"]);
                            if (this.ScreenObject.GridDataColumns.Contains("SchemeProductID"))
                                datarow["SchemeProductID"] = null;

                            datarow["ExtraXML"] = null;
                        }

                        if (this.ScreenObject.Preferences.ContainsKey("ResetFields") && this.ScreenObject.Preferences["ResetFields"].toString() != "") {
                            let filter: string[] = [];

                            let flds = this.ScreenObject.Preferences["ResetFields"].toString().split(',');
                            for (let i = 0; i < flds.length; i++) {
                                filter.push(flds[i]);
                                if (this.ScreenObject.GridDataColumns.Contains(flds[i]))
                                    datarow[flds[i]] = null;

                                if (this.ScreenObject.GridDataColumns.Contains(flds[i] + "_Key"))
                                    datarow[flds[i] + "_Key"] = null;
                                let IsValueChange = false;
                                if (flds[i].toLowerCase() == "debitaccount" && this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key")
                                    && !Util.IsEmpty(ds.Tables[0][0]["DrAccount"])) {
                                    if (Util.String(datarow["DebitAccount_Key"]) != ds.Tables[0][0]["DrAccount"].toString())
                                        IsValueChange = true;

                                    datarow["DebitAccount_Key"] = ds.Tables[0][0]["DrAccount"].toString();
                                    if (this.ScreenObject.GridDataColumns.Contains("DebitAccount"))
                                        datarow["DebitAccount"] = ds.Tables[0][0]["DrName"].toString();
                                    else {
                                        var dbcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "debitaccount_key");
                                        if (dbcol != undefined)
                                            datarow[dbcol.DisplayMember] = ds.Tables[0][0]["DrName"].toString();
                                    }

                                    if (IsValueChange) {
                                        var dbcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "debitaccount_key");

                                        if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == dbcol.ID).length > 0) {
                                            this.ScreenObject.GetLinkReferenceData(parseInt(col.ID), this.DocumentID, parseInt(datarow[dbcol.ValueMember]), new Date(), "", dbcol.CostCenterID, datarow);
                                        }

                                        //Budget Dimension Auto Load
                                        if (BaseService.SessionManager.Preferences["BudgetAccount"].length > 0 && BaseService.SessionManager.Preferences["BudgetDimension"].length > 0)
                                            this.BudgetObj.AutoLoadBudgetDimension(datarow, null);
                                    }
                                }
                                else if (flds[i].toLowerCase() == "creditaccount" && this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")
                                    && !Util.IsEmpty(ds.Tables[0][0]["CrAccount"])) {
                                    if (Util.String(datarow["CreditAccount_Key"]) != ds.Tables[0][0]["CrAccount"].toString())
                                        IsValueChange = true;

                                    datarow["CreditAccount_Key"] = ds.Tables[0][0]["CrAccount"].toString();
                                    if (this.ScreenObject.GridDataColumns.Contains("CreditAccount"))
                                        datarow["CreditAccount"] = ds.Tables[0][0]["CrName"].toString();
                                    else {
                                        var dbcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "creditaccount_key");
                                        if (dbcol != undefined)
                                            datarow[dbcol.DisplayMember] = ds.Tables[0][0]["CrName"].toString();
                                    }

                                    if (IsValueChange) {
                                        var dbcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "creditaccount_key");

                                        if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == dbcol.ID).length > 0) {
                                            this.ScreenObject.GetLinkReferenceData(parseInt(col.ID), this.DocumentID, parseInt(datarow[dbcol.ValueMember]), new Date(), "", dbcol.CostCenterID, datarow);
                                        }

                                        //Budget Dimension Auto Load
                                        if (BaseService.SessionManager.Preferences["BudgetAccount"].length > 0 && BaseService.SessionManager.Preferences["BudgetDimension"].length > 0)
                                            this.BudgetObj.AutoLoadBudgetDimension(datarow, null);
                                    }
                                }
                                else {
                                    let drr = ds.Tables[4].filter(x => x.SysColumnName = flds[i]);
                                    if (drr.length > 0) {
                                        datarow[flds[i]] = Util.String(drr[0]["Value"]);
                                        datarow["default" + flds[i]] = Util.String(drr[0]["Value"]);
                                    }
                                    else {
                                        drr = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == flds[i] && x.LinkData != null && x.LinkData > 0);
                                        if (drr.length > 0) {
                                            if (ds.Tables[3].length > 0)
                                                this.FillLinkRefereceProducts(datarow, ds.Tables[0], ds.Tables[3][0], Util.String(drr[0]["LinkData"]));
                                            else
                                                this.FillLinkRefereceProducts(datarow, ds.Tables[0], null, Util.String(drr[0]["LinkData"]));
                                        }
                                        else if (flds[i] == "Unit" && ds.Tables.length > 0 && ds.Columns[0].Contains("uomid") && !Util.IsEmpty(ds.Tables[0][0]["uomid"])) {
                                            datarow["Unit"] = Util.String(ds.Tables[0][0]["UnitName"]);
                                            datarow["Unit_Key"] = Util.String(ds.Tables[0][0]["uomid"]);

                                        }
                                        else if (flds[i] == "Rate") {
                                            if (ds.Tables.length > 3 && ds.Tables[3].length > 0)//prices
                                            {
                                                if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                                                    if (!Util.IsEmpty(ds.Tables[3][0]["PurchaseRate"]))
                                                        datarow["Rate"] = ds.Tables[3][0]["PurchaseRate"];
                                                }
                                                else if (!Util.IsEmpty(ds.Tables[3][0]["SellingRate"]))
                                                    datarow["Rate"] = ds.Tables[3][0]["SellingRate"];
                                            }
                                            else if (ds.Tables.length > 0 && ds.Tables[0].length > 0)//prices
                                            {
                                                if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                                                    if (!Util.IsEmpty(ds.Tables[0][0]["PurchaseRate"]))
                                                        datarow["Rate"] = ds.Tables[0][0]["PurchaseRate"];
                                                }
                                                else if (!Util.IsEmpty(ds.Tables[0][0]["SellingRate"]))
                                                    datarow["Rate"] = ds.Tables[0][0]["SellingRate"];
                                            }
                                        }
                                    }
                                }
                            }

                            let data = this.ScreenObject.Data.Tables[0].filter(x => filter.Contains(x.SysColumnName) && x.LocalReference != null && x.LocalReference == col.ID);
                            if (data.length > 0)
                                this.ScreenObject.GetLinkReferenceData(parseInt(col.ID), this.DocumentID, parseInt(datarow["ProductID_Key"]), Date.Today(), "", 3, datarow, flds, false);

                            let ProdExtracol = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.ValueMember) && a.ValueMember.toLowerCase() == col.ValueMember.toLowerCase() && a.ID != col.ID);
                            if (ProdExtracol) {
                                data = this.ScreenObject.Data.Tables[0].filter(x => filter.Contains(x.SysColumnName) && x.LocalReference != null && x.LocalReference == ProdExtracol.ID);
                                if (data.length > 0)
                                    this.ScreenObject.GetLinkReferenceData(parseInt(ProdExtracol.ID), this.DocumentID, parseInt(datarow["ProductID_Key"]), Date.Today(), "", 3, datarow, flds, false);
                            }
                        }
                    }
                    if (!(this.ScreenObject.Preferences.ContainsKey("SubonProdChange") && this.ScreenObject.Preferences["SubonProdChange"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["SubonProdChange"]))
                        && !(this.ScreenObject.Preferences.ContainsKey("SubstituteOnQty") && this.ScreenObject.Preferences["SubstituteOnQty"].toString() != "" && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["SubstituteOnQty"]))
                        && this.ScreenObject.Preferences.ContainsKey("EnableSubtitutes") && this.ScreenObject.Preferences["EnableSubtitutes"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["EnableSubtitutes"])
                        && !Util.IsEmpty(datarow["ProductID_Key"]) && parseInt(datarow["ProductID_Key"]) == this.ProdID && ((Util.String(datarow["Subexists"]) == "1") || (this.ScreenObject.IsDocEdit))) {
                        let dssubdata = this.ScreenObject.GetSubtituteProducts(parseInt(datarow["ProductID_Key"]), this.DocumentDate, datarow["DocDetailsID"].toString(), datarow)
                        if (dssubdata.Tables.length > 0 && !dssubdata.Columns[0].Contains("ErrorMessage") && dssubdata.Tables[0].length > 1) {
                            let sb = new SubsituteProductsViewModel(this, dssubdata.Tables[0], dssubdata.Columns[0], dssubdata.Tables[1], datarow["ProductName"].toString(), datarow["ProductCode"].toString(), datarow["ProductID_Key"].toString())
                            if (sb.GridData.length > 0) {
                                BaseService.page
                                    .ShowDialog(sb, SubsituteProductsComponent, { ShowCenter: true })
                            }
                        }
                    }
                }
                else if ((Temppath == "ProductName" || Temppath == "ProductCode") && !Util.IsEmpty(datarow["ProductID_Key"])) {
                    if (!(this.ScreenObject.Preferences.ContainsKey("Dontresetvaluesonproductchange") && this.ScreenObject.Preferences["Dontresetvaluesonproductchange"] != "" && parseBoolean(this.ScreenObject.Preferences["Dontresetvaluesonproductchange"])))
                        this.ClearDatarow(datarow, false);
                }
                else if (this.ScreenObject.DocumentType == 35 && (Temppath == "dcAlpha13" || Temppath == "dcAlpha14")) {
                    let StDate = new Date();
                    let EnDate = new Date();
                    if (!Util.IsEmpty(datarow["dcAlpha13"]))
                        StDate = Util.ParseDate(datarow["dcAlpha13_Key"]);

                    if (!Util.IsEmpty(datarow["dcAlpha14"]))
                        EnDate = Util.ParseDate(datarow["dcAlpha14_Key"]);

                    if (StDate != null && EnDate != null && StDate.getFullYear() > 1 && EnDate.getFullYear() > 1) {
                        if (this.DocumentDate >= StDate && this.DocumentDate <= EnDate)
                            datarow["dcAlpha15"] = "Warranty";
                        else
                            datarow["dcAlpha15"] = "Out of Warranty";
                    }
                }
                Logger.InfoLog("AddEditDocumentViewModel::Entering OnCellEditEnding");
            }
            else {
                if (strBindingPaths == "CreditAccount" || strBindingPaths == "DebitAccount" || strBindingPaths == "AccountCode" || strBindingPaths == "AccountName" || strBindingPaths == "AccountID" || strBindingPaths == "AccountID_Key") {
                    if (col && this.ScreenObject.GridDataColumns.Contains(col.ValueMember) && !Util.IsEmpty(datarow[col.ValueMember]))
                        this.RepeatRowData(datarow);
                    this.BindDivisionorLocation(datarow);
                    if (datarow[strBindingPaths] != null && !Util.IsEmpty(datarow[strBindingPaths])) {
                        let NumCol = this.ScreenObject.ColumnSource.filter(a => a.DisplayMember.Contains("dcNum"));
                        NumCol.forEach(item => {
                            if (this.ScreenObject.GridDataColumns.Contains("dcCurrID" + item.DisplayMember.replace("dcNum", "").toString() + "_Key"))
                                datarow["dcCurrID" + item.DisplayMember.replace("dcNum", "").toString() + "_Key"] = item.DefaultValue;
                            if (this.ScreenObject.GridDataColumns.Contains("dcExchRT" + item.DisplayMember.replace("dcNum", "").toString()))
                                datarow["dcExchRT" + item.DisplayMember.replace("dcNum", "").toString()] = this.ScreenObject.GetExchangeRate(parseInt(item.DefaultValue), this.DocumentDate);
                        });
                        this.ScreenObject.GridDataObj.updateRow(datarow);
                    }
                    if ((strBindingPaths == "AccountCode" || strBindingPaths == "AccountName")) {
                        if ((this.ScreenObject.DocumentType == 18 || this.ScreenObject.DocumentType == 19 || this.ScreenObject.DocumentType == 21 || this.ScreenObject.DocumentType == 22) && !Util.IsEmpty(datarow["CreditAccount_Key"])) {
                            if (this.ScreenObject.Preferences.ContainsKey("Valueonbillwise") && this.ScreenObject.Preferences["Valueonbillwise"] != "" && parseBoolean(this.ScreenObject.Preferences["Valueonbillwise"]))
                                this.CheckIsBillWise(parseInt(datarow["CreditAccount_Key"].toString()), datarow, strBindingPaths, 0, true, CurrID, ExhgRate);
                        }
                        if ((this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 15 || this.ScreenObject.DocumentType == 20 || this.ScreenObject.DocumentType == 23) && !Util.IsEmpty(datarow["DebitAccount_Key"])) {
                            if (this.ScreenObject.Preferences.ContainsKey("Valueonbillwise") && this.ScreenObject.Preferences["Valueonbillwise"] != "" && parseBoolean(this.ScreenObject.Preferences["Valueonbillwise"]))
                                this.CheckIsBillWise(parseInt(datarow["DebitAccount_Key"].toString()), datarow, strBindingPaths, 0, false, CurrID, ExhgRate);
                        }
                    }
                }
            }

            //Budget Dimension Auto Load
            if (col.CostCenterID == 2 && BaseService.SessionManager.Preferences["BudgetAccount"].length > 0 && BaseService.SessionManager.Preferences["BudgetDimension"].length > 0) {
                if (datarow[col.ValueMember].toString() != this.PrevValue)
                    this.BudgetObj.AutoLoadBudgetDimension(datarow, null);
            }

            if (!(!this.IsInventoryVoucher && this.ScreenObject.Preferences.ContainsKey("DbCrBills") && Util.String(this.ScreenObject.Preferences["DbCrBills"]) == "True"
                && this.ScreenObject.Preferences.ContainsKey("NetAmountFld") && this.ScreenObject.Preferences["NetAmountFld"] == strBindingPaths))
                this.CalculateTotals(datarow, false, strBindingPaths);

            if (!this.IsInventoryVoucher) {
                let DbCrNetFld = '';
                if (this.ScreenObject.Preferences.ContainsKey("DbCrBills") && Util.String(this.ScreenObject.Preferences["DbCrBills"]) == "True"
                    && this.ScreenObject.Preferences.ContainsKey("NetAmountFld") && !Util.IsEmpty(this.ScreenObject.Preferences["NetAmountFld"]))
                    DbCrNetFld = this.ScreenObject.Preferences["NetAmountFld"];

                if ((DbCrNetFld == '' && strBindingPaths == "Amount") || (DbCrNetFld == strBindingPaths)) {
                    let ValuonBillwise = false;
                    if (this.ScreenObject.Preferences.ContainsKey("Valueonbillwise"))
                        ValuonBillwise = parseBoolean(this.ScreenObject.Preferences["Valueonbillwise"]);
                    if (datarow[strBindingPaths] != null && parseFloat(datarow[strBindingPaths]) != 0) {
                        if (this.ScreenObject.DocumentType == 18 || this.ScreenObject.DocumentType == 19 || this.ScreenObject.DocumentType == 21 || this.ScreenObject.DocumentType == 22) {
                            if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(datarow["CreditAccount_Key"])) {
                                if (!Util.IsEmpty(datarow[strBindingPaths])) {
                                    //this.CheckDistCosts(parseInt(datarow["CreditAccount_Key"].toString()), datarow, parseFloat(datarow[strBindingPaths]), strBindingPaths);
                                    if (!ValuonBillwise)
                                        this.CheckIsBillWise(parseInt(datarow["CreditAccount_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), true, CurrID, ExhgRate, "", DbCrNetFld, () => {
                                            this.ChequeReturn(parseInt(datarow["CreditAccount_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), true, CurrID, ExhgRate);
                                        });
                                }
                            }
                        }
                        else if (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 15 || this.ScreenObject.DocumentType == 20 || this.ScreenObject.DocumentType == 23) {
                            if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(datarow["DebitAccount_Key"])) {
                                if (!Util.IsEmpty(datarow[strBindingPaths])) {
                                    //this.CheckDistCosts(parseInt(datarow["DebitAccount_Key"].toString()), datarow, parseFloat(datarow[strBindingPaths]), strBindingPaths);
                                    if (!ValuonBillwise)
                                        this.CheckIsBillWise(parseInt(datarow["DebitAccount_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), false, CurrID, ExhgRate, "", DbCrNetFld, () => {
                                            this.ChequeReturn(parseInt(datarow["DebitAccount_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), false, CurrID, ExhgRate);

                                        });
                                }
                            }
                        }
                    }
                }
                else if (strBindingPaths == "DebitAmount") {
                    if (datarow[strBindingPaths] != null && parseFloat(datarow[strBindingPaths]) != 0 && !Util.IsEmpty(datarow["AccountID_Key"])) {
                        if (!Util.IsEmpty(datarow[strBindingPaths])) {
                            //this.CheckDistCosts(parseInt(datarow["AccountID_Key"]), datarow, parseFloat(datarow[strBindingPaths]), strBindingPaths);

                            this.CheckIsBillWise(parseInt(datarow["AccountID_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), false, CurrID, ExhgRate);
                            this.ChequeReturn(parseInt(datarow["AccountID_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), false, CurrID, ExhgRate);
                        }
                        if (this.ScreenObject.GridDataColumns.Contains("CreditAmount"))
                            datarow["CreditAmount"] = 0;
                    }

                }
                else if (strBindingPaths == "CreditAmount") {
                    if (datarow[strBindingPaths] != null && parseFloat(datarow[strBindingPaths]) != 0 && !Util.IsEmpty(datarow["AccountID_Key"])) {
                        //this.CheckDistCosts(parseInt(datarow["AccountID_Key"]), datarow, parseFloat(datarow[strBindingPaths]), strBindingPaths);
                        this.CheckIsBillWise(parseInt(datarow["AccountID_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), true, CurrID, ExhgRate);
                        this.ChequeReturn(parseInt(datarow["AccountID_Key"]), datarow, strBindingPaths, parseFloat(datarow[strBindingPaths]), true, CurrID, ExhgRate);

                        if (this.ScreenObject.GridDataColumns.Contains("DebitAmount"))
                            datarow["DebitAmount"] = 0;
                    }
                }
            }
            if (col != null)
                this.ValidateData_Column(col, datarow);

            let schemes = false;
            if (this.ScreenObject.Preferences.ContainsKey("EnableSchemes") && parseBoolean(this.ScreenObject.Preferences["EnableSchemes"]))
                schemes = parseBoolean(this.ScreenObject.Preferences["EnableSchemes"]);
            if (schemes) {
                let GrossFld = "GROSS";
                if (this.ScreenObject.Preferences.ContainsKey("SchemesNumericFields") && this.ScreenObject.Preferences["SchemesNumericFields"] != "" && this.ScreenObject.Preferences["SchemesNumericFields"] != "0") {
                    let Col = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["SchemesNumericFields"]);
                    if (Col && Col.DisplayMember != "")
                        GrossFld = Col.DisplayMember;
                }
                if (strBindingPaths == "Quantity" || strBindingPaths == "ProductID" || strBindingPaths.toLowerCase() == GrossFld.toLowerCase() || strBindingPaths.toLowerCase() == "rate" || strBindingPaths.toLowerCase() == "gross") {
                    if (!Util.IsEmpty(datarow["ProductID_Key"]) && parseInt(datarow["ProductID_Key"]) > 0) {
                        let ds = this.ScreenObject.GetSchemes(this.DocumentDate, datarow);
                        if (ds.Tables.length > 0 && ds.Columns[0].Contains("SchemeID"))
                            this.fillSchemevalues(ds.Tables[0], ds.Columns[0], datarow);
                    }
                    this.ApplySchemes(datarow);
                }
            }

            //#region AddifSingleattachment
            if (CostCenterID > 0)
                for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
                    if (this.ScreenObject.ColumnSource[i].DisplayMember == "ModSelect" || this.ScreenObject.ColumnSource[i].DisplayMember == "ModifierName")
                        continue;
                    if (this.ScreenObject.ColumnSource[i].DataType == "LINK" && !this.ScreenObject.ColumnSource[i].Dependantinuse && this.ScreenObject.ColumnSource[i].Mandatory && !Util.IsEmpty(this.ScreenObject.ColumnSource[i].FilterCondition) && this.ScreenObject.ColumnSource[i].FilterCondition.split(',').Contains(CostCenterID.toString())) {
                        this.RowAttachments(this.ScreenObject.ColumnSource[i].DisplayMember, true, datarow);
                    }
                }
            //#endregion

            //#region "Apply leave & Leave Encashment"
            if ((this.ScreenObject.DocumentType == 62 && (strBindingPaths.toLowerCase() == "dcccnid52" || strBindingPaths.toLowerCase() == "dcalpha4")) || (this.ScreenObject.CostCenterID == 40058 && (strBindingPaths.toLowerCase() == "dcccnid52"))) {
                let EmpID, LtID;
                EmpID = LtID = 0;

                let fldAPl = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (fldAPl != null && fldAPl instanceof PactListBoxData && fldAPl.SelectedValue > 0)
                    EmpID = fldAPl.SelectedValue;
                else if (fldAPl != null && fldAPl instanceof PactCodeNameListBoxData && fldAPl.SelectedValue > 0)
                    EmpID = fldAPl.SelectedValue;

                let fldAPl1 = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50052);
                if (fldAPl1 && fldAPl1 instanceof DgColumn && datarow[fldAPl1.ValueMember] != null)
                    LtID = parseInt(datarow[fldAPl1.ValueMember]);

                if (EmpID > 0 && LtID > 0) {
                    let outrefobj = { IfFormulaExistsNoOfDays: false }
                    this.DisplayMessage = this.IsLeaveTypeValid(EmpID, LtID, datarow, outrefobj);
                    if (this.DisplayMessage != "") {
                        this.MessageVisibility = true;
                        if (this.ScreenObject.CostCenterID == 40058) {
                            fldAPl1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                            if (fldAPl1)
                                datarow[fldAPl1.DisplayMember] = 0;
                        }

                        if (!outrefobj.IfFormulaExistsNoOfDays) {
                            fldAPl1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                            if (fldAPl1)
                                datarow[fldAPl1.DisplayMember] = 0;

                            fldAPl1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                            if (fldAPl1)
                                datarow[fldAPl1.DisplayMember] = 0;
                            return;
                        }
                    }
                    else
                        this.MessageVisibility = false;

                }
                this.ScreenObject.GridDataObj.updateRow(datarow);
            }
            //#endregion

            //#region "DOJ Validation"
            if ((this.ScreenObject.CostCenterID == 40055 && strBindingPaths.toLowerCase() == "dcalpha1" && datarow["dcAlpha1"] != null) ||
                (this.ScreenObject.CostCenterID == 40057 && (strBindingPaths.toLowerCase() == "dcalpha5" && datarow["dcAlpha5"] != null ||
                    strBindingPaths.toLowerCase() == "dcalpha4" && datarow["dcAlpha4"] != null))) {
                this.DisplayMessage = this.IsDateValid(datarow, strBindingPaths);
                if (this.DisplayMessage) {
                    datarow["Rate"] = -1;
                    return;
                }
                else {
                    datarow["Rate"] = 0;
                    this.MessageVisibility = false;
                }
            }
            //#endregion

            //#region "Assign Leave"
            if (this.ScreenObject.CostCenterID == 40060 && this.ScreenObject.DocumentType == 60) {
                //Start: For checking the Fromdate and ToDate value validations and convert the datevalue to dd-MMM-yyyy format
                if (strBindingPaths == "dcAlpha3" || strBindingPaths == "dcAlpha4") {
                    if (datarow["dcAlpha3_Key"] != null && datarow["dcAlpha4_Key"] != null) {
                        datarow["dcAlpha3"] = Util.ParseDate(datarow["dcAlpha3_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        //datarow["dcAlpha3_Key"] = Util.ParseDate(datarow["dcAlpha3_Key"]);
                        datarow["dcAlpha4"] = Util.ParseDate(datarow["dcAlpha4_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        //datarow["dcAlpha4_Key"] = Util.ParseDate(datarow["dcAlpha4_Key"]);

                        if (strBindingPaths == "dcAlpha3") {
                            if ((Util.ParseDate(datarow["dcAlpha3_Key"]) > Util.ParseDate(datarow["dcAlpha4_Key"]))) {
                                strValidationMsg = "Fromdate should be less than or equal to Todate" + "\r\n";
                                datarow["dcNum6"] = 2;
                            }
                            else {
                                datarow["dcNum6"] = 0;
                            }
                        }
                        if (strBindingPaths == "dcAlpha4") {
                            if ((Util.ParseDate(datarow["dcAlpha4_Key"]) < Util.ParseDate(datarow["dcAlpha3_Key"]))) {
                                strValidationMsg = "Todate should be greater than or equal to Fromdate" + "\r\n";
                                datarow["dcNum6"] = 2;
                            }
                            else {
                                datarow["dcNum6"] = 0;
                            }
                        }
                        if (strValidationMsg) {
                            this.DisplayMessage = strValidationMsg;
                            return;
                        }
                        else {
                            this.DisplayMessage = "";
                        }
                    }
                }
                //End: For checking the Fromdate and ToDate value validations and convert the datevalue to dd-MMM-yyyy format
                if (strBindingPaths == "dcAlpha4" && datarow["dcAlpha4_Key"] != null && datarow["dcAlpha5_Key"] != null) {
                    if ((Util.ParseDate(datarow["dcAlpha4_Key"]) > Util.ParseDate(datarow["dcAlpha5_Key"]))) {
                        datarow["dcNum6"] = 1;
                        this.DisplayMessage = "ToDate should be less than Leaveyear enddate (" + Util.ParseDate(datarow["dcAlpha5_Key"]).ToString("dd-MMM-yyyy") + ")";

                        return;
                    }
                    else {
                        datarow["dcNum6"] = 0;
                        this.DisplayMessage = "";
                        this.MessageVisibility = false;
                    }
                }
            }
            //#endregion

            //#region "Apply Leave"
            if (this.ScreenObject.DocumentType == 62) {
                if (parseInt(datarow["DocDetailsID"]) > 0 && parseInt(datarow["dcAlpha10"]) == 2 && col.Mode == 3 && (strBindingPaths == "dcAlpha4" || strBindingPaths.toLowerCase() == "dcccnid52")) {
                    let index = 0;
                    index = parseInt(datarow["DocSeqNo"]);
                    for (let p = 0; p < this.dtData.length; p++) {
                        if (p == index - 1) {
                            if (parseInt(datarow["dcCCNID52_Key"]) == parseInt(this.dtData[p]["dcCCNID52"])) {
                                if (strBindingPaths == "dcAlpha4") {
                                    if (datarow["dcAlpha4_Key"] != null) {
                                        if ((Util.ParseDate(datarow["dcAlpha4_Key"]) > Util.ParseDate(datarow["dcAlpha5_Key"])) && Util.String(datarow["dcAlpha6"]) == "Both") {
                                            datarow["dcAlpha5"] = Util.ParseDate(datarow["dcAlpha4_Key"]).AddDays(1);
                                            datarow["dcAlpha5_Key"] = Util.ParseDate(datarow["dcAlpha4_Key"]).AddDays(1);
                                        }
                                    }
                                }
                                return;
                            }
                        }
                    }
                }
                //Start: For checking the Fromdate and ToDate value not null and date validations and convert the datevalue to dd-MMM-yyyy format
                if (strBindingPaths == "dcAlpha4" || strBindingPaths == "dcAlpha5" || strBindingPaths == "dcAlpha6") {
                    if (datarow["dcAlpha4_Key"] != null && datarow["dcAlpha5_Key"] != null) {
                        datarow["dcAlpha4"] = Util.ParseDate(datarow["dcAlpha4_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        //datarow["dcAlpha4_Key"] = Util.ParseDate(datarow["dcAlpha4_Key"]);//.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        datarow["dcAlpha5"] = Util.ParseDate(datarow["dcAlpha5_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        //datarow["dcAlpha5_Key"] = Util.ParseDate(datarow["dcAlpha5_Key"]);//.ToString(BaseService.SessionManager.Preferences["Date Format"]);

                        if (strBindingPaths == "dcAlpha4") {
                            if ((Util.ParseDate(datarow["dcAlpha4_Key"]) > Util.ParseDate(datarow["dcAlpha5_Key"])) && Util.String(datarow["dcAlpha6"]) == "Both") {
                                datarow["dcAlpha5"] = Util.ParseDate(datarow["dcAlpha4_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                datarow["dcAlpha5_Key"] = Util.ParseDate(datarow["dcAlpha4_Key"]);
                            }

                            if ((Util.ParseDate(datarow["dcAlpha5_Key"]) >= Util.ParseDate(datarow["dcAlpha4_Key"])) && Util.String(datarow["dcAlpha6"]) == "Both") {
                                let col1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcAlpha5");
                                if (col1 && !Util.IsEmpty(col1.Shortcut) && col1.Shortcut.toLowerCase() == "lostfocus" && this.ValidateData_Column(col1, datarow, true))
                                    this.ScreenObject.GetExternalFuncData(col1.Mode, col1.SPName, col1.IPParams, col1.OPParams, datarow);
                            }

                        }
                        if (strBindingPaths == "dcAlpha5") {
                            if ((Util.ParseDate(datarow["dcAlpha5_kKey"]) < Util.ParseDate(datarow["dcAlpha4_Key"])) && Util.String(datarow["dcAlpha6"]) == "Both") {
                                datarow["dcAlpha4"] = Util.ParseDate(datarow["dcAlpha5_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                datarow["dcAlpha4_Key"] = Util.ParseDate(datarow["dcAlpha5_Key"]);
                                strValidationMsg = "Todate should be greater than or equal to Fromdate" + "\r\n";
                            }

                            //#region CHECKING Next day to ToDate is WeeklyOff/Holiday

                            let EmpID, LtID;
                            EmpID = LtID = 0;

                            let fldAPl = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                            if (fldAPl instanceof PactListBoxData && fldAPl.SelectedValue > 0)
                                EmpID = fldAPl.SelectedValue;
                            else if (fldAPl instanceof PactCodeNameListBoxData && fldAPl.SelectedValue > 0)
                                EmpID = fldAPl.SelectedValue;

                            let fldAPl1 = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50052);
                            if (fldAPl1 && fldAPl1 instanceof DgColumn && datarow[fldAPl1.ValueMember] != null)
                                LtID = parseInt(datarow[fldAPl1.ValueMember]);

                            if (EmpID > 0 && LtID > 0) {
                                let dsStr = Util.GetPayrollStructureBasedonEmployee(EmpID, Util.ParseDate(datarow["dcAlpha4_Key"].ToString("dd-MMM-yyyy")));
                                let dvDS = dsStr.Tables[0].filter(x => x.Type == 4 && x.ComponentID == LtID);
                                if (dvDS != null && dvDS.length > 0) {
                                    if (dvDS[0]["LeaveOthFeatures"] != null && dvDS[0]["LeaveOthFeatures"] != null && dvDS[0]["LeaveOthFeatures"].toString().trim() != "") {
                                        let i = 0;
                                        let sAr = dvDS[0]["LeaveOthFeatures"].toString().split(';');
                                        if (sAr != null && sAr.length > 0) {
                                            for (let l = 0; l < sAr.length; l++) {
                                                if (sAr[l] != null && sAr[l].startsWith("#ContLeaveS_")) {
                                                    let sD = sAr[l].replace("#", "").split('_');
                                                    if (sD.length > 2) {
                                                        let iD = parseInt(sD[1]);

                                                        let tsD: TimeSpan = Util.ParseDate(datarow["dcAlpha5_Key"]).Date().Subtract(Util.ParseDate(datarow["dcAlpha4_Key"]).Date());
                                                        if ((tsD.TotalDays + 1) >= iD) {
                                                            let tmp = 1, tmp1 = 0;
                                                            do {
                                                                tmp1 = 0;
                                                                let dtmp = Util.ParseDate(datarow["dcAlpha5_Key"]).Date();
                                                                if (this.objPayDayCheck == null)
                                                                    this.objPayDayCheck = new PayDayCheck(this.ScreenObject);
                                                                this.objPayDayCheck.CheckIsHolidayDate(EmpID.toString(), dtmp.AddDays(1).ToString("dd/MMM/yyyy"), datarow);
                                                                if (!Util.IsEmpty(datarow["PayrollType"])) {
                                                                    if ((datarow["PayrollType"].toString() == "WeeklyOff" && Util.String(sD[2]) == "W") || (datarow["PayrollType"].toString() == "Holiday" && Util.String(sD[2]) == "H") || ((datarow["PayrollType"].toString() == "WeeklyOff" || datarow["PayrollType"].toString() == "Holiday") && Util.String(sD[2]) == "WH")) //Holiday WeeklyOff
                                                                    {
                                                                        if (i == 0) {
                                                                            if (confirm("WeeklyOff/Holiday days will be considered, Are you sure want to Proceed.? ")) {
                                                                                datarow["dcAlpha5"] = dtmp.AddDays(1).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                                                datarow["dcAlpha5_Key"] = Util.ParseDate(dtmp.AddDays(1));
                                                                                tmp1 = 1;
                                                                                i = 1;
                                                                            }
                                                                            else {
                                                                                datarow["dcAlpha5"] = datarow["dcAlpha4"];
                                                                                datarow["dcAlpha5_Key"] = datarow["dcAlpha4_Key"];
                                                                            }
                                                                        }
                                                                        else {
                                                                            datarow["dcAlpha5"] = dtmp.AddDays(1).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                                            datarow["dcAlpha5_Key"] = Util.ParseDate(dtmp.AddDays(1));
                                                                            tmp1 = 1;
                                                                        }
                                                                        this.ScreenObject.GridDataObj.updateRow(datarow);
                                                                    }
                                                                }
                                                            } while (tmp == tmp1);

                                                        }
                                                    }
                                                }
                                                if (sAr[l] != null && sAr[l].startsWith("#ContLeaveP_")) {
                                                    let sD = sAr[l].replace("#", "").split('_');
                                                    if (sD.length > 2) {
                                                        let iD = parseInt(sD[1]);
                                                        let tsD: TimeSpan = Util.ParseDate(datarow["dcAlpha5_Key"]).Date().Subtract(Util.ParseDate(datarow["dcAlpha4_Key"]).Date());
                                                        if ((tsD.TotalDays + 1) >= iD) {
                                                            let tmp = 1, tmp1 = 0;
                                                            do {
                                                                tmp1 = 0;
                                                                let dtmp = Util.ParseDate(datarow["dcAlpha4_Key"]).Date();
                                                                if (this.objPayDayCheck == null)
                                                                    this.objPayDayCheck = new PayDayCheck(this.ScreenObject);
                                                                this.objPayDayCheck.CheckIsHolidayDate(EmpID.toString(), dtmp.AddDays(-1).ToString("dd/MMM/yyyy"), datarow);
                                                                if (!Util.IsEmpty(datarow["PayrollType"])) {
                                                                    if ((datarow["PayrollType"].toString() == "WeeklyOff" && Util.String(sD[2]) == "W") || (datarow["PayrollType"].toString() == "Holiday" && Util.String(sD[2]) == "H") || ((datarow["PayrollType"].toString() == "WeeklyOff" || datarow["PayrollType"].toString() == "Holiday") && Util.String(sD[2]) == "WH")) //Holiday WeeklyOff
                                                                    {
                                                                        if (i == 0) {
                                                                            if (confirm("WeeklyOff/Holiday days will be considered, Are you sure want to Proceed.? ")) {
                                                                                datarow["dcAlpha4"] = dtmp.AddDays(-1).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                                                datarow["dcAlpha4_Key"] = dtmp.AddDays(-1);
                                                                                tmp1 = 1;
                                                                                i = 1;
                                                                            }
                                                                            else {
                                                                                datarow["dcAlpha4"] = datarow["dcAlpha5"];
                                                                                datarow["dcAlpha4_Key"] = datarow["dcAlpha5_Key"];
                                                                            }
                                                                        }
                                                                        else {
                                                                            datarow["dcAlpha4"] = dtmp.AddDays(-1).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                                            datarow["dcAlpha4_Key"] = Util.ParseDate(dtmp.AddDays(-1));
                                                                            tmp1 = 1;
                                                                        }
                                                                        this.ScreenObject.GridDataObj.updateRow(datarow);
                                                                    }
                                                                }
                                                            } while (tmp == tmp1);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            //#endregion
                        }

                        if (strValidationMsg) {
                            this.DisplayMessage = strValidationMsg;
                            return;
                        }
                        else {
                            this.DisplayMessage = "";
                        }
                    }
                }
                //End: For checking the Fromdate and ToDate value and convert the datevalue to dd-MMM-yyyy format
                //Start: For checking the duplicate rows in grid (Fromdate and Todate)
                // if (datarow.Table.length > 1 && datarow.Table[1]["dcCCNID52_Key"] != null) {
                if (this.ScreenObject.GridData.length > 1 && !Util.IsEmpty(this.ScreenObject.GridData[1]["dcCCNID52_Key"])) {
                    let index;
                    index = parseInt(datarow[Object.keys(datarow)[1]]) - 1;
                    for (let i = 0; i < this.ScreenObject.GridData.length - 1; i++) {
                        if (i != index && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha4_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[index]["dcAlpha5_Key"])) {
                            if ((Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha4_Key"]) &&
                                Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha5_Key"]))
                                ||
                                (Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha4_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) &&
                                    Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha4_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]))) {
                                this.DisplayMessage = "FromDate already exist";
                                this.ScreenObject.GridData[index]["dcAlpha7"] = 0;
                                return;
                            }
                            else {
                                this.DisplayMessage = "";
                            }
                        }
                        if (i != index && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha5_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[index]["dcAlpha4_Key"])) {
                            if (i != index && (Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha4_Key"]) &&
                                Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha5_Key"]))
                                ||
                                (Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha5_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) &&
                                    Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha5_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]))) {
                                this.DisplayMessage = "ToDate already exist";
                                this.ScreenObject.GridData[index]["dcAlpha7"] = 0;
                                return;
                            }
                            else {
                                if ((parseInt(this.ScreenObject.GridData[index]["dcCCNID52_Key"]) == parseInt(this.ScreenObject.GridData[i]["dcCCNID52_Key"])) && (parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]) == parseFloat(this.ScreenObject.GridData[i]["dcAlpha3"]))) {
                                    this.ScreenObject.GridData[index]["dcAlpha3"] = parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]) - parseFloat(this.ScreenObject.GridData[i]["dcAlpha7"]);
                                }
                                this.DisplayMessage = "";
                            }
                        }
                    }
                }
                //End: For checking the duplicate rows in grid (Fromdate and Todate)
            }
            //#endregion

            //#region "Consolidated Leave"
            if (this.ScreenObject.DocumentType == 63) {
                this.ScreenObject.GridDataObj.updateRow(datarow);
                if (parseInt(datarow["DocDetailsID"]) > 0 && col.Mode == 3 && (strBindingPaths == "dcAlpha4" || strBindingPaths.toLowerCase() == "dcccnid52")) {
                    let index = 0;
                    index = parseInt(datarow["DocSeqNo"]);
                    for (let p = 0; p < this.dtData.length; p++) {
                        if (p == index - 1) {
                            if (parseInt(datarow["dcCCNID51_Key"]) == parseInt(this.dtData[p]["dcCCNID51"]) && parseInt(datarow["dcCCNID52_Key"]) == parseInt(this.dtData[p]["dcCCNID52"])) {
                                if (strBindingPaths == "dcAlpha4") {
                                    if (datarow["dcAlpha4_Key"] != null) {
                                        if ((Util.ParseDate(datarow["dcAlpha4_Key"]) > Util.ParseDate(datarow["dcAlpha5_Key"])) && Util.String(datarow["dcAlpha6"]) == "Both") {
                                            datarow["dcAlpha5"] = Util.ParseDate(datarow["dcAlpha4_Key"]).AddDays(1);
                                            datarow["dcAlpha5_Key"] = Util.ParseDate(datarow["dcAlpha4_Key"]).AddDays(1);
                                        }
                                    }
                                }
                                return;
                            }
                        }
                    }
                }
                //Start: For checking the Fromdate and ToDate value not null and date validations and convert the datevalue to dd-MMM-yyyy format
                if (strBindingPaths == "dcAlpha4" || strBindingPaths == "dcAlpha5" || strBindingPaths == "dcAlpha6") {
                    if (datarow["dcAlpha4_Key"] != null && datarow["dcAlpha5_Key"] != null) {
                        datarow["dcAlpha4"] = Util.ParseDate(datarow["dcAlpha4_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        datarow["dcAlpha4_Key"] = Util.ParseDate(datarow["dcAlpha4_Key"]);//.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        datarow["dcAlpha5"] = Util.ParseDate(datarow["dcAlpha5_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        datarow["dcAlpha5_Key"] = Util.ParseDate(datarow["dcAlpha5_Key"]);//.ToString(BaseService.SessionManager.Preferences["Date Format"]);

                        if (strBindingPaths == "dcAlpha4") {
                            if ((Util.ParseDate(datarow["dcAlpha4_Key"]) > Util.ParseDate(datarow["dcAlpha5_Key"])) && Util.String(datarow["dcAlpha6"]) == "Both") {
                                datarow["dcAlpha5"] = Util.ParseDate(datarow["dcAlpha4_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                datarow["dcAlpha5_Key"] = Util.ParseDate(datarow["dcAlpha4_Key"]);
                            }

                            if ((Util.ParseDate(datarow["dcAlpha5_Key"]) >= Util.ParseDate(datarow["dcAlpha4_Key"])) && Util.String(datarow["dcAlpha6"]) == "Both") {
                                let col1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcAlpha5");
                                if (col1 && !Util.IsEmpty(col1.Shortcut) && col1.Shortcut.toLowerCase() == "lostfocus" && this.ValidateData_Column(col1, datarow, true))
                                    this.ScreenObject.GetExternalFuncData(col1.Mode, col1.SPName, col1.IPParams, col1.OPParams, datarow);
                            }
                        }
                        if (strBindingPaths == "dcAlpha5") {
                            if ((Util.ParseDate(datarow["dcAlpha5_Key"]) < Util.ParseDate(datarow["dcAlpha4_Key"])) && Util.String(datarow["dcAlpha6"]) == "Both") {
                                datarow["dcAlpha4"] = Util.ParseDate(datarow["dcAlpha5_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                datarow["dcAlpha4_Key"] = Util.ParseDate(datarow["dcAlpha5_Key"]);
                                strValidationMsg = "Todate should be greater than or equal to Fromdate" + "\r\n";
                            }
                        }

                        if (strValidationMsg) {
                            this.DisplayMessage = strValidationMsg;
                            return;
                        }
                        else {
                            this.DisplayMessage = "";
                        }
                    }
                }
                //End: For checking the Fromdate and ToDate value and convert the datevalue to dd-MMM-yyyy format
                //Start: For checking the duplicate rows in grid (Fromdate and Todate)
                if (!Util.IsEmpty(this.ScreenObject.GridData[1]["dcCCNID51_Key"])) {
                    let index;
                    index = parseInt(datarow[Object.keys(datarow)[1]]) - 1;
                    for (let i = 0; i < this.ScreenObject.GridData.length - 1; i++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID51_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID52_Key"])
                            && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha4_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha5_Key"])
                            && !Util.IsEmpty(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[index]["dcAlpha5_Key"])) {
                            if (i != index && (parseInt(this.ScreenObject.GridData[i]["dcCCNID51_Key"]) == parseInt(this.ScreenObject.GridData[index]["dcCCNID51_Key"]))
                                && (parseInt(this.ScreenObject.GridData[i]["dcCCNID52_Key"]) == parseInt(this.ScreenObject.GridData[index]["dcCCNID52_Key"]))
                                && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha4_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[index]["dcAlpha5_Key"])) {
                                if ((Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha4_Key"]) &&
                                    Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha5_Key"]))
                                    ||
                                    (Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha4_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) &&
                                        Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha4_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]))) {
                                    this.DisplayMessage = "FromDate already exist";
                                    this.ScreenObject.GridData[index]["dcAlpha7"] = 0;
                                    return;
                                }
                                else {
                                    this.DisplayMessage = "";
                                }
                            }
                            if (i != index && (parseInt(this.ScreenObject.GridData[i]["dcCCNID51_Key"]) == parseInt(this.ScreenObject.GridData[index]["dcCCNID51_Key"]))
                                && (parseInt(this.ScreenObject.GridData[i]["dcCCNID52_Key"]) == parseInt(this.ScreenObject.GridData[index]["dcCCNID52_Key"]))
                                && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha5_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[index]["dcAlpha4_Key"])) {
                                if (i != index && (Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha4_Key"]) &&
                                    Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha5_Key"]))
                                    ||
                                    (Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha5_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) &&
                                        Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha5_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]))) {

                                    this.DisplayMessage = "ToDate already exist";
                                    this.ScreenObject.GridData[index]["dcAlpha7"] = 0;
                                    return;
                                }
                                else {
                                    if ((parseInt(this.ScreenObject.GridData[index]["dcCCNID51_Key"]) == parseInt(this.ScreenObject.GridData[i]["dcCCNID51_Key"])) && (parseInt(this.ScreenObject.GridData[index]["dcCCNID52_Key"]) == parseInt(this.ScreenObject.GridData[i]["dcCCNID52_Key"])) && (parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]) == parseFloat(this.ScreenObject.GridData[i]["dcAlpha3"]))) {
                                        this.ScreenObject.GridData[index]["dcAlpha3"] = parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]) - parseFloat(this.ScreenObject.GridData[i]["dcNum1"]);
                                    }
                                    else if ((parseInt(this.ScreenObject.GridData[index]["dcCCNID51_Key"]) == parseInt(this.ScreenObject.GridData[i]["dcCCNID51_Key"])) && (parseInt(this.ScreenObject.GridData[index]["dcCCNID52_Key"]) == parseInt(this.ScreenObject.GridData[i]["dcCCNID52_Key"])) && (parseFloat(this.ScreenObject.GridData[i]["dcAlpha3"]) < parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]))) {
                                        this.ScreenObject.GridData[i]["dcAlpha3"] = parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]) - parseFloat(this.ScreenObject.GridData[i]["dcNum1"]);
                                    }
                                    this.DisplayMessage = "";
                                }
                            }
                        }
                    }
                    this.ScreenObject.GridDataObj.updateRow(datarow);
                }
                //End: For checking the duplicate rows in grid (Fromdate and Todate)
            }
            //#endregion

            //#region "Daily Attendance"
            if (this.ScreenObject.DocumentType == 67) {
                if (strBindingPaths == "dcCCNID51" || strBindingPaths == "dcCCNID51Code") {
                    let txtDatefld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                    if (txtDatefld && txtDatefld instanceof PactExtraFieldDateData && !txtDatefld.Date) {
                        this.DisplayMessage = "Select the daily attendance date";
                        return;
                    }
                }

                if (strBindingPaths == "dcNum2") {
                    if (datarow["PayrollType"].toString() == "WeeklyOff" || datarow["PayrollType"].toString() == "Holiday") {
                        if (!Util.IsEmpty(datarow["dcNum2"])) {
                            if (parseFloat(datarow["dcNum2"]) != -1 && parseFloat(datarow["dcNum2"]) != -2 && parseFloat(datarow["dcNum2"]) > 0) {
                                datarow["dcNum2"] = "0.00";
                            }
                        }
                    }
                }

                ////SSS
                if ((strBindingPaths == "dcCCNID51Code" || strBindingPaths == "dcCCNID51") && this.ScreenObject.GridDataColumns.Contains("dcCCNID51_Key") && Util.String(datarow["dcCCNID51_Key"]) == this.PrevValue)
                    return;

                if ((strBindingPaths == "dcAlpha1") && this.ScreenObject.GridDataColumns.Contains("dcAlpha1_Key") && Util.String(datarow["dcAlpha1_Key"]) == this.PrevValue)
                    return;

                if ((strBindingPaths == "dcAlpha2") && this.ScreenObject.GridDataColumns.Contains("dcAlpha2_Key") && Util.String(datarow["dcAlpha2_Key"]) == this.PrevValue)
                    return;

                if ((strBindingPaths == "dcAlpha3") && this.ScreenObject.GridDataColumns.Contains("dcAlpha3_Key") && Util.String(datarow["dcAlpha3_Key"]) == this.PrevValue)
                    return;

                if ((strBindingPaths == "dcNum1") && this.ScreenObject.GridDataColumns.Contains("dcNum1") && Util.String(datarow["dcNum1"]) == this.PrevValue)
                    return;

                if ((strBindingPaths == "dcCCNID73Code" || strBindingPaths == "dcCCNID73") && this.ScreenObject.GridDataColumns.Contains("dcCCNID73_Key") && Util.String(datarow["dcCCNID73_Key"]) == this.PrevValue)
                    return;
                ////SSS

                this.DailyAttendanceCellEditEnd(datarow, strBindingPaths, col);
            }
            //#endregion

            //#region "Apply Leave1"
            //Start: For showing Available and Noofdays leaves message
            if (this.ScreenObject.DocumentType == 62 && (strBindingPaths == "dcCCNID52" || strBindingPaths == "dcAlpha5")) {
                this.ScreenObject.GridDataObj.updateRow(datarow);
                if (datarow["dcAlpha3"] != null && datarow["dcAlpha9"] != null) {
                    if (parseFloat(datarow["dcAlpha3"]) <= 0 && (parseInt(datarow["dcAlpha9"]) >= 0 || parseInt(datarow["dcAlpha9"]) == -4))
                        strValidationMsg = "Please check the availability of leaves" + "\r\n";
                }

                if (datarow["dcAlpha7"] != null && strBindingPaths != "dcAlpha5") {
                    if (parseFloat(datarow["dcAlpha7"]) <= 0)
                        strValidationMsg = "Dates already applied | Selected dates between Holidays/Weeklyoffs" + "\r\n";
                }

                if (strValidationMsg) {
                    this.DisplayMessage = strValidationMsg;
                    return;
                }
                else {
                    this.DisplayMessage = "";
                }
            }
            //End: For showing Available and Noofdays leaves message
            //#endregion

            //#region "Daily Attendance"
            //  if (this.ScreenObject.DocumentType == 67)
            // {
            //     if (strBindingPaths == "dcCCNID51" || strBindingPaths == "dcAlpha3" || strBindingPaths == "dcCCNID2" || strBindingPaths == "dcAlpha1")
            //     {
            //         string TotalHours = "";
            //         if (datarow["dcAlpha3_Key"] != null && datarow["dcAlpha2_Key"] != null)
            //         {
            //             TimeSpan Hrs = Util.ParseDate(datarow["dcAlpha3_Key"]) - Util.ParseDate(datarow["dcAlpha2_Key"]);
            //             TotalHours = Hrs.Hours + "." + Hrs.Minutes;
            //             datarow["dcNum1"] = parseFloat(TotalHours);
            //         }

            //         if (datarow["dcAlpha5"] != null)
            //         {
            //             if (parseInt(datarow["dcAlpha5"]) > 0)
            //             {
            //                 let colDAT = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcnum2");
            //                 if (colDAT)
            //                 {
            //                     colDAT.ReadOnly = true;
            //                 }
            //                 colDAT = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcnum4");
            //                 if (colDAT)
            //                 {
            //                     colDAT.ReadOnly = true;
            //                 }
            //                 for(let i = 5; i < 13; i++)
            //                 {
            //                     colDAT = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcnum" + i.toString());
            //                     if (colDAT)
            //                     {
            //                         colDAT.ReadOnly = true;
            //                         if (colDAT.DisplayMember == "dcNum11" && parseInt(datarow["dcAlpha5"]) == 1)
            //                         {
            //                             colDAT.ReadOnly = false;
            //                         }
            //                         if (colDAT.DisplayMember == "dcNum13" && parseInt(datarow["dcAlpha5"]) == 2)
            //                         {
            //                             colDAT.ReadOnly = false;
            //                         }
            //                     }
            //                     i = i + 1;
            //                 }
            //             }
            //         }
            //     }

            //     if ((strBindingPaths == "dcNum1" || strBindingPaths == "dcNum2"))
            //     {
            //         //FOR RECHECKING THE NORMAL WORKING HOURS
            //         DataSet dsEmployee = null;
            //         let dtdat = new Date();
            //         TimeSpan CurrNrHrsDiff;
            //         string ActualNormalHours = "", strRowNrmlHrs = "", strCalNrmlHrs = "";
            //         let EmpNode = 0;
            //         double dblNHrs = 0, dblActualNormalHrs = 0;
            //         let drgrid = null;
            //         let fldDat = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            //         if (fldDat instanceof PactListBoxData)
            //         {
            //             dtdat = Util.ParseDate(datarow["dcAlpha1_Key"]);
            //             dsEmployee = this.ScreenObject.GetAllEmployeesList(Util.ParseDate(datarow["dcAlpha1_Key"]), DocID, 1, parseInt(((PactListBoxData)fldDat).SelectedValue), "");
            //             drgrid = datarow.Table.filter(x=>x.dcAlpha1=='" + Util.ParseDate(dtdat.Date).ToString(BaseService.SessionManager.Preferences["Date Format"]) + "'");
            //         }
            //         else if (fldDat instanceof PactCodeNameListBoxData)
            //         {
            //             dtdat = Util.ParseDate(datarow["dcAlpha1_Key"]);
            //             dsEmployee = this.ScreenObject.GetAllEmployeesList(Util.ParseDate(datarow["dcAlpha1_Key"]), DocID, 1, parseInt(((PactCodeNameListBoxData)fldDat).SelectedValue), "");
            //             drgrid = datarow.Table.filter(x=>x.dcAlpha1=='" + Util.ParseDate(dtdat.Date).ToString(BaseService.SessionManager.Preferences["Date Format"]) + "'");
            //         }

            //         fldDat = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
            //         if (fldDat instanceof PactExtraFieldDateData)
            //         {
            //             if (datarow["dcCCNID51_Key"] != null)
            //             {
            //                 EmpNode = parseInt(datarow["dcCCNID51_Key"]);
            //                 dsEmployee = this.ScreenObject.GetAllEmployeesList(Util.ParseDate(((PactExtraFieldDateData)fldDat).Date), DocID, 1, parseInt(datarow["dcCCNID51_Key"]), "");
            //             }
            //             drgrid = datarow.Table.filter(x=>x.dcCCNID51_Key==" + parseInt(EmpNode));
            //         }

            //         if (drgrid.length > 0)
            //         {
            //             dblActualNormalHrs = parseFloat(dsEmployee.Tables[1][0]["NORMALHOURS"]);
            //             for(let i = 0; i <= drgrid.length - 1; i++)
            //             {
            //                 if (((drgrid[i]["dcNum5"] == null && drgrid[i]["dcNum7"] == null) || (parseFloat(drgrid[i]["dcNum5"]) == 0 && parseFloat(drgrid[i]["dcNum7"]) == 0)))
            //                 {
            //                     if (i == 0)
            //                     {
            //                         dblNHrs = parseFloat(drgrid[i]["dcNum2"]);
            //                         if (DocID == 0 && dsEmployee.Tables[0].length > 0)
            //                         {
            //                             dblNHrs = dblNHrs + parseFloat(dsEmployee.Tables[0][0]["EXSTNRMLHRS"]);
            //                             ActualNormalHours = parseFloat(dblActualNormalHrs).ToTime("00.00");
            //                             strRowNrmlHrs = parseFloat(dblNHrs).ToTime("00.00");
            //                             CurrNrHrsDiff = Util.ParseDate(ActualNormalHours.toString().replace(".", ":")) - Util.ParseDate(strRowNrmlHrs.toString().replace(".", ":"));
            //                             strCalNrmlHrs = CurrNrHrsDiff.Hours + "." + CurrNrHrsDiff.Minutes;
            //                             drgrid[i]["dcAlpha4"] = strCalNrmlHrs;
            //                         }
            //                     }
            //                     else if (i > 0)
            //                     {
            //                         if (parseFloat(drgrid[i]["dcNum2"]) <= 0)
            //                             dblNHrs = parseFloat(drgrid[i - 1]["dcAlpha4"]);
            //                         else if (parseFloat(drgrid[i]["dcNum2"]) <= parseFloat(drgrid[i - 1]["dcAlpha4"]))
            //                             dblNHrs = parseFloat(drgrid[i]["dcNum2"]);
            //                         //else if (parseFloat(drgrid[i - 1]["dcAlpha4"]) == 0)
            //                         //    drgrid[i]["dcNum2"] = dblNHrs = 0;
            //                         else
            //                             dblNHrs = parseFloat(drgrid[i - 1]["dcAlpha4"]);

            //                         dblActualNormalHrs = parseFloat(drgrid[i - 1]["dcAlpha4"]);
            //                         drgrid[i]["dcNum2"] = dblNHrs;
            //                     }
            //                     ActualNormalHours = parseFloat(dblActualNormalHrs).ToTime("00.00");
            //                     strRowNrmlHrs = parseFloat(dblNHrs).ToTime("00.00");
            //                     CurrNrHrsDiff = Util.ParseDate(ActualNormalHours.toString().replace(".", ":")) - Util.ParseDate(strRowNrmlHrs.toString().replace(".", ":"));
            //                     strCalNrmlHrs = CurrNrHrsDiff.Hours + "." + CurrNrHrsDiff.Minutes;
            //                     drgrid[i]["dcAlpha4"] = strCalNrmlHrs;
            //                 }
            //             }
            //         }
            //     }

            //     if (strBindingPaths == "dcNum2" || strBindingPaths == "dcNum5" || strBindingPaths == "dcNum7" || strBindingPaths == "dcNum9" || strBindingPaths == "dcNum11" || strBindingPaths == "dcNum13")
            //     {
            //         //RECALCULATING THE TOTAL COST
            //         double dblTotalCost = 0;
            //         double dblCurrColRate = 0;
            //         for(let j = 0; j < datarow.Table.length - 1; j++)
            //         {
            //             if (datarow.Table[j][strBindingPaths] != null)
            //             {
            //                 dblTotalCost = 0;
            //                 for(let i = 5; i < 15; i++)
            //                 {
            //                     dblCurrColRate = 0;
            //                     if (parseFloat(datarow.Table[j]["dcNum" + i]) > 0)
            //                     {
            //                         dblCurrColRate = (ConvertHoursToMinutes(datarow.Table[j]["dcNum" + i]) * (parseFloat(datarow.Table[j]["dcNum" + (i + 1)]) / 60));
            //                         dblTotalCost = dblTotalCost + dblCurrColRate;
            //                     }
            //                     i = i + 1;
            //                 }
            //                 dblCurrColRate = 0;
            //                 dblCurrColRate = (ConvertHoursToMinutes(datarow.Table[j]["dcNum2"]) * (parseFloat(datarow.Table[j]["dcNum3"]) / 60));
            //                 dblTotalCost = dblTotalCost + dblCurrColRate;
            //                 datarow.Table[j]["dcNum15"] = dblTotalCost;
            //             }
            //         }
            //     }
            //     if (datarow.RowState != DataRowState.Detached && datarow.RowState != DataRowState.Deleted)
            //         this.ScreenObject.GridDataObj.updateRow(datarow);
            //     CalculateTotals(datarow, false);
            // } 
            //#endregion

            //#region "Post Past Salary Details"
            if (this.ScreenObject.CostCenterID == 40071) {
                if (strBindingPaths == "dcAlpha3" || strBindingPaths == "dcAlpha4" || strBindingPaths == "dcAlpha5" || strBindingPaths == "dcAlpha6" || strBindingPaths == "dcAlpha7" || strBindingPaths == "dcAlpha8" || strBindingPaths == "dcAlpha9" || strBindingPaths == "dcAlpha10" || strBindingPaths == "dcAlpha11" || strBindingPaths == "dcAlpha12" || strBindingPaths == "dcAlpha13" || strBindingPaths == "dcAlpha14") {
                    //CALCULATING THE TOTAL COST
                    for (let j = 0; j < this.ScreenObject.GridData.length - 1; j++) {
                        let dblTotalCost = 0;
                        if (this.ScreenObject.GridData[j][strBindingPaths] != null) {
                            for (let i = 3; i < 15; i++) {
                                if (this.ScreenObject.GridData[j]["dcAlpha" + i] != null) {
                                    if (parseFloat(this.ScreenObject.GridData[j]["dcAlpha" + i]) > 0) {
                                        dblTotalCost = dblTotalCost + parseFloat(this.ScreenObject.GridData[j]["dcAlpha" + i]);
                                    }
                                }
                            }
                            this.ScreenObject.GridData[j]["dcNum1"] = dblTotalCost;
                        }
                    }
                    this.ScreenObject.GridDataObj.updateRow(datarow);
                    this.CalculateTotals(datarow, false);
                }
            }
            //#endregion

            //#region "Apply Vacation"
            if (this.ScreenObject.CostCenterID == 40072) {
                if (strBindingPaths == "dcNum1" || strBindingPaths == "dcNum2" || strBindingPaths == "dcNum3") {
                    //CALCULATING NET AMOUNT
                    let dblNETAMOUNT = 0, dblTotEarnings = 0, dblTotDeductions = 0, dblOPVacSalary = 0;
                    for (let j = 0; j < this.ScreenObject.GridData.length; j++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[j]["dcAlpha21"])) {
                            if (parseFloat(this.ScreenObject.GridData[j]["dcAlpha21"]) == 2) {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[j]["dcNum1"]))
                                    dblTotEarnings = dblTotEarnings + parseFloat(this.ScreenObject.GridData[j]["dcNum1"]);
                                if (!Util.IsEmpty(this.ScreenObject.GridData[j]["dcNum2"]))
                                    dblTotEarnings = dblTotEarnings + parseFloat(this.ScreenObject.GridData[j]["dcNum2"]);
                                if (!Util.IsEmpty(this.ScreenObject.GridData[j]["dcNum3"]))
                                    dblTotEarnings = dblTotEarnings + parseFloat(this.ScreenObject.GridData[j]["dcNum3"]);
                            }
                            else if (parseFloat(this.ScreenObject.GridData[j]["dcAlpha21"]) != 2) {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[j]["dcNum1"]))
                                    dblTotDeductions = dblTotDeductions + parseFloat(this.ScreenObject.GridData[j]["dcNum1"]);
                            }
                        }
                    }

                    let fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
                    if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text))
                        dblOPVacSalary = parseFloat(fldAPV.Text);

                    dblNETAMOUNT = (dblTotEarnings + dblOPVacSalary) - dblTotDeductions;

                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha6");
                    if (fldAPV instanceof PactTextBoxData)
                        fldAPV.Text = dblNETAMOUNT.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]);

                    this.ScreenObject.GridDataObj.updateRow(datarow);

                    this.CalculateTotals(datarow, false);

                    this.GridNetTotal = parseFloat(dblNETAMOUNT.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));
                    this.RefreshNetAmount();
                }
            }
            //#endregion

            //#region "Form12BA"
            if (this.ScreenObject.CostCenterID == 40076) {
                let dblAddAmount = 0, dblMinusAmount = 0, dblNum1 = 0, dblNum2 = 0;
                if (strBindingPaths == "dcNum1" || strBindingPaths == "dcNum2") {
                    if (datarow["dcAlpha2"] != null) {
                        if (parseInt(datarow["dcAlpha3"]) == 0 || parseInt(datarow["dcAlpha3"]) == -2) {
                            if (datarow["dcNum1"] != null)
                                dblNum1 = parseFloat(datarow["dcNum1"]);

                            if (datarow["dcNum2"] != null)
                                dblNum2 = parseFloat(datarow["dcNum2"]);

                            datarow["dcNum3"] = dblNum1 - dblNum2;
                        }
                    }

                    for (let j = 0; j < this.ScreenObject.GridData.length - 1; j++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[j]["dcAlpha2"])) {
                            if (parseInt(this.ScreenObject.GridData[j]["dcAlpha3"]) == 0) {
                                dblNum1 = 0;
                                dblNum2 = 0;
                                if (!Util.IsEmpty(this.ScreenObject.GridData[j]["dcNum1"]))
                                    dblNum1 = parseFloat(this.ScreenObject.GridData[j]["dcNum1"]);

                                if (!Util.IsEmpty(this.ScreenObject.GridData[j]["dcNum2"]))
                                    dblNum2 = parseFloat(this.ScreenObject.GridData[j]["dcNum2"]);

                                dblAddAmount = dblAddAmount + dblNum1;
                                dblMinusAmount = dblMinusAmount + dblNum2;
                            }

                            if (parseInt(this.ScreenObject.GridData[j]["dcAlpha3"]) == -1) {
                                this.ScreenObject.GridData[j]["dcNum1"] = dblAddAmount;
                                this.ScreenObject.GridData[j]["dcNum2"] = dblMinusAmount;
                                this.ScreenObject.GridData[j]["dcNum3"] = dblAddAmount - dblMinusAmount;
                            }
                        }
                    }
                }
                this.ScreenObject.GridDataObj.updateRow(datarow);
            }
            //#endregion

            //#region "Income Tax Definitions"
            if (this.ScreenObject.DocumentType == 74 && (strBindingPaths == "dcNum1" || strBindingPaths == "dcNum2")) {
                this.ScreenObject.GridDataObj.updateRow(datarow);

                strValidationMsg = this.GetITSlabValidation(0, datarow);
                if (strValidationMsg) {
                    this.DisplayMessage = strValidationMsg;
                    return;
                }
                else {
                    this.DisplayMessage = "";
                }
            }
            //#endregion

            //#region "Dues Entry"
            if (this.ScreenObject.CostCenterID == 40080) {
                if (strBindingPaths == "dcAlpha3") {
                    if (datarow["dcAlpha3_Key"] != null) {
                        let dtPayrollMonth = new Date();
                        dtPayrollMonth = new Date(parseInt(Util.ParseDate(datarow["dcAlpha3_Key"]).ToString("yyyy")), parseInt(Util.ParseDate(datarow["dcAlpha3_Key"]).ToString("MM")), 1);
                        datarow["dcAlpha3"] = Util.ParseDate(dtPayrollMonth).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        datarow["dcAlpha3_Key"] = Util.ParseDate(dtPayrollMonth);
                    }
                }
            }
            //#endregion

            //#region "Bulk Appraisals"
            if (this.ScreenObject.CostCenterID == 40085) {
                this.ScreenObject.GridDataObj.updateRow(datarow);
            }
            //#endregion

            //#region "Leave Encashment"
            if (this.ScreenObject.DocumentType == 58 && strBindingPaths == "dcAlpha3") {
                if (datarow["dcCCNID52_Key"] == null)
                    return;

                let dME = 0;
                dME = (parseFloat(datarow["dcAlpha1"]) - parseFloat(datarow["dcAlpha8"]));
                if (dME < 0) dME = 0;
                if (dME > parseFloat(datarow["dcAlpha2"]))
                    dME = parseFloat(datarow["dcAlpha2"]);

                if (parseFloat(datarow["dcAlpha3"]) > dME)
                    strValidationMsg = "You can not Encash more than ( " + dME + " ) Days" + "\r\n";

                // if (parseFloat(datarow["dcAlpha2"]) == 0)
                //     strValidationMsg = "No Leaves found to Encash" + "\r\n";

                // else if ((parseFloat(datarow["dcAlpha1"]) < parseFloat(datarow["dcAlpha3"])))
                //     strValidationMsg = "Applied Days should be less than or equal to Available Days" + "\r\n";
                // else if ((parseFloat(datarow["dcAlpha2"]) < parseFloat(datarow["dcAlpha3"])))
                //     strValidationMsg = "Applied Days should be less than or equal to Max Encash Days" + "\r\n";
                // else if ((parseFloat(datarow["dcAlpha1"]) - parseFloat(datarow["dcAlpha3"]) < parseFloat(datarow["dcAlpha8"])))
                //     strValidationMsg = "Remaining Days should be Grater than or equal to Threshold Limit" + "\r\n";


                if (strValidationMsg) {
                    this.DisplayMessage = strValidationMsg;
                    return;
                }
                else {
                    this.DisplayMessage = "";
                }
                datarow["dcNum1"] = this.GetLeaveEncashAmount(parseFloat(datarow["dcAlpha3"]), parseInt(datarow["dcCCNID52_Key"]));
            }
            //#endregion

            //#region Attendance

            if (this.ScreenObject.DocumentType == 89) {
                if (strBindingPaths == "dcAlpha1" || strBindingPaths == "dcAlpha2" || strBindingPaths == "dcAlpha3" || strBindingPaths == "dcAlpha4") {
                    let dtCheckInDate = null, dtCheckInTime = null, dtCheckOutDate = null, dtCheckOutTime = null;
                    let dtmp = new Date();

                    let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                    if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"]))
                        dtCheckInDate = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);

                    vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                    if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"])) {
                        //dtCheckInTime = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);
                        dtmp = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);
                        dtCheckInTime = new Date(dtCheckInDate.getFullYear(), dtCheckInDate.getMonth(), dtCheckInDate.getDate(), dtmp.getHours(), dtmp.getMinutes(), dtmp.getSeconds());
                        datarow[vFld2.DisplayMember + "_Key"] = dtCheckInTime;
                    }

                    vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                    if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"]))
                        dtCheckOutDate = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);

                    vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha4");
                    if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"])) {
                        //dtCheckOutTime = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);
                        dtmp = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);
                        dtCheckOutTime = new Date(dtCheckOutDate.getFullYear(), dtCheckOutDate.getMonth(), dtCheckOutDate.getDate(), dtmp.getHours(), dtmp.getMinutes(), dtmp.getSeconds());
                        datarow[vFld2.DisplayMember + "_Key"] = dtCheckOutTime;
                    }

                    if (dtCheckInDate != null && dtCheckInTime != null && dtCheckOutDate != null && dtCheckOutTime != null) {
                        let per = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha5");
                        if (per != null) {
                            datarow[per.DisplayMember] = this.CalculateTotalTime(dtCheckInDate, dtCheckInTime, dtCheckOutDate, dtCheckOutTime);
                        }
                    }
                    else {
                        let per = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha5");
                        if (per != null) {
                            datarow[per.DisplayMember] = null;
                        }
                    }
                    this.ScreenObject.GridDataObj.updateRow(datarow);
                }
            }
            //#endregion

            //#region Time Sheet

            if (this.ScreenObject.DocumentType == 90) {
                if (strBindingPaths == "dcAlpha1" || strBindingPaths == "dcAlpha2" || strBindingPaths == "dcAlpha3" || strBindingPaths == "dcAlpha4") {
                    let dtCheckInDate = null, dtCheckInTime = null, dtCheckOutDate = null, dtCheckOutTime = null;
                    let dtmp = new Date();

                    let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                    if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"]))
                        dtCheckInDate = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);

                    vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                    if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"])) {
                        //dtCheckInTime = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);
                        dtmp = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);
                        dtCheckInTime = new Date(dtCheckInDate.getFullYear(), dtCheckInDate.getMonth(), dtCheckInDate.getDate(), dtmp.getHours(), dtmp.getMinutes(), dtmp.getSeconds());
                        datarow[vFld2.DisplayMember + "_Key"] = dtCheckInTime;
                    }

                    vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                    if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"]))
                        dtCheckOutDate = new Date(datarow[vFld2.DisplayMember + "_Key"]);

                    vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha4");
                    if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"])) {
                        //dtCheckOutTime = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);
                        dtmp = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);
                        dtCheckOutTime = new Date(dtCheckOutDate.getFullYear(), dtCheckOutDate.getMonth(), dtCheckOutDate.getDate(), dtmp.getHours(), dtmp.getMinutes(), dtmp.getSeconds());
                        datarow[vFld2.DisplayMember + "_Key"] = dtCheckOutTime;
                    }

                    this.ScreenObject.GridDataObj.updateRow(datarow);

                    if (dtCheckInDate != null && dtCheckInTime != null && dtCheckOutDate != null && dtCheckOutTime != null) {
                        let per = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha5");
                        if (per != null) {
                            datarow[per.DisplayMember] = this.CalculateTotalTime(dtCheckInDate, dtCheckInTime, dtCheckOutDate, dtCheckOutTime);
                        }
                    }
                    else {
                        let per = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha5");
                        if (per != null) {
                            datarow[per.DisplayMember] = null;
                        }
                    }
                    this.ScreenObject.GridDataObj.updateRow(datarow);

                }
            }


            //#endregion

            //#region Consider LOP to Service Days

            if (this.DocumentType == 94) {
                if (strBindingPaths.toLowerCase() == "dcalpha5") {
                    if (!parseBoolean(datarow["dcAlpha5"])) {
                        datarow["dcAlpha7"] = 0;
                        this.ScreenObject.GridDataObj.updateRow(datarow);
                    }
                }
                if (strBindingPaths.toLowerCase() == "dcalpha7") {
                    if (parseBoolean(datarow["dcAlpha5"])) {
                        let dC = Util.Double(datarow["dcAlpha7"]);
                        if (dC + parseFloat(datarow["dcAlpha6"]) > parseFloat(datarow["dcAlpha4"])) {
                            this.DisplayMessage = "SUM of Prev.Adj.Days and Cur.Adj.Days should be less than or equal to 'No of Days'";
                            return;
                        }
                    }
                    else {
                        datarow["dcAlpha7"] = 0;
                        this.ScreenObject.GridDataObj.updateRow(datarow);
                        this.DisplayMessage = "First Consider the Document then adjust";
                        return;
                    }
                }
            }
            //#endregion


            //#region
            if (this.ScreenObject.DocumentType == 103) {
                if (strBindingPaths == "dcAlpha2" || strBindingPaths == "dcAlpha3" || strBindingPaths == "dcAlpha4" || strBindingPaths == "dcAlpha5" || strBindingPaths == "dcAlpha6") {
                    let dtCheckInDate: Date = null, dtCheckInTime: Date = null, dtCheckOutDate: Date = null, dtCheckOutTime: Date = null;
                    let dtmp = new Date();
                    let session = "";

                    var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                    if (vFld2 != null && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"]))
                        dtCheckInDate = new Date(datarow[vFld2.DisplayMember + "_Key"]);

                    vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                    if (vFld2 != null && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"])) {
                        //dtCheckInTime = new Date(datarow[vFld2.DisplayMember + "_Key"]);
                        dtmp = new Date(datarow[vFld2.DisplayMember + "_Key"]);
                        dtCheckInTime = new Date(dtCheckInDate.getFullYear(), dtCheckInDate.iMonth(), dtCheckInDate.getDate(), dtmp.getHours(), dtmp.getMinutes(), dtmp.getSeconds());
                        datarow[vFld2.DisplayMember + "_Key"] = dtCheckInTime;
                    }

                    vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha4");
                    if (vFld2 != null && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"]))
                        dtCheckOutDate = new Date(datarow[vFld2.DisplayMember + "_Key"]);

                    vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha5");
                    if (vFld2 != null && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"])) {
                        //dtCheckOutTime = new Date(datarow[vFld2.DisplayMember + "_Key"]);
                        dtmp = new Date(datarow[vFld2.DisplayMember + "_Key"]);
                        dtCheckOutTime = new Date(dtCheckOutDate.getFullYear(), dtCheckOutDate.iMonth(), dtCheckOutDate.getDate(), dtmp.getHours(), dtmp.getMinutes(), dtmp.getSeconds())
                        datarow[vFld2.DisplayMember + "_Key"] = dtCheckOutTime;
                    }

                    vFld2 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding != null && a.ValueBinding.toLowerCase() == "dcalpha6");
                    if (vFld2 != null && !Util.IsEmpty(datarow[vFld2.ValueBinding])) {
                        this.session = datarow[vFld2.ValueBinding].toString();
                        session = datarow[vFld2.ValueBinding].toString();
                    }


                    if (dtCheckInDate != null && dtCheckInTime != null && dtCheckOutDate != null && dtCheckOutTime != null && session != null && session != "") {
                        if (dtCheckOutDate < dtCheckInDate) {
                            this.DisplayMessage = "EndDate should be greater than or equal to StartDate" + "\r\n";
                            this.MessageVisibility = true;
                            return;
                        }


                        if (!Util.IsEmpty(dtCheckInDate) && !Util.IsEmpty(dtCheckOutDate) && dtCheckInDate.toString() != dtCheckOutDate.toString()) {
                            this.DisplayMessage = "Cannot Apply more than one day";
                            this.MessageVisibility = true;
                            return;
                        }

                        var per = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha8");
                        if (per != null) {
                            datarow[per.DisplayMember] = this.CalculateTotalTime(dtCheckInDate, dtCheckInTime, dtCheckOutDate, dtCheckOutTime);
                        }

                        per = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha7");
                        if (per != null) {
                            if (session == "Both")
                                datarow[per.DisplayMember] = "1";
                            else
                                datarow[per.DisplayMember] = "0.5";
                        }
                    }
                    else {
                        var per = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha8");
                        if (per != null) {
                            datarow[per.DisplayMember] = null;
                        }

                        per = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha7");
                        if (per != null) {
                            datarow[per.DisplayMember] = "0";
                        }
                    }
                    //datarow.AcceptChanges();
                    this.ScreenObject.GridDataObj.updateRow(datarow);

                }
            }
            //#endregion


            if (col && !Util.IsEmpty(col.Shortcut) && col.Shortcut.toLowerCase() == "lostfocus" && this.ValidateData_Column(col, datarow, true))
                this.ScreenObject.GetExternalFuncData(col.Mode, col.SPName, col.IPParams, col.OPParams, datarow);

            if (col && !Util.IsEmpty(col.Shortcut) && col.Shortcut.toLowerCase() == "onchange" && this.ValidateData_Column(col, datarow, true)) {
                if ((this.ScreenObject.GridDataColumns.Contains(strBindingPaths + "_Key") && !Util.IsEmpty(datarow[strBindingPaths + "_Key"]) && datarow[strBindingPaths + "_Key"].toString() != this.PrevValue)
                    || (!this.ScreenObject.GridDataColumns.Contains(strBindingPaths + "_Key") && !Util.IsEmpty(datarow[strBindingPaths]) && datarow[strBindingPaths].toString() != this.PrevValue))
                    this.ScreenObject.GetExternalFuncData(col.Mode, col.SPName, col.IPParams, col.OPParams, datarow);
            }

            //#region "JoinFromVacation"
            if (this.DocumentType == 65) {
                //Start: For checking the Fromdate and ToDate value not null and date validations and convert the datevalue to dd-MMM-yyyy format
                if (strBindingPaths == "dcAlpha3") {
                    if (datarow["dcAlpha1_Key"] != null && datarow["dcAlpha2_Key"] != null && datarow["dcAlpha3_Key"] != null) {
                        datarow["dcAlpha1"] = Util.ParseDate(datarow["dcAlpha1_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        datarow["dcAlpha1_Key"] = Util.ParseDate(datarow["dcAlpha1_Key"]);
                        datarow["dcAlpha2"] = Util.ParseDate(datarow["dcAlpha2_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        datarow["dcAlpha2_Key"] = Util.ParseDate(datarow["dcAlpha2_Key"]);
                        datarow["dcAlpha3"] = Util.ParseDate(datarow["dcAlpha3_Key"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        datarow["dcAlpha3_Key"] = Util.ParseDate(datarow["dcAlpha3_Key"]);

                        if (strBindingPaths == "dcAlpha3") {
                            if (datarow["dcAlpha4"] != null && BaseService.SessionManager.Preferences.ContainsKey("AllowRejoinonHolidayweeklyoff") && parseBoolean(BaseService.SessionManager.Preferences["AllowRejoinonHolidayweeklyoff"] == "False")) {
                                if (parseInt(datarow["dcAlpha4"]) == 1)
                                    strValidationMsg = "Re-join date should not be Weekly Off" + "\r\n";
                                else if (parseInt(datarow["dcAlpha4"]) == 2)
                                    strValidationMsg = "Re-join date should not be Holiday" + "\r\n";

                            }
                            if ((Util.ParseDate(datarow["dcAlpha3_Key"]) <= Util.ParseDate(datarow["dcAlpha1_Key"]))) {
                                strValidationMsg = strValidationMsg + "Re-join date should be after the vacation FromDate" + "\r\n";
                                datarow["dcAlpha4"] = 1;
                            }
                            else {
                                if (strValidationMsg == "")
                                    datarow["dcAlpha4"] = 0;
                            }
                        }

                        if (strValidationMsg != "") {
                            this.DisplayMessage = strValidationMsg;

                            return;
                        }
                        else {
                            this.DisplayMessage = "";
                            this.MessageVisibility = false;
                        }

                    }
                }
                //End: For checking the Fromdate and ToDate value and convert the datevalue to dd-MMM-yyyy format
            }
            //#endregion

            //#region "Compensatory Leave"
            if (this.ScreenObject.CostCenterID == 40059 && this.ScreenObject.DocumentType == 59) {
                this.ScreenObject.GridDataObj.updateRow(datarow);
                if (strBindingPaths == "dcAlpha1") {
                    if (datarow["dcAlpha1_Key"] != null) {
                        if (datarow["dcNum1"] != null) {
                            if (parseFloat(datarow["dcNum1"]) <= 0) {
                                this.DisplayMessage = "Selected date should be Weeklyoff or Holiday";
                                return;
                            }
                            else {
                                this.DisplayMessage = "";
                            }
                        }
                    }
                }
            }
            //#endregion

            //#region "Consolidated Leave1"
            //Start: For showing Available and Noofdays leaves message
            if (this.ScreenObject.DocumentType == 63 && (strBindingPaths == "dcCCNID52" || strBindingPaths == "dcAlpha5" || strBindingPaths == "dcAlpha6")) {
                this.ScreenObject.GridDataObj.updateRow(datarow);
                if (datarow["dcAlpha3"] != null && datarow["dcAlpha8"] != null) {
                    if (parseFloat(datarow["dcAlpha3"]) <= 0 && parseFloat(datarow["dcAlpha8"]) != -1)
                        strValidationMsg = "Please check the availability of leaves" + "\r\n";

                }
                if (datarow["dcNum1"] != null && datarow["dcAlpha4_Key"] != null && datarow["dcAlpha5_Key"] != null) {
                    if (parseFloat(datarow["dcNum1"]) <= 0)
                        strValidationMsg = "Dates already applied | Selected dates between Holidays/Weeklyoffs" + "\r\n";

                }

                if (strValidationMsg != "") {
                    this.DisplayMessage = strValidationMsg;

                    return;
                }
                else {
                    this.DisplayMessage = "";
                    this.MessageVisibility = false;
                }
            }
            //End: For showing Available and Noofdays leaves message
            //#endregion

            //#region Apply Leave

            if (this.ScreenObject.DocumentType == 62 && strBindingPaths == "dcAlpha5") {
                this.Celleditend(datarow, "dcAlpha7", 40062);
            }

            //#endregion

            if (col != null) {
                let rpt = this.ReportsList.find(a => a.Formula == col.ID && a.KeyTip.toLowerCase() == "lostfocus");
                if (rpt) {
                    this.OnReportsLinkClick(rpt.DBColumnID);
                }
            }
            Logger.InfoLog("AddEditDocumentViewModel::Exiting OnCellEditEnding");
        }
        catch (error) {
            if (error.message == "PactException") {
                throw new Error("PactException");
                //alert('PactException')
                //throw new Error();
            }
            else {
                this.DisplayMessage = "Problem processing document try again";
                Logger.ErrorLog("Addeditdocumentviewmodel", "cell edit ending", error.stack);
            }
        }
    }

    private InitProjWOffsHolidays() {
        this.dsProjWOffHol = [];// new DataSet();
        this.dsProjWOffHol = BaseService.common.GetDataSet("DOC066", this.DocumentDate.ToString("dd MMM yyyy"))
    }

    DailyAttendanceCellEditEnd(datarow: any, strBindingPaths: string, col: DgColumn) {
        let SelectedDate;
        let CurrHrsDiff: TimeSpan;
        let StartTime = "", EndTime = "", StartDate = "", EndDate = "", TotHours = "", CurrTotHours = "", strCurrHours = "";
        let dblHoursdiff = 0;

        let sDailyAttDate = "", sEmpID = "1";
        let vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
        if (vFld instanceof PactExtraFieldDateData) {
            if ((vFld).Date)
                sDailyAttDate = (vFld).Date.ToString("dd/MMM/yyyy");
        }
        else {
            let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
            if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"]))
                sDailyAttDate = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");
        }

        vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
        if (vFld) {
            if (vFld instanceof PactListBoxData)
                sEmpID = vFld.SelectedValue.toString();
            else if (vFld instanceof PactCodeNameListBoxData)
                sEmpID = vFld.SelectedValue.toString();
        }
        else {
            let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
            if (vFld2 && !Util.IsEmpty(datarow[vFld2.ValueMember]))
                sEmpID = datarow[vFld2.ValueMember].toString();
        }



        if (sDailyAttDate != "" && parseInt(sEmpID) > 1) {
            if (strBindingPaths == "dcAlpha2" || strBindingPaths == "dcAlpha3" || strBindingPaths == "dcNum1") {
                if (datarow["dcAlpha2_Key"] != null && datarow["dcAlpha3_Key"] != null) {
                    datarow["dcAlpha2"] = StartTime = Util.ParseDate(datarow["dcAlpha2_Key"]).ToString("HH:mm");
                    datarow["dcAlpha2_Key"] = Util.ParseDate(datarow["dcAlpha2_Key"]).ToString("dd-MMM-yyyy HH:mm");

                    datarow["dcAlpha3"] = EndTime = Util.ParseDate(datarow["dcAlpha3_Key"]).ToString("HH:mm");
                    datarow["dcAlpha3_Key"] = Util.ParseDate(datarow["dcAlpha3_Key"]).ToString("dd-MMM-yyyy HH:mm");

                    if (strBindingPaths == "dcNum1") {
                        //RECALCULATING THE START TIME AND END TIME IF TOTAL HOURS CHANGE MANUALLY 
                        let Hrs: TimeSpan = Util.ParseDate(datarow["dcAlpha3_Key"]).Subtract(Util.ParseDate(datarow["dcAlpha2_Key"]));/* = Util.ParseDate(datarow["dcAlpha3_Key"]) - Util.ParseDate(datarow["dcAlpha2_Key"]);*/
                        if (Hrs.Minutes.toString().length == 1)
                            TotHours = Hrs.Hours + ".0" + Hrs.Minutes;
                        else
                            TotHours = Hrs.Hours + "." + Hrs.Minutes;
                        strCurrHours = parseFloat(datarow["dcNum1"]).ToTime("00.00")//ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]);

                        //if (parseFloat(strCurrHours) != parseFloat(TotHours) && parseFloat(TotHours) > 0)
                        {
                            //CurrHrsDiff = Util.ParseDate(strCurrHours.toString().replace(".", ":")) - Util.ParseDate(TotHours.toString().replace(".", ":"));
                            CurrHrsDiff = Util.ParseDate(Date.WithTime(strCurrHours.toString().replace(".", ":"))).Subtract(Util.ParseDate(Date.WithTime(TotHours.toString().replace(".", ":"))));
                            if (CurrHrsDiff.Minutes.toString().length == 1)
                                CurrTotHours = CurrHrsDiff.Hours + ".0" + CurrHrsDiff.Minutes;
                            else
                                CurrTotHours = CurrHrsDiff.Hours + "." + CurrHrsDiff.Minutes;
                            dblHoursdiff = this.ConvertHoursToMinutes(CurrTotHours);

                            EndTime = Util.ParseDate(datarow["dcAlpha3_Key"]).AddMinutes(dblHoursdiff).ToString("HH:mm");
                            datarow["dcAlpha3"] = Util.ParseDate(Date.WithTime(EndTime)).ToString("HH:mm");
                            EndDate = Util.ParseDate(datarow["dcAlpha3_Key"]).ToString("dd-MMM-yyyy") + " " + EndTime;
                            datarow["dcAlpha3_Key"] = Util.ParseDate(EndDate).ToString("dd-MMM-yyyy HH:mm");

                            StartTime = Util.ParseDate(datarow["dcAlpha2_Key"]).ToString("HH:mm");
                            datarow["dcAlpha2"] = Util.ParseDate(Date.WithTime(StartTime)).ToString("HH:mm");
                            StartDate = Util.ParseDate(datarow["dcAlpha2_Key"]).ToString("dd-MMM-yyyy") + " " + StartTime;
                            datarow["dcAlpha2_Key"] = Util.ParseDate(StartDate).ToString("dd-MMM-yyyy HH:mm");
                        }
                    }

                    //IF DAILY ATTENADANCE DATE FILED IN HEADER SECTION
                    let fldDat = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                    if (fldDat) {
                        if (fldDat instanceof PactExtraFieldDateData && fldDat.Date) {
                            if (Util.ParseDate(Date.Today().ToString("dd-MMM-yyyy") + " " + StartTime) > Util.ParseDate(Date.Today().ToString("dd-MMM-yyyy") + " " + EndTime))
                            //if (Util.ParseDate(datarow["dcAlpha2_Key"]) > Util.ParseDate(datarow["dcAlpha3_Key"]))
                            {
                                SelectedDate = Util.ParseDate(sDailyAttDate);// ((PactExtraFieldDateData)fldDat).Date;
                                StartDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + StartTime;
                                datarow["dcAlpha2_Key"] = Util.ParseDate(StartDate).ToString("dd-MMM-yyyy HH:mm");
                                EndDate = SelectedDate.AddDays(1).ToString("dd-MMM-yyyy") + " " + EndTime;
                                datarow["dcAlpha3_Key"] = Util.ParseDate(EndDate).ToString("dd-MMM-yyyy HH:mm");
                            }
                            else {
                                SelectedDate = Util.ParseDate(sDailyAttDate);// ((PactExtraFieldDateData)fldDat).Date;
                                StartDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + StartTime;
                                datarow["dcAlpha2_Key"] = Util.ParseDate(StartDate).ToString("dd-MMM-yyyy HH:mm");
                                EndDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + EndTime;
                                datarow["dcAlpha3_Key"] = Util.ParseDate(EndDate).ToString("dd-MMM-yyyy HH:mm");
                            }
                        }
                    }
                    else {
                        //IF DAILY ATTENADANCE DATE FILED IN BODY SECTION
                        let fldDat2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                        if (fldDat2 != null) {
                            if (Util.ParseDate(Date.Today().ToString("dd-MMM-yyyy") + " " + StartTime) > Util.ParseDate(Date.Today().ToString("dd-MMM-yyyy") + " " + EndTime))
                            //if (Util.ParseDate(datarow["dcAlpha2_Key"]) > Util.ParseDate(datarow["dcAlpha3_Key"]))
                            {
                                SelectedDate = Util.ParseDate(sDailyAttDate);// Util.ParseDate(datarow["dcAlpha1_Key"]).Date;
                                StartDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + StartTime;
                                datarow["dcAlpha2_Key"] = Util.ParseDate(StartDate).ToString("dd-MMM-yyyy HH:mm");
                                EndDate = SelectedDate.AddDays(1).ToString("dd-MMM-yyyy") + " " + EndTime;
                                datarow["dcAlpha3_Key"] = Util.ParseDate(EndDate).ToString("dd-MMM-yyyy HH:mm");
                            }
                            else {
                                SelectedDate = Util.ParseDate(sDailyAttDate);// Util.ParseDate(datarow["dcAlpha1_Key"]).Date;
                                StartDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + StartTime;
                                datarow["dcAlpha2_Key"] = Util.ParseDate(StartDate).ToString("dd-MMM-yyyy HH:mm");
                                EndDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + EndTime;
                                datarow["dcAlpha3_Key"] = Util.ParseDate(EndDate).ToString("dd-MMM-yyyy HH:mm");
                            }
                        }
                    }

                    //IF EMPLOYEE DIMENSION IN HEADER SECTION
                    fldDat = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if (fldDat) {
                        if (fldDat instanceof PactListBoxData && fldDat.SelectedValue > 0) {
                            if (Util.ParseDate(SelectedDate.ToString("dd-MMM-yyyy") + " " + StartTime) > Util.ParseDate(SelectedDate.ToString("dd-MMM-yyyy") + " " + EndTime))
                            //if (Util.ParseDate(datarow["dcAlpha2_Key"]) > Util.ParseDate(datarow["dcAlpha3_Key"]))
                            {
                                SelectedDate = Util.ParseDate(sDailyAttDate);// Util.ParseDate(datarow["dcAlpha1_Key"]);
                                StartDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + StartTime;
                                datarow["dcAlpha2_Key"] = Util.ParseDate(StartDate).ToString("dd-MMM-yyyy HH:mm");
                                EndDate = SelectedDate.AddDays(1).ToString("dd-MMM-yyyy") + " " + EndTime;
                                datarow["dcAlpha3_Key"] = Util.ParseDate(EndDate).ToString("dd-MMM-yyyy HH:mm");
                            }
                            else {
                                SelectedDate = Util.ParseDate(sDailyAttDate);// Util.ParseDate(datarow["dcAlpha1_Key"]);
                                StartDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + StartTime;
                                datarow["dcAlpha2_Key"] = Util.ParseDate(StartDate).ToString("dd-MMM-yyyy HH:mm");
                                EndDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + EndTime;
                                datarow["dcAlpha3_Key"] = Util.ParseDate(EndDate).ToString("dd-MMM-yyyy HH:mm");
                            }
                        }
                    }
                    else {
                        //IF EMPLOYEE DIMENSION IN BODY SECTION
                        let fldDat2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcccnid51");
                        if (fldDat2 != null) {
                            if (Util.ParseDate(Date.Today().ToString("dd-MMM-yyyy") + " " + StartTime) > Util.ParseDate(Date.Today().ToString("dd-MMM-yyyy") + " " + EndTime))
                            //if (Util.ParseDate(datarow["dcAlpha2_Key"]) > Util.ParseDate(datarow["dcAlpha3_Key"]))
                            {
                                SelectedDate = Util.ParseDate(sDailyAttDate);// Util.ParseDate(datarow["dcAlpha1_Key"]);
                                StartDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + StartTime;
                                datarow["dcAlpha2_Key"] = Util.ParseDate(StartDate).ToString("dd-MMM-yyyy HH:mm");
                                EndDate = SelectedDate.AddDays(1).ToString("dd-MMM-yyyy") + " " + EndTime;
                                datarow["dcAlpha3_Key"] = Util.ParseDate(EndDate).ToString("dd-MMM-yyyy HH:mm");
                            }
                            else {
                                SelectedDate = Util.ParseDate(sDailyAttDate);// Util.ParseDate(datarow["dcAlpha1_Key"]);
                                StartDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + StartTime;
                                datarow["dcAlpha2_Key"] = Util.ParseDate(StartDate).ToString("dd-MMM-yyyy HH:mm");
                                EndDate = SelectedDate.ToString("dd-MMM-yyyy") + " " + EndTime;
                                datarow["dcAlpha3_Key"] = Util.ParseDate(EndDate).ToString("dd-MMM-yyyy HH:mm");
                            }
                        }
                    }
                }
            }

            if (strBindingPaths.toLowerCase() == "dcccnid51" || strBindingPaths.toLowerCase() == "dcccnid51code" || strBindingPaths.toLowerCase() == "dcalpha1") {
                this.CheckEmployeeShift(sEmpID, sDailyAttDate, datarow);
                if (this.objPayDayCheck == null)
                    this.objPayDayCheck = new PayDayCheck(this.ScreenObject);
                this.objPayDayCheck.CheckIsHolidayDate(sEmpID, sDailyAttDate, datarow, this.IsGetAllEmployees, this.dsAllEmployeeData);
            }

            if ((BaseService.SessionManager.Preferences.ContainsKey("GeneralTimingsBasedOn") && BaseService.SessionManager.Preferences["GeneralTimingsBasedOn"] != "") || strBindingPaths == "dcAlpha1") {
                let sArrBasedOn = BaseService.SessionManager.Preferences["GeneralTimingsBasedOn"].split(',');
                if (sArrBasedOn != null && sArrBasedOn.length > 0) {
                    for (let i = 0; i < sArrBasedOn.length; i++) {
                        if (sArrBasedOn[i] != null && sArrBasedOn[i] != "") {
                            this.ScreenObject.Data.Tables[0].CaseSensitive = false;
                            let drows = this.ScreenObject.Data.Tables[0].filter(x => x.localreference > 0 && x.SysColumnName.startsWith('dcCCNID') && x.ColumnCostcenterID == sArrBasedOn[i]);
                            if (drows.length > 0 && !Util.IsEmpty(drows[0]["LocalCCID"]))
                                sArrBasedOn.push(drows[0]["LocalCCID"].toString());
                        }
                    }
                }

                if ((strBindingPaths.startsWith("dcCCNID") && sArrBasedOn.Contains(col.CostCenterID.toString()) && datarow[col.ValueMember].toString() != this.PrevValue) || strBindingPaths == "dcAlpha1")
                    this.FillGeneralTimings(sEmpID, sDailyAttDate, datarow);
            }

            if ((BaseService.SessionManager.Preferences.ContainsKey("HoursDefChartBasedOn") && BaseService.SessionManager.Preferences["HoursDefChartBasedOn"] != "" && strBindingPaths.startsWith("dcCCNID")) || strBindingPaths == "dcAlpha1" || strBindingPaths == "dcAlpha2" || strBindingPaths == "dcAlpha3" || strBindingPaths == "dcNum1" || strBindingPaths == "dcNum4" || strBindingPaths == "dcNum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") {
                let sArrBasedOn = BaseService.SessionManager.Preferences["HoursDefChartBasedOn"].split(',');
                if (sArrBasedOn != null && sArrBasedOn.length > 0) {
                    for (let i = 0; i < sArrBasedOn.length; i++) {
                        if (sArrBasedOn[i] != null && sArrBasedOn[i] != "") {
                            this.ScreenObject.Data.Tables[0].CaseSensitive = false;
                            let drows = this.ScreenObject.Data.Tables[0].filter(x => x.localreference > 0 && x.SysColumnName.startsWith('dcCCNID') && x.ColumnCostcenterID == sArrBasedOn[i]);
                            if (drows.length > 0 && !Util.IsEmpty(drows[0]["LocalCCID"]))
                                sArrBasedOn.push(drows[0]["LocalCCID"].toString());
                        }
                    }
                }
                if ((strBindingPaths.startsWith("dcCCNID") && sArrBasedOn.Contains(col.CostCenterID.toString()) && datarow[col.ValueMember].toString() != this.PrevValue) || strBindingPaths == "dcAlpha1" || strBindingPaths == "dcAlpha2" || strBindingPaths == "dcAlpha3" ||
                    strBindingPaths == "dcNum1" || strBindingPaths == "dcNum4" || strBindingPaths == "dcNum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13")
                    this.DistributeTotalHours(sEmpID, sDailyAttDate, datarow, strBindingPaths);
            }

            if (BaseService.SessionManager.Preferences.ContainsKey("DonotallowAttendancebasedon") && BaseService.SessionManager.Preferences["DonotallowAttendancebasedon"] != "" &&
                BaseService.SessionManager.Preferences.ContainsKey("DonotallowAttendancebasedonid") && BaseService.SessionManager.Preferences["DonotallowAttendancebasedonid"] != ""
                && strBindingPaths.startsWith("dcCCNID") && strBindingPaths == "dcCCNID" + (parseInt(BaseService.SessionManager.Preferences["DonotallowAttendancebasedon"]) - 50000)
            ) {
                if (datarow[col.ValueMember] != null && datarow[col.ValueMember] != null && datarow[col.ValueMember].toString() != this.PrevValue && datarow[col.ValueMember].toString() == BaseService.SessionManager.Preferences["DonotallowAttendancebasedonid"]) {
                    this.DistributeTotalHours(sEmpID, sDailyAttDate, datarow, strBindingPaths);
                }
            }

        }

        this.ScreenObject.GridDataObj.updateRow(datarow);
        this.ScreenObject.GridDataObj.refreshDatawithIDs();
    }

    AutoSerialNumber(datarow: any, ObjSerialNumber: SerialNumberViewModel) {
        if (this.ScreenObject.DocID == 0 || Util.IsEmpty(datarow["ExtraXML"])) {
            ObjSerialNumber.SerialNumber.Text = ObjSerialNumber.ds.Tables[3][0][ObjSerialNumber.ds.Columns[3][0]].toString();
            ObjSerialNumber.Qty.Text = datarow["Quantity"].toString();
            ObjSerialNumber.DisplayMessage = "";
            ObjSerialNumber.GridData.Clear();
            ObjSerialNumber.OnSave("Add");
            if (ObjSerialNumber.DisplayMessage.length > 0) {
                this.DisplayMessage = ObjSerialNumber.DisplayMessage;
            }
            else {
                ObjSerialNumber.OnSave("Save");
                if (ObjSerialNumber.DisplayMessage.length > 0) {
                    this.DisplayMessage = ObjSerialNumber.DisplayMessage;
                }
            }
        }
        else {
            let xDoc = new XmlDocument();
            xDoc.LoadXml(datarow["ExtraXML"]);
            let xList = xDoc.SelectNodes("xml/Row");
            if (parseInt(datarow["Quantity"]) > xList.length) {
                ObjSerialNumber.SerialNumber.Text = ObjSerialNumber.ds.Tables[3][0][ObjSerialNumber.ds.Columns[3][0]].toString();
                ObjSerialNumber.Qty.Text = (parseInt(datarow["Quantity"]) - xList.length).toString();
                ObjSerialNumber.DisplayMessage = "";
                ObjSerialNumber.OnSave("Add");
                if (ObjSerialNumber.DisplayMessage.length > 0) {
                    this.DisplayMessage = ObjSerialNumber.DisplayMessage;
                }
                else {
                    ObjSerialNumber.OnSave("Save");
                    if (ObjSerialNumber.DisplayMessage.length > 0) {
                        this.DisplayMessage = ObjSerialNumber.DisplayMessage;
                    }
                }
            }
            else if (parseInt(datarow["Quantity"]) < xList.length && ObjSerialNumber.GridData.length > 0) {
                for (let i = ObjSerialNumber.GridData.length - 1; i >= parseInt(datarow["Quantity"]); i--) {
                    ObjSerialNumber.SelectedRow = ObjSerialNumber.GridData[ObjSerialNumber.GridData.indexOf(ObjSerialNumber.GridData[i])];
                    ObjSerialNumber.OnRemove("Remove");
                    if (ObjSerialNumber.DisplayMessage.length > 0) {
                        this.DisplayMessage = ObjSerialNumber.DisplayMessage;
                    }
                }
            }
        }
    }

    AddProductQty(datarow: any, isSetFocus: boolean): boolean {
        let Ret = false;
        this.ScreenObject.GridDataObj.updateRow(datarow);
        let dvTemp = this.ScreenObject.GridData;
        let wherefilter = "";
        if (!Util.IsEmpty(datarow["ProductID_Key"])) {
            //wherefilter = "ProductID_Key=" + datarow["ProductID_Key"].toString();
            dvTemp = dvTemp.filter(x => x["ProductID_Key"] == Util.String(datarow["ProductID_Key"]));
        }
        else
            return Ret;
        if (!Util.IsEmpty(datarow["Unit_Key"])) {
            //wherefilter += "and Unit_key=" + datarow["Unit_Key"].toString();
            dvTemp = dvTemp.filter(x => x["Unit_Key"] == Util.String(datarow["Unit_Key"]));
        }
        if (Util.String(datarow["Type"]) == "5") {
            if (!Util.IsEmpty(datarow["ExtraXML"]))
                return false;
            //wherefilter += " and ExtraXML is null ";
            dvTemp = dvTemp.filter(x => x["ExtraXML"] == null);
        }
        console.log('Test:ClubProdBasedon-29813');

        //let dvTemp = this.ScreenObject.GridData;
        if (this.ScreenObject.Preferences.ContainsKey("ClubProdBasedon") && this.ScreenObject.Preferences["ClubProdBasedon"] != "") {
            let StrDocs = this.ScreenObject.Preferences["ClubProdBasedon"].split(',');
            StrDocs.forEach(item => {
                if (this.ScreenObject.GridDataColumns.Contains(item))
                    dvTemp = dvTemp.filter(x => x[item] == Util.String(datarow[item]));
            });
        }

        let drdup = dvTemp;
        if (drdup.length > 1) {
            let indx1 = this.ScreenObject.GridData.indexOf(drdup[0]);
            let indx2 = this.ScreenObject.GridData.indexOf(drdup[1]);
            let qty1 = 0, qty2 = 0;
            qty1 = Util.Double(drdup[0]["Quantity"]);
            qty2 = Util.Double(drdup[1]["Quantity"]);

            if (indx1 > indx2) {
                drdup[1]["Quantity"] = qty1 + qty2;
                datarow = drdup[1];
                this.Setselectedrow(indx2);
                this.ScreenObject.GridDataObj.removeRow(drdup[0]);
                this.LineNo = indx2 + 1;
            }
            else {
                drdup[0]["Quantity"] = qty1 + qty2;
                datarow = drdup[0];
                this.Setselectedrow(indx1);
                this.ScreenObject.GridDataObj.removeRow(drdup[1]);
                this.LineNo = indx1 + 1;
            }
            let cno = this.ColumnNo;
            let qtycol = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.DisplayMember) && a.DisplayMember.toLowerCase() == "quantity");
            if (qtycol)
                this.ColumnNo = this.ScreenObject.ColumnSource.indexOf(qtycol) + 1;
            if (isSetFocus)
                this.SetFocusongrid = true;
            this.ColumnNo = cno;
            Ret = true;
        }
        return Ret;
    }
    jvTotal() {
        if (this.ScreenObject.DocumentType == 17 || this.ScreenObject.DocumentType == 28 || this.ScreenObject.DocumentType == 29) {
            let totCredit = 0;
            let totDebit = 0;
            for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                let ExchangeRate = 1;
                if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                    if (this.Currency && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
                        ExchangeRate = parseFloat(this.Currency.ExchangeRate.Text);
                    else if (this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && !Util.IsEmpty(this.ScreenObject.GridData[k]["ExchangeRate"]))
                        ExchangeRate = parseFloat(this.ScreenObject.GridData[k]["ExchangeRate"]);
                }
                if (!Util.IsEmpty(this.ScreenObject.GridData[k]["AccountID_Key"])) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["DebitAmount"]))
                        totDebit += parseFloat(this.ScreenObject.GridData[k]["DebitAmount"]) * ExchangeRate;
                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["CreditAmount"]))
                        totCredit += parseFloat(this.ScreenObject.GridData[k]["CreditAmount"]) * ExchangeRate;

                }
            }

            let dr = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != null && a.DisplayMember.toLowerCase() == "debitamount");
            let cr = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != null && a.DisplayMember.toLowerCase() == "creditamount");

            if (dr != null && cr != null && totCredit.ToString("N" + dr.DecimalPoints) != totDebit.ToString("N" + cr.DecimalPoints)) {
                if (totDebit > totCredit) {
                    if (cr.ShowbodyTotal == 1)
                        cr.footer = (totCredit - totDebit).ToString("N" + dr.DecimalPoints);
                    else {
                        let exrate = 1;
                        if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])
                            && this.Currency && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
                            exrate = parseFloat(this.Currency.ExchangeRate.Text);
                        if (exrate != 0)
                            cr.footer = ((totCredit - totDebit) / exrate).ToString("N" + dr.DecimalPoints);
                        else
                            cr.footer = (totCredit - totDebit).ToString("N" + dr.DecimalPoints);
                    }
                }
                else {
                    if (dr.ShowbodyTotal == 1)
                        dr.footer = (totDebit - totCredit).ToString("N" + cr.DecimalPoints);
                    else {
                        let exrate = 1;
                        if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])
                            && this.Currency && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
                            exrate = parseFloat(this.Currency.ExchangeRate.Text);
                        if (exrate != 0)
                            dr.footer = ((totDebit - totCredit) / exrate).ToString("N" + cr.DecimalPoints);
                        else
                            dr.footer = (totDebit - totCredit).ToString("N" + cr.DecimalPoints);
                    }
                }
            }
        }
    }

    ProdID: number = 0;
    PrevValue: string = "";
    GetProductValues(datarow: any, Unit: number, Islink: boolean = false, StockCode: string = null, IsReeval: boolean = false, ds: any = null): any {
        let qqty = 1;
        qqty = Util.Double(datarow["Quantity"]);
        if (qqty == 0)
            qqty = 1;
        if (Unit == 0 && this.ScreenObject.GridDataColumns.Contains("Unit_Key") && !Util.IsEmpty(datarow["Unit_Key"]) && !Util.IsEmpty(datarow["ProductID_Key"])
            && (this.ProdID == 0 || this.ProdID == parseInt(datarow["ProductID_Key"])))
            Unit = parseInt(datarow["Unit_Key"]);

        if (Unit == 0 && this.barcodeValues != null && this.barcodeValues.ContainsKey("Unit_Key") && !Util.IsEmpty(this.barcodeValues["Unit_Key"]))
            Unit = parseInt(datarow["Unit_Key"]);


        if (ds == null && (Util.String(datarow["ProductID_Key"]) != "" || StockCode != null))
            ds = this.ScreenObject.GetProductTypeDetails(Util.String(datarow["ProductID_Key"]), this.DocumentDate, Unit, qqty, Util.String(datarow["DocDetailsID"]), datarow, Islink, StockCode, false, 0, this.Currency, IsReeval);
        if (ds && ds.Tables.length > 0 && ds.Tables[0].length > 0) {
            if (!Util.IsEmpty(StockCode) && !ds.Columns[0].Contains("ErrorMessage")) {
                datarow["ProductID_Key"] = ds.Tables[0][0]["ProductID"];
                if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                    datarow["ProductCode"] = ds.Tables[0][0]["ProductCode"].toString();
                if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                    datarow["ProductName"] = ds.Tables[0][0]["ProductName"].toString();

                if (BaseService.SessionManager.Preferences.ContainsKey("POSItemCodeDimension")) {
                    let stkcol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID.toString() == BaseService.SessionManager.Preferences["POSItemCodeDimension"]);
                    if (stkcol && this.ScreenObject.GridDataColumns.Contains(stkcol.DisplayMember)) {
                        datarow[stkcol.DisplayMember] = StockCode;
                        if (!Util.IsEmpty(stkcol.ValueMember) && this.ScreenObject.GridDataColumns.Contains(stkcol.ValueMember) && ds.Columns[0].Contains("stockID")
                            && !Util.IsEmpty(ds.Tables[0][0]["stockID"]))
                            datarow[stkcol.ValueMember] = ds.Tables[0][0]["stockID"].toString();
                    }
                }
                if (this.SalesManDimension.Visible && this.ScreenObject.GridDataColumns.Contains("Dcccnid5") && this.SalesManDimension.SelectedValue > 0) {
                    datarow["Dcccnid5"] = this.SalesManDimension.Text;
                    datarow["Dcccnid5_Key"] = this.SalesManDimension.SelectedValue;
                }
                this.FillDefaultValues(datarow);
                this.RepeatRowData(datarow);
                this.BindDivisionorLocation(datarow);
                if (ds.Tables.length > 1 && ds.Tables[1].length > 0) {
                    this.FillPromotions(ds.Tables[1], this.ScreenObject.GridData.indexOf(datarow));
                }
            }

            if (ds.Columns[0].Contains("AvgRate") && !Util.IsEmpty(ds.Tables[0][0]["AvgRate"]))
                datarow["AVGRATE"] = ds.Tables[0][0]["AvgRate"].toString();
            else
                datarow["AVGRATE"] = 0;

            if (parseInt(datarow["ProductID_Key"]) != this.ScreenObject.TempProductID) {
                if (!Util.IsEmpty(ds.Tables[0][0]["QOH"]))
                    datarow["QOH"] = ds.Tables[0][0]["QOH"].toString();
                else
                    datarow["QOH"] = 0;

                if (!Util.IsEmpty(ds.Tables[0][0]["BalQOH"]))
                    datarow["BalQOH"] = ds.Tables[0][0]["BalQOH"].toString();
                else
                    datarow["BalQOH"] = 0;

                if (!Util.IsEmpty(ds.Tables[0][0]["HOLDQTY"]))
                    datarow["HOLDQTY"] = ds.Tables[0][0]["HOLDQTY"].toString();
                else
                    datarow["HOLDQTY"] = 0;

                if (!Util.IsEmpty(ds.Tables[0][0]["CommittedQty"]))
                    datarow["CommittedQty"] = ds.Tables[0][0]["CommittedQty"].toString();
                else
                    datarow["CommittedQty"] = 0;

                if (!Util.IsEmpty(ds.Tables[0][0]["RESERVEQTY"]))
                    datarow["RESERVEQTY"] = ds.Tables[0][0]["RESERVEQTY"].toString();
                else
                    datarow["RESERVEQTY"] = 0;
                if (!Util.IsEmpty(ds.Tables[0][0]["TotalReserve"]))
                    datarow["TotalReserve"] = ds.Tables[0][0]["TotalReserve"].toString();
                else
                    datarow["TotalReserve"] = 0;
                this.FillDatarow(datarow, ds.Tables[0], null, { LocalReference: 79, LinkData: 23819 }, "AvgRate");
                this.FillDatarow(datarow, ds.Tables[0], null, { LocalReference: 79, LinkData: 25398 }, "QOH");
                this.FillDatarow(datarow, ds.Tables[0], null, { LocalReference: 79, LinkData: 52638 }, "QOH");
                this.FillDatarow(datarow, ds.Tables[0], null, { LocalReference: 79, LinkData: 52637 }, "BalQOH");
                this.FillDatarow(datarow, ds.Tables[0], null, { LocalReference: 79, LinkData: 26421 }, "HOLDQTY");
                this.FillDatarow(datarow, ds.Tables[0], null, { LocalReference: 79, LinkData: 50454 }, "CommittedQty");
                this.FillDatarow(datarow, ds.Tables[0], null, { LocalReference: 79, LinkData: 26422 }, "RESERVEQTY");
                this.FillDatarow(datarow, ds.Tables[0], null, { LocalReference: 79, LinkData: 499943 }, "TotalReserve");
            }

            if (ds.Tables.length > 3 && ds.Tables[3].length > 0) {
                this.FillDatarowNN(datarow, ds.Tables[3], null, { LinkData: 55481 }, "WEF");
                this.FillDatarowNN(datarow, ds.Tables[3], null, { LinkData: 55484 }, "TillDate");
                this.FillDatarowNN(datarow, ds.Tables[3], null, { LinkData: 55486 }, "ProfileName");
            }
            if (ds.Tables.length > 4 && ds.Tables[4].length > 0) {
                this.FillDatarowNN(datarow, ds.Tables[4], null, { LinkData: 55482 }, "WEF");
                this.FillDatarowNN(datarow, ds.Tables[4], null, { LinkData: 55485 }, "TillDate");
                this.FillDatarowNN(datarow, ds.Tables[4], null, { LinkData: 55487 }, "ProfileName");
            }

            if (this.ScreenObject.DocumentType == 31) {
                if (!Util.IsEmpty(ds.Tables[0][0]["QOH"]))
                    datarow["QOH"] = ds.Tables[0][0]["QOH"].toString();
                else
                    datarow["QOH"] = 0;

                let QOHField = "";
                let fld = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["QOHField"]);
                if (fld)
                    QOHField = fld.DisplayMember;
                if (QOHField != "")
                    datarow[QOHField] = datarow["QOH"].toString();
            }
        }
        return ds;
    }

    FillProductValues(datarow: any) {
        let ds = this.GetProductValues(datarow, 0);
        if (Util.IsEmpty(datarow["Unit_Key"]) && ds.Tables.length > 0 && ds.Columns[0].Contains("uomid") && !Util.IsEmpty(ds.Tables[0][0]["uomid"])) {
            datarow["Unit"] = ds.Tables[0][0]["UnitName"].toString();
            datarow["Unit_Key"] = ds.Tables[0][0]["uomid"].toString();
        }
        let NumColt = this.ScreenObject.ColumnSource.filter(a => a.DisplayMember.Contains("dcNum") && a.SectionID != 4);

        for (let k = 0; k < NumColt.length; k++) {
            let item = NumColt[k]
            if (item.linkData > 0)
                continue;
            if (ds.Tables.length > 4)//Extra Fields
            {
                let drr = ds.Tables[4].filter(x => x.SysColumnName == item.DisplayMember);
                if (drr.length > 0) {
                    datarow[item.DisplayMember] = drr[0]["Value"].toString();
                    datarow["default" + item.DisplayMember] = drr[0]["Value"].toString();
                }
                //else if (ds.Tables.length > 5)
                //{
                //    drr = ds.Tables[5].filter(x=>x.SysColumnName==item.DisplayMember);
                //    if (drr.length > 0)
                //    {
                //        datarow[item.DisplayMember] = drr[0]["Value"].toString();
                //        datarow["default" + item.DisplayMember] = drr[0]["Value"].toString();
                //    }
                //}
            }
        }
        this.FillRates(ds, datarow);
        let dvCnt = this.ScreenObject.Data.Tables[0];
        if (dvCnt.length > 0) {
            let prodcol = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toString().toLowerCase() == "productid_key");
            if (prodcol && prodcol.CostCenterID > 0) {
                dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && (x.LocalReference == prodcol.ID || (x.LocalReference == 79 && (x.LinkData == 26585 || x.LinkData == 54306 || x.LinkData == 54307 || x.LinkData == 53529 || x.LinkData == 53589 || x.LinkData == 53530))));
                if (dvCnt.length > 0 && prodcol.ValueMember && !Util.IsEmpty(datarow[prodcol.ValueMember])) {
                    this.ScreenObject.GetLinkReferenceData(parseInt(prodcol.ID), this.DocumentID, parseInt(datarow[prodcol.ValueMember]), Date.Today(), "", prodcol.CostCenterID, datarow, null, false);
                }

                let ProdExtracol = null;
                if (prodcol.DisplayMember == "ProductName")
                    ProdExtracol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "ProductCode");
                else if (prodcol.DisplayMember == "ProductCode")
                    ProdExtracol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "ProductName");
                if (ProdExtracol) {
                    dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == ProdExtracol.ID);
                    if (dvCnt.length > 0 && ProdExtracol.ValueMember && !Util.IsEmpty(datarow[ProdExtracol.ValueMember])) {
                        this.ScreenObject.GetLinkReferenceData(parseInt(ProdExtracol.ID), this.DocumentID, parseInt(datarow[ProdExtracol.ValueMember]), Date.Today(), "", ProdExtracol.CostCenterID, datarow, null, false);
                    }
                }
            }
        }

        if (ds.Tables.length > 0 && ds.Tables[0].length > 0 && !ds.Columns[0].Contains("ErrorMessage")
            && Util.Int(ds.Tables[0][0]["DrAccount"]) > 0
            && this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key")) {
            datarow["DebitAccount_Key"] = ds.Tables[0][0]["DrAccount"].toString();
            if (this.ScreenObject.GridDataColumns.Contains("DebitAccount"))
                datarow["DebitAccount"] = ds.Tables[0][0]["DrName"].toString();
        }

        if (ds.Tables.length > 0 && ds.Tables[0].length > 0 && !ds.Columns[0].Contains("ErrorMessage")
            && Util.Int(ds.Tables[0][0]["CrAccount"]) > 0
            && this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")) {
            datarow["CreditAccount_Key"] = ds.Tables[0][0]["CrAccount"].toString();
            if (this.ScreenObject.GridDataColumns.Contains("CreditAccount"))
                datarow["CreditAccount"] = ds.Tables[0][0]["CrName"].toString();
        }

        this.CalculateTotals(datarow, false);
    }
    public ClearDatarow(dr: any, ClearAll: boolean) {
        if (BaseService.IsMobile) {
            this.ScreenObject.GridDataObj.removeRow(dr);
            return
        }
        dr["Type"] = 0;
        if (this.ScreenObject.GridDataColumns.Contains("BinWise"))
            dr["BinWise"] = null;
        if (this.ScreenObject.GridDataColumns.Contains("QtyType"))
            dr["QtyType"] = null;
        dr["LinkedInvDocDetailsID"] = 0;
        dr["LinkedFieldName"] = "";
        dr["RefNo"] = "";
        dr["UOMConversion"] = 0;
        dr["QOH"] = 0;
        dr["BalQOH"] = 0;
        dr["HOLDQTY"] = 0;
        dr["CommittedQty"] = 0;
        dr["RESERVEQTY"] = 0;
        dr["TotalReserve"] = 0;
        dr["LASTPURCHASERATE"] = 0;
        dr["UOMConvertedQty"] = 0;
        dr["Unit"] = "";
        dr["Unit_Key"] = 0;
        dr["ExtraXML"] = null;
        if (ClearAll) {
            dr["Quantity"] = null;
            dr["Rate"] = null;
            dr["defaultRate"] = null;
        }
        else {
            dr["Quantity"] = 0;
            dr["Rate"] = 0;
            dr["defaultRate"] = 0;

        }
        for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
            let item = this.ScreenObject.ColumnSource[i]
            if (item.SectionID == 4 || item.DistributeColName == "FillGUID")
                continue;

            if (item.DisplayMember != null && item.DisplayMember.toLowerCase().Contains("dcnum")) {
                if (ClearAll) {
                    dr[item.DisplayMember] = null;
                    dr["default" + item.DisplayMember] = null;
                    dr["dcCalc" + item.DisplayMember] = null;
                }
                else {
                    dr[item.DisplayMember] = 0;
                    dr["default" + item.DisplayMember] = 0;
                    dr["dcCalc" + item.DisplayMember] = 0;
                }
            }
            if (item.DisplayMember != null && item.DisplayMember.toLowerCase().Contains("alpha")) {
                if (!ClearAll && this.ScreenObject.Preferences.ContainsKey("ProductFilterField") && this.ScreenObject.Preferences["ProductFilterField"] != ""
                    && item.ID == this.ScreenObject.Preferences["ProductFilterField"])
                    continue;

                dr[item.DisplayMember] = null;
            }
            if (ClearAll && !Util.IsEmpty(item.ValueMember) && this.ScreenObject.GridDataColumns.Contains(item.ValueMember)) {
                dr[item.ValueMember] = null;
                dr[item.DisplayMember] = null;
            }
        }
    }

    RepeatRowData(dr: any) {
        let index = this.ScreenObject.GridData.indexOf(dr);
        if (index > 0)
            for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
                if (this.ScreenObject.ColumnSource[i].IsRepeat) {
                    if (this.ScreenObject.ColumnSource[i].CostCenterID > 0 && this.ScreenObject.ColumnSource[i].CostCenterID != this.CostCenterID) {
                        if (Util.IsEmpty(dr[this.ScreenObject.ColumnSource[i].ValueMember])) {
                            dr[this.ScreenObject.ColumnSource[i].DisplayMember] = this.ScreenObject.GridData[index - 1][this.ScreenObject.ColumnSource[i].DisplayMember];
                            dr[this.ScreenObject.ColumnSource[i].ValueMember] = this.ScreenObject.GridData[index - 1][this.ScreenObject.ColumnSource[i].ValueMember];

                            this.FillLinkRef(dr, this.ScreenObject.ColumnSource[i]);
                        }
                    }
                    else if (this.ScreenObject.ColumnSource[i].DisplayMember.toLowerCase().Contains("dcnum")) {
                        if (Util.IsEmpty(dr[this.ScreenObject.ColumnSource[i].DisplayMember]))
                            dr[this.ScreenObject.ColumnSource[i].DisplayMember] =
                                this.ScreenObject.GridData[index - 1][this.ScreenObject.ColumnSource[i].DisplayMember];
                    }
                    else if (this.ScreenObject.ColumnSource[i].DataType == "DATE" ||
                        this.ScreenObject.ColumnSource[i].DataType.toLocaleLowerCase() == "datetime"
                        || this.ScreenObject.ColumnSource[i].DataType.toLocaleLowerCase() == "time") {
                        if (Util.IsEmpty(dr[this.ScreenObject.ColumnSource[i].DisplayMember])) {
                            dr[this.ScreenObject.ColumnSource[i].DisplayMember] =
                                this.ScreenObject.GridData[index - 1][this.ScreenObject.ColumnSource[i].DisplayMember];
                            dr[this.ScreenObject.ColumnSource[i].DisplayMember + "_Key"] =
                                this.ScreenObject.GridData[index - 1][this.ScreenObject.ColumnSource[i].DisplayMember + "_Key"];
                        }
                    }
                    else if (this.ScreenObject.ColumnSource[i].DataType == "PactComboBox" || this.ScreenObject.ColumnSource[i].DataType == "ComboBox") {
                        if (Util.IsEmpty(dr[this.ScreenObject.ColumnSource[i].ValueBinding]))
                            dr[this.ScreenObject.ColumnSource[i].ValueBinding] = this.ScreenObject.GridData[index - 1][this.ScreenObject.ColumnSource[i].ValueBinding];
                    }
                    else {
                        if (Util.IsEmpty(dr[this.ScreenObject.ColumnSource[i].DisplayMember]))
                            dr[this.ScreenObject.ColumnSource[i].DisplayMember] = this.ScreenObject.GridData[index - 1][this.ScreenObject.ColumnSource[i].DisplayMember];
                    }
                }
            }
    }

    CheckStockDimensions() {
        let tempint = 0;
        if (BaseService.SessionManager.Preferences.ContainsKey("Maintain Dimensionwise stock") && Util.Int(BaseService.SessionManager.Preferences["Maintain Dimensionwise stock"]) > 50000) {
            tempint = Util.IntTryParse(BaseService.SessionManager.Preferences["Maintain Dimensionwise stock"]);
            let cc = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid" + (tempint - 50000));
            if (!this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (tempint - 50000) + "_Key") && !cc) {
                let lst: PactListBoxData = new PactListBoxData(0);
                lst.CCID = tempint;
                lst.TypeID = 1;
                lst.Label = this.ScreenObject.GetCostcenterName(tempint);
                lst.DBColumnName = "dcCCNID" + (tempint - 50000);
                lst.Mandatory = true;
                if (this.ScreenObject.CustomTab.Pages.length > 0) {
                    lst.Row = (this.ScreenObject.CustomTab.Pages[0].Fields.length / 4);
                    lst.Column = (this.ScreenObject.CustomTab.Pages[0].Fields.length % 4);
                    this.ScreenObject.CustomTab.Pages[0].Fields.push(lst);
                    this.ScreenObject._CCFields.push(lst);
                }
                else {
                    lst.Row = 0;
                    lst.Column = 0;
                    let t = new PactTabData();
                    t.Header = "Extra fields";
                    t.Name = "Extra fields";
                    this.ScreenObject.CustomTab.Pages.push(t);
                    this.ScreenObject.CustomTab.Pages[0].Fields.push(lst);
                    this.ScreenObject.CustomTab.Visible = true;
                    this.ScreenObject.CustomTab.SelectedTab = this.ScreenObject.CustomTab.Pages[0];
                    this.ScreenObject._CCFields.push(lst);
                }
            }
        }
        if (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && parseBoolean(BaseService.SessionManager.Preferences["EnableLocationWise"]) && parseBoolean(BaseService.SessionManager.Preferences["EnableLocationWise"])
            && BaseService.SessionManager.Preferences.ContainsKey("Location Stock") && parseBoolean(BaseService.SessionManager.Preferences["Location Stock"]) && parseBoolean(BaseService.SessionManager.Preferences["Location Stock"])) {
            let cc = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
            if (!cc && !this.ScreenObject.GridDataColumns.Contains("dcCCNID2_Key")) {
                let lst = new PactListBoxData(0);
                lst.CCID = 50002;
                lst.TypeID = 1;
                if (BaseService.SessionManager.Preferences.ContainsKey("LocationName"))
                    lst.Label = BaseService.SessionManager.Preferences["LocationName"];
                else
                    lst.Label = "Location";
                lst.DBColumnName = "dcCCNID2";
                lst.Mandatory = true;
                if (this.ScreenObject.CustomTab.Pages.length > 0) {
                    lst.Row = (this.ScreenObject.CustomTab.Pages[0].Fields.length / 4);
                    lst.Column = (this.ScreenObject.CustomTab.Pages[0].Fields.length % 4);
                    this.ScreenObject.CustomTab.Pages[0].Fields.push(lst);
                    this.ScreenObject._CCFields.push(lst);
                }
                else {
                    lst.Row = 0;
                    lst.Column = 0;
                    let t = new PactTabData();
                    t.Header = "Extra fields";
                    t.Name = "Extra fields";
                    this.ScreenObject.CustomTab.Pages.push(t);
                    this.ScreenObject.CustomTab.Pages[0].Fields.push(lst);
                    this.ScreenObject.CustomTab.Visible = true;
                    this.ScreenObject.CustomTab.SelectedTab = this.ScreenObject.CustomTab.Pages[0];
                    this.ScreenObject._CCFields.push(lst);
                }
            }

        }
        let tempbool = false;
        if (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && parseBoolean(BaseService.SessionManager.Preferences["EnableDivisionWise"]) && parseBoolean(BaseService.SessionManager.Preferences["EnableDivisionWise"])
            && BaseService.SessionManager.Preferences.ContainsKey("Division Stock") && parseBoolean(BaseService.SessionManager.Preferences["Division Stock"]) && parseBoolean(BaseService.SessionManager.Preferences["Division Stock"])) {
            let cc = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid1");
            if (!cc && !this.ScreenObject.GridDataColumns.Contains("dcCCNID1_Key")) {
                let lst = new PactListBoxData(0);
                lst.CCID = 50001;
                lst.TypeID = 1;
                if (BaseService.SessionManager.Preferences.ContainsKey("DivisionName"))
                    lst.Label = BaseService.SessionManager.Preferences["DivisionName"];
                else
                    lst.Label = "Division";
                lst.DBColumnName = "dcCCNID1";
                lst.Mandatory = true;
                if (this.ScreenObject.CustomTab.Pages.length > 0) {
                    lst.Row = (this.ScreenObject.CustomTab.Pages[0].Fields.length / 4);
                    lst.Column = (this.ScreenObject.CustomTab.Pages[0].Fields.length % 4);
                    this.ScreenObject.CustomTab.Pages[0].Fields.push(lst);
                    this.ScreenObject._CCFields.push(lst);
                }
                else {
                    lst.Row = 0;
                    lst.Column = 0;
                    let t = new PactTabData();
                    t.Header = "Extra fields";
                    t.Name = "Extra fields";
                    this.ScreenObject.CustomTab.Pages.push(t);
                    this.ScreenObject.CustomTab.Pages[0].Fields.push(lst);
                    this.ScreenObject.CustomTab.Visible = true;
                    this.ScreenObject.CustomTab.SelectedTab = this.ScreenObject.CustomTab.Pages[0];
                    this.ScreenObject._CCFields.push(lst);
                }
            }
        }
    }

    QtyReader(Quantity: string): string {
        return Quantity;
        /**
        string Key = "f12";
        TextBox textBox = new TextBox();
        textBox.Text = Quantity;
        try
        {
            SerialPortListnerDialog d = new SerialPortListnerDialog(textBox, null, null, Key);

            let KeyValues = System.Configuration.ConfigurationManager.AppSettings["ComPort-" + Key].split(',');
            if (KeyValues.length > 5 && KeyValues[5] == "a")
            {
                d.IsAuto = true;
                d.Capture();
                return "";
            }
            System.Windows.Media.Effects.DropShadowEffect efft = new System.Windows.Media.Effects.DropShadowEffect();
            efft.Direction = 300;
            efft.ShadowDepth = 1;
            efft.BlurRadius = 50;
            efft.RenderingBias = System.Windows.Media.Effects.RenderingBias.Quality;
            efft.Opacity = 0.6;
            d.Effect = efft;
            d.Owner = Application.Current.MainWindow;
            d.ShowDialog();
        }
        catch
        {
        }
        return textBox.Text;**/
    }

    SubDialogResult: boolean = false;
    async AddProductData(datarow: any, IsFromLink: boolean, isfomCatalog: boolean, IsFromSubtitute: boolean = false, rate: string = null, StockCode: string = null, stkcol: DgColumn = null) {
        if (!Util.IsEmpty(datarow["ProductID_Key"]) && StockCode == null && this.ProdID == parseInt(datarow["ProductID_Key"]) && parseInt(datarow["ProductID_Key"]) != 0) {
            this.RepeatRowData(datarow);
            if (this.ScreenObject.Preferences.ContainsKey("IgnoreKitPopup") && this.ScreenObject.Preferences["IgnoreKitPopup"] == "True" && Util.String(datarow["Type"]) == "3")
                return;
            if (!Util.IsEmpty(datarow["Type"]) && (datarow["Type"].toString() == "8" || datarow["Type"].toString() == "3" || datarow["Type"].toString() == "11" || datarow["Type"].toString() == "12")) {
                if (datarow["Type"].toString() == "11" || datarow["Type"].toString() == "12") //Modifiers
                {
                    let ds1 = this.GetProductValues(datarow, 0, false, StockCode);
                    BaseService.page.ShowDialog(new DynamicSetViewModel(this, datarow, ds1), DynamicSetComponent);
                }
                else
                    BaseService.page.ShowDialog(new DynamicSetViewModel(this, datarow, null), DynamicSetComponent);
            }
            return;
        }

        if (!Util.IsEmpty(datarow["ProductID_Key"]) && this.ProdID != parseInt(datarow["ProductID_Key"]) && !(this.ScreenObject.Preferences.ContainsKey("SnoBasedLinking") && this.ScreenObject.Preferences["SnoBasedLinking"] != "" && parseBoolean(this.ScreenObject.Preferences["SnoBasedLinking"]))) {
            datarow["LinkedInvDocDetailsID"] = 0;
            datarow["LinkedFieldName"] = "";
            datarow["RefNo"] = "";
        }
        if (!Util.IsEmpty(datarow["ProductID_Key"]) && this.ProdID != parseInt(datarow["ProductID_Key"]) && parseInt(datarow["ProductID_Key"]) != 0) {
            datarow["ExtraXML"] = null;
            if (this.ProdID > 0 && !(this.ScreenObject.Preferences.ContainsKey("Dontresetvaluesonproductchange") && this.ScreenObject.Preferences["Dontresetvaluesonproductchange"] != "" && parseBoolean(this.ScreenObject.Preferences["Dontresetvaluesonproductchange"]))) {
                let TextColt = this.ScreenObject.ColumnSource.filter(a => a.DisplayMember.toLowerCase().Contains("dcalpha"));
                TextColt.forEach(item => {
                    if (item.DistributeColName == "FillGUID")
                        return;
                    datarow[item.DisplayMember] = null;
                });
            }
        }
        if ((this.ScreenObject.DocumentType == 31 || this.ScreenObject.DocumentType == 32) && stkcol != null) {
            var drdup = this.ScreenObject.GridData.filter(x => x[stkcol.ValueMember] == Util.String(datarow[stkcol.ValueMember]));
            if (drdup.length > 1) {
                let res = '';
                if (BaseService.SessionManager.Preferences.ContainsKey("ShowProdCodeinErrMsg") && parseBoolean(BaseService.SessionManager.Preferences["ShowProdCodeinErrMsg"]))
                    this.res = datarow["ProductCode"].toString() + "-" + datarow["ProductName"].toString();
                else if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                    this.res = datarow["ProductName"].toString();
                else if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                    this.res = datarow["ProductCode"].toString();

                this.DisplayMessage = "Product '" + this.res + "' Already exists at Row No:" + drdup[0]["DocSeqNo"].toString();
                this.SetFocusongrid = true;
                return;
            }
        }
        else if (!Util.IsEmpty(datarow["ProductID_Key"]) && datarow["ProductID_Key"].toString() != this.ScreenObject.TempProductID.toString() &&
            ((this.ScreenObject.Preferences.ContainsKey("Alert Duplicate Product") && this.ScreenObject.Preferences["Alert Duplicate Product"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["Alert Duplicate Product"]))
                || ((this.ScreenObject.DocumentType == 31 || this.ScreenObject.DocumentType == 32) && !this.ScreenObject.GridDataColumns.Contains("BOEID")))) {
            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (this.ScreenObject.GridData[i] != datarow && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]))
                    if (this.ScreenObject.GridData[i]["ProductID_Key"].toString() == datarow["ProductID_Key"].toString() && !(this.ScreenObject.GridData[i]["Type"].toString() == "5" && (this.ScreenObject.DocumentType == 31 || this.ScreenObject.DocumentType == 32))) {
                        let res = "";
                        if (BaseService.SessionManager.Preferences.ContainsKey("ShowProdCodeinErrMsg") && parseBoolean(BaseService.SessionManager.Preferences["ShowProdCodeinErrMsg"]))
                            this.res = this.ScreenObject.GridData[i]["ProductCode"].toString() + "-" + this.ScreenObject.GridData[i]["ProductName"].toString();
                        else if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                            this.res = this.ScreenObject.GridData[i]["ProductName"].toString();
                        else if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                            this.res = this.ScreenObject.GridData[i]["ProductCode"].toString();

                        let mbres = confirm("Product '" + this.res + "' Already exists at Row No:" + this.ScreenObject.GridData[i]["DocSeqNo"].toString() + ".\nDo you want to continue?");
                        if (mbres && !(this.ScreenObject.DocumentType == 31 || this.ScreenObject.DocumentType == 32))
                            break;

                        if (this.ProdID > 0) {
                            datarow["ProductID_Key"] = this.ProdID;
                            let dt: any = BaseService.document.GetCCValues(this.ProdID.toString(), 3, 2);
                            if (dt != null && dt.Tables.length > 0 && dt.Tables[0].length && dt.Columns[0].Contains("name")) {
                                if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                    datarow["ProductCode"] = dt.Tables[0]["Code"].toString();
                                if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                                    datarow["ProductName"] = dt.Tables[0]["name"].toString();
                            }
                            return;
                        }
                        else {
                            if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                datarow["ProductCode"] = null;
                            if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                                datarow["ProductName"] = null;
                            if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key"))
                                datarow["ProductID_Key"] = null;

                            this.LineNo = i + 1;
                            this.SetFocusongrid = true;
                            return;
                        }
                    }
            }
        }

        if (this.ScreenObject.DocumentType == 31 && this.ScreenObject.GridDataColumns.Contains("DueDate")) {
            datarow["DueDate"] = Date.Today().ToString(BaseService.SessionManager.Preferences["Date Format"]);
            datarow["DueDate_Key"] = Date.Today();
        }
        if (!Util.IsEmpty(datarow["ProductID_Key"])) {
            this.FillDefaultValues(datarow);
            this.RepeatRowData(datarow);
            this.BindDivisionorLocation(datarow);
        }

        let ds: any = null;
        if (this.ImportCopyProductdata && this.iprodDics != null && this.iprodDics.ContainsKey(parseInt(datarow["ProductID_Key"].toString())))
            ds = this.GetProductValues(datarow, 0, false, StockCode, false, this.iprodDics[parseInt(datarow["ProductID_Key"].toString())]);
        else
            ds = this.GetProductValues(datarow, 0, false, StockCode);

        if (this.ImportCopyProductdata && this.iprodDics != null && !this.iprodDics.ContainsKey(parseInt(datarow["ProductID_Key"].toString())))
            this.iprodDics.push(parseInt(datarow["ProductID_Key"].toString()), ds);


        if (ds != null && ds.Tables.length > 4 && ds.Tables[4].length > 0) {
            let drr = ds.Tables[4].filter(x => x.ColID == -1);
            if (drr.length > 0) {
                for (let i = 0; i < drr.length; i++)
                    alert(drr[i]["Message"].toString());
            }
        }

        if (!Util.IsEmpty(StockCode) && !Util.IsEmpty(datarow["ProductID_Key"]))
            return;

        try {
            if (this.ScreenObject.GridDataColumns.Contains("ProductCode") && Util.IsEmpty(datarow["ProductCode"]))
                datarow["ProductCode"] = ds.Tables[0][0]["ProductCode"];
            if (this.ScreenObject.GridDataColumns.Contains("ProductName") && Util.IsEmpty(datarow["ProductName"]))
                datarow["ProductName"] = ds.Tables[0][0]["ProductName"];
            if (this.ScreenObject.GridDataColumns.Contains("IsWeightable") && ds.Columns[0].Contains("IsWeightable"))
                datarow["IsWeightable"] = ds.Tables[0][0]["IsWeightable"];
        } catch (error) {

        }

        if (IsFromSubtitute)
            datarow["Subexists"] = "1";
        else if (ds != null && ds.Tables.length > 8 && ds.Tables[8].length > 1 && !ds.Columns[8].Contains("ErrorMessage")
            && !(this.ScreenObject.Preferences.ContainsKey("SubstituteOnQty") && this.ScreenObject.Preferences["SubstituteOnQty"].toString() != "" && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["SubstituteOnQty"]))
            && this.ScreenObject.Preferences.ContainsKey("EnableSubtitutes") && this.ScreenObject.Preferences["EnableSubtitutes"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["EnableSubtitutes"])) {
            if (!isfomCatalog && BaseService.page.DialogCount == 0) {
                if (datarow["ProductCode"] != null) {
                    let sb = new SubsituteProductsViewModel(this, ds.Tables[8], ds.Columns[8], ds.Tables[9], datarow["ProductName"].toString(), datarow["ProductCode"].toString(), datarow["ProductID_Key"].toString())
                    if (sb.GridData.length > 0) {
                        BaseService.page.ShowDialog(sb, SubsituteProductsComponent, { ShowCenter: true })
                    }
                }
                else {
                    let sb = new SubsituteProductsViewModel(this, ds.Tables[8], ds.Columns[8], ds.Tables[9], datarow["ProductName"].toString(), "", "");
                    if (sb.GridData.length > 0) {
                        BaseService.page.ShowDialog(sb, SubsituteProductsComponent, { ShowCenter: true })
                    }
                }

                this.ScreenObject.UpdateSequence();
                if (this.SubDialogResult) {
                    this.ScreenObject.GridDataObj.updateRow(datarow);
                    return;
                }
                else {
                    if (ds.Columns[0].Contains("AvgRate") && !Util.IsEmpty(ds.Tables[0][0]["AvgRate"]))
                        datarow["AVGRATE"] = ds.Tables[0][0]["AvgRate"].toString();
                    else
                        datarow["AVGRATE"] = 0;
                }
            }
            else
                datarow["Subexists"] = "1";
        }
        else
            datarow["Subexists"] = "0";

        if (this.ScreenObject.Preferences.ContainsKey("ProductWiseCreditDays") && this.ScreenObject.Preferences["ProductWiseCreditDays"] != "" && parseBoolean(this.ScreenObject.Preferences["ProductWiseCreditDays"])
            && ds.Tables.length > 0 && ds.Tables[0].length > 0 && ds.Columns[0].Contains("CreditDays")) {
            this.ScreenObject.GetDueDate_Table(ds.Tables[0], this.DocumentDate, false);
        }

        if (ds.Tables.length > 0 && ds.Tables[0].length > 0 && !ds.Columns[0].Contains("ErrorMessage")
            && !Util.IsEmpty(ds.Tables[0][0]["DrAccount"]) && parseInt(ds.Tables[0][0]["DrAccount"]) > 0) {
            let IsValueChange = false;
            if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key")) {
                if (Util.String(datarow["DebitAccount_Key"]) != ds.Tables[0][0]["DrAccount"].toString())
                    IsValueChange = true;

                datarow["DebitAccount_Key"] = ds.Tables[0][0]["DrAccount"].toString();
                if (this.ScreenObject.GridDataColumns.Contains("DebitAccount"))
                    datarow["DebitAccount"] = ds.Tables[0][0]["DrName"].toString();
                else {
                    let col = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "debitaccount_key");
                    if (col)
                        datarow[col.DisplayMember] = ds.Tables[0][0]["DrName"].toString();
                }

                if (IsValueChange) {
                    let col = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "debitaccount_key");
                    if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == col.ID).length > 0) {
                        this.ScreenObject.GetLinkReferenceData(parseInt(col.ID), this.DocumentID, parseInt(datarow[col.ValueMember]), Date.Today(), "", col.CostCenterID, datarow);
                    }

                    //Budget Dimension Auto Load
                    if (BaseService.SessionManager.Preferences["BudgetAccount"].length > 0 && BaseService.SessionManager.Preferences["BudgetDimension"].length > 0)
                        this.BudgetObj.AutoLoadBudgetDimension(datarow, null);
                }
            }
            else if (this.ScreenObject.DebitAccount != null) {
                if (this.ScreenObject.DebitAccount.SelectedValue != parseInt(ds.Tables[0][0]["DrAccount"]))
                    IsValueChange = true;

                this.ScreenObject.DebitAccount.SelectedValue = parseInt(ds.Tables[0][0]["DrAccount"]);
                if (BaseService.SessionManager.Preferences.ContainsKey("DisableAutoLoad") && BaseService.SessionManager.Preferences["DisableAutoLoad"].toLowerCase() == "true")
                    this.ScreenObject.DebitAccount.Name.SelectedValueText = ds.Tables[0][0]["DrName"].toString();

                //Budget Dimension Auto Load
                if (IsValueChange && BaseService.SessionManager.Preferences["BudgetAccount"].length > 0 && BaseService.SessionManager.Preferences["BudgetDimension"].length > 0)
                    this.BudgetObj.AutoLoadBudgetDimension(datarow, null);
            }
        }
        if (ds.Tables.length > 0 && ds.Tables[0].length > 0 && !ds.Columns[0].Contains("ErrorMessage")
            && !Util.IsEmpty(ds.Tables[0][0]["CrAccount"]) && parseInt(ds.Tables[0][0]["CrAccount"]) > 0) {
            let IsValueChange = false;
            if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")) {
                if (Util.String(datarow["CreditAccount_Key"]) != ds.Tables[0][0]["CrAccount"].toString())
                    IsValueChange = true;

                datarow["CreditAccount_Key"] = ds.Tables[0][0]["CrAccount"].toString();
                if (this.ScreenObject.GridDataColumns.Contains("CreditAccount"))
                    datarow["CreditAccount"] = ds.Tables[0][0]["CrName"].toString();
                else {
                    let col = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "creditaccount_key");
                    if (col)
                        datarow[col.DisplayMember] = ds.Tables[0][0]["CrName"].toString();
                }

                if (IsValueChange) {
                    let col = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "creditaccount_key");
                    if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == col.ID).length > 0) {
                        this.ScreenObject.GetLinkReferenceData(parseInt(col.ID), this.DocumentID, parseInt(datarow[col.ValueMember]), Date.Today(), "", col.CostCenterID, datarow);
                    }

                    //Budget Dimension Auto Load
                    if (BaseService.SessionManager.Preferences["BudgetAccount"].length > 0 && BaseService.SessionManager.Preferences["BudgetDimension"].length > 0)
                        this.BudgetObj.AutoLoadBudgetDimension(datarow, null);
                }
            }
            else if (this.ScreenObject.CreditAccount != null) {
                if (this.ScreenObject.CreditAccount.SelectedValue != parseInt(ds.Tables[0][0]["CrAccount"]))
                    IsValueChange = true;

                this.ScreenObject.CreditAccount.SelectedValue = parseInt(ds.Tables[0][0]["CrAccount"]);
                if (BaseService.SessionManager.Preferences.ContainsKey("DisableAutoLoad") && BaseService.SessionManager.Preferences["DisableAutoLoad"].toLowerCase() == "true")
                    this.ScreenObject.CreditAccount.Name.SelectedValueText = ds.Tables[0][0]["CrName"].toString();

                //Budget Dimension Auto Load
                if (IsValueChange && BaseService.SessionManager.Preferences["BudgetAccount"].length > 0 && BaseService.SessionManager.Preferences["BudgetDimension"].length > 0)
                    this.BudgetObj.AutoLoadBudgetDimension(datarow, null);
            }
        }
        if (ds.Tables.length > 0 && ds.Tables[0].length > 0 && !ds.Columns[0].Contains("ErrorMessage") && (ds.Tables[0][0]["ProductTypeID"].toString() == "8" || ds.Tables[0][0]["ProductTypeID"].toString() == "3" || ds.Tables[0][0]["ProductTypeID"].toString() == "11" || ds.Tables[0][0]["ProductTypeID"].toString() == "12")) {
            let ind = this.ScreenObject.GridData.indexOf(datarow) + 1;
            datarow["Type"] = ds.Tables[0][0]["ProductTypeID"].toString();

            if (this.ScreenObject.GridDataColumns.Contains("BinWise") && ds.Columns[0].Contains("BinWise"))
                datarow["BinWise"] = ds.Tables[0][0]["BinWise"];

            if (this.ScreenObject.GridDataColumns.Contains("QtyType") && ds.Columns[0].Contains("QtyAdjustType"))
                datarow["QtyType"] = ds.Tables[0][0]["QtyAdjustType"];

            if (this.ScreenObject.GridDataColumns.Contains("PackType") && ds.Columns[0].Contains("IsPacking"))
                datarow["PackType"] = ds.Tables[0][0]["IsPacking"];

            if (this.ScreenObject.GridDataColumns.Contains("IsTestCase") && ds.Columns[0].Contains("TestCaseExists"))
                datarow["IsTestCase"] = ds.Tables[0][0]["TestCaseExists"];

            if (this.ScreenObject.GridDataColumns.Contains("landingType") && ds.Columns[0].Contains("IsBillOfEntry"))
                datarow["landingType"] = ds.Tables[0][0]["IsBillOfEntry"];

            if (ds.Tables.length > 3 && ds.Tables[3].length > 0)//prices
            {
                if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                    if (ds.Tables[3][0]["PurchaseRate"] != null)
                        datarow["Rate"] = ds.Tables[3][0]["PurchaseRate"];
                }
                else if (ds.Tables[3][0]["SellingRate"] != null)
                    datarow["Rate"] = ds.Tables[3][0]["SellingRate"];
            }
            else if (ds.Tables.length > 0 && ds.Tables[0].length > 0)//prices
            {
                if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                    if (!Util.IsEmpty(ds.Tables[0][0]["PurchaseRate"]))
                        datarow["Rate"] = ds.Tables[0][0]["PurchaseRate"];
                }
                else if (!Util.IsEmpty(ds.Tables[0][0]["SellingRate"]))
                    datarow["Rate"] = ds.Tables[0][0]["SellingRate"];
            }
            let qtycol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Quantity");
            let qtydbl = 0;
            if (qtycol && qtycol.DefaultValue != "" && Util.IsNum(qtycol.DefaultValue))
                datarow["Quantity"] = qtycol.DefaultValue;
            else
                datarow["Quantity"] = 1;

            if (this.IsMobile && this.IsNativeMobile) {
                this.res = "No";
                if (ds.Tables.length > 0 && ds.Columns[0].Contains("uomid") && !Util.IsEmpty(ds.Tables[0][0]["uomid"])) {
                    datarow["Unit"] = ds.Tables[0][0]["UnitName"].toString();
                    datarow["Unit_Key"] = ds.Tables[0][0]["uomid"].toString();
                }
                if (this.ScreenObject.Preferences.ContainsKey("IgnoreKitPopup") && this.ScreenObject.Preferences["IgnoreKitPopup"] == "True" && ds.Tables[0][0]["ProductTypeID"].toString() == "3") {
                    let dsvm = new DynamicSetViewModel(this, datarow, ds);

                    dsvm.OnButtonClick("AutoSave");
                }
                else
                    BaseService.page.ShowDialog(new DynamicSetViewModel(this, datarow, ds), DynamicSetComponent);
                if (this.res == "Yes")
                    return;
                else if (this.res == "No" && datarow["ProductID_Key"] == "")
                    return;
            } else if (BaseService.page.DialogCount == 0 && ind > 0) {
                this.res = "No";
                if (ds.Tables.length > 0 && ds.Columns[0].Contains("uomid") && !Util.IsEmpty(ds.Tables[0][0]["uomid"])) {
                    datarow["Unit"] = ds.Tables[0][0]["UnitName"].toString();
                    datarow["Unit_Key"] = ds.Tables[0][0]["uomid"].toString();
                }
                if (this.ScreenObject.Preferences.ContainsKey("IgnoreKitPopup") && this.ScreenObject.Preferences["IgnoreKitPopup"] == "True" && ds.Tables[0][0]["ProductTypeID"].toString() == "3") {
                    let dsvm = new DynamicSetViewModel(this, datarow, ds);
                    dsvm.OnButtonClick("AutoSave");
                }
                else
                    BaseService.page.ShowDialog(new DynamicSetViewModel(this, datarow, ds), DynamicSetComponent);
                if (this.res == "Yes")
                    return;
                else if (this.res == "No" && datarow["ProductID_Key"] == "")
                    return;
            }

        }
        else if (!isfomCatalog) {
            if (!(this.ScreenObject.Preferences.ContainsKey("Dontresetvaluesonproductchange") && this.ScreenObject.Preferences["Dontresetvaluesonproductchange"] != "" && parseBoolean(this.ScreenObject.Preferences["Dontresetvaluesonproductchange"])
                && !Util.IsEmpty(datarow["Quantity"]))) {
                if (!(!Util.IsEmpty(datarow["LinkedInvDocDetailsID"]) && parseInt(datarow["LinkedInvDocDetailsID"]) > 0 && this.ScreenObject.Preferences.ContainsKey("SnoBasedLinking") && this.ScreenObject.Preferences["SnoBasedLinking"] != "" && parseBoolean(this.ScreenObject.Preferences["SnoBasedLinking"]))) {
                    if (!Util.IsEmpty(StockCode) && this.IsSales == "0") {
                        datarow["Quantity"] = -1;
                        this.RowForegroundChange(datarow);
                    }
                    else {
                        if (this.ScreenObject.Preferences.ContainsKey("EnableWieghingPopupOnQty") && this.ScreenObject.Preferences["EnableWieghingPopupOnQty"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableWieghingPopupOnQty"]) && datarow["IsWeightable"].toString().toLowerCase() == "true") {
                            let Quantity: string = this.QtyReader("0");
                            if (this.IsSales == "0") {
                                datarow["Quantity"] = Util.IsEmpty(Quantity) ? 0 : -parseFloat(Quantity);
                                this.RowForegroundChange(datarow);
                            }
                            else
                                datarow["Quantity"] = Util.IsEmpty(Quantity) ? 0 : parseFloat(Quantity);
                        }
                        else {
                            let qtycol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Quantity");
                            let qtydbl = 0;
                            if (qtycol && qtycol.DefaultValue != "" && Util.IsNum(qtycol.DefaultValue)) {
                                qtydbl = Util.Double(qtycol.DefaultValue)
                                if (this.IsSales == "0") {
                                    datarow["Quantity"] = -qtydbl;
                                    this.RowForegroundChange(datarow);
                                }
                                else
                                    datarow["Quantity"] = qtydbl;
                            }
                            else {
                                if (this.IsSales == "0") {
                                    datarow["Quantity"] = -1;
                                    this.RowForegroundChange(datarow);
                                }
                                else
                                    datarow["Quantity"] = 1;
                            }
                        }
                    }
                }
            }
            if (!Util.IsEmpty(datarow["Rate"])) {
                datarow["Rate"] = 0;
                datarow["defaultRate"] = 0;
            }

        }

        if (!Util.IsEmpty(datarow["Quantity"]) && this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && parseInt(datarow["ProductID_Key"]) != this.ScreenObject.TempProductID
            && this.ScreenObject.Preferences.ContainsKey("DuplicateProduct_IncrementQuantity") && this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"] != "" && parseBoolean(this.ScreenObject.Preferences["DuplicateProduct_IncrementQuantity"])) {
            let qtycol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "quantity");
            if (qtycol.ReadOnly || isfomCatalog) {
                if (ds.Tables.length > 0 && ds.Columns[0].Contains("uomid") && !Util.IsEmpty(ds.Tables[0][0]["uomid"])) {
                    datarow["Unit"] = ds.Tables[0][0]["UnitName"].toString();
                    datarow["Unit_Key"] = ds.Tables[0][0]["uomid"].toString();
                }
                datarow["Type"] = ds.Tables[0][0]["ProductTypeID"].toString();

                if (this.AddProductQty(datarow, !isfomCatalog)) {
                    let Vldbl = 0;
                    if (!Util.IsEmpty(datarow["Quantity"]) && !Util.IsEmpty(datarow["UOMConversion"]) && Util.IsNum(datarow["UOMConversion"])) {
                        datarow["UOMConvertedQty"] = Util.Double(datarow["UOMConversion"]) * parseFloat(datarow["Quantity"]);
                    }
                    else if (!Util.IsEmpty(datarow["Quantity"]))
                        datarow["UOMConvertedQty"] = datarow["Quantity"].toString();
                    this.ScreenObject.GridDataObj.updateRow(datarow);
                    return;
                }
            }
        }


        if (ds.Tables.length > 0 && ds.Tables[0].length > 0 && !ds.Columns[0].Contains("ErrorMessage")) {
            datarow["Type"] = ds.Tables[0][0]["ProductTypeID"].toString();

            if (this.ScreenObject.GridDataColumns.Contains("QtyType") && ds.Columns[0].Contains("QtyAdjustType"))
                datarow["QtyType"] = ds.Tables[0][0]["QtyAdjustType"];

            if (this.ScreenObject.GridDataColumns.Contains("PackType") && ds.Columns[0].Contains("IsPacking"))
                datarow["PackType"] = ds.Tables[0][0]["IsPacking"];

            if (this.ScreenObject.GridDataColumns.Contains("IsTestCase") && ds.Columns[0].Contains("TestCaseExists"))
                datarow["IsTestCase"] = ds.Tables[0][0]["TestCaseExists"];

            if (this.ScreenObject.GridDataColumns.Contains("landingType") && ds.Columns[0].Contains("IsBillOfEntry"))
                datarow["landingType"] = ds.Tables[0][0]["IsBillOfEntry"];

            if (this.ScreenObject.GridDataColumns.Contains("BinWise") && ds.Columns[0].Contains("BinWise"))
                datarow["BinWise"] = ds.Tables[0][0]["BinWise"];

            datarow["UOMConversion"] = ds.Tables[0][0]["Conversion"];
            if (ds.Columns[0].Contains("FileGUID")) {
                datarow["FileGUID"] = Util.String(ds.Tables[0][0]["FileGUID"]);
                datarow["FileExtension"] = Util.String(ds.Tables[0][0]["FileExtension"]);
            }

            if (ds.Columns[0].Contains("Barcode_Key") && !Util.IsEmpty(ds.Tables[0][0]["Barcode_Key"]) && this.ScreenObject.Preferences.ContainsKey("BarcodeDimension") && this.ScreenObject.Preferences["BarcodeDimension"] != "" && parseInt(this.ScreenObject.Preferences["BarcodeDimension"]) > 0) {
                let barcodecol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == parseInt(this.ScreenObject.Preferences["BarcodeDimension"]));
                if (barcodecol) {
                    datarow[barcodecol.ValueMember] = ds.Tables[0][0]["Barcode_Key"];
                    datarow[barcodecol.DisplayMember] = ds.Tables[0][0]["UnitProductCode"];
                    if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == barcodecol.ID).length > 0) {
                        this.ScreenObject.GetLinkReferenceData(parseInt(barcodecol.ID), this.DocumentID, parseInt(datarow[barcodecol.ValueMember]), Date.Today(), "", barcodecol.CostCenterID, datarow);
                    }
                }
            }

            if (ds.Columns[0].Contains("LastPurchaseRate") && !Util.IsEmpty(ds.Tables[0][0]["LastPurchaseRate"]))
                datarow["LASTPURCHASERATE"] = ds.Tables[0][0]["LastPurchaseRate"];
            else
                datarow["LASTPURCHASERATE"] = 0;

            if (!Util.IsEmpty(datarow["Quantity"]) && !Util.IsEmpty(ds.Tables[0][0]["Conversion"]) && Util.IsNum(ds.Tables[0][0]["Conversion"])) {
                datarow["UOMConvertedQty"] = Util.Double(ds.Tables[0][0]["Conversion"]) * parseFloat(datarow["Quantity"]);
            }
            else if (!Util.IsEmpty(datarow["Quantity"]))
                datarow["UOMConvertedQty"] = datarow["Quantity"];

            if (ds.Tables.length > 0 && ds.Columns[0].Contains("uomid") && !Util.IsEmpty(ds.Tables[0][0]["uomid"])) {
                datarow["Unit"] = ds.Tables[0][0]["UnitName"];
                datarow["Unit_Key"] = ds.Tables[0][0]["uomid"];
            }
        }
        let drCCRate: any = null;
        if (datarow["Type"] != null && Util.String(datarow["Type"]) != "8" && Util.String(datarow["Type"]) != "3") {
            let RateCol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Rate");
            let strRateColumn = "";
            if (!Util.IsEmpty(RateCol.Formula) && ds.Columns[3].Contains(RateCol.Formula)) {
                strRateColumn = RateCol.Formula;
            }
            if (ds.Tables.length > 3 && ds.Tables[3].length > 0)//prices
            {
                if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                    strRateColumn = "PurchaseRate";
                }
                else
                    strRateColumn = "SellingRate";

                drCCRate = ds.Tables[3][0];
                let ind = this.ScreenObject.GridData.indexOf(datarow) + 1;
                if (ds.Tables[3].length > 1 && ind > 0 && (RateCol.Formula == null || !RateCol.Formula.toLowerCase().Contains("avgrate"))) {
                    let RatePicker: ProductRatePickerViewModel = new ProductRatePickerViewModel(this)
                    {
                        RatePicker.LoadData(ds.Tables[3], strRateColumn, 1);
                        await BaseService.page.openDialog(RatePicker, ProductRatePickerComponent, { ShowCenter: true })
                        if (RatePicker.RateGrid.SelectedItem != null) {
                            drCCRate = RatePicker.RateGrid.SelectedItem;
                        }
                    }
                }

                if (!Util.IsEmpty(strRateColumn) && !Util.IsEmpty(drCCRate[strRateColumn])) {
                    datarow["Rate"] = drCCRate[strRateColumn];
                    datarow["default" + "Rate"] = drCCRate[strRateColumn];
                }
            }
            else if (!Util.IsEmpty(rate)) {
                datarow["Rate"] = rate;
            }
            else if (ds.Tables.length > 0 && ds.Tables[0].length > 0 && !ds.Columns[0].Contains("ErrorMessage")) {
                if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                    if (!Util.IsEmpty(ds.Tables[0][0]["PurchaseRate"])) {
                        datarow["Rate"] = ds.Tables[0][0]["PurchaseRate"];
                        datarow["default" + "Rate"] = ds.Tables[0][0]["PurchaseRate"];
                    }
                    else
                        datarow["Rate"] = 0;
                }
                else if (!Util.IsEmpty(ds.Tables[0][0]["SellingRate"])) {
                    datarow["Rate"] = ds.Tables[0][0]["SellingRate"];
                    datarow["default" + "Rate"] = ds.Tables[0][0]["SellingRate"];
                }
            }
        }
        if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0 && !ds.Columns[0].Contains("ErrorMessage"))
            this.FillLinkRefereceProducts(datarow, ds.Tables[0], drCCRate);

        if (ds.Tables.length > 10 && ds.Columns[10].Contains("BinId") && ds.Tables[10].length > 0 && ds.Tables[10][0]["BinId"] != 0 && this.ScreenObject.Preferences.ContainsKey("BinsDimension") && parseInt(this.ScreenObject.Preferences["BinsDimension"]) > 50000) {
            let bincol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == parseInt(this.ScreenObject.Preferences["BinsDimension"]));
            if (bincol && this.ScreenObject.GridDataColumns.Contains(bincol.DisplayMember)) {
                datarow[bincol.DisplayMember] = ds.Tables[10][0]["BinName"].toString();
                datarow[bincol.ValueMember] = ds.Tables[10][0]["BinId"].toString();
            }
        }
        let NumColt = this.ScreenObject.ColumnSource.filter(a => a.DisplayMember.Contains("dcNum") && a.SectionID != 4);
        NumColt.forEach(item => {
            if (item.linkData > 0)
                return;
            if (Util.String(datarow["Type"]) != "8" && Util.String(datarow["Type"]) != "3") {

                if (!(this.ScreenObject.Preferences.ContainsKey("Dontresetvaluesonproductchange") && this.ScreenObject.Preferences["Dontresetvaluesonproductchange"] != "" && parseBoolean(this.ScreenObject.Preferences["Dontresetvaluesonproductchange"])
                    && !Util.IsEmpty(datarow["Quantity"])) && !item.IsRepeat) {
                    datarow[item.DisplayMember] = 0;
                    datarow["default" + item.DisplayMember] = 0;
                    datarow["dcCalc" + item.DisplayMember] = 0;
                }
            }
            if (ds.Tables.length > 4)//Extra Fields
            {
                let drr = ds.Tables[4].filter(x => x.SysColumnName == item.DisplayMember);
                if (drr.length > 0) {
                    datarow[item.DisplayMember] = drr[0]["Value"].toString();
                    datarow["default" + item.DisplayMember] = drr[0]["Value"].toString();
                }
                //else if (ds.Tables.length > 5)
                //{
                //    drr = ds.Tables[5].filter(x=>x.SysColumnName==item.DisplayMember);
                //    if (drr.length > 0)
                //    {
                //        datarow[item.DisplayMember] = drr[0]["Value"].toString();
                //        datarow["default" + item.DisplayMember] = drr[0]["Value"].toString();
                //    }
                //}
            }
        });

        if (ds != null && ds.Tables.length > 7 && ds.Tables[7].length > 0 && !ds.Columns[7].Contains("ErrorMessage")
            && this.ScreenObject.Preferences.ContainsKey("Enable Linked Products") && this.ScreenObject.Preferences["Enable Linked Products"] != "" && parseBoolean(this.ScreenObject.Preferences["Enable Linked Products"]) && !IsFromLink) {
            let ind = this.ScreenObject.GridData.indexOf(datarow) + 1;
            if (ind > 0)
                this.AddLinkProducts(ds.Tables[7], ind);

        }
        let LRefCalled = false;
        let prodcol = this.ScreenObject.ColumnSource.filter(a => a.ValueMember != null && a.ValueMember.toString().toLowerCase() == "productid_key");
        prodcol.forEach(ProdExtracol => {
            let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == ProdExtracol.ID);
            if ((dvCnt.length > 0 || this.ScreenObject.DefaultBasedOn.ContainsKey("3")) && ProdExtracol.ValueMember != "" && datarow[ProdExtracol.ValueMember] != null && !Util.IsEmpty(datarow[ProdExtracol.ValueMember])) {
                LRefCalled = true;
                this.ScreenObject.GetLinkReferenceData(parseInt(ProdExtracol.ID), this.DocumentID, parseInt(datarow[ProdExtracol.ValueMember]), Date.Today(), "", ProdExtracol.CostCenterID, datarow, null, false, this.ImportCopyProductdata);
            }
        });

        let dCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference == 79 && (x.LinkData == 26585 || x.LinkData == 54306 || x.LinkData == 54307 || x.LinkData == 53529 || x.LinkData == 53589 || x.LinkData == 53530));
        if (!LRefCalled && dCnt.length > 0 && prodcol.length > 0) {
            let ProdExtracol = prodcol[0];
            this.ScreenObject.GetLinkReferenceData(parseInt(ProdExtracol.ID), this.DocumentID, parseInt(datarow[ProdExtracol.ValueMember]), Date.Today(), "", ProdExtracol.CostCenterID, datarow, null, false, this.ImportCopyProductdata);
        }

        if (this.ScreenObject.Preferences.ContainsKey("BUDGET_BudgetAccountField") && !Util.IsEmpty(this.ScreenObject.Preferences["BUDGET_BudgetAccountField"]) && this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.Preferences["BUDGET_BudgetAccountField"] + "_Key") && !Util.IsEmpty(datarow[this.ScreenObject.Preferences["BUDGET_BudgetAccountField"] + "_Key"]))
            this.BudgetObj.AutoLoadBudgetDimension(datarow, null);

        if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0 && !ds.Columns[0].Contains("ErrorMessage"))
            this.FillSalesPurchase(datarow, ds.Tables[0], drCCRate);

        if (ds != null && ds.Tables.length > 11 && ds.Columns[11].Contains("FileDescription") && ds.Tables[11].length > 0 && this.ViewAttachments != null) {
            if (this.ScreenObject.Preferences.ContainsKey("AutoAttachment") && this.ScreenObject.Preferences["AutoAttachment"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["AutoAttachment"])) {
                for (let p = 0; p < ds.Tables[11].length; p++) {
                    let addatt = new AddAttachmentViewModel();
                    addatt.AddAttachmentViewModel_2(this);
                    {
                        addatt.ActualFileName = Util.StringValue(ds.Tables[11][p]["ActualFileName"]);
                        addatt.FileExtension = Util.StringValue(ds.Tables[11][p]["FileExtension"]);
                        addatt.Guid = Util.StringValue(ds.Tables[11][p]["GUID"]);
                        addatt.FileDescription = Util.StringValue(ds.Tables[11][p]["FileDescription"]);
                        addatt.FilePath = Util.GetPath(Util.StringValue(ds.Tables[11][p]["GUID"]) + "." + Util.StringValue(ds.Tables[11][p]["FileExtension"]));
                        addatt.RelativeFileName = Util.StringValue(ds.Tables[11][p]["RelativeFileName"]);
                        addatt.AllowInPrintVisible = true;
                        addatt.AllowInPrint = true;
                        addatt.isfrmProduct = true;
                        this.ViewAttachments.AttachmentsListObj.addRow(addatt);
                    }
                }
            }
            else if (this.ScreenObject.Preferences.ContainsKey("ProductAttachment") && this.ScreenObject.Preferences["ProductAttachment"].toString() != "" && parseBoolean(this.ScreenObject.Preferences["ProductAttachment"])) {
                BaseService.page.ShowDialog(new ProductAttachmentViewModel(this, ds.Tables[11], "")
                    , ProductAttachmentsComponent, { ShowCenter: true });

            }
        }

        if (this.ScreenObject.Preferences.ContainsKey("DimWiseCurrency") && this.ScreenObject.Preferences["DimWiseCurrency"].toLowerCase() == "true" &&
            this.ScreenObject.Preferences.ContainsKey("CurrencyDim") && this.ScreenObject.Preferences["CurrencyDim"] == "3" &&
            ds != null && ds.Tables.length > 12 && ds.Columns[12].Contains("Name") && ds.Tables[12].length > 0) {
            if (this.ScreenObject.GridDataColumns.Contains("CurrencyID")) {
                datarow["CurrencyID_Key"] = ds.Tables[12][0]["CurrencyID"].toString();
                datarow["CurrencyID"] = ds.Tables[12][0]["Name"].toString();
                if (this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && ds.Tables.length > 13 && ds.Columns[13].Contains("Rate") && ds.Tables[13].length > 0)
                    datarow["ExchangeRate"] = ds.Tables[13][0]["Rate"].toString();
            }
            else if (this.Currency && this.Currency.Currency.SelectedValue != null && this.Currency.Currency.SelectedValue != "") {
                this.Currency.Currency.SelectedValue = ds.Tables[12][0]["CurrencyID"].toString();
                if (ds.Tables.length > 13 && ds.Columns[13].Contains("Rate") && ds.Tables[13].length > 0)
                    this.Currency.ExchangeRate.Text = ds.Tables[13][0]["Rate"].toString();
            }
        }/**
        if (datarow.RowState != DataRowState.Detached && datarow.RowState != DataRowState.Deleted)
            this.ScreenObject.GridDataObj.updateRow(datarow);
**/
        //#region CommentedAttributes
        //if (parseInt(ds.Tables[0][0]["ProductTypeID"]) == 4)
        //{
        //    ShellWindowViewModel.Instance().PopViewModel = new DocumentAttributeViewModel(this, this.ScreenObject.DocumentType, parseInt(ds.Tables[0][0]["AttributeGroupID"]));
        //    PopUpFields.Clear();
        //}
        //#endregion

    }

    RowForegroundChange(dr: any, Clear: boolean = false) {
        if (!this.ScreenObject.GridDataColumns.Contains("Row_Foreground"))
            this.ScreenObject.GridDataColumns.push("Row_Foreground");
        if (Clear)
            dr["Row_Foreground"] = null;
        else
            dr["Row_Foreground"] = "#D30609";//new System.Windows.Media.SolidColorBrush((System.Windows.Media.Color)System.Windows.Media.ColorConverter.ConvertFromString("#FFD30609"));
        this.ScreenObject.GridDataObj.refreshDataView();
    }

    ValidateSchemes(): boolean {
        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["SchemeID"]) &&
                parseInt(this.ScreenObject.GridData[i]["ProductID_Key"]) > 0 && parseInt(this.ScreenObject.GridData[i]["SchemeID"]) > 0
                && this.ScreenObject.GridData[i]["IsScheme"].toString() == "N") {
                let ds: any = this.ScreenObject.GetSchemes(this.DocumentDate, this.ScreenObject.GridData[i]);
                if (ds.Tables.length > 0 && ds.Columns[0].Contains("SchemeID")) {
                    let drs = ds.Tables[0].filter(x => x.SchemeID == this.ScreenObject.GridData[i]["SchemeID"]);
                    if (drs.length > 0) {
                        if (!Util.IsEmpty(drs[0]["FromQty"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && !Util.IsEmpty(drs[0]["ToQty"]) && parseFloat(drs[0]["ToQty"]) != parseFloat(drs[0]["FromQty"])
                            && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) >= parseFloat(drs[0]["FromQty"]))
                            continue;
                        else if (!Util.IsEmpty(drs[0]["FromQty"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["Quantity"]) && !Util.IsEmpty(drs[0]["ToQty"]) && parseFloat(drs[0]["ToQty"]) == parseFloat(drs[0]["FromQty"])
                            && parseFloat(this.ScreenObject.GridData[i]["Quantity"]) >= parseFloat(drs[0]["FromQty"]))
                            continue;
                    }
                    this.fillSchemevalues(ds.Tables[0], ds.Columns[0], this.ScreenObject.GridData[i]);
                    this.ApplySchemes(this.ScreenObject.GridData[i]);
                }
            }
        }
        return true;
    }
    fillSchemevalues(dtscheme: any[], dtschemecols: any[], dr: any) {
        if (this.DtTempSchemes != null) {
            //let exists = dt.Select("ProductID=" + dr["ProductID_Key"].toString());
            //foreach (DataRow drtodel in exists)
            //{
            //    dt.Rows.Remove(drtodel);
            //}

            this.DtTempSchemes.Clear();
        }
        else {
            this.DtTempSchemes = []
            this.DtTempSchemesColumns = []
            this.DtTempSchemesColumns.push("SchemeProductID");
            this.DtTempSchemesColumns.push("SchemeID");
            this.DtTempSchemesColumns.push("ProfileName");
            this.DtTempSchemesColumns.push("FromQty");
            this.DtTempSchemesColumns.push("ToQty");
            this.DtTempSchemesColumns.push("FromValue");
            this.DtTempSchemesColumns.push("ToValue");
            this.DtTempSchemesColumns.push("ProductID");
            this.DtTempSchemesColumns.push("Quantity");
            this.DtTempSchemesColumns.push("Value");
            this.DtTempSchemesColumns.push("Percentage");
            this.DtTempSchemesColumns.push("freeProductID");
            this.DtTempSchemesColumns.push("ProductName");
            this.DtTempSchemesColumns.push("ProductCode");
            this.DtTempSchemesColumns.push("freeQuantity");
            this.DtTempSchemesColumns.push("freeValue");
            this.DtTempSchemesColumns.push("freePercentage");
            this.DtTempSchemesColumns.push("ProductTypeID");
            this.DtTempSchemesColumns.push("IsQtyPercent");
            this.DtTempSchemesColumns.push("FreeQtyPercent");
            this.DtTempSchemesColumns.push("FromDate");
            this.DtTempSchemesColumns.push("ToDate");
            if (dtscheme != null && dtschemecols.Contains("Dim1")) {
                this.DtTempSchemesColumns.push("Dim1");
                this.DtTempSchemesColumns.push("Name");
            }
        }
        if (dtscheme != null) {
            for (let j = 0; j < dtscheme.length; j++) {
                let drsc = {};
                drsc["SchemeProductID"] = dtscheme[j]["SchemeProductID"].toString();
                drsc["SchemeID"] = dtscheme[j]["SchemeID"].toString();
                drsc["FromQty"] = dtscheme[j]["FromQty"].toString();
                drsc["ToQty"] = dtscheme[j]["ToQty"].toString();
                drsc["ProfileName"] = dtscheme[j]["ProfileName"].toString();
                drsc["FromValue"] = dtscheme[j]["FromValue"].toString();
                drsc["ToValue"] = dtscheme[j]["ToValue"].toString();
                drsc["ProductID"] = dtscheme[j]["ProductID"].toString();
                drsc["Quantity"] = dtscheme[j]["Quantity"].toString();
                drsc["Value"] = dtscheme[j]["Value"].toString();
                drsc["Percentage"] = dtscheme[j]["Percentage"].toString();
                drsc["IsQtyPercent"] = dtscheme[j]["IsQtyPercent"].toString();
                drsc["FromDate"] = dtscheme[j]["FromDate"].toString();
                drsc["ToDate"] = dtscheme[j]["ToDate"].toString();

                if (!Util.IsEmpty(dtscheme[j]["freeProductID"])) {
                    drsc["FreeQtyPercent"] = dtscheme[j]["FreeQtyPercent"].toString();
                    drsc["freeProductID"] = dtscheme[j]["freeProductID"].toString();
                    drsc["ProductName"] = dtscheme[j]["ProductName"].toString();
                    drsc["ProductCode"] = dtscheme[j]["ProductCode"].toString();
                    drsc["freeQuantity"] = dtscheme[j]["freeQuantity"].toString();
                    drsc["freeValue"] = dtscheme[j]["freeValue"].toString();
                    drsc["freePercentage"] = dtscheme[j]["freePercentage"].toString();
                    drsc["ProductTypeID"] = dtscheme[j]["ProductTypeID"].toString();

                    if (dtschemecols.Contains("Dim1") && this.DtTempSchemesColumns.Contains("Dim1")) {
                        drsc["Dim1"] = dtscheme[j]["Dim1"].toString();
                        drsc["Name"] = dtscheme[j]["Name"].toString();
                    }
                }
                this.DtTempSchemes.push(drsc);
            }
        }
    }
    FillRowValues(dt: any[], dr: any, dtColumns: string[]) {
        let drsc = {};
        drsc["SchemeProductID"] = dr["SchemeProductID"].toString();
        drsc["SchemeID"] = dr["SchemeID"].toString();
        drsc["FromQty"] = dr["FromQty"].toString();
        drsc["ToQty"] = dr["ToQty"].toString();
        drsc["ProfileName"] = dr["ProfileName"].toString();
        drsc["FromValue"] = dr["FromValue"].toString();
        drsc["ToValue"] = dr["ToValue"].toString();
        drsc["ProductID"] = dr["ProductID"].toString();
        drsc["Quantity"] = dr["Quantity"].toString();
        drsc["Value"] = dr["Value"].toString();
        drsc["Percentage"] = dr["Percentage"].toString();
        drsc["IsQtyPercent"] = dr["IsQtyPercent"].toString();
        drsc["ToDate"] = dr["ToDate"].toString();
        drsc["FromDate"] = dr["FromDate"].toString();

        if (!Util.IsEmpty(dr["freeProductID"])) {
            drsc["FreeQtyPercent"] = dr["FreeQtyPercent"].toString();
            drsc["freeProductID"] = dr["freeProductID"].toString();
            drsc["ProductName"] = dr["ProductName"].toString();
            drsc["ProductCode"] = dr["ProductCode"].toString();
            drsc["freeQuantity"] = dr["freeQuantity"].toString();
            drsc["freeValue"] = dr["freeValue"].toString();
            drsc["freePercentage"] = dr["freePercentage"].toString();
            drsc["ProductTypeID"] = dr["ProductTypeID"].toString();
            drsc["FreeProductName"] = dr["ProductName"].toString();
            var drschrow = dt.filter(x => x.SchemeID == dr["SchemeID"].toString() && (x.StyleHeightZero == null || x.StyleHeightZero != 1));// and (StyleHeightZero is null or StyleHeightZero<>'1')");
            if (drschrow.length > 0) {
                drschrow[0]["FreeProductName"] = drschrow[0]["FreeProductName"].toString() + "," + dr["ProductName"].toString();
                drsc["StyleHeightZero"] = "1";
            }

            if (dtColumns.Contains("Dim1")) {
                drsc["Dim1"] = dr["Dim1"].toString();
                drsc["Name"] = dr["Name"].toString();
            }
        }
        dt.push(drsc);
    }
    async ApplySchemes(dr: any) {
        let schemes = false;
        if (this.ScreenObject.Preferences.ContainsKey("EnableSchemes") && parseBoolean(this.ScreenObject.Preferences["EnableSchemes"]))
            schemes = parseBoolean(this.ScreenObject.Preferences["EnableSchemes"]);
        if (!schemes)
            return;
        let schemeapplied = false;
        let Filter: any[] = [];
        let dttem = []
        let dttemColumns: string[] = []
        {
            dttemColumns.push("SchemeProductID");
            dttemColumns.push("SchemeID");
            dttemColumns.push("FromQty");
            dttemColumns.push("ToQty");
            dttemColumns.push("FromValue");
            dttemColumns.push("ToValue");
            dttemColumns.push("ProductID");
            dttemColumns.push("Quantity");
            dttemColumns.push("Value");
            dttemColumns.push("Percentage");
            dttemColumns.push("freeProductID");
            dttemColumns.push("ProductName");
            dttemColumns.push("FreeProductName");
            dttemColumns.push("StyleHeightZero");
            dttemColumns.push("ProductCode");
            dttemColumns.push("freeQuantity");
            dttemColumns.push("freeValue");
            dttemColumns.push("ProfileName");
            dttemColumns.push("freePercentage");
            dttemColumns.push("ProductTypeID");
            dttemColumns.push("IsQtyPercent");
            dttemColumns.push("FreeQtyPercent");
            dttemColumns.push("ToDate");
            dttemColumns.push("FromDate");

            if (this.DtTempSchemes != null && this.DtTempSchemesColumns.Contains("Dim1")) {
                dttemColumns.push("Dim1");
                dttemColumns.push("Name");
            }

            let GrossFld = "GROSS";
            if (this.ScreenObject.Preferences.ContainsKey("SchemesNumericFields") && this.ScreenObject.Preferences["SchemesNumericFields"] != "" && this.ScreenObject.Preferences["SchemesNumericFields"] != "0") {
                let Col = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["SchemesNumericFields"]);
                if (Col && Col.DisplayMember != "")
                    GrossFld = Col.DisplayMember;
            }

            if (!Util.IsEmpty(dr["ProductID_Key"]) && this.DtTempSchemes != null) {
                let exists = this.DtTempSchemes.filter(x => x.ProductID == dr["ProductID_Key"]);
                exists.sort((a, b) => (a.FromQty < b.FromQty) ? 1 : (a.FromQty == b.FromQty) ? ((a.FromValue < b.FromValue) ? 1 : -1) : -1)
                // "FromQty desc,FromValue desc"
                if (exists.length > 0) {
                    let Qty = 0, grs = 0;
                    let loyl = BaseService.SessionManager.Preferences["LoyaltyBasedOn"].toString().split(',');

                    if (this.ScreenObject.Preferences.ContainsKey("PriceScheme") && parseBoolean(this.ScreenObject.Preferences["PriceScheme"])) {
                        if (!Util.IsEmpty(dr["Quantity"]))
                            Qty = parseFloat(dr["Quantity"]);
                        if (!Util.IsEmpty(dr[GrossFld]))
                            grs = parseFloat(dr[GrossFld]);
                    }
                    else {
                        Filter = this.ScreenObject.GridData.filter(x => x.ProductID_Key == dr["ProductID_Key"] && (Util.IsEmpty(x.IsScheme) || x.IsScheme != 'Y'));

                        let val = Filter.Compute("sum", "Quantity");
                        if (val != null && Util.IsNum(val))
                            Qty = parseFloat(val);

                        val = Filter.Compute("sum", GrossFld);
                        if (val != null && Util.IsNum(val))
                            grs = parseFloat(val);
                    }
                    for (let p = 0; p < exists.length; p++) {
                        let drow = exists[p]
                        if (loyl.length > 1 && !(this.ScreenObject.Preferences.ContainsKey("PriceScheme") && parseBoolean(this.ScreenObject.Preferences["PriceScheme"]))) {
                            Filter = this.ScreenObject.GridData.filter(x => Util.IsEmpty(x.IsScheme) || x.IsScheme != 'Y');
                            if (loyl.Contains("-1"))
                                Filter = Filter.filter(x => x.SchemeProductID == drow["SchemeProductID"]);
                            loyl.forEach(item => {
                                let col = this.ScreenObject.ColumnSource.find(a => a.CostCenterID.toString() == item);
                                if (col && !Util.IsEmpty(dr[col.ValueMember]))
                                    Filter = Filter.filter(x => x[col.ValueMember] == dr[col.ValueMember]);
                            });

                            let val = Filter.Compute("sum", "Quantity");
                            if (val != null && Util.IsNum(val))
                                Qty = parseFloat(val);

                            val = Filter.Compute("sum", GrossFld);
                            if (val != null && Util.IsNum(val))
                                grs = parseFloat(val);
                        }

                        if (!Util.IsEmpty(drow["FromQty"]) && !Util.IsEmpty(drow["ToQty"]) && parseFloat(drow["FromQty"]) > 0
                            && parseFloat(drow["ToQty"]) != parseFloat(drow["FromQty"])
                            && Qty >= parseFloat(drow["FromQty"]) && (parseFloat(drow["ToQty"]) == 0 || Qty <= parseFloat(drow["ToQty"])))
                            this.FillRowValues(dttem, drow, dttemColumns);
                        else if (!Util.IsEmpty(drow["FromQty"]) && !Util.IsEmpty(drow["ToQty"]) && parseFloat(drow["FromQty"]) > 0
                            && parseFloat(drow["ToQty"]) == parseFloat(drow["FromQty"])
                            && Qty >= parseFloat(drow["FromQty"]))
                            this.FillRowValues(dttem, drow, dttemColumns);
                        else if (!Util.IsEmpty(drow["FromValue"]) && !Util.IsEmpty(drow["ToValue"]) && parseFloat(drow["FromValue"]) > 0 && parseFloat(drow["ToValue"]) != parseFloat(drow["FromValue"])
                            && grs >= parseFloat(drow["FromValue"]) && (parseFloat(drow["ToValue"]) == 0 || grs <= parseFloat(drow["ToValue"])))
                            this.FillRowValues(dttem, drow, dttemColumns);
                        else if (!Util.IsEmpty(drow["FromValue"]) && !Util.IsEmpty(drow["ToValue"]) && parseFloat(drow["FromValue"]) > 0 && parseFloat(drow["ToValue"]) == parseFloat(drow["FromValue"])
                            && grs >= parseFloat(drow["FromValue"]))
                            this.FillRowValues(dttem, drow, dttemColumns);
                    }
                    if (dttem.length == 1) {
                        schemeapplied = true;
                        this.FillSchemeRows(dr, dttem[0], GrossFld);
                        if (loyl.Contains("-1"))
                            dr["SchemeProductID"] = dttem[0]["SchemeProductID"].toString();

                        if (!Util.IsEmpty(dttem[0]["Percentage"]) && parseFloat(dttem[0]["Percentage"]) > 0
                            && !Util.IsEmpty(dttem[0]["IsQtyPercent"]) && parseInt(dttem[0]["IsQtyPercent"]) == 2)
                            this.CalculateTotals(dr, false);
                        else
                            this.CalculateTotals(null, false);
                    }
                    else if (dttem.length > 1) {
                        let RatePicker = new ProductRatePickerViewModel(this)
                        {
                            RatePicker.LoadData(dttem, "", 2);
                            if (!Util.IsEmpty(dr["SchemeID"]) && parseInt(dr["SchemeID"]) > 0 && RatePicker.RateGrid.Table.filter(x => x.SchemeID == dr["SchemeID"]).length > 0) {
                                RatePicker.RateGrid.SelectedIndex = RatePicker.RateGrid.Table.indexOf(RatePicker.RateGrid.Table.filter(x => x.SchemeID == dr["SchemeID"])[0]);
                            }
                            await BaseService.page.openDialog(RatePicker, ProductRatePickerComponent, { ShowCenter: true })
                            if (RatePicker.RateGrid.SelectedItem != null) {
                                schemeapplied = true;
                                this.FillSchemeRows(dr, RatePicker.RateGrid.SelectedItem, GrossFld);
                                if (loyl.Contains("-1"))
                                    dr["SchemeProductID"] = RatePicker.RateGrid.SelectedItem["SchemeProductID"].toString();
                            }
                        }
                    }
                    else if (dttem.length == 0 && loyl.Contains("-1") && exists.length > 0) {
                        dr["SchemeProductID"] = exists[0]["SchemeProductID"].toString();
                    }
                }
            }
        }

        if (!schemeapplied) {
            let schemeids = "", filter = "";

            if (Filter.length > 0) {
                let rowsval = Filter.filter(x => x.SchemeID == -1);
                if (this.ScreenObject.Preferences.ContainsKey("SchemesValueField") && this.ScreenObject.Preferences["SchemesValueField"] != "" && this.ScreenObject.Preferences["SchemesValueField"] != "0") {
                    let Col = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["SchemesValueField"]);
                    if (Col && Col.DisplayMember != "") {
                        rowsval.forEach(item => {
                            item[Col.DisplayMember] = "0";
                            this.CalculateTotals(item, false);
                        });
                    }
                }
            }
            else if (Util.String(dr["SchemeID"]) == "-1") {
                if (this.ScreenObject.Preferences.ContainsKey("SchemesValueField") && this.ScreenObject.Preferences["SchemesValueField"] != "" && this.ScreenObject.Preferences["SchemesValueField"] != "0") {
                    let Col = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["SchemesValueField"]);
                    if (Col && Col.DisplayMember != "") {
                        dr[Col.DisplayMember] = "0";
                        this.CalculateTotals(dr, false);
                    }
                }
            }

            let drprrows = []
            if (!Util.IsEmpty(dr["ProductID_Key"]))
                drprrows = this.ScreenObject.GridData.filter(x => x.ProductID_Key == dr["ProductID_Key"] && (Util.IsEmpty(x.IsScheme) || x.IsScheme != 'Y'));
            else if (!Util.IsEmpty(dr["MaxSchemeID"]))
                drprrows = this.ScreenObject.GridData.filter(x => x.MaxSchemeID == dr["MaxSchemeID"] && (Util.IsEmpty(x.IsScheme) || x.IsScheme != 'Y'));
            else
                return;

            drprrows.forEach(item => {
                if (!Util.IsEmpty(item["MaxSchemeID"]) && parseInt(item["MaxSchemeID"]) > 0) {
                    schemeids += item["MaxSchemeID"].toString() + ",";
                    item["IsScheme"] = null;
                    item["MaxSchemeID"] = null;
                    item["SchemeID"] = null;
                }
            });
            if (schemeids.length > 1) {
                schemeids = schemeids.Remove(schemeids.length - 1, 1);

                let drschemes = this.ScreenObject.GridData.filter(x => schemeids.split(',').Contains(x.MaxSchemeID) && x.IsScheme == 'Y');
                drschemes.forEach(ddel => {
                    this.ScreenObject.GridDataObj.removeRow(ddel);
                });
            }
        }
    }
    Copyparentrow(drSel: any, parentdr: any) {
        for (let c = 0; c < this.ScreenObject.GridDataColumns.length; c++) {
            if (this.ScreenObject.GridDataColumns[c].toLowerCase().Contains("ccnid")
                && this.ScreenObject.GridDataColumns[c].toLowerCase().Contains("alpha"))
                drSel[c] = parentdr[c];
        }
    }

    FillSchemeRows(dr: any, drow: any, GrossFld: string) {
        let DimCCid = 0;
        if (BaseService.SessionManager.Preferences.ContainsKey("SchemeFreeProdDim"))
            DimCCid = Util.Int(BaseService.SessionManager.Preferences["SchemeFreeProdDim"]);

        let ValueFld = GrossFld;
        if (this.ScreenObject.Preferences.ContainsKey("SchemesValueField") && this.ScreenObject.Preferences["SchemesValueField"] != "" && this.ScreenObject.Preferences["SchemesValueField"] != "0") {
            let Col = this.ScreenObject.ColumnSource.find(a => a.ID == this.ScreenObject.Preferences["SchemesValueField"]);
            if (Col && Col.DisplayMember != "")
                ValueFld = Col.DisplayMember;
        }
        let Qty = 0, grs = 0;

        let loyl = BaseService.SessionManager.Preferences["LoyaltyBasedOn"].toString().split(',');
        let drprrows = null;

        if (this.ScreenObject.Preferences.ContainsKey("PriceScheme") && parseBoolean(this.ScreenObject.Preferences["PriceScheme"])) {
            if (!Util.IsEmpty(dr["Quantity"]))
                Qty = parseFloat(dr["Quantity"]);
            if (!Util.IsEmpty(dr[GrossFld]))
                grs = parseFloat(dr[GrossFld]);
            drprrows = [];
        }
        else {
            let filterRows;
            if (loyl.length > 1) {
                if (loyl.Contains("-1"))
                    filterRows = this.ScreenObject.GridData.filter(x => (Util.IsEmpty(x.IsScheme) || x.IsScheme != 'Y') && x.SchemeProductID == drow["SchemeProductID"]);
                else
                    filterRows = this.ScreenObject.GridData.filter(x => (Util.IsEmpty(x.IsScheme) || x.IsScheme != 'Y'))
                loyl.forEach(item => {
                    let col = this.ScreenObject.ColumnSource.find(a => a.CostCenterID.toString() == item);
                    if (col && !Util.IsEmpty(dr[col.ValueMember]))
                        filterRows = filterRows.filter(x => x[col.ValueMember] == dr[col.ValueMember]);
                });
            }
            else
                filterRows = this.ScreenObject.GridData.filter(x => x.ProductID_Key == dr["ProductID_Key"] && (Util.IsEmpty(x.IsScheme) || x.IsScheme != 'Y'));

            let val = filterRows.Compute("sum", "Quantity");
            if (val != null)
                Qty = Util.Double(val);

            val = filterRows.Compute("sum", GrossFld);
            if (val != null)
                grs = Util.Double(val);

            drprrows = filterRows;
        }

        let isproductChange = false;


        let schemeids = "";
        let MaxSchemeID = 0;
        drprrows.forEach(item => {
            if (!Util.IsEmpty(item["MaxSchemeID"]) && parseInt(item["MaxSchemeID"]) > 0)
                schemeids += item["MaxSchemeID"].toString() + ",";
        });
        if (schemeids.length > 1)
            schemeids = schemeids.Remove(schemeids.length - 1, 1);
        //schemeapplied = true;
        if (parseFloat(drow["FromQty"]) > 0) {
            if (parseFloat(drow["ToQty"]) != parseFloat(drow["FromQty"])) {
                if (!Util.IsEmpty(drow["freeProductID"]) && parseInt(drow["freeProductID"]) > 0) {
                    let templink = this.ScreenObject.GridData.Compute("max", "MaxSchemeID");
                    if (templink != null)
                        MaxSchemeID = Util.Int(templink);
                    MaxSchemeID++;

                    let dradd = null;
                    let schpr = this.DtTempSchemes.filter(x => x.SchemeID == drow["SchemeID"]);
                    let drschemes = null;
                    if (schemeids != "")
                        drschemes = this.ScreenObject.GridData.filter(x => schemeids.split(',').Contains(x.MaxSchemeID) && x.IsScheme == 'Y');
                    for (let s = 0; s < schpr.length; s++) {
                        isproductChange = false;

                        if (schemeids != "" && drschemes != null && drschemes.length > s) {
                            dradd = drschemes[s];
                            MaxSchemeID = parseInt(schemeids.split(',')[0]);
                        }
                        else {
                            dradd = this.ScreenObject.GridDataObj.NewRow();
                            dradd["IsScheme"] = "Y";
                            dr["IsScheme"] = "N";
                            dradd["MaxSchemeID"] = MaxSchemeID;
                            dr["MaxSchemeID"] = MaxSchemeID;
                            this.ScreenObject.GridDataObj.insertRowAt(dradd, this.ScreenObject.GridData.indexOf(dr) + 1);
                            this.schRowsCnt++;
                            this.ScreenObject.UpdateSequence();
                        }
                        if (this.ScreenObject.Preferences.ContainsKey("schemecopydata") && parseBoolean(this.ScreenObject.Preferences["schemecopydata"]))
                            this.Copyparentrow(dradd, dr);
                        if (dradd["ProductID_Key"].toString() != schpr[s]["freeProductID"].toString())
                            isproductChange = true;
                        dradd["ProductID_Key"] = schpr[s]["freeProductID"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                            dradd["ProductCode"] = schpr[s]["ProductCode"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                            dradd["ProductName"] = schpr[s]["ProductName"].toString();
                        if (!Util.IsEmpty(schpr[s]["freeQuantity"]))
                            dradd["FreeQTY"] = parseFloat(schpr[s]["freeQuantity"]);

                        if (DimCCid > 50000 && this.DtTempSchemesColumns.Contains("Dim1")) {
                            if (!Util.IsEmpty(schpr[s]["Dim1"]) && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (DimCCid - 50000))) {
                                dradd["dcCCNID" + (DimCCid - 50000)] = schpr[s]["Name"].toString();
                                dradd["dcCCNID" + (DimCCid - 50000) + "_Key"] = schpr[s]["Dim1"].toString();
                            }
                        }

                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromQty");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToQty");

                        if (!Util.IsEmpty(schpr[s]["freeQuantity"]) && parseFloat(schpr[s]["freeQuantity"]) > 0) {
                            dradd["FreeQTY"] = parseFloat(schpr[s]["freeQuantity"]);
                            dradd[ValueFld] = 0;
                        }
                        else if (!Util.IsEmpty(drow["freeValue"]) && parseFloat(schpr[s]["freeValue"]) > 0) {
                            dradd[ValueFld] = parseFloat(schpr[s]["freeValue"]) * -1;
                            dradd["FreeQTY"] = 0;
                        }
                        else if (!Util.IsEmpty(schpr[s]["freePercentage"]) && parseFloat(schpr[s]["freePercentage"]) > 0) {
                            if (!Util.IsEmpty(schpr[s]["FreeQtyPercent"]) && parseBoolean(schpr[s]["FreeQtyPercent"])) {
                                let toadd = (Qty / 100) * parseFloat(schpr[s]["freePercentage"]);
                                dradd["FreeQTY"] = toadd;
                                dradd[ValueFld] = 0;
                            }
                            else if (!Util.IsEmpty(dr[GrossFld])) {
                                let toadd = (grs / 100) * parseFloat(schpr[s]["freePercentage"]);
                                dradd[ValueFld] = toadd * -1;
                                dradd["FreeQTY"] = 0;
                            }
                        }
                        if (!Util.IsEmpty(schpr[s]["ProductTypeID"]))
                            dradd["Type"] = parseFloat(schpr[s]["ProductTypeID"]);
                        if (isproductChange)
                            this.FillProductValues(dradd);
                        //else

                        dradd["SchemeID"] = schpr[s]["SchemeID"].toString();
                        if (!Util.IsEmpty(dradd["FreeQTY"]) && parseFloat(dradd["FreeQTY"]) > 0) {
                            if (!Util.IsEmpty(dradd["UOMConversion"]))
                                dradd["UOMConvertedQty"] = parseFloat(dradd["FreeQTY"]) * parseFloat(dradd["UOMConversion"]);
                            else
                                dradd["UOMConvertedQty"] = dradd["FreeQTY"].toString();
                        }
                        this.CalculateTotals(dradd, false);
                    }
                    if (drschemes != null)
                        for (let j = schpr.length; j < drschemes.length; j++) {
                            this.ScreenObject.GridDataObj.removeRow(drschemes[j]);
                        }

                }
                else {
                    let dradd = null;
                    if (schemeids != "" && this.ScreenObject.GridData.filter(x => x.MaxSchemeID && schemeids.split(',').Contains(x.MaxSchemeID.toString()) && x.IsScheme == 'Y').length > 0) {
                        let drschemes = this.ScreenObject.GridData.filter(x => x.MaxSchemeID && schemeids.split(',').Contains(x.MaxSchemeID.toString()) && x.IsScheme == 'Y');
                        dradd = drschemes[0];
                        MaxSchemeID = parseInt(drschemes[0]["MaxSchemeID"]);
                        for (let j = 1; j < drschemes.length; j++) {
                            this.ScreenObject.GridDataObj.removeRow(drschemes[j]);
                        }
                    }
                    else {
                        if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                            && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                            dradd = this.ScreenObject.GridDataObj.NewRow();
                            let templink = this.ScreenObject.GridData.Compute("max", "MaxSchemeID");
                            if (templink != null)
                                MaxSchemeID = Util.Int(templink);
                            MaxSchemeID++;
                            dradd["IsScheme"] = "Y";
                            dr["IsScheme"] = "N";
                            dradd["MaxSchemeID"] = MaxSchemeID;
                            dr["MaxSchemeID"] = MaxSchemeID;

                            this.ScreenObject.GridDataObj.insertRowAt(dradd, this.ScreenObject.GridData.indexOf(dr) + 1);
                            this.schRowsCnt++;
                            this.ScreenObject.UpdateSequence();
                        }
                    }
                    if (this.ScreenObject.Preferences.ContainsKey("schemecopydata") && parseBoolean(this.ScreenObject.Preferences["schemecopydata"]))
                        this.Copyparentrow(dradd, dr);
                    if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                        && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                        dradd["ProductID_Key"] = dr["ProductID_Key"].toString();

                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                            dradd["ProductCode"] = dr["ProductCode"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                            dradd["ProductName"] = dr["ProductName"].toString();

                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromQty");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToQty");
                    }

                    if (!Util.IsEmpty(drow["Quantity"]) && parseFloat(drow["Quantity"]) > 0) {
                        dradd["FreeQTY"] = parseFloat(drow["Quantity"]);
                        dradd[ValueFld] = 0;
                    }
                    else if (!Util.IsEmpty(drow["Value"]) && parseFloat(drow["Value"]) > 0) {
                        dradd[ValueFld] = parseFloat(drow["Value"]) * -1;
                        dradd["FreeQTY"] = 0;
                    }
                    else if (!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0) {
                        if (!Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2) {
                            dr[ValueFld] = drow["Percentage"].toString();
                            dr["SchemeID"] = "-1";

                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromQty");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToQty");

                            drprrows.forEach(item => {
                                if (item != dr)
                                    item[ValueFld] = 0;
                            });
                        }
                        else if (!Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 1) {
                            let toadd = (Qty / 100) * parseFloat(drow["Percentage"]);
                            dradd["FreeQTY"] = toadd;
                            dradd[ValueFld] = 0;
                        }
                        else if (!Util.IsEmpty(dr[GrossFld])) {
                            let toadd = (grs / 100) * parseFloat(drow["Percentage"]);
                            dradd[ValueFld] = toadd * -1;
                            dradd["FreeQTY"] = 0;
                        }
                    }

                    if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                        && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                        dradd["Type"] = Util.String(dr["Type"]);
                        dradd["SchemeID"] = drow["SchemeID"].toString();
                        if (isproductChange)
                            this.FillProductValues(dradd);
                        //else

                        if (!Util.IsEmpty(dradd["FreeQTY"]) && parseFloat(dradd["FreeQTY"]) > 0) {
                            if (!Util.IsEmpty(dradd["UOMConversion"]))
                                dradd["UOMConvertedQty"] = parseFloat(dradd["FreeQTY"]) * parseFloat(dradd["UOMConversion"]);
                            else
                                dradd["UOMConvertedQty"] = dradd["FreeQTY"].toString();
                        }
                        this.CalculateTotals(dradd, false);

                    }
                }
            }
            else if (parseFloat(drow["ToQty"]) == parseFloat(drow["FromQty"])) {
                //schemeapplied = true;
                let qtydbl = 0;
                if (!Util.IsEmpty(drow["freeProductID"]) && parseInt(drow["freeProductID"]) > 0) {
                    let templink = this.ScreenObject.GridData.Compute("max", "MaxSchemeID");
                    if (templink != null)
                        MaxSchemeID = Util.Int(templink);
                    MaxSchemeID++;

                    let dradd = null;
                    let schpr = this.DtTempSchemes.filter(x => x.SchemeID == drow["SchemeID"]);
                    let drschemes = null;
                    if (schemeids != "")
                        drschemes = this.ScreenObject.GridData.filter(x => schemeids.split(',').Contains(x.MaxSchemeID) && x.IsScheme == 'Y');
                    for (let s = 0; s < schpr.length; s++) {
                        isproductChange = false;

                        if (schemeids != "" && drschemes != null && drschemes.length > s) {
                            dradd = drschemes[s];
                            MaxSchemeID = parseInt(schemeids.split(',')[0]);
                        }
                        else {
                            dradd = this.ScreenObject.GridDataObj.NewRow();
                            dradd["IsScheme"] = "Y";
                            dr["IsScheme"] = "N";
                            dradd["MaxSchemeID"] = MaxSchemeID;
                            dr["MaxSchemeID"] = MaxSchemeID;
                            this.ScreenObject.GridDataObj.insertRowAt(dradd, this.ScreenObject.GridData.indexOf(dr) + 1);
                            this.schRowsCnt++;
                            this.ScreenObject.UpdateSequence();
                        }
                        if (this.ScreenObject.Preferences.ContainsKey("schemecopydata") && parseBoolean(this.ScreenObject.Preferences["schemecopydata"]))
                            this.Copyparentrow(dradd, dr);
                        if (dradd["ProductID_Key"].toString() != schpr[s]["freeProductID"].toString())
                            isproductChange = true;
                        dradd["ProductID_Key"] = schpr[s]["freeProductID"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                            dradd["ProductCode"] = schpr[s]["ProductCode"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                            dradd["ProductName"] = schpr[s]["ProductName"].toString();
                        if (!Util.IsEmpty(schpr[s]["ProductTypeID"]))
                            dradd["Type"] = parseFloat(schpr[s]["ProductTypeID"]);

                        if (!Util.IsEmpty(schpr[s]["freeQuantity"]) && parseFloat(schpr[s]["freeQuantity"]) > 0) {
                            qtydbl = parseFloat(schpr[s]["freeQuantity"]);
                            let toadd = Qty / parseFloat(schpr[s]["FromQty"]);
                            dradd["FreeQTY"] = Math.floor(toadd) * qtydbl;
                            dradd[ValueFld] = 0;
                        }
                        else if (!Util.IsEmpty(drow["freeValue"]) && parseFloat(schpr[s]["freeValue"]) > 0) {
                            qtydbl = parseFloat(schpr[s]["freeValue"]);
                            let toadd = Qty / parseFloat(schpr[s]["FromQty"]);
                            dradd[ValueFld] = Math.floor(toadd) * qtydbl * -1;
                            dradd["FreeQTY"] = 0;
                        }
                        else if (!Util.IsEmpty(schpr[s]["freePercentage"]) && parseFloat(schpr[s]["freePercentage"]) > 0) {
                            if (!Util.IsEmpty(schpr[s]["FreeQtyPercent"]) && parseBoolean(schpr[s]["FreeQtyPercent"])) {
                                qtydbl = parseFloat(schpr[s]["freePercentage"]);
                                let toadd = Qty / parseFloat(schpr[s]["FromQty"]);

                                toadd = (Qty / 100) * Math.floor(toadd);
                                dradd["FreeQTY"] = toadd * qtydbl;
                                dradd[ValueFld] = 0;
                            }
                            else if (!Util.IsEmpty(dr[GrossFld])) {
                                qtydbl = parseFloat(schpr[s]["freePercentage"]);
                                let toadd = Qty / parseFloat(schpr[s]["FromQty"]);

                                toadd = (grs / 100) * Math.floor(toadd);
                                dradd[ValueFld] = toadd * qtydbl * -1;
                                dradd["FreeQTY"] = 0;
                            }
                        }

                        if (DimCCid > 50000 && this.DtTempSchemesColumns.Contains("Dim1")) {
                            if (!Util.IsEmpty(schpr[s]["Dim1"]) && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (DimCCid - 50000))) {
                                dradd["dcCCNID" + (DimCCid - 50000)] = schpr[s]["Name"].toString();
                                dradd["dcCCNID" + (DimCCid - 50000) + "_Key"] = schpr[s]["Dim1"].toString();
                            }
                        }

                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromQty");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToQty");

                        dradd["SchemeID"] = schpr[s]["SchemeID"].toString();
                        if (isproductChange)
                            this.FillProductValues(dradd);
                        //else

                        if (!Util.IsEmpty(dradd["FreeQTY"]) && parseFloat(dradd["FreeQTY"]) > 0) {
                            if (!Util.IsEmpty(dradd["UOMConversion"]))
                                dradd["UOMConvertedQty"] = parseFloat(dradd["FreeQTY"]) * parseFloat(dradd["UOMConversion"]);
                            else
                                dradd["UOMConvertedQty"] = dradd["FreeQTY"].toString();
                        }
                        this.CalculateTotals(dradd, false);
                    }
                    if (drschemes != null)
                        for (let j = schpr.length; j < drschemes.length; j++) {
                            this.ScreenObject.GridDataObj.removeRow(drschemes[j]);
                        }
                }
                else {
                    let dradd = null;
                    if (schemeids != "" && this.ScreenObject.GridData.filter(x => x.MaxSchemeID && schemeids.split(',').Contains(x.MaxSchemeID.toString()) && x.IsScheme == 'Y').length > 0) {
                        let drschemes = this.ScreenObject.GridData.filter(x => x.MaxSchemeID && schemeids.split(',').Contains(x.MaxSchemeID.toString()) && x.IsScheme == 'Y');
                        dradd = drschemes[0];
                        MaxSchemeID = parseInt(drschemes[0]["MaxSchemeID"]);
                        for (let j = 1; j < drschemes.length; j++) {
                            this.ScreenObject.GridDataObj.removeRow(drschemes[j]);
                        }
                    }
                    else {
                        if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                            && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                            dradd = this.ScreenObject.GridDataObj.NewRow();
                            let templink = this.ScreenObject.GridData.Compute("max", "MaxSchemeID");
                            if (templink != null)
                                MaxSchemeID = Util.Int(templink);
                            MaxSchemeID++;
                            dradd["IsScheme"] = "Y";
                            dr["IsScheme"] = "N";
                            dradd["MaxSchemeID"] = MaxSchemeID;
                            dr["MaxSchemeID"] = MaxSchemeID;
                            this.ScreenObject.GridDataObj.insertRowAt(dradd, this.ScreenObject.GridData.indexOf(dr) + 1);
                            this.schRowsCnt++;
                            this.ScreenObject.UpdateSequence();
                        }
                    }
                    if (this.ScreenObject.Preferences.ContainsKey("schemecopydata") && parseBoolean(this.ScreenObject.Preferences["schemecopydata"]))
                        this.Copyparentrow(dradd, dr);
                    if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                        && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                        if (Util.String(dradd["ProductID_Key"]) != dr["ProductID_Key"].toString())
                            isproductChange = true;
                        dradd["ProductID_Key"] = dr["ProductID_Key"].toString();

                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                            dradd["ProductCode"] = dr["ProductCode"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                            dradd["ProductName"] = dr["ProductName"].toString();
                        dradd["Type"] = Util.String(dr["Type"]);
                    }

                    if (!Util.IsEmpty(drow["Quantity"]) && parseFloat(drow["Quantity"]) > 0) {
                        qtydbl = parseFloat(drow["Quantity"]);
                        let toadd = Qty / parseFloat(drow["FromQty"]);
                        dradd["FreeQTY"] = Math.floor(toadd) * qtydbl;
                    }
                    else if (!Util.IsEmpty(drow["Value"]) && parseFloat(drow["Value"]) > 0) {
                        qtydbl = parseFloat(drow["Value"]);
                        let toadd = Qty / parseFloat(drow["FromQty"]);
                        dradd[ValueFld] = Math.floor(toadd) * qtydbl * -1;
                        dradd["FreeQTY"] = 0;
                    }
                    else if (!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0) {
                        if (!Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2) {
                            if (this.IsPOs) {
                                qtydbl = Qty / parseFloat(drow["FromQty"]);
                                dr[ValueFld] = Math.floor(qtydbl) * parseFloat(drow["Percentage"]);
                            }
                            else
                                dr[ValueFld] = drow["Percentage"].toString();
                            dr["SchemeID"] = "-1";

                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromQty");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToQty");

                            drprrows.forEach(item => {
                                if (item != dr)
                                    item[ValueFld] = 0;
                            });
                        }
                        else if (!Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 1) {
                            qtydbl = parseFloat(drow["Percentage"]);
                            let toadd = Qty / parseFloat(drow["FromQty"]);

                            toadd = (Qty / 100) * Math.floor(toadd);
                            dradd["FreeQTY"] = toadd * qtydbl;
                            dradd[ValueFld] = 0;
                        }
                        else if (!Util.IsEmpty(dr[GrossFld])) {
                            qtydbl = parseFloat(drow["Percentage"]);
                            let toadd = Qty / parseFloat(drow["FromQty"]);

                            toadd = (grs / 100) * Math.floor(toadd);
                            dradd[ValueFld] = toadd * qtydbl * -1;
                            dradd["FreeQTY"] = 0;
                        }
                    }

                    if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                        && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromQty");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToQty");

                        dradd["SchemeID"] = drow["SchemeID"].toString();
                        if (isproductChange)
                            this.FillProductValues(dradd);
                        //else

                        if (!Util.IsEmpty(dradd["FreeQTY"]) && parseFloat(dradd["FreeQTY"]) > 0) {
                            if (!Util.IsEmpty(dradd["UOMConversion"]))
                                dradd["UOMConvertedQty"] = parseFloat(dradd["FreeQTY"]) * parseFloat(dradd["UOMConversion"]);
                            else
                                dradd["UOMConvertedQty"] = dradd["FreeQTY"].toString();
                        }
                        this.CalculateTotals(dradd, false);
                    }
                }
            }

        }
        else if (parseFloat(drow["FromValue"]) > 0) {
            if (parseFloat(drow["ToValue"]) != parseFloat(drow["FromValue"])) {
                if (!Util.IsEmpty(drow["freeProductID"]) && parseInt(drow["freeProductID"]) > 0) {
                    let templink = this.ScreenObject.GridData.Compute("max", "MaxSchemeID");
                    if (templink != null)
                        MaxSchemeID = Util.Int(templink);
                    MaxSchemeID++;

                    let dradd = null;
                    let schpr = this.DtTempSchemes.filter(x => x.SchemeID == drow["SchemeID"]);
                    let drschemes = null;
                    if (schemeids != "")
                        drschemes = this.ScreenObject.GridData.filter(x => schemeids.split(',').Contains(x.MaxSchemeID) && x.IsScheme == 'Y');
                    for (let s = 0; s < schpr.length; s++) {
                        isproductChange = false;

                        if (schemeids != "" && drschemes != null && drschemes.length > s) {
                            dradd = drschemes[s];
                            MaxSchemeID = parseInt(schemeids.split(',')[0]);
                        }
                        else {
                            dradd = this.ScreenObject.GridDataObj.NewRow();
                            dradd["IsScheme"] = "Y";
                            dr["IsScheme"] = "N";
                            dradd["MaxSchemeID"] = MaxSchemeID;
                            dr["MaxSchemeID"] = MaxSchemeID;
                            this.ScreenObject.GridDataObj.insertRowAt(dradd, this.ScreenObject.GridData.indexOf(dr) + 1);
                            this.schRowsCnt++;
                            this.ScreenObject.UpdateSequence();
                        }
                        if (this.ScreenObject.Preferences.ContainsKey("schemecopydata") && parseBoolean(this.ScreenObject.Preferences["schemecopydata"]))
                            this.Copyparentrow(dradd, dr);
                        if (dradd["ProductID_Key"].toString() != schpr[s]["freeProductID"].toString())
                            isproductChange = true;
                        dradd["ProductID_Key"] = schpr[s]["freeProductID"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                            dradd["ProductCode"] = schpr[s]["ProductCode"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                            dradd["ProductName"] = schpr[s]["ProductName"].toString();
                        if (!Util.IsEmpty(schpr[s]["freeQuantity"]))
                            dradd["FreeQTY"] = parseFloat(schpr[s]["freeQuantity"]);


                        if (!Util.IsEmpty(schpr[s]["freeQuantity"]) && parseFloat(schpr[s]["freeQuantity"]) > 0) {
                            dradd["FreeQTY"] = parseFloat(schpr[s]["freeQuantity"]);
                            dradd[ValueFld] = 0;
                        }
                        else if (!Util.IsEmpty(drow["freeValue"]) && parseFloat(schpr[s]["freeValue"]) > 0) {
                            dradd[ValueFld] = parseFloat(schpr[s]["freeValue"]) * -1;
                            dradd["FreeQTY"] = 0;
                        }
                        else if (!Util.IsEmpty(schpr[s]["freePercentage"]) && parseFloat(schpr[s]["freePercentage"]) > 0) {
                            if (!Util.IsEmpty(dr[GrossFld])) {
                                let toadd = (grs / 100) * parseFloat(schpr[s]["freePercentage"]);
                                dradd[ValueFld] = toadd * -1;
                                dradd["FreeQTY"] = 0;
                            }
                        }
                        if (!Util.IsEmpty(schpr[s]["ProductTypeID"]))
                            dradd["Type"] = parseFloat(schpr[s]["ProductTypeID"]);

                        if (DimCCid > 50000 && this.DtTempSchemesColumns.Contains("Dim1")) {
                            if (!Util.IsEmpty(schpr[s]["Dim1"]) && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (DimCCid - 50000))) {
                                dradd["dcCCNID" + (DimCCid - 50000)] = schpr[s]["Name"].toString();
                                dradd["dcCCNID" + (DimCCid - 50000) + "_Key"] = schpr[s]["Dim1"].toString();
                            }
                        }

                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromValue");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToValue");

                        dradd["SchemeID"] = schpr[s]["SchemeID"].toString();
                        if (isproductChange)
                            this.FillProductValues(dradd);
                        else
                            this.CalculateTotals(dradd, false);
                    }
                    if (drschemes != null)
                        for (let j = schpr.length; j < drschemes.length; j++) {
                            this.ScreenObject.GridDataObj.removeRow(drschemes[j]);
                        }
                }
                else {
                    let dradd = null;
                    if (schemeids != "" && this.ScreenObject.GridData.filter(x => x.MaxSchemeID && schemeids.split(',').Contains(x.MaxSchemeID.toString()) && x.IsScheme == 'Y').length > 0) {
                        let drschemes = this.ScreenObject.GridData.filter(x => x.MaxSchemeID && schemeids.split(',').Contains(x.MaxSchemeID.toString()) && x.IsScheme == 'Y');
                        dradd = drschemes[0];
                        MaxSchemeID = parseInt(drschemes[0]["MaxSchemeID"]);
                        for (let j = 1; j < drschemes.length; j++) {
                            this.ScreenObject.GridDataObj.removeRow(drschemes[j]);
                        }
                    }
                    else {
                        if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                            && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                            dradd = this.ScreenObject.GridDataObj.NewRow();
                            let templink = this.ScreenObject.GridData.Compute("max", "MaxSchemeID");
                            if (templink != null)
                                MaxSchemeID = Util.Int(templink);
                            MaxSchemeID++;
                            dradd["IsScheme"] = "Y";
                            dr["IsScheme"] = "N";
                            dradd["MaxSchemeID"] = MaxSchemeID;
                            dr["MaxSchemeID"] = MaxSchemeID;
                            this.ScreenObject.GridDataObj.insertRowAt(dradd, this.ScreenObject.GridData.indexOf(dr) + 1);
                            this.schRowsCnt++;
                            this.ScreenObject.UpdateSequence();
                        }
                    }
                    if (this.ScreenObject.Preferences.ContainsKey("schemecopydata") && parseBoolean(this.ScreenObject.Preferences["schemecopydata"]))
                        this.Copyparentrow(dradd, dr);
                    if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                        && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                        if (Util.String(dradd["ProductID_Key"]) != dr["ProductID_Key"].toString())
                            isproductChange = true;
                        dradd["ProductID_Key"] = dr["ProductID_Key"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                            dradd["ProductCode"] = dr["ProductCode"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                            dradd["ProductName"] = dr["ProductName"].toString();
                        if (!Util.IsEmpty(drow["Quantity"]))
                            dradd["FreeQTY"] = parseFloat(drow["Quantity"]);
                    }

                    if (!Util.IsEmpty(drow["Quantity"]) && parseFloat(drow["Quantity"]) > 0) {
                        dradd["FreeQTY"] = parseFloat(drow["Quantity"]);
                        dradd[ValueFld] = 0;
                    }
                    else if (!Util.IsEmpty(drow["Value"]) && parseFloat(drow["Value"]) > 0) {
                        dradd[ValueFld] = parseFloat(drow["Value"]) * -1;
                        dradd["FreeQTY"] = 0;
                    }
                    else if (!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0) {
                        if (!Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2) {
                            dr[ValueFld] = drow["Percentage"].toString();
                            dr["SchemeID"] = "-1";

                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromValue");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToValue");

                            drprrows.forEach(item => {
                                if (item != dr)
                                    item[ValueFld] = 0;
                            });
                        }
                        else if (!Util.IsEmpty(dr[GrossFld])) {
                            let toadd = (grs / 100) * parseFloat(drow["Percentage"]);
                            dradd[ValueFld] = toadd * -1;
                            dradd["FreeQTY"] = 0;
                        }
                    }

                    if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                        && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                        dradd["Type"] = Util.String(dr["Type"]);

                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromValue");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToValue");

                        dradd["SchemeID"] = drow["SchemeID"].toString();
                        if (isproductChange)
                            this.FillProductValues(dradd);
                        else
                            this.CalculateTotals(dradd, false);
                    }
                }
            }
            else if (parseFloat(drow["ToValue"]) == parseFloat(drow["FromValue"])) {
                //schemeapplied = true;
                let qtydbl = 0;
                if (!Util.IsEmpty(drow["freeProductID"]) && parseInt(drow["freeProductID"]) > 0) {
                    let templink = this.ScreenObject.GridData.Compute("max", "MaxSchemeID");
                    if (templink != null)
                        MaxSchemeID = Util.Int(templink);
                    MaxSchemeID++;

                    let dradd = null;
                    let schpr = this.DtTempSchemes.filter(x => x.SchemeID == drow["SchemeID"]);
                    let drschemes = null;
                    if (schemeids != "")
                        drschemes = this.ScreenObject.GridData.filter(x => schemeids.split(',').Contains(x.MaxSchemeID) && x.IsScheme == 'Y');
                    for (let s = 0; s < schpr.length; s++) {
                        isproductChange = false;

                        if (schemeids != "" && drschemes != null && drschemes.length > s) {
                            dradd = drschemes[s];
                            MaxSchemeID = parseInt(schemeids.split(',')[0]);
                        }
                        else {
                            dradd = this.ScreenObject.GridDataObj.NewRow();
                            dradd["IsScheme"] = "Y";
                            dr["IsScheme"] = "N";
                            dradd["MaxSchemeID"] = MaxSchemeID;
                            dr["MaxSchemeID"] = MaxSchemeID;
                            this.ScreenObject.GridDataObj.insertRowAt(dradd, this.ScreenObject.GridData.indexOf(dr) + 1);
                            this.schRowsCnt++;
                            this.ScreenObject.UpdateSequence();
                        }
                        if (this.ScreenObject.Preferences.ContainsKey("schemecopydata") && parseBoolean(this.ScreenObject.Preferences["schemecopydata"]))
                            this.Copyparentrow(dradd, dr);
                        if (dradd["ProductID_Key"].toString() != schpr[s]["freeProductID"].toString())
                            isproductChange = true;
                        dradd["ProductID_Key"] = schpr[s]["freeProductID"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                            dradd["ProductCode"] = schpr[s]["ProductCode"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                            dradd["ProductName"] = schpr[s]["ProductName"].toString();
                        if (!Util.IsEmpty(schpr[s]["ProductTypeID"]))
                            dradd["Type"] = parseFloat(schpr[s]["ProductTypeID"]);

                        if (!Util.IsEmpty(schpr[s]["freeQuantity"]) && parseFloat(schpr[s]["freeQuantity"]) > 0) {
                            qtydbl = parseFloat(schpr[s]["freeQuantity"]);
                            let toadd = grs / parseFloat(schpr[s]["FromValue"]);
                            dradd["FreeQTY"] = Math.floor(toadd) * qtydbl;
                            dradd[ValueFld] = 0;
                        }
                        else if (!Util.IsEmpty(drow["freeValue"]) && parseFloat(schpr[s]["freeValue"]) > 0) {
                            qtydbl = parseFloat(schpr[s]["freeValue"]);
                            let toadd = grs / parseFloat(schpr[s]["FromValue"]);
                            dradd[ValueFld] = Math.floor(toadd) * qtydbl * -1;
                            dradd["FreeQTY"] = 0;
                        }
                        else if (!Util.IsEmpty(schpr[s]["freePercentage"]) && parseFloat(schpr[s]["freePercentage"]) > 0) {
                            if (!Util.IsEmpty(dr[GrossFld])) {
                                qtydbl = parseFloat(schpr[s]["freePercentage"]);
                                let toadd = grs / parseFloat(schpr[s]["FromValue"]);

                                toadd = (grs / 100) * Math.floor(toadd);
                                dradd[ValueFld] = toadd * qtydbl * -1;
                                dradd["FreeQTY"] = 0;
                            }
                        }

                        if (DimCCid > 50000 && this.DtTempSchemesColumns.Contains("Dim1")) {
                            if (!Util.IsEmpty(schpr[s]["Dim1"]) && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (DimCCid - 50000))) {
                                dradd["dcCCNID" + (DimCCid - 50000)] = schpr[s]["Name"].toString();
                                dradd["dcCCNID" + (DimCCid - 50000) + "_Key"] = schpr[s]["Dim1"].toString();
                            }
                        }

                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromValue");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToValue");

                        dradd["SchemeID"] = schpr[s]["SchemeID"].toString();
                        if (isproductChange)
                            this.FillProductValues(dradd);
                        else
                            this.CalculateTotals(dradd, false);
                    }
                    if (drschemes != null)
                        for (let j = schpr.length; j < drschemes.length; j++) {
                            this.ScreenObject.GridDataObj.removeRow(drschemes[j]);
                        }
                }
                else {
                    let dradd = null;
                    if (schemeids != "" && this.ScreenObject.GridData.filter(x => x.MaxSchemeID == dr["MaxSchemeID"] && x.IsScheme == 'Y').length > 0) {
                        let drschemes = this.ScreenObject.GridData.filter(x => schemeids.split(',').Contains(x.MaxSchemeID) && x.IsScheme == 'Y');
                        dradd = drschemes[0];
                        MaxSchemeID = parseInt(drschemes[0]["MaxSchemeID"]);
                        for (let j = 1; j < drschemes.length; j++) {
                            this.ScreenObject.GridDataObj.removeRow(drschemes[j]);
                        }
                    }
                    else {
                        if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                            && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                            dradd = this.ScreenObject.GridDataObj.NewRow();
                            let templink = this.ScreenObject.GridData.Compute("max", "MaxSchemeID");
                            if (templink != null)
                                MaxSchemeID = Util.Int(templink);
                            MaxSchemeID++;
                            dradd["IsScheme"] = "Y";
                            dr["IsScheme"] = "N";
                            dradd["MaxSchemeID"] = MaxSchemeID;
                            dr["MaxSchemeID"] = MaxSchemeID;
                            this.ScreenObject.GridDataObj.insertRowAt(dradd, this.ScreenObject.GridData.indexOf(dr) + 1);
                            this.schRowsCnt++;
                            this.ScreenObject.UpdateSequence();
                        }
                    }
                    if (this.ScreenObject.Preferences.ContainsKey("schemecopydata") && parseBoolean(this.ScreenObject.Preferences["schemecopydata"]))
                        this.Copyparentrow(dradd, dr);
                    if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                        && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                        if (Util.String(dradd["ProductID_Key"]) != dr["ProductID_Key"].toString())
                            isproductChange = true;
                        dradd["ProductID_Key"] = dr["ProductID_Key"].toString();

                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                            dradd["ProductCode"] = dr["ProductCode"].toString();
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                            dradd["ProductName"] = dr["ProductName"].toString();
                        dradd["Type"] = Util.String(dr["Type"]);
                    }

                    if (!Util.IsEmpty(drow["Quantity"]) && parseFloat(drow["Quantity"]) > 0) {
                        qtydbl = parseFloat(drow["Quantity"]);
                        let toadd = grs / parseFloat(drow["FromValue"]);
                        dradd["FreeQTY"] = Math.floor(toadd) * qtydbl;
                    }
                    else if (!Util.IsEmpty(drow["Value"]) && parseFloat(drow["Value"]) > 0) {
                        qtydbl = parseFloat(drow["Value"]);
                        let toadd = grs / parseFloat(drow["FromValue"]);
                        dradd[ValueFld] = Math.floor(toadd) * qtydbl * -1;
                        dradd["FreeQTY"] = 0;
                    }
                    else if (!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0) {
                        if (!Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2) {
                            if (this.IsPOs) {
                                qtydbl = grs / parseFloat(drow["FromValue"]);
                                dr[ValueFld] = Math.floor(qtydbl) * parseFloat(drow["Percentage"]);
                            }
                            else
                                dr[ValueFld] = drow["Percentage"].toString();
                            dr["SchemeID"] = "-1";

                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromValue");
                            this.FillDatarowNN(dr, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToValue");

                            drprrows.forEach(item => {
                                if (item != dr)
                                    item[ValueFld] = 0;
                            });
                        }
                        else if (!Util.IsEmpty(dr[GrossFld])) {
                            qtydbl = parseFloat(drow["Percentage"]);
                            let toadd = grs / parseFloat(drow["FromValue"]);

                            toadd = (grs / 100) * Math.floor(toadd);
                            dradd[ValueFld] = toadd * qtydbl * -1;
                            dradd["FreeQTY"] = 0;
                        }
                    }

                    if (!(!Util.IsEmpty(drow["Percentage"]) && parseFloat(drow["Percentage"]) > 0
                        && !Util.IsEmpty(drow["IsQtyPercent"]) && parseInt(drow["IsQtyPercent"]) == 2)) {
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55850 }, "FromValue");
                        this.FillDatarowNN(dradd, null, drow, { LocalReference: 79, LinkData: 55851 }, "ToValue");

                        dradd["SchemeID"] = drow["SchemeID"].toString();

                        if (isproductChange)
                            this.FillProductValues(dradd);
                        else
                            this.CalculateTotals(dradd, false);
                    }
                }

            }

        }

        drprrows.forEach(item => {
            if (MaxSchemeID > 0) {
                item["IsScheme"] = "N";
                item["MaxSchemeID"] = MaxSchemeID;
                item["SchemeID"] = drow["SchemeID"].toString();
            }

            this.FillDatarowNN(item, null, drow, { LocalReference: 79, LinkData: 53734 }, "ProfileName");
            this.FillDatarowNN(item, null, drow, { LocalReference: 79, LinkData: 55480 }, "FromDate");
            this.FillDatarowNN(item, null, drow, { LocalReference: 79, LinkData: 55483 }, "ToDate");
        });
    }
    AddLinkProducts(dtlink: any[], index: number) {
        let ind = index;
        let maxlinkid = 0;
        let templink = this.ScreenObject.GridData.Compute("max", "LinkID");
        if (templink != null)
            maxlinkid = Util.Int(templink);
        maxlinkid++;
        this.ScreenObject.GridData[ind - 1]["LinkID"] = maxlinkid;
        this.ScreenObject.GridData[ind - 1]["LinkType"] = 0;

        let optionalCount = 0;
        for (let i = 0; i < dtlink.length; i++) {
            if (!Util.IsEmpty(dtlink[i]["LinkType"]) && parseInt(dtlink[i]["LinkType"]) == 2) {
                let drGrid = this.ScreenObject.GridDataObj.NewRow();
                drGrid["LinkID"] = maxlinkid;
                drGrid["ProductID_Key"] = dtlink[i]["ProductID"].toString();
                drGrid["Quantity"] = "1";
                this.ScreenObject.GridData.InsertAt(drGrid, ind);
                this.AddProductData(drGrid, true, false);
                this.CalculateTotals(drGrid, false);
                drGrid["LinkType"] = 2;
                ind++;
            }
            else if (!Util.IsEmpty(dtlink[i]["LinkType"]) && parseInt(dtlink[i]["LinkType"]) == 1)
                optionalCount++;
        }
        if (optionalCount > 0 && BaseService.page.DialogCount == 0) {
            BaseService.page.ShowDialog(new LinkedProductsViewModel(this, dtlink, maxlinkid, index), LinkedProductsComponent, { ShowCenter: true, HideClose: true, Title: "Optinal Linked Products" });
        }

        this.ScreenObject.UpdateSequence();
    }
    FillDatarow(dr: any, dt: any[], PriceDr: any, objFilter: any, ColName: string, Conv: number = -1) {
        let dvCnt: any;
        if (objFilter.LocalReference)
            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference == objFilter.LocalReference && x.LinkData == objFilter.LinkData);
        else
            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LinkData == objFilter.LinkData);
        if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
            if (PriceDr != null && !Util.IsEmpty(PriceDr[ColName]) && parseFloat(PriceDr[ColName]) != 0) {
                if (Conv == -1 || (this.ScreenObject.PriceTaxcc.ContainsKey(11) && this.ScreenObject.PriceTaxcc[11].Contains('p')))
                    dr[dvCnt[0]["SysColumnName"]] = PriceDr[ColName].toString();
                else
                    dr[dvCnt[0]["SysColumnName"]] = parseFloat(PriceDr[ColName]) * Conv;
            }
            else if (dt.length > 0 && !Util.IsEmpty(dt[0][ColName]))
                dr[dvCnt[0]["SysColumnName"]] = dt[0][ColName].toString();
            else
                dr[dvCnt[0]["SysColumnName"]] = 0;
        }
    }

    FillDatarowNN(dr: any, dt: any[], srcrow: any, objFilter: any, ColName: string) {
        let dvCnt: any;
        if (objFilter.LocalReference)
            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference == objFilter.LocalReference && x.LinkData == objFilter.LinkData);
        else
            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LinkData == objFilter.LinkData);
        if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
            if ((dvCnt[0]["ColumnDataType"].toString().toUpperCase() == "DATE" || dvCnt[0]["UserColumnType"].toString().toUpperCase() == "DATE") && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"] + "_Key")) {
                let dttmp: Date;
                if (srcrow != null && Util.isValidDate(srcrow[ColName])) {
                    dr[dvCnt[0]["SysColumnName"] + "_Key"] = Util.ParseDate(srcrow[ColName]);
                    dr[dvCnt[0]["SysColumnName"]] = Util.ParseDate(srcrow[ColName]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                }
                else if (dt != null && !Util.IsEmpty(dt[0][ColName]) && Util.isValidDate(dt[0][ColName])) {
                    dr[dvCnt[0]["SysColumnName"] + "_Key"] = Util.ParseDate(dt[0][ColName]);
                    dr[dvCnt[0]["SysColumnName"]] = Util.ParseDate(dt[0][ColName]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                }
                else {
                    dr[dvCnt[0]["SysColumnName"]] = null;
                    dr[dvCnt[0]["SysColumnName"] + "_Key"] = null;
                }
            }
            else {
                if (srcrow != null && !Util.IsEmpty(srcrow[ColName]))
                    dr[dvCnt[0]["SysColumnName"]] = srcrow[ColName].toString();
                else if (dt != null && !Util.IsEmpty(dt[0][ColName]))
                    dr[dvCnt[0]["SysColumnName"]] = dt[0][ColName].toString();
                else
                    dr[dvCnt[0]["SysColumnName"]] = null;
            }
        }
    }

    FillCreatedByDate(Sender: string) {
        if (this.ScreenObject.Data.Tables.length == 0)
            return;

        if (this.ScreenObject.IsDocEdit) {
            if (Sender == "Revise") {
                let dr = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 55488);
                if (dr.length > 0) {
                    if (this.ScreenObject.GridDataColumns.Contains(dr[0]["SysColumnName"])) {
                        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                            if ((this.IsInventoryVoucher && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]))
                                || (!this.IsInventoryVoucher && ((this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"]))
                                    || (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                                    || (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                                ))) {
                                if (dr[0]["UserColumnType"].toString() == "Date") {
                                    this.ScreenObject.GridData[i][dr[0]["SysColumnName"]] = new Date().ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                    this.ScreenObject.GridData[i][dr[0]["SysColumnName"] + "_Key"] = new Date();
                                }
                                else if (dr[0]["UserColumnType"].toString() == "DateTime") {
                                    this.ScreenObject.GridData[i][dr[0]["SysColumnName"]] = new Date().ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");
                                    this.ScreenObject.GridData[i][dr[0]["SysColumnName"] + "_Key"] = new Date();
                                }
                                else if (dr[0]["UserColumnType"].toString() == "Time") {
                                    this.ScreenObject.GridData[i][dr[0]["SysColumnName"]] = new Date().ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                                    this.ScreenObject.GridData[i][dr[0]["SysColumnName"] + "_Key"] = new Date();
                                }
                                else
                                    this.ScreenObject.GridData[i][dr[0]["SysColumnName"]] = new Date().ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            }
                        }
                    }
                    else {
                        let Cb = this.ScreenObject._TextFields.find(a => a.DBColumnName == dr[0]["SysColumnName"]);
                        if (Cb) {
                            if (Cb instanceof PactTextBoxData)
                                Cb.Text = new Date().ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            else if (Cb instanceof PactExtraFieldDateData)
                                Cb.Date = new Date();
                            if (Cb instanceof PactDateTimeData)
                                Cb.Date = new Date();
                        }
                    }
                }
                else
                    return;
            }
        }
        let dvCnt = this.ScreenObject.Data.Tables[0];
        if (dvCnt.length > 0) {
            if (!this.ScreenObject.IsDocEdit) {
                dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 24060);
                if (dvCnt.length > 0) {
                    if (this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                            if (this.IsInventoryVoucher && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]))
                                this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = BaseService.SessionManager.UserName;
                            else if (!this.IsInventoryVoucher && ((this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"]))
                                || (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                                || (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                            ))
                                this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = BaseService.SessionManager.UserName;
                        }
                    }

                    let Cb = this.ScreenObject._TextFields.find(a => a.DBColumnName == dvCnt[0]["SysColumnName"]);
                    if (Cb && Cb instanceof PactTextBoxData)
                        Cb.Text = BaseService.SessionManager.UserName;

                }

                dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 24061);
                if (dvCnt.length > 0) {
                    let ds: any = BaseService.common.GetDataSet("DOC001", "")
                    if (ds != null && ds.Tables.length > 0 && !ds.Columns[0].Contains("ErrorMessage") && ds.Tables[0].length > 0 && !Util.IsEmpty(ds.Tables[0][0]["dt"])) {
                        if (this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                                if (this.IsInventoryVoucher && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]))
                                    this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = BaseService.SessionManager.UserName;
                                else if (!this.IsInventoryVoucher && ((this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"]))
                                    || (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                                    || (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                                )) {
                                    let c0 = ds.Columns[0][0]
                                    if (dvCnt[0]["UserColumnType"].toString() == "Date") {
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0][c0]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"] + "_Key"] = Util.ParseDate(ds.Tables[0][0][c0]);
                                    }
                                    else if (dvCnt[0]["UserColumnType"].toString() == "DateTime") {
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0][c0]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"] + "_Key"] = Util.ParseDate(ds.Tables[0][0][c0]);
                                    }
                                    else if (dvCnt[0]["UserColumnType"].toString() == "Time") {
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0][c0]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"] + "_Key"] = Util.ParseDate(ds.Tables[0][0][c0]);
                                    }
                                    else
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0][c0]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                }
                            }
                        }

                        let Cb = this.ScreenObject._TextFields.find(a => a.DBColumnName == dvCnt[0]["SysColumnName"]);
                        if (Cb) {
                            let c0 = ds.Columns[0][0]
                            if (Cb instanceof PactTextBoxData)
                                Cb.Text = Util.ParseDate(ds.Tables[0][0][c0]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            else if (Cb instanceof PactExtraFieldDateData)
                                Cb.Date = Util.ParseDate(ds.Tables[0][0][c0]);
                            if (Cb instanceof PactDateTimeData)
                                Cb.Date = Util.ParseDate(ds.Tables[0][0][c0]);
                        }
                    }
                }

                dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalCCID != null && x.LocalCCID == 7);
                if (dvCnt.length > 0) {
                    for (let j = 0; j < dvCnt.length; j++) {
                        if (this.ScreenObject.GridDataColumns.Contains(dvCnt[j]["SysColumnName"])) {
                            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                                if (this.IsInventoryVoucher && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                                    if (this.ScreenObject.Data.Tables.length > 22 && this.ScreenObject.Data.Tables[23] != null && this.ScreenObject.Data.Tables[23].length > 0) {
                                        if (dvCnt[j]["LinkData"].toString() == "22898")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["UserName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22900")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["FirstName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22901")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["MiddleName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22902")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["LastName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22903")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22904")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22905")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address3"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22906")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["City"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22907")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["State"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22908")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Zip"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22909")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Country"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22910")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Phone1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22911")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Phone2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22912")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Fax"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22913")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Email1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22914")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Email2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22915")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Website"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22916")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Description"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22917")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Role"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "53531")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Status"].toString();
                                    }
                                }
                                else if (!this.IsInventoryVoucher && ((this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"]))
                                    || (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                                    || (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                                )) {
                                    if (this.ScreenObject.Data.Tables.length > 22 && this.ScreenObject.Data.Tables[23] != null && this.ScreenObject.Data.Tables[23].length > 0) {
                                        if (dvCnt[j]["LinkData"].toString() == "22898")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["UserName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22900")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["FirstName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22901")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["MiddleName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22902")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["LastName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22903")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22904")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22905")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address3"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22906")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["City"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22907")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["State"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22908")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Zip"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22909")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Country"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22910")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Phone1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22911")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Phone2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22912")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Fax"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22913")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Email1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22914")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Email2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22915")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Website"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22916")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Description"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22917")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Role"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "53531")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Status"].toString();
                                    }
                                }
                            }
                        }

                        let Cb = this.ScreenObject._TextFields.find(a => a.DBColumnName == dvCnt[j]["SysColumnName"]);
                        if (Cb && Cb instanceof PactTextBoxData) {
                            if (this.ScreenObject.Data.Tables.length > 22 && this.ScreenObject.Data.Tables[23] != null && this.ScreenObject.Data.Tables[23].length > 0) {
                                if (dvCnt[j]["LinkData"].toString() == "22898")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["UserName"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22900")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["FirstName"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22901")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["MiddleName"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22902")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["LastName"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22903")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Address1"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22904")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Address2"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22905")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Address3"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22906")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["City"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22907")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["State"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22908")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Zip"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22909")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Country"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22910")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Phone1"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22911")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Phone2"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22912")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Fax"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22913")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Email1"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22914")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Email2"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22915")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Website"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22916")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Description"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22917")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Role"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "53531")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Status"].toString();
                            }
                        }
                    }
                }
            }
            else {
                dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 49983);
                if (dvCnt.length > 0) {
                    if (this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                            if (this.IsInventoryVoucher && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]))
                                this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = BaseService.SessionManager.UserName;
                            else if (!this.IsInventoryVoucher && ((this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"]))
                                || (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                                || (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                            ))
                                this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = BaseService.SessionManager.UserName;
                        }
                    }

                    let Cb = this.ScreenObject._TextFields.find(a => a.DBColumnName == dvCnt[0]["SysColumnName"]);
                    if (Cb && Cb instanceof PactTextBoxData)
                        Cb.Text = BaseService.SessionManager.UserName;
                }

                dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 49984);
                if (dvCnt.length > 0) {
                    let ds: any = BaseService.common.GetDataSet("DOC001", "")
                    if (ds != null && ds.Tables.length > 0 && !ds.Columns[0].Contains("ErrorMessage") && ds.Tables[0].length > 0 && !Util.IsEmpty(ds.Tables[0][0]["dt"])) {
                        if (this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                                if (this.IsInventoryVoucher && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]))
                                    this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = BaseService.SessionManager.UserName;
                                else if (!this.IsInventoryVoucher && ((this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"]))
                                    || (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                                    || (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                                )) {
                                    let c0 = ds.Columns[0][0]
                                    if (dvCnt[0]["UserColumnType"].toString() == "Date") {
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0][c0]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"] + "_Key"] = Util.ParseDate(ds.Tables[0][0][c0]);
                                    }
                                    else if (dvCnt[0]["UserColumnType"].toString() == "DateTime") {
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0][c0]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"] + "_Key"] = Util.ParseDate(ds.Tables[0][0][c0]);
                                    }
                                    else if (dvCnt[0]["UserColumnType"].toString() == "Time") {
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0][c0]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"] + "_Key"] = Util.ParseDate(ds.Tables[0][0][c0]);
                                    }
                                    else
                                        this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0][c0]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                }
                            }
                        }

                        let Cb = this.ScreenObject._TextFields.find(a => a.DBColumnName == dvCnt[0]["SysColumnName"]);
                        if (Cb) {
                            let c0 = ds.Columns[0][0]
                            if (Cb instanceof PactTextBoxData)
                                Cb.Text = Util.ParseDate(ds.Tables[0][0][c0]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            else if (Cb instanceof PactExtraFieldDateData)
                                Cb.Date = Util.ParseDate(ds.Tables[0][0][c0]);
                            if (Cb instanceof PactDateTimeData)
                                Cb.Date = Util.ParseDate(ds.Tables[0][0][c0]);
                        }
                    }
                }

                dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalCCID != null && x.LocalCCID == -7);
                if (dvCnt.length > 0) {
                    for (let j = 0; j < dvCnt.length; j++) {
                        if (this.ScreenObject.GridDataColumns.Contains(dvCnt[j]["SysColumnName"])) {
                            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                                if (this.IsInventoryVoucher && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                                    if (this.ScreenObject.Data.Tables.length > 22 && this.ScreenObject.Data.Tables[23] != null && this.ScreenObject.Data.Tables[23].length > 0) {
                                        if (dvCnt[j]["LinkData"].toString() == "22898")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["UserName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22900")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["FirstName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22901")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["MiddleName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22902")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["LastName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22903")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22904")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22905")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address3"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22906")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["City"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22907")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["State"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22908")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Zip"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22909")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Country"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22910")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Phone1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22911")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Phone2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22912")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Fax"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22913")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Email1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22914")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Email2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22915")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Website"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22916")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Description"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22917")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Role"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "53531")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Status"].toString();
                                    }
                                }
                                else if (!this.IsInventoryVoucher && ((this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"]))
                                    || (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                                    || (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                                )) {
                                    if (this.ScreenObject.Data.Tables.length > 22 && this.ScreenObject.Data.Tables[23] != null && this.ScreenObject.Data.Tables[23].length > 0) {
                                        if (dvCnt[j]["LinkData"].toString() == "22898")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["UserName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22900")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["FirstName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22901")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["MiddleName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22902")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["LastName"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22903")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22904")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22905")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Address3"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22906")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["City"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22907")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["State"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22908")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Zip"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22909")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Country"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22910")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Phone1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22911")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Phone2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22912")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Fax"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22913")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Email1"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22914")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Email2"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22915")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Website"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22916")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Description"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "22917")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Role"].toString();
                                        else if (dvCnt[j]["LinkData"].toString() == "53531")
                                            this.ScreenObject.GridData[i][dvCnt[j]["SysColumnName"]] = this.ScreenObject.Data.Tables[23][0]["Status"].toString();
                                    }
                                }
                            }
                        }

                        let Cb = this.ScreenObject._TextFields.find(a => a.DBColumnName == dvCnt[j]["SysColumnName"]);
                        if (Cb && Cb instanceof PactTextBoxData) {
                            if (this.ScreenObject.Data.Tables.length > 22 && this.ScreenObject.Data.Tables[23] != null && this.ScreenObject.Data.Tables[23].length > 0) {
                                if (dvCnt[j]["LinkData"].toString() == "22898")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["UserName"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22900")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["FirstName"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22901")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["MiddleName"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22902")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["LastName"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22903")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Address1"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22904")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Address2"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22905")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Address3"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22906")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["City"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22907")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["State"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22908")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Zip"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22909")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Country"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22910")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Phone1"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22911")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Phone2"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22912")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Fax"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22913")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Email1"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22914")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Email2"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22915")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Website"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22916")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Description"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "22917")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Role"].toString();
                                else if (dvCnt[j]["LinkData"].toString() == "53531")
                                    Cb.Text = this.ScreenObject.Data.Tables[23][0]["Status"].toString();
                            }
                        }
                    }
                }
            }
        }
    }

    FillLinkRefereceProducts(dr: any, dt: any[], PriceDr: any, Linkdata: string = "") {
        if (!Util.IsEmpty(dr["ProductID_Key"]) && parseInt(dr["ProductID_Key"]) != this.ScreenObject.TempProductID) {
            if (Linkdata == "" || Linkdata == "23819")
                this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 23819 }, "AvgRate");
            if (Linkdata == "" || Linkdata == "25398")
                this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 25398 }, "QOH");
            if (Linkdata == "" || Linkdata == "52638")
                this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 52638 }, "QOH");
            if (Linkdata == "" || Linkdata == "49")
                this.FillDatarow(dr, dt, null, { LinkData: 49 }, "Loc_QOH");
            if (Linkdata == "" || Linkdata == "50")
                this.FillDatarow(dr, dt, null, { LinkData: 50 }, "Div_QOH");

            if (Linkdata == "" || Linkdata == "52637")
                this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 52637 }, "BalQOH");
            if (Linkdata == "" || Linkdata == "26421")
                this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 26421 }, "HOLDQTY");
            if (Linkdata == "" || Linkdata == "50454")
                this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 50454 }, "CommittedQty");
            if (Linkdata == "" || Linkdata == "26422")
                this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 26422 }, "RESERVEQTY");
            if (Linkdata == "" || Linkdata == "499943")
                this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 499943 }, "TotalReserve");
        }
        if (Linkdata == "" || Linkdata == "23820")
            this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 23820 }, "LastPurchaseRate");
        if (Linkdata == "" || Linkdata == "55479")
            this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 55479 }, "LPRStockNonStock");
        if (Linkdata == "" || Linkdata == "24062")
            this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 24062 }, "PWLastPRate");
        if (Linkdata == "" || Linkdata == "50051")
            this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 50051 }, "LastPCost");
        if (Linkdata == "" || Linkdata == "23821")
            this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 23821 }, "PWLastPCost");
        if (Linkdata == "" || Linkdata == "50494")
            this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 50494 }, "UnitProductCode");
        if (Linkdata == "" || Linkdata == "50493")
            this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 50493 }, "VendorProductCode");
        if (Linkdata == "" || Linkdata == "53736")
            this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 53736 }, "VendorQty");
        if (Linkdata == "" || Linkdata == "55490")
            this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 55490 }, "AvgPrice");
        if (Linkdata == "" || Linkdata == "55491")
            this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 55491 }, "dp");
        if (Linkdata == "" || Linkdata == "55492")
            this.FillDatarow(dr, dt, null, { LocalReference: 79, LinkData: 55492 }, "rp");

        this.FillSalesPurchase(dr, dt, PriceDr, -1, Linkdata);
        if (Linkdata == "" || Linkdata == "277")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 277 }, "ReorderQty");
        if (Linkdata == "" || Linkdata == "276")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 276 }, "ReorderLevel");
    }

    FillSalesPurchase(dr: any, dt: any[], PriceDr: any, Conv: number = -1, Linkdata: string = "") {
        if (Linkdata == "" || Linkdata == "22821")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22821 }, "SellingRate", Conv);
        if (Linkdata == "" || Linkdata == "22793")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22793 }, "SellingRateA", Conv);
        if (Linkdata == "" || Linkdata == "22794")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22794 }, "SellingRateB", Conv);
        if (Linkdata == "" || Linkdata == "22795")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22795 }, "SellingRateC", Conv);
        if (Linkdata == "" || Linkdata == "22796")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22796 }, "SellingRateD", Conv);
        if (Linkdata == "" || Linkdata == "22797")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22797 }, "SellingRateE", Conv);
        if (Linkdata == "" || Linkdata == "22798")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22798 }, "SellingRateF", Conv);
        if (Linkdata == "" || Linkdata == "22799")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22799 }, "SellingRateG", Conv);

        if (Linkdata == "" || Linkdata == "22820")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22820 }, "PurchaseRate", Conv);
        if (Linkdata == "" || Linkdata == "22786")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22786 }, "PurchaseRateA", Conv);
        if (Linkdata == "" || Linkdata == "22787")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22787 }, "PurchaseRateB", Conv);
        if (Linkdata == "" || Linkdata == "22788")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22788 }, "PurchaseRateC", Conv);
        if (Linkdata == "" || Linkdata == "22789")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22789 }, "PurchaseRateD", Conv);
        if (Linkdata == "" || Linkdata == "22790")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22790 }, "PurchaseRateE", Conv);
        if (Linkdata == "" || Linkdata == "22791")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22791 }, "PurchaseRateF", Conv);
        if (Linkdata == "" || Linkdata == "22792")
            this.FillDatarow(dr, dt, PriceDr, { LinkData: 22792 }, "PurchaseRateG", Conv);
    }

    FillRates(ds: any, datarow: any) {
        let pricdr: any = null;
        if (ds.Tables.length > 3 && ds.Tables[3].length > 0)//prices
        {
            pricdr = ds.Tables[3][0];
            let RateCol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Rate");
            if (!Util.IsEmpty(RateCol.Formula) && ds.Columns[3].Contains(RateCol.Formula) && !Util.IsEmpty(ds.Tables[3][0][RateCol.Formula])) {
                datarow["Rate"] = ds.Tables[3][0][RateCol.Formula].toString();
                datarow["default" + "Rate"] = ds.Tables[3][0][RateCol.Formula].toString();
            }
            else {
                if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                    if (!Util.IsEmpty(ds.Tables[3][0]["PurchaseRate"])) {
                        datarow["Rate"] = ds.Tables[3][0]["PurchaseRate"].toString();
                        datarow["default" + "Rate"] = ds.Tables[3][0]["PurchaseRate"].toString();
                    }
                }
                else {
                    if (!Util.IsEmpty(ds.Tables[3][0]["SellingRate"])) {
                        datarow["Rate"] = ds.Tables[3][0]["SellingRate"].toString();
                        datarow["default" + "Rate"] = ds.Tables[3][0]["SellingRate"].toString();
                    }
                }
            }
        }

        this.FillLinkRefereceProducts(datarow, ds.Tables[0], pricdr);
        if (ds.Tables.length > 0 && ds.Tables[0].length > 0)//prices
        {
            datarow["UOMConversion"] = ds.Tables[0][0]["Conversion"].toString();
            let Vldbl = 0;
            if (!Util.IsEmpty(datarow["Quantity"]) && !Util.IsEmpty(ds.Tables[0][0]["Conversion"]) && Util.IsNum(ds.Tables[0][0]["Conversion"])) {
                datarow["UOMConvertedQty"] = Util.Double(ds.Tables[0][0]["Conversion"]) * parseFloat(datarow["Quantity"]);
            }
            else if (!Util.IsEmpty(datarow["Quantity"]))
                datarow["UOMConvertedQty"] = datarow["Quantity"].toString();
        }

        if (ds.Tables.length > 10 && ds.Columns[10].Contains("BinId") && ds.Tables[10].length > 0 && ds.Tables[10][0]["BinId"] && ds.Tables[10][0]["BinId"].toString() != "0" && this.ScreenObject.Preferences.ContainsKey("BinsDimension") && parseInt(this.ScreenObject.Preferences["BinsDimension"]) > 50000) {
            let bincol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == parseInt(this.ScreenObject.Preferences["BinsDimension"]));
            if (bincol && this.ScreenObject.GridDataColumns.Contains(bincol.DisplayMember)) {
                datarow[bincol.DisplayMember] = ds.Tables[10][0]["BinName"].toString();
                datarow[bincol.ValueMember] = ds.Tables[10][0]["BinId"].toString();
            }
        }
    }
    async OnProductUnitChange(datarow: any) {
        if (Util.String(datarow["Unit_Key"]) == "-1" && this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(datarow["ProductID_Key"]) && parseInt(datarow["ProductID_Key"]) > 0) {
            const { ViewAddMulitpleUnitsViewModel } = await import('../../common/view-add-mulitple-units/ViewAddMulitpleUnitsViewModel')
            const { ViewAddMulitpleUnitsComponent } = await import('../../common/view-add-mulitple-units/view-add-mulitple-units.component')
            let objVMU = new ViewAddMulitpleUnitsViewModel(parseInt(datarow["ProductID_Key"]), this);
            await BaseService.page.openDialog(objVMU, ViewAddMulitpleUnitsComponent, { ShowCenter: true })
        }
        if (Util.IsNum(datarow["Unit_Key"]) && parseInt(datarow["Unit_Key"]) > 0 && datarow["Unit_Key"].toString() != this.PrevValue) {

            let ds = this.ScreenObject.GetPriceofUnit(datarow["ProductID_Key"].toString(), this.DocumentDate, parseInt(datarow["Unit_Key"]), datarow);

            let Conv = 0, tempdbl = 0;
            if (ds.Tables.length > 0 && ds.Tables[0].length > 0)//prices
            {
                if (!Util.IsEmpty(ds.Tables[0][0]["Conversion"]))
                    Conv = parseFloat(ds.Tables[0][0]["Conversion"]);
                datarow["UOMConversion"] = Conv;

                if (!Util.IsEmpty(datarow["Quantity"]) && !Util.IsEmpty(ds.Tables[0][0]["Conversion"]) && Util.IsNum(ds.Tables[0][0]["Conversion"])) {
                    datarow["UOMConvertedQty"] = Util.Double(ds.Tables[0][0]["Conversion"]) * parseFloat(datarow["Quantity"]);
                }
                else if (!Util.IsEmpty(datarow["Quantity"]))
                    datarow["UOMConvertedQty"] = datarow["Quantity"].toString();

                let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 50494);
                if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                    if (!Util.IsEmpty(ds.Columns[0].Contains("Barcode") && ds.Tables[0][0]["Barcode"]))
                        datarow[dvCnt[0]["SysColumnName"]] = ds.Tables[0][0]["Barcode"].toString();
                }
                if (ds.Columns[0].Contains("Barcode_Key") && !Util.IsEmpty(ds.Tables[0][0]["Barcode_Key"]) && this.ScreenObject.Preferences.ContainsKey("BarcodeDimension") && this.ScreenObject.Preferences["BarcodeDimension"] != "" && parseInt(this.ScreenObject.Preferences["BarcodeDimension"]) > 0) {
                    let barcodecol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == parseInt(this.ScreenObject.Preferences["BarcodeDimension"]));
                    if (barcodecol) {
                        datarow[barcodecol.ValueMember] = ds.Tables[0][0]["Barcode_Key"].toString();
                        datarow[barcodecol.DisplayMember] = ds.Tables[0][0]["Barcode"].toString();
                        if (this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == barcodecol.ID).length > 0) {
                            this.ScreenObject.GetLinkReferenceData(parseInt(barcodecol.ID), this.DocumentID, parseInt(datarow[barcodecol.ValueMember]), Date.Today(), "", barcodecol.CostCenterID, datarow);
                        }
                    }
                }
            }

            if (ds.Tables.length > 1 && ds.Tables[1].length > 0 && ds.Columns[1].Contains("PurchaseRate"))//prices
            {
                let RateCol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Rate");
                if (!Util.IsEmpty(RateCol.Formula) && ds.Columns[1].Contains(RateCol.Formula) && !Util.IsEmpty(ds.Tables[1][0][RateCol.Formula])) {
                    if (ds.Columns[1].Contains("UOMID"))
                        tempdbl = Conv * parseFloat(ds.Tables[1][0][RateCol.Formula]);
                    else
                        tempdbl = parseFloat(ds.Tables[1][0][RateCol.Formula]);
                    datarow["Rate"] = tempdbl.ToString("N" + RateCol.DecimalPoints);
                    datarow["default" + "Rate"] = tempdbl.ToString("N" + RateCol.DecimalPoints);
                }
                else {
                    if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 10 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 31) {
                        if (!Util.IsEmpty(ds.Tables[1][0]["PurchaseRate"])) {
                            if (ds.Columns[1].Contains("UOMID"))
                                tempdbl = Conv * parseFloat(ds.Tables[1][0]["PurchaseRate"]);
                            else
                                tempdbl = parseFloat(ds.Tables[1][0]["PurchaseRate"]);

                            datarow["Rate"] = tempdbl.ToString("N" + RateCol.DecimalPoints);
                            datarow["default" + "Rate"] = tempdbl.ToString("N" + RateCol.DecimalPoints);
                        }
                    }
                    else {
                        if (!Util.IsEmpty(ds.Tables[1][0]["SellingRate"])) {
                            if (ds.Columns[1].Contains("UOMID"))
                                tempdbl = Conv * parseFloat(ds.Tables[1][0]["SellingRate"]);
                            else
                                tempdbl = parseFloat(ds.Tables[1][0]["SellingRate"]);

                            datarow["Rate"] = tempdbl.ToString("N" + RateCol.DecimalPoints);
                            datarow["default" + "Rate"] = tempdbl.ToString("N" + RateCol.DecimalPoints);
                        }
                    }
                }
            }

            this.FillSalesPurchase(datarow, ds.Tables[1], ds.Tables[1][0], Conv);
        }
    }

    ValidateDataonSave_xml(xdoc: XmlDocument, ind: number): boolean {
        try {
            for (let i = 0; i < this.ScreenObject._TextFields.length; i++) {
                let item = this.ScreenObject._TextFields[i]
                if (this.fldDict.ContainsKey(item.Lbl)) {
                    if (item instanceof PactTextBoxData) {
                        if (item.DataType == "FLOAT") {
                            if (item.Text != null && item.Text != "" && item.ValidateData() == "")
                                this.fldDict[item.Lbl].setFieldValue(item.Text);
                            else
                                this.fldDict[item.Lbl].setFieldValue(0);
                        }
                        else
                            this.fldDict[item.Lbl].setFieldValue(item.Text);
                    }
                    else if (item instanceof PactComboBoxData)
                        this.fldDict[item.Lbl].setFieldValue(item.SelectedValue);
                    else if (item instanceof PactSelectionBoxData)
                        this.fldDict[item.Lbl].setFieldValue(item.Text);
                    else if (item instanceof PactListBoxData) {
                        if (item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                            this.fldDict[item.Lbl].setFieldValue(item.Text);
                        else
                            this.fldDict[item.Lbl].setFieldValue("");
                    }
                }
            }
            for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                let column = this.ScreenObject.ColumnSource[j]
                if (column.Expression != null && column.Expression != "") {
                    let xList = xdoc.SelectNodes("xml/Row/xml");
                    let dyncnt = 0;
                    for (let k = 0; k < xList.length; k++) {
                        let xnode = xList[k]
                        dyncnt++;
                        let oCols = this.ScreenObject.ColumnSource;
                        let ExhgRate = 1;
                        if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                            if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                                ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
                        }
                        this.fldDict.keys.forEach(dictKey => {
                            let item = { Key: dictKey, Value: this.fldDict[dictKey] }
                            let col = oCols.filter(a => a.lbl == (this.fldDict[item.Key].getFieldName()));

                            if (col.length > 0 && col[0].DataType != "ComboBox" && col[0].DataType != "PactComboBox"
                                && xnode.attributes[col[0].DisplayMember] && !Util.IsEmpty(xnode.attributes[col[0].DisplayMember].value)) {
                                if (Util.IsNum(xnode.attributes[col[0].DisplayMember].value)) {
                                    if (col[0].DecimalPoints != null && col[0].DecimalPoints != "")
                                        this.fldDict[item.Key].setFieldValue(parseFloat(xnode.attributes[col[0].DisplayMember].value).ToString("N" + col[0].DecimalPoints));
                                    else
                                        this.fldDict[item.Key].setFieldValue(xnode.attributes[col[0].DisplayMember].value);
                                }
                                else
                                    this.fldDict[item.Key].setFieldValue(xnode.attributes[col[0].DisplayMember].value);
                            }
                            else if (item.Key.toLowerCase().startsWith("calc")) {
                                col = oCols.filter(a => a.lbl == (this.fldDict[item.Key.substr(4)].getFieldName()));
                                if (col.length > 0 && col[0].DataType != "ComboBox" && col[0].DataType != "PactComboBox"
                                    && xnode.attributes["dcCalc" + col[0].DisplayMember.replace("dc", "")] != null && xnode.attributes["dcCalc" + col[0].DisplayMember.replace("dc", "")].value != "") {
                                    if (Util.IsNum(xnode.attributes["dcCalc" + col[0].DisplayMember.replace("dc", "")].value)) {
                                        if (col[0].DecimalPoints != null && col[0].DecimalPoints != "")
                                            this.fldDict[item.Key].setFieldValue(parseFloat(xnode.attributes["dcCalc" + col[0].DisplayMember.replace("dc", "")].value).ToString("N" + col[0].DecimalPoints));
                                        else
                                            this.fldDict[item.Key].setFieldValue(xnode.attributes["dcCalc" + col[0].DisplayMember.replace("dc", "")].value);
                                    }
                                    else
                                        this.fldDict[item.Key].setFieldValue(xnode.attributes["dcCalc" + col[0].DisplayMember.replace("dc", "")].value);
                                }
                            }
                            else
                                this.fldDict[item.Key].setFieldValue(0);
                        });

                        if (this.IsInventoryVoucher) {
                            if (xnode.attributes["Rate"] != null && xnode.attributes["Rate"].value != "")
                                this.fldDict["RATE"].setFieldValue(xnode.attributes["Rate"].value);
                            else
                                this.fldDict["RATE"].setFieldValue(0);

                            if (xnode.attributes["Quantity"] != null && xnode.attributes["Quantity"].value != "")
                                this.fldDict["QTY"].setFieldValue(xnode.attributes["Quantity"].value);
                            else
                                this.fldDict["QTY"].setFieldValue(0);

                            if (xnode.attributes["Gross"] != null && xnode.attributes["Gross"].value != "")
                                this.fldDict["GROSS"].setFieldValue(xnode.attributes["Gross"].value);
                            else
                                this.fldDict["GROSS"].setFieldValue(0);

                            if (xnode.attributes["UOMConvertedQty"] != null && xnode.attributes["UOMConvertedQty"].value != "")
                                this.fldDict["CONVQTY"].setFieldValue(xnode.attributes["UOMConvertedQty"].value);
                            else
                                this.fldDict["CONVQTY"].setFieldValue(0);

                            if (xnode.attributes["UOMConversion"] != null && xnode.attributes["UOMConversion"].value != "")
                                this.fldDict["UOMCONVERSION"].setFieldValue(xnode.attributes["UOMConversion"].value);
                            else
                                this.fldDict["UOMCONVERSION"].setFieldValue(0);

                            if (xnode.attributes["AVGRATE"] != null && xnode.attributes["AVGRATE"].value != "")
                                this.fldDict["AVGRT"].setFieldValue(xnode.attributes["AVGRATE"].value);
                            else
                                this.fldDict["AVGRT"].setFieldValue(0);

                            if (xnode.attributes["QOH"] != null && xnode.attributes["QOH"].value != "")
                                this.fldDict["QOH"].setFieldValue(xnode.attributes["QOH"].value);
                            else
                                this.fldDict["QOH"].setFieldValue(0);

                            if (xnode.attributes["BalQOH"] != null && xnode.attributes["BalQOH"].value != "")
                                this.fldDict["BalQOH"].setFieldValue(xnode.attributes["BalQOH"].value);
                            else
                                this.fldDict["BalQOH"].setFieldValue(0);

                            if (xnode.attributes["HOLDQTY"] != null && xnode.attributes["HOLDQTY"].value != "")
                                this.fldDict["HOLDQTY"].setFieldValue(xnode.attributes["HOLDQTY"].value);
                            else
                                this.fldDict["HOLDQTY"].setFieldValue(0);

                            if (xnode.attributes["CommittedQty"] != null && xnode.attributes["CommittedQty"].value != "")
                                this.fldDict["CommittedQty"].setFieldValue(xnode.attributes["CommittedQty"].value);
                            else
                                this.fldDict["CommittedQty"].setFieldValue(0);

                            if (xnode.attributes["RESERVEQTY"] != null && xnode.attributes["RESERVEQTY"].value != "")
                                this.fldDict["RESERVEQTY"].setFieldValue(xnode.attributes["RESERVEQTY"].value);
                            else
                                this.fldDict["RESERVEQTY"].setFieldValue(0);

                            if (xnode.attributes["TotalReserve"] != null && xnode.attributes["TotalReserve"].value != "")
                                this.fldDict["TotalReserve"].setFieldValue(xnode.attributes["TotalReserve"].value);
                            else
                                this.fldDict["TotalReserve"].setFieldValue(0);
                        }

                        this.fldDict["EXCHRT"].setFieldValue(ExhgRate);
                        let temp = this.fldDict;
                        let result = BaseService.eval.EvaluateExpression(column.Expression, temp).toString();

                        if (result.toString() == "1" && (column.Action == 1 || column.Action == 3 || column.Action == 4)) {
                            let message = column.Message;
                            if (xnode.attributes["DocSeqNo"] != null && xnode.attributes["DocSeqNo"].value != "")
                                message = column.Message.replace("[ROWNO]", xnode.attributes["DocSeqNo"].value);
                            else
                                message = column.Message.replace("[ROWNO]", dyncnt.toString());

                            if (xnode.attributes["ProductCode"] != null && xnode.attributes["ProductCode"].value != "")
                                message = message.replace("[ProductCode]", xnode.attributes["ProductCode"].value);
                            else
                                message = message.replace("[ProductCode]", "");

                            message += " For Dynamic set at Row No:" + this.ScreenObject.GridData[ind]["DocSeqNo"].toString();

                            alert(message)
                            if (column.Action == 3 || column.Action == 4) {
                                return false;
                            }
                        }
                    }
                }
            }
        }
        catch (error) {
            if (error == "Cannot set Visibility or call Show, ShowDialog, or WindowInteropHelper.EnsureHandle after a Window has closed.")
                return false;
        }
        return true;
    }
    ValidateDataonSave(): boolean {
        try {
            let colName = this.GetColName();

            for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                if (this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("exchangerate") || this.ScreenObject.ColumnSource[j].DisplayMember == "AppRemarks" || this.ScreenObject.ColumnSource[j].DisplayMember == "FreeQTY" || this.ScreenObject.ColumnSource[j].DisplayMember.toLowerCase().Contains("currencyid")
                    || (this.ScreenObject.ColumnSource[j].CostCenterID > 0 && this.ScreenObject.ColumnSource[j].DisplayMember != "ProductCode" && this.ScreenObject.ColumnSource[j].DisplayMember.endsWith("Code")))
                    continue;
                if (!Util.IsEmpty(this.ScreenObject.ColumnSource[j].Expression) && this.ScreenObject.ColumnSource[j].Action == 5) {
                    let rownos = "";
                    let ProductCode = "";
                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName])) {
                            this.FillDictionary(this.ScreenObject.GridData[i], false);
                            let temp = this.fldDict;
                            let result = BaseService.eval.EvaluateExpression(this.ScreenObject.ColumnSource[j].Expression, temp).toString();
                            if (result.toString() == "1") {
                                rownos += this.ScreenObject.GridData[i]["DocSeqNo"].toString() + ",";
                                if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                    ProductCode += this.ScreenObject.GridData[i]["ProductCode"].toString();
                            }
                        }
                    }

                    if (rownos.length > 1) {
                        let message: string = this.ScreenObject.ColumnSource[j].Message.replace("[ROWNO]", rownos.substr(0, rownos.length - 1));
                        message = message.replace("[ProductCode]", ProductCode);
                        if (!confirm(message))
                            return false;
                    }
                }
            }
        }
        catch (error) {
            alert('SaveError');
            if (error.message == "Cannot set Visibility or call Show, ShowDialog, or WindowInteropHelper.EnsureHandle after a Window has closed.")
                return false;

        }
        return true;
    }
    ValidateDataonSave_col_dr(col: DgColumn, dr: any): boolean {
        try {
            if (col.Expression != null && col.Expression != "") {
                this.FillDictionary(dr, false);
                let result = BaseService.eval.EvaluateExpression(col.Expression, this.fldDict).toString();

                if (result.toString() == "1" && (col.Action == 1 || col.Action == 3 || col.Action == 4)) {
                    let message = col.Message.replace("[ROWNO]", dr["DocSeqNo"].toString());

                    if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                        message = message.replace("[ProductCode]", Util.String(dr["ProductCode"]));

                    if (BaseService.SessionManager.IsWebApplication)//There instanceof no msg to display warning message in web 
                    {
                        this.ScreenObject.Preferences["tempWarningMsg"] = message;
                        //DisplayMessage = message;
                    }
                    else {
                        this.ScreenObject.Preferences["tempWarningMsg"] = null;
                    }

                    alert(message)
                    if (col.Action == 3 || col.Action == 4) {
                        return false;
                    }
                }
            }
            else if (col.EditOption == 4 && (col.Action == 3 || col.Action == 4)) {
                let colName = this.GetPrimaryColName();
                let flds: string[] = [];

                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName]) && !Util.IsEmpty(this.ScreenObject.GridData[i][col.DisplayMember])) {
                        if (flds.Contains(this.ScreenObject.GridData[i][col.DisplayMember].toString())) {
                            let message = col.Message.replace("[ROWNO]", dr["DocSeqNo"].toString());
                            if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                message = message.replace("[ProductCode]", Util.String(dr["ProductCode"]));

                            alert(message)
                            return false;
                        }
                        else
                            flds.push(this.ScreenObject.GridData[i][col.DisplayMember].toString());
                    }
                }
            }
            else if (col.EditOption == 5 && (col.Action == 3 || col.Action == 4)) {
                let colName = this.GetPrimaryColName(), fldval = null;

                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName])) {
                        if (fldval == null)
                            fldval = this.ScreenObject.GridData[i][col.DisplayMember].toString();
                        else if (fldval != this.ScreenObject.GridData[i][col.DisplayMember].toString()) {
                            let message = col.Message.replace("[ROWNO]", dr["DocSeqNo"].toString());
                            if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                message = message.replace("[ProductCode]", Util.String(dr["ProductCode"]));
                            alert(message);
                            return false;
                        }
                    }
                }
            }
        }
        catch (error) {
            if (error == "Cannot set Visibility or call Show, ShowDialog, or WindowInteropHelper.EnsureHandle after a Window has closed.")
                return false;
        }
        return true;
    }
    ValidateDataonSave_Ctrl(col: PactControlData): boolean {
        try {
            if (col.Expression != null && col.Expression != "") {
                let temp: any = this.fldDict;
                let result = BaseService.eval.EvaluateExpression(col.Expression, temp).toString();

                if (result.toString() == "1" && (col.Action == 1 || col.Action == 3 || col.Action == 4)) {
                    alert(col.Message);
                    if (col.Action == 3 || col.Action == 4) {
                        return false;
                    }
                }
                else if (result.toString() == "1" && col.Action == 5) {
                    if (!confirm(col.Message))
                        return false;
                }
            }
        }
        catch {

        }
        return true;
    }
    ValidateDate(col: PactControlData) {
        try {
            if (!Util.IsEmpty(col.Expression)) {
                this.FillDictionary(null, false);
                let temp = this.fldDict;
                let result = BaseService.eval.EvaluateExpression(col.Expression, temp).toString();
                if (Util.String(result) == "1" && (col.Action == 1 || col.Action == 3 || col.Action == 4)) {
                    alert(col.Message);
                }
            }
        }
        catch (error) {

        }
    }
    NumFieldEditOptionValidation(col: DgColumn, dr: any) {
        if (col) {
            if (col.EditOption == 1 && this.ScreenObject.GridDataColumns.Contains("default" + col.DisplayMember)) {
                if (!Util.IsEmpty(dr["default" + col.DisplayMember]) && !Util.IsEmpty(dr[col.DisplayMember]) && parseFloat(dr["default" + col.DisplayMember]) > parseFloat(dr[col.DisplayMember])) {
                    alert("Can not decrease value less than " + dr["default" + col.DisplayMember].toString())
                    throw new Error("PactException");
                }
            }
            else if (col.EditOption == 2 && this.ScreenObject.GridDataColumns.Contains("default" + col.DisplayMember)) {
                if (!Util.IsEmpty(dr["default" + col.DisplayMember]) && !Util.IsEmpty(dr[col.DisplayMember]) && parseFloat(dr["default" + col.DisplayMember]) < parseFloat(dr[col.DisplayMember])) {
                    alert("Can not increase value greater than " + dr["default" + col.DisplayMember].toString());
                    throw new Error("PactException");
                }
            }

            if (col.DisplayMember == "Quantity" && Util.String(dr["LinkedFieldName"]) == "Quantity" && this.ScreenObject.DocID == 0 && !Util.IsEmpty(dr["LinkedInvDocDetailsID"]) && parseInt(dr["LinkedInvDocDetailsID"]) > 0 && !(this.ScreenObject.Preferences.ContainsKey("DisableQtyCheck") && parseBoolean(this.ScreenObject.Preferences["DisableQtyCheck"]))) {
                let tol = parseBoolean(this.ScreenObject.Preferences["Enabletolerance"]);
                if (!Util.IsEmpty(dr["default" + col.DisplayMember]) && !Util.IsEmpty(dr[col.DisplayMember])) {
                    if (tol && Util.Double(dr["TolPer"]) > 0) {
                        if ((parseFloat(dr["default" + col.DisplayMember]) + parseFloat(dr["TolPer"])) < parseFloat(dr[col.DisplayMember])) {
                            alert("Can not enter more than source document quantity :" + (parseFloat(dr["default" + col.DisplayMember]) + parseFloat(dr["TolPer"])));
                            throw new Error("PactException");
                        }
                    }
                    else if (tol && Util.Double(dr["TolVal"]) > 0) {
                        if ((parseFloat(dr["default" + col.DisplayMember]) + parseFloat(dr["TolVal"])) < parseFloat(dr[col.DisplayMember])) {
                            alert("Can not enter more than source document quantity :" + (parseFloat(dr["default" + col.DisplayMember]) + parseFloat(dr["TolVal"])));
                            throw new Error("PactException");

                        }
                    }
                    else if (parseFloat(dr["default" + col.DisplayMember]) < parseFloat(dr[col.DisplayMember])) {
                        alert("Can not enter more than source document quantity :" + dr["default" + col.DisplayMember].toString());
                        throw new Error("PactException");
                    }
                }
            }

            //if (col.DisplayMember == "Quantity" && !Util.IsEmpty(dr["LinkedQuantity"])
            //    && !(this.ScreenObject.Preferences.ContainsKey("LinkForward") && this.ScreenObject.Preferences["LinkForward"] != "" && parseBoolean(this.ScreenObject.Preferences["LinkForward"]))
            //    && !(this.ScreenObject.Preferences.ContainsKey("AllowMultipleLinking") && this.ScreenObject.Preferences["AllowMultipleLinking"] != "" && parseBoolean(this.ScreenObject.Preferences["AllowMultipleLinking"])))
            //{
            //    let qty = 0;
            //    Util.Double(dr[col.DisplayMember].toString(), out qty);
            //    if (qty < parseFloat(dr["LinkedQuantity"]))
            //    {
            //        ShellWindowViewModel.Instance().PopViewModel = new MessageDialogViewModel("Can not enter less than linked quantity :" + dr["LinkedQuantity"].toString(), "OK");
            //        throw new Error("PactException");
            //    }
            //}
            //if (col.DisplayMember == "Gross" && !Util.IsEmpty(dr["LinkedGross"])
            //    && !(this.ScreenObject.Preferences.ContainsKey("LinkForward") && this.ScreenObject.Preferences["LinkForward"] != "" && parseBoolean(this.ScreenObject.Preferences["LinkForward"]))
            //    && !(this.ScreenObject.Preferences.ContainsKey("AllowMultipleLinking") && this.ScreenObject.Preferences["AllowMultipleLinking"] != "" && parseBoolean(this.ScreenObject.Preferences["AllowMultipleLinking"])))
            //{
            //    let qty = 0;
            //    Util.Double(dr[col.DisplayMember].toString(), out qty);
            //    if (qty < parseFloat(dr["LinkedGross"]))
            //    {
            //        ShellWindowViewModel.Instance().PopViewModel = new MessageDialogViewModel("Can not enter less than linked value :" + dr["LinkedGross"].toString(), "OK");
            //        throw new Error("PactException");
            //    }
            //}
        }
    }

    ValidateFooterDataonSave(dr: any): boolean {
        try {
            if (this.ScreenObject.FooterGridDataColumns.Contains("Expression") && this.ScreenObject.FooterGridDataColumns.Contains("Action") && this.ScreenObject.FooterGridDataColumns.Contains("Message") && !Util.IsEmpty(dr["Expression"])) {
                let temp = this.FooterDics;
                let result = BaseService.eval.EvaluateExpression(dr["Expression"].toString(), temp);

                if (result.toString() == "1" && (dr["Action"].toString() == "1" || dr["Action"].toString() == "3" || dr["Action"].toString() == "4")) {
                    alert(dr["Message"].toString())
                    if (dr["Action"].toString() == "3" || dr["Action"].toString() == "4") {
                        return false;
                    }
                }
            }
        }
        catch {
        }
        return true;
    }
    ValidateFooterData(dr: any) {
        try {
            if (this.ScreenObject.FooterGridDataColumns.Contains("Expression") && this.ScreenObject.FooterGridDataColumns.Contains("Action") && this.ScreenObject.FooterGridDataColumns.Contains("Message") && !Util.IsEmpty(dr["Expression"])) {
                let temp = this.FooterDics;
                let result = BaseService.eval.EvaluateExpression(dr["Expression"].toString(), temp);
                if (Util.String(result) == "1" && (Util.String(dr["Action"]) == "2" || Util.String(dr["Action"]) == "4")) {
                    alert(dr["Message"])
                    if (Util.String(dr["Action"]) == "4") {
                        dr["Amount"] = null;
                        this.CalculateTotals(dr, false);
                    }
                }
            }

        }
        catch (error) {
        }
    }

    ValidateData_Column(col: DgColumn, dr: any, IsExternal: boolean = false): boolean {
        try {
            if (IsExternal) {
                if (!Util.IsEmpty(col.ExternExpression)) {
                    let result = BaseService.eval.EvaluateExpression(col.ExternExpression, this.fldDict).toString();
                    if (result.toString() == "1")
                        return true;
                    else
                        return false;
                }
                else
                    return true;
            }
            if (this.IsInventoryVoucher && !Util.IsEmpty(dr["ProductID_Key"]) && Util.String(dr["Type"]) == "8")
                return false;
            if (!Util.IsEmpty(col.Expression)) {
                let result = BaseService.eval.EvaluateExpression(col.Expression, this.fldDict).toString();

                if (result.toString() == "1" && (col.Action == 2 || col.Action == 4)) {
                    let message: string = col.Message.replace("[ROWNO]", dr["DocSeqNo"].toString());
                    if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                        message = message.replace("[ProductCode]", dr["ProductCode"].toString());
                    alert(message)
                    if (col.Action == 4) {
                        this.CalculateTotals(dr, false);
                        throw new Error("PactException");
                    }
                }
            }
            else if (col.EditOption == 4 && (col.Action == 2 || col.Action == 4)) {
                let colName = this.GetPrimaryColName();
                let flds: string[] = [];

                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName]) && !Util.IsEmpty(this.ScreenObject.GridData[i][col.DisplayMember])) {
                        if (flds.Contains(this.ScreenObject.GridData[i][col.DisplayMember].toString())) {
                            let message: string = col.Message.replace("[ROWNO]", dr["DocSeqNo"].toString());
                            if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                message = message.replace("[ProductCode]", dr["ProductCode"].toString());
                            alert(message);
                            return false;
                        }
                        else
                            flds.push(this.ScreenObject.GridData[i][col.DisplayMember].toString());
                    }
                }
            }
            else if (col.EditOption == 5 && (col.Action == 2 || col.Action == 4)) {
                let colName: string = this.GetPrimaryColName(), fldval: any = null;

                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i][colName])) {
                        if (fldval == null)
                            fldval = this.ScreenObject.GridData[i][col.DisplayMember].toString();
                        else if (fldval != this.ScreenObject.GridData[i][col.DisplayMember].toString()) {
                            let message = col.Message.replace("[ROWNO]", dr["DocSeqNo"].toString());
                            if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                message = message.replace("[ProductCode]", dr["ProductCode"].toString());
                            alert(message)
                            return false;
                        }
                    }
                }
            }
        }
        catch (error) {
            if (error.message == "PactException")
                throw new Error("PactException");
        }
        return false;
    }
    ValidateDataCallBack(obj: any): boolean {
        return this.ValidateData(obj.sender, obj.IsExternal);
    }
    ValidateData(sender: PactControlData, IsExternal: boolean = false): boolean {
        try {
            if (IsExternal) {
                if (!Util.IsEmpty(sender.ExternExpression)) {
                    let result = BaseService.eval.EvaluateExpression(sender.ExternExpression, this.fldDict).toString();
                    if (result.toString() == "1")
                        return true;
                    else
                        return false;
                }
                else
                    return true;
            }
            else if (!Util.IsEmpty(sender.Expression)) {
                let result = BaseService.eval.EvaluateExpression(sender.Expression, this.fldDict).toString();
                if (result.toString() == "1" && (sender.Action == 2 || sender.Action == 4)) {
                    alert(sender.Message)
                    if (sender.Action == 4) {
                        if (sender instanceof PactTextBoxData) {
                            // sender.Text = "";
                        }
                    }
                }
            }

        }
        catch {

        }
        return false;
    }

    ValidateMinMax(col: DgColumn, dr: any) {
        let ValidationMessage = "";
        if (col.MinChar > 0 || col.MaxChar > 0) {
            let colName = this.GetPrimaryColName();

            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (this.ScreenObject.GridDataColumns.Contains(colName) && !Util.IsEmpty(this.ScreenObject.GridData[i][colName])) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i][col.DisplayMember])) {
                        if (col.MinChar > 0 && this.ScreenObject.GridData[i][col.DisplayMember].toString().Trim().length < col.MinChar) {
                            ValidationMessage = "Enter Min. Character of " + col.MinChar + " at " + col.lbl + " @RowNo - " + this.ScreenObject.GridData[i]["DocSeqNo"].ToString();
                            return ValidationMessage;
                        }

                        if (col.MaxChar > 0 && this.ScreenObject.GridData[i][col.DisplayMember].toString().Trim().length > col.MaxChar) {
                            ValidationMessage = "Enter Max. Character of " + col.MaxChar + " at " + col.lbl + " @RowNo - " + this.ScreenObject.GridData[i]["DocSeqNo"].ToString();
                            return ValidationMessage;
                        }

                    }
                }
            }
        }
        return ValidationMessage;
    }

    Fill(drrows: any[], count: number, Validate: boolean, IsWbs: boolean) {
        let ValueMember = "", NxtLvl = "";
        let tmpint = 0;
        if (count < 4) {
            tmpint = Util.Int(BaseService.SessionManager.Preferences["PMLevel" + count.toString() + "Dimension"])
            if (BaseService.SessionManager.Preferences.ContainsKey("PMLevel" + count.toString() + "Dimension") && tmpint > 0
                && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (tmpint - 50000) + "_Key")) {
                ValueMember = "dcCCNID" + (tmpint - 50000) + "_Key";
                tmpint = count + 1;
                while (tmpint < 5) {
                    if (tmpint == 4 && BaseService.SessionManager.Preferences.ContainsKey("PMTaskDimension") && BaseService.SessionManager.Preferences["PMTaskDimension"] != "" && BaseService.SessionManager.Preferences["PMTaskDimension"] != "0") {
                        NxtLvl = "dcCCNID" + (parseInt(BaseService.SessionManager.Preferences["PMTaskDimension"]) - 50000) + "_Key";
                        break;
                    }
                    else if (BaseService.SessionManager.Preferences.ContainsKey("PMLevel" + tmpint.toString() + "Dimension") && BaseService.SessionManager.Preferences["PMLevel" + tmpint.toString() + "Dimension"] != "" && BaseService.SessionManager.Preferences["PMLevel" + tmpint.toString() + "Dimension"] != "0"
                        && this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (parseInt(BaseService.SessionManager.Preferences["PMLevel" + tmpint.toString() + "Dimension"]) - 50000) + "_Key")) {
                        NxtLvl = "dcCCNID" + (parseInt(BaseService.SessionManager.Preferences["PMLevel" + tmpint.toString() + "Dimension"]) - 50000) + "_Key";
                        break;
                    }
                    tmpint++;
                }
            }
            else {
                this.Fill(drrows, count + 1, Validate, IsWbs);
                return;
            }
        }
        else if (count == 4) {
            if (BaseService.SessionManager.Preferences.ContainsKey("PMTaskDimension") && Util.IsNum(BaseService.SessionManager.Preferences["PMTaskDimension"])) {
                tmpint = parseInt(BaseService.SessionManager.Preferences["PMTaskDimension"]);
                ValueMember = "dcCCNID" + (tmpint - 50000) + "_Key";
            }
            else
                return;
        }
        else
            return;
        let cont: Dictionary<number> = new Dictionary<number>();
        let Parentdr: any = null;
        let minDate: Date = null, MaxDate: Date = null;
        let ActMinDate: Date = null, ActMaxDate: Date = null;
        let dt: Date;
        let tempint: number, cnt = 0;
        let tempdbl: number = 0, dWH = 0, dDurDays = 0;
        let dActWH = 0, dActDurDays = 0;
        let Totper: number = 0;

        for (let i = 0; i < drrows.length; i++) {
            if (!Util.IsEmpty(drrows[i]["ProductID_Key"]) && !Util.IsEmpty(drrows[i][ValueMember]) && parseInt(drrows[i][ValueMember]) > 1) {
                if (count == 4)
                    cnt++;
                else if (!cont.ContainsKey(drrows[i][ValueMember].toString()))
                    cont.push(drrows[i][ValueMember].toString(), cont.length + 1);

                if (IsWbs) {
                    if (!(!Util.IsEmpty(drrows[i]["DocDetailsID"]) && parseInt(drrows[i]["DocDetailsID"]) > 0)) {
                        if (count == 4)
                            drrows[i]["dcAlpha11"] = drrows[i]["dcAlpha11"].toString() + "." + cnt.toString();
                        else
                            drrows[i]["dcAlpha11"] = drrows[i]["dcAlpha11"].toString() + "." + cont[drrows[i][ValueMember].toString()].toString();
                    }
                }

                if (Util.isValidDate(drrows[i]["dcAlpha15_Key"]) && (!minDate || dt < minDate))
                    minDate = Util.ParseDate(drrows[i]["dcAlpha15_Key"]);
                if (Util.isValidDate(drrows[i]["dcAlpha16_Key"]) && (!MaxDate || dt > MaxDate))
                    MaxDate = Util.ParseDate(drrows[i]["dcAlpha16_Key"]);

                if (Util.isValidDate(drrows[i]["dcAlpha22_Key"]) && (!ActMinDate || dt < ActMinDate))
                    ActMinDate = dt;
                if (Util.isValidDate(drrows[i]["dcAlpha23_Key"]) && (!ActMaxDate || dt > ActMaxDate))
                    ActMaxDate = dt;

                tempint = Util.Int(drrows[i]["dcAlpha18"]);
                if (tempint > 0) {
                    if (count == 4 || (NxtLvl != "" && (Util.String(drrows[i][NxtLvl]) == "" || Util.String(drrows[i][NxtLvl]) == "1")))
                        Totper += tempint;
                    if (Parentdr != null && Util.IsNum(Parentdr["dcAlpha14"]))
                        drrows[i]["dcAlpha14"] = Util.Double(Parentdr["dcAlpha14"]) * tempint / 100;
                    else
                        drrows[i]["dcAlpha14"] = tempint;
                }

                if (count == 4 || (NxtLvl != '' && (Util.String(drrows[i][NxtLvl]) == "" || Util.String(drrows[i][NxtLvl]) == "1"))) {
                    tempdbl = Util.Double(drrows[i]["dcAlpha31"]);
                    if (tempdbl > 0)
                        dWH += tempdbl;

                    tempdbl = Util.Double(drrows[i]["dcAlpha32"]);
                    if (tempdbl > 0)
                        dDurDays += tempdbl;

                    tempdbl = Util.Double(drrows[i]["dcAlpha33"]);
                    if (tempdbl > 0)
                        dActWH += tempdbl;

                    tempdbl = Util.Double(drrows[i]["dcAlpha34"]);
                    if (tempdbl > 0)
                        dActDurDays += tempdbl;

                }
            }
            else if (Parentdr == null && !Util.IsEmpty(drrows[i]["ProductID_Key"]))
                Parentdr = drrows[i];
        }

        if (Totper > 100) {
            this.DisplayMessage = "Percentage exceeds 100";
        }

        if (Parentdr != null) {
            if (minDate) {
                Parentdr["dcAlpha15"] = minDate.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm tt");
                Parentdr["dcAlpha15_Key"] = minDate;
            }
            if (MaxDate) {
                Parentdr["dcAlpha16"] = MaxDate.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm tt");
                Parentdr["dcAlpha16_Key"] = MaxDate;
            }

            if (ActMinDate) {
                Parentdr["dcAlpha22"] = ActMinDate.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm tt");
                Parentdr["dcAlpha22_Key"] = ActMinDate;
            }
            if (ActMaxDate) {
                Parentdr["dcAlpha23"] = ActMaxDate.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm tt");
                Parentdr["dcAlpha23_Key"] = ActMaxDate;
            }


            if (this.dsProjWOffHol != null) {
                let bConsWH = false;
                if (this.ScreenObject.Preferences.ContainsKey("ConsiderWeeklyOffsAndHolidays") && !Util.IsEmpty(this.ScreenObject.Preferences["ConsiderWeeklyOffsAndHolidays"]))
                    bConsWH = parseBoolean(this.ScreenObject.Preferences["ConsiderWeeklyOffsAndHolidays"]);

                if (this.ScreenObject.GridDataColumns.Contains("dcAlpha15_Key") && !Util.IsEmpty(Parentdr["dcAlpha15_Key"]) &&
                    this.ScreenObject.GridDataColumns.Contains("dcAlpha16_Key") && !Util.IsEmpty(Parentdr["dcAlpha16_Key"])) {
                    let dWHrs = 0, dHrsPerDay = 0;
                    let refObj = { odWHrs: dWHrs, odHrsPerDay: dHrsPerDay };
                    let dDays = Util.GetNoOfDays(this.dsProjWOffHol, Util.ParseDate(Parentdr["dcAlpha15_Key"]), Util.ParseDate(Parentdr["dcAlpha16_Key"]), bConsWH, Parentdr, this.DocumentDate, refObj);
                    dWHrs = refObj.odWHrs;
                    dHrsPerDay = refObj.odHrsPerDay;
                    Parentdr["dcAlpha17"] = dDays.toString();
                }

                if (this.ScreenObject.GridDataColumns.Contains("dcAlpha22_Key") && !Util.IsEmpty(Parentdr["dcAlpha22_Key"]) &&
                    this.ScreenObject.GridDataColumns.Contains("dcAlpha23_Key") && !Util.IsEmpty(Parentdr["dcAlpha23_Key"])) {
                    let dWHrs = 0, dHrsPerDay = 0;
                    let refObj = { odWHrs: dWHrs, odHrsPerDay: dHrsPerDay };
                    let dDays = Util.GetNoOfDays(this.dsProjWOffHol, Util.ParseDate(Parentdr["dcAlpha22_Key"]), Util.ParseDate(Parentdr["dcAlpha23_Key"]), bConsWH, Parentdr, this.DocumentDate, refObj);
                    dWHrs = refObj.odWHrs;
                    dHrsPerDay = refObj.odHrsPerDay;
                    Parentdr["dcAlpha24"] = dDays.toString();
                }
            }

            Parentdr["dcAlpha31"] = dWH;
            Parentdr["dcAlpha32"] = dDurDays;

            Parentdr["dcAlpha33"] = dActWH;
            Parentdr["dcAlpha34"] = dActDurDays;
        }

        for (let i = 0; i < cont.keys.length; i++) {
            this.Fill(drrows.filter(x => x[ValueMember] == cont.keys[i]), count + 1, Validate, IsWbs);
        }
    }

    async EditProjectDim(dr: any) {
        if (BaseService.SessionManager.Preferences.ContainsKey("ProjectManagementDimension") && BaseService.SessionManager.Preferences["ProjectManagementDimension"] != "" && BaseService.SessionManager.Preferences["ProjectManagementDimension"] != "0"
            && !Util.IsEmpty(dr["DocDetailsID"]) && parseInt(dr["DocDetailsID"]) > 0) {
            let CostCenterID = parseInt(BaseService.SessionManager.Preferences["ProjectManagementDimension"]);
            let colname = "dcCCNID" + (CostCenterID - 50000);
            let SelVal = this.ScreenObject.GetProjectByINVID(dr["DocDetailsID"].toString(), colname);

            const { AddEditCostcenterComponent } = await import('../../CostCenters/add-edit-costcenter/add-edit-costcenter.component')
            const { AddCostCenterViewModel } = await import('../../CostCenters/add-edit-costcenter/AddCostCenterViewModel')

            let objCost = new AddCostCenterViewModel(CostCenterID);
            objCost.AddCostCenterViewModel_1(SelVal, CostCenterID, 0, "", false);
            BaseService.page.addNewTab({ title: this.ScreenName, component: AddEditCostcenterComponent, params: { obj: objCost } })
        }
    }
    GenerateDoc(dr: any) {
        if (!Util.IsEmpty(dr["DocDetailsID"]) && parseInt(dr["DocDetailsID"]) > 0) {
            if (this.ScreenObject.Data.Tables.length > 20) {
                let drtolink = this.ScreenObject.Data.Tables[20].filter(x => x.CostCenterIDBase > 40000);
                if (drtolink.length == 1) {
                    this.GenerateDocfromProject(parseInt(drtolink[0]["CostCenterIDBase"]));
                }
                else if (drtolink.length > 1) {
                    let gt = new GoToLineViewModel();
                    gt.GoToLineViewModel_3(this, drtolink, 0);
                    BaseService.page.ShowDialog(gt, GoToLineComponent, { ShowCenter: true, NoWidth: true });
                }
            }
        }
    }
    GenerateDocfromProject(cid: number) {
        let dimcid = 0, projCcID = parseInt(BaseService.SessionManager.Preferences["ProjectManagementDimension"]);
        let colname = "dcCCNID" + (projCcID - 50000);
        let SelVal = this.ScreenObject.GetProjectByINVID(this.SelectedRow["DocDetailsID"].toString(), colname);

        let Tolink = new AddEditDocumentViewModel(cid, "", false, this);

        for (let c = 0; c < Tolink.ScreenObject._CCFields.length; c++) {
            let item = Tolink.ScreenObject._CCFields[c]
            if (item instanceof PactListBoxData) {
                if (item.CCID == projCcID) {
                    item.SelectedValue = SelVal;
                }
                else {
                    dimcid = item.CCID;
                    let dimf = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == dimcid);
                    if (dimf instanceof PactListBoxData && dimf.SelectedValue > 0)
                        item.SelectedValue = dimf.SelectedValue;
                    else if (this.ScreenObject.GridDataColumns.Contains("dcCCNID" + (dimcid - 50000))
                        && !Util.IsEmpty(this.SelectedRow["dcCCNID" + (dimcid - 50000) + "_Key"]))
                        item.SelectedValue = parseInt(this.SelectedRow["dcCCNID" + (dimcid - 50000) + "_Key"]);
                }
            }
        }

        if (BaseService.SessionManager.Preferences.ContainsKey("DisableAutoLoad") && BaseService.SessionManager.Preferences["DisableAutoLoad"].toLowerCase() == "true")
            Tolink.ScreenObject.FillListViews(false);

        if (Tolink.DocumentType == 33 || Tolink.DocumentType == 34) {
            if (Tolink.ScreenObject.Link != null) {
                let selectlink = Tolink.ScreenObject.Link.LinkCombo.Items.find(a => a.Parent != null && a.Parent == "158");
                if (selectlink) {
                    Tolink.ScreenObject.Link.LinkCombo.SelectedValue = selectlink.Value;
                    Tolink.OLinkSelectionChanged(null);
                }
            }
            if (this.ScreenObject.Preferences.ContainsKey("jobCCID") && this.ScreenObject.Preferences["jobCCID"].toString() != "" && parseInt(this.ScreenObject.Preferences["jobCCID"]) > 50000
                && this.ScreenObject.Preferences.ContainsKey("StageCCID") && this.ScreenObject.Preferences["StageCCID"].toString() != "" && parseInt(this.ScreenObject.Preferences["StageCCID"]) > 50000
                && this.ScreenObject.Preferences.ContainsKey("BomCCID") && this.ScreenObject.Preferences["BomCCID"].toString() != "" && parseInt(this.ScreenObject.Preferences["BomCCID"]) > 50000) {
                let fld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == parseInt(this.ScreenObject.Preferences["jobCCID"])) as PactListBoxData;

                let BOMID = 0, stageID = 0, StageNodeID = 0;
                colname = "dcCCNID" + (parseInt(this.ScreenObject.Preferences["StageCCID"]) - 50000) + "_Key";
                if (this.ScreenObject.GridDataColumns.Contains(colname) && !Util.IsEmpty(this.SelectedRow[colname]))
                    StageNodeID = parseInt(this.SelectedRow[colname]);

                colname = "dcCCNID" + (parseInt(this.ScreenObject.Preferences["BomCCID"]) - 50000) + "_Key";
                if (this.ScreenObject.GridDataColumns.Contains(colname) && !Util.IsEmpty(this.SelectedRow[colname]))
                    BOMID = parseInt(this.SelectedRow[colname]);

                if (fld && fld.SelectedValue > 0 && BOMID > 0 && StageNodeID > 0) {
                    let linkdoc = Tolink.ScreenObject.Link.DocumentList.Items.find(a => a.Value == fld.SelectedValue.toString());
                    if (linkdoc) {
                        linkdoc.IsChecked = true;

                        let lnkdoc = new LinkDocument(Tolink, fld.Text, parseInt(Tolink.ScreenObject.Link.LinkCombo.SelectedValue), fld.SelectedValue, false);

                        let tempdr = lnkdoc.ds.Tables[0].filter(x => x.CCNodeID == BOMID);
                        if (tempdr.length > 0)
                            BOMID = parseInt(tempdr[0]["BomID"]);

                        if (Util.IsEmpty(lnkdoc.Boms.SelectedValue) || lnkdoc.Boms.SelectedValue != BOMID.toString()) {
                            lnkdoc.Boms.SelectedValue = BOMID.toString();
                            lnkdoc.onBomChanged(lnkdoc.Boms.SelectedValue);
                        }
                        lnkdoc.Boms.SelectedItem = lnkdoc.Boms.GetselectedItem();

                        tempdr = lnkdoc.ds.Tables[3].filter(x => x.BOMID == BOMID && x.StageNodeID == StageNodeID);
                        if (tempdr.length > 0)
                            stageID = parseInt(tempdr[0]["StageID"]);

                        if (Util.IsEmpty(lnkdoc.Stages.SelectedValue) || lnkdoc.Stages.SelectedValue != stageID.toString()) {
                            lnkdoc.Stages.SelectedValue = stageID.toString();
                            lnkdoc.FillJobProducts();
                        }
                        lnkdoc.Stages.SelectedItem = lnkdoc.Stages.GetselectedItem();

                        lnkdoc.GridData.forEach(dr => {
                            if (!Util.IsEmpty(dr["Select"])) {
                                dr["Select"] = true;
                            }
                        });

                        lnkdoc.OnSave("Add");
                        lnkdoc.OnSave("OKNoClose");
                    }
                }
            }
        }
        let pageObj: IPage = { component: AddEditDocumentComponent, params: { obj: Tolink } }
        BaseService.page.addNewTab(pageObj)
    }


    public GenerateRedepositDoc(cid) {
        try {
            let RedepositDoc: boolean = true;
            if (cid == 0 || cid == this.CostCenterID)
                RedepositDoc = false;

            let ToDoc: AddEditDocumentViewModel = null;
            if (RedepositDoc) {
                ToDoc = new AddEditDocumentViewModel(cid, "", false, this);
                if (this.ScreenObject.DebitAccount != null)
                    ToDoc.ScreenObject.DebitAccount.SelectedValue = this.ScreenObject.DebitAccount.SelectedValue;
                if (this.ScreenObject.CreditAccount != null)
                    ToDoc.ScreenObject.CreditAccount.SelectedValue = this.ScreenObject.CreditAccount.SelectedValue;
            }

            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                let CurrID = 1; let ExhgRate = 1;
                if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                    if (this.Currency && !Util.IsEmpty(this.Currency.Currency.SelectedValue))
                        CurrID = parseInt(this.Currency.Currency.SelectedValue);
                    else if (this.ScreenObject.GridDataColumns.Contains("CurrencyID") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CurrencyID_Key"]))
                        CurrID = parseInt(this.ScreenObject.GridData[i]["CurrencyID_Key"]);

                    if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                        ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
                    else if (this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ExchangeRate"]))
                        ExhgRate = parseFloat(this.ScreenObject.GridData[i]["ExchangeRate"]);
                }

                let sb = "";
                let sbbills = "";

                sbbills += "<BillWise><Row  ";
                sb += "<XML><Row  ";

                sb += "DocSeqNo=\"" + this.ScreenObject.GridData[i]["DocSeqNo"].toString() + "\" ";
                sbbills += "DocSeqNo=\"" + this.ScreenObject.GridData[i]["DocSeqNo"].toString() + "\" ";

                if (this.DocumentType == 14 || this.DocumentType == 15) {
                    if (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"])
                        && !Util.IsEmpty(this.ScreenObject.GridData[i]["Amount"])) {
                        sb += "AccountID=\"" + this.ScreenObject.GridData[i]["DebitAccount_Key"].toString() + "\" ";
                        sbbills += "AccountID=\"" + this.ScreenObject.GridData[i]["DebitAccount_Key"].toString() + "\" ";
                    }
                    else {
                        this.ScreenObject.GridData[i]["ReturnXML"] = "";
                        this.ScreenObject.GridData[i]["ExtraXML"] = "";
                        continue;
                    }

                    sb += "AmountFC=\"" + "-" + this.ScreenObject.GridData[i]["Amount"].toString() + "\" ";
                    sb += "AdjAmount=\"" + "-" + (parseFloat(this.ScreenObject.GridData[i]["Amount"]) * ExhgRate) + "\" ";
                    sb += "AdjExchRT=\"" + ExhgRate.toString() + "\" ";

                    sbbills += "AmountFC=\"" + this.ScreenObject.GridData[i]["Amount"].toString() + "\" ";
                    sbbills += "AdjAmount=\"" + (parseFloat(this.ScreenObject.GridData[i]["Amount"]) * ExhgRate) + "\" ";
                }
                else {
                    if (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"])
                        && !Util.IsEmpty(this.ScreenObject.GridData[i]["Amount"])) {
                        sb += "AccountID=\"" + this.ScreenObject.GridData[i]["CreditAccount_Key"].toString() + "\" ";
                        sbbills += "AccountID=\"" + this.ScreenObject.GridData[i]["CreditAccount_Key"].toString() + "\" ";
                    }
                    else {
                        this.ScreenObject.GridData[i]["ReturnXML"] = "";
                        this.ScreenObject.GridData[i]["ExtraXML"] = "";
                        continue;
                    }

                    sb += "AmountFC=\"" + this.ScreenObject.GridData[i]["Amount"].toString() + "\" ";
                    sb += "AdjAmount=\"" + parseFloat(this.ScreenObject.GridData[i]["Amount"]) * ExhgRate + "\" ";
                    sb += "AdjExchRT=\"" + ExhgRate.toString() + "\" ";

                    sbbills += "AmountFC=\"" + "-" + this.ScreenObject.GridData[i]["Amount"].toString() + "\" ";
                    sbbills += "AdjAmount=\"" + "-" + (parseFloat(this.ScreenObject.GridData[i]["Amount"]) * ExhgRate) + "\" ";
                }

                sb += "AdjCurrID=\"" + CurrID.toString() + "\" ";

                sb += "IsNewReference=\"" + "0" + "\" ";
                sb += "RefDocNo=\"" + this.ScreenObject.VoucherNo + "\" ";
                sb += "RefDocSeqNo=\"" + this.ScreenObject.GridData[i]["DocSeqNo"].toString() + "\" ";
                sb += "RefDocDate=\"" + this.DocumentDate.ToString("dd/MMM/yyyy") + "\" ";
                if (this.ScreenObject.DueDate != null && this.ScreenObject.DueDate.Date)
                    sb += "RefDocDueDate=\"" + this.ScreenObject.DueDate.Date.ToString("dd/MMM/yyyy") + "\" ";
                sb += "Narration=\"\" ";
                sb += "IsDocPDC=\"" + "0" + "\" >";
                sb += " </Row>";

                sb += " </XML>";

                sbbills += "AdjCurrID=\"" + ExhgRate.toString() + "\" ";
                sbbills += "AdjExchRT=\"" + ExhgRate.toString() + "\" ";
                sbbills += "IsNewReference=\"" + "1" + "\" ";
                sbbills += "Narration=\"" + "" + "\" ";
                sbbills += "IsDocPDC=\"" + "0" + "\" ";
                sbbills += " ></Row>";
                sbbills += " </BillWise>";


                if (RedepositDoc) {
                    if (ToDoc != null && this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key")) {
                        if (ToDoc.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && this.ScreenObject.GridData[i]["DebitAccount_Key"].toString() != "")
                            ToDoc.ScreenObject.GridData[i]["DebitAccount_Key"] = this.ScreenObject.GridData[i]["DebitAccount_Key"].toString();
                        else
                            ToDoc.ScreenObject.DebitAccount.SelectedValue = parseInt(this.ScreenObject.GridData[i]["DebitAccount_Key"].toString());
                    }
                    if (ToDoc != null && this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key")) {
                        if (ToDoc.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && this.ScreenObject.GridData[i]["CreditAccount_Key"].toString() != "")
                            ToDoc.ScreenObject.GridData[i]["CreditAccount_Key"] = this.ScreenObject.GridData[i]["CreditAccount_Key"].toString();
                        else
                            ToDoc.ScreenObject.CreditAccount.SelectedValue = parseInt(this.ScreenObject.GridData[i]["CreditAccount_Key"].toString());
                    }
                    ToDoc.ScreenObject.ColumnSource.forEach(cccol => {
                        var datacol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == cccol.DisplayMember.toLowerCase());

                        if (datacol != null && cccol.CostCenterID > 50000 && this.ScreenObject.GridDataColumns.Contains(cccol.DisplayMember) && this.ScreenObject.GridData[i][cccol.DisplayMember].toString() != "") {
                            if (this.ScreenObject.GridDataColumns.Contains(cccol.DisplayMember + "_Key") && this.ScreenObject.GridDataColumns.Contains(cccol.ValueMember)) {
                                let TempId = 0;
                                if (Util.DoubleTryParse(this.ScreenObject.GridData[i][datacol.ValueMember].toString()) > 0) {
                                    ToDoc.ScreenObject.GridData[i][datacol.ValueMember] = TempId;
                                    ToDoc.ScreenObject.GridData[i][datacol.DisplayMember] = this.ScreenObject.GridData[i][datacol.DisplayMember].toString();
                                }
                            }
                        }
                        else if (datacol != null) {
                            if (datacol.DisplayMember == "DocDetailsID" || datacol.CostCenterID == 2 || datacol.DisplayMember == "LinkedInvDocDetailsID" || datacol.DisplayMember == "RefNo" || datacol.DisplayMember == "LinkedFieldName")
                                return;
                            let Resvalue = ""; let dttmp;
                            if (datacol.DataType == "DATE") {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"]) && Util.isValidDate(this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"])) {
                                    ToDoc.ScreenObject.GridData[i][cccol.DisplayMember] = new Date(this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"].toString()).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                    ToDoc.ScreenObject.GridData[i][cccol.DisplayMember + "_Key"] = new Date(this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"].toString());
                                }
                            }
                            else if ((datacol.DataType == "DATETIME" || datacol.DataType == "TIME") && Util.isValidDate(this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"].toString())) {
                                if (this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"].toString() != "") {

                                    ToDoc.ScreenObject.GridData[i][cccol.DisplayMember + "_Key"] = new Date(this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"].toString());
                                    ToDoc.ScreenObject.GridData[i][cccol.DisplayMember] = new Date(this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"].toString()).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                                }
                            }
                            else if ((datacol.DataType == "Time2") && Util.isValidDate(this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"].toString())) {
                                if (this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"].toString() != "") {
                                    ToDoc.ScreenObject.GridData[i][cccol.DisplayMember + "_Key"] = new Date(this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"].toString());
                                    ToDoc.ScreenObject.GridData[i][cccol.DisplayMember] = new Date(this.ScreenObject.GridData[i][datacol.DisplayMember + "_Key"].toString()).ToString("HH:mm");
                                }
                            }
                            else if (datacol.DataType == "ComboBox")
                                ToDoc.ScreenObject.GridData[i][cccol.ValueBinding] = this.ScreenObject.GridData[i][datacol.ValueBinding].toString();
                            else if (datacol.DataType == "PactComboBox") {
                                ToDoc.ScreenObject.GridData[i][cccol.ValueBinding] = this.ScreenObject.GridData[i][datacol.ValueBinding + "_Key"].toString();;
                                ToDoc.ScreenObject.GridData[i][cccol.ValueBinding + "_Key"] = this.ScreenObject.GridData[i][datacol.ValueBinding + "_Key"].toString();;
                            }
                            else if (["int", "double", "float"].Contains(ToDoc.ScreenObject.ColumnSource.find(x => x.DisplayMember == cccol.DisplayMember).DataType.toLowerCase())) {
                                let tempdbl = Util.DoubleTryParse(this.ScreenObject.GridData[i][datacol.DisplayMember].toString());
                                ToDoc.ScreenObject.GridData[i][cccol.DisplayMember] = tempdbl;
                            }
                            else
                                ToDoc.ScreenObject.GridData[i][cccol.DisplayMember] = this.ScreenObject.GridData[i][datacol.DisplayMember].toString();

                        }
                    });

                    ToDoc.ScreenObject.GridData[i]["DocDetailsID"] = 0;
                    ToDoc.ScreenObject.GridData[i]["ReturnXML"] = sb.toString();
                    // if (ToDoc.ScreenObject.GridData[i]["Type"].toString() != "" && parseBoolean(ToDoc.ScreenObject.GridData[i]["Type"].toString())
                    ToDoc.ScreenObject.GridData[i]["ExtraXML"] = sbbills.toString();
                    ToDoc.CalculateTotals(ToDoc.ScreenObject.GridData[i], false);
                    //ToDoc.ScreenObject.GridData.AcceptChanges();

                }
                else {
                    this.ScreenObject.GridData[i]["DocDetailsID"] = 0;
                    this.ScreenObject.GridData[i]["ReturnXML"] = sb;
                    if (parseBoolean(this.ScreenObject.GridData[i]["Type"]) == true)
                        this.ScreenObject.GridData[i]["ExtraXML"] = sbbills.toString();
                }
            }
            if (RedepositDoc) {
                ToDoc.ScreenObject._CCFields.forEach(ccfld => {
                    var frmfld = this.ScreenObject._CCFields.find(x => x.DBColumnName.toLowerCase() == ccfld.DBColumnName.toLowerCase());
                    if (ccfld instanceof PactListBoxData && ccfld.CCID > 50000 && frmfld != null && frmfld instanceof PactListBoxData) {
                        ccfld.SelectedValue = frmfld.SelectedValue;
                    }
                });

                ToDoc.ScreenObject._TextFields.forEach(ccfld => {
                    var frmfld = this.ScreenObject._TextFields.find(x => x.DBColumnName.toLowerCase() == ccfld.DBColumnName.toLowerCase());
                    if (frmfld != null && ccfld instanceof PactControlData) {
                        let Val = this.ScreenObject.GetcontrolValue(frmfld);
                        this.ScreenObject.fillcontrolValue(ccfld, Val);
                    }
                });
                ToDoc.ScreenObject._numericFields.forEach(ccfld => {
                    var frmfld = this.ScreenObject._numericFields.find(x => x.DBColumnName.toLowerCase() == ccfld.DBColumnName.toLowerCase());
                    if (frmfld != null && ccfld instanceof PactControlData) {
                        let Val = this.ScreenObject.GetcontrolValue(frmfld);
                        this.ScreenObject.fillcontrolValue(ccfld, Val);
                    }
                });
                ToDoc.ScreenObject._StaticFields.forEach(ccfld => {
                    var frmfld = this.ScreenObject._StaticFields.find(x => x.DBColumnName.toLowerCase() == ccfld.DBColumnName.toLowerCase());
                    if (frmfld != null && ccfld instanceof PactControlData) {
                        let Val = this.ScreenObject.GetcontrolValue(frmfld);
                        this.ScreenObject.fillcontrolValue(ccfld, Val);
                    }
                });

                let retObj: IPage = { component: AddEditDocumentComponent, params: { obj: ToDoc } }
                BaseService.page.addNewTab(retObj);
            }
            else {
                this.DocStatus = "[" + BaseService.GetResource("Doc_Draft") + "]";
                this.ScreenObject.DocID = 0;
                this.ScreenObject.RefCCId = 0;
                this.ScreenObject.RefNodeID = 0;
                this.DocumentDate = Date.Today();
                this.SetNewDocButtonVisibility();
                let DS: any = BaseService.document.getcurrentcode(this.ScreenObject.CostCenterID, this.ScreenObject.Prefix);
                if (DS != null && DS.Tables.length > 0 && DS.Tables[0].length > 0 && !DS.Columns[0].Contains("ErrorMessage") && DS.Columns[0].Contains("CurrentCodeNumber") && DS.Tables[0][0]["CurrentCodeNumber"].toString().trim() != "") {
                    this.ScreenObject.DocPrefix.TextBox.Text = DS.Tables[0][0]["CurrentCodeNumber"].toString();
                }
            }
        }
        catch (error) {
            Logger.ErrorLog("Generate re deposit document getting error" + error);
        }
        return true;
    }

    public LinkDoc(LinkCC, linkDoc) {
        if (this.ScreenObject.Link != null && this.ScreenObject.Link.LinkCombo != null) {
            if (this.ScreenObject.Link.LinkCombo.Items.length == 1 && this.ScreenObject.Link.LinkCombo.Items[0].Parent == LinkCC) {
                this.ScreenObject.Link.LinkCombo.SelectedValue = this.ScreenObject.Link.LinkCombo.Items[0].Value;
                this.OLinkSelectionChanged(null);
            }
            else {
                var selectlink = this.ScreenObject.Link.LinkCombo.Items.find(a => a.Parent != null && a.Parent == LinkCC);
                if (selectlink != null) {
                    this.ScreenObject.Link.LinkCombo.SelectedValue = selectlink.Value;
                    this.OLinkSelectionChanged(null);
                }
            }
            var linkdoc = this.ScreenObject.Link.DocumentList.Items.find(a => a.Value == linkDoc);
            if (linkdoc != null) {
                linkdoc.IsChecked = true;
                this.OnLinkDocumentCheckedChanged(linkdoc);
                if (!this.DialogResult)
                    return false;
            }
            else
                return false;
        }
        return true;
    }


    public FillWBS(Validate: boolean) {
        let tmpint: number;
        let ValueMember = "";

        if (BaseService.SessionManager.Preferences.ContainsKey("ProjectManagementDimension") && Util.IsNum(BaseService.SessionManager.Preferences["ProjectManagementDimension"])) {
            tmpint = parseInt(BaseService.SessionManager.Preferences["ProjectManagementDimension"]);
            let fld = this.ScreenObject._TextFields.find(a => a instanceof PactListBoxData && a.CCID == tmpint) as PactListBoxData;
            if (fld && fld.SelectedValue > 0) {
                ValueMember = this.ScreenObject.GetDocNumberString("Code", tmpint, fld.SelectedValue);
            }
        }


        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {//this.ScreenObject.GridData[i].RowState != DataRowState.Detached && 
            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                if (!(!Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"]) && parseInt(this.ScreenObject.GridData[i]["DocDetailsID"]) > 0))
                    this.ScreenObject.GridData[i]["dcAlpha11"] = ValueMember;
            }
        }
        this.Fill(this.ScreenObject.GridData, 1, Validate, true);
        tmpint = 1;
        while (tmpint < 4) {
            if (BaseService.SessionManager.Preferences.ContainsKey("PMLevel" + tmpint.toString() + "Dimension") && !Util.IsEmpty(BaseService.SessionManager.Preferences["PMLevel" + tmpint.toString() + "Dimension"]) && BaseService.SessionManager.Preferences["PMLevel" + tmpint.toString() + "Dimension"] != "0"
                && this.ScreenObject.GridDataColumns.Contains("dcccnid" + (parseInt(BaseService.SessionManager.Preferences["PMLevel" + tmpint.toString() + "Dimension"]) - 50000) + "_Key"))
                this.Fill(this.ScreenObject.GridData, 1, Validate, false);
            else
                break;
            tmpint++;
        }
    }

    FillHeaderDictionary() {
        this.ScreenObject._CCFields.forEach(item => {
            if (this.fldDict.ContainsKey(item.Lbl)) {
                if (item instanceof PactListBoxData && item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                    this.fldDict[item.Lbl].setFieldValue(item.Text);
                else if (item instanceof PactCodeNameListBoxData && item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                    this.fldDict[item.Lbl].setFieldValue(item.Text);
                else
                    this.fldDict[item.Lbl].setFieldValue("");

                if (this.FooterDics.ContainsKey(item.Lbl)) {
                    this.FooterDics[item.Lbl].setFieldValue(this.fldDict[item.Lbl].fieldResult);
                }
            }
        });
        this.ScreenObject.HeaderFields.forEach(item => {
            if (item instanceof PactControlData && !Util.IsEmpty(item.Lbl) && this.fldDict.ContainsKey(item.Lbl)) {
                if (item instanceof PactTextBoxData) {
                    if (item.DataType == "FLOAT") {
                        if (item.Text != null && item.Text != "" && item.ValidateData() == "")
                            this.fldDict[item.Lbl].setFieldValue(item.Text);
                        else
                            this.fldDict[item.Lbl].setFieldValue(0);
                    }
                    else
                        this.fldDict[item.Lbl].setFieldValue(item.Text);
                }
                else if (item instanceof PactComboBoxData)
                    this.fldDict[item.Lbl].setFieldValue(item.SelectedValue);
                else if (item instanceof PactSelectionBoxData)
                    this.fldDict[item.Lbl].setFieldValue(item.Text);
                else if (item instanceof PactExtraFieldDateData && item.Date)
                    this.fldDict[item.Lbl].setFieldValue(item.Date);
                else if (item instanceof PactListBoxData) {
                    if (item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                        this.fldDict[item.Lbl].setFieldValue(item.Text);
                    else
                        this.fldDict[item.Lbl].setFieldValue("");
                }
                else if (item instanceof PactCurrencyData)
                    this.fldDict[item.Lbl].setFieldValue(item.Currency.Text);
                if (this.FooterDics.ContainsKey(item.Lbl)) {
                    this.FooterDics[item.Lbl].setFieldValue(this.fldDict[item.Lbl].fieldResult);
                }
            }
        });

        this.ScreenObject._TextFields.forEach(item => {
            if (this.fldDict.ContainsKey(item.Lbl)) {
                if (item instanceof PactTextBoxData) {
                    if (item.DataType == "FLOAT") {
                        if (item.Text != null && item.Text != "" && item.ValidateData() == "")
                            this.fldDict[item.Lbl].setFieldValue(item.Text);
                        else
                            this.fldDict[item.Lbl].setFieldValue(0);
                    }
                    else
                        this.fldDict[item.Lbl].setFieldValue(item.Text);
                }
                else if (item instanceof PactComboBoxData)
                    this.fldDict[item.Lbl].setFieldValue(item.SelectedValue);
                else if (item instanceof PactSelectionBoxData)
                    this.fldDict[item.Lbl].setFieldValue(item.Text);
                else if (item instanceof PactExtraFieldDateData && item.Date)
                    this.fldDict[item.Lbl].setFieldValue(item.Date);
                else if (item instanceof PactDateTimeData && item.Date)
                    this.fldDict[item.Lbl].setFieldValue(item.Date);
                else if (item instanceof PactListBoxData) {
                    if (item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                        this.fldDict[item.Lbl].setFieldValue(item.Text);
                    else
                        this.fldDict[item.Lbl].setFieldValue("");
                }
                if (this.FooterDics.ContainsKey(item.Lbl)) {
                    this.FooterDics[item.Lbl].setFieldValue(this.fldDict[item.Lbl].fieldResult);
                }
            }
        });

        if (this.ScreenObject.DebitAccount != null && this.fldDict.ContainsKey(this.ScreenObject.DebitAccount.Lbl)) {
            if (this.ScreenObject.DebitAccount.SelectedValue > 0 && this.ScreenObject.DebitAccount.Name.Visible && !Util.IsEmpty(this.ScreenObject.DebitAccount.Name.Text))
                this.fldDict[this.ScreenObject.DebitAccount.Lbl].setFieldValue(this.ScreenObject.DebitAccount.Name.Text);
            else if (this.ScreenObject.DebitAccount.SelectedValue > 0 && this.ScreenObject.DebitAccount.Code.Visible && !Util.IsEmpty(this.ScreenObject.DebitAccount.Code.Text))
                this.fldDict[this.ScreenObject.DebitAccount.Lbl].setFieldValue(this.ScreenObject.DebitAccount.Code.Text);
            else
                this.fldDict[this.ScreenObject.DebitAccount.Lbl].setFieldValue("");
        }
        if (this.ScreenObject.CreditAccount != null && this.fldDict.ContainsKey(this.ScreenObject.CreditAccount.Lbl)) {
            if (this.ScreenObject.CreditAccount.SelectedValue > 0 && this.ScreenObject.CreditAccount.Name.Visible && !Util.IsEmpty(this.ScreenObject.CreditAccount.Name.Text))
                this.fldDict[this.ScreenObject.CreditAccount.Lbl].setFieldValue(this.ScreenObject.CreditAccount.Name.Text);
            else if (this.ScreenObject.CreditAccount.SelectedValue > 0 && this.ScreenObject.CreditAccount.Code.Visible && !Util.IsEmpty(this.ScreenObject.CreditAccount.Code.Text))
                this.fldDict[this.ScreenObject.CreditAccount.Lbl].setFieldValue(this.ScreenObject.CreditAccount.Code.Text);
            else
                this.fldDict[this.ScreenObject.CreditAccount.Lbl].setFieldValue("");
        }

        if (this.Currency != null && !Util.IsEmpty(this.Currency.Currency.SelectedValue))
            this.fldDict["Currency"].setFieldValue(this.Currency.Currency.GetText());
        else
            this.fldDict["Currency"].setFieldValue('');

        this.fldDict["DOCDATE"].setFieldValue(this.DocumentDate);
        if (this.ScreenObject.DocPrefix != null && this.ScreenObject.DocPrefix.ComboBox != null && !Util.IsEmpty(this.ScreenObject.DocPrefix.ComboBox.Text))
            this.fldDict["DocPrefix"].setFieldValue(this.ScreenObject.DocPrefix.ComboBox.Text);
        else
            this.fldDict["DocPrefix"].setFieldValue("");
        if (this.ScreenObject.DueDate != null && this.ScreenObject.DueDate.Date)
            this.fldDict["DUEDATE"].setFieldValue(this.ScreenObject.DueDate.Date);
        else
            this.fldDict["DUEDATE"].setFieldValue(Date.Today());
        let bildate = this.ScreenObject._StaticFields.find(a => a.DBColumnName.toLowerCase() == "billdate");
        if (bildate && bildate instanceof PactExtraFieldDateData && bildate.Date)
            this.fldDict["BILLDATE"].setFieldValue(bildate.Date);
        else
            this.fldDict["BILLDATE"].setFieldValue(Date.Today());
        let maturitydate = this.ScreenObject._StaticFields.find(a => a.DBColumnName.toLowerCase() == "chequematuritydate");
        if (maturitydate && maturitydate instanceof PactExtraFieldDateData && maturitydate.Date)
            this.fldDict["MaturityDate"].setFieldValue(maturitydate.Date);
        else
            this.fldDict["MaturityDate"].setFieldValue(Date.Today());

        if (this.FooterDics.ContainsKey("BILLDATE")) {
            this.FooterDics["BILLDATE"].setFieldValue(this.fldDict["BILLDATE"].fieldResult);
        }
        if (this.FooterDics.ContainsKey("DUEDATE")) {
            this.FooterDics["DUEDATE"].setFieldValue(this.fldDict["DUEDATE"].fieldResult);
        }
        if (this.FooterDics.ContainsKey("DOCDATE")) {
            this.FooterDics["DOCDATE"].setFieldValue(this.fldDict["DOCDATE"].fieldResult);
        }
    }

    FillDictionary(dr: any[], CalAvgRate: boolean) {
        let Fldstr = '';
        try {
            let oCols: DgColumn[] = this.ScreenObject.ColumnSource;
            let ExhgRate = 1;
            let tempdbl: number = 0;
            if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                if (this.Currency && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                    ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
                else if (dr != null && this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && !Util.IsEmpty(dr["ExchangeRate"]))
                    ExhgRate = parseFloat(dr["ExchangeRate"]);
            }
            if (dr != null) {
                this.fldDict.keys.forEach(dicKey => {
                    let item = { Key: dicKey, Value: this.fldDict[dicKey] }
                    if (item.Key == "ServerDate")
                        return;
                    let col = oCols.find(a => a.lbl == (this.fldDict[item.Key].getFieldName()));

                    if (col != undefined && col.DataType == "ComboBox" && !Util.IsEmpty(dr[col.ValueBinding]))
                        this.fldDict[item.Key].setFieldValue(dr[col.ValueBinding]);
                    else if (col != undefined && col.DataType == "PactComboBox" && !Util.IsEmpty(dr[col.ValueBinding + "_Key"]))
                        this.fldDict[item.Key].setFieldValue(dr[col.ValueBinding + "_Key"]);
                    else if (col != undefined && (col.DataType == "DATE" || col.DataType == "DATETIME" || col.DataType == "TIME") && !Util.IsEmpty(dr[col.DisplayMember + "_Key"]))
                        this.fldDict[item.Key].setFieldValue(dr[col.DisplayMember + "_Key"]);
                    else if (col != undefined && col.DataType == "LISTBOX" && !Util.IsEmpty(dr[col.DisplayMember]))
                        this.fldDict[item.Key].setFieldValue(dr[col.DisplayMember].toString());
                    else if (col != undefined && col.DataType != "ComboBox" && col.DataType != "DATE" && col.DataType != "LISTBOX" && col.DataType != "DATETIME" && col.DataType != "TIME" && col.DataType != "PactComboBox" && !Util.IsEmpty(dr[col.DisplayMember])) {
                        if (Util.IsNum(dr[col.DisplayMember])) {
                            if (!Util.IsEmpty(col.DecimalPoints))
                                this.fldDict[item.Key].setFieldValue(parseFloat(dr[col.DisplayMember].toString()).ToString("N" + col.DecimalPoints));
                            else
                                this.fldDict[item.Key].setFieldValue(dr[col.DisplayMember]);
                        }
                        else
                            this.fldDict[item.Key].setFieldValue(dr[col.DisplayMember]);
                    }
                    else if (item.Key.endsWith("Curr")) {
                        //col = oCols.find(a => a.lbl == (this.fldDict[item.Key.substr(0, item.Key.length - 4)].getFieldName()) && a.DisplayMember != null && a.DisplayMember.toLowerCase().startsWith("dcnum"));
                        let fldname = item.Key.substr(0, item.Key.length - 4);
                        if (this.fldDict.ContainsKey(fldname))
                            fldname = this.fldDict[fldname].getFieldName();
                        col = oCols.find(a => a.lbl == fldname && a.DisplayMember != null && a.DisplayMember.toLowerCase().startsWith("dcnum"));
                        if (col != undefined && col.DefaultValue == "-2") {
                            if (this.ScreenObject.GridDataColumns.Contains("dcCurrID" + col.DisplayMember.toLowerCase().replace("dcnum", "") + "_Key") &&
                                dr["dcCurrID" + col.DisplayMember.toLowerCase().replace("dcnum", "") + "_Key"].toString() != "")
                                this.fldDict[item.Key].setFieldValue(dr["dcCurrID" + col.DisplayMember.toLowerCase().replace("dcnum", "")].toString());
                            else
                                this.fldDict[item.Key].setFieldValue('');
                        }
                        else
                            this.fldDict[item.Key].setFieldValue('');
                    }
                    else if (item.Key.endsWith("EXRT")) {
                        //col = oCols.find(a => a.lbl == (this.fldDict[item.Key.substr(0, item.Key.length - 4)].getFieldName()) && a.DisplayMember != null && a.DisplayMember.toLowerCase().startsWith("dcnum"));
                        let fldname = item.Key.substr(0, item.Key.length - 4);
                        if (this.fldDict.ContainsKey(fldname))
                            fldname = this.fldDict[fldname].getFieldName();

                        col = oCols.find(a => a.lbl == fldname && a.DisplayMember != null && a.DisplayMember.toLowerCase().startsWith("dcnum"));
                        if (col != undefined) {
                            if (col.DefaultValue == "-1") {
                                this.fldDict[item.Key].setFieldValue(ExhgRate);
                            }
                            else if (col.DefaultValue == "-2") {
                                if (this.ScreenObject.GridDataColumns.Contains(col.DisplayMember.replace("dcNum", "dcExchRT")) && !Util.IsEmpty(dr[col.DisplayMember.Replace("dcNum", "dcExchRT")]))
                                    this.fldDict[item.Key].setFieldValue(dr[col.DisplayMember.replace("dcNum", "dcExchRT")].toString());
                                else
                                    this.fldDict[item.Key].setFieldValue(1);
                            }
                            else {
                                let def = Util.Double(col.DefaultValue);
                                if (def > 0 && col.CurrID > 0) {
                                    this.fldDict[item.Key].setFieldValue(col.ExhcgRt);
                                }
                                else
                                    this.fldDict[item.Key].setFieldValue(1);
                            }
                        }
                        else
                            this.fldDict[item.Key].setFieldValue(1);
                    }
                    else if (item.Key.toLowerCase().startsWith("calc") && !item.Key.toLowerCase().startsWith("calculate")) {
                        col = oCols.find(a => a.lbl == (this.fldDict[item.Key.substr(4)].getFieldName()) && a.DisplayMember != null && a.DisplayMember.toLowerCase().startsWith("dcnum"));
                        if (col != undefined && col.DataType != "ComboBox" && col.DataType != "PactComboBox" && !Util.IsEmpty(dr[col.DisplayMember])) {
                            if (Util.IsNum(dr["dcCalc" + col.DisplayMember])) {
                                if (!Util.IsEmpty(col.DecimalPoints))
                                    this.fldDict[item.Key].setFieldValue(parseFloat(dr["dcCalc" + col.DisplayMember].toString()).ToString("N" + col.DecimalPoints));
                                else
                                    this.fldDict[item.Key].setFieldValue(dr["dcCalc" + col.DisplayMember]);
                            }
                            else
                                this.fldDict[item.Key].setFieldValue(dr["dcCalc" + col.DisplayMember]);
                        }
                        else
                            this.fldDict[item.Key].setFieldValue(0);
                    }
                    else if (col != undefined && (col.DataType == "STRING" || col.DataType == "TEXT" || col.DataType == "LISTBOX" || col.DataType == "LINK"))
                        this.fldDict[item.Key].setFieldValue("");
                    else if (item.Key == "NET")
                        this.fldDict[item.Key].setFieldValue(this.NetAmount);
                    else
                        this.fldDict[item.Key].setFieldValue(0);

                    if (CalAvgRate && col != undefined && col.Formula != null && col.Formula.Contains("AVGRATE"))
                        this.fldDict[item.Key].setFieldValue(0);

                });

                if (this.IsInventoryVoucher) {
                    if (!Util.IsEmpty(dr["Rate"]))
                        this.fldDict["RATE"].setFieldValue(dr["Rate"]);
                    else
                        this.fldDict["RATE"].setFieldValue(0);
                    if (!Util.IsEmpty(dr["Quantity"]))
                        this.fldDict["QTY"].setFieldValue(dr["Quantity"]);
                    else
                        this.fldDict["QTY"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["FreeQTY"]))
                        this.fldDict["FreeQTY"].setFieldValue(dr["FreeQTY"]);
                    else
                        this.fldDict["FreeQTY"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["Gross"]))
                        this.fldDict["GROSS"].setFieldValue(dr["Gross"]);
                    else
                        this.fldDict["GROSS"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["UOMConvertedQty"]))
                        this.fldDict["CONVQTY"].setFieldValue(dr["UOMConvertedQty"]);
                    else
                        this.fldDict["CONVQTY"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["UOMConversion"]))
                        this.fldDict["UOMCONVERSION"].setFieldValue(dr["UOMConversion"]);
                    else
                        this.fldDict["UOMCONVERSION"].setFieldValue(1);

                    if (!Util.IsEmpty(dr["LASTPURCHASERATE"]))
                        this.fldDict["LSTPRCHSRT"].setFieldValue(dr["LASTPURCHASERATE"]);
                    else
                        this.fldDict["LSTPRCHSRT"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["AVGRATE"]))
                        this.fldDict["AVGRT"].setFieldValue(dr["AVGRATE"]);
                    else
                        this.fldDict["AVGRT"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["SRate"]))
                        this.fldDict["SRate"].setFieldValue(dr["SRate"]);
                    else
                        this.fldDict["SRate"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["RRate"]))
                        this.fldDict["RRate"].setFieldValue(dr["RRate"]);
                    else
                        this.fldDict["RRate"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["MRate"]))
                        this.fldDict["MRate"].setFieldValue(dr["MRate"]);
                    else
                        this.fldDict["MRate"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["QOH"]))
                        this.fldDict["QOH"].setFieldValue(dr["QOH"]);
                    else
                        this.fldDict["QOH"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["BalQOH"]))
                        this.fldDict["BalQOH"].setFieldValue(dr["BalQOH"]);
                    else
                        this.fldDict["BalQOH"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["HOLDQTY"]))
                        this.fldDict["HOLDQTY"].setFieldValue(dr["HOLDQTY"]);
                    else
                        this.fldDict["HOLDQTY"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["CommittedQty"]))
                        this.fldDict["CommittedQty"].setFieldValue(dr["CommittedQty"]);
                    else
                        this.fldDict["CommittedQty"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["RESERVEQTY"]))
                        this.fldDict["RESERVEQTY"].setFieldValue(dr["RESERVEQTY"]);
                    else
                        this.fldDict["RESERVEQTY"].setFieldValue(0);

                    if (!Util.IsEmpty(dr["TotalReserve"]))
                        this.fldDict["TotalReserve"].setFieldValue(dr["TotalReserve"]);
                    else
                        this.fldDict["TotalReserve"].setFieldValue(0);
                }
            }

            this.FillHeaderDictionary();

            this.fldDict["EXCHRT"].setFieldValue(ExhgRate);
            if (this.FooterDics.ContainsKey("EXCHRT")) {
                this.FooterDics["EXCHRT"].setFieldValue(this.fldDict["EXCHRT"].fieldResult);
            }
        }
        catch (ex) {
            this.DisplayMessage = "Problem filling Dictionary,try again";
            this.MessageVisibility = true;
            //Logger.ErrorLog("Addeditdocumentviewmodel", "Formua filling Dictionary column:" + Fldstr, ex.Message, ex);
            console.log("Addeditdocumentviewmodel", "Formua filling Dictionary column:" + Fldstr, ex.Message, ex);
        }
    }

    drcc1: any[]; drcc2: any[];
    sHrs: string[];

    DontChVlue(dr: any, col: DgColumn, vl: number): boolean {
        if (col.DisplayMember == "Gross" && !Util.IsEmpty(dr[col.DisplayMember]) && !Util.IsEmpty(col.DecimalPoints)) {
            var res = (parseFloat(dr[col.DisplayMember].toString()) - vl).toString().split('.');

            if (res.length > 0 && parseFloat(res[0]) == 0 && res.length > 1 && res[1].length > parseInt(col.DecimalPoints) && parseFloat(res[1].substr(0, parseInt(col.DecimalPoints))) == 0)
                return true;
        }

        return false;
    }

    CalculateTotals(dr: any, CalAvgRate: boolean, BindingPath: string = "", CalcFooter: boolean = true) {
        let Formula = "";
        try {
            //if (System.Web.HttpContext.Current == null && !this.ScreenObject.IsForecast || BaseService.SessionManager.IsWebApplication == true && !this.ScreenObject.IsForecast)//OR cond instanceof for web purpose
            {
                if (this.ScreenObject.GridData == null || (dr != null && this.IsInventoryVoucher && Util.IsEmpty(dr["ProductID_Key"])))
                    return;

                if (dr != null && !this.IsInventoryVoucher && this.ScreenObject.GridDataColumns.Contains("Denomination"))
                    dr["Denomination"] = "Denominations";

                let ExhgRate: number = 1;
                let CurrencyID: number = 1;
                if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                    if (this.Currency && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "") {
                        ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
                        if (!Util.IsEmpty(this.Currency.Currency.SelectedValue))
                            CurrencyID = parseInt(this.Currency.Currency.SelectedValue);
                    }
                    else if (dr != null && this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && !Util.IsEmpty(dr["ExchangeRate"])) {
                        ExhgRate = parseFloat(dr["ExchangeRate"]);
                        if (this.ScreenObject.GridDataColumns.Contains("CurrencyID_Key") && !Util.IsEmpty(dr["CurrencyID_Key"]))
                            CurrencyID = parseInt(dr["CurrencyID_Key"]);
                    }
                }
                this.GridNetTotal = 0;
                let oCols = this.ScreenObject.ColumnSource;

                this.FillDictionary(dr, CalAvgRate);


                let dblFooter = 0, dblCalcLc = 0, dblCalcFooter = 0; let temp = this.fldDict;
                let resval: any; let tempdbl: number;
                if (BindingPath != "" && dr != null) {
                    let cccol: DgColumn;
                    cccol = oCols.find(a => a.DisplayMember == BindingPath);
                    if (cccol && !Util.IsEmpty(cccol.DecimalPoints) && !Util.IsEmpty(dr[BindingPath]) && cccol.DataType == "FLOAT") {
                        if (!cccol.NoRoundOff)//&& (cccol.DisplayMember == "Quantity" || cccol.DisplayMember == "Rate")))
                            dr[cccol.DisplayMember] = parseFloat(dr[BindingPath]).ToString("N" + cccol.DecimalPoints);
                        this.fldDict[cccol.lbl].setFieldValue(dr[BindingPath].toString());

                        if (cccol.DisplayMember == "Gross")
                            this.fldDict["GROSS"].setFieldValue(dr["Gross"]);
                        else if (cccol.DisplayMember == "Quantity")
                            this.fldDict["QTY"].setFieldValue(Util.String(dr["Quantity"]));
                        else if (cccol.DisplayMember == "Rate")
                            this.fldDict["RATE"].setFieldValue(Util.String(dr["Rate"]));
                    }
                    cccol = null;
                    cccol = oCols.find(a => !Util.IsEmpty(a.FilterCondition) && !Util.IsEmpty(a.DisplayMember) && a.DisplayMember.toLowerCase().Contains("dcnum") && a.FilterCondition.toLowerCase() == BindingPath.toLowerCase());
                    if (cccol)
                        BindingPath = cccol.DisplayMember;
                    else {
                        if (BindingPath.toLowerCase() == "productid")
                            BindingPath = "Gross";
                        else if (BindingPath.toLowerCase() == "gross")
                            BindingPath = "Rate";
                        else if (BindingPath.toLowerCase() == "rate" || BindingPath.toLowerCase() == "quantity" || BindingPath.toLowerCase() == "unit") {
                            if (BindingPath == "Quantity") {
                                this.fldDict["QTY"].setFieldValue(Util.String(dr["Quantity"]));

                                let Vldbl = 1;
                                if (Util.IsNum(dr["UOMConversion"]))
                                    Vldbl = parseFloat(dr["UOMConversion"]);
                                if (!Util.IsEmpty(dr["Quantity"]))
                                    dr["UOMConvertedQty"] = Vldbl * parseFloat(dr["Quantity"]);

                            }
                            BindingPath = "Gross";
                        }

                        cccol = oCols.find(a => a.DisplayMember == BindingPath);
                        if (cccol && !Util.IsEmpty(cccol.FilterCondition)) {
                            cccol = oCols.find(a => !Util.IsEmpty(a.DisplayMember) && a.DisplayMember.toLowerCase() == cccol.FilterCondition.toLowerCase());
                        }
                    }
                    if (cccol && !Util.IsEmpty(cccol.Formula) && cccol.SectionID != 4 && !(Util.String(dr["Type"]) == "8" && cccol.UseBarcode)) {
                        Formula = cccol.Formula;
                        resval = BaseService.eval.EvaluateExpression(cccol.Formula, temp);
                        if (resval != null && resval.toString() != "Infinity" && resval.toString() != "-Infinity" && resval.toString() != "NaN" && Util.IsNum(resval)) {
                            if (cccol.IsCalculated == 0 && cccol.IsColumnUserDefined && cccol.DisplayMember.toLowerCase().Contains("dcnum")) {
                                if (resval != null && Util.IsNum(resval)) {
                                    if (cccol.NoRoundOff)
                                        dr["dcCalc" + cccol.DisplayMember] = parseFloat(resval).ToString("N6");
                                    else if (cccol.DecimalPoints != null && cccol.DecimalPoints != "")
                                        dr["dcCalc" + cccol.DisplayMember] = parseFloat(resval).ToString("N" + cccol.DecimalPoints);
                                    else if (resval != null)
                                        dr["dcCalc" + cccol.DisplayMember] = resval;
                                }
                            }
                            else {
                                if (!this.DontChVlue(dr, cccol, parseFloat(resval.toString()))) {
                                    if (cccol.NoRoundOff)
                                        dr[cccol.DisplayMember] = parseFloat(resval).ToString("N6");
                                    else if (!Util.IsEmpty(cccol.DecimalPoints))
                                        dr[cccol.DisplayMember] = parseFloat(resval).ToString("N" + cccol.DecimalPoints);
                                    else if (resval != null)
                                        dr[cccol.DisplayMember] = resval.toString();
                                }
                            }

                            if (cccol.DisplayMember == "Gross")
                                this.fldDict["GROSS"].setFieldValue(dr["Gross"]);
                            else if (cccol.DisplayMember == "Quantity") {
                                this.fldDict["QTY"].setFieldValue(Util.String(dr["Quantity"]));
                                if (!Util.IsEmpty(dr["UOMConversion"]) && !Util.IsEmpty(dr["Quantity"])) {
                                    dr["UOMConvertedQty"] = parseFloat(dr["Quantity"]) * parseFloat(dr["UOMConversion"]);

                                }
                            }
                            else if (cccol.DisplayMember == "FreeQTY") {
                                this.fldDict["FreeQTY"].setFieldValue(dr["FreeQTY"]);
                                if (!Util.IsEmpty(dr["FreeQTY"]) && parseFloat(dr["FreeQTY"]) > 0) {
                                    if (!Util.IsEmpty(dr["UOMConversion"]))
                                        dr["UOMConvertedQty"] = parseFloat(dr["FreeQTY"]) * parseFloat(dr["UOMConversion"]);
                                    else
                                        dr["UOMConvertedQty"] = dr["FreeQTY"].toString();
                                }
                            }
                            else if (cccol.DisplayMember == "Rate")
                                this.fldDict["RATE"].setFieldValue(dr["Rate"]);
                            else if (cccol.IsCalculated == 1) {
                                this.fldDict[cccol.lbl].setFieldValue(dr[cccol.DisplayMember]);
                                if (cccol.DisplayMember.Contains("dcNum"))
                                    this.fldDict["Calc" + cccol.lbl].setFieldValue(dr[cccol.DisplayMember]);
                            }
                            else if (cccol.DisplayMember.Contains("dcNum"))
                                this.fldDict["Calc" + cccol.lbl].setFieldValue(dr["dcCalc" + cccol.DisplayMember]);

                        }
                    }
                    else if (cccol && cccol.DisplayMember.Contains("dcNum"))
                        this.fldDict["Calc" + cccol.lbl].setFieldValue(dr[cccol.DisplayMember]);
                }

                for (let i = 0; i < oCols.length; i++) {
                    if (dr != null) {
                        if (!Util.IsEmpty(oCols[i].Formula) && oCols[i].SectionID != 4 && !(Util.String(dr["Type"]) == "8" && oCols[i].UseBarcode)) {
                            Formula = oCols[i].Formula;
                            if (oCols[i].IsCalculated == 1 || !(oCols[i].IsColumnUserDefined || oCols[i].DisplayMember == "DueDate")) {
                                resval = BaseService.eval.EvaluateExpression(oCols[i].Formula, temp);

                                if (resval != null && resval.toString() != "Infinity" && resval.toString() != "-Infinity" && resval.toString() != "NaN" && Util.IsNum(resval)) {
                                    if (!this.DontChVlue(dr, oCols[i], parseFloat(resval.toString()))) {
                                        if (oCols[i].NoRoundOff)
                                            dr[oCols[i].DisplayMember] = parseFloat(resval).ToString("N6");
                                        else if (!Util.IsEmpty(oCols[i].DecimalPoints))
                                            dr[oCols[i].DisplayMember] = parseFloat(resval).ToString("N" + oCols[i].DecimalPoints);
                                        else if (resval != null)
                                            dr[oCols[i].DisplayMember] = resval.toString();
                                    }
                                }
                                if (oCols[i].DisplayMember.Contains("dcNum"))
                                    dr["dcCalc" + oCols[i].DisplayMember] = dr[oCols[i].DisplayMember];
                            }
                            else if (oCols[i].DisplayMember.Contains("dcNum")) {
                                resval = BaseService.eval.EvaluateExpression(oCols[i].Formula, temp);

                                if (resval != null && resval.toString() != "Infinity" && resval.toString() != "-Infinity" && resval.toString() != "NaN" && Util.IsNum(resval)) {
                                    if (oCols[i].NoRoundOff)
                                        dr["dcCalc" + oCols[i].DisplayMember] = parseFloat(resval).ToString("N6");
                                    else if (!Util.IsEmpty(oCols[i].DecimalPoints))
                                        dr["dcCalc" + oCols[i].DisplayMember] = parseFloat(resval).ToString("N" + oCols[i].DecimalPoints);
                                    else if (resval != null)
                                        dr["dcCalc" + oCols[i].DisplayMember] = resval.toString();
                                }
                            }
                            else if (oCols[i].DisplayMember.toLowerCase().Contains("dcalpha") || oCols[i].DisplayMember == "DueDate") {
                                resval = BaseService.eval.EvaluateExpression(oCols[i].Formula, temp).toString();

                                if (resval != null && resval.toString() != "Infinity" && resval.toString() != "-Infinity" && resval.toString() != "NaN") {
                                    if (oCols[i].DataType == "DATE" || oCols[i].DataType == "DATETIME" || oCols[i].DataType == "TIME") {
                                        let tempdt: Date;
                                        if (Util.isValidDate(resval)) {
                                            if (oCols[i].DataType == "DATETIME")
                                                dr[oCols[i].DisplayMember] = Util.ParseDate(resval).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");
                                            else if (oCols[i].DataType == "TIME")
                                                dr[oCols[i].DisplayMember] = Util.ParseDate(resval).ToString("hh:mm:ss tt");
                                            else
                                                dr[oCols[i].DisplayMember] = Util.ParseDate(resval).ToString(BaseService.SessionManager.Preferences["Date Format"]);

                                            if (oCols[i].DataType == "TIME") {
                                                tempdt = Util.ParseDate(resval);
                                                dr[oCols[i].DisplayMember + "_Key"] = new Date(1900, 1, 1, tempdt.getHours(), tempdt.getMinutes(), tempdt.getSeconds(), tempdt.getMilliseconds());
                                            }
                                            else
                                                dr[oCols[i].DisplayMember + "_Key"] = Util.ParseDate(resval);

                                            this.fldDict[oCols[i].lbl].setFieldValue(resval.toString());
                                        }
                                    }
                                    else if (oCols[i].DataType == "FLOAT") {
                                        if (Util.IsNum(resval)) {
                                            dr[oCols[i].DisplayMember] = resval.toString();
                                            this.fldDict[oCols[i].lbl].setFieldValue(resval);
                                        }
                                        else {
                                            dr[oCols[i].DisplayMember] = 0;
                                            this.fldDict[oCols[i].lbl].setFieldValue(0);
                                        }
                                    }
                                    else {
                                        dr[oCols[i].DisplayMember] = resval.toString();
                                        this.fldDict[oCols[i].lbl].setFieldValue(resval.toString());
                                    }
                                }
                            }

                            if (oCols[i].DisplayMember == "Gross" && !Util.IsEmpty(dr["Gross"]))
                                this.fldDict["GROSS"].setFieldValue(dr["Gross"]);
                            else if (oCols[i].DisplayMember == "FreeQTY" && !Util.IsEmpty(dr["FreeQTY"]))
                                this.fldDict["FreeQTY"].setFieldValue(dr["FreeQTY"]);
                            else if (oCols[i].DisplayMember == "Quantity") {
                                if (!Util.IsEmpty(dr["Quantity"])) {
                                    this.fldDict["QTY"].setFieldValue(Util.String(dr["Quantity"]));
                                    if (!Util.IsEmpty(dr["UOMConversion"])) {
                                        dr["UOMConvertedQty"] = parseFloat(dr["Quantity"]) * parseFloat(dr["UOMConversion"]);
                                    }
                                }
                            }
                            else if (oCols[i].DisplayMember == "Rate" && !Util.IsEmpty(dr["Rate"]))
                                this.fldDict["RATE"].setFieldValue(dr["Rate"]);
                            else if (oCols[i].IsCalculated == 1) {
                                if (!Util.IsEmpty(dr[oCols[i].DisplayMember]))
                                    this.fldDict[oCols[i].lbl].setFieldValue(dr[oCols[i].DisplayMember]);
                                if (oCols[i].DisplayMember.Contains("dcNum") && !Util.IsEmpty(dr[oCols[i].DisplayMember]))
                                    this.fldDict["Calc" + oCols[i].lbl].setFieldValue(dr[oCols[i].DisplayMember]);
                            }
                            else if (oCols[i].DisplayMember.Contains("dcNum"))
                                this.fldDict["Calc" + oCols[i].lbl].setFieldValue(dr["dcCalc" + oCols[i].DisplayMember]);

                            if (oCols[i].DisplayMember.Contains("dcNum") && Util.IsEmpty(dr[oCols[i].DisplayMember]))
                                this.fldDict[oCols[i].lbl].setFieldValue(0);
                            if (oCols[i].DisplayMember.Contains("dcNum") && Util.IsEmpty(dr["dcCalc" + oCols[i].DisplayMember]))
                                this.fldDict["Calc" + oCols[i].lbl].setFieldValue(0);

                            this.ScreenObject.GridDataObj.updateRow(dr);
                        }
                        else if (oCols[i].DisplayMember.Contains("dcNum") && (oCols[i].SectionID != 4 || Util.IsEmpty(oCols[i].Formula))) {
                            if (!Util.IsEmpty(dr[oCols[i].DisplayMember])) {

                                if (!Util.IsEmpty(oCols[i].DecimalPoints))
                                    dr[oCols[i].DisplayMember] = parseFloat(dr[oCols[i].DisplayMember]).ToString("N" + oCols[i].DecimalPoints);

                                dr["dcCalc" + oCols[i].DisplayMember] = dr[oCols[i].DisplayMember];
                                this.fldDict["Calc" + oCols[i].lbl].setFieldValue(dr[oCols[i].DisplayMember]);
                            }
                        }
                        else if (oCols[i].DisplayMember == "FreeQTY" && (oCols[i].SectionID != 4 || Util.IsEmpty(oCols[i].Formula))) {
                            let drfreeQtyformula = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'Quantity');
                            if (drfreeQtyformula.length > 0 && !Util.IsEmpty(drfreeQtyformula[0]["Cformula"])) {
                                resval = BaseService.eval.EvaluateExpression(drfreeQtyformula[0]["Cformula"], temp);

                                if (resval != null && resval.toString() != "Infinity" && resval.toString() != "-Infinity" && resval.toString() != "NaN" && Util.IsNum(resval)) {
                                    if (!this.DontChVlue(dr, oCols[i], parseFloat(resval.toString()))) {
                                        if (oCols[i].NoRoundOff)
                                            dr[oCols[i].DisplayMember] = parseFloat(resval).ToString("N6");
                                        else if (!Util.IsEmpty(oCols[i].DecimalPoints))
                                            dr[oCols[i].DisplayMember] = parseFloat(resval).ToString("N" + oCols[i].DecimalPoints);
                                        else if (resval != null)
                                            dr[oCols[i].DisplayMember] = resval.toString();
                                    }
                                }
                                if (oCols[i].DisplayMember.Contains("FreeQTY"))
                                    dr["FreeQTY"] = dr["FreeQTY"];
                            }
                        }
                        else if (oCols[i].DataType == "LINK" && oCols[i].DisplayMember.toLowerCase().Contains("dcalpha"))
                            dr[oCols[i].DisplayMember] = "...";

                    }
                    if (CalcFooter) {
                        let dtTmp1 = Util.GetEmptyDate()//new Date();

                        dblFooter = 0;
                        dblCalcFooter = 0;
                        dblCalcLc = 0;

                        if (!oCols[i].DisplayMember.Contains("dcAlpha") && oCols[i].DataType.toUpperCase() == "FLOAT" && oCols[i].SectionID != 4) {
                            let MaxVal = 0, MinValue = 0, MaxCalcVal = 0, MinCalcVal = 0;
                            for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                                let ExchangeRate = ExhgRate;
                                if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                                    if (this.ScreenObject.GridDataColumns.Contains("ExchangeRate") && !Util.IsEmpty(this.ScreenObject.GridData[k]["ExchangeRate"]))
                                        ExchangeRate = parseFloat(this.ScreenObject.GridData[k]["ExchangeRate"]);
                                }
                                if (oCols[i].DisplayMember.toLowerCase().Contains("dcnum")) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[k][oCols[i].DisplayMember]) && parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]) > MaxVal)
                                        MaxVal = parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]);

                                    if (!Util.IsEmpty(this.ScreenObject.GridData[k][oCols[i].DisplayMember]) && (parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]) < MinValue || MinValue == 0))
                                        MinValue = parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]);

                                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcCalc" + oCols[i].DisplayMember]) && parseFloat(this.ScreenObject.GridData[k]["dcCalc" + oCols[i].DisplayMember]) > MaxCalcVal)
                                        MaxCalcVal = parseFloat(this.ScreenObject.GridData[k]["dcCalc" + oCols[i].DisplayMember]);

                                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcCalc" + oCols[i].DisplayMember]) && (parseFloat(this.ScreenObject.GridData[k]["dcCalc" + oCols[i].DisplayMember]) < MinCalcVal || MinCalcVal == 0))
                                        MinCalcVal = parseFloat(this.ScreenObject.GridData[k]["dcCalc" + oCols[i].DisplayMember]);

                                    if (oCols[i].DefaultValue == "-2") {
                                        if (this.ScreenObject.GridDataColumns.Contains(oCols[i].DisplayMember.toLowerCase().replace("dcnum", "dcExchRT")) && !Util.IsEmpty(this.ScreenObject.GridData[k][oCols[i].DisplayMember.toLowerCase().replace("dcnum", "dcExchRT")]))
                                            ExchangeRate = parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember.toLowerCase().replace("dcnum", "dcExchRT")]);
                                        else
                                            ExchangeRate = 1;
                                    }

                                    let def = Util.Double(oCols[i].DefaultValue);
                                    if (def > 0)
                                        if (oCols[i].CurrID > 0) {
                                            ExchangeRate = oCols[i].ExhcgRt;
                                        }
                                        else
                                            ExchangeRate = 1;
                                }

                                if (oCols[i].DisplayMember == "Quantity") {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["UOMConvertedQty"])
                                        && !Util.IsEmpty(this.ScreenObject.GridData[k]["Quantity"]) && parseFloat(this.ScreenObject.GridData[k]["Quantity"]) != 0) {
                                        if (this.ScreenObject.Preferences.ContainsKey("ShowQtyTotal") && this.ScreenObject.Preferences["ShowQtyTotal"] != "" && this.ScreenObject.Preferences["ShowQtyTotal"].toString() == "2")
                                            dblFooter += parseFloat(this.ScreenObject.GridData[k]["Quantity"]);
                                        else
                                            dblFooter += parseFloat(this.ScreenObject.GridData[k]["UOMConvertedQty"]);

                                        dblCalcFooter = dblFooter;
                                    }
                                }
                                else if (oCols[i].IsCalculated == 1 || !oCols[i].IsColumnUserDefined) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[k][oCols[i].DisplayMember])) {
                                        if (this.DocumentType == 67 && (oCols[i].DisplayMember == "dcNum1" || oCols[i].DisplayMember == "dcNum2" || oCols[i].DisplayMember == "dcNum4" ||
                                            oCols[i].DisplayMember == "dcNum5" || oCols[i].DisplayMember == "dcNum7" || oCols[i].DisplayMember == "dcNum9" ||
                                            oCols[i].DisplayMember == "dcNum11" || oCols[i].DisplayMember == "dcNum13")) {
                                            this.drcc1 = this.ScreenObject.Data.Tables[0].filter(x => x.CostCenterColID == oCols[i].ID);
                                            if (this.drcc1 != null && this.drcc1.length > 0) {
                                                if (!Util.IsEmpty(this.drcc1[0]["UserColumnType"])) {
                                                    if (parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]) > 0) {
                                                        //sHrs = parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]).ToTime("00.00").split('.');
                                                        //dtTmp1 = dtTmp1.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));

                                                        //if (dtTmp1.Minute.toString().length == 1)
                                                        //    dblFooter = parseFloat(dtTmp1.Hour + ".0" + dtTmp1.getMinutes());
                                                        //else
                                                        //    dblFooter = parseFloat(dtTmp1.Hour + "." + dtTmp1.getMinutes());

                                                        ////
                                                        let sSP: string[] = parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]).ToTime("00.00").split('.');
                                                        dtTmp1 = dtTmp1.AddHours(parseFloat(sSP[0]));
                                                        if (sSP.length > 1) {
                                                            if (sSP[1].length == 1)
                                                                sSP[1] = sSP[1] + "0";
                                                            dtTmp1 = dtTmp1.AddMinutes(parseFloat(sSP[1]));
                                                        }

                                                        let sMin = dtTmp1.getMinutes().toString();
                                                        if (sMin.length == 1)
                                                            sMin = "0" + sMin;
                                                        dblFooter = parseFloat((((dtTmp1.getDate() - 1) * 24) + dtTmp1.getHours()) + "." + sMin);
                                                        ////
                                                        dblCalcLc = dblCalcFooter = dblFooter;
                                                    }
                                                }
                                                else {
                                                    dblFooter += parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]);
                                                    dblCalcLc += parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]) * ExchangeRate;
                                                    dblCalcFooter = dblFooter;
                                                }
                                            }
                                        }
                                        else {
                                            dblFooter += parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]);
                                            dblCalcLc += parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]) * ExchangeRate;
                                            dblCalcFooter = dblFooter;
                                        }
                                        if (this.DocumentType == 72 && (oCols[i].DisplayMember == "dcNum1" || oCols[i].DisplayMember == "dcNum2" || oCols[i].DisplayMember == "dcNum3")) {
                                            if (this.ScreenObject.GridData[k]["dcAlpha21"] != null) {
                                                if (parseFloat(this.ScreenObject.GridData[k]["dcAlpha21"]) == 2) {
                                                    dblFooter += parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]);
                                                    dblCalcLc += parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]) * ExchangeRate;
                                                }
                                                else {
                                                    dblFooter -= parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]);
                                                    dblCalcLc -= parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]) * ExchangeRate;
                                                }

                                                dblCalcFooter = dblFooter;
                                            }
                                            else {
                                                dblFooter += parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]);
                                                dblCalcLc += parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]) * ExchangeRate;
                                                dblCalcFooter = dblFooter;
                                            }
                                        }


                                    }
                                }
                                else if (oCols[i].DisplayMember.Contains("dcNum")) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcCalc" + oCols[i].DisplayMember])) {
                                        dblCalcFooter += parseFloat(this.ScreenObject.GridData[k]["dcCalc" + oCols[i].DisplayMember]);
                                        dblCalcLc += parseFloat(this.ScreenObject.GridData[k]["dcCalc" + oCols[i].DisplayMember]) * ExchangeRate;
                                    }

                                    if (!Util.IsEmpty(this.ScreenObject.GridData[k][oCols[i].DisplayMember])) {
                                        dblFooter += parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]);
                                    }
                                }
                            }

                            if (oCols[i].IsCalculated == 1 || !oCols[i].IsColumnUserDefined) {
                                if (oCols[i].ShowbodyTotal != 0) {
                                    if (oCols[i].DisplayMember == "Quantity" || oCols[i].DisplayMember == "Rate") {
                                        if (!Util.IsEmpty(oCols[i].DecimalPoints))
                                            oCols[i].footer = dblFooter.ToString("N" + oCols[i].DecimalPoints);
                                        else
                                            oCols[i].footer = dblFooter.toString();
                                    }
                                    else {
                                        if (!Util.IsEmpty(oCols[i].DecimalPoints)) {
                                            if (oCols[i].ShowbodyTotal == 1)
                                                oCols[i].footer = dblCalcLc.ToString("N" + oCols[i].DecimalPoints);
                                            else {
                                                let exrate = 1;
                                                if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])
                                                    && this.Currency && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
                                                    exrate = parseFloat(this.Currency.ExchangeRate.Text);
                                                if (exrate != 0)
                                                    oCols[i].footer = (dblCalcLc / exrate).ToString("N" + oCols[i].DecimalPoints);
                                                else
                                                    oCols[i].footer = dblCalcLc.ToString("N" + oCols[i].DecimalPoints);
                                            }
                                        }
                                        else {
                                            if (oCols[i].ShowbodyTotal == 1)
                                                oCols[i].footer = dblCalcLc.toString();
                                            else {
                                                let exrate = 1;
                                                if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])
                                                    && this.Currency && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
                                                    exrate = parseFloat(this.Currency.ExchangeRate.Text);
                                                if (exrate != 0)
                                                    oCols[i].footer = (dblCalcLc / exrate).toString();
                                                else
                                                    oCols[i].footer = dblCalcLc.toString();
                                            }
                                        }
                                    }
                                }
                                if (oCols[i].PostingType == 3 || oCols[i].PostingType == 4) {
                                    if (this.IsInventoryVoucher) {
                                        if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 6 || this.ScreenObject.DocumentType == 39 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 8 || this.ScreenObject.DocumentType == 31) {
                                            if (oCols[i].CrRefColID == 0 && oCols[i].CreditAcount == 0)
                                                this.GridNetTotal += dblCalcLc;
                                        }
                                        else {
                                            if (oCols[i].DrRefColID == 0 && oCols[i].DebitAccount == 0)
                                                this.GridNetTotal += dblCalcLc;
                                        }
                                    }
                                    else
                                        this.GridNetTotal += dblCalcLc;

                                }
                                else if (!this.IsInventoryVoucher && (oCols[i].DisplayMember == "Amount" || oCols[i].DisplayMember == "CreditAmount"))
                                    this.GridNetTotal += dblCalcLc;
                            }
                            else {
                                if (oCols[i].ShowbodyTotal != 0) {
                                    if (!Util.IsEmpty(oCols[i].DecimalPoints)) {
                                        if (oCols[i].ShowbodyTotal == 1)
                                            oCols[i].footer = dblCalcLc.ToString("N" + oCols[i].DecimalPoints);
                                        else {
                                            let exrate = 1;
                                            if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])
                                                && this.Currency && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
                                                exrate = parseFloat(this.Currency.ExchangeRate.Text);
                                            if (exrate != 0)
                                                oCols[i].footer = (dblCalcLc / exrate).ToString("N" + oCols[i].DecimalPoints);
                                            else
                                                oCols[i].footer = dblCalcLc.ToString("N" + oCols[i].DecimalPoints);
                                        }
                                    }
                                    else {
                                        if (oCols[i].ShowbodyTotal == 1)
                                            oCols[i].footer = dblCalcLc.toString();
                                        else {
                                            let exrate = 1;
                                            if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])
                                                && this.Currency && !Util.IsEmpty(this.Currency.ExchangeRate.Text))
                                                exrate = parseFloat(this.Currency.ExchangeRate.Text);
                                            if (exrate != 0)
                                                oCols[i].footer = (dblCalcLc / exrate).toString();
                                            else
                                                oCols[i].footer = dblCalcLc.toString();
                                        }
                                    }
                                }
                                if (oCols[i].PostingType == 3 || oCols[i].PostingType == 4) {
                                    if (this.IsInventoryVoucher) {
                                        if (this.ScreenObject.DocumentType == 1 || this.ScreenObject.DocumentType == 2 || this.ScreenObject.DocumentType == 25 || this.ScreenObject.DocumentType == 26 || this.ScreenObject.DocumentType == 27 || this.ScreenObject.DocumentType == 6 || this.ScreenObject.DocumentType == 39 || this.ScreenObject.DocumentType == 3 || this.ScreenObject.DocumentType == 4 || this.ScreenObject.DocumentType == 34 || this.ScreenObject.DocumentType == 8 || this.ScreenObject.DocumentType == 31) {
                                            if (oCols[i].CrRefColID == 0 && oCols[i].CreditAcount == 0)
                                                this.GridNetTotal += dblCalcLc;
                                        }
                                        else {
                                            if (oCols[i].DrRefColID == 0 && oCols[i].DebitAccount == 0)
                                                this.GridNetTotal += dblCalcLc;
                                        }
                                    }
                                    else
                                        this.GridNetTotal += dblCalcLc;
                                }
                                else if (!this.IsInventoryVoucher && (oCols[i].DisplayMember == "Amount" || oCols[i].DisplayMember == "CreditAmount"))
                                    this.GridNetTotal += dblCalcLc;
                            }

                            if (this.fldDict.ContainsKey("Max" + oCols[i].lbl))
                                this.fldDict["Max" + oCols[i].lbl].setFieldValue(MaxVal);
                            if (this.fldDict.ContainsKey("MaxCalc" + oCols[i].lbl))
                                this.fldDict["MaxCalc" + oCols[i].lbl].setFieldValue(MaxCalcVal);
                            if (this.fldDict.ContainsKey("Min" + oCols[i].lbl))
                                this.fldDict["Min" + oCols[i].lbl].setFieldValue(MinValue);
                            if (this.fldDict.ContainsKey("MinCalc" + oCols[i].lbl))
                                this.fldDict["MinCalc" + oCols[i].lbl].setFieldValue(MinCalcVal);

                            if (this.FooterDics.ContainsKey("Max" + oCols[i].lbl))
                                this.FooterDics["Max" + oCols[i].lbl].setFieldValue(MaxVal);
                            if (this.FooterDics.ContainsKey("MaxCalc" + oCols[i].lbl))
                                this.FooterDics["MaxCalc" + oCols[i].lbl].setFieldValue(MaxCalcVal);
                            if (this.FooterDics.ContainsKey("Min" + oCols[i].lbl))
                                this.FooterDics["Min" + oCols[i].lbl].setFieldValue(MinValue);
                            if (this.FooterDics.ContainsKey("MinCalc" + oCols[i].lbl))
                                this.FooterDics["MinCalc" + oCols[i].lbl].setFieldValue(MinCalcVal);
                        }
                        else if (oCols[i].DisplayMember.Contains("dcAlpha") && oCols[i].DataType.toUpperCase() == "FLOAT" && oCols[i].SectionID != 4) {
                            dblFooter = 0;
                            for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[k][oCols[i].DisplayMember])) {
                                    dblFooter += parseFloat(this.ScreenObject.GridData[k][oCols[i].DisplayMember]);
                                }
                            }
                            dblCalcFooter = dblFooter;
                            if (oCols[i].ShowbodyTotal == 1)
                                if (!Util.IsEmpty(oCols[i].DecimalPoints))
                                    oCols[i].footer = dblCalcFooter.ToString("N" + oCols[i].DecimalPoints);

                                else
                                    oCols[i].footer = dblCalcFooter.toString();
                        }
                        if (oCols[i].IsColumnUserDefined && this.FooterDics.ContainsKey(oCols[i].lbl)) {
                            this.FooterDics[oCols[i].lbl].setFieldValue(dblFooter);
                            if (oCols[i].DisplayMember.Contains("dcNum") && this.FooterDics.ContainsKey("Calc" + oCols[i].lbl))
                                this.FooterDics["Calc" + oCols[i].lbl].setFieldValue(dblCalcFooter);
                        }
                        else if (oCols[i].DisplayMember == "Gross" && this.FooterDics.ContainsKey("GROSS"))
                            this.FooterDics["GROSS"].setFieldValue(dblFooter);
                        else if (oCols[i].DisplayMember == "Quantity" && this.FooterDics.ContainsKey("QTY"))
                            this.FooterDics["QTY"].setFieldValue(dblFooter);
                        else if (oCols[i].DisplayMember == "FreeQTY" && this.FooterDics.ContainsKey("FreeQTY"))
                            this.FooterDics["FreeQTY"].setFieldValue(dblFooter);
                        else if (oCols[i].DisplayMember == "Rate" && this.FooterDics.ContainsKey("RATE"))
                            this.FooterDics["RATE"].setFieldValue(dblFooter);
                        else if (this.FooterDics.ContainsKey(oCols[i].DisplayMember)) {
                            this.FooterDics[oCols[i].DisplayMember].setFieldValue(dblFooter);
                        }
                    }
                }
                if (CalcFooter) {
                    if (this.ScreenObject.GridDataColumns.Contains("IsKit") && dr != null && dr["IsKit"].toString() == "2")
                        this.CalcOpRate();
                    this.CalculateFooter(-1);
                    this.RefreshNetAmount();
                    this.jvTotal();
                    this.UpdateFooter = true;
                }
            }
            this.ScreenObject.GridDataObj.UpdateFooter()
        }
        catch (ex) {
            this.DisplayMessage = "Problem evaluating formula,try again";
            this.MessageVisibility = true;
            Logger.ErrorLog("Addeditdocumentviewmodel", "Formua evaluation calculate totals Formula:" + Formula, ex.Message, ex.stack);
        }
    }

    GetLineWiseValue(Formula: string): number {
        let tempdbl: number, Amt = 0;
        for (let h = 0; h < this.ScreenObject.GridData.length; h++) {//this.ScreenObject.GridData[h].RowState != DataRowState.Deleted && this.ScreenObject.GridData[h].RowState != DataRowState.Detached
            if (!Util.IsEmpty(this.ScreenObject.GridData[h]["ProductID_Key"])) {
                this.FillDictionary(this.ScreenObject.GridData[h], false);
                let tempBodyFlds = this.fldDict;

                let resval = BaseService.eval.EvaluateExpression(Formula, tempBodyFlds);
                if (!Util.IsEmpty(resval) && resval.toString() != "Infinity" && resval.toString() != "-Infinity" && resval.toString() != "NaN" && Util.IsNum(resval))
                    Amt += parseFloat(resval);
            }
        }
        return Amt;
    }

    CalculateFooter(CalcRowIndex: number) {
        if (!this.IsInventoryVoucher) {
            this.CalcTextFields();
            return;
        }
        try {
            let temp = this.FooterDics;
            if (this.ScreenObject.FooterGridData != null && this.ScreenObject.FooterGridData.length > 0) {
                let ColName = "";
                for (let k = 0; k < this.ScreenObject.FooterGridData.length; k++) {
                    ColName = Util.String(this.ScreenObject.FooterGridData[k]["Name"]).Replace(" ", "");
                    if (this.FooterDics.ContainsKey(ColName)) {
                        if (!Util.IsEmpty(this.ScreenObject.FooterGridData[k]["Amount"]))
                            this.FooterDics[ColName].setFieldValue(this.ScreenObject.FooterGridData[k]["Amount"]);
                        else
                            this.FooterDics[ColName].setFieldValue(0);
                    }
                    if (this.FooterDics.ContainsKey("Calc" + ColName)) {
                        if (!Util.IsEmpty(this.ScreenObject.FooterGridData[k]["CalcAmount"]))
                            this.FooterDics["Calc" + ColName].setFieldValue(this.ScreenObject.FooterGridData[k]["CalcAmount"]);
                        else
                            this.FooterDics["Calc" + ColName].setFieldValue(0);
                    }
                }

                this.FooterGridNetTotal = 0;
                for (let k = 0; k < this.ScreenObject.FooterGridData.length; k++) {
                    ColName = Util.String(this.ScreenObject.FooterGridData[k]["Name"]).Replace(" ", "");
                    let ExhgRate = 1;
                    if (BaseService.SessionManager.Preferences.ContainsKey("Use Foreign Currency") && parseBoolean(BaseService.SessionManager.Preferences["Use Foreign Currency"])) {
                        if (this.Currency != null && this.Currency.ExchangeRate.Text != null && this.Currency.ExchangeRate.Text != "")
                            ExhgRate = parseFloat(this.Currency.ExchangeRate.Text);
                        let fcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember != null && a.DisplayMember == this.ScreenObject.FooterGridData[k]["ColumnName"]);
                        if (fcol) {
                            if (fcol.DefaultValue == "-2") {
                                if (!Util.IsEmpty(this.ScreenObject.FooterGridData[k]["dcCurrID_Key"]) && !Util.IsEmpty(this.ScreenObject.FooterGridData[k]["dcExchRT"]))
                                    ExhgRate = parseFloat(this.ScreenObject.FooterGridData[k]["dcExchRT"]);
                                else
                                    ExhgRate = 1;
                            }

                            let def = Util.Double(fcol.DefaultValue);
                            if (def > 0)
                                if (fcol.CurrID > 0) {
                                    ExhgRate = fcol.ExhcgRt;
                                }
                                else
                                    ExhgRate = 1;
                        }
                    }
                    if (!Util.IsEmpty(this.ScreenObject.FooterGridData[k]["Formula"])) {
                        let basedonflds: DgColumn[] = [];
                        if (!Util.IsEmpty(this.ScreenObject.FooterGridData[k]["BasedOnXML"])) {
                            let xDoc = new XmlDocument();
                            xDoc.LoadXml(this.ScreenObject.FooterGridData[k]["BasedOnXML"]);
                            let xlist = xDoc.SelectNodes("Xml/Row");
                            for (let c = 0; c < xlist.length; c++) {
                                let xnode = xlist[c]
                                if (xnode.attributes["ColumnName"] != null && !Util.IsEmpty(xnode.attributes["ColumnName"].value)
                                    && xnode.attributes["Formula"] != null && !Util.IsEmpty(xnode.attributes["Formula"].value)) {
                                    let bcol = this.ScreenObject.ColumnSource.find(a => a.ID == xnode.attributes["ColumnName"].value);
                                    if (bcol) {
                                        basedonflds.push(bcol);
                                        let Amt = this.GetLineWiseValue(xnode.attributes["Formula"].value);
                                        if (bcol.DisplayMember == "Gross")
                                            this.FooterDics["GROSS"].setFieldValue(Amt);
                                        else if (bcol.DisplayMember == "Quantity")
                                            this.FooterDics["QTY"].setFieldValue(Amt);
                                        else if (bcol.DisplayMember == "Rate")
                                            this.FooterDics["RATE"].setFieldValue(Amt);
                                        else if (this.FooterDics.ContainsKey(bcol.lbl))
                                            this.FooterDics[bcol.lbl].setFieldValue(Amt);
                                    }
                                }
                            }
                        }
                        if (this.ScreenObject.FooterGridData[k]["IsCalculated"] == "2") {
                            let Amt = this.GetLineWiseValue(this.ScreenObject.FooterGridData[k]["Formula"].toString());
                            this.ScreenObject.FooterGridData[k]["Amount"] = parseFloat(Amt.toString()).ToString("N" + this.ScreenObject.FooterGridData[k]["Decimals"].toString());
                            this.ScreenObject.FooterGridData[k]["CalcAmount"] = this.ScreenObject.FooterGridData[k]["Amount"];
                        }
                        else if (this.ScreenObject.FooterGridData[k]["IsCalculated"] == "1") {
                            let resval = BaseService.eval.EvaluateExpression(this.ScreenObject.FooterGridData[k]["Formula"].toString(), temp);
                            if (resval != null && !Util.IsEmpty(resval) && resval.toString() != "Infinity" && resval.toString() != "-Infinity" && resval.toString() != "NaN" && Util.IsNum(resval))
                                this.ScreenObject.FooterGridData[k]["Amount"] = parseFloat(resval.toString()).ToString("N" + this.ScreenObject.FooterGridData[k]["Decimals"].toString());
                            else
                                this.ScreenObject.FooterGridData[k]["Amount"] = 0;

                            this.ScreenObject.FooterGridData[k]["CalcAmount"] = this.ScreenObject.FooterGridData[k]["Amount"];
                        }
                        else {
                            //If data entered in calucalted field
                            if (CalcRowIndex == k && this.ScreenObject.FooterGridData[k]["Formula"].toString().Contains("%")) {
                                this.FooterDics[ColName].setFieldValue(1);
                                let dbl, dblCalc;
                                dbl = Util.Double(BaseService.eval.EvaluateExpression(this.ScreenObject.FooterGridData[k]["Formula"].toString(), temp).toString());
                                dblCalc = Util.Double(this.ScreenObject.FooterGridData[k]["CalcAmount"]);

                                if (dbl != 0) {
                                    dbl = dblCalc / dbl;
                                }
                                this.ScreenObject.FooterGridData[k]["Amount"] = parseFloat(dbl.toString()).ToString("N" + this.ScreenObject.FooterGridData[k]["Decimals"].toString());
                            }
                            else {
                                let resval = BaseService.eval.EvaluateExpression(this.ScreenObject.FooterGridData[k]["Formula"].toString(), temp);
                                if (resval != null && !Util.IsEmpty(resval) && resval.toString() != "Infinity" && resval.toString() != "-Infinity" && resval.toString() != "NaN" && Util.IsNum(resval))
                                    this.ScreenObject.FooterGridData[k]["CalcAmount"] = parseFloat(resval.toString()).ToString("N" + this.ScreenObject.FooterGridData[k]["Decimals"].toString());
                                else
                                    this.ScreenObject.FooterGridData[k]["CalcAmount"] = 0;
                            }
                        }

                        if (basedonflds.length > 0) {
                            basedonflds.forEach(item => {
                                let Amt = 0, Tempdbl: number;
                                for (let h = 0; h < this.ScreenObject.GridData.length; h++) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[h]["ProductID_Key"])) {
                                        if (!Util.IsEmpty(this.ScreenObject.GridData[h][item.DisplayMember]) && Util.IsNum(this.ScreenObject.GridData[h][item.DisplayMember]))
                                            Amt += parseFloat(this.ScreenObject.GridData[h][item.DisplayMember]);
                                    }
                                }

                                if (item.DisplayMember == "Gross")
                                    this.FooterDics["GROSS"].setFieldValue(Amt);
                                else if (item.DisplayMember == "Quantity")
                                    this.FooterDics["QTY"].setFieldValue(Amt);
                                else if (item.DisplayMember == "Rate")
                                    this.FooterDics["RATE"].setFieldValue(Amt);
                                else if (this.FooterDics.ContainsKey(item.lbl))
                                    this.FooterDics[item.lbl].setFieldValue(Amt);
                            });
                        }
                    }
                    else {
                        if (Util.StringValue(this.ScreenObject.FooterGridData[k]["Amount"]) != "")
                            this.ScreenObject.FooterGridData[k]["Amount"] = parseFloat(this.ScreenObject.FooterGridData[k]["Amount"]).ToString("N" + Util.StringValue(this.ScreenObject.FooterGridData[k]["Decimals"]));
                        else
                            this.ScreenObject.FooterGridData[k]["Amount"] = parseInt("0").ToString("N" + Util.StringValue(this.ScreenObject.FooterGridData[k]["Decimals"]));
                        this.ScreenObject.FooterGridData[k]["CalcAmount"] = this.ScreenObject.FooterGridData[k]["Amount"];
                    }


                    if (this.FooterDics.ContainsKey(ColName)) {
                        if (!Util.IsEmpty(this.ScreenObject.FooterGridData[k]["Amount"]))
                            this.FooterDics[ColName].setFieldValue(this.ScreenObject.FooterGridData[k]["Amount"].toString());
                        else
                            this.FooterDics[ColName].setFieldValue(0);
                    }
                    if (this.FooterDics.ContainsKey("Calc" + ColName)) {
                        if (!Util.IsEmpty(this.ScreenObject.FooterGridData[k]["CalcAmount"]))
                            this.FooterDics["Calc" + ColName].setFieldValue(this.ScreenObject.FooterGridData[k]["CalcAmount"].toString());
                        else
                            this.FooterDics["Calc" + ColName].setFieldValue(0);
                    }

                    if (this.FooterDics.ContainsKey(ColName + "EXRT"))
                        this.FooterDics[ColName + "EXRT"].setFieldValue(ExhgRate);

                    if (this.ScreenObject.FooterGridData[k]["CalcAmount"] != null && !Util.IsEmpty(this.ScreenObject.FooterGridData[k]["CalcAmount"])
                        && this.ScreenObject.FooterGridData[k]["PostingType"] != null && !Util.IsEmpty(this.ScreenObject.FooterGridData[k]["PostingType"])
                        && (parseInt(this.ScreenObject.FooterGridData[k]["PostingType"]) == 3 || parseInt(this.ScreenObject.FooterGridData[k]["PostingType"]) == 4)) {
                        this.FooterGridNetTotal += parseFloat(this.ScreenObject.FooterGridData[k]["CalcAmount"]) * ExhgRate;
                    }
                    this.ScreenObject.FooterGridDataObj.updateRow(this.ScreenObject.FooterGridData[k])
                }
            }

            if (this.ScreenObject.DocPrefix != null && !Util.IsNullOrWhiteSpace(this.ScreenObject.DocPrefix.Formula)) {
                this.GridNetTotal = 0; this.FooterGridNetTotal = 0;
                let tempdbl: number;
                let resval = BaseService.eval.EvaluateExpression(this.ScreenObject.DocPrefix.Formula, temp);
                if (Util.IsNum(resval)) {
                    this.FooterGridNetTotal = parseFloat(resval);
                }
            }
            this.RefreshNetAmount();
            this.CalcTextFields();
        }
        catch (error) {
            this.DisplayMessage = "Problem processing document try again";

            Logger.ErrorLog("Addeditdocumentviewmodel", "footer calculation", error.stack);

        }
    }

    CalcTextFields() {
        try {
            let temp = this.FooterDics;
            this.ScreenObject._TextFields.forEach(item => {
                let tempdt: Date;
                let drr: any[] = this.ScreenObject.Data.Tables[0].filter(x => x.CostCenterColID == item.DBColumnID && x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 53580);
                if (drr.length > 0) {
                    if (this.fldDict != null && Util.isValidDate(this.fldDict["ServerDate"].fieldResult)) {
                        tempdt = Util.ParseDate(this.fldDict["ServerDate"].fieldResult);
                        if (item instanceof PactDateTimeData)
                            item.Date = tempdt;
                        else if (item instanceof PactExtraFieldDateData)
                            item.Date = tempdt;
                        else if (item instanceof PactTextBoxData)
                            item.Text = tempdt.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                    }
                }
                drr = this.ScreenObject.Data.Tables[0].filter(x => x.CostCenterColI == item.DBColumnID && x.LocalReference != null && x.LocalReference == 79 && (x.LinkData == 55496 || x.LinkData == 55495));
                if (drr.length > 0) {
                    tempdt = new Date();
                    if (item instanceof PactDateTimeData) {
                        item.Date = tempdt;
                        if (this.FooterDics.ContainsKey(item.Lbl) && item.Date)
                            this.FooterDics[item.Lbl].setFieldValue(item.Date);
                    }
                    else if (item instanceof PactExtraFieldDateData) {
                        item.Date = tempdt;
                        if (this.FooterDics.ContainsKey(item.Lbl) && item.Date)
                            this.FooterDics[item.Lbl].setFieldValue(item.Date);
                    }
                    else if (item instanceof PactTextBoxData) {
                        item.Text = tempdt.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        if (this.FooterDics.ContainsKey(item.Lbl))
                            this.FooterDics[item.Lbl].setFieldValue(item.Text);
                    }
                }
                if (!Util.IsEmpty(item.Formula)) {
                    let resval = BaseService.eval.EvaluateExpression(item.Formula, temp);

                    if (item instanceof PactTextBoxData && item.DataType == "FLOAT") {
                        let tempdbl: number;
                        if (Util.IsNum(resval)) {
                            if (!Util.IsEmpty(item.DecimalPoints))
                                item.Text = parseFloat(resval).ToString("N" + item.DecimalPoints);
                            else
                                item.Text = parseFloat(resval).ToString("N" + BaseService.SessionManager.Preferences["DecimalsinExtraFields"]);
                        }
                        else
                            item.Text = "0";
                        if (this.FooterDics.ContainsKey(item.Lbl))
                            this.FooterDics[item.Lbl].setFieldValue(item.Text);
                    }
                    else if (item instanceof PactTextBoxData) {
                        if (resval != null)
                            item.Text = resval.toString();
                        else
                            item.Text = "";
                        if (this.FooterDics.ContainsKey(item.Lbl))
                            this.FooterDics[item.Lbl].setFieldValue(item.Text);
                    }
                    else if (item instanceof PactExtraFieldDateData) {
                        if (resval != null && Util.isValidDate(resval))
                            item.Date = Util.ParseDate(resval);
                        else
                            item.Date = null;
                        if (this.FooterDics.ContainsKey(item.Lbl) && item.Date)
                            this.FooterDics[item.Lbl].setFieldValue(item.Date);
                    }
                    else if (item instanceof PactDateTimeData) {
                        if (resval != null && Util.isValidDate(resval.toString()))
                            item.Date = Util.ParseDate(resval.toString());
                        else
                            item.Date = null;
                        if (this.FooterDics.ContainsKey(item.Lbl) && item.Date)
                            this.FooterDics[item.Lbl].setFieldValue(item.Date);
                    }
                }

                if (this.ScreenObject.DocumentType == 57 && item.DBColumnName.toLowerCase() == "dcalpha3") {
                    let AmountCol = this.ColumnSource.find(a => a.DisplayMember.toLowerCase().Contains("dcnum3"));
                    if (AmountCol != null)
                        (item as PactTextBoxData).Text = this.FooterDics[AmountCol.lbl].fieldResult.toString();
                }
            });
            if (this.ScreenObject.DueDate != null && !Util.IsEmpty(this.ScreenObject.DueDate.Formula)) {
                let Res = BaseService.eval.EvaluateExpression(this.ScreenObject.DueDate.Formula, temp);
                let tempd: Date;
                if (Res != null && Util.isValidDate(Res)) {
                    this.ScreenObject.DueDate.Date = Util.ParseDate(Res);
                }
                if (this.FooterDics.ContainsKey("DUEDATE") && this.ScreenObject.DueDate.Date)
                    this.FooterDics["DUEDATE"].setFieldValue(this.ScreenObject.DueDate.Date);
            }

            if (!this.IsInventoryVoucher && this.ScreenObject.DocPrefix != null && !Util.IsEmpty(this.ScreenObject.DocPrefix.Formula) && this.ScreenObject.DocPrefix.Formula.trim() != "") {
                this.GridNetTotal = 0; this.FooterGridNetTotal = 0;
                let tempdbl;
                let resval = BaseService.eval.EvaluateExpression(this.ScreenObject.DocPrefix.Formula, temp);
                if (Util.IsNum(resval)) {
                    this.FooterGridNetTotal = parseFloat(resval);
                }
                this.RefreshNetAmount();
            }
        }
        catch (error) {
            this.DisplayMessage = "Problem processing document try again";

            Logger.ErrorLog("Addeditdocumentviewmodel", "footer calculation", error.stack);

        }
    }

    FillCreatedByDate_ds(ds: any) {
        if (this.ScreenObject.Data.Tables.length == 0 || ds == null || ds.Tables.length == 0 || (ds.Tables.length > 0 && ds.Tables[0].length == 0))
            return;
        if (this.ScreenObject.Data.Tables[0].length > 0) {
            let dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 24060);
            if (dvCnt.length > 0 && ds.Columns[0].Contains("CreatedBy")) {
                if (this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        if (this.IsInventoryVoucher && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"]))
                            this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = ds.Tables[0][0]["CreatedBy"].toString();
                        else if (!this.IsInventoryVoucher && ((this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"]))
                            || (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                            || (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                        ))
                            this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = ds.Tables[0][0]["CreatedBy"].toString();
                    }
                }

                let Cb = this.ScreenObject._TextFields.find(a => a.DBColumnName == dvCnt[0]["SysColumnName"]);
                if (Cb && Cb instanceof PactTextBoxData && ds.Columns[0].Contains("CreatedBy"))
                    Cb.Text = ds.Tables[0][0]["CreatedBy"].toString();
            }

            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 24061);
            if (dvCnt.length > 0) {
                if (this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"]) && ds.Columns[0].Contains("CreatedDate")) {
                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        if ((this.IsInventoryVoucher && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) || (!this.IsInventoryVoucher && ((this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["AccountID_Key"]))
                            || (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["DebitAccount_Key"]))
                            || (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["CreditAccount_Key"]))
                        ))) {
                            if (dvCnt[0]["UserColumnType"].toString() == "Date") {
                                this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0]["CreatedDate"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"] + "_Key"] = Util.ParseDate(ds.Tables[0][0]["CreatedDate"]);
                            }
                            else if (dvCnt[0]["UserColumnType"].toString() == "DateTime") {
                                this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0]["CreatedDate"]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm a");
                                this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"] + "_Key"] = Util.ParseDate(ds.Tables[0][0]["CreatedDate"]);
                            }
                            else if (dvCnt[0]["UserColumnType"].toString() == "Time") {
                                this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0]["CreatedDate"]).ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                                this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"] + "_Key"] = Util.ParseDate(ds.Tables[0][0]["CreatedDate"]);
                            }
                            else
                                this.ScreenObject.GridData[i][dvCnt[0]["SysColumnName"]] = Util.ParseDate(ds.Tables[0][0]["CreatedDate"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        }
                    }
                }

                let Cb = this.ScreenObject._TextFields.find(a => a.DBColumnName == dvCnt[0]["SysColumnName"]);
                if (Cb && ds.Columns[0].Contains("CreatedDate")) {
                    if (Cb instanceof PactTextBoxData)
                        Cb.Text = Util.ParseDate(ds.Tables[0][0]["CreatedDate"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                    else if (Cb instanceof PactExtraFieldDateData)
                        Cb.Date = Util.ParseDate(ds.Tables[0][0]["CreatedDate"]);
                    if (Cb instanceof PactDateTimeData)
                        Cb.Date = Util.ParseDate(ds.Tables[0][0]["CreatedDate"]);
                }
            }
        }
    }

    AddAddress(ds: any) {
        if (this.AssignAddress != null && ds.Tables.length > 11 && ds.Tables[11].length > 0) {
            let drSelectadd, dradd;
            this.AssignAddress.IsEditing = true;
            if (this.ScreenObject.DebitAccount != null) {
                dradd = ds.Tables[11].filter(x => x.AddressTypeID == 3 && x.FEATUREPK == this.ScreenObject.DebitAccount.SelectedValue);
                drSelectadd = ds.Tables[10].filter(x => x.AddressTypeID == 3);
                this.AssignAddress.ShipTo.push(ComboBoxItems.ComboBoxItems_2("", ""));
                dradd.forEach(dra => {
                    this.AssignAddress.ShipTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));
                    if (drSelectadd.length > 0 && drSelectadd[0]["addressid"].toString() == dra["AddressID"].toString()) {
                        this.AssignAddress.SelectedShipTo = dra["AddressID"].toString();
                        this.AssignAddress.SAddressName.Text = Util.String(dra["ContactPerson"]);
                        this.AssignAddress.SAddress1.Text = Util.String(dra["Address1"]) + " " + Util.String(dra["Address2"]) + " " + Util.String(dra["Address3"]);
                        this.AssignAddress.SAddressCity.Text = Util.String(dra["City"]) + " " + Util.String(dra["State"]) + " " + Util.String(dra["Zip"]);
                        this.AssignAddress.SPhone1.Text = Util.String(dra["Phone1"]);
                        this.AssignAddress.ShipToVisibility = true;
                    }
                });
            }
            if (this.ScreenObject.IsPurchase) {
                if (this.ScreenObject.CreditAccount != null) {
                    dradd = ds.Tables[11].filter(x => x.AddressTypeID == 2 && x.FEATUREPK == this.ScreenObject.CreditAccount.SelectedValue);
                    drSelectadd = ds.Tables[10].filter(x => x.AddressTypeID == 2);

                    this.AssignAddress.BillTo.push(ComboBoxItems.ComboBoxItems_2("", ""));
                    dradd.forEach(dra => {
                        this.AssignAddress.BillTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));
                        if (drSelectadd.length > 0 && drSelectadd[0]["addressid"].toString() == dra["AddressID"].toString()) {
                            this.AssignAddress.SelectedBillTo = dra["AddressID"].toString();
                            this.AssignAddress.AddressName.Text = Util.String(dra["ContactPerson"])
                            this.AssignAddress.Address1.Text = Util.String(dra["Address1"]) + " " + Util.String(dra["Address2"]) + " " + Util.String(dra["Address3"]);
                            this.AssignAddress.Phone1.Text = Util.String(dra["Phone1"]);
                            this.AssignAddress.AddressCity.Text = Util.String(dra["City"]) + " " + Util.String(dra["State"]) + " " + Util.String(dra["Zip"]);
                            this.AssignAddress.BillToVisibility = true;
                        }
                    });
                    dradd = ds.Tables[11].filter(x => x.AddressTypeID == 1 && x.FEATUREPK == this.ScreenObject.CreditAccount.SelectedValue);
                    drSelectadd = ds.Tables[10].filter(x => x.AddressTypeID == 1);

                    this.AssignAddress.AddressTo.push(ComboBoxItems.ComboBoxItems_2("", ""));
                    dradd.forEach(dra => {
                        this.AssignAddress.AddressTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));

                        if (drSelectadd.length > 0 && drSelectadd[0]["addressid"].toString() == dra["AddressID"].toString()) {
                            this.AssignAddress.SelectedAddressTo = dra["AddressID"].toString();
                            this.AssignAddress.AddressToName.Text = Util.String(dra["ContactPerson"])
                            this.AssignAddress.AddressTo1.Text = Util.String(dra["Address1"]) + " " + Util.String(dra["Address2"]) + " " + Util.String(dra["Address3"]);
                            this.AssignAddress.PhoneTo1.Text = Util.String(dra["Phone1"]);
                            this.AssignAddress.AddressToCity.Text = Util.String(dra["City"]) + " " + Util.String(dra["State"]) + " " + Util.String(dra["Zip"]);
                            this.AssignAddress.AddressToVisbility = true;
                        }
                    });

                    dradd = ds.Tables[11].filter(x => x.AddressTypeID == 3 && x.FEATUREPK == this.ScreenObject.CreditAccount.SelectedValue);
                    drSelectadd = ds.Tables[10].filter(x => x.AddressTypeID == 3);
                    this.AssignAddress.ShipTo.push(ComboBoxItems.ComboBoxItems_2("", ""));
                    dradd.forEach(dra => {
                        this.AssignAddress.ShipTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));
                        if (drSelectadd.length > 0 && drSelectadd[0]["AddressID"].toString() == dra["AddressID"].toString()) {
                            this.AssignAddress.SelectedShipTo = dra["AddressID"].toString();
                            this.AssignAddress.SAddressName.Text = dra["ContactPerson"].toString();
                            this.AssignAddress.SAddress1.Text = dra["Address1"].toString() + " " + dra["Address2"].toString() + " " + dra["Address3"].toString();
                            this.AssignAddress.SAddressCity.Text = dra["City"].toString() + " " + dra["State"].toString() + " " + dra["Zip"].toString();
                            this.AssignAddress.SPhone1.Text = dra["Phone1"].toString();
                            this.AssignAddress.ShipToVisibility = true;
                        }
                    });
                }
            }
            else if (this.ScreenObject.DebitAccount != null) {
                dradd = ds.Tables[11].filter(x => x.AddressTypeID == 2 && x.FEATUREPK == this.ScreenObject.DebitAccount.SelectedValue);
                drSelectadd = ds.Tables[10].filter(x => x.AddressTypeID == 2);

                this.AssignAddress.BillTo.push(ComboBoxItems.ComboBoxItems_2("", ""));
                dradd.forEach(dra => {
                    this.AssignAddress.BillTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));
                    if (drSelectadd.length > 0 && drSelectadd[0]["addressid"].toString() == dra["AddressID"].toString()) {
                        this.AssignAddress.SelectedBillTo = dra["AddressID"].toString();
                        this.AssignAddress.AddressName.Text = Util.String(dra["ContactPerson"])
                        this.AssignAddress.Address1.Text = Util.String(dra["Address1"]) + " " + Util.String(dra["Address2"]) + " " + Util.String(dra["Address3"]);
                        this.AssignAddress.Phone1.Text = Util.String(dra["Phone1"]);
                        this.AssignAddress.AddressCity.Text = Util.String(dra["City"]) + " " + Util.String(dra["State"]) + " " + Util.String(dra["Zip"]);
                        this.AssignAddress.BillToVisibility = true;
                    }
                });

                dradd = ds.Tables[11].filter(x => x.AddressTypeID = 1 && x.FEATUREPK == this.ScreenObject.DebitAccount.SelectedValue);
                drSelectadd = ds.Tables[10].filter(x => x.AddressTypeID == 1);

                this.AssignAddress.AddressTo.push(ComboBoxItems.ComboBoxItems_2("", ""));
                dradd.forEach(dra => {
                    this.AssignAddress.AddressTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));

                    if (drSelectadd.length > 0 && drSelectadd[0]["addressid"].toString() == dra["AddressID"].toString()) {
                        this.AssignAddress.SelectedAddressTo = dra["AddressID"].toString();
                        this.AssignAddress.AddressToName.Text = Util.String(dra["ContactPerson"])
                        this.AssignAddress.AddressTo1.Text = Util.String(dra["Address1"]) + " " + Util.String(dra["Address2"]) + " " + Util.String(dra["Address3"]);
                        this.AssignAddress.PhoneTo1.Text = Util.String(dra["Phone1"]);
                        this.AssignAddress.AddressToCity.Text = Util.String(dra["City"]) + " " + Util.String(dra["State"]) + " " + Util.String(dra["Zip"]);
                        this.AssignAddress.AddressToVisbility = true;
                    }
                });
            }
            this.AssignAddress.IsEditing = false;
        }
    }

    CheckViewOnLoad() {
        try {
            let drviews: any[] = this.ScreenObject.Data.Tables[10].filter(x => x.Mode == 6);
            drviews.forEach(dr => {
                if (!Util.IsEmpty(dr["Expression"]) && !Util.IsEmpty(dr["ActionOptionID"])) {
                    let result = BaseService.eval.EvaluateExpression(dr["Expression"].toString(), this.FooterDics).toString();
                    if (result.toString() == "1") {
                        if (dr["ActionOptionID"].toString() == "4") {
                            this.ScreenObject.DocID = 0;
                            this.ScreenObject.VoucherNo = "";
                            this.clear(1);
                        }
                        alert(dr["FailureMessage"].toString())
                    }
                }
            });

            if (this.ScreenObject.Link != null && this.ScreenObject.Link.LinkStatus != "[Open]") {
                if (this.StatusID == 369)
                    drviews = this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -2 && (x.Mode == 2 || x.Mode == 3 || x.Mode == 4 || x.Mode == 5));//Edit or both or linked or Posted
                else
                    drviews = this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -2 && (x.Mode == 2 || x.Mode == 3 || x.Mode == 5));//Edit or both or linked
            }
            else if (this.StatusID == 369)
                drviews = this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -2 && (x.Mode == 2 || x.Mode == 3 || x.Mode == 4));//Edit or both or Posted
            else
                drviews = this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -2 && (x.Mode == 2 || x.Mode == 3));

            if (drviews.length > 0) {
                this.BodyVisible = parseBoolean(drviews[0]["IsVisible"]);
                this.ReadOnlyBody = !parseBoolean(drviews[0]["IsEditable"]);
            }
            else {
                this.BodyVisible = true;
                this.ReadOnlyBody = false;
                if (this.ScreenObject.Preferences.ContainsKey("Lock Body") && this.ScreenObject.Preferences["Lock Body"] != "" && parseBoolean(this.ScreenObject.Preferences["Lock Body"]))
                    this.ReadOnlyBody = true;
                else
                    this.ReadOnlyBody = false;
            }

            if (this.IsInventoryVoucher && this.AssignAddress != null) {
                if (this.ScreenObject.Preferences.ContainsKey("BillingAddress"))
                    this.AssignAddress.BillsVisibe = parseBoolean(this.ScreenObject.Preferences["BillingAddress"]);
                else
                    this.AssignAddress.BillsVisibe = false;

                if (this.ScreenObject.Preferences.ContainsKey("ShippingAddress"))
                    this.AssignAddress.ShipVisibe = parseBoolean(this.ScreenObject.Preferences["ShippingAddress"]);
                else
                    this.AssignAddress.ShipVisibe = false;

                if (this.ScreenObject.Preferences.ContainsKey("PrimaryAddress"))
                    this.AssignAddress.PrimVisibe = parseBoolean(this.ScreenObject.Preferences["PrimaryAddress"]);
                else
                    this.AssignAddress.PrimVisibe = false;

                drviews = this.ScreenObject.Data.Tables[10].length > 0 ? this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -6 && (x.Mode == 2 || x.Mode == 3)) : [];
                if (this.AssignAddress.PrimVisibe && drviews.length > 0) {
                    this.AssignAddress.PrimVisibe = parseBoolean(drviews[0]["IsVisible"]);
                    this.AssignAddress.PrimMandatory = parseBoolean(drviews[0]["IsMandatory"]);
                }
                else
                    this.AssignAddress.PrimMandatory = false;
                drviews = this.ScreenObject.Data.Tables[10].length > 0 ? this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -7 && (x.Mode == 2 || x.Mode == 3)) : [];
                if (this.AssignAddress.BillsVisibe && drviews.length > 0) {
                    this.AssignAddress.BillsVisibe = parseBoolean(drviews[0]["IsVisible"]);
                    this.AssignAddress.BillsMandatory = parseBoolean(drviews[0]["IsMandatory"]);
                }
                else
                    this.AssignAddress.BillsMandatory = false;
                drviews = this.ScreenObject.Data.Tables[10].length > 0 ? this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -8 && (x.Mode == 2 || x.Mode == 3)) : [];
                if (this.AssignAddress.ShipVisibe && drviews.length > 0) {
                    this.AssignAddress.ShipVisibe = parseBoolean(drviews[0]["IsVisible"]);
                    this.AssignAddress.ShipMandatory = parseBoolean(drviews[0]["IsMandatory"]);
                }
                else
                    this.AssignAddress.ShipMandatory = false;
            }
        }
        catch (error) {
        }
    }

    ReadonlyfldsbasedonExpression() {
        if (this.ScreenObject.Preferences.ContainsKey("ReadonlyfieldsbasedonExpression") && !Util.IsEmpty(this.ScreenObject.Preferences["ReadonlyfieldsbasedonExpression"])
            && this.ScreenObject.Preferences.ContainsKey("ReadonlyfieldsbasedonExpressionXML") && !Util.IsEmpty(this.ScreenObject.Preferences["ReadonlyfieldsbasedonExpressionXML"])) {
            let sExp = this.ScreenObject.Preferences["ReadonlyfieldsbasedonExpression"].toString();
            let result = BaseService.eval.EvaluateExpression(sExp, this.FooterDics).toString();

            if (result.toString() == "1") {
                for (let p = 0; p < this.ScreenObject.HeaderFields.length; p++) {
                    let item = this.ScreenObject.HeaderFields[p]
                    this.SetReadonly(item, true);
                }

                this.ScreenObject.CustomTab.Pages.forEach(item => {

                    item.Fields.forEach(field => {
                        this.SetReadonly(field, true);
                    });

                });

                this.ScreenObject.ColumnSource.forEach(item => {
                    this.SetReadonly(item, true);
                });

            }
        }
    }

    SetReadonly(Sender: any, IsReadOnly: boolean) {
        let sFlds = this.ScreenObject.Preferences["ReadonlyfieldsbasedonExpressionXML"].toString().split(',');

        if (Sender instanceof PactControlData && !Util.IsEmpty(Sender.DBColumnName) && sFlds.Contains(Sender.DBColumnName)) {
            Sender.IsReadOnly = IsReadOnly;
            if (Sender instanceof PactCodeNameListBoxData)
                Sender.Code.IsReadOnly = Sender.Name.IsReadOnly = Sender.IsReadOnly;
        }
        else if (Sender instanceof DgColumn && ((!Util.IsEmpty(Sender.ValueBinding) && sFlds.Contains(Sender.ValueBinding)) || (!Util.IsEmpty(Sender.DisplayMember) && sFlds.Contains(Sender.DisplayMember)))) {
            Sender.ReadOnly = IsReadOnly;
        }
    }

    public Addguid() {

        if (!this.ScreenObject.GridDataColumns.Contains("StyleHeightZero"))
            this.ScreenObject.GridDataColumns.push("StyleHeightZero");
        else
            this.ScreenObject.GridDataColumns.push("tempcol");

        if (this.ScreenObject.Preferences.ContainsKey("DbCrBills") && Util.String(this.ScreenObject.Preferences["DbCrBills"]) == "True") {
            let DbCrNetFld = '';
            if (this.ScreenObject.Preferences.ContainsKey("DbCrBills") && this.ScreenObject.Preferences["DbCrBills"].toString() == "True"
                && this.ScreenObject.Preferences.ContainsKey("NetAmountFld") && this.ScreenObject.Preferences["NetAmountFld"] != "")
                DbCrNetFld = this.ScreenObject.Preferences["NetAmountFld"];

            if (!this.ScreenObject.GridDataColumns.Contains("guidCol"))
                this.ScreenObject.GridDataColumns.push("guidCol");
            let ColName = '';
            if (this.ScreenObject.DocumentType == 18 || this.ScreenObject.DocumentType == 19 || this.ScreenObject.DocumentType == 21 || this.ScreenObject.DocumentType == 22)
                ColName = "CreditAccount_Key";
            else if (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 15 || this.ScreenObject.DocumentType == 20 || this.ScreenObject.DocumentType == 23)
                ColName = "DebitAccount_Key";
            else
                ColName = "AccountID_Key";

            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["Amount"]) && parseFloat(this.ScreenObject.GridData[i]["Amount"].toString()) > 0) {
                    var drrows = this.ScreenObject.GridData.filter(x => x[ColName] == Util.String(this.ScreenObject.GridData[i][ColName]) && x.Amount < 0 && x.guidCol == null);
                    if (drrows.length > 0) {
                        this.ScreenObject.GridData[i]["guidCol"] = Util.NewGuid();
                        drrows[0]["guidCol"] = this.ScreenObject.GridData[i]["guidCol"].toString();
                        if (DbCrNetFld != '')
                            drrows[0]["StyleHeightZero"] = 1;
                    }
                }
            }
        }
        this.ScreenObject.UpdateSequence();
        if (this.ScreenObject.GridDataColumns.Contains("tempcol"))
            this.ScreenObject.GridDataColumns.Remove("tempcol");

    }


    LoadEditCallBack(ds: any) {
        /*** if (RightTabSelectedIndex > 1)
         RightTabSelectedIndex = 0;***/
        let btn: PactButtonData;
        let btnsubmit = this.GetButton("Submit");
        let btnHistory = this.GetButton("History");
        this.WfID = 0;
        this.WorkFlowDocLevel = 0;
        this.IsLocked = false;
        this.IsReplaced = 0;
        this.LCDueAmt = 0;
        btnsubmit.Visible = false;
        this.ChkRtnXml = "";
        this.DisplayMessage = "";
        this.MessageVisibility = false;
        this.IsUserLock = false;
        this.BtnRejVisible = true;
        this.ArApBills = "";
        if (this.pdcGCVM != null)
            this.pdcGCVM = new pdcGenerateChequeViewModel(this);

        if (this.ScreenObject.Preferences.ContainsKey("DbCrBills") && Util.String(this.ScreenObject.Preferences["DbCrBills"]) == "True")
            this.Addguid();

        if (!this.IsInventoryVoucher && this.pdcGCVM != null && this.DocumentType != 16 && ds.Columns[0].Contains("Description") && ds.Tables[0].length > 0 && !Util.IsEmpty(ds.Tables[0][0]["Description"])) {
            this.pdcGCVM.loadFromxml(ds.Tables[0][0]["Description"].toString(), this.ScreenObject.GridData[0]["Amount"].toString());
        }

        if (this.ScreenObject.DocumentType == 56) // Apply Loan -> Loading Loan Guarantees
        {
            if (this.LoanGuaranteeVisible) {
                this.dtLoanGuarantees = null;
                let dtG = BaseService.common.GetDataSet("PAY051", this.DocID.toString()).Tables[0];
                if (dtG != null && dtG.length > 0) {
                    this.dtLoanGuarantees = [];
                    /**this.dtLoanGuaranteesColumns.push("GEmpSeqNo");*/
                    let drw;
                    for (let i = 0; i < dtG.length; i++) {
                        drw = {};
                        drw["GEmpSeqNo"] = dtG[i]["GEmpSeqNo"].toString();
                        this.dtLoanGuarantees.push(drw);
                    }
                }
            }
        }

        if (this.ScreenObject.DocumentType == 61) // Vacation Management -> Define Days
        {
            this.dtVacDefineDays = null;
            let dtVDD = BaseService.common.GetDataSet("PAY052", this.DocID.toString()).Tables[0];
            if (dtVDD != null && dtVDD.length > 0) {
                this.dtVacDefineDays = []
                /** this.dtVacDefineDaysColumns.push("SNo", typeof(int));
                 this.dtVacDefineDaysColumns.push("FromMonth", typeof(int));
                 this.dtVacDefineDaysColumns.push("ToMonth", typeof(int));
                 this.dtVacDefineDaysColumns.push("DaysPerMonth", typeof(double));
                 this.dtVacDefineDaysColumns.push("ApplyToPrevMonths");
 */
                let drw;
                for (let i = 0; i < dtVDD.length; i++) {
                    drw = {};
                    drw["SNo"] = dtVDD[i]["SNo"].toString();
                    drw["FromMonth"] = dtVDD[i]["FromMonth"].toString();
                    drw["ToMonth"] = dtVDD[i]["ToMonth"].toString();
                    drw["DaysPerMonth"] = dtVDD[i]["DaysPerMonth"].toString();
                    drw["ApplyToPrevMonths"] = dtVDD[i]["ApplyToPrevMonths"].toString();
                    this.dtVacDefineDays.push(drw);
                }
            }
        }

        if (this.ScreenObject.DocumentType == 62)
            this.dtData = ds.Tables[1];

        this.FillCreatedByDate_ds(ds);
        if (this.Currency != null && this.Currency.Currency != null && this.Currency.Currency.SelectedValue != null)
            this.lastCurr = this.Currency.Currency.SelectedValue;

        this.ButtonApprove.Visible = false;

        if (this.ViewNotes != null)
            this.ViewNotes.NotesListObj.Clear();

        if (this.DtPack != null)
            this.DtPack.Clear();

        if (this.ViewAttachments != null)
            this.ViewAttachments.AttachmentsListObj.Clear();

        if (this.grdLinkTab != null) {
            this.grdLinkTab.Clear();
            this.grdLinkTab.loadGrid(this.ScreenObject.VoucherNo);
            this.grdLinkTab.linkTabs.Pages.map(x => x.IsAccordionOpen = (this.ScreenObject.Preferences.ContainsKey("OpenAllSection") && this.ScreenObject.Preferences["OpenAllSection"] == "True"));
        }

        if (this.ViewActivities != null) {
            this.ViewActivities.ActivityGridDataObj.Clear();
        }

        if (this.Activities != null)
            this.Activities.ClearFields();

        if (this.AssignAddress != null) {
            this.AssignAddress.AddressTo.Clear();
            this.AssignAddress.BillTo.Clear();
            this.AssignAddress.ShipTo.Clear();
        }
        if (this.ViewOrganizationViewModel != null)
            this.ViewOrganizationViewModel.OrganizationData.Clear();

        if (this.ScreenObject.IsForecast)
            this.ScreenObject.GridDataObj.RefreshColumns();

        this.StatusID = parseInt(ds.Tables[0][0]["StatusID"]);

        if (ds.Columns[0].Contains("WorkFlowLevel") && ds.Tables[0][0]["WorkFlowLevel"] != null && this.StatusID != 372)
            this.WorkFlowDocLevel = parseInt(ds.Tables[0][0]["WorkFlowLevel"]);

        if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0 && ds.Columns[0].Contains("DocNumber") && ds.Tables[0][0]["DocNumber"].toString() != this.ScreenObject.DocPrefix.TextBox.Text) {
            this.ScreenObject.DocPrefix.TextBox.Text = ds.Tables[0][0]["DocNumber"].toString();
        }
        if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0 && ds.Columns[0].Contains("DocDate") && !Util.IsEmpty(ds.Tables[0][0]["DocDate"])) {
            this._Ddate = Util.ParseDate(ds.Tables[0][0]["DocDate"]);
            this.ScreenObject.DocDate.Date = this.DocumentDate;
            if (this.ScreenObject.DocumentType != 38)
                this.ScreenObject.SetView(this.ScreenObject.DocDate, this.StatusID);
        }

        let btnTemp = this.GetButton("GST");
        if (btnTemp != null) {
            if (this.StatusID == 369)
                btnTemp.Visible = true;
            else
                btnTemp.Visible = false;
        }

        btnTemp = this.GetButton("API");
        if (btnTemp != null) {
            if (this.StatusID == 369)
                btnTemp.Visible = true;
            else
                btnTemp.Visible = false;
        }
        btnTemp = this.GetButton("UBL");
        if (btnTemp != null) {
            if (this.StatusID == 369)
                btnTemp.Visible = true;
            else
                btnTemp.Visible = false;
        }

        btnTemp = this.GetButton("UBLNEW");
        if (btnTemp != null) {
            if (this.StatusID == 369)
                btnTemp.Visible = true;
            else
                btnTemp.Visible = false;
        }

        btnTemp = this.GetButton("PriceChart");
        if (btnTemp != null) {
            if (this.StatusID == 369)
                btnTemp.Visible = true;
            else
                btnTemp.Visible = false;
        }

        let btnGen = this.GetButton("Generate");
        if (this.IsInventoryVoucher) {
            if (btnGen != null) {
                if (!(ds.Columns[0].Contains("LinkStatusID") && ds.Tables[0].filter(x => x.LinkStatusID != 445).length == 0)) {
                    if (this.StatusID == 369)
                        btnGen.Visible = true;
                    else if (this.StatusID == 372 && this.ScreenObject.Preferences.ContainsKey("LinkUnposted") && this.ScreenObject.Preferences["LinkUnposted"] != "" && parseBoolean(this.ScreenObject.Preferences["LinkUnposted"]))
                        btnGen.Visible = true;
                    else
                        btnGen.Visible = false;
                }
                else
                    btnGen.Visible = false;
            }

            let btnadv = this.GetButton("Advance");
            if (this.StatusID == 369 && btnadv != null)
                btnadv.Visible = true;
            else if (btnadv != null)
                btnadv.Visible = false;

            if (this.IsEdit && this.ScreenObject.Link != null && this.ScreenObject.Link.LinkCombo != null && this.ScreenObject.Link.LinkCombo.SelectedValue != null &&
                this.ScreenObject.Link.LinkCombo.SelectedValue != "" && parseInt(this.ScreenObject.Link.LinkCombo.SelectedValue) > 0) {
                this.IsEdit = false;
                this.OLinkSelectionChanged("");
            }

            if (ds.Tables.length > 0 && ds.Columns[0].Contains("IsQtyIgnored") && ds.Tables[0].length > 0
                && !Util.IsEmpty(this.donotupInv)) {
                for (let k = 0; k < ds.Tables[0].length; k++) {
                    if (ds.Tables[0][k]["ProductTypeID"].toString() == "6" || ds.Tables[0][k]["ProductTypeID"].toString() == "8" || ds.Tables[0][k]["ProductTypeID"].toString() == "3")
                        continue;
                    if (!Util.IsEmpty(ds.Tables[0][k]["IsQtyIgnored"]))
                        this.donotupInv.IsChecked = parseBoolean(ds.Tables[0][k]["IsQtyIgnored"]);
                    break;
                }
            }
            if (ds.Tables.length > 0 && ds.Columns[0].Contains("LinkStatusRemarks") && ds.Tables[0].length > 0 && !Util.IsEmpty(ds.Tables[0][0]["LinkStatusRemarks"]))
                this.linkStatusRemarks = ds.Tables[0][0]["LinkStatusRemarks"].toString();
            else
                this.linkStatusRemarks = "";

            if (this.ViewNotes != null && ds.Tables.length > 7)
                this.ViewNotes.LoadNotes(ds.Tables[7]);
            if (this.ViewAttachments != null && ds.Tables.length > 8) {
                this.ViewAttachments.LoadAttachments(ds.Tables[8], ds.Tables[0]);
            }
            if (ds.Tables.length > 9) {
                if (this.ViewActivities != null) {
                    this.ViewActivities.NodeID = this.DocID;
                    this.ViewActivities.LoadActivityData(ds.Tables[9]);
                }
                else if (ds.Tables[9].length > 0) {
                    //this.ViewActivities = new ViewActivitiesViewModel(this);
                    this.ViewActivities.NodeID = this.DocID;
                    this.NodeID = this.DocID;
                    //this.Activities = new ActivitiesViewModel(this, false);
                    //this.Activities.AssignVisiblity = false;
                    //  this.ViewActivities.Activities = this.Activities;
                    this.ViewActivities.CloseVisible = true;
                    this.ViewActivities.SetColumnsVisibility(this.Activities);
                    this.ViewActivities.LoadActivityData(ds.Tables[9]);
                }
            }

            this.AddAddress(ds);

            let dvCnt: any[];
            if (this.ScreenObject.Data.Tables[0].length > 0 && this.ScreenObject.GridDataColumns.Contains("ProductID_Key")) {
                ;
                dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName != null && x.SysColumnName == 'Quantity' && x.Cformula != null);
                if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])
                    && this.ScreenObject.GridDataColumns.Contains("FreeQTY")) {
                    for (let r = 0; r < this.ScreenObject.GridData.length; r++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[r]["ProductID_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[r]["UOMConvertedQty"])) {
                            this.ScreenObject.GridData[r]["FreeQty"] = parseFloat(this.ScreenObject.GridData[r]["UOMConvertedQty"].toString());
                            this.ScreenObject.GridDataObj.updateRow(this.ScreenObject.GridData[r]);
                            this.ScreenObject.GridDataObj.refreshDatawithIDs();
                        }
                    }
                }

                dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 50455);
                if (dvCnt.length > 0 && this.ScreenObject.GridDataColumns.Contains(dvCnt[0]["SysColumnName"])) {
                    this.ScreenObject.GridData.forEach(dr => {
                        if (!Util.IsEmpty(dr["ProductID_Key"]))
                            this.CalculateTotals(dr, false);
                    });
                }
            }
            if (ds.Tables.length > 15 && ds.Columns[15].Contains("Amount")) {
                let sb = "";
                if (ds.Tables[15].length > 0) {
                    sb += "<Paymentterms>";
                    for (let i = 0; i < ds.Tables[15].length; i++) {
                        if (!Util.IsEmpty(ds.Tables[15][i]["Amount"])) {
                            sb += "<Row ";
                            sb += " Percentage=\"" + Util.String(ds.Tables[15][i]["Percentage"]) + "\" ";

                            sb += " BasedOn=\"" + Util.String(ds.Tables[15][i]["BasedOn"]) + "\" ";
                            sb += " Period=\"" + Util.String(ds.Tables[15][i]["Period"]) + "\" ";
                            sb += " DateNo=\"" + Util.String(ds.Tables[15][i]["DateNo"]) + "\" ";
                            if (!Util.IsEmpty(ds.Tables[15][i]["BaseDate"]))
                                sb += " BaseDate=\"" + Util.ParseDate(ds.Tables[15][i]["BaseDate"]).ToString("dd/MMM/yyyy") + "\" ";
                            if (ds.Columns[15].Contains("ProfileID") && !Util.IsEmpty(ds.Tables[15][i]["ProfileID"])) {
                                sb += " ProfileId=\"" + ds.Tables[15][i]["ProfileID"].toString() + "\" ";
                                sb += " ProfileName=\"" + Util.String(PactTextBoxData.GetValidXml(ds.Tables[15][i]["ProfileName"])) + "\" ";
                            }
                            if (ds.Columns[15].Contains("TotAmt") && !Util.IsEmpty(ds.Tables[15][i]["TotAmt"]))
                               sb+=" TotAmt=\""+ds.Tables[15][i]["TotAmt"].toString()+"\" ";

                            if (!Util.IsEmpty(ds.Tables[15][i]["DimCCID"]))
                                sb += " DimCCID=\"" + ds.Tables[15][i]["DimCCID"].toString() + "\" ";
                            if (!Util.IsEmpty(ds.Tables[15][i]["DimNodeID"]))
                                sb += " DimNodeID=\"" + ds.Tables[15][i]["DimNodeID"].toString() + "\" ";

                            sb += " Accountid=\"" + ds.Tables[15][i]["AccountID"].toString() + "\" ";
                            sb += " Amount=\"" + ds.Tables[15][i]["Amount"].toString() + "\" ";
                            if (!Util.IsEmpty(ds.Columns[15].Contains("AmountFC") && ds.Tables[15][i]["AmountFC"]))
                                sb += " AmountFC=\"" + ds.Tables[15][i]["AmountFC"].toString() + "\" ";
                            sb += " Days=\"" + ds.Tables[15][i]["days"].toString() + "\" ";
                            if (!Util.IsEmpty(ds.Tables[15][i]["DueDate"]))
                                sb += " DueDate=\"" + Util.ParseDate(ds.Tables[15][i]["DueDate"]).ToString("dd/MMM/yyyy") + "\" ";
                            sb += " Remarks=\"" + PactTextBoxData.GetValidXml(ds.Tables[15][i]["Remarts"]) + "\" ";
                            sb += " Remarks1=\"" + PactTextBoxData.GetValidXml(ds.Tables[15][i]["Remarts1"]) + "\" ";
                            sb += " /> ";
                        }
                    }
                    sb += "</Paymentterms>";
                    this.payTermXml = sb;
                }
            }
            if (this.ScreenObject.IsInventory && ds.Tables.length > 21 && ds.Columns[21].Contains("DocID") && ds.Tables[21].length > 0) {
                let sb = '';
                let batches: any = ds.Tables[21].filter(x => x.InvDocDetailsID == 0 && x.DocID == this.ScreenObject.DocID);

                if (batches.length > 0) {
                    sb += "<QtyAdjustments>";
                    batches.forEach(item => {
                        sb += "<Row ";
                        for (let l = 0; l < ds.Columns[21].length; l++) {
                            if (ds.Columns[21][l].Contains("Fld") && !Util.IsEmpty(item[ds.Columns[21][l]]))
                                sb += ds.Columns[21][l] + "=\"" + PactTextBoxData.GetValidTextXml(item[ds.Columns[21][l]].toString()) + "\" ";
                        }
                        if (Util.String(item["Islinked"]) == "1" || Util.String(item["Islinked"]) == "True")
                            sb += "Islinked=\"1\" ";
                        else
                            sb += "Islinked=\"0\" ";

                        if (!Util.IsEmpty(item["RefVoucherNo"]))
                            sb += "RefVoucherNo=\"" + item["RefVoucherNo"].toString() + "\" ";
                        sb += " ></Row>";
                    });

                    sb += "</QtyAdjustments>";
                    this.QtyXML = sb.toString();
                }
            }
            else if (this.ScreenObject.IsInventory && ds.Tables.length > 4 && ds.Columns[4].Contains("DocID") && ds.Tables[4].length > 0 && this.ScreenObject.DocPrefix.RevisionCombo.SelectedValue != this.ScreenObject.DocPrefix.RevisionCombo.Items[this.ScreenObject.DocPrefix.RevisionCombo.Items.length - 1].Value) {
                let sb = '';
                let batches: any = ds.Tables[4].filter(x => x.InvDocDetailsID == 0 && x.DocID == this.ScreenObject.DocID);

                if (batches.length > 0) {
                    sb += "<QtyAdjustments>";
                    batches.forEach(item => {
                        sb += "<Row ";
                        for (let l = 0; l < ds.Columns[4].length; l++) {
                            if (ds.Columns[4][l].Contains("Fld") && !Util.IsEmpty(item[ds.Columns[4][l]]))
                                sb += ds.Columns[4][l] + "=\"" + PactTextBoxData.GetValidTextXml(item[ds.Columns[4][l]].toString()) + "\" ";
                        }
                        if (Util.String(item["Islinked"]) == "1" || Util.String(item["Islinked"]) == "True")
                            sb += "Islinked=\"1\" ";
                        else
                            sb += "Islinked=\"0\" ";

                        if (!Util.IsEmpty(item["RefVoucherNo"]))
                            sb += "RefVoucherNo=\"" + item["RefVoucherNo"].toString() + "\" ";
                        sb += " ></Row>";
                    });

                    sb += "</QtyAdjustments>";
                    this.QtyXML = sb.toString();
                }
            }

            if (ds != null && ds.Tables.length > 27 && ds.Tables[27].length > 0 && ds.Columns[27].Contains("RefDocNO")) {

                let sb = "";

                for (let i = 0; i < ds.Tables[27].length; i++) {
                    sb += "<NonAccRows  RefDocNo=\"" + ds.Tables[27][i]["RefDocNO"].toString() + "\" Amount=\"";
                    sb += ds.Tables[27][i]["Amount"].toString() + "\" ";
                    if (this.DocumentType != 38)
                        sb += "AccountID=\"" + ds.Tables[27][i]["AccountID"].toString() + "\" ";
                    sb += " />";
                }
                this.ArApBills = sb;
            }

            if (ds.Tables.length > 23 && ds.Tables[23].length > 0 && ds.Columns[23].Contains("AdjAmount")) {
                let sb = "";
                sb += "<ChkRtnXML>";
                for (let i = 0; i < ds.Tables[23].length; i++) {
                    if (!Util.IsEmpty(ds.Tables[23][i]["AdjAmount"])) {
                        sb += "<Row ";
                        sb += "DocSeqNo=\"1\" ";

                        sb += " AccountID=\"" + ds.Tables[23][i]["AccountID"].toString() + "\" ";
                        sb += "IsNewReference=\"0\" ";
                        sb += " RefDocNo=\"" + ds.Tables[23][i]["RefDocNo"].toString() + "\" ";
                        sb += " RefDocSeqNo=\"" + ds.Tables[23][i]["RefDocSeqNo"].toString() + "\" ";
                        if (!Util.IsEmpty(ds.Tables[23][i]["RefDocDate"]))
                            sb += " RefDocDate=\"" + Util.ParseDate(ds.Tables[23][i]["RefDocDate"]).ToString("dd/MMM/yyyy") + "\" ";

                        sb += " AdjAmount=\"" + ds.Tables[23][i]["AdjAmount"].toString() + "\" ";
                        sb += " Amount=\"" + ds.Tables[23][i]["AmountFC"].toString() + "\" ";
                        sb += " AdjCurrID=\"" + ds.Tables[23][i]["AdjCurrID"].toString() + "\" ";
                        sb += " AdjExchRT=\"" + ds.Tables[23][i]["AdjExchRT"].toString() + "\" ";

                        if (!Util.IsEmpty(ds.Tables[23][i]["RefDocDueDate"]))
                            sb += " RefDocDueDate=\"" + Util.ParseDate(ds.Tables[23][i]["RefDocDueDate"]).ToString("dd/MMM/yyyy") + "\" ";
                        sb += " Narration=\"" + ds.Tables[23][i]["Narration"].toString() + "\" ";
                        sb += " /> ";

                    }
                }
                sb += "</ChkRtnXML>";
                this.ChkRtnXml = sb;
            }

            if (this.POSPayModes != null && this.IsPOs && ds.Tables.length > 16 && ds.Columns[16].Contains("Amount")) {
                this.POSPayModes.clear();
                for (let i = 0; i < ds.Tables[16].length; i++) {
                    let Selectedbtn = this.POSPayModes.PayModes.find(a => a.DBColumnName == ds.Tables[16][i]["DBColumnName"].toString());
                    if (Selectedbtn) {
                        let drpay;
                        if (i < this.POSPayModes.GridData.length)
                            drpay = this.POSPayModes.GridData[i];
                        else {
                            drpay = this.POSPayModes.GridDataObj.NewRow();
                            this.POSPayModes.GridData.push(drpay);
                        }

                        drpay["Name"] = Selectedbtn.Label;
                        drpay["Amount"] = ds.Tables[16][i]["Amount"].toString();
                        drpay["ColumnName"] = Selectedbtn.DBColumnName;
                        drpay["Type"] = Selectedbtn.SectionID;

                        let sb = "";
                        sb += "<XML Amount=\"" + ds.Tables[16][i]["Amount"].toString() + "\" ";
                        sb += " DBColumnName=\"" + Selectedbtn.DBColumnName + "\" ";
                        sb += " Type=\"" + Selectedbtn.SectionID + "\" ";

                        sb += " RegisterID=\"" + this.ScreenObject.RegisterNodeID + "\" ";
                        sb += " ShiftID=\"" + this.ScreenObject.ShiftNodeID + "\" ";
                        sb += " DocDate=\"" + this.DocumentDate.ToString("dd/MMM/yyyy") + "\" ";

                        if (Selectedbtn.SectionID == "5" && this.ScreenObject.Preferences.ContainsKey("CashForeignCurrency") && parseBoolean(this.ScreenObject.Preferences["CashForeignCurrency"])) {
                            if (!Util.IsEmpty(ds.Tables[16][i]["Currency"])) {
                                sb += " Currency=\"" + ds.Tables[16][i]["Currency"].toString() + "\" ";
                                let currfld = this.POSPayModes.Currency.Currency.Items.find(a => a.Value == ds.Tables[16][i]["Currency"].toString());
                                if (currfld) {
                                    drpay["Description"] = ds.Tables[16][i]["AmountFC"].toString() + " " + currfld.Name + "@" + ds.Tables[16][i]["ExchangeRate"].toString();
                                }
                            }
                            if (!Util.IsEmpty(ds.Tables[16][i]["ExchangeRate"]))
                                sb += " ExchangeRate=\"" + ds.Tables[16][i]["ExchangeRate"].toString() + "\" ";
                            if (!Util.IsEmpty(ds.Tables[16][i]["AmountFC"]))
                                sb += " FCAmt=\"" + ds.Tables[16][i]["AmountFC"].toString() + "\" ";
                        }

                        if (Selectedbtn.SectionID == "6" || Selectedbtn.SectionID == "7") {
                            drpay["Description"] = ds.Tables[16][i]["CardNo"].toString();
                            sb += " CardNo=\"" + PactTextBoxData.GetValidXml(ds.Tables[16][i]["CardNo"]) + "\" ";
                            sb += " CardName=\"" + PactTextBoxData.GetValidXml(ds.Tables[16][i]["CardName"]) + "\" ";
                            if (!Util.IsEmpty(ds.Tables[16][i]["ExpDate"]))
                                sb += " ExpDate=\"" + Util.ParseDate(ds.Tables[16][i]["ExpDate"]).ToString("dd/MMM/yyyy") + "\" ";
                            if (Selectedbtn.SectionID == "6") {
                                sb += " ApprovalCode=\"" + PactTextBoxData.GetValidXml(ds.Tables[16][i]["ApprovalCode"]) + "\" ";
                                if (!Util.IsEmpty(ds.Tables[16][i]["BankName"]))
                                    sb += " BankName=\"" + ds.Tables[16][i]["BankName"].toString() + "\" ";
                                if (!Util.IsEmpty(ds.Tables[16][i]["CardType"]))
                                    sb += " CardType=\"" + ds.Tables[16][i]["CardType"].toString() + "\" ";
                            }
                        }
                        else if (Selectedbtn.SectionID == "5" || Selectedbtn.SectionID == "8") {
                            let sbden = "";
                            let drdenom = null;
                            if (Selectedbtn.SectionID == "5")
                                drdenom = ds.Tables[17].filter(x => x.CurrencyID != -10);
                            else
                                drdenom = ds.Tables[17].filter(x => x.CurrencyID == -10);

                            for (let l = 0; l < drdenom.length; l++) {
                                sbden += "<XML IsDenom=\"1\" ";
                                if (!Util.IsEmpty(drdenom[l]["Notes"]) && !Util.IsEmpty(drdenom[l]["NotesTender"])) {
                                    sbden += " CurrencyID=\"" + drdenom[l]["CurrencyID"].toString() + "\" Notes=\"" + drdenom[l]["Notes"].toString() + "\"  NotesTender=\"";
                                    sbden += drdenom[l]["NotesTender"].toString() + "\"  Change=\"";
                                }

                                if (!Util.IsEmpty(drdenom[l]["Change"]) && !Util.IsEmpty(drdenom[l]["ChangeTender"]))
                                    sbden += drdenom[l]["Change"].toString() + "\" ChangeTender=\"" + drdenom[l]["ChangeTender"].toString() + "\" />";
                                else
                                    sbden += "0\" ChangeTender=\"0\" />";

                            }
                            drpay["Denomination"] = sbden.toString();
                        }
                        else if (Selectedbtn.SectionID == "9" || Selectedbtn.SectionID == "10") {
                            drpay["Description"] = ds.Tables[16][i]["CardNo"].toString();
                            sb += " CardNo=\"" + PactTextBoxData.GetValidXml(ds.Tables[16][i]["CardNo"]) + "\" ";
                            if (Selectedbtn.SectionID == "9")
                                sb += " VoucherNodeID=\"" + ds.Tables[16][i]["VoucherNodeID"].toString() + "\" ";
                        }
                        sb += " />";
                        drpay["Details"] = sb;
                    }
                    else if (ds.Tables[16][i]["Type"].toString() == "12" && ds.Tables[16][i]["DBColumnName"].toString().toLowerCase() == this.POSPayModes.Returnfld.toLowerCase()) {
                        if (this.POSPayModes.ReturnDecimalPoints != "" && !Util.IsEmpty(ds.Tables[16][i]["Amount"]))
                            this.POSPayModes.Return = parseFloat(ds.Tables[16][i]["Amount"]).ToString("N" + this.POSPayModes.ReturnDecimalPoints);
                        else if (this.POSPayModes.ReturnDecimalPoints != "")
                            this.POSPayModes.Return = (0).ToString("N" + this.POSPayModes.ReturnDecimalPoints);
                        else
                            this.POSPayModes.Return = ds.Tables[16][i]["Amount"].toString();
                    }
                }
            }

            if (this.ScreenObject.DocumentType == 30 && this.ScreenObject.Preferences.ContainsKey("UseasAssemble/DisAssembly") && parseBoolean(this.ScreenObject.Preferences["UseasAssemble/DisAssembly"])
                && ds.Tables.length > 20 && ds.Tables[20].length > 0) {
                let drkit: any[] = this.ScreenObject.GridData.filter(x => x.ProductID_key == ds.Tables[20][0]["ParentProductID"]);
                if (drkit.length > 0) {
                    if (!this.ScreenObject.GridDataColumns.Contains("IsKit"))
                        this.ScreenObject.GridDataColumns.push("IsKit");

                    drkit[0]["IsKit"] = 1;

                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                            drkit = ds.Tables[20].filter(x => x.ProductID == this.ScreenObject.GridData[i]["ProductID_Key"]);
                            if (drkit.length > 0) {
                                this.ScreenObject.GridData[i]["IsKit"] = 2;
                                this.ScreenObject.GridData[i]["DefaultQuantity"] = drkit[0]["Quantity"];
                            }
                        }
                    }
                }
            }

            if (this.ScreenObject.DocumentType == 35 && this.ViewOrganizationViewModel != null) {
                if (ds != null && ds.Tables.length > 17 && ds.Tables[17].length > 0)
                    this.ViewOrganizationViewModel.LoadData(ds.Tables[17]);
            }
            if (ds != null && ds.Tables.length > 18 && ds.Tables[18].length > 0
                && ds.Columns[18].Contains("DocID") && !Util.IsEmpty(ds.Tables[18][0]["DocID"])) {
                if (this.AutoPostViewModel != null && this.AutoPostViewModel.CostCenterID.toString() == ds.Tables[18][0]["costcenterid"].toString())
                    this.AutoPostDocID = parseInt(ds.Tables[18][0]["DocID"]);
                else if (ds.Tables[18].length > 1 && this.AutoPostViewModel != null && this.AutoPostViewModel.CostCenterID.toString() == ds.Tables[18][1]["costcenterid"].toString())
                    this.AutoPostDocID = parseInt(ds.Tables[18][1]["DocID"]);
                else
                    this.AutoPostDocID = 0;

                if (this.AutoProduce != null && this.AutoProduce.CostCenterID.toString() == ds.Tables[18][0]["costcenterid"].toString())
                    this.AutoProduceDocID = parseInt(ds.Tables[18][0]["DocID"]);
                else if (ds.Tables[18].length > 1 && this.AutoProduce != null && this.AutoProduce.CostCenterID.toString() == ds.Tables[18][1]["costcenterid"].toString())
                    this.AutoProduceDocID = parseInt(ds.Tables[18][1]["DocID"]);
                else
                    this.AutoProduceDocID = 0;

                if (this.AutoPostViewModel != null) {
                    if (this.AutoPostDocID > 0) {
                        this.AutoPostViewModel.ScreenObject.DocID = this.AutoPostDocID;
                        let dsautopost: any = this.AutoPostViewModel.ScreenObject.GetEditDataByDOCID();
                        if (ds != null && this.AutoPostViewModel.ScreenObject.IsDocEdit && dsautopost.Tables.length > 0 && dsautopost.Tables[0].length > 0) {

                            ////
                            let Newid1 = "";
                            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                                if (this.ScreenObject.GridData[i]["ProductID_key"].toString() != "") {
                                    Newid1 = Util.NewGuid();
                                    this.ScreenObject.GridData[i]["RefSeqNo"] = Newid1;
                                    this.ScreenObject.GridData[i]["defaultQuantity"] = null;
                                }
                            }
                            //ScreenObject.GridData.AcceptChanges();
                            this.RefreshGrid = true;
                            ///

                            this.AutoPostViewModel.ScreenObject.LoadEditData(dsautopost, false);

                            let drcc1 = null;
                            for (let p = 0; p < this.ScreenObject.GridData.length; p++) {
                                if (this.ScreenObject.GridData[p]["ProductID_key"].toString() != "" && !Util.IsEmpty(this.ScreenObject.GridData[p]["RefSeqNo"].toString())) {
                                    for (let c = 0; c < this.AutoPostViewModel.ScreenObject.GridData.length; c++) {
                                        if (this.AutoPostViewModel.ScreenObject.GridData[c]["ProductID_key"].toString() != "") {
                                            drcc1 = dsautopost.Tables[0].filter(x => x["DocDetailsID"] == this.AutoPostViewModel.ScreenObject.GridData[c]["DocDetailsID"].toString());
                                            if (drcc1 != null && drcc1.length > 0) {
                                                if (drcc1[0]["RefNodeID"].toString() == this.ScreenObject.GridData[p]["DocDetailsID"].toString()) {
                                                    this.AutoPostViewModel.ScreenObject.GridData[c]["RefSeqNo"] = this.ScreenObject.GridData[p]["RefSeqNo"].toString();
                                                    this.AutoPostViewModel.ScreenObject.GridData[c]["defaultQuantity"] = null;
                                                }
                                            }

                                        }
                                    }
                                }

                            }

                            /**this.AutoPostViewModel.ScreenObject.GridData.AcceptChanges();**/
                            this.AutoPostViewModel.RefreshGrid = true;

                            if (this.ScreenObject.Preferences.ContainsKey("Autopostdocument") && this.ScreenObject.Preferences["Autopostdocument"] != "" && this.ScreenObject.Preferences["Autopostdocument"] != "0") {
                                let qtyfld = this.AutoPostViewModel.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == this.ScreenObject.Preferences["FPQty"].toLowerCase());
                                if (qtyfld && qtyfld instanceof PactTextBoxData) {
                                    let Newid = Util.NewGuid().toString();

                                    let Fqty = 0;
                                    if (Util.IsNum(qtyfld.Text))
                                        Fqty = parseFloat(qtyfld.Text);
                                    for (let i = 0; i < this.AutoPostViewModel.ScreenObject.GridData.length; i++) {
                                        if (!Util.IsEmpty(this.AutoPostViewModel.ScreenObject.GridData[i]["ProductID_Key"]) &&
                                            !Util.IsEmpty(this.AutoPostViewModel.ScreenObject.GridData[i]["Quantity"])) {
                                            this.AutoPostViewModel.ScreenObject.GridData[i]["RefSeqNo"] = Newid;
                                            this.AutoPostViewModel.ScreenObject.GridData[i]["defaultQuantity"] = parseFloat(this.AutoPostViewModel.ScreenObject.GridData[i]["Quantity"]) / Fqty;
                                        }
                                    }
                                    if (this.ScreenObject.GridData.length > 0)
                                        this.ScreenObject.GridData[0]["RefSeqNo"] = Newid;

                                }
                            }
                            this.AutoPostViewModel.ScreenObject.GridDataObj.RefreshGridView();
                            this.AutoPostViewModel.RefreshGrid = true;
                        }
                    }
                    else
                        this.AutoPostViewModel.ScreenObject.GridData.Clear();
                }
                if (this.AutoProduce != null) {
                    this.AutoProduce.ScreenObject.DocID = this.AutoProduceDocID;
                    if (this.AutoProduceDocID > 0) {
                        let dsautopost: any = this.AutoProduce.ScreenObject.GetEditDataByDOCID();
                        if (ds != null && this.AutoProduce.ScreenObject.IsDocEdit && dsautopost.Tables.length > 0 && dsautopost.Tables[0].length > 0) {
                            this.AutoProduce.ScreenObject.LoadEditData(dsautopost, false);
                        }
                    }
                    else
                        this.AutoProduce.ScreenObject.GridData.Clear();
                }
            }
            else {
                this.AutoPostDocID = 0;
                if (this.AutoPostViewModel != null)
                    this.AutoPostViewModel.ScreenObject.GridData.Clear();

                this.AutoProduceDocID = 0;
                if (this.AutoProduce != null)
                    this.AutoProduce.ScreenObject.GridData.Clear();
            }
            if (this.DtTempSchemes != null)
                this.DtTempSchemes.Clear();

            if (ds != null && ds.Tables.length > 26 && ds.Tables[26].length > 0 && ds.Columns[26].Contains("InvDocDetailsID")) {
                let drrows: any = ds.Tables[26].filter(x => x.Type == 2);
                let tmpdbl: number = 0;
                if (drrows.length > 0) {
                    if (this.DtPack == null) {
                        this.DtPack = [];
                        this.DtPackColumns.push("ID");
                        this.DtPackColumns.push("Name");
                        this.DtPackColumns.push("Label");
                        this.DtPackColumns.push("cWeight");
                        this.DtPackColumns.push("cVolume");
                        this.DtPackColumns.push("Weight");
                        this.DtPackColumns.push("Volume");
                        this.DtPackColumns.push("Height");
                        this.DtPackColumns.push("length");
                        this.DtPackColumns.push("Width");
                        this.DtPackColumns.push("ActualWeight")//, typeof(double));
                        this.DtPackColumns.push("ActualVolume")//, typeof(double));

                        if ((this.ScreenObject.Preferences.ContainsKey("PackWiseProds") && this.ScreenObject.Preferences["PackWiseProds"].toLowerCase() == "true")
                            || (this.ScreenObject.Preferences.ContainsKey("LineWisePacking") && this.ScreenObject.Preferences["LineWisePacking"].toLowerCase() == "true"))
                            this.DtPackColumns.push("Data");

                        if ((this.ScreenObject.Preferences.ContainsKey("ScanwithPack") && this.ScreenObject.Preferences["ScanwithPack"].toLowerCase() == "true")
                            || (this.ScreenObject.Preferences.ContainsKey("AllowDuplLbls") && this.ScreenObject.Preferences["AllowDuplLbls"].toLowerCase() == "true")) {
                            this.DtPackColumns.push("ReportNo");
                            this.DtPackColumns.push("LabID");
                        }
                    }
                    let ids = "";
                    for (let j = 0; j < drrows.length; j++) {
                        let drpk = drrows[j]
                        if (ids != "")
                            ids += ",";
                        ids += drpk["RefID"].toString();
                        let drpkss = this.DtPack.filter(x => x.Label == drpk["label"].toString());
                        let dr;
                        if (drpkss.length == 0) {
                            dr = {};
                            dr["ID"] = drpk["RefID"].toString();
                            dr["Label"] = drpk["label"].toString();
                            if (!Util.IsEmpty(drpk["Fld1"]))
                                dr["length"] = drpk["Fld1"];
                            if (!Util.IsEmpty(drpk["Fld2"]))
                                dr["Width"] = drpk["Fld2"];
                            if (!Util.IsEmpty(drpk["Fld3"]))
                                dr["Height"] = drpk["Fld3"];
                            if (!Util.IsEmpty(drpk["Fld4"]))
                                dr["ActualWeight"] = drpk["Fld4"];
                            if (!Util.IsEmpty(drpk["Fld5"]))
                                dr["ActualVolume"] = drpk["Fld5"];
                            if (this.DtPackColumns.Contains("LabID")) {
                                dr["LabID"] = drpk["LabID"];
                                dr["ReportNo"] = drpk["ReportNo"];
                            }
                            this.DtPack.push(dr);
                        }
                        else
                            dr = drpkss[0];

                        if (this.DtPackColumns.Contains("Data")) {
                            if (ds.Columns[26].Contains("Remarks") && !Util.IsEmpty(drpk["Remarks"]) && drpk["Remarks"].toString().Contains("~")) {
                                dr["Data"] = drpk["Remarks"].toString();
                            }
                            else {
                                if (!Util.IsEmpty(dr["Data"]))
                                    dr["Data"] = dr["Data"].toString() + "," + drpk["Unq"].toString() + "~" + drpk["Quantity"].toString();
                                else
                                    dr["Data"] = drpk["Unq"].toString() + "~" + drpk["Quantity"].toString();
                            }
                        }

                        if (ds.Columns[0].Contains("Volume")) {
                            let drprds = ds.Tables[0].filter(x => x.DocDetailsID == drpk["InvDocDetailsID"]);
                            tmpdbl = 0;
                            if (!Util.IsEmpty(drprds[0]["Volume"]) && !Util.IsEmpty(drpk["Quantity"]))
                                tmpdbl = parseFloat(drprds[0]["Volume"]) * parseFloat(drpk["Quantity"]);
                            if (!Util.IsEmpty(dr["cVolume"]))
                                dr["cVolume"] = parseFloat(dr["cVolume"]) + tmpdbl;
                            else
                                dr["cVolume"] = tmpdbl;

                            tmpdbl = 0;
                            if (!Util.IsEmpty(drprds[0]["Weight"]) && !Util.IsEmpty(drpk["Quantity"]))
                                tmpdbl = parseFloat(drprds[0]["Weight"]) * parseFloat(drpk["Quantity"]);
                            if (!Util.IsEmpty(dr["cWeight"]))
                                dr["cWeight"] = parseFloat(dr["cWeight"]) + tmpdbl;
                            else
                                dr["cWeight"] = tmpdbl;
                        }
                    }
                    let dspk = this.ScreenObject.GetPackDetails(ids);
                    if (dspk != null && dspk.Tables.length > 0 && dspk.Columns[0].Contains("Name") && dspk.Tables[0].length > 0) {
                        dspk.Tables[0].forEach(dsdr => {
                            let drpkrows = this.DtPack.filter(x => x.ID == dsdr["Nodeid"]);
                            drpkrows.forEach(drpk => {
                                drpk["Name"] = dsdr["Name"];
                            });
                        });
                    }
                }
            }
        }
        else {
            let drbrs: any[] = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 55845);
            if (drbrs.length > 0) {
                let dtbrs: Date;
                if (this.ScreenObject.GridDataColumns.Contains(drbrs[0]["SysColumnName"])) {
                    for (let i = 0; i < ds.Tables[0].length; i++) {
                        dtbrs = (Util.isValidDate(ds.Tables[0][i]["ClearanceDate"])) ? Util.ParseDate(ds.Tables[0][i]["ClearanceDate"]) : undefined;
                        if (this.ScreenObject.GridData[i]["DocDetailsID"] == ds.Tables[0][i]["DocDetailsID"]
                            && dtbrs != undefined && dtbrs.getFullYear() > 2000) {
                            this.ScreenObject.GridData[i][drbrs[0]["SysColumnName"]] = dtbrs.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            if (this.ScreenObject.GridDataColumns.Contains(drbrs[0]["SysColumnName"] + "_Key"))
                                this.ScreenObject.GridData[i][drbrs[0]["SysColumnName"] + "_Key"] = dtbrs;
                        }
                    }
                }
                else {
                    let brsfld = this.ScreenObject._TextFields.find(a => a.DBColumnID == parseInt(drbrs[0]["CostCenterColID"]));
                    if (brsfld && Util.isValidDate(ds.Tables[0][0]["ClearanceDate"])) {
                        dtbrs = Util.ParseDate(ds.Tables[0][0]["ClearanceDate"]);
                        if (dtbrs.getFullYear() > 2000) {
                            if (brsfld instanceof PactTextBoxData)
                                brsfld.Text = dtbrs.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            else if (brsfld instanceof PactExtraFieldDateData)
                                brsfld.Date = dtbrs;
                        }
                    }
                }
            }

            drbrs = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 55846);
            if (drbrs.length > 0) {

                if (this.ScreenObject.GridDataColumns.Contains(drbrs[0]["SysColumnName"])) {
                    for (let i = 0; i < ds.Tables[0].length; i++) {
                        if (this.ScreenObject.GridData[i]["DocDetailsID"] == ds.Tables[0][i]["DocDetailsID"]) {
                            if (ds.Tables[0][i]["BRS_Status"].toString() == "0")
                                this.ScreenObject.GridData[i][drbrs[0]["SysColumnName"]] = BaseService.GetResource("Reports_Outstanding");
                            else if (ds.Tables[0][i]["BRS_Status"].toString() == "1")
                                this.ScreenObject.GridData[i][drbrs[0]["SysColumnName"]] = BaseService.GetResource("Reports_Cleared");
                        }
                    }
                }
                else {
                    let brsfld = this.ScreenObject._TextFields.find(a => a.DBColumnID == parseInt(drbrs[0]["CostCenterColID"]));
                    if (brsfld) {
                        if (brsfld instanceof PactTextBoxData) {
                            if (ds.Tables[0][0]["BRS_Status"].toString() == "0")
                                brsfld.Text = BaseService.GetResource("Reports_Outstanding");
                            else if (ds.Tables[0][0]["BRS_Status"].toString() == "1")
                                brsfld.Text = BaseService.GetResource("Reports_Cleared");
                        }
                    }
                }
            }

            this.IsReplaced = 0;
            if (this.StatusID == 429 && ds.Tables[0].length > 0 && ds.Columns[0].Contains("IsReplce") && Util.IsNum(ds.Tables[0][0]["IsReplce"]))
                this.IsReplaced = parseInt(ds.Tables[0][0]["IsReplce"]);

            let btnUBLNEW = this.GetButton("UBLNEW");
            if (btnUBLNEW != null)
                btnUBLNEW.Visible = false;

            let btnred = this.GetButton("Redeposit");
            if (btnred != null && ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("CanRedeposit") && !Util.IsEmpty(ds.Tables[6][0]["CanRedeposit"])
                && parseBoolean(ds.Tables[6][0]["CanRedeposit"].toString()))
                btnred.Visible = true;
            else if (btnred != null)
                btnred.Visible = false;

            if (this.ViewNotes != null && ds.Tables.length > 7)
                this.ViewNotes.LoadNotes(ds.Tables[7]);
            if (this.ViewAttachments != null && ds.Tables.length > 8) {
                this.ViewAttachments.LoadAttachments(ds.Tables[8], ds.Tables[0]);
            }
            if (ds.Tables.length > 9) {
                if (this.ViewActivities != null) {
                    this.ViewActivities.LoadActivityData(ds.Tables[9]);
                    this.ViewActivities.NodeID = this.DocID;
                }
                else if (ds.Tables[9].length > 0) {
                    //this.ViewActivities = new ViewActivitiesViewModel(this);
                    this.ViewActivities.NodeID = this.DocID;
                    this.NodeID = this.DocID;
                    //this.Activities = new ActivitiesViewModel(this, false);
                    this.Activities.AssignVisiblity = false;
                    //  this.ViewActivities.Activities = this.Activities;
                    this.ViewActivities.CloseVisible = true;
                    this.ViewActivities.SetColumnsVisibility(this.Activities);
                    this.ViewActivities.LoadActivityData(ds.Tables[9]);
                }
            }
            if ((this.ScreenObject.Preferences.ContainsKey("UseAsLC") && !Util.IsEmpty(this.ScreenObject.Preferences["UseAsLC"]) && parseBoolean(this.ScreenObject.Preferences["UseAsLC"]))
                || (this.ScreenObject.Preferences.ContainsKey("UseAsTR") && !Util.IsEmpty(this.ScreenObject.Preferences["UseAsTR"]) && parseBoolean(this.ScreenObject.Preferences["UseAsTR"]))) {
                var btncolse = this.GetButton("Close");
                if (btncolse != null)
                    btncolse.Visible = false;

                if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0 && ds.Columns[0].Contains("StatusID") && !Util.IsEmpty(ds.Tables[0][0]["StatusID"])) {
                    if (parseInt(ds.Tables[0][0]["StatusID"].toString()) == 443) {
                        if (btncolse != null)
                            btncolse.Visible = false;
                        this.ButtonApprove.Visible = true;
                    }
                    else {
                        if (btncolse != null)
                            btncolse.Visible = true;
                        this.ButtonApprove.Visible = false;
                        if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit"))
                            btnsubmit.Visible = true;
                        this.ButtonSaveandPrint.Enable = false;
                        this.ButtonSaveandBarcode.Enable = false;
                        this.ButtonSave.Enable = false;
                    }
                }
            }
        }

        if (ds.Tables[0].length > 0 && ds.Columns[0].Contains("WorkflowID") && !Util.IsEmpty(ds.Tables[0][0]["WorkflowID"])
            && parseInt(ds.Tables[0][0]["WorkflowID"]) > 0) {
            btnHistory.Visible = true;

            if (ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("userlevel") && Util.String(ds.Tables[6][0]["userlevel"]) == "1"
                && this.WorkFlowDocLevel == 1 && ds.Columns[6].Contains("Wlevel") && Util.String(ds.Tables[6][0]["Wlevel"]) == "1")
                this.WorkFlowDocLevel = 0;
            else
                this.WfID = parseInt(ds.Tables[0][0]["WorkflowID"]);
        }
        else
            btnHistory.Visible = false;


        if (ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("CanEdit") && !Util.IsEmpty(ds.Tables[6][0]["CanEdit"]) && !parseBoolean(ds.Tables[6][0]["CanEdit"])) {
            if (this.StatusID == 369 && ((this.ScreenObject.Preferences.ContainsKey("NoWorkflowPostedDocs") && this.ScreenObject.Preferences["NoWorkflowPostedDocs"] != ""
                && parseBoolean(this.ScreenObject.Preferences["NoWorkflowPostedDocs"]))
                || BaseService.SessionManager.Preferences["EditApprovedDocuments"].toLowerCase() == "true" || BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Posted Docs"))) {
                this.ButtonSaveandPrint.Enable = true;
                this.ButtonSaveandBarcode.Enable = true;
                this.ButtonSave.Enable = true;
                this.WorkFlowDocLevel = 0;
            }
            else if (this.StatusID == 441 && BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Approved Docs")) {
                this.ButtonSaveandPrint.Enable = false;
                this.ButtonSaveandBarcode.Enable = false;
                this.ButtonSave.Enable = false;
                this.WorkFlowDocLevel = 0;
                btnsubmit.Visible = true;
            }
            else {
                this.ButtonSaveandPrint.Enable = false;
                this.ButtonSaveandBarcode.Enable = false;
                this.ButtonSave.Enable = false;
            }
        }
        else if (!((this.ScreenObject.Preferences.ContainsKey("UseAsLC") && this.ScreenObject.Preferences["UseAsLC"] != "" && parseBoolean(this.ScreenObject.Preferences["UseAsLC"]))
            || (this.ScreenObject.Preferences.ContainsKey("UseAsTR") && this.ScreenObject.Preferences["UseAsTR"] != "" && parseBoolean(this.ScreenObject.Preferences["UseAsTR"])))) {
            if (ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("canapprove")
                && parseBoolean(ds.Tables[6][0]["canapprove"])) {
                this.ButtonApprove.Visible = true;
                this.ButtonSave.Enable = false;
            }
            else if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit")) {
                this.ButtonApprove.Visible = false;
                this.ButtonSave.Enable = true;
            }
            this.ButtonSaveandPrint.Enable = true;
            this.ButtonSaveandBarcode.Enable = true;
        }

        // non-workflow and upper level users
        if (!this.ButtonApprove.Visible && ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("WType")) {
            if (ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("userlevel") && ds.Tables[6][0]["userlevel"] != null
                && ds.Tables[6][0]["Wlevel"] == ds.Tables[6][0]["userlevel"] && this.StatusID != 369) {
                this.ButtonSave.Enable = false;
                this.ButtonSaveandPrint.Enable = false;
                this.ButtonSaveandBarcode.Enable = false;

                if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit")) {
                    if (Util.String(ds.Tables[6][0]["Wlevel"]) == "1")
                        this.ButtonSave.Enable = true;
                    else
                        btnsubmit.Visible = true;
                }
            }
            else if (ds.Tables[6][0]["WType"] == 2 && ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("userlevel")
                && (Util.IsEmpty(ds.Tables[6][0]["userlevel"]) || (!Util.IsEmpty(ds.Tables[6][0]["Wlevel"])
                    && parseInt(ds.Tables[6][0]["Wlevel"]) < parseInt(ds.Tables[6][0]["userlevel"])))
                && this.StatusID != 369) {
                this.ButtonSave.Enable = false;
                this.ButtonSaveandPrint.Enable = false;
                this.ButtonSaveandBarcode.Enable = false;

                if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit") && Util.IsEmpty(ds.Tables[6][0]["userlevel"]))
                    btnsubmit.Visible = true;
            }
            else if (ds.Tables[6][0]["WType"] == 1 && ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("userlevel")
                && ds.Tables[6][0]["userlevel"] != null && this.StatusID != 369) {
                this.ButtonSave.Enable = false;
                this.ButtonSaveandPrint.Enable = false;
                this.ButtonSaveandBarcode.Enable = false;
                if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit"))
                    btnsubmit.Visible = true;
            }
        }


        if (!BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Printed Documents") && ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("IsPrinted")
            && ds.Tables[6][0]["IsPrinted"] != null && parseBoolean(ds.Tables[6][0]["IsPrinted"])) {
            this.ButtonSave.Enable = false;
            this.ButtonSaveandBarcode.Enable = false;
            this.ButtonSaveandPrint.Enable = false;
        }
        if (this.ButtonSave.Enable && (this.StatusID == 371 || this.StatusID == 372 || this.StatusID == 441) && this.ScreenObject.RefCCId == 95 && this.ScreenObject.RefNodeID > 0)
            this.ButtonSave.Enable = false;

        this.ButtonSuspend.Visible = false;
        if (this.ButtonSuspend.Mandatory && !this.IsPOs && BaseService.SessionManager.IsActionAssigned(43, "Modify Link Status")) {
            this.ButtonSuspend.Visible = true;
        }



        //if (this.ScreenObject.Preferences.ContainsKey("LineWisePDC") && this.ScreenObject.Preferences["LineWisePDC"] != "" && parseBoolean(this.ScreenObject.Preferences["LineWisePDC"]))
        //{

        //    ButtonSaveandPrint.Enable = false;
        //    ButtonSaveandBarcode.Enable = false;
        //    ButtonApprove.Visible = false;
        //    ButtonSave.Enable = false;
        //    ButtonSuspend.Enable = false;

        //    //PDCSCleared = false;
        //    //if (ds.Tables.length > 13 && ds.Tables[13].length > 0)
        //    //{
        //    //    PDCSCleared = true;
        //    //}
        //}
        if (this.IsPOs) {
            let btnpay = this.GetButton("Pay");
            if (btnpay != null)
                btnpay.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit");
        }
        if (this.StatusID != 376 && this.ScreenObject.Preferences.ContainsKey("EnableRevision") && this.ScreenObject.Preferences["EnableRevision"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableRevision"])) {
            if (BaseService.SessionManager.HideUnathorizedAccess)
                this.ButtonRevise.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Revise");
            else {
                this.ButtonRevise.Visible = true;
                this.ButtonRevise.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Revise");
            }
        }
        else
            this.ButtonRevise.Visible = false;

        if ((this.StatusID == 371 && this.ButtonSave.Enable) || this.StatusID == 372 || this.StatusID == 438) {
            if (this.StatusID == 372) {
                this.ButtonSave.Enable = false;
                this.ButtonApprove.Visible = false;
                if (!this.OnRejectEdit || (this.OnRejectEdit && !Util.IsEmpty(ds.Tables[6][0]["userlevel"]) && (!Util.IsEmpty(ds.Tables[6][0]["Wlevel"])
                    && parseInt(ds.Tables[6][0]["Wlevel"]) - 1 == parseInt(ds.Tables[6][0]["userlevel"])))) {
                    if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit") || BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Rejected Documents")) {
                        this.ButtonSave.Visible = true;
                        this.ButtonSave.Enable = true;

                        if (BaseService.SessionManager.HideUnathorizedAccess) {
                            this.ButtonSaveandPrint.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");
                            this.ButtonSaveandPrint.Enable = true;
                        }
                        else
                            this.ButtonSaveandPrint.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");

                        this.HideButtons("Save&Barcode");
                    }
                }
            }
            else {
                if (BaseService.SessionManager.HideUnathorizedAccess) {
                    this.ButtonSave.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit");
                    this.ButtonSave.Enable = true;
                }
                else
                    this.ButtonSave.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit");

                if (BaseService.SessionManager.HideUnathorizedAccess) {
                    this.ButtonSaveandPrint.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");
                    this.ButtonSaveandPrint.Enable = true;
                }
                else
                    this.ButtonSaveandPrint.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");

                this.HideButtons("Save&Barcode");
            }
            this.HideButtons("BarcodePrint");
        }
        else if (this.ButtonSave.Enable && this.StatusID != 376) {
            if (BaseService.SessionManager.HideUnathorizedAccess) {
                this.ButtonSave.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit");
                this.ButtonSave.Enable = true;
            }
            else
                this.ButtonSave.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit");

            if (BaseService.SessionManager.HideUnathorizedAccess) {
                this.ButtonSaveandPrint.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");
                this.ButtonSaveandPrint.Enable = true;
            }
            else
                this.ButtonSaveandPrint.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");

            this.HideButtons("Save&Barcode");

            this.HideButtons("BarcodePrint");

            if (this.StatusID != 376 && this.ScreenObject.Preferences.ContainsKey("EnableRevision") && this.ScreenObject.Preferences["EnableRevision"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableRevision"])) {
                if (BaseService.SessionManager.HideUnathorizedAccess)
                    this.ButtonRevise.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Revise");
                else {
                    this.ButtonRevise.Visible = true;
                    this.ButtonRevise.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Revise");
                }
            }
            else
                this.ButtonRevise.Visible = false;
        }
        if (this.ButtonApprove.Visible) {
            if (BaseService.SessionManager.IsRptManagerUser) {

            }
            else {
                if (BaseService.SessionManager.HideUnathorizedAccess)
                    this.ButtonApprove.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Approve");
                else
                    this.ButtonApprove.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Approve");
            }
            if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit"))
                btnsubmit.Visible = true;
        }

        if (this.ScreenObject.Preferences.ContainsKey("enebleSaveonhold") && this.ScreenObject.Preferences["enebleSaveonhold"] == "True") {
            let btnhold = this.GetButton("Save");
            if (btnhold != null) {
                if (this.StatusID == 438) {
                    btnhold.Enable = this.ButtonSave.Enable;
                    btnhold.Visible = this.ButtonSave.Visible;
                }
                else
                    btnhold.Visible = false;
            }
        }

        if (this.ScreenObject.DocumentType == 25) {
            btn = this.GetButton("Enquiries");
            if (btnGen != null && btnGen.Visible)
                btn.Visible = true;
            else {
                if (this.ScreenObject.Preferences.ContainsKey("DisableGenerate") && this.ScreenObject.Preferences["DisableGenerate"] == "True" && this.StatusID == 369)
                    btn.Visible = true;
                else
                    btn.Visible = false;
            }
        }
        if (this.ScreenObject.DocumentType == 31 || this.ScreenObject.DocumentType == 32)
        //if (this.ScreenObject.DocumentType == 31 || this.ScreenObject.DocumentType == 32)
        {
            btn = this.GetButton("Stock Posting");
            if (btn != undefined)
                btn.Visible = false;
            if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0 && ds.Columns[0].Contains("StatusID") && !Util.IsEmpty(ds.Tables[0][0]["StatusID"])) {
                if (parseInt(ds.Tables[0][0]["StatusID"]) == 443)
                    btn.Visible = true;
                else if (parseInt(ds.Tables[0][0]["StatusID"]) == 369) {
                    this.ButtonSave.Enable = false;
                    this.ButtonSaveandBarcode.Enable = false;
                    this.ButtonSaveandPrint.Enable = false;
                }
            }
        }
        if (this.ScreenObject.Preferences.ContainsKey("batchpaymentreport") && !Util.IsEmpty(this.ScreenObject.Preferences["batchpaymentreport"]) && this.ScreenObject.Preferences["batchpaymentreport"] != "0"
            && this.ScreenObject.DocumentType == 15 && parseInt(ds.Tables[0][0]["StatusID"].toString()) == 377) {
            this.ButtonSave.Enable = false;
            this.ButtonSaveandBarcode.Enable = false;
            this.ButtonSaveandPrint.Enable = false;
        }

        btn = this.GetButton("Bounce");

        if (this.ScreenObject.DocumentType == 15 || this.ScreenObject.DocumentType == 18)// && IsEdit)
            btn.Visible = true;

        if ((this.ScreenObject.DocumentType == 18 || this.ScreenObject.DocumentType == 15) && this.StatusID == 429) {
            btn.Visible = false;
            this.ButtonSave.Visible = false;
            this.ButtonRevise.Visible = false;
        }

        this.ScreenObject.SetDefaultValuesforCostCenters(2);
        this.SetSaveVisibility();

        this.CalculateTotals(null, false);
        this.RefreshGrid = true;
        this.RefreshGridFooter = true;
        this.DQuickInfoVisibility = false;
        this.QuickInfoVisibility = false;
        this.ApproveVisibility = false;
        this.VoucherDefVisibility = false;

        if (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 19) {
            this.DocStatus = "";
            for (let k = 0; k < ds.Tables[0].length; k++) {
                if (ds.Tables[0][k]["StatusID"].toString() != this.StatusID.toString() && this.DocStatus != "[Partial]") {
                    this.DocStatus = "[Partial]";
                    break;
                }
            }
            let statcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "StatusID");
            if (statcol) {
                if (this.DocStatus == "[Partial]")
                    statcol.IsVisible = true;
                else
                    statcol.IsVisible = false;
            }
        }

        if (((this.ScreenObject.Preferences.ContainsKey("UseAsLC") && this.ScreenObject.Preferences["UseAsLC"] != "" && parseBoolean(this.ScreenObject.Preferences["UseAsLC"]))
            || (this.ScreenObject.Preferences.ContainsKey("UseAsTR") && this.ScreenObject.Preferences["UseAsTR"] != "" && parseBoolean(this.ScreenObject.Preferences["UseAsTR"]))) && this.StatusID == 369)
            this.DocStatus = BaseService.GetResource("Status_Approved");
        else if (this.StatusID == 429 && this.IsReplaced > 0 && this.DocStatus != "[Partial]") {
            if (this.IsReplaced == 1)
                this.DocStatus = "[" + BaseService.GetResource("Replaced") + "]";
            else if (this.IsReplaced == 2)
                this.DocStatus = "[" + BaseService.GetResource("ReplacedPartial") + "]";
            else if (ds.Tables.length > 6 && ds.Columns[6].Contains("Status") && ds.Tables[6].length > 0) {
                if (Util.String(ds.Tables[6][0]["Status"]).Replace("-", "_").Replace(" ", "") == "Hold")
                    this.DocStatus = "[" + BaseService.GetResource("Status_Hold") + "]";
                else
                    this.DocStatus = "[" + BaseService.GetResource(ds.Tables[6][0]["Status"].toString().Replace("-", "_").Replace(" ", "")) + "]";
            }
            //this.DocStatus = "[" + ds.Tables[6][0]["Status"].toString() + "]";
        }
        else if (ds.Tables.length > 6 && ds.Columns[6].Contains("Status") && ds.Tables[6].length > 0) {
            if (this.ScreenObject.IsDocEdit && !(this.DocStatus == "[Partial]" && (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 19))) {
                if (Util.String(ds.Tables[6][0]["Status"]).Replace("-", "_").Replace(" ", "") == "Hold")
                    this.DocStatus = "[" + BaseService.GetResource("Status_Hold") + "]";
                else
                    this.DocStatus = "[" + BaseService.GetResource(ds.Tables[6][0]["Status"].toString().Replace("-", "_").Replace(" ", "")) + "]";
            }
            //this.DocStatus = "[" + ds.Tables[6][0]["Status"].toString() + "]";
            let LockOnPost = false;
            if (this.ScreenObject.Preferences.ContainsKey("PostAsset") && this.ScreenObject.Preferences["PostAsset"].toLowerCase() == "true")
                LockOnPost = true;
            if (this.ScreenObject.Preferences.ContainsKey("DimTransferSrc") && parseInt(this.ScreenObject.Preferences["DimTransferSrc"]) > 0)
                LockOnPost = true;
            if ((this.DocumentType == 5 || this.DocumentType == 8 || this.DocumentType == 13) && this.ScreenObject.Preferences.ContainsKey("IsBudgetDocument") && (this.ScreenObject.Preferences["IsBudgetDocument"].toLowerCase() == "true" || this.ScreenObject.Preferences["IsBudgetDocument"] == "1"))
                LockOnPost = true;

            if (this.LineWiseApproval) {
                let DiffWflw = false;
                for (let k = 0; k < ds.Tables[0].length; k++) {
                    if (k > 0 && !Util.IsEmpty(ds.Tables[0][k]["WorkFlowID"]) && !Util.IsEmpty(ds.Tables[0][k - 1]["WorkFlowID"]) && ds.Tables[0][k]["WorkFlowID"].toString() != ds.Tables[0][k - 1]["WorkFlowID"].toString())
                        DiffWflw = true;

                    if (k > 0 && Util.String(ds.Tables[0][k]["canapprove"]) != Util.String(ds.Tables[0][k - 1]["canapprove"]))
                        DiffWflw = true;

                    if (Util.String(ds.Tables[0][k]["StatusID"]) != this.StatusID.toString() && this.DocStatus != "[Partial]") {
                        this.DocStatus = "[Partial]";
                        break;
                    }
                }
                if (this.DocStatus != "[Partial]" && ((this.StatusID == 369 && LockOnPost)
                    || (this.ScreenObject.Preferences.ContainsKey("batchpaymentDoc") && !Util.IsEmpty(this.ScreenObject.Preferences["batchpaymentDoc"])
                        && parseInt(this.ScreenObject.Preferences["batchpaymentDoc"].toString()) > 40000 && this.StatusID == 377))) {
                    this.ButtonSave.Enable = false;
                    this.ButtonSaveandBarcode.Enable = false;
                    this.ButtonSaveandPrint.Enable = false;
                    this.ButtonRevise.Enable = false;
                    this.ButtonSuspend.Enable = false;
                }
                else if (this.DocStatus == "[Partial]" || DiffWflw) {
                    let Canedit = false, canapprove = false, isRejected = false;
                    for (let k = 0; k < ds.Tables[0].length; k++) {
                        if (this.IsInventoryVoucher && btnGen != null && !btnGen.Visible && ds.Tables[0][k]["StatusID"].toString() == "369")
                            btnGen.Visible = true;

                        if (ds.Tables[0][k]["StatusID"].toString() == "369" && LockOnPost)
                            ds.Tables[0][k]["CanEdit"] = "0";

                        if (ds.Columns[0].Contains("CanApprove") && ds.Tables[0][k]["CanApprove"].toString() == "1")
                            canapprove = true;
                        else if (ds.Columns[0].Contains("CanEdit") && ds.Tables[0][k]["CanEdit"].toString() == "1") {
                            if (ds.Tables[0][k]["StatusID"].toString() == "372" && !(BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Rejected Documents") || BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit")))
                                ds.Tables[0][k]["CanEdit"] = "0";
                            else if (ds.Tables[0][k]["StatusID"].toString() != "372" && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit"))
                                ds.Tables[0][k]["CanEdit"] = "0";
                            else
                                Canedit = true;
                        }
                        if (ds.Tables[0][k]["StatusID"].toString() == "372" && ds.Columns[0].Contains("CanEdit") && ds.Tables[0][k]["CanEdit"].toString() == "1")
                            isRejected = true;
                    }

                    if (canapprove && BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Approve")) {
                        if (ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("WType") && ds.Tables[6][0]["WType"].toString() != "2") {
                            if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit"))
                                btnsubmit.Visible = true;
                            else
                                btnsubmit.Visible = false;
                        }
                        this.ButtonApprove.Visible = true;
                        this.ButtonSave.Enable = false;
                    }
                    else if (isRejected && (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Rejected Documents") || BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit"))
                        && ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("userlevel") && !Util.IsEmpty(ds.Tables[6][0]["userlevel"])) {
                        btnsubmit.Visible = false;
                        this.ButtonApprove.Visible = false;
                        this.ButtonSave.Enable = true;
                        this.ButtonSave.Visible = true;
                    }
                    else if (Canedit && BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit")) {
                        if (ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("userlevel") && !Util.IsEmpty(ds.Tables[6][0]["userlevel"])
                            && ds.Tables[6][0]["Wlevel"].toString() == ds.Tables[6][0]["userlevel"].toString()) {
                            this.ButtonSave.Enable = false;
                            this.ButtonSaveandPrint.Enable = false;
                            this.ButtonSaveandBarcode.Enable = false;
                            btnsubmit.Visible = true;
                        }
                        else if ((ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("WType") && ds.Tables[6][0]["WType"].toString() == "2"
                            && !(ds.Columns[6].Contains("userlevel") && Util.IsEmpty(ds.Tables[6][0]["userlevel"])))
                            || BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Posted Docs") || BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit Approved Docs")) {
                            btnsubmit.Visible = false;
                            this.ButtonApprove.Visible = false;
                            this.ButtonSave.Enable = true;
                        }
                        else {
                            btnsubmit.Visible = true;
                            this.ButtonApprove.Visible = false;
                            this.ButtonSave.Enable = false;
                        }
                    }
                    else {
                        btnsubmit.Visible = false;
                        this.ButtonApprove.Visible = false;
                        this.ButtonSave.Enable = false;
                    }
                }

            }
            else if ((this.StatusID == 369 && LockOnPost)
                || (this.ScreenObject.Preferences.ContainsKey("batchpaymentDoc") && !Util.IsEmpty(this.ScreenObject.Preferences["batchpaymentDoc"])
                    && parseInt(this.ScreenObject.Preferences["batchpaymentDoc"].toString()) > 40000 && this.StatusID == 377)) {
                this.ButtonSave.Enable = false;
                this.ButtonSaveandBarcode.Enable = false;
                this.ButtonSaveandPrint.Enable = false;
                this.ButtonRevise.Enable = false;
                this.ButtonSuspend.Enable = false;
            }
        }

        if (this.IsInventoryVoucher && ds.Tables.length > 19 && ds.Tables[19].length > 0 && ds.Columns[19].Contains("ExecutedQty")
            && this.ScreenObject.Preferences.ContainsKey("ShowLinkStatus") && this.ScreenObject.Preferences["ShowLinkStatus"] != "" && parseBoolean(this.ScreenObject.Preferences["ShowLinkStatus"])) {
            let tempstr = "";
            if (ds.Columns[0].Contains("LinkStatusID") && ds.Tables[0].filter(x => x.LinkStatusID != 445).length == 0) {
                tempstr = "Close";
            }
            else {
                tempstr = "Open";

                let dblExQty = 0;
                let obj: any = null;
                if (this.DocumentType == 5 && ds.Columns[19].Contains("VoucherType"))
                    obj = ds.Tables[19].filter(x => x.VoucherType == -1).Compute("sum", "ExecutedQty");
                else
                    obj = ds.Tables[19].Compute("sum", "ExecutedQty");

                if (obj != null && obj.toString().length > 0) {
                    dblExQty = parseFloat(obj);
                }
                if (dblExQty == 0) {
                    tempstr = "Open";
                }
                else {
                    let arr;
                    if (this.DocumentType == 5 && ds.Columns[19].Contains("VoucherType"))
                        arr = ds.Tables[19].filter(x => x.VoucherType == -1 && x.Quantity > x.ExecutedQty);
                    else
                        arr = ds.Tables[19].filter(x => x.Quantity > x.ExecutedQty);
                    if (arr.length > 0)
                        tempstr = "Pending";
                    else
                        tempstr = "Executed";
                }
            }

            if (this.ScreenObject.Link != null)
                this.ScreenObject.Link.LinkStatus = "[" + tempstr + "]";
            else {
                this.ScreenObject.linkstat = tempstr;
                this.DocStatus += "(" + BaseService.GetResource(tempstr.Replace("-", "_").Replace(" ", "")) + ")";
            }
        }


        this.ScreenObject.CheckViewForUser(this.StatusID);

        if (this.ScreenObject.DocumentType == 5) //Stock Transfer
        {
            ;
            this.ScreenObject._CCFields.forEach(item => {
                if (item instanceof PactListBoxData && item.CCID > 50000 && item.DBColumnName.Contains("TO")) {
                    var TodependantFields = this.ScreenObject._CCFields.filter(a => a.DependantOn != null && a.DependantOn.toLowerCase() == item.DBColumnName.Replace("TO", "").toLowerCase());
                    TodependantFields.forEach(Titem => {
                        if (Titem instanceof PactListBoxData && Titem.CCID > 50000 && Titem.DBColumnName.Contains("TO"))
                            this.ScreenObject.FilterToListView(item);
                    });
                }
            });
        }

        this.UpdateFooter = true;
        if (!this.ButtonSuspendDoc.Visible || !this.ButtonSuspendDoc.Enable) {
            if (BaseService.SessionManager.HideUnathorizedAccess)
                this.ButtonSuspendDoc.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");
            else
                this.ButtonSuspendDoc.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");
        }

        if (ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("IsLock") && !Util.IsEmpty(ds.Tables[6][0]["IsLock"])
            && parseBoolean(ds.Tables[6][0]["IsLock"]) && !BaseService.SessionManager.IsActionAssigned(43, "Override Lock")) {
            this.ButtonSave.Enable = false;
            this.ButtonSaveandBarcode.Enable = false;
            this.ButtonSaveandPrint.Enable = false;
            this.ButtonRevise.Enable = false;
            this.ButtonSuspend.Enable = false;
            this.ButtonDelete.Visible = false;
            this.ButtonSuspend.Visible = false;
            this.ButtonSuspendDoc.Visible = false;
            btnsubmit.Visible = false;
            this.IsLocked = true;
            if (!(this.ButtonApprove.Visible &&
                (BaseService.SessionManager.IsActionAssigned(43, "Approve Locked Documents") || (BaseService.SessionManager.Preferences.ContainsKey("PostLockedDocs") && parseBoolean(BaseService.SessionManager.Preferences["PostLockedDocs"]))
                    || (BaseService.SessionManager.Preferences.ContainsKey("DocDateasPostedDate") && parseBoolean(BaseService.SessionManager.Preferences["DocDateasPostedDate"])))))
                this.ButtonApprove.Enable = false;
        }
        else if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0 && ds.Columns[0].Contains("StatusID") && !Util.IsEmpty(ds.Tables[0][0]["StatusID"])
            && parseInt(ds.Tables[0][0]["StatusID"]) == 376) {
            this.ButtonSaveandPrint.Enable = false;
            this.ButtonSaveandBarcode.Enable = false;
            this.ButtonApprove.Visible = false;
            this.ButtonDelete.Visible = false;
            this.ButtonSuspendDoc.Visible = false;

            if (BaseService.SessionManager.HideUnathorizedAccess) {
                this.ButtonSave.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Post Cancelled Documents");
                this.ButtonSave.Enable = true;
            }
            else
                this.ButtonSave.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Post Cancelled Documents");
        }
        else if (btnHistory.Visible && BaseService.SessionManager.Preferences["Override Workflow"].toLowerCase() == "true" && BaseService.SessionManager.UserID == "1") {
            this.ButtonDelete.Visible = true;
            this.ButtonSuspendDoc.Visible = true;
            this.ButtonRevise.Visible = true;
            this.ButtonSave.Visible = true;
            this.ButtonDelete.Enable = true;
            this.ButtonSuspendDoc.Enable = true;
            this.ButtonRevise.Enable = true;
            this.ButtonSave.Enable = true;
        }
        else if (btnHistory.Visible &&
            !((this.ButtonApprove.Enable && this.ButtonApprove.Visible) || (this.ButtonSave.Enable && this.ButtonSave.Visible))) {
            if (ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("userlevel") && !Util.IsEmpty(ds.Tables[6][0]["userlevel"])
                && ds.Columns[6].Contains("Wlevel") && Util.String(ds.Tables[6][0]["Wlevel"]) == Util.String(ds.Tables[6][0]["userlevel"]) && btnsubmit.Visible) {
                if (!this.ButtonDelete.Visible || !this.ButtonDelete.Enable) {
                    this.ButtonDelete.Visible = true;
                    this.ButtonDelete.Enable = true;
                    this.ButtonSuspendDoc.Visible = true;
                    this.ButtonSuspendDoc.Enable = true;
                    if (BaseService.SessionManager.HideUnathorizedAccess)
                        this.ButtonDelete.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");
                    else
                        this.ButtonDelete.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");
                    if (BaseService.SessionManager.HideUnathorizedAccess)
                        this.ButtonSuspendDoc.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");
                    else
                        this.ButtonSuspendDoc.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");
                }
            }
            else {
                this.ButtonDelete.Enable = false;
                this.ButtonSuspendDoc.Enable = false;
                if (!(this.ButtonRevise.Visible && (this.StatusID == 372 || this.StatusID == 369)))
                    this.ButtonRevise.Visible = false;
            }
        }
        else if (!this.ButtonDelete.Visible || !this.ButtonDelete.Enable) {
            this.ButtonDelete.Visible = true;
            this.ButtonDelete.Enable = true;
            this.ButtonSuspendDoc.Visible = true;
            this.ButtonSuspendDoc.Enable = true;
            if (BaseService.SessionManager.HideUnathorizedAccess)
                this.ButtonDelete.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");
            else
                this.ButtonDelete.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");
            if (BaseService.SessionManager.HideUnathorizedAccess)
                this.ButtonSuspendDoc.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");
            else
                this.ButtonSuspendDoc.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");
        }

        if (btnHistory.Visible && BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend") && BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Withdraw") &&
            (!this.ButtonSuspendDoc.Visible || !this.ButtonSuspendDoc.Enable) && this.StatusID != 376)
            this.ButtonSuspendDoc.Visible = this.ButtonSuspendDoc.Enable = true;

        if (BaseService.SessionManager.HideUnathorizedAccess)
            btnHistory.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "History");
        else
            btnHistory.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "History");

        if (BaseService.SessionManager.Preferences.ContainsKey("LockEditMode") && parseBoolean(BaseService.SessionManager.Preferences["LockEditMode"])) {
            let btnLock = this.GetButton("Lock");
            if (this.ButtonSave.Visible && this.ButtonSave.Enable && ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Tables[6][0]["LockedBY"] == null) {
                btnLock.Visible = true;
                btnLock.Label = "Lock";
                btnLock.Mandatory = true;
            }
            else if (ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Tables[6][0]["LockedBY"] != null) {
                if (ds.Tables[6][0]["LockedBY"].toString() == BaseService.SessionManager.UserName) {
                    btnLock.Visible = true;
                    btnLock.Mandatory = false;
                    btnLock.Label = "Unlock";
                }
                else {
                    this.IsUserLock = true;
                    this.DocStatus += "(LockedBy " + ds.Tables[6][0]["LockedBY"].toString() + ")";
                }
            }
        }

        if (ds.Tables.length > 6 && ds.Tables[6].length > 0 && !Util.IsEmpty(ds.Tables[6][0]["DisableReject"]) && ds.Tables[6][0]["DisableReject"] == true)
            this.BtnRejVisible = false;


        if (BaseService.SessionManager.IsOffline && this.ScreenObject.DocID < 0) {
            if (ds.Tables.length > 6 && ds.Tables[6].length > 0 && ds.Columns[6].Contains("OffLineStatus") && ds.Tables[6][0]["OffLineStatus"].toString() == "1") {
                btn = this.GetButton("Pay");
                if (btn != null)
                    btn.Visible = false;
                this.ButtonSave.Visible = this.ButtonDelete.Visible = btnsubmit.Visible = this.ButtonRevise.Visible = this.ButtonSaveandPrint.Visible = false;
            }
            else {
                if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Edit") && !this.ButtonSave.Visible) {
                    this.ButtonSave.Visible = true;
                    btn = this.GetButton("Pay");
                    if (btn != null)
                        btn.Visible = true;
                    this.ButtonSuspendDoc.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Suspend");
                    this.ButtonDelete.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");
                    if (this.ScreenObject.Preferences.ContainsKey("EnableRevision") && this.ScreenObject.Preferences["EnableRevision"] != "" && parseBoolean(this.ScreenObject.Preferences["EnableRevision"]))
                        this.ButtonRevise.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Revise");
                }
            }
        }
        if (this.ScreenObject.Preferences.ContainsKey("ShowPackStat") && parseBoolean(this.ScreenObject.Preferences["ShowPackStat"])) {
            if (ds.Tables[26].filter(x => x.Type == 2).length > 0) {
                let IsPartial = false;
                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["DocDetailsID"])) {
                        let PackVal = ds.Tables[26].filter(x => x.Type == 2 && x.InvDocDetailsID == this.ScreenObject.GridData[i]["DocDetailsID"]).Compute("sum", "Quantity");

                        if (!(PackVal != null && PackVal.toString() == this.ScreenObject.GridData[i]["Quantity"].toString())) {
                            IsPartial = true;
                            break;
                        }
                    }
                }
                if (IsPartial)
                    this.DocStatus += "(Partially packed)";
                else
                    this.DocStatus += "(Packed)";
            }
            else
                this.DocStatus += "(To be packed)";
        }
        this.WFDocLevelList.Clear();
        let dtWFDef = null, dtWFHist = null;
        if (this.IsInventoryVoucher && ds.Tables.length > 25) {
            dtWFDef = ds.Tables[25];
            dtWFHist = ds.Tables[24];
        }
        else if (!this.IsInventoryVoucher && ds.Tables.length > 15) {
            dtWFDef = ds.Tables[15];
            dtWFHist = ds.Tables[14];
        }
        if (dtWFDef != null && dtWFDef.length > 0 && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "HideWorkflowLevels")) {
            let iwfLevel = 0;
            if (!Util.IsEmpty(ds.Tables[0][0]["WorkFlowLevel"]))
                iwfLevel = parseInt(ds.Tables[0][0]["WorkFlowLevel"]);
            let iwfLastStatus;
            if (dtWFHist.length > 0) {
                iwfLastStatus = parseInt(dtWFHist[dtWFHist.length - 1]["StatusID"]);
            }
            console.log('WF');
            console.log((dtWFDef));

            let iStartLevel = dtWFHist.length > 0 ? parseInt(dtWFHist[0]["WorkFlowLevel"]) - 1 : 0;
            for (let i = 0; i < dtWFDef.length; i++) {
                let lvl = new WFLevelDoc(parseInt(dtWFDef[0]["WID"]), parseInt(dtWFDef[i]["levelID"]), dtWFDef[i]["LevelName"].toString(), this.CostCenterID, this.ScreenObject.DocID, this.ScreenObject.DocDate.Date);
                if (i == iStartLevel) {
                    lvl.IsPending = true;
                    lvl.Label = "C";
                }
                if (i == 0)
                    lvl.LeftLineBrush = "";
                if (i == dtWFDef.length - 1)
                    lvl.RightLineBrush = "";
                this.WFDocLevelList.push(lvl);
            }

            for (let i = dtWFHist.length - 1; i >= 0; i--) {
                let icurr = parseInt(dtWFHist[i]["WorkFlowLevel"]);
                if (icurr <= iwfLevel && icurr <= this.WFDocLevelList.length && !this.WFDocLevelList[icurr - 1].IsSet) {
                    this.WFDocLevelList[icurr - 1].IsSet = true;
                    this.WFDocLevelList[icurr - 1].ModifiedBy = dtWFHist[i]["Status"].toString() + " By " + dtWFHist[i]["CreatedBy"].toString();
                    if (dtWFHist[i]["FirstName"].toString().length > 0)
                        this.WFDocLevelList[icurr - 1].ModifiedBy += "(" + dtWFHist[i]["FirstName"].toString() + ")";
                    let dt = Util.ParseDate(dtWFHist[i]["Date"]);
                    this.WFDocLevelList[icurr - 1].ModifiedBy += " On " + dt.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                    let istatus = parseInt(dtWFHist[i]["StatusID"]);
                    if (istatus == 372) {
                        this.WFDocLevelList[icurr - 1].IsRejected = true;
                    }
                    else if (istatus == 441) {
                        this.WFDocLevelList[icurr - 1].IsApproved = true;
                    }
                    else if (istatus == 369 || istatus == 370) {
                        this.WFDocLevelList[icurr - 1].IsPending = true;
                        this.WFDocLevelList[icurr - 1].Label = " P";
                    }
                    this.WFDocLevelList[icurr - 1].BgColor = AddEditDocumentViewModel.getStatusColor(istatus);
                }
            }
        }
        this.CheckViewOnLoad();
        this.ReadonlyfldsbasedonExpression();
        if (this.ScreenObject.DocumentType == 69 || this.ScreenObject.DocumentType == 86 || this.ScreenObject.DocumentType == 91 || this.ScreenObject.DocumentType == 98) {
            this.BodyVisible = false;
        }
        if (this.ScreenObject.DocumentType == 71) {
            let Dimfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (Dimfld) {
                let SelectedEmpID = 0;
                if (Dimfld instanceof PactListBoxData)
                    SelectedEmpID = Dimfld.SelectedValue;
                else if (Dimfld instanceof PactCodeNameListBoxData)
                    SelectedEmpID = Dimfld.SelectedValue;

                if (SelectedEmpID > 0) {
                    this.dsData = this.ScreenObject.GetEmployeePayrollInfo(SelectedEmpID, 1, this.ScreenObject.DocDate.Date, 0);
                    if (this.dsData.Tables.length > 0) {
                        if (this.dsData.Tables[0].length > 0) {
                            this.SetNoofMonths(this.dsData);
                        }
                    }
                }
            }
        }

        //Start : For checking the payroll processed
        if (this.StatusID == 369 && (this.ScreenObject.DocumentType == 62 || this.ScreenObject.CostCenterID == 40063 || this.ScreenObject.CostCenterID == 40059 || this.ScreenObject.DocumentType == 58 || this.ScreenObject.DocumentType == 67 || this.ScreenObject.DocumentType == 72 || this.ScreenObject.DocumentType == 97)) {

            let dsPostedDoc = this.ScreenObject.GetPayrollProcessed(0, this.DocID);
            if (dsPostedDoc.Tables.length > 0) {
                if (dsPostedDoc.Tables[0].length > 0) {
                    this.ButtonSave.Visible = false;
                    this.ButtonDelete.Visible = false;
                    this.ButtonSuspendDoc.Visible = false;
                    if (this.ScreenObject.DocumentType == 62 || this.ScreenObject.CostCenterID == 40063) {
                        if (BaseService.SessionManager.Preferences.ContainsKey("AllowLeavesifPayrollProcessedorLocked") && parseBoolean(BaseService.SessionManager.Preferences["AllowLeavesifPayrollProcessedorLocked"] == "False"))
                            this.DocStatus += " (Payroll Processed)";
                        else {
                            this.ButtonSave.Visible = true;
                            this.ButtonDelete.Visible = true;
                            this.ButtonSuspendDoc.Visible = true;
                        }
                    }
                    else if (this.ScreenObject.DocumentType == 67) {
                        if (BaseService.SessionManager.Preferences.ContainsKey("AllowDailyPayrollEntryforPostedMonths") && parseBoolean(BaseService.SessionManager.Preferences["AllowDailyPayrollEntryforPostedMonths"] == "False")) {
                            this.DocStatus += " (Payroll Processed)";
                        }
                        else {
                            this.ButtonSave.Visible = true;
                            this.ButtonDelete.Visible = true;
                            this.ButtonSuspendDoc.Visible = true;
                        }
                    }
                    else if (this.ScreenObject.DocumentType == 72) {
                        if (BaseService.SessionManager.Preferences.ContainsKey("AllowVacationifPayrollProcessedorLocked") && parseBoolean(BaseService.SessionManager.Preferences["AllowVacationifPayrollProcessedorLocked"] == "False")) {
                            this.DocStatus += " (Payroll Processed)";
                        }
                        else {
                            this.ButtonSave.Visible = true;
                            this.ButtonDelete.Visible = true;
                        }
                    }
                    else
                        this.DocStatus += " (Payroll Processed)";
                }

            }
        }
        //End : For checking the payroll processed

        if (this.ScreenObject.DocumentType == 68) {
            let dtFromDate = new Date().OnlyDate(), dtToDate = new Date().OnlyDate();// DateTime.Now;
            let sEmpID = "0";
            let drw: any = null;
            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {

                    drw = this.ScreenObject.GridData[i];

                    let vFld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                    if (vFld != null && vFld != undefined)
                        dtFromDate = new Date(vFld.Date.getFullYear(), vFld.Date.iMonth(), 1);
                    else {
                        let vFld2: any = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                        if (vFld2 != undefined && drw[vFld2.DisplayMember + "_Key"] != null && drw[vFld2.DisplayMember + "_Key"] != null && drw[vFld2.DisplayMember + "_Key"].toString() != "")
                            dtFromDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]);
                    }

                    vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                    if (vFld != undefined)
                        dtToDate = new Date(vFld.Date.getFullYear(), vFld.Date.iMonth(), 1);
                    else {
                        let vFld2: any = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha4");
                        if (vFld2 != undefined && drw[vFld2.DisplayMember + "_Key"] != null && drw[vFld2.DisplayMember + "_Key"] != null && drw[vFld2.DisplayMember + "_Key"].toString() != "")
                            dtToDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]);
                    }

                    vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if (vFld != undefined) {
                        if (vFld instanceof PactListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                        else if (vFld instanceof PactCodeNameListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                    }
                    else {
                        let vFld2: any = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                        if (vFld2 != undefined && drw[vFld2.ValueMember] != null && drw[vFld2.ValueMember] != null && drw[vFld2.ValueMember].toString() != "")
                            sEmpID = drw[vFld2.ValueMember].toString();
                    }

                    let dtp: any = BaseService.common.GetDataTable("PAY090", sEmpID.toString() + "~" + dtFromDate + "~" + dtToDate);

                    let fldAPV2: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                    if (fldAPV2 != undefined)
                        fldAPV2.IsReadOnly = false;
                    if (dtp != null && dtp.length > 0) {
                        if (fldAPV2 != undefined)
                            fldAPV2.IsReadOnly = true;

                        this.ReadOnlyBody = true;
                    }
                }
            }
        }

        if (this.ScreenObject.DocumentType == 72) //Apply Vacation
        {
            let vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (vFld) {
                let sEmpID = "0";
                if (vFld instanceof PactListBoxData)
                    sEmpID = vFld.SelectedValue.toString();
                else if (vFld instanceof PactCodeNameListBoxData)
                    sEmpID = vFld.SelectedValue.toString();

                if (parseInt(sEmpID) > 0)
                    this.ShowVacationCreditDaysDetail(parseInt(sEmpID));
            }

            let fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha6");
            if (fldAPV instanceof PactTextBoxData && fldAPV.Text != "") {
                this.GridNetTotal = parseFloat(fldAPV.Text);
                this.RefreshNetAmount();
            }
        }

        if (this.ScreenObject.DocumentType == 77) //Payroll Lock/Unlock
            this.FillPayrollLockUnlockDetails(true);

        if (this.ScreenObject.DocumentType == 56) //Apply Loan
        {
            this.dsData = this.ScreenObject.CheckLoanRepayAmountDetails(this.DocID);
            if (this.dsData.Tables.length > 0) {
                if (this.dsData.Tables[0].length > 0) {
                    let btndist = this.GetButton("Distribute");
                    if (btndist != null) {
                        if (parseFloat(this.dsData.Tables[0][0][ds.Columns[0][0]]) > 0)
                            btndist.Visible = false;
                        else
                            btndist.Visible = true;
                    }
                }
            }
            this.EmployeewiseDocumentView(40056, this.strEmpIsMgr, "True");
        }

        if (this.ScreenObject.DocumentType == 81 || this.IsNewAssignLeave) {
            this.dtData = null;
            let ALfld1 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
            if (ALfld1 && ALfld1 instanceof PactComboBoxData && !Util.IsEmpty(ALfld1.SelectedValue)) {
                if (this.IsNewAssignLeave)
                    this.LoadGradeDataNew(1, new Date(), ALfld1.SelectedValue.toString(), ds);
                else
                    this.LoadGradeData(1, new Date(), ALfld1.SelectedValue.toString());
            }
        }

        if (this.ScreenObject.DocumentType == 67) //Daily Attendance
        {
            if (this.ScreenObject.IsDocEdit) {
                if (!this.ScreenObject.GridDataColumns.Contains("Row_Background"))
                    this.ScreenObject.GridDataColumns.push("Row_Background");

                let sDailyAttDate = Date.Today().ToString("dd/MMM/yyyy"), sEmpID = "1";
                let isDADateLineWise = false;
                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (this.ScreenObject.GridData[i]["ProductID_Key"] != null && this.ScreenObject.GridData[i]["ProductID_Key"] != null && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                        let drw = this.ScreenObject.GridData[i];

                        let vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                        if (vFld instanceof PactExtraFieldDateData)
                            sDailyAttDate = vFld.Date.ToString("dd/MMM/yyyy");
                        else {
                            let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                            if (vFld2 && drw[vFld2.DisplayMember + "_Key"] != null && drw[vFld2.DisplayMember + "_Key"] != null && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"])) {
                                sDailyAttDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");
                                isDADateLineWise = true;
                            }
                        }

                        vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (vFld) {
                            if (vFld instanceof PactListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                        }
                        else {
                            let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                            if (vFld2 && drw[vFld2.ValueMember] != null && drw[vFld2.ValueMember] != null && !Util.IsEmpty(drw[vFld2.ValueMember]))
                                sEmpID = drw[vFld2.ValueMember].toString();
                        }

                        if (isDADateLineWise) {
                            if (this.ScreenObject.GridDataColumns.Contains("dcAlpha15") && !Util.IsEmpty(drw["dcAlpha15"])) {
                                if (!this.ScreenObject.GridDataColumns.Contains("Row_Background"))
                                    this.ScreenObject.GridDataColumns.push("Row_Background");

                                if (drw["dcAlpha15"].toString() == "WeeklyOff")
                                    drw["Row_Background"] = "#F77B7E";//new System.Windows.Media.SolidColorBrush((System.Windows.Media.Color)System.Windows.Media.ColorConverter.ConvertFromString("#9FE296"));
                                else if (drw["dcAlpha15"].toString() == "Holiday")
                                    drw["Row_Background"] = "#40C8B7";//new System.Windows.Media.SolidColorBrush((System.Windows.Media.Color)System.Windows.Media.ColorConverter.ConvertFromString("#40C8B7"));
                                else
                                    drw["Row_Background"] = "#FFFFFF";//new System.Windows.Media.SolidColorBrush((System.Windows.Media.Color)System.Windows.Media.ColorConverter.ConvertFromString("#FFFFFF"));

                                drw["PayrollType"] = drw["dcAlpha15"];
                            }
                            else
                                drw["Row_Background"] = "#FFFFFF";
                            //if (this.objPayDayCheck == null)
                            //    this.objPayDayCheck = new PayDayCheck(this.ScreenObject);
                            //this.objPayDayCheck.CheckIsHolidayDate(sEmpID, sDailyAttDate, drw);
                        }
                    }
                }
            }
        }

        if (this.ScreenObject.DocumentType == 89 || this.ScreenObject.DocumentType == 90) //For Attendance and Time Sheet Documents
        {
            //DateTime?
            let dtCheckInDate = null, dtCheckInTime = null, dtCheckOutDate = null, dtCheckOutTime = null;
            let dtmp: Date = new Date();
            this.ScreenObject.GridData.forEach(datarow => {
                let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"]))
                    dtCheckInDate = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);

                vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"])) {
                    dtmp = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);
                    dtCheckInTime = new Date(dtCheckInDate.getFullYear(), dtCheckInDate.getMonth(), dtCheckInDate.getDate(), dtmp.getHours(), dtmp.getMinutes(), dtmp.getSeconds());
                    datarow[vFld2.DisplayMember + "_Key"] = dtCheckInTime;
                }

                vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"]))
                    dtCheckOutDate = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);

                vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha4");
                if (vFld2 && !Util.IsEmpty(datarow[vFld2.DisplayMember + "_Key"])) {
                    dtmp = Util.ParseDate(datarow[vFld2.DisplayMember + "_Key"]);
                    dtCheckOutTime = new Date(dtCheckOutDate.getFullYear(), dtCheckOutDate.getMonth(), dtCheckOutDate.getDate(), dtmp.getHours(), dtmp.getMinutes(), dtmp.getSeconds());
                    datarow[vFld2.DisplayMember + "_Key"] = dtCheckOutTime;
                }
                this.ScreenObject.GridDataObj.updateRow(datarow);
            });

            let vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha26");
            if (vFld)
                (vFld as PactExtraFieldDateData).Date = null;

            vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha27");
            if (vFld)
                (vFld as PactDateTimeData).Date = null;
        }

        if (this.ScreenObject.DocumentType == 92) //Payroll - Shift Assign
        {
            this.LoadEditShiftAssign(ds);
        }

        if (this.DocHistoryVisibility) { // commented wajid, when clicking next and previous button in document, DocHistory popup is getting populate.
            //if (this.HistCols != null && this.HistCols.length > 0 && this.HistCols[0].IsVisible)
            //    this.onButtonClick("ReviseHistory");
            // else 
            //     this.onButtonClick("DocumentHistory");
        }

        if (this.ScreenObject.DocumentType == 73) // Leave Adjustment as Vacation 
        {
            // ReadOnlyBody = true;
            btn = this.GetButton("Post");
            if (btn != null) {
                btn.Visible = false;
            }

            btn = this.GetButton("SaveAndPrint");
            if (btn != null) {
                btn.Visible = false;
            }
        }
        else if (this.ScreenObject.DocumentType == 89 || this.ScreenObject.DocumentType == 90) //Attendacne & Time Sheet
        {
            let vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha32");
            if (vFld instanceof PactComboBoxData) {
                if (vFld.SelectedValue != null && vFld.SelectedValue == "Manual") {
                    this.ScreenObject._TextFields.forEach(item => {
                        if (item.DBColumnName.toLowerCase() == "dcalpha26")
                            item.IsReadOnly = true;
                        else if (item.DBColumnName.toLowerCase() == "dcalpha27")
                            item.Enable = false;
                    });
                    this.SetButtonVisibility("Save", true);
                    this.SetButtonVisibility("SaveAndPrint", true);
                    this.SetButtonVisibility("Check-in", false);
                    this.SetButtonVisibility("Check-out", false);
                }
                else {
                    this.ScreenObject._TextFields.forEach(item => {
                        if (item.DBColumnName.toLowerCase() == "dcalpha26")
                            item.IsReadOnly = false;
                        else if (item.DBColumnName.toLowerCase() == "dcalpha27")
                            item.Enable = true;
                    });
                    this.SetButtonVisibility("Save", false);
                    this.SetButtonVisibility("SaveAndPrint", false);
                    this.SetButtonVisibility("Check-in", true);
                    this.SetButtonVisibility("Check-out", true);
                }

            }
        }
        else if (this.ScreenObject.DocumentType == 97) //Payroll - Lates Processing
        {
            let fldROD = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha16");
            if (fldROD instanceof PactExtraFieldDateData) {
                this.dtPayMon = (fldROD).Date.Date();
            }
        }
        else if (this.ScreenObject.DocumentType == 62) //Apply Leaves
        {
            this.ReadOnlyBody = false;
            let fldAR = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha16");
            if (fldAR && fldAR instanceof PactTextBoxData && fldAR.Text != null && fldAR.Text == "LatesProcessing") {
                this.ReadOnlyBody = true;
            }
        }
        else if (this.ScreenObject.DocumentType == 100) //Travel Request
        {
            let PrevSchemeID;
            let MCColors = ["#017EFA", "#21bf74", "#FFAA2E", "#293978", "#33a9b6", "#ff3333"]
            this.ScreenObject.GridData.forEach(dr => {
                if (dr["SchemeID"]) {
                    dr["ParentSchemeID"] = dr["SchemeID"]
                    dr["MaxSchemeID"] = dr["SchemeID"]
                    if (PrevSchemeID == Util.Int(dr["SchemeID"])) {
                        dr["drEdit"] = "N"
                        dr["drDelete"] = "N"
                        dr["IsScheme"] = "Y"
                    }
                    else {
                        dr["IsScheme"] = "N"
                    }
                    PrevSchemeID = Util.Int(dr["SchemeID"])
                    dr["MCColorID"] = MCColors[PrevSchemeID % MCColors.length];
                }
            });
            if (this.ScreenObject.GridDataObj.MobileAddLine)
                this.ScreenObject.GridDataObj.MobileAddLine.RefreshWidgetData()
        }

        if (btnsubmit != null) {
            btn = this.GetButton("Submitprint");
            if (btnsubmit.Visible && BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Print") && btn != null)
                btn.Visible = true;
            else if (btn != null)
                btn.Visible = false;
        }

        for (let h = 0; h < this.Shortcuts.length; h++) {
            if (this.Shortcuts[h] instanceof DgColumn && this.Shortcuts[h].Mode == 15 && this.ScreenObject.GridData.length > 0 && this.ValidateData_Column(this.Shortcuts[h] as DgColumn, this.ScreenObject.GridData[0], true))
                this.ScreenObject.GetExternalFuncData(this.Shortcuts[h].Mode, this.Shortcuts[h].SPName, this.Shortcuts[h].IPParams, this.Shortcuts[h].OPParams, this.ScreenObject.GridData[0], true);
            else if (this.Shortcuts[h] instanceof PactControlData && this.Shortcuts[h].Mode == 15)
                this.ScreenObject.GetExternalFuncData(this.Shortcuts[h].Mode, this.Shortcuts[h].ToolTipFooterTitle, this.Shortcuts[h].ToolTipFooterDescription, this.Shortcuts[h].ToolTipDescription, null, true);
        }

        if (this.ScreenObject.Preferences.ContainsKey("HideBody") && !Util.IsEmpty(this.ScreenObject.Preferences["HideBody"]) && parseBoolean(this.ScreenObject.Preferences["HideBody"].toString()))
            this.BodyVisible = false;

        if (this.CostCenterID == 40045) {
            if (this.ScreenObject.GridDataColumns.Contains("dcAlpha15_Key")) {
                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha15_Key"])) {
                        this.Celleditend(this.ScreenObject.GridData[i], "dcAlpha15", 40045);
                    }
                }
            }
        }
        if (!this.IsPOs)
            this.SetDefaultRightPanel();

        if (BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "GST")) {
            if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0 && !ds.Columns[0].Contains("ErrorMessage")) {
                if (ds.Tables[29].length > 0 && ds.Tables[29].Columns.Contains("IRN") && ds.Tables[29][0]["IRN"].toString() != "") {
                    this.ButtonDelete.Enable = false;
                }
            }
        }



        Logger.InfoLog("AddEditDocumentViewModel::Exiting LoadEditCallBack");
    }

    ClearCallBack(Sender: string) {
        if (Sender == "Clear") {
        }
        else {
            alert(Sender);
        }
    }

    public OnMessageCallBack() {
        this.res = "Yes";
    }
    OnDeleteCallBack() {
        let RetVal = 0;
        let Message = "";
        if (this.IsSuspend) {
            let suspendall = false;
            if (this.ScreenObject.Preferences.ContainsKey("SuspendAllDocs") && this.ScreenObject.Preferences["SuspendAllDocs"] == "True") {
                if (confirm("Do you want to suspend linked documents?"))
                    suspendall = true;
            }
            let retobj = this.ScreenObject.SuspentDocument(suspendall, "");
            Message = retobj.Message;
            RetVal = retobj.RetValue;
        }
        else {/**
            const { SendEmailSMSViewModel } = await import('../../reports/send-email-sms/SendEmailSMSViewModel');
            SendEmailSMSViewModel.PushDeleteEvents(this.CostCenterID, this.DocID);***/
            let retobj = this.ScreenObject.DeleteDocument();
            Message = retobj.Message;
            RetVal = retobj.RetValue;
        }
        if (this.ScreenObject.DocumentType == 72 && !this.ReevaluateFutureVac && RetVal == 1) {
            this.ReevaluateFutureVacation();
        }
        this.ScreenObject.CheckViewForUser(0);

        this.clear(RetVal);
        this.DisplayMessage = Message;

    }

    setDefaultCurrency() {
        if (this.Currency != null) {
            if (!Util.IsEmpty(this.Currency.DefaultValue) && parseInt(this.Currency.DefaultValue) > 0) {
                if (this.Currency.Currency.SelectedValue != this.Currency.DefaultValue) {
                    this.Currency.Currency.SelectedValue = this.Currency.DefaultValue;
                    this.Currency.ExchangeRate.Text = this.ScreenObject.GetExchangeRate(parseInt(this.Currency.Currency.SelectedValue), this.DocumentDate).toString();
                }
            }
            else {
                this.Currency.Currency.SelectedValue = "1";
                this.Currency.ExchangeRate.Text = "1";
            }
        }
    }

    ClearLeaveData() {
        this.ScreenObject.GridDataObj.Clear();

        let drr = this.ScreenObject.GridDataObj.NewRow();
        drr["DocSeqNo"] = 1;
        drr["DocDetailsID"] = 0;
        this.ScreenObject.GridDataObj.Table.push(drr)

        this.ScreenObject.GridDataObj.refreshDataView();

        this.leaveTab.Fields.forEach(element => {
            if (element instanceof PactListBoxData) {

                element.OnPactListBoxValueChanged = new Delegate();

            } else if (element instanceof PactDatePickerData || element instanceof PactDateTimeData || element instanceof PactExtraFieldDateData) {

                element.SelectedDateChanged = new Delegate();

            } else if (element instanceof PactComboBoxData) {

                element.SelectionChangedCommand = new Delegate();

            } else if (element instanceof PactTextBoxData) {

                element.TextChangedCommand = new Delegate();

            }
        });


        this.leaveTab.Fields.forEach(element => {
            if (element instanceof PactListBoxData) {

                element.SelectedValue = 0
                element.SelectedValueText = ''

            } else if (element instanceof PactDatePickerData || element instanceof PactDateTimeData || element instanceof PactExtraFieldDateData) {

                element.Date = null
                element.Text = ''

            } else if (element instanceof PactComboBoxData) {

                element.Text = ''
                element.SelectedValue = ''

            } else if (element instanceof PactTextBoxData) {

                element.Text = ''

            }
        });

        this.prepareLineItemsToForm();

    }

    clear(RetVal: number) {
        /** if (RightTabSelectedIndex > 1)
              RightTabSelectedIndex = 0; **/

        if (RetVal == 1 || RetVal == 2 || RetVal == 3 || RetVal == 4 || RetVal == 5) {
            if (RetVal != 4) {
                let tempdt: Date = this.DocumentDate;
                let ref_date: any = { value: this._Ddate };
                this.ScreenObject.Clear(ref_date, RetVal);
                this._Ddate = ref_date.value;
                if (tempdt != this.DocumentDate) {
                    if (RetVal == 2)
                        this.CheckDateInDocNumber(false, false);
                    else if (RetVal == 1)
                        this.CheckDateInDocNumber(false);
                }
                if (RetVal == 3)
                    this.ChangeDateIfDateExists(this.ScreenObject.DocPrefix.ComboBox.SelectedValue);
            }
            this.setDefaultCurrency();

            if (!this.IsPOs)
                this.SetDefaultRightPanel();

            if (this.pdcGCVM != null)
                this.pdcGCVM = new pdcGenerateChequeViewModel(this);

            if (this.ScreenObject.DocumentType == 14 || this.ScreenObject.DocumentType == 19) {
                let statcol = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "StatusID");
                if (statcol) {
                    if (this.DocStatus == "[Partial]")
                        statcol.IsVisible = true;
                    else
                        statcol.IsVisible = false;
                }
            }
            let dvrws = this.ScreenObject.Data.Tables[10].length > 0 ? this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -2 && (x.Mode == 1 || x.Mode == 3)) : [];
            if (dvrws.length > 0) {
                this.BodyVisible = parseBoolean(dvrws[0]["IsVisible"]);
                this.ReadOnlyBody = !parseBoolean(dvrws[0]["IsEditable"]);
            }
            else {
                this.BodyVisible = true;
                this.ReadOnlyBody = false;
                if (this.ScreenObject.Preferences.ContainsKey("Lock Body") && this.ScreenObject.Preferences["Lock Body"] != "" && parseBoolean(this.ScreenObject.Preferences["Lock Body"]))
                    this.ReadOnlyBody = true;
                else
                    this.ReadOnlyBody = false;
            }
            if (this.IsInventoryVoucher && this.AssignAddress != null) {
                if (this.ScreenObject.Preferences.ContainsKey("BillingAddress"))
                    this.AssignAddress.BillsVisibe = parseBoolean(this.ScreenObject.Preferences["BillingAddress"]);
                else
                    this.AssignAddress.BillsVisibe = false;

                if (this.ScreenObject.Preferences.ContainsKey("ShippingAddress"))
                    this.AssignAddress.ShipVisibe = parseBoolean(this.ScreenObject.Preferences["ShippingAddress"]);
                else
                    this.AssignAddress.ShipVisibe = false;

                if (this.ScreenObject.Preferences.ContainsKey("PrimaryAddress"))
                    this.AssignAddress.PrimVisibe = parseBoolean(this.ScreenObject.Preferences["PrimaryAddress"]);
                else
                    this.AssignAddress.PrimVisibe = false;

                dvrws = this.ScreenObject.Data.Tables[10].length > 0 ? this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -6 && (x.Mode == 1 || x.Mode == 3)) : [];
                if (this.AssignAddress.PrimVisibe && dvrws.length > 0) {
                    this.AssignAddress.PrimVisibe = parseBoolean(dvrws[0]["IsVisible"]);
                    this.AssignAddress.PrimMandatory = parseBoolean(dvrws[0]["IsMandatory"]);
                }
                else
                    this.AssignAddress.PrimMandatory = false;
                dvrws = this.ScreenObject.Data.Tables[10].length > 0 ? this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -7 && (x.Mode == 1 || x.Mode == 3)) : [];
                if (this.AssignAddress.BillsVisibe && dvrws.length > 0) {
                    this.AssignAddress.BillsVisibe = parseBoolean(dvrws[0]["IsVisible"]);
                    this.AssignAddress.BillsMandatory = parseBoolean(dvrws[0]["IsMandatory"]);
                }
                else
                    this.AssignAddress.BillsMandatory = false;
                dvrws = this.ScreenObject.Data.Tables[10].length > 0 ? this.ScreenObject.Data.Tables[10].filter(x => x.CostCenterColID == -8 && (x.Mode == 1 || x.Mode == 3)) : [];
                if (this.AssignAddress.ShipVisibe && dvrws.length > 0) {
                    this.AssignAddress.ShipVisibe = parseBoolean(dvrws[0]["IsVisible"]);
                    this.AssignAddress.ShipMandatory = parseBoolean(dvrws[0]["IsMandatory"]);
                }
                else
                    this.AssignAddress.ShipMandatory = false;
            }
            this.WfID = 0;
            this.WorkFlowDocLevel = 0;
            this.WFDocLevelList.Clear();
            this.StatusID = 0;
            this.QtyXML = "";
            this.payTermXml = "";
            this.LCBillsXml = "";
            this.ChkRtnXml = "";
            this.ArApBills = "";
            this.DocFlowXMl = "";
            this.IsUserLock = false;
            this.IsLocked = false;
            this.BtnRejVisible = true;
            this.PosDiscUserName = "";
            if (this.CaseList != null)
                this.CaseList.Clear();
            if (this.DtTempSchemes != null)
                this.DtTempSchemes.Clear();
            if (this.DtPack != null)
                this.DtPack.Clear();
            if (this.AssignAddress != null) {
                this.AssignAddress.AddressTo.Clear();
                this.AssignAddress.BillTo.Clear();
                this.AssignAddress.ShipTo.Clear();
            }
            if (this.ChequeBook != null) {
                this.ChequeBook.Items.Clear();
                this.ChequeBook.SelectedValue = "";
            }

            if (this.ViewNotes != null)
                this.ViewNotes.NotesListObj.Clear();
            if (this.AutoPostViewModel != null) {
                this.AutoPostViewModel.ScreenObject.OnDocPrefixChanged(this.AutoPostViewModel.ScreenObject.Prefix, 0, 0, this.AutoPostViewModel._Ddate, false);
                let ref_date = { value: this.AutoPostViewModel._Ddate }
                this.AutoPostViewModel.ScreenObject.Clear(ref_date, RetVal);
                this.AutoPostViewModel.DocStatus = "[" + BaseService.GetResource("Doc_Draft") + "]";
               this.AutoPostViewModel.GridNetTotal = 0; 
               this.AutoPostViewModel.FooterGridNetTotal = 0;
                this.AutoPostViewModel._Ddate = ref_date.value;
                if (this.AutoPostViewModel.AutoProduce != null) {
                    this.AutoPostViewModel.AutoProduce.ScreenObject.OnDocPrefixChanged(this.AutoPostViewModel.AutoProduce.ScreenObject.Prefix, 0, 0, this.AutoPostViewModel.AutoProduce._Ddate, false);
                    ref_date = { value: this.AutoPostViewModel.AutoProduce._Ddate }
                    this.AutoPostViewModel.AutoProduce.ScreenObject.Clear(ref_date, RetVal);
                    this.AutoPostViewModel.AutoProduce._Ddate = ref_date.value
                }
            }

            if (this.AutoProduce != null) {
                let ref_date = { value: this.AutoProduce._Ddate }
                this.AutoProduce.ScreenObject.Clear(ref_date, RetVal);
                this.AutoProduce._Ddate = ref_date.value;
            }

            this.ScreenObject.IsDirty = false;

            if (this.donotupInv != null)
                this.donotupInv.IsChecked = this.DonotUpdateInventory;

            if (this.ViewAttachments != null)
                this.ViewAttachments.AttachmentsListObj.Clear();
            if (this.grdLinkTab != null)
                this.grdLinkTab.Clear();
            if (this.ViewActivities != null) {
                // this.ViewActivities.ActivityGridData.Clear();
                this.ViewActivities.ActivityGridDataObj.Clear();
                this.ViewActivities.NodeID = 0;
            }

            if (this.Activities != null)
                this.Activities.ClearFields();

            if (this.POSPayModes != null)
                this.POSPayModes.clear();

            if (this.ViewOrganizationViewModel != null)
                this.ViewOrganizationViewModel.OrganizationData.Clear();

            if (this.IsExpressionAvailable("ServerDate")) {
                let ds = BaseService.common.GetDataSet("DOC001", "");
                if (ds != null && ds.Tables.length > 0 && !ds.Columns[0].Contains("ErrorMessage") && ds.Tables[0].length > 0 && ds.Tables[0][0]["dt"] != ""
                    && this.fldDict != null) {
                    if (BaseService.SessionManager.IsWebApplication) {
                        let ServerDate = Util.ParseDate(ds.Tables[0][0]["dt"]);
                        this.fldDict["ServerDate"].setFieldValue(ServerDate.ToString("MMM/dd/yyyy"));
                        this.FooterDics["ServerDate"].setFieldValue(ServerDate.ToString("MMM/dd/yyyy"));
                    }
                    else {
                        this.fldDict["ServerDate"].setFieldValue(ds.Tables[0][0]["dt"]);
                        this.FooterDics["ServerDate"].setFieldValue(ds.Tables[0][0]["dt"]);
                    }
                }
            }

            if (this.ScreenObject.Link != null)
                this.ScreenObject.Link.LinkStatus = "[Open]";

            if (this.ScreenObject.IsForecast) {
                this.ScreenObject.ForecastObj.Clear();
                this.ScreenObject.GridDataObj.RefreshColumns();
            }

            this.AutoPostDocID = 0;
            this.IsReplaced = 0;
            this.AutoProduceDocID = 0;
            this.LCDueAmt = 0;

            if (this.ClassName == "POSDocumentViewModel")
                this.DocStatus = "";
            else
                this.DocStatus = "[" + BaseService.GetResource("Doc_Draft") + "]";

            this.GridNetTotal = 0; this.FooterGridNetTotal = 0;
            this.Title = this.ScreenName;

            this.RefreshNetAmount();

            let dratt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LinkData == 55500);
            if (dratt.length > 0) {
                let attcnt = this.ScreenObject._TextFields.find(a => a.DBColumnID == dratt[0]["CostCenterColID"]);
                if (attcnt && attcnt instanceof PactTextBoxData)
                    attcnt.Text = "0";
            }

            this.FillExchangeRates();
            this.UpdateFooter = true;

            this.AppRejDate.Date = new Date();
            this.Remarks.Text = "";
            this.ReviseReason = "";

            if (this.DocHistoryVisibility)
                this.DocHistory.Clear();
            if (RetVal != 4)
                this.SetFocus();
            this.SetNewDocButtonVisibility();
            this.SetSaveVisibility();
            this.ConsolidateLeaveMonth();
            this.dtLoanGuarantees = null;
            this.dsProjWOffHol = null;
            this.PrevVacFrom = new Date();
            this.PrevVacTo = new Date();

            //For the apply leave to clear the data(Ag Grid session and line items form) for the new and after saving the data
            if (this.ScreenObject.DocumentType == 62) {
                this.ClearLeaveData();
            }
            if (RetVal == 1) {


                if (this.ScreenObject.DocumentType == 94 || this.ScreenObject.DocumentType == 99) //Consider LOP to Service Days | Regularization of Att.
                {
                    this.ScreenObject.GridDataObj.Clear();
                }
                if (this.ScreenObject.DocumentType == 71) //Post Past Salary Details
                {
                    this.PostSalaryDocResetColumns();
                    this.FillEarnDeductDetails(0, parseInt(Util.ParseDate(this.ScreenObject.DocDate.Date).ToString("yyyy")));
                }
                if (this.ScreenObject.DocumentType == 72) //Apply Vacation
                {
                    let fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha15");
                    if (fldAPV instanceof PactComboBoxData && !Util.IsEmpty(fldAPV.SelectedValue))
                        fldAPV.IsReadOnly = false;

                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha16");
                    if (fldAPV instanceof PactComboBoxData && !Util.IsEmpty(fldAPV.SelectedValue))
                        fldAPV.IsReadOnly = false;

                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha13");
                    if (fldAPV instanceof PactComboBoxData) {
                        fldAPV.SelectedValue = "No";
                        fldAPV.IsReadOnly = false;
                    }
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha16");
                    if (fldAPV instanceof PactComboBoxData) {
                        fldAPV.SelectedValue = "No";
                        fldAPV.IsReadOnly = false;
                    }

                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                    if (fldAPV instanceof PactTextBoxData)
                        fldAPV.IsReadOnly = true;

                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha14");
                    if (fldAPV instanceof PactTextBoxData)
                        fldAPV.IsReadOnly = true;

                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                    if (fldAPV instanceof PactExtraFieldDateData)
                        fldAPV.IsReadOnly = false;

                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                    if (fldAPV instanceof PactExtraFieldDateData)
                        fldAPV.IsReadOnly = false;

                    fldAPV = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if (fldAPV instanceof PactListBoxData)
                        fldAPV.IsReadOnly = false;
                    else if (fldAPV instanceof PactCodeNameListBoxData)
                        fldAPV.IsReadOnly = false;

                    //foreach (let item1 in this.ScreenObject._TextFields)
                    //{
                    //if (item1 instanceof PactExtraFieldDateData && ((PactExtraFieldDateData)item1).DBColumnName.toLowerCase() == "dcalpha2")
                    //    ((PactExtraFieldDateData)item1).SelectedDateChanged = new DelegateCommand<object>(ApplyVacationFrom);
                    //if (item1 instanceof PactExtraFieldDateData && ((PactExtraFieldDateData)item1).DBColumnName.toLowerCase() == "dcalpha3")
                    //    ((PactExtraFieldDateData)item1).SelectedDateChanged = new DelegateCommand<object>(ApplyVacation);
                    //}
                    this.FillEarningsDeductions(0, this.ScreenObject.DocDate.Date);
                    this.ShowVacationCreditDaysDetail(0);

                }
            }

            if (this.ScreenObject.DocumentType == 72) //Apply Vacation
            {
                this.ShowVacationCreditDaysDetail(0);
                this.VacCrDaysScreen.Clear();
            }

            if (this.ScreenObject.DocumentType == 75) //Gratuity Settings
                this.FillGratuitySettingsExpDetails();

            if (this.ScreenObject.DocumentType == 76) //Form 12BA
                this.FillForm12BALookupDetails();

            if (this.ScreenObject.DocumentType == 77) //Payroll Lock/Unlock
                this.FillPayrollLockUnlockDetails(false);

            if (this.ScreenObject.DocumentType == 72) {
                if (this.oVac != null)
                    this.oVac = null;
            }
            if (this.ScreenObject.DocumentType == 68) //Recording of data
            {
                let fldROD: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha2");
                if (fldROD != undefined) {
                    fldROD.Date = Util.ParseDate(BaseService.SessionManager.PayrollMonth);//.ToString(BaseService.SessionManager.Preferences["Date Format"]));
                    fldROD.CustomFormat = "MMM/yyyy";
                }
                fldROD = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha4");
                if (fldROD != undefined) {
                    fldROD.Date = Util.ParseDate(BaseService.SessionManager.PayrollMonth);
                    fldROD.CustomFormat = "MMM/yyyy";
                }
            }
            if (this.ScreenObject.DocumentType == 86) //Time off Request
            {
                let fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha2");
                if (fld instanceof PactDateTimeData) {
                    fld.CustomFormat = "HH:mm";
                    fld.Date = new Date();
                }

                fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha3");
                if (fld instanceof PactDateTimeData) {
                    fld.CustomFormat = "HH:mm";
                    fld.Date = new Date();
                }

                let per = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha3");
                if (per)
                    this.onDateChanged(per);
            }

            if (this.ScreenObject.DocumentType == 85) // Bulk Appraisals
            {
                let fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha1");
                if (fld instanceof PactExtraFieldDateData) {
                    fld.CustomFormat = "MMM/yyyy";
                    fld.Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                }

                fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha2");
                if (fld instanceof PactExtraFieldDateData) {
                    fld.CustomFormat = "MMM/yyyy";
                    fld.Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                }
                fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha4");
                if (fld instanceof PactExtraFieldDateData) {
                    fld.CustomFormat = "MMM/yyyy";
                    fld.Date = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                }
            }

            if (this.ScreenObject.DocumentType == 56) //Apply Loan
                this.EmployeewiseDocumentView(40056, this.strEmpIsMgr, "False");

            if (this.ScreenObject.DocumentType == 81)//Assign Leaves
            {
                this.ScreenObject._TextFields.forEach(item1 => {
                    if (item1 instanceof PactComboBoxData && item1.DBColumnName.toLowerCase() == "dcalpha1")
                        item1.SelectionChangedCommand.Subscribe(this, "LeavesBasedon");

                    if (item1 instanceof PactComboBoxData && item1.DBColumnName.toLowerCase() == "dcalpha2")
                        item1.IsReadOnly = false;
                });

                let ALfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
                if (ALfld && ALfld instanceof PactListBoxData)
                    ALfld.Enable = true;

                this.dtData = null;
                let DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50051);
                //let DimGrdBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50053);
                if (DimEmpBodyfld && DimEmpBodyfld instanceof DgColumn) {
                    DimEmpBodyfld.IsVisible = false;
                }
            }

            if (this.ScreenObject.DocumentType == 67) //Daily Attendance
            {
                let dsDAStr = BaseService.common.GetDataSet("PAY033", this.ScreenObject.CostCenterID.toString());
                if (dsDAStr != null && dsDAStr.Tables[0].length == 0)
                    this.ReadOnlyBody = true;
            }
            if (this.ScreenObject.DocumentType == 97) //Lates Processing
            {
                this.ScreenObject.GridDataObj.Clear();
                this.dtPayMon = new Date();
                this.dtPayMonStart = new Date();
                this.dtPayMonEnd = new Date();

                let fldROD: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha16");
                if (fldROD != undefined) {
                    fldROD.CustomFormat = "01/MMM/yyyy";
                    fldROD.Date = Util.ParseDate(BaseService.SessionManager.PayrollMonth);
                }

                fldROD = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha33");
                if (fldROD != undefined) {
                    fldROD.CustomFormat = "01/MMM/yyyy";
                    fldROD.Date = Util.ParseDate(BaseService.SessionManager.PayrollMonth);
                }

            }

            this.intRecCount = 0;

            //////// PAYROLL 
            if (this.objPayDayCheck != null) {
                this.objPayDayCheck.dsWOffData = { Tables: [] };
                this.objPayDayCheck.dsHMData = { Tables: [] };
                this.objPayDayCheck.dtEmpData = null;
            }

            this.dsSaved = { Tables: [] };
            this.dsHrsDef = { Tables: [] };
            this.dtEData = null;
            this.dtVacDefineDays = null;
            this.dtVacContract = null;
            this.IsLatesProcessTimingsUpdated = false;
            //////// END PAYROLL 

        }

        if (this.ScreenObject.Preferences.ContainsKey("HideBody") && !Util.IsEmpty(this.ScreenObject.Preferences["HideBody"]) && parseBoolean(this.ScreenObject.Preferences["HideBody"].toString()))
            this.BodyVisible = false;

    }




    IsLatesProcessTimingsUpdated = false;

    public SetNewDocButtonVisibility() {
        let btn = this.GetButton("Submit");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("Submitprint");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("Generate");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("GST");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("API");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("Redeposit");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("Stock Posting");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("Enquiries");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("Bounce");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("Advance");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("PriceChart");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("Pay");
        if (btn != null)
            btn.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Create");

        btn = this.GetButton("Save");
        if (btn != null)
            btn.Visible = true;
        btn = this.GetButton("Convert");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("Close");
        if (btn != null)
            btn.Visible = false;

        btn = this.GetButton("ReverseJV");
        if (btn != null)
            btn.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "ReverseJV");

        this.ApproveVisibility = false;
        this.ButtonRevise.Visible = false;
        this.ButtonApprove.Visible = false;

        this.ButtonSuspend.Visible = false;
        this.ButtonCloseVisibility = false;

        this.CaseVisibility = false;

        if (this.ScreenObject.DocumentType == 56 && this.DocID == 0)
            this.DistributeInstallmentsVisible = true;

        if (this.ScreenObject.DocumentType == 92) //Payroll - Shift Assign
        {
            btn = this.GetButton("Fill Dates");
            if (btn != null) {
                if (this.DocID == 0)
                    btn.Visible = true;
                else
                    btn.Visible = false;
            }
        }

        this.ButtonSave.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Create");
        if (BaseService.SessionManager.HideUnathorizedAccess)
            this.ButtonSave.Enable = true;
        else
            this.ButtonSave.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Create");

        this.ButtonDelete.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");
        if (BaseService.SessionManager.HideUnathorizedAccess)
            this.ButtonDelete.Enable = true;
        else
            this.ButtonDelete.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Delete");

        this.ButtonSaveandPrint.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");
        if (BaseService.SessionManager.HideUnathorizedAccess)
            this.ButtonSaveandPrint.Enable = true;
        else
            this.ButtonSaveandPrint.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Print");

        this.HideButtons("Save&Barcode");

        this.HideButtons("BarcodePrint");


        if (this.IsMPVParent || this.IsFrmFS_LoanBal) {
            this.OKCancelVisibility = true;
            this.ButtonCloseVisibility = true;

            if (this.IsFrmFS_LoanBal) {
                this.DisableRightPanel = true;
            }
        }
    }
    DimWiseAttachment(dt: any, Name: string) {
        let isAutoattach = false;
        if (dt.length > 0 && Util.Int(dt[0]["FeatureID"]) > 50000) {
            if (this.ScreenObject.Preferences.ContainsKey("AutoDimWiseAttachments") && parseBoolean(this.ScreenObject.Preferences["AutoDimWiseAttachments"]))
                isAutoattach = parseBoolean(this.ScreenObject.Preferences["AutoDimWiseAttachments"]);
            else
                isAutoattach = false;
        }
        if (!isAutoattach) {
            BaseService.page.ShowDialog(new ProductAttachmentViewModel(this, dt, Name)
                , ProductAttachmentsComponent, { ShowCenter: true });
        }
        else {
            for (let p = 0; p < dt.length; p++) {
                let addatt1: AddAttachmentViewModel = new AddAttachmentViewModel();
                addatt1.AddAttachmentViewModel_2(this);
                {
                    addatt1.ActualFileName = Util.String(dt[p]["ActualFileName"]);
                    addatt1.FileExtension = Util.String(dt[p]["FileExtension"]);
                    addatt1.Guid = Util.String(dt[p]["GUID"]);
                    addatt1.FileDescription = Util.String(dt[p]["FileDescription"]).toString();
                    addatt1.FilePath = Util.GetPath(Util.String(dt[p]["GUID"]) + "." + Util.String(dt[p]["FileExtension"]));
                    addatt1.RelativeFileName = Util.String(dt[p]["RelativeFileName"]);
                    addatt1.AllowInPrintVisible = true;
                    addatt1.AllowInPrint = true;
                    addatt1.isfrmProduct = true;
                    this.ViewAttachments.AttachmentsListObj.addRow(addatt1);
                }
            }
        }
    }

    ReferenceCallBack(param) {
        let ReferenceTable: any[] = param.ReferenceTable, ReferenceEditTable: any[] = param.ReferenceEditTable,
            DBColumnName: string = param.DBColumnName, ccid: number = param.ccid, dr: any = param.dr
        if (DBColumnName == "LinkAll") {
            this.ScreenObject.GridDataObj.Clear();
            this.ScreenObject.UpdateSequence();
            let Vno = "";
            for (let i = 0; i < this.ScreenObject.Link.DocumentList.Items.length; i++) {
                if (Vno != "")
                    Vno += "','";

                Vno += this.ScreenObject.Link.DocumentList.Items[i].Name;
            }
            if (Vno != "")
                this.FillLink(Vno, parseInt(this.ScreenObject.Link.LinkCombo.SelectedValue), [], []);

            this.ScreenObject.UpdateSequence();
        }
        else if (DBColumnName == "ReCalculate") {
            this.onExchangeRateChanged("");
            this.CalculateTotals(null, false);
        }
        else if (DBColumnName == "FillDefaultVal") {
            this.FillDefaultValues(dr);
        }
        else if (DBColumnName == "ReEvaluate") {
            if (dr != null)
                this.ReEvaluatePriceTax_3(dr, ccid);
            else
                this.ReEvaluatePriceTax(ccid);
        }
        else if (DBColumnName == "Dimension")
            this.DimensionSelectedvalueData();
        else if (DBColumnName == "Formula") {
            if (this.fldDict == null)
                return;
            this.ScreenObject._TextFields.forEach(item => {
                if (this.fldDict.ContainsKey(item.Lbl)) {
                    if (item instanceof PactTextBoxData) {
                        if (item.DataType == "FLOAT") {
                            if (item.Text != null && item.Text != "" && item.ValidateData() == "")
                                this.fldDict[item.Lbl].setFieldValue(item.Text);
                            else
                                this.fldDict[item.Lbl].setFieldValue(0);
                        }
                        else
                            this.fldDict[item.Lbl].setFieldValue(item.Text);
                    }
                    else if (item instanceof PactComboBoxData)
                        this.fldDict[item.Lbl].setFieldValue(item.SelectedValue);
                    else if (item instanceof PactSelectionBoxData)
                        this.fldDict[item.Lbl].setFieldValue(item.Text);
                    else if (item instanceof PactExtraFieldDateData && item.Date)
                        this.fldDict[item.Lbl].setFieldValue(item.Date);
                    else if (item instanceof PactListBoxData) {
                        if (item.SelectedValue > 0 && !Util.IsEmpty(item.Text))
                            this.fldDict[item.Lbl].setFieldValue(item.Text);
                        else
                            this.fldDict[item.Lbl].setFieldValue("");
                    }
                }
            });

            this.fldDict["DOCDATE"].setFieldValue(this.DocumentDate);
            if (this.ScreenObject.DueDate && this.ScreenObject.DueDate.Date)
                this.fldDict["DUEDATE"].setFieldValue(this.ScreenObject.DueDate.Date);
            else
                this.fldDict["DUEDATE"].setFieldValue(Date.Today());
            let bildate = this.ScreenObject._StaticFields.find(a => a.DBColumnName.toLowerCase() == "billdate");
            if (bildate && bildate instanceof PactExtraFieldDateData && bildate.Date)
                this.fldDict["BILLDATE"].setFieldValue(bildate.Date);
            else
                this.fldDict["BILLDATE"].setFieldValue(Date.Today());
            let Res = BaseService.eval.EvaluateExpression(this.ScreenObject.DueDate.Formula, this.fldDict);
            if (Res != null && Util.isValidDate(Res))
                this.ScreenObject.DueDate.Date = Util.ParseDate(Res);
        }
        else if (DBColumnName.Contains("Attachments") && this.ViewAttachments != null) {
            DBColumnName = DBColumnName.substr(DBColumnName.indexOf("~") + 1);
            this.DimWiseAttachment(ReferenceTable, DBColumnName);
        }
        else if (dr != null) {
            this.ProdID = 0;
            this.AddProductData(dr, false, false);
            this.ApplySchemes(dr);
        }
        else if (this.AssignAddress != null) {
            if (ReferenceTable.length > 0) {
                let dradd: any[];
                if (this.ScreenObject.IsPurchase && DBColumnName.toLowerCase() == "creditaccount") {
                    this.AssignAddress.AddressTo.Clear();
                    this.AssignAddress.BillTo.Clear();
                    this.AssignAddress.ShipTo.Clear();
                    this.AssignAddress.AddressTo.push(ComboBoxItems.ComboBoxItems_2("", ""));
                    this.AssignAddress.BillTo.push(ComboBoxItems.ComboBoxItems_2("", ""));
                    this.AssignAddress.ShipTo.push(ComboBoxItems.ComboBoxItems_2("", ""));
                    this.AssignAddress.AddressToName.Text = "";
                    this.AssignAddress.AddressTo1.Text = "";
                    this.AssignAddress.PhoneTo1.Text = "";
                    this.AssignAddress.AddressName.Text = "";
                    this.AssignAddress.Address1.Text = "";
                    this.AssignAddress.Phone1.Text = "";
                    this.AssignAddress.SAddressName.Text = "";
                    this.AssignAddress.SAddress1.Text = "";
                    this.AssignAddress.SPhone1.Text = "";

                    dradd = ReferenceTable.filter(x => x.AddressTypeID == 1);
                    dradd.forEach(dra => {
                        this.AssignAddress.AddressTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));
                        if (Object.keys(ReferenceTable[0]).Contains("IsDefault") && parseBoolean(dra["IsDefault"])) {
                            this.AssignAddress.SelectedAddressTo = Util.String(dra["AddressID"]);
                            this.AssignAddress.AddressToName.Text = Util.String(dra["ContactPerson"]);
                            this.AssignAddress.AddressTo1.Text = Util.String(dra["Address1"]) + " " + Util.String(dra["Address2"]) + " " + Util.String(dra["Address3"]);
                            this.AssignAddress.PhoneTo1.Text = Util.String(dra["Phone1"]);
                            this.AssignAddress.AddressToCity.Text = Util.String(dra["City"]) + " " + Util.String(dra["State"]) + " " + Util.String(dra["Zip"]);
                            this.AssignAddress.AddressToVisbility = true;
                        }
                    });

                    dradd = ReferenceTable.filter(x => x.AddressTypeID == 2);
                    dradd.forEach(dra => {
                        this.AssignAddress.BillTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));
                        if (Object.keys(ReferenceTable[0]).Contains("IsDefault") && parseBoolean(dra["IsDefault"])) {
                            this.AssignAddress.SelectedBillTo = Util.String(dra["AddressID"]);
                            this.AssignAddress.AddressToName.Text = Util.String(dra["ContactPerson"]);
                            this.AssignAddress.AddressTo1.Text = Util.String(dra["Address1"]) + " " + Util.String(dra["Address2"]) + " " + Util.String(dra["Address3"]);
                            this.AssignAddress.PhoneTo1.Text = Util.String(dra["Phone1"]);
                            this.AssignAddress.AddressToCity.Text = Util.String(dra["City"]) + " " + Util.String(dra["State"]) + " " + Util.String(dra["Zip"]);
                            this.AssignAddress.AddressToVisbility = true;
                        }
                    });

                    dradd = ReferenceTable.filter(x => x.AddressTypeID == 3);
                    dradd.forEach(dra => {
                        this.AssignAddress.ShipTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));
                        if (Object.keys(ReferenceTable[0]).Contains("IsDefault") && parseBoolean(dra["IsDefault"])) {
                            this.AssignAddress.SelectedShipTo = Util.String(dra["AddressID"]);
                            this.AssignAddress.AddressToName.Text = Util.String(dra["ContactPerson"]);
                            this.AssignAddress.AddressTo1.Text = Util.String(dra["Address1"]) + " " + Util.String(dra["Address2"]) + " " + Util.String(dra["Address3"]);
                            this.AssignAddress.PhoneTo1.Text = Util.String(dra["Phone1"]);
                            this.AssignAddress.AddressToCity.Text = Util.String(dra["City"]) + " " + Util.String(dra["State"]) + " " + Util.String(dra["Zip"]);
                            this.AssignAddress.AddressToVisbility = true;
                        }
                    });

                }
                else if (DBColumnName.toLowerCase() == "debitaccount") {
                    this.AssignAddress.ShipTo.Clear();
                    this.AssignAddress.ShipTo.push(ComboBoxItems.ComboBoxItems_2("", ""));

                    this.AssignAddress.SAddressName.Text = "";
                    this.AssignAddress.SAddress1.Text = "";
                    this.AssignAddress.SPhone1.Text = "";

                    dradd = ReferenceTable.filter(x => x.AddressTypeID == 3);
                    dradd.forEach(dra => {
                        this.AssignAddress.ShipTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));
                        if (Object.keys(ReferenceTable[0]).Contains("IsDefault") && parseBoolean(dra["IsDefault"])) {
                            this.AssignAddress.SelectedShipTo = Util.String(dra["AddressID"]);
                            this.AssignAddress.AddressToName.Text = Util.String(dra["ContactPerson"]);
                            this.AssignAddress.AddressTo1.Text = Util.String(dra["Address1"]) + " " + Util.String(dra["Address2"]) + " " + Util.String(dra["Address3"]);
                            this.AssignAddress.PhoneTo1.Text = Util.String(dra["Phone1"]);
                            this.AssignAddress.AddressToCity.Text = Util.String(dra["City"]) + " " + Util.String(dra["State"]) + " " + Util.String(dra["Zip"]);
                            this.AssignAddress.AddressToVisbility = true;
                        }
                    });

                    if (!this.ScreenObject.IsPurchase) {
                        this.AssignAddress.AddressTo.Clear();
                        this.AssignAddress.BillTo.Clear();
                        this.AssignAddress.AddressTo.push(ComboBoxItems.ComboBoxItems_2("", ""));
                        this.AssignAddress.BillTo.push(ComboBoxItems.ComboBoxItems_2("", ""));

                        this.AssignAddress.AddressToName.Text = "";
                        this.AssignAddress.AddressTo1.Text = "";
                        this.AssignAddress.PhoneTo1.Text = "";

                        this.AssignAddress.AddressName.Text = "";
                        this.AssignAddress.Address1.Text = "";
                        this.AssignAddress.Phone1.Text = "";
                        dradd = ReferenceTable.filter(x => x.AddressTypeID == 1);
                        dradd.forEach(dra => {
                            this.AssignAddress.AddressTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));
                            if (Object.keys(ReferenceTable[0]).Contains("IsDefault") && parseBoolean(dra["IsDefault"])) {
                                this.AssignAddress.SelectedAddressTo = Util.String(dra["AddressID"]);
                                this.AssignAddress.AddressToName.Text = Util.String(dra["ContactPerson"]);
                                this.AssignAddress.AddressTo1.Text = Util.String(dra["Address1"]) + " " + Util.String(dra["Address2"]) + " " + Util.String(dra["Address3"]);
                                this.AssignAddress.PhoneTo1.Text = Util.String(dra["Phone1"]);
                                this.AssignAddress.AddressToCity.Text = Util.String(dra["City"]) + " " + Util.String(dra["State"]) + " " + Util.String(dra["Zip"]);
                                this.AssignAddress.AddressToVisbility = true;
                            }
                        });

                        dradd = ReferenceTable.filter(x => x.AddressTypeID == 2);
                        dradd.forEach(dra => {
                            this.AssignAddress.BillTo.push(ComboBoxItems.ComboBoxItems_2(dra["AddressName"].toString(), dra["AddressID"].toString()));
                            if (Object.keys(ReferenceTable[0]).Contains("IsDefault") && parseBoolean(dra["IsDefault"])) {
                                this.AssignAddress.SelectedBillTo = Util.String(dra["AddressID"]);
                                this.AssignAddress.AddressToName.Text = Util.String(dra["ContactPerson"]);
                                this.AssignAddress.AddressTo1.Text = Util.String(dra["Address1"]) + " " + Util.String(dra["Address2"]) + " " + Util.String(dra["Address3"]);
                                this.AssignAddress.PhoneTo1.Text = Util.String(dra["Phone1"]);
                                this.AssignAddress.AddressToCity.Text = Util.String(dra["City"]) + " " + Util.String(dra["State"]) + " " + Util.String(dra["Zip"]);
                                this.AssignAddress.AddressToVisbility = true;
                            }
                        });
                    }
                }
            }
        }
    }

    //#region Drafts Code & Cash Drawer
    GetDraftXML(IsAutoSave: boolean): any {
        let i, k;
        let objRet = { LastRowNo: 0, strXML: "" };
        for (objRet.LastRowNo = this.ScreenObject.GridData.length - 1; objRet.LastRowNo >= 0; objRet.LastRowNo--) {
            for (i = 2; i < this.ScreenObject.GridDataColumns.length; i++) {
                if (Util.String(this.ScreenObject.GridData[objRet.LastRowNo][this.ScreenObject.GridDataColumns[i]]).length > 0)
                    break;
            }
            if (i != this.ScreenObject.GridDataColumns.length)
                break;
        }
        if (objRet.LastRowNo == -1 && IsAutoSave)
            return "";

        let sb = "";
        sb += "<XML>";
        sb += "<Header>";
        this.ScreenObject.HeaderFields.forEach(obj => {
            if (obj instanceof PactTextBoxData) {
                sb += "<" + obj.DBColumnName + ">";
                sb += PactTextBoxData.GetValidXml(obj.Text);
                sb += "</" + obj.DBColumnName + ">";
            }
            else if (obj instanceof PactTextAreaData) {
                sb += "<" + obj.DBColumnName + ">";
                sb += PactTextBoxData.GetValidXml(obj.Text);
                sb += "</" + obj.DBColumnName + ">";
            }
            else if (obj instanceof PactExtraFieldDateData) {
                if (obj.Date) {
                    sb += "<" + obj.DBColumnName + ">";
                    sb += obj.Date.ToString("dd MMM yyyy");
                    sb += "</" + obj.DBColumnName + ">";
                }
            }
            else if (obj instanceof PactDatePickerData) {
                sb += "<" + obj.DBColumnName + ">";
                sb += obj.Date.ToString("dd MMM yyyy");
                sb += "</" + obj.DBColumnName + ">";
            }
            else if (obj instanceof PactListBoxData) {
                sb += "<" + obj.DBColumnName + ">";
                sb += obj.SelectedValue;
                sb += "</" + obj.DBColumnName + ">";
            }
            else if (obj instanceof PactComboTextData) {
                sb += "<" + obj.DBColumnName + "_COMBO>";
                sb += obj.ComboBox.SelectedValue;
                sb += "</" + obj.DBColumnName + "_COMBO>";
            }
            else if (obj instanceof PactCodeNameListBoxData) {
                sb += "<" + obj.DBColumnName + ">";
                sb += obj.SelectedValue;
                sb += "</" + obj.DBColumnName + ">";
            }
            else if (obj instanceof PactCurrencyData) {
                sb += "<" + obj.DBColumnName + ">";
                sb += "<Currency>" + obj.Currency.SelectedValue + "</Currency>";
                sb += "<ExchangeRate>" + obj.ExchangeRate.Text + "</ExchangeRate>";
                sb += "</" + obj.DBColumnName + ">";
            }
        });
        this.ScreenObject._CCFields.forEach(lst => {
            if (lst instanceof PactListBoxData) {
                sb += "<" + lst.DBColumnName + ">";
                sb += lst.SelectedValue;
                sb += "</" + lst.DBColumnName + ">";
            }
            else if (lst instanceof PactCodeNameListBoxData) {
                sb += "<" + lst.DBColumnName + ">";
                sb += lst.SelectedValue;
                sb += "</" + lst.DBColumnName + ">";
            }
        });
        this.ScreenObject._TextFields.forEach(txtf => {
            if (txtf instanceof PactTextBoxData) {
                let txt = txtf;
                sb += "<" + txt.DBColumnName + ">";
                sb += PactTextBoxData.GetValidXml(txt.Text);
                sb += "</" + txt.DBColumnName + ">";
            }
            else if (txtf instanceof PactTextAreaData) {
                let txt = txtf;
                sb += "<" + txt.DBColumnName + ">";
                sb += PactTextBoxData.GetValidXml(txt.Text);
                sb += "</" + txt.DBColumnName + ">";
            }
            else if (txtf instanceof PactExtraFieldDateData) {
                let dte = txtf;
                if (dte.Date) {
                    sb += "<" + dte.DBColumnName + ">";
                    sb += dte.Date.ToString("dd MMM yyyy");
                    sb += "</" + dte.DBColumnName + ">";
                }
            }
            else if (txtf instanceof PactDatePickerData) {
                let dt = txtf;
                if (dt.Date == null || dt.Date == undefined)
                    dt.Date = new Date().OnlyDate();

                sb += "<" + dt.DBColumnName + ">";
                sb += dt.Date.ToString("dd MMM yyyy");
                sb += "</" + dt.DBColumnName + ">";
            }
            else if (txtf instanceof PactListBoxData) {
                let lst = txtf;
                sb += "<" + lst.DBColumnName + ">";
                sb += lst.SelectedValue;
                sb += "</" + lst.DBColumnName + ">";
            }
            else if (txtf instanceof PactComboBoxData) {
                let lst = txtf;
                sb += "<" + lst.DBColumnName + ">";
                sb += lst.SelectedValue;
                sb += "</" + lst.DBColumnName + ">";
            }
            else if (txtf instanceof PactSelectionBoxData) {
                let lst = txtf;
                sb += "<" + lst.DBColumnName + ">";
                sb += lst.Text;
                sb += "</" + lst.DBColumnName + ">";
            }

        });
        sb += "</Header>";
        let val;
        sb += "<DataTable>";
        for (k = 0; k <= objRet.LastRowNo; k++) {
            let dr = this.ScreenObject.GridData[k];
            sb += "<Row>";
            for (i = 0; i < this.ScreenObject.GridDataColumns.length; i++) {
                val = dr[this.ScreenObject.GridDataColumns[i]];
                if (Util.IsEmpty(val))
                    continue;
                sb += "<" + this.ScreenObject.GridDataColumns[i] + ">";
                sb += PactTextBoxData.GetValidXml(val);
                sb += "</" + this.ScreenObject.GridDataColumns[i] + ">";
            }
            sb += "</Row>";
        }
        sb += "</DataTable>";
        sb += "<FooterTable>";
        this.ScreenObject.FooterGridData.forEach(dr => {
            sb += "<Row>";

            sb += "<ColumnName>";
            sb += Util.String(dr["ColumnName"]);
            sb += "</ColumnName>";

            sb += "<Amount>";
            sb += Util.String(dr["Amount"]);
            sb += "</Amount>";

            sb += "<CalcAmount>";
            sb += Util.String(dr["CalcAmount"]);
            sb += "</CalcAmount>";

            sb += "<dcCurrID>";
            sb += Util.String(dr["dcCurrID"]);
            sb += "</dcCurrID>";

            sb += "<dcCurrID_Key>";
            sb += Util.String(dr["dcCurrID_Key"]);
            sb += "</dcCurrID_Key>";

            sb += "<dcExchrt>";
            sb += Util.String(dr["dcExchrt"]);
            sb += "</dcExchrt>";

            sb += "</Row>";
        });
        sb += "</FooterTable>";

        sb += "</XML>";
        objRet.strXML = sb;
        return objRet;
    }
    PoleDisplaytimer_Elapsed() {
        this.PoleDisplayMessage(1, null);
        this.PoleDisplaytimer.Enabled = false;
    }
    timerDraft_Elapsed() {
        if (!this.ButtonsEnabled || (this.ScreenObject != null && this.ScreenObject.IsDocEdit) || (BaseService.SessionManager.Preferences.ContainsKey("AutoDocumentDraft") && !parseBoolean(BaseService.SessionManager.Preferences["AutoDocumentDraft"])))
            return;
        if (BaseService.page.isActiveTab(this))
            this.SaveDraft(true, true);
    }

    SaveDraft(IsAutoSave: boolean, IsDraft: boolean) {
        try {
            let objRet: any;
            objRet = this.GetDraftXML(IsAutoSave);

            if (IsAutoSave && objRet.strXML.length == 0)
                return;

            let al = [];
            al.push(this.ScreenObject.DraftID);
            al.push(this.ScreenObject.CostCenterID);
            al.push(0);//NodeID
            al.push(objRet.strXML);
            if (IsDraft)
                al.push(1);
            else
                al.push(2);
            al.push(this.HoldDocName.Text);
            if (!IsDraft)
                al.push(this.HoldDocDate.Date);
            else
                al.push(this.DocumentDate);
            al.push(objRet.LastRowNo);
            al.push(this.NetAmount);
            al.push(this.ScreenObject.RegisterNodeID);
            al.push(this.ScreenObject.LocationID);
            al.push(this.ScreenObject.DivisionID);

            this.ScreenObject.SetDocumentDraft(al).subscribe(
                (response: any) => {
                    if (response.RetValue > 0)
                        this.ScreenObject.DraftID = response.RetValue;
                    if (this.ScreenObject.DraftID > 0) {
                        if (IsDraft)
                            this.DisplayMessage += "Draft Saved At " + new Date().ToString("hh:mm a") + " ";
                        else {
                            this.clear(1);
                            this.ScreenObject.DraftID = 0;
                            this.DisplayMessage += "Document Hold Succesfully";
                            BaseService.page.HideDialog(this.PopUpGUID);
                            this.HoldDocName.Text = "";
                        }
                    }
                    else {
                        this.DisplayMessage = response.Message;
                    }
                },
                (error) => {

                    console.log(error);
                }
            );
        }
        catch { }
    }

    LoadDraftXML(drData: any, Isfromreport: boolean = false) {
        let DataXML = drData["DataXML"].toString();
        if (DataXML.length == 0)
            return;

        let i, k;
        let xDoc = new XmlDocument();
        xDoc.LoadXml(drData["DataXML"]);
        this.ScreenObject.DraftID = parseInt(drData["DraftID"]);
        if (!Util.IsEmpty(drData["DocName"]))
            this.HoldDocName.Text = drData["DocName"].toString();
        let xNode, xHeader, val;
        xHeader = xDoc.SelectSingleNode("XML/Header");
        this.ScreenObject.HeaderFields.forEach(obj => {
            if (obj instanceof PactTextBoxData) {
                let txt = obj;
                val = xDoc.getDateByNodeName(xHeader, obj.DBColumnName);
                if (val != null)
                    txt.Text = val;
            }
            else if (obj instanceof PactTextAreaData) {
                let txt = obj;
                val = xDoc.getDateByNodeName(xHeader, obj.DBColumnName);
                if (xNode != null)
                    txt.Text = val;
            }
            else if (obj instanceof PactExtraFieldDateData) {
                let dte = obj;
                val = xDoc.getDateByNodeName(xHeader, obj.DBColumnName);
                if (val != null)// && xNode.InnerText != "")
                {
                    dte.Date = Util.ParseDate(val);
                }
            }
            else if (obj instanceof PactDatePickerData) {
                let dt = obj;
                val = xDoc.getDateByNodeName(xHeader, obj.DBColumnName);
                if (val != null)
                    dt.Date = Util.ParseDate(val);
                if (dt.DBColumnName == "DocDate")
                    this.DocumentDate = dt.Date;
            }
            else if (obj instanceof PactListBoxData) {
                let lst = obj;
                val = xDoc.getDateByNodeName(xHeader, obj.DBColumnName);
                if (val != null) {
                    lst.OnPactListBoxValueChanged.UnSubscribe();
                    lst.SelectedValue = parseInt(val);
                    lst.OnPactListBoxValueChanged.Subscribe(this.ScreenObject, "OnGetReference");
                }
            }
            else if (obj instanceof PactComboTextData) {
                let cmbText = obj;
                val = xDoc.getDateByNodeName(xHeader, obj.DBColumnName + "_COMBO");
                if (val != null)
                    cmbText.ComboBox.SelectedValue = val;
            }
            else if (obj instanceof PactCodeNameListBoxData) {
                let lstcn = obj;
                val = xDoc.getDateByNodeName(xHeader, obj.DBColumnName);
                if (val != null) {
                    lstcn.SelectionCallBack.UnSubscribe();
                    lstcn.SelectedValue = parseInt(val);
                    lstcn.SelectionCallBack.Subscribe(this.ScreenObject, "OnGetReference");
                }
            }
            else if (obj instanceof PactCurrencyData) {
                let curcn = obj;
                xNode = xDoc.getNodeByName(xHeader, curcn.DBColumnName);//xHeader.SelectSingleNode(curcn.DBColumnName);
                if (xNode != null) {
                    curcn.Currency.SelectedValue = xNode.firstChild.innerHTML;
                    curcn.ExchangeRate.Text = xNode.lastChild.innerHTML;
                }
            }
        });
        this.ScreenObject._CCFields.forEach(lst => {
            // Old code... later need to remove
            // val = xDoc.getDateByNodeName(xHeader, lst.DBColumnName);
            // if (val != null && lst instanceof PactListBoxData) {
            //     lst.OnPactListBoxValueChanged.UnSubscribe();
            //     lst.SelectedValue = parseInt(val);
            //     lst.OnPactListBoxValueChanged.Subscribe(this.ScreenObject, "OnGetReference");
            //     if (lst.CCID == 50001 && !lst.DBColumnName.startsWith("TO") && Isfromreport && BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True"
            //         && !(this.ScreenObject.Preferences.ContainsKey("Donotusedivision") && this.ScreenObject.Preferences["Donotusedivision"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotusedivision"])))
            //         this.ScreenObject.DivisionID = lst.SelectedValue;
            //     else if (lst.CCID == 50002 && !lst.DBColumnName.startsWith("TO") && Isfromreport && BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True"
            //          && !(this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])))
            //          this.ScreenObject.DivisionID = lst.SelectedValue;
            // }

            if (lst instanceof PactListBoxData || lst instanceof PactCodeNameListBoxData) {
                val = xDoc.getDateByNodeName(xHeader, lst.DBColumnName);
                if (val != null && lst instanceof PactListBoxData) {
                    // xNode = xHeader.SelectSingleNode(lst.DBColumnName);
                    // if (xNode != null)
                    {
                        lst.OnPactListBoxValueChanged.UnSubscribe();
                        lst.SelectedValue = parseInt(val);
                        lst.OnPactListBoxValueChanged.Subscribe(this.ScreenObject, "OnGetReference");
                        if (lst.CCID == 50001 && !lst.DBColumnName.startsWith("TO") && Isfromreport && BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True"
                            && !(this.ScreenObject.Preferences.ContainsKey("Donotusedivision") && this.ScreenObject.Preferences["Donotusedivision"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotusedivision"])))
                            this.ScreenObject.DivisionID = lst.SelectedValue;
                        else if (lst.CCID == 50002 && !lst.DBColumnName.startsWith("TO") && Isfromreport && BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True"
                            && !(this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])))
                            this.ScreenObject.DivisionID = lst.SelectedValue;
                    }
                }
                else if (val != null && lst instanceof PactCodeNameListBoxData) {
                    // xNode = xHeader.SelectSingleNode(lst.DBColumnName);
                    // if (xNode != null)
                    {
                        lst.Name.OnPactListBoxValueChanged.UnSubscribe();
                        lst.SelectedValue = parseInt(val);
                        lst.Name.OnPactListBoxValueChanged.Subscribe(this.ScreenObject, "OnGetReference");
                        if (lst.CCID == 50001 && !lst.DBColumnName.startsWith("TO") && Isfromreport && BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True"
                            && !(this.ScreenObject.Preferences.ContainsKey("Donotusedivision") && this.ScreenObject.Preferences["Donotusedivision"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotusedivision"])))
                            this.ScreenObject.DivisionID = lst.SelectedValue;
                        else if (lst.CCID == 50002 && !lst.DBColumnName.startsWith("TO") && Isfromreport && BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True"
                            && !(this.ScreenObject.Preferences.ContainsKey("Donotuselocation") && this.ScreenObject.Preferences["Donotuselocation"] != "" && parseBoolean(this.ScreenObject.Preferences["Donotuselocation"])))
                            this.ScreenObject.DivisionID = lst.SelectedValue;
                    }
                }
            }
        });
        this.ScreenObject._TextFields.forEach(txt => {
            val = xDoc.getDateByNodeName(xHeader, txt.DBColumnName);
            if (val != null)
                this.ScreenObject.fillcontrolValue(txt, val);
        });

        let colName;
        let xRows = xDoc.SelectNodes("XML/DataTable/Row")
        for (k = 0; k < xRows.length; k++) {
            if (this.ScreenObject.GridData.length - 1 <= k)
                this.ScreenObject.GridDataObj.addEmptyRow();

            let dr = this.ScreenObject.GridData[k];

            dr["DocSeqNo"] = (k + 1);

            for (i = 1; i < this.ScreenObject.GridDataColumns.length; i++) {
                colName = this.ScreenObject.GridDataColumns[i]
                val = xDoc.getDateByNodeName(xRows[k], colName);
                if (!Util.IsEmpty(val)) {
                    if (this.ScreenObject.GridDataObj.DataTypes.Date.Contains(colName)) {
                        if (Util.isValidDate(val))
                            dr[colName] = Util.ParseDate(val);
                    }
                    else {
                        if (val == "" && (this.ScreenObject.GridDataObj.DataTypes.Double.Contains(colName) || this.ScreenObject.GridDataObj.DataTypes.Int.Contains(colName))) {
                        }
                        else {
                            try {
                                if (!Util.IsEmpty(val) && val.Contains("FlowDocument"))
                                    val = xDoc.getNodeByName(xRows[k], colName).textContent
                                dr[colName] = val;
                            }
                            catch {
                                //Logger.ErrorLog("Line:" + (k + 1).toString() + " Name: " + this.ScreenObject.GridDataColumns[i] + ", DataType:" + this.ScreenObject.GridDataColumns[i].DataType.toString() + ",  xml:" + xNode.InnerText); 
                            }
                        }
                    }
                }
            }
            this.CalculateTotals(dr, false);
            this.ScreenObject.GridDataObj.updateRow(dr);
        }
        // this.ScreenObject.GridDataObj.refreshDataView();

        xRows = xDoc.SelectNodes("XML/FooterTable/Row");
        for (k = 0; k < xRows.length; k++) {
            if (this.ScreenObject.FooterGridData.length - 1 <= k)
                this.ScreenObject.FooterGridDataObj.addEmptyRow();

            let dr = this.ScreenObject.FooterGridData[k];
            val = xDoc.getDateByNodeName(xRows[k], "ColumnName");
            if (!Util.IsEmpty(val)) xRows[k]["ColumnName"] = val;

            this.FooterCellEditEnd("ColumnName", dr);

            val = xDoc.getDateByNodeName(xRows[k], "Amount");
            if (!Util.IsEmpty(val)) xRows[k]["Amount"] = val;

            val = xDoc.getDateByNodeName(xRows[k], "CalcAmount");
            if (!Util.IsEmpty(val)) xRows[k]["CalcAmount"] = val;

            val = xDoc.getDateByNodeName(xRows[k], "dcCurrID");
            if (!Util.IsEmpty(val)) xRows[k]["dcCurrID"] = val;

            val = xDoc.getDateByNodeName(xRows[k], "dcCurrID_Key");
            if (!Util.IsEmpty(val)) xRows[k]["dcCurrID_Key"] = val;

            val = xDoc.getDateByNodeName(xRows[k], "dcExchRT");
            if (!Util.IsEmpty(val)) xRows[k]["dcExchRT"] = val;
        }

        if (BaseService.SessionManager.Preferences.ContainsKey("DraftServerDate") && BaseService.SessionManager.Preferences["DraftServerDate"].toLowerCase() == "true") {
            if (this.fldDict != null && Util.isValidDate(this.fldDict["ServerDate"].fieldResult))
                this.DocumentDate = Util.ParseDate(this.fldDict["ServerDate"].fieldResult);
        }
        if (BaseService.SessionManager.Preferences.ContainsKey("DisableAutoLoad") && BaseService.SessionManager.Preferences["DisableAutoLoad"].toLowerCase() == "true")
            this.ScreenObject.FillListViews(false);
        this.CalculateTotals(null, false);
    }

    OpenCashDrawer(PortNo: string, Message: string) {
        if (this.ScreenObject.Preferences.ContainsKey("Select Port")
            && Util.String(this.ScreenObject.Preferences["Select Port"]).toLowerCase() == "true") {
            try {
                Logger.InfoLog("Message :" + Message + "   to Port NO:" + PortNo);
                /***
                using (System.IO.Ports.SerialPort sp = new System.IO.Ports.SerialPort())
                {
                    sp.PortName = PortNo;
                    sp.BaudRate = 9600;
                    sp.Parity = System.IO.Ports.Parity.None;
                    sp.DataBits = 8;
                    sp.StopBits = System.IO.Ports.StopBits.One;
                    sp.Open();
                    //    sp.Write("\x04\x01" + "C" + "\x32" + "\x17");
                    // sp.Write("CHR(12)");
                    sp.Write(Message);
                    sp.Close();
                    Logger.InfoLog("Message Sent successfully : ");
                }
                ***/
            }
            catch (error) {
                Logger.ErrorLog("Cash Drawer :: " + error.Message);
            }
        }
    }

    //#endregion

    //#region Budget

    private _BudgetObj: BudgetCheck = null;
    get BudgetObj(): BudgetCheck {
        if (this._BudgetObj == null)
            this._BudgetObj = new BudgetCheck(this);
        return this._BudgetObj;
    }

    BudgetValidation(XML: string) {
        if (this.ScreenObject.Data.Tables[5] != null && this.ScreenObject.Data.Columns[5].length > 0) {
            if (!this.ScreenObject.Preferences.ContainsKey("Check Budget")
                || this.ScreenObject.Preferences["Check Budget"] == "False"
                || BaseService.SessionManager.Preferences["Use Budget"] == "False"
                || this.ScreenObject.Data.Tables[5].filter(x => x.QtyBudget == 0).length == 0
                || (BaseService.SessionManager.LicenseSettings.ContainsKey("Budget") && BaseService.SessionManager.LicenseSettings["Budget"].toUpperCase() == "FALSE")
            ) {
                return;
            }
            this.BudgetObj.BudgetValidation(XML);
        }
    }

    ValidateBudget(Qty: number, outObj: any): string {//dim:string[], out long BudID, out DateTime BudStartDate, ref bool LineWiseBudget
        if (!this.ScreenObject.Preferences.ContainsKey("Check Budget")
            || this.ScreenObject.Preferences["Check Budget"] == "False"
            || BaseService.SessionManager.Preferences["Use Budget"] == "False"
            || (BaseService.SessionManager.LicenseSettings.ContainsKey("Budget") && BaseService.SessionManager.LicenseSettings["Budget"].toUpperCase() == "FALSE")
        ) {
            outObj.dim = null;
            outObj.BudID = 0;
            outObj.BudStartDate = new Date();
            return "";
        }
        //outObj.BudID=0, outObj.BudStartDate, outObj.LineWiseBudget
        return this.BudgetObj.ValidateBudget(Qty, outObj);
    }
    //#endregion

    SetVisibiltiFalse() {
        this.ImportVisiblity = false;
        this.ProductImageVisibility = false;
        /***    PosPayVisiblity = false;
            this.ProductSearchVisibility = false;
            this.QuickInfoVisibility = false;
            this.DQuickInfoVisibility = false;
            VoucherDefVisibility = false;
            AttachmentVisibility = false;
            NoteVisibility = false;
            ApproveVisibility = false;
            this.SuspendVisiblity = false;
            this.AssignVisibility = false;
            BounceVisibility = false;
            SearchVisibility = false;
            this.ReportInfoVisibility = false;
            ProductImageVisibility = false;
            this.ActVisibility = false;
            CaseVisibility = false;
            this.DocHistoryVisibility = false;
            ContactsVisibility = false;
            this.DependencyVisibility = false;
            this.VacCrDaysVisibility = false;
            this.MappedDocsVisibility = false;***/
        this.MappedDocsVisibility = false;
    }

    Dependencies() {
        if (this.SelectedRow == null)
            return;
        this.SetVisibiltiFalse();
        this.DependencyVisibility = true;
        this.RightTabSelectedIndex = 0;
        this.DependantText = Util.StringValue(this.SelectedRow["dcAlpha11"])

        let val = Util.StringValue(this.SelectedRow["Dependencies"]).toString().split(',');

        this.Dependflds.Items.Clear();

        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                if (this.ScreenObject.GridData[i] == this.SelectedRow)
                    continue;
                if (val.Contains(this.ScreenObject.GridData[i]["dcAlpha11"].toString()))
                    this.Dependflds.Items.push(CheckedListBoxItem.CheckedListBoxItem_6(this.ScreenObject.GridData[i]["dcAlpha11"].toString(), this.ScreenObject.GridData[i]["dcAlpha11"].toString(), true, 0));
                else
                    this.Dependflds.Items.push(CheckedListBoxItem.CheckedListBoxItem_6(this.ScreenObject.GridData[i]["dcAlpha11"].toString(), this.ScreenObject.GridData[i]["dcAlpha11"].toString(), false, 0));
            }
        }
    }
    AssignUsers() {
        if (this.SelectedRow == null)
            return;
        this.SetVisibiltiFalse();
        this.AssignVisibility = true;
        this.RightTabSelectedIndex = 0;
        if (this.AssignFields == null)
            this.AssignFields = new AssignReportViewModel(0, "", this);


        this.AssignFields.ReportName = Util.StringValue(this.SelectedRow["dcAlpha11"]);

        let Grps = "", usrs = "", rls = "";
        if (!Util.IsEmpty(this.SelectedRow["AssignXML"])) {
            //alert('check:AssigXML-38500')
            let xdoc = new XmlDocument();
            xdoc.LoadXml(this.SelectedRow["AssignXML"]);
            if (xdoc.DocumentElement.children.length > 0) {
                if (xdoc.DocumentElement.children[0].attributes["Groups"] != null && !Util.IsEmpty(xdoc.DocumentElement.children[0].attributes["Groups"].value))
                    Grps = xdoc.DocumentElement.children[0].attributes["Groups"].value;
                if (xdoc.DocumentElement.children[0].attributes["Roles"] != null && !Util.IsEmpty(xdoc.DocumentElement.children[0].attributes["Roles"].value))
                    rls = xdoc.DocumentElement.children[0].attributes["Roles"].value;
                if (xdoc.DocumentElement.children[0].attributes["Users"] != null && !Util.IsEmpty(xdoc.DocumentElement.children[0].attributes["Users"].value))
                    usrs = xdoc.DocumentElement.children[0].attributes["Users"].value;
            }
        }
        this.AssignFields.SetSelectedItems_2(this.AssignFields.Groups, Grps);
        this.AssignFields.SetSelectedItems_2(this.AssignFields.Roles, rls);
        this.AssignFields.SetSelectedItems_2(this.AssignFields.Users, usrs);

        BaseService.page.ShowDialog(this.AssignFields, AssignReportComponent, { HideClose: false, ShowCenter: true, Title: BaseService.GetResource("Assign") })

    }

    MultiAssignUsers()
    {
        let dsvm:DynamicSetViewModel = new DynamicSetViewModel(this, this.SelectedRow, null, 6);
        BaseService.page.ShowDialog(dsvm,DynamicSetComponent,{ShowCenter:true});
    }

    PoleDisplayMessage(Display: number, dr: any) {
        try {


            let Message = "";
            if (this.ScreenObject.Data.Tables.length > 18 && this.ScreenObject.Data.Tables[18].length > 0) {
                let drRow = this.ScreenObject.Data.Tables[18][0];
                if (this.ScreenObject.RegisterNodeID > 0) {
                    let drRows = this.ScreenObject.Data.Tables[18].filter(x => x.NodeID == this.ScreenObject.RegisterNodeID);
                    if (drRows.length > 0)
                        drRow = drRows[0];
                    else
                        return;
                }

                let xdoc: any = new XmlDocument();
                let xList: any = null;
                if (Display == 1 && !Util.IsEmpty(drRow["IdleMessageXML"])) {
                    xdoc.LoadXml(drRow["IdleMessageXML"]);
                    xList = xdoc.SelectNodes("IdleMessage/Rows");

                }
                else if (Display == 2 && !Util.IsEmpty(drRow["ProductScanXML"])) {
                    xdoc.LoadXml(drRow["ProductScanXML"]);
                    xList = xdoc.SelectNodes("ProductScan/Rows");

                }
                else if (Display == 3 && !Util.IsEmpty(drRow["BillPayXML"])) {
                    xdoc.LoadXml(drRow["BillPayXML"]);
                    xList = xdoc.SelectNodes("BillPay/Rows");

                }
                else if (Display == 4 && !Util.IsEmpty(drRow["OnExitXML"])) {
                    xdoc.LoadXml(drRow["OnExitXML"]);
                    xList = xdoc.SelectNodes("ExitXML/Rows");

                }
                if (xList != null && xList.length > 0) {
                    let ChPerline = 0, nooflines = 0;
                    if (!Util.IsEmpty(drRow["NoOfLines"]))
                        nooflines = parseInt(drRow["NoOfLines"]);
                    if (!Util.IsEmpty(drRow["CharactersPerLine"]))
                        ChPerline = parseInt(drRow["CharactersPerLine"]);
                    let lineNo = 1;

                    for (let i = 0; i < xList.length; i++) {
                        if (xList[i].attributes["LineNo"] != null && xList[i].attributes["LineNo"].value != "" && parseInt(xList[i].attributes["LineNo"].value) > nooflines)
                            continue;
                        let Data = "";

                        if (xList[i].attributes["FieldID"] != null && xList[i].attributes["FieldID"].value == "-1") {
                            if (xList[i].attributes["Data"] != null)
                                Data = xList[i].attributes["Data"].value;
                        }
                        else if (xList[i].attributes["FieldID"] != null && xList[i].attributes["FieldID"].value == "-2") {
                            Data = this.NetAmount;
                        }
                        else if (xList[i].attributes["FieldID"] != null && xList[i].attributes["FieldID"].value != "") {
                            let col = this.ScreenObject.ColumnSource.find(a => a.ID == xList[i].attributes["FieldID"].value);
                            if (dr != null && col) {
                                if (col.DataType == "FLOAT" && xList[i].attributes["Decimal"] != null && xList[i].attributes["Decimal"].value != "") {
                                    Data = parseFloat(dr[col.DisplayMember]).ToString("N" + xList[i].attributes["Decimal"].value);
                                }
                                else
                                    Data = dr[col.DisplayMember].toString();
                            }
                            else {
                                Data = this.GetHeaderData(xList[i].attributes["FieldID"].value);
                            }
                        }

                        let NCh = 0;
                        if (xList[i].attributes["NoOfCharacters"] != null && xList[i].attributes["NoOfCharacters"].value != "")
                            NCh = parseInt(xList[i].attributes["NoOfCharacters"].value);

                        let sbSpaces = "";
                        if (Data.length < NCh) {
                            for (let j = NCh - Data.length; j > 0; j--) {
                                sbSpaces += ' ';
                            }
                        }
                        else {
                            Data = Data.substr(0, NCh);
                        }
                        if (xList[i].attributes["Align"] != null && xList[i].attributes["Align"].value == "Left")
                            sbSpaces = sbSpaces.Insert(0, Data);
                        else
                            sbSpaces += Data;
                        Data = sbSpaces.toString();
                        if (xList[i].attributes["StartPosition"] != null && xList[i].attributes["StartPosition"].value != "" && parseInt(xList[i].attributes["StartPosition"].value) > 1) {
                            sbSpaces = "";
                            for (let j = 1; j < parseInt(xList[i].attributes["StartPosition"].value); j++) {
                                sbSpaces += ' ';
                            }
                            Data = sbSpaces.toString() + Data;
                        }

                        if (xList[i].attributes["LineNo"] != null && xList[i].attributes["LineNo"].value != "" && parseInt(xList[i].attributes["LineNo"].value) < lineNo) {
                            for (let n = lineNo; n < parseInt(xList[i].attributes["LineNo"].value); n++) {
                                sbSpaces = "";
                                for (let j = NCh; j < ChPerline; j++) {
                                    sbSpaces += ' ';
                                }
                                NCh = 0;
                                Message += sbSpaces.toString();
                            }
                        }
                        NCh += Data.length;
                        lineNo = parseInt(xList[i].attributes["LineNo"].value);
                        Message += Data;
                    }
                    this.OpenCashDrawer(drRow["PortName"].toString(), Message);
                }
            }
        }
        catch (Exception) {

        }
    }

    GetHeaderData(ColumnName: string): string {
        let tempint = Util.Int(ColumnName);
        if (tempint > 0) {
            let fld = this.ScreenObject._StaticFields.find(a => a.DBColumnID == tempint)
            if (!fld)
                fld = this.ScreenObject._TextFields.find(a => a.DBColumnID == tempint);
            if (!fld)
                fld = this.ScreenObject._CCFields.find(a => a.DBColumnID == tempint);
            if (!fld) {
                let drr = this.ScreenObject.Data.Tables[0].filter(x => x.CostCenterColID == tempint);
                if (drr.length > 0) {
                    ColumnName = drr[0]["SysColumnName"];
                    if (fld == null && this.ScreenObject.DocDate != null && ColumnName == "DocDate")
                        fld = this.ScreenObject.DocDate;

                    if (fld == null && this.ScreenObject.DocPrefix != null && ColumnName == "VoucheNo")
                        fld = this.ScreenObject.DocPrefix;

                    if (fld == null && this.ScreenObject.DueDate != null && ColumnName == "DueDate")
                        fld = this.ScreenObject.DueDate;

                    if (fld == null && this.ScreenObject.BillNo != null && ColumnName == "BillNo")
                        fld = this.ScreenObject.BillNo;
                }
            }
            if (fld)
                return this.GetFldName(fld);
        }
        return "";
    }

    GetFldName(fld: PactControlData): string {
        if (fld instanceof PactListBoxData && fld.SelectedValue > 0 && fld.Text != null)
            return fld.Text;
        else if (fld instanceof PactTextBoxData && fld.Text != null)
            return fld.Text;
        else if (fld instanceof PactComboBoxData && fld.Text != null)
            return fld.Text;
        else if (fld instanceof PactComboTextData && fld.ComboBox != null && fld.TextBox != null &&
            fld.TextBox.Text != null && fld.ComboBox.Text != null)
            return fld.ComboBox.Text + fld.TextBox.Text;
        else if (fld instanceof PactDatePickerData && fld.Date != null)
            return fld.Date.ToString(BaseService.SessionManager.Preferences["Date Format"]);
        return "";
    }

    GetMatchedIndex(StrText: string): number {
        let MatchIndex = 0;
        let xdoc;

        /////////
        if (!this.ScreenObject.Data.Columns[19].Contains("FldCnt"))
            this.ScreenObject.Data.Columns[19].push("FldCnt");

        let iFldCnt = 0;
        for (let j = 0; j < this.ScreenObject.Data.Tables[19].length; j++) {
            iFldCnt = 0;
            let BarcodeDef = this.ScreenObject.Data.Tables[19][j]["DefinitionXML"].toString();
            if (BarcodeDef.Trim() != "") {
                xdoc = new XmlDocument();
                xdoc.LoadXml(BarcodeDef);
                let xlist = xdoc.SelectNodes("Definition/Field");
                if (xlist != null && xlist.length > 0)
                    iFldCnt = xlist.length;
            }
            this.ScreenObject.Data.Tables[19][j]["FldCnt"] = iFldCnt;
        }
        let dvBL: any = Object.assign([], this.ScreenObject.Data.Tables[19]);

        dvBL = dvBL.sort((a, b) => b.FldCnt - a.FldCnt);//"FldCnt DESC";

        ///////////

        for (let j = 0; j < dvBL.length; j++) {
            let ActualText = StrText;
            let IsMatched = true;
            let BarcodeDef = dvBL[j]["DefinitionXML"].toString(), BarcodeProp = dvBL[j]["BarcodeXml"].toString();
            if (BarcodeProp != "") {
                xdoc = new XmlDocument();
                xdoc.LoadXml(BarcodeProp);

                let xnode = xdoc.SelectSingleNodeText("BarCodeBody/IsFixedBarcodeLength");
                if (xnode != null && xnode.toLowerCase() == "true") {
                    xnode = xdoc.SelectSingleNodeText("BarCodeBody/FixedBarcodeChar");
                    if (xnode != null && xnode.trim() != "") {
                        let c = xnode[0];
                        xnode = xdoc.SelectSingleNodeText("BarCodeBody/IsFixedBarcodePrefix");
                        if (xnode != null && xnode.trim() == "true") {
                            for (let i = 0; i < ActualText.length; i++) {
                                if (ActualText[i] == c) {
                                    ActualText = ActualText.Remove(0, 1);
                                    i--;
                                }
                                else
                                    break;
                            }
                        }
                        else {
                            for (let i = ActualText.length - 1; i >= 0; i--) {
                                if (ActualText[i] == c)
                                    ActualText = ActualText.Remove(ActualText.length - 1, 1);
                                else
                                    break;
                            }
                        }
                    }
                }

                xnode = xdoc.SelectSingleNodeText("BarCodeBody/IsExclude");
                if (xnode != null && xnode.toLowerCase() == "true") {
                    let c;
                    xnode = xdoc.SelectSingleNodeText("BarCodeBody/ExcludeChar");
                    if (xnode != null && xnode.trim() != "")
                        c = xnode[0];
                    else {
                        xnode = xdoc.SelectSingleNodeText("BarCodeBody/FixedBarcodeChar");
                        if (xnode != null && xnode.trim() != "")
                            c = xnode[0];
                        else
                            c = ' ';
                    }

                    xnode = xdoc.SelectSingleNode("BarCodeBody/IsExcludePrefix");
                    if (xnode != null && xnode.trim() == "true") {
                        for (let i = 0; i < ActualText.length; i++) {
                            if (ActualText[i] == c) {
                                ActualText = ActualText.Remove(0, 1);
                                i--;
                            }
                            else
                                break;
                        }
                    }
                    else {
                        for (let i = ActualText.length - 1; i >= 0; i--) {
                            if (ActualText[i] == c)
                                ActualText = ActualText.Remove(ActualText.length - 1, 1);
                            else
                                break;
                        }
                    }
                }

                xnode = xdoc.SelectSingleNodeText("BarCodeBody/IncludeChecksum");
                if (xnode != null && xnode.toLowerCase() == "true") {
                    ActualText = ActualText.Remove(ActualText.length - 1, 1);
                }
            }
            if (BarcodeDef != "") {
                xdoc = new XmlDocument();
                xdoc.LoadXml(BarcodeDef);
                let xlist = xdoc.SelectNodes("Definition/Field");
                for (let i = 0; i < xlist.length; i++) {
                    let dsource = "", syscolname = "", delimiter = "", tempstr = "";
                    let Width = 0, Decimals = 0, temp;

                    dsource = XmlDocument.SelectSingleNodeText(xlist[i], "DataSource");
                    syscolname = XmlDocument.SelectSingleNodeText(xlist[i], "SysColumn");
                    delimiter = XmlDocument.SelectSingleNodeText(xlist[i], "Delimiter");
                    tempstr = XmlDocument.SelectSingleNodeText(xlist[i], "Width");
                    if (tempstr.length > 0 && Util.IsNum(tempstr))
                        Width = parseInt(tempstr);
                    tempstr = XmlDocument.SelectSingleNodeText(xlist[i], "Decimals");
                    if (tempstr.length > 0 && Util.IsNum(tempstr))
                        Decimals = parseInt(tempstr);

                    tempstr = "";
                    if (Width == -1 && delimiter != "") {
                        let ind = ActualText.indexOf(delimiter);
                        if (ind > 0 && ind < ActualText.length) {
                            tempstr = ActualText.substr(0, ind);
                            ActualText = ActualText.Remove(0, ind);
                        }
                        else
                            IsMatched = false;
                    }
                    else if (Width != -1) {
                        if (ActualText.length >= Width) {
                            tempstr = ActualText.substr(0, Width);
                            ActualText = ActualText.Remove(0, Width);
                        }
                        else
                            IsMatched = false;
                    }
                    else if (Width == -1 && i == xlist.length - 1) {
                        tempstr = ActualText;
                        ActualText = "";
                    }

                    if (delimiter != "" && ActualText.length > delimiter.length)
                        ActualText = ActualText.Remove(0, delimiter.length);
                    else if (ActualText != "")
                        IsMatched = false;
                }
            }
            if (IsMatched) {
                MatchIndex = this.ScreenObject.Data.Tables[19].indexOf(dvBL[j]);
                break;
            }
        }
        return MatchIndex;
    }

    barcodeValues: Dictionary<string> = null;

    ReadBarcode(BarcodeDef: string, BarcodeProp: string, EditElment: any, dataRow: any, text: string, outPID: any) {
        outPID.PID = 0;

        if (EditElment != null && Util.IsEmpty(EditElment.Text))
            return false;
        let Matchedindex = 0;
        if (this.ScreenObject.Data.Tables[19].length > 1) {
            //Matchedindex = this.GetMatchedIndex(text, dataRow);
            if (EditElment != null)
                Matchedindex = this.GetMatchedIndex(EditElment.Text);
            else
                Matchedindex = this.GetMatchedIndex(text);
            BarcodeDef = this.ScreenObject.Data.Tables[19][Matchedindex]["DefinitionXML"].toString();
            BarcodeProp = this.ScreenObject.Data.Tables[19][Matchedindex]["BarcodeXml"].toString();
        }

        let prodexists = false;
        let countNO = 0;
        do {
            let ActualText = "";
            if (EditElment != null)
                ActualText = EditElment.Text;
            else
                ActualText = text;
            this.barcodeValues = new Dictionary<string>();
            let xml = "";

            if (BarcodeDef != "" || BarcodeProp != "") {
                let xdoc;
                if (BarcodeProp != "") {
                    xdoc = new XmlDocument();
                    xdoc.LoadXml(BarcodeProp);
                    let str = xdoc.SelectSingleNodeText("BarCodeBody/IsFixedBarcodeLength");
                    if (str != null && str.toLowerCase() == "true") {
                        str = xdoc.SelectSingleNodeText("BarCodeBody/FixedBarcodeChar");
                        if (str != null && str.trim() != "") {
                            let c = str[0];
                            str = xdoc.SelectSingleNodeText("BarCodeBody/IsFixedBarcodePrefix");
                            if (str != null && str.trim() == "true") {
                                for (let i = 0; i < ActualText.length; i++) {
                                    if (ActualText[i] == c) {
                                        ActualText = ActualText.Remove(0, 1);
                                        i--;
                                    }
                                    else
                                        break;
                                }
                            }
                            else {
                                for (let i = ActualText.length - 1; i >= 0; i--) {
                                    if (ActualText[i] == c)
                                        ActualText = ActualText.Remove(ActualText.length - 1, 1);
                                    else
                                        break;
                                }
                            }
                        }
                    }

                    str = xdoc.SelectSingleNodeText("BarCodeBody/IsExclude");
                    if (str != null && str.toLowerCase() == "true") {
                        let c;
                        str = xdoc.SelectSingleNodeText("BarCodeBody/ExcludeChar");
                        if (str != null && str.trim() != "")
                            c = str[0];
                        else {
                            str = xdoc.SelectSingleNodeText("BarCodeBody/FixedBarcodeChar");
                            if (str != null && str.trim() != "")
                                c = str[0];
                            else
                                c = ' ';
                        }

                        str = xdoc.SelectSingleNodeText("BarCodeBody/IsExcludePrefix");
                        if (str != null && str.trim() == "true") {
                            for (let i = 0; i < ActualText.length; i++) {
                                if (ActualText[i] == c) {
                                    ActualText = ActualText.Remove(0, 1);
                                    i--;
                                }
                                else
                                    break;
                            }
                        }
                        else {
                            for (let i = ActualText.length - 1; i >= 0; i--) {
                                if (ActualText[i] == c)
                                    ActualText = ActualText.Remove(ActualText.length - 1, 1);
                                else
                                    break;
                            }
                        }
                    }
                    str = xdoc.SelectSingleNodeText("BarCodeBody/IncludeChecksum");
                    if (str != null && str.toLowerCase() == "true") {
                        ActualText = ActualText.Remove(ActualText.length - 1, 1);
                    }
                }
                if (BarcodeDef != "") {
                    xdoc = new XmlDocument();
                    xdoc.LoadXml(BarcodeDef);
                    let xlist = xdoc.SelectNodes("Definition/Field");
                    for (let i = 0; i < xlist.length; i++) {
                        let dsource = "", syscolname = "", delimiter = "", tempstr = "", dformat = "";
                        let Width = 0, Decimals = 0, temp;
                        dsource = XmlDocument.SelectSingleNodeText(xlist[i], "DataSource");
                        syscolname = XmlDocument.SelectSingleNodeText(xlist[i], "SysColumn");
                        delimiter = XmlDocument.SelectSingleNodeText(xlist[i], "Delimiter");

                        tempstr = XmlDocument.SelectSingleNodeText(xlist[i], "Width");

                        if ((syscolname == "Batch_MfgDate" || syscolname == "Batch_ExpDate")
                            && tempstr.length > 0) {
                            dformat = tempstr;
                            Width = dformat.length;
                        }

                        if (tempstr.length > 0 && Util.IsNum(tempstr))
                            Width = parseInt(tempstr);
                        tempstr = XmlDocument.SelectSingleNodeText(xlist[i], "Decimals");
                        if (tempstr.length > 0 && Util.IsNum(tempstr))
                            Decimals = parseInt(tempstr);

                        tempstr = "";
                        if (Width == -1 && delimiter != "") {
                            let ind = ActualText.indexOf(delimiter);
                            if (ind > 0 && ind < ActualText.length) {
                                tempstr = ActualText.substr(0, ind);
                                ActualText = ActualText.Remove(0, ind);
                            }
                        }
                        else if (Width != -1 && ActualText.length >= Width) {
                            tempstr = ActualText.substr(0, Width);
                            ActualText = ActualText.Remove(0, Width);
                        }
                        else if (Width == -1 && i == xlist.length - 1) {
                            tempstr = ActualText;
                        }

                        if (delimiter != "" && ActualText.length > delimiter.length)
                            ActualText = ActualText.Remove(0, delimiter.length);
                        if (dsource == "Product" && tempstr != "") {
                            if (xml == "")
                                xml += "<XML>";
                            xml += "<Row CostcenterID=\"" + 3 + "\"";
                            xml += " syscolname=\"" + syscolname + "\"";
                            xml += " value=\"" + PactTextBoxData.GetValidTextXml(tempstr) + "\" />";
                        }
                        else if (dsource.startsWith("CC") && tempstr != "") {
                            let ccid = 50000;
                            ccid = ccid + parseInt(dsource.replace("CC", ""));
                            if (xml == "")
                                xml += "<XML>";
                            xml += "<Row CostcenterID=\"" + ccid + "\"";
                            xml += " syscolname=\"" + syscolname + "\"";
                            xml += " value=\"" + PactTextBoxData.GetValidTextXml(tempstr) + "\" />";
                        }
                        else if (dsource == "Document" && syscolname == "INVID" && tempstr != "") {
                            if (xml == "")
                                xml += "<XML>";
                            xml += "<Row CostcenterID=\"400\"";
                            xml += " syscolname=\"Inv_docDetailsID\"";
                            xml += " value=\"" + PactTextBoxData.GetValidTextXml(tempstr) + "\" />";
                            this.barcodeValues.push(syscolname, tempstr);
                        }
                        else if (dsource == "Document" && tempstr != "") {
                            if (dformat != '') {
                                let day = 0, yr = 0;;
                                let MM = '';
                                if (dformat.startsWith("YYYY"))
                                    MM = this.ScreenObject.GetMonthName(parseInt(tempstr.substr(4, 2)), false);
                                else if (dformat.startsWith("MM"))
                                    MM = this.ScreenObject.GetMonthName(parseInt(tempstr.substr(0, 2)), false);
                                else
                                    MM = this.ScreenObject.GetMonthName(parseInt(tempstr.substr(2, 2)), false);


                                if (dformat.startsWith("YYYY"))
                                    day = parseInt(tempstr.substr(6, 2));
                                else if (dformat.startsWith("DD"))
                                    day = parseInt(tempstr.substr(0, 2));
                                else
                                    day = parseInt(tempstr.substr(2, 2));

                                if (dformat.startsWith("YYYY"))
                                    yr = parseInt(tempstr.substr(0, 4));
                                else if (dformat.Contains("YYYY"))
                                    yr = parseInt(tempstr.substr(4, 4));
                                else
                                    yr = parseInt(tempstr.substr(4, 2));

                                this.barcodeValues.push(syscolname, day.toString() + "/" + MM + "/" + yr.toString());

                            }
                            else if (this.ScreenObject.GridDataColumns.Contains(syscolname)) {
                                if (this.ScreenObject.GridDataObj.DataTypes.Double.Contains(syscolname)) {
                                    if (Decimals > 0) {
                                        tempstr = tempstr.Insert(tempstr.length - Decimals, ".");
                                    }
                                    if (Util.IsNum(tempstr)) {
                                        if (dataRow != null)
                                            dataRow[syscolname] = tempstr;
                                        this.barcodeValues.push(syscolname, tempstr);
                                    }
                                }
                                else if (this.ScreenObject.GridDataObj.DataTypes.Int.Contains(syscolname)) {
                                    if (Util.IsNum(tempstr)) {
                                        if (dataRow != null)
                                            dataRow[syscolname] = tempstr;
                                        this.barcodeValues.push(syscolname, tempstr);
                                    }
                                }
                                else {
                                    if (dataRow != null)
                                        dataRow[syscolname] = tempstr;
                                    this.barcodeValues.push(syscolname, tempstr);
                                }
                            }
                            else {
                                if (Decimals > 0) {
                                    tempstr = tempstr.Insert(tempstr.length - Decimals, ".");
                                    this.barcodeValues.push(syscolname, tempstr);
                                }
                                else
                                    this.barcodeValues.push(syscolname, tempstr);
                            }
                        }
                        else if (dsource == "Document" && dataRow != null && (syscolname == "Batch_No" || syscolname == "Batch_Code") && tempstr != "") {
                            this.barcodeValues.push(syscolname, tempstr);
                        }
                    }
                }
                else {
                    xml += "<XML>";
                    xml += "<Row CostcenterID=\"" + 3 + "\"";
                    xml += " syscolname=\"" + "ProductCode" + "\"";
                    xml += " value=\"" + PactTextBoxData.GetValidXml(ActualText) + "\" />";
                }
            }

            let ds = null;
            if (xml != "") {
                xml += "</XML>";
                ds = BaseService.document.GetCCValues_xml(xml);
            }

            if (ds != null && ds.Tables.length > 0 && ds.Columns[0].Contains("CostCenterID")) {
                if (ds.Tables.length > 1 && ds.Tables[1].length > 0) {
                    for (let j = 0; j < ds.Tables[1].length; j++) {
                        let drrows = this.ScreenObject.GridData.filter(x => x.BOEID == ds.Tables[1][j]["InvDocDetailsID"]);
                        if (drrows.length > 0) {
                            if (!Util.IsEmpty(drrows[0]["UOMConvertedQty"]) && parseFloat(drrows[0]["UOMConvertedQty"]) < parseFloat(ds.Tables[1][j]["Qty"])) {
                                this.DisplayMessage = "Select Product in FIFO Order";
                                return false;
                            }
                        }
                        else {
                            this.DisplayMessage = "Select Product in FIFO Order";
                            return false;
                        }
                    }
                }

                for (let i = 0; i < ds.Tables[0].length; i++) {
                    let col = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == parseInt(ds.Tables[0][i]["CostCenterID"]));
                    if (col) {
                        if (dataRow != null) {
                            if (Util.IsEmpty(ds.Tables[0][i]["name"]))
                                dataRow[col.DisplayMember] = ds.Tables[0][i]["Name"].toString();
                            else
                                dataRow[col.DisplayMember] = ds.Tables[0][i]["name"].toString();

                            dataRow[col.ValueMember] = ds.Tables[0][i]["NODEID"].toString();
                            if (col.CostCenterID == 3) {
                                if (ds.Columns[0].Contains("VenderID")) {
                                    if (ds.Columns[0].Contains("barcodeid") && !Util.IsEmpty(ds.Tables[0][i]["barcodeid"]) && parseInt(ds.Tables[0][i]["barcodeid"]) > 0
                                        && this.ScreenObject.Preferences.ContainsKey("BarcodeDimension") && this.ScreenObject.Preferences["BarcodeDimension"] != "" && parseInt(this.ScreenObject.Preferences["BarcodeDimension"]) > 0) {
                                        let barcodecol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == parseInt(this.ScreenObject.Preferences["BarcodeDimension"]));
                                        if (barcodecol && !this.barcodeValues.ContainsKey(barcodecol.ValueMember)) {
                                            this.barcodeValues.push(barcodecol.ValueMember, ds.Tables[0][i]["barcodeid"].toString());
                                            this.barcodeValues.push(barcodecol.DisplayMember, ds.Tables[0][i]["ECode"].toString());
                                        }
                                    }

                                    if (ds.Columns[0].Contains("UnitID") && Util.Int(ds.Tables[0][i]["UnitID"]) > 0
                                        && !this.barcodeValues.ContainsKey("Unit_Key")) {
                                        this.barcodeValues.push("Unit_Key", ds.Tables[0][i]["UnitID"].toString());
                                        this.barcodeValues.push("Unit", ds.Tables[0][i]["UnitName"].toString());

                                        dataRow["Unit_Key"] = ds.Tables[0][i]["UnitID"].toString();
                                        dataRow["Unit"] = ds.Tables[0][i]["UnitName"].toString();
                                    }
                                    else if (ds.Columns[0].Contains("AccountCode") && !Util.IsEmpty(ds.Tables[0][i]["VenderID"]) && parseInt(ds.Tables[0][i]["VenderID"]) > 0) {
                                        let dvCnt = this.ScreenObject.Data.Tables[0];
                                        if (dvCnt.length > 0) {
                                            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LinkData == 53412);
                                            if (dvCnt.length > 0 && !this.barcodeValues.ContainsKey(dvCnt[0]["SysColumnName"])) {
                                                dataRow[dvCnt[0]["SysColumnName"]] = ds.Tables[0][i]["AccountCode"].toString();
                                                this.barcodeValues.push(dvCnt[0]["SysColumnName"], ds.Tables[0][i]["AccountCode"].toString());
                                            }

                                            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LinkData == 53413);
                                            if (dvCnt.length > 0 && !this.barcodeValues.ContainsKey(dvCnt[0]["SysColumnName"])) {
                                                dataRow[dvCnt[0]["SysColumnName"]] = ds.Tables[0][i]["AccountName"].toString();
                                                this.barcodeValues.push(dvCnt[0]["SysColumnName"], ds.Tables[0][i]["AccountName"].toString());
                                            }

                                            dvCnt = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LinkData == 50493);
                                            if (dvCnt.length > 0 && !this.barcodeValues.ContainsKey(dvCnt[0]["SysColumnName"])
                                                && ds.Columns[0].Contains("ECode")) {
                                                dataRow[dvCnt[0]["SysColumnName"]] = ds.Tables[0][i]["ECode"].toString();
                                                this.barcodeValues.push(dvCnt[0]["SysColumnName"], ds.Tables[0][i]["ECode"].toString());
                                            }
                                        }
                                    }
                                }
                                if (EditElment != null) {
                                    //Reserved Word - Scanned Barcode
                                    let drScanR = this.ScreenObject.Data.Tables[0].filter(x => x.LocalReference != null && x.LocalReference == 79 && x.LinkData == 7801);
                                    if (drScanR.length > 0 && this.ScreenObject.GridDataColumns.Contains(Util.String(drScanR[0]["SysColumnName"])))
                                        drScanR[Util.String(drScanR[0]["SysColumnName"])] = ActualText;
                                    EditElment.Text = ds.Tables[0][i]["Code"].toString();
                                    EditElment.SelectedValue = ds.Tables[0][i]["NODEID"].toString();
                                }
                                if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                    dataRow["ProductCode"] = ds.Tables[0][i]["Code"].toString();
                                if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                                    if (Util.IsEmpty(ds.Tables[0][i]["name"]))
                                        dataRow["ProductName"] = ds.Tables[0][i]["Name"].toString();
                                    else
                                        dataRow["ProductName"] = ds.Tables[0][i]["name"].toString();
                                if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key"))
                                    dataRow["ProductID_Key"] = ds.Tables[0][i]["NODEID"].toString();

                                if (!Util.IsEmpty(ds.Tables[0][i]["NODEID"]) && parseInt(ds.Tables[0][i]["NODEID"]) > 0)
                                    prodexists = true;

                            }
                        }
                        else if (!this.barcodeValues.ContainsKey(col.ValueMember))
                            this.barcodeValues.push(col.ValueMember, ds.Tables[0][i]["NODEID"].toString());
                    }
                }

                for (let i = 0; i < ds.Tables[0].length; i++) {
                    if (parseInt(ds.Tables[0][i]["CostCenterID"]) == 3 && !Util.IsEmpty(ds.Tables[0][i]["NODEID"]) && parseInt(ds.Tables[0][i]["NODEID"]) > 0) {
                        outPID.PID = parseInt(ds.Tables[0][i]["NODEID"]);
                        prodexists = true;
                    }
                }
            }

            if (!prodexists) {
                countNO++;
                if (this.ScreenObject.Data.Tables[19].length > countNO) {
                    Matchedindex++;
                    if (Matchedindex >= this.ScreenObject.Data.Tables[19].length)
                        Matchedindex = 0;
                    BarcodeDef = this.ScreenObject.Data.Tables[19][Matchedindex]["DefinitionXML"].toString();
                    BarcodeProp = this.ScreenObject.Data.Tables[19][Matchedindex]["BarcodeXml"].toString();
                }
            }

        } while (!prodexists && this.ScreenObject.Data.Tables[19].length > countNO);

        if (!prodexists && dataRow != null) {
            if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                dataRow["ProductCode"] = null;
            if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                dataRow["ProductName"] = null;
            if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key"))
                dataRow["ProductID_Key"] = null;
        }
        return prodexists;
    }

    async Export(DocSeqNo: number, OtherDocNos: string, ContinuousExportClubOtherDocs: boolean, iVersionNo: number = -1, IsPrint: boolean = false, isAutoAttach: boolean = false) {
        ;
        if (!isAutoAttach) {
            if (this.StatusID == 376 && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Print/Export Cancelled")) {
                this.DisplayMessage = "Documents is cancelled";
                return;
            }
            if (this.StatusID == 371 && this.DoNotPrintUnApprovedDocuments) {
                this.DisplayMessage = "Un-Approved documents not allowed to export";
                return;
            }
            if (this.StatusID == 371 && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Print/Export Un-Approved")) {
                this.DisplayMessage = "Un-Approved documents not allowed to export";
                return;
            }
            if (this.StatusID == 441 && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Print/Export Approved")) {
                this.DisplayMessage = "Approved documents not allowed to export";
                return;
            }
            if (this.StatusID == 372 && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Print/Export Rejected")) {
                this.DisplayMessage = "Rejected documents not allowed to export";
                return;
            }
        }
        let drPrintLayout = null;
        const { VoucherExportExcel } = await import('../../reports/vpt/VoucherExportExcel');
        const { VPTDialogViewModel } = await import('../../reports/vptdialog/VPTDialogViewModel');
        const { VPTDialogComponent } = await import('../../reports/vptdialog/vptdialog.component');
        let dsLayout = VoucherExportExcel.GetLocationPrintLayouts(this.DocumentID, 0, DocSeqNo, 4)
        {
            if (dsLayout == null || dsLayout.Tables[0].length == 0) {
                this.DisplayMessage = BaseService.GetResource("Err_PrintLayoutNotDefined");
            }

            this.sDSCUserName = "";
            this.bDSExists = false;
            this.oDSImg = null;

            let oVoucherPrintDialog = new VPTDialogViewModel(dsLayout.Tables[0], !IsPrint, false);

            if (!isAutoAttach) {
                BaseService.page.ShowDialog(oVoucherPrintDialog, VPTDialogComponent, { ShowCenter: true, NoWidth: true }).subscribe(() => {
                    if (oVoucherPrintDialog.IsOkClicked) {
                        drPrintLayout = oVoucherPrintDialog.SelectedRow;
                        //  this.bDSExists = oVoucherPrintDialog.bDSExists;
                        this.sDSCUserName = oVoucherPrintDialog.sDSCUserName;
                        //  this.oDSImg = oVoucherPrintDialog.oDSImg;
                    }

                    if (drPrintLayout != null) {
                        let param = new Dictionary<any>();
                        param.push("SaveFileName", this.ScreenObject.VoucherNo);
                        param.push("ContinuousExportClubOtherDocs", ContinuousExportClubOtherDocs ? "1" : "0");

                        let arrSeqNos: string[] = [DocSeqNo.toString()];
                        if (!ContinuousExportClubOtherDocs && !Util.IsEmpty(OtherDocNos)) {
                            arrSeqNos.AddRange(OtherDocNos.split(','));
                            OtherDocNos = null;
                        }
                        param.push("OtherDocNos", OtherDocNos);

                        let ExportType = oVoucherPrintDialog.IsExcelChecked ? "EXCEL" : "PDF";

                        /*if (BaseService.SessionManager.IsExportPDFWithPrintOption)
                        {
                            this.DisplayMessage = this.PrintVoucher(false, this.ScreenObject.DocID.toString(), true, null, iVersionNo, drPrintLayout, true);
                            if (this.DisplayMessage.Length == 0 && oPrint != null)
                            {
                                let sXpsFile = oPrint.Document.PrinterSettings.PrintFileName;
                                let sPdfFile = sXpsFile.Replace(".xps", ".pdf");
                                
                                using (FileStream fs = File.Open(sXpsFile, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
                                {
                                    using (PdfSharp.Xps.XpsModel.XpsDocument xpdoc = PdfSharp.Xps.XpsModel.XpsDocument.Open(fs))
                                    {
                                        PdfSharp.Xps.XpsConverter.Convert(xpdoc, sPdfFile, 0);
                                    }
                                    fs.Dispose();
                                }
                                FileName = sPdfFile;
    
                                try
                                {
                                    if (File.Exists(sXpsFile))
                                        File.Delete(sXpsFile);
                                }
                                catch(error)
                                {
                                    Logger.ErrorLog("XPS File Delete ERROR : " + ex.Message);
                                }
                            }
                        }
                        else*/
                        {
                            arrSeqNos.forEach(seqno => {
                                BaseService.report.ExportVPT(this.CostCenterID, seqno, parseInt(drPrintLayout["DocPrintLayoutID"]), ExportType, this.IsInventoryVoucher, param).subscribe(
                                    (response: any) => {
                                        console.log(response)
                                        if (IsPrint) {
                                            BaseService.SessionManager.printTab(response.FileName);
                                            if (Util.IsEmpty(response.Message) && !Util.IsEmpty(response.FileName))
                                                this.DisplayMessage = "Error in Print";
                                        }
                                        else if (!isAutoAttach) {
                                            BaseService.SessionManager.Download(response.FileName, "abcd" + seqno)
                                            if (Util.IsEmpty(response.Message) && !Util.IsEmpty(response.FileName))
                                                this.DisplayMessage = "Exported Successfully";
                                        }
                                        BaseService.common.setAuditPrint(4, this.CostCenterID, this.DocID, drPrintLayout["DocPrintLayoutID"], 3, ExportType);
                                    },
                                    (error) => {
                                        console.log(error);
                                        if (error.error != undefined && !Util.IsEmpty(error.error.Message))
                                            this.DisplayMessage = error.error.Message;
                                    }
                                );
                            });
                        }
                    }
                });
            }
            else {
                drPrintLayout = dsLayout.Tables[0][0];
                if (drPrintLayout != null) {
                    let param = new Dictionary<any>();
                    param.push("SaveFileName", this.ScreenObject.VoucherNo);
                    param.push("ContinuousExportClubOtherDocs", ContinuousExportClubOtherDocs ? "1" : "0");

                    let arrSeqNos: string[] = [DocSeqNo.toString()];
                    if (!ContinuousExportClubOtherDocs && !Util.IsEmpty(OtherDocNos)) {
                        arrSeqNos.AddRange(OtherDocNos.split(','));
                        OtherDocNos = null;
                    }
                    param.push("OtherDocNos", OtherDocNos);

                    let ExportType = oVoucherPrintDialog.IsExcelChecked ? "EXCEL" : "PDF";
                    {
                        arrSeqNos.forEach(seqno => {
                            BaseService.report.ExportVPT(this.CostCenterID, seqno, parseInt(drPrintLayout["DocPrintLayoutID"]), ExportType, this.IsInventoryVoucher, param, '', isAutoAttach).subscribe(
                                (response: any) => {
                                    console.log(response)
                                    if (IsPrint) {
                                        BaseService.SessionManager.printTab(response.FileName);
                                        if (Util.IsEmpty(response.Message) && !Util.IsEmpty(response.FileName))
                                            this.DisplayMessage = "Error in Print";
                                    }
                                    else if (!isAutoAttach) {
                                        BaseService.SessionManager.Download(response.FileName, "abcd" + seqno)
                                        if (Util.IsEmpty(response.Message) && !Util.IsEmpty(response.FileName)) {
                                            this.DisplayMessage = "Exported Successfully";
                                        }
                                    }
                                    BaseService.common.setAuditPrint(4, this.CostCenterID, this.DocID, drPrintLayout["DocPrintLayoutID"], 3, ExportType);
                                },
                                (error) => {
                                    console.log(error);
                                    if (error.error != undefined && !Util.IsEmpty(error.error.Message))
                                        this.DisplayMessage = error.error.Message;
                                }
                            );
                        });


                    }
                }
            }
        }
    }

    importWorker_DoWork(sender: any, e: any) {
        this.FailedRecourdList.Clear();
        //let dts: any=[];//Dictionary<int, DataTable> dts = new Dictionary<int, DataTable>();
        let dts: any = null;
        let drrows: any[];
        let drprds = null;
        dts = new Dictionary<any>()
        let sNames: string = '';
        let sFieldName: string = ''
        let sFeatureFieldName: string = '';
        let iDimensionIndex: number = -1;
        let iDefProductID: number = 0;
        let IsProductFromExcel: boolean = false;
        //Sajid
        let dsLinkDeFID: any = null;
        let CCColIDs = "";
        //#region "Reset Dimension Column Index"
        if (this.IsInventoryVoucher) {
            let ImportExtraCols: any = this.ImportCols[1].ComboData;
            for (let l = 0; l < ImportExtraCols.length; l++) {
                if (!Util.IsEmpty(ImportExtraCols[l].Aliasname) && ImportExtraCols[l].Aliasname.toLowerCase() == "productid") {
                    if (iDefProductID == 0)
                        iDefProductID = !Util.IsEmpty(ImportExtraCols[l].Parent) ? parseInt(ImportExtraCols[l].Parent) : 0;

                    for (let r = 0; r < this.DtImport.length; r++) {
                        if (Util.String(this.DtImport[r]["FeatureFieldName"]) == ImportExtraCols[l].Value.toString()) {
                            IsProductFromExcel = true;
                            iDefProductID = 0;
                            iDimensionIndex = r;
                            sFieldName = this.DtImport[r]["FieldName"].toString();
                            sFeatureFieldName = this.DtImport[r]["FeatureFieldName"].toString();

                            if (iDimensionIndex > 0) {
                                this.DtImport.RemoveAt(iDimensionIndex);
                                if (!Util.IsEmpty(sFieldName)) {
                                    let drName = this.DtImportObj.NewRow();
                                    drName["FieldName"] = sFieldName;
                                    drName["FeatureFieldName"] = sFeatureFieldName;
                                    this.DtImportObj.insertRowAt(drName, 0);
                                    this.DtImportObj.updateRow(drName);
                                    sFieldName = sFeatureFieldName = "";
                                }

                            }
                            break;
                        }
                    }
                }
            }

            if (!IsProductFromExcel && iDefProductID == 0) {
                this.DisplayMessage = "No defalut product exists, Please map the default product";
                this.MessageVisibility = true;
                return;
            }
            else if (!IsProductFromExcel && iDefProductID > 0) {
                let dtDefprds: any = BaseService.document.GetCCValues(iDefProductID.toString(), 3, 2, "", this.ImportIsBarcode);
                if (dtDefprds != null && dtDefprds.length > 0)
                    dts.push(3, dtDefprds);
                else {
                    this.DisplayMessage = "No data exists for default ProductID, Please check";
                    this.MessageVisibility = true;
                    return;
                }
            }
        }
        //#endregion

        if (this.ImportCopyLinkFields) {
            for (let l = 0; l < this.DtImport.length; l++) {
                if (Util.IsEmpty(CCColIDs))
                    CCColIDs = this.DtImport[l]["FeatureFieldName"].toString();
                else {
                    if (CCColIDs != '')
                        CCColIDs += ",";
                    CCColIDs += this.DtImport[l]["FeatureFieldName"].toString();
                }
            }
        }
        //

        for (let i = 0; i < this.DtImport.length; i++) {//i=0 contain columns in excel
            let row: any = this.DtImport[i];
            let ColIndex = this.ExcelDataColumn.indexOf(row.FieldName);
            if (Util.IsEmpty(row["FeatureFieldName"]) || Util.StringValue(row["FeatureFieldName"]) == "0")
                //if (row[1].toString() == "" || row[1].toString() == "0")
                continue;
            var col = this.ScreenObject.ColumnSource.find(a => a.ID == row["FeatureFieldName"].toString());
            //CC
            if (col == null)
                col = this.ScreenObject.ColumnSource.find(a => "-" + a.ID == row["FeatureFieldName"].toString());
            //CC
            //  if (col != null && col.DataType == "LISTBOX" && !Util.IsEmpty(dts.Contains(col.CostCenterID))) {
            if (col != null && col.DataType == "LISTBOX" && (!Util.IsEmpty(dts.ContainsKey(col.CostCenterID)) || (Util.IsEmpty(dts.ContainsKey(col.CostCenterID)) && col.DisplayMember.toLowerCase().Contains("dcalpha")))) {
                let iscode: boolean = false;
                if (col.DisplayMember.toLowerCase().Contains("code") || (BaseService.SessionManager.Preferences.ContainsKey("POSItemCodeDimension") && this.IsInventoryVoucher && col.CostCenterID.toString() == BaseService.SessionManager.Preferences["POSItemCodeDimension"]))
                    iscode = true;

                let UnqDim: number = this.ScreenObject.GetUniqueDimension(col.CostCenterID, iscode);

                if (UnqDim > 50000) {
                    let UniqColID: number = 0;
                    var unqcol = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == UnqDim);
                    if (unqcol != null && !Util.IsEmpty(unqcol.ID)) {
                        UniqColID = parseInt(unqcol.ID);
                    }
                    else {
                        var fld = this.ScreenObject._CCFields.find(a => a instanceof PactListBoxData && a.CCID == UnqDim);
                        if (fld != null)
                            UniqColID = fld.DBColumnID;
                    }

                    if (UniqColID > 0) {
                        let unqrow = this.DtImport.filter(x => x.FeatureFieldName == "'" + UniqColID + "'");

                        if (unqrow.length > 0) {
                            if (!dts.ContainsKey(UnqDim)) {
                                let Names: string = '';
                                //IMPORT_STATUS
                                if (!this.ExcelDataColumn.Contains("IMPORT_STATUS"))
                                    this.ExcelDataColumn.push("IMPORT_STATUS");
                                if (!this.ExcelDataColumn.Contains("xIMP_STATUSx"))
                                    this.ExcelDataColumn.push("xIMP_STATUSx");
                                if (!this.ExcelDataColumn.Contains("IMPORT_MESSAGE"))
                                    this.ExcelDataColumn.push("IMPORT_MESSAGE");
                                for (let j = 0; j < this.ExcelTable.length; j++) {
                                    if (this.ExcelTable[j][unqrow[0][0].toString()].toString().Trim().Replace("'", "''") == '')
                                        continue;
                                    if (Names != '')
                                        Names += ",";
                                    Names += "'" + this.ExcelTable[j][unqrow[0][0].toString()].toString().Trim().Replace("'", "''") + "'";
                                }
                                let dtDims = BaseService.document.GetCCValues(Names, UnqDim, 0);
                                dts.push(UnqDim, dtDims);
                            }

                            if (!this.ExcelDataColumn.Contains("UniqDim"))
                                this.ExcelDataColumn.push("UniqDim");

                            let Codes: string = '';

                            for (let j = 0; j < this.ExcelTable.length; j++) {
                                drrows = dts[UnqDim].filter(x => x.Name == this.ExcelTable[j][unqrow[0][0].toString()].toString().Trim().Replace("'", "''"));

                                if (drrows.length > 0) {
                                    if (Codes != '')
                                        Codes += " or ";

                                    if (col.CostCenterID == 3)
                                        Codes += " (" + ((iscode) ? "ProductCode" : "ProductName") + "='" + this.ExcelTable[j][row[0].toString()].toString().Trim().Replace("'", "''") + "' and ccnid" + (UnqDim - 50000) + "=" + drrows[0]["ID"].toString() + ")";
                                    else if (col.CostCenterID == 2)
                                        Codes += " (" + ((iscode) ? "AccountCode" : "AccountName") + "='" + this.ExcelTable[j][row[0].toString()].toString().Trim().Replace("'", "''") + "' and ccnid" + (UnqDim - 50000) + "=" + drrows[0]["ID"].toString() + ")";
                                    else if (col.CostCenterID > 50000)
                                        Codes += " (" + ((iscode) ? "Code" : "Name") + "='" + this.ExcelTable[j][row[0].toString()].toString().Trim().Replace("'", "''") + "' and ccnid" + (UnqDim - 50000) + "=" + drrows[0]["ID"].toString() + ")";

                                    this.ExcelTable[j]["UniqDim"] = drrows[0]["ID"].toString();
                                }
                            }

                            if (Codes != '') {
                                let dtprds: any = BaseService.document.GetCCValues_string(Codes, col.CostCenterID, "ccnid" + (UnqDim - 50000));
                                // dts.push(col.CostCenterID, dtprds);                              
                                dts.push(col.CostCenterID, dtprds);
                            }

                        }
                    }
                    else {
                        this.DisplayMessage = "Define Unique dimension column";
                        this.MessageVisibility = true;
                        return;
                    }
                }
                else {
                    let Names: string = '';
                    sNames = '';
                    for (let j = 0; j < this.ExcelTable.length; j++) {
                        //for (let j = 1; j < this.ExcelTable.length; j++) {
                        if (this.ExcelTable[j][ColIndex].toString().Trim().Replace("'", "''") == '')
                            continue;
                        if (Names != '')
                            Names += ",";
                        Names += "'" + this.ExcelTable[j][ColIndex].toString().Trim().Replace("'", "''") + "'";

                        if (sNames != '')
                            sNames += ",";
                        sNames += "" + this.ExcelTable[j][ColIndex].toString().Trim().Replace("'", "''") + "";
                        //this.ExcelTable[j][row[0].toString()].toString().Trim().Replace("'", "''") + "'";
                    }
                    if (col.ValueMember == "CreditAccount_Key" || col.ValueMember == "DebitAccount_Key") {
                        let nextcol: DgColumn;
                        if (col.ValueMember == "CreditAccount_Key")
                            nextcol = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.ValueMember) && a.ValueMember == "DebitAccount_Key");
                        else
                            nextcol = this.ScreenObject.ColumnSource.find(a => !Util.IsEmpty(a.ValueMember) && a.ValueMember == "CreditAccount_Key");
                        if (nextcol != null) {
                            let drnext = this.DtImport.filter(x => x.FeatureFieldName == nextcol.ID);
                            if (drnext.length > 0) {
                                for (let j = 0; j < this.ExcelTable.length; j++) {
                                    if (this.ExcelTable[j][drnext[0][0].toString()].toString().Trim().Replace("'", "''") == '')
                                        continue;
                                    if (Names != '')
                                        Names += ",";
                                    Names += "'" + this.ExcelTable[j][drnext[0][0].toString()].toString().Trim().Replace("'", "''") + "'";

                                    if (sNames != '')
                                        sNames += ",";
                                    sNames += "" + this.ExcelTable[j][drnext[0][0].toString()].toString().Trim().Replace("'", "''") + "";
                                }
                            }
                        }
                    }
                    if (Names.Contains('&')) {
                        Names = Names.Replace('&', '~');
                    }
                    let dtprds = BaseService.document.GetCCValues(Names, col.CostCenterID, ((iscode) ? 1 : 0), ((col.ValueMember == "CreditAccount_Key" || col.ValueMember == "DebitAccount_Key") ? " and IsGroup=0 " : ""), this.ImportIsBarcode);
                    //#region "Import Missing Names"
                    if (this.ImportMissingNames && !Util.StringIsNullOrEmpty(sNames)) {
                        let IsExists: boolean = false;
                        let sb: string = '';
                        let arrNames: string[] = sNames.split(',');
                        if (col.CostCenterID == 2 || col.CostCenterID == 3 || col.CostCenterID > 50000) {
                            if (arrNames.length > 0) {
                                for (let r = 0; r < arrNames.length; r++) {
                                    IsExists = false;
                                    for (let h = 0; h < dtprds.Tables[0].length; h++) {
                                        if (arrNames[r].toString() == dtprds.Tables[0][h]["name"].toString() || arrNames[r].toString() == dtprds.Tables[0][h]["Code"].toString()) {
                                            IsExists = true;
                                            break;
                                        }
                                    }

                                    if (!IsExists) {
                                        sb += "<Row ";
                                        sb += " ProductCode ='" + arrNames[r].toString() + "'  ";
                                        sb += " ProductName ='" + arrNames[r].toString() + "'  ";
                                        sb += "></Row>";
                                    }
                                }
                            }
                            if (sb.toString() != "") {

                                sb = "<XML>" + sb.toString();
                                sb += "</XML>";
                                let dsMissingNames: any = BaseService.document.GetCostCenterMissingNames(sb, col.CostCenterID, iscode);
                                let dtMissingNames: any;
                                if (dsMissingNames.Tables.length > 0)
                                    dtMissingNames = dsMissingNames.Tables[dsMissingNames.Tables.length - 1];
                                if (dtMissingNames != null && dtMissingNames.length > 0) {
                                    //if (ds.Tables.length > 0 && ds.Columns[0].Contains("SchemeID"))
                                    //this.fillSchemevalues(this.DtTempSchemes, ds.Tables[0], drGrid);
                                    sb = '';
                                    let RowIndex: number = dtprds.length;
                                    let drName: any = null;
                                    for (let r = 0; r < dtMissingNames.length; r++) {
                                        RowIndex++;
                                        //  drName  = dtprds.NewRow();
                                        drName = {};

                                        drName["ID"] = parseInt(dtMissingNames[r]["ID"]);
                                        drName["Code"] = dtMissingNames[r]["Code"].toString();
                                        drName["name"] = dtMissingNames[r]["name"].toString();
                                        dtprds.Tables[0].push(drName);

                                        sb += "<Row ";
                                        sb += " NodeID ='" + dtMissingNames[r]["ID"].toString() + "'  ";
                                        sb += "></Row>";
                                    }
                                    if (sb.toString() != "") {
                                        sb = "<XML>" + sb.toString();
                                        sb += "</XML>";
                                        let dsUpdateExtraFields: any = BaseService.document.FillCCDefaultValues(sb.toString(), col.CostCenterID, 0);
                                        let dtUpdateExtraFields: any;
                                        if (dsUpdateExtraFields.Tables.length > 0)
                                            dtUpdateExtraFields = dsUpdateExtraFields.Tables[0];
                                    }
                                }
                            }
                        }
                    }
                    //#endregion
                    if (dts.ContainsKey(col.CostCenterID)) {
                        let drr1: any = null;
                        for (let p = 0; p < dtprds.Tables[0].length; p++) {
                            drr1 = {};
                            drr1[dts[col.CostCenterID].Columns[0][0]] = dtprds.Tables[0][p][dtprds.Columns[0][0]];
                            drr1[dts[col.CostCenterID].Columns[0][1]] = dtprds.Tables[0][p][dtprds.Columns[0][1]];
                            drr1[dts[col.CostCenterID].Columns[0][2]] = dtprds.Tables[0][p][dtprds.Columns[0][2]];
                            dts[col.CostCenterID].Tables[0].push(drr1);
                        }
                    }
                    else
                        dts.push(col.CostCenterID, dtprds);
                }
            }
            else if (col != null && col.DataType == "LINK" && col.DisplayMember.toLowerCase() == "refno")// && !dts.ContainsKey(400) && dts.ContainsKey(3))
            {
                let Vnos: string = '';
                let RefSnos: string = '';
                let PIDS: string = '';
                for (let k = 0; k < this.ExcelTable.length; k++) {
                    if (Vnos != '')
                        Vnos += ",";
                    Vnos += "'" + this.ExcelTable[k][ColIndex].toString() + "'";
                }

                let Drow = this.DtImport.filter(x => x.FeatureFieldName == '-501');
                if (Drow.length > 0 && this.ScreenObject.Preferences.ContainsKey("SnoBasedLinking") && this.ScreenObject.Preferences["SnoBasedLinking"] != "" && parseBoolean(this.ScreenObject.Preferences["SnoBasedLinking"]) && !dts.ContainsKey(400)) {
                    PIDS = RefSnos = "";
                    for (let r = 0; r < this.ExcelTable.length; r++) {
                        if (RefSnos != '')
                            RefSnos += ",";
                        RefSnos += "'" + this.ExcelTable[r][1] + "'";
                    }
                }
                else if (!dts.ContainsKey(400) && dts.ContainsKey(3)) {
                    for (let r = 0; r < dts[3].length; r++) {
                        if (PIDS != '')
                            PIDS += ",";
                        PIDS += dts[3][r]["ID"].toString();
                    }
                }

                dsLinkDeFID = this.ScreenObject.GetLinkDefDetails(this.CostCenterID, 0, Vnos, PIDS, RefSnos, CCColIDs);
                if (dsLinkDeFID != null && dsLinkDeFID.Tables.length > 0)
                    dts.push(400, dsLinkDeFID.Tables[0]);
                if (dsLinkDeFID != null && dsLinkDeFID.Tables.length > 4)
                    dts.push(43, dsLinkDeFID.Tables[5]);
            }
        }

        let drGrid: any = null;
        let RowPos: number = 0;
        for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
            if (((this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && Util.String(this.ScreenObject.GridData[k]["ProductID_Key"]) == "")
                || (this.ScreenObject.GridDataColumns.Contains("DebitAccount_Key") && Util.String(this.ScreenObject.GridData[k]["DebitAccount_Key"]) == "")
                || (this.ScreenObject.GridDataColumns.Contains("CreditAccount_Key") && Util.String(this.ScreenObject.GridData[k]["CreditAccount_Key"]) == ""))) {
                RowPos = k;
                break;
            }
        }
        //FOR DEFAULT PRODUCTID
        //let drCL: any[] = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
        /***MessageBlinkDialog ImportStatus = new MessageBlinkDialog();***/
        let ImportStatus;
        let schemes: boolean = false;
        if (this.ScreenObject.Preferences.ContainsKey("EnableSchemes") && parseBoolean(this.ScreenObject.Preferences["EnableSchemes"]))
            schemes = parseBoolean(this.ScreenObject.Preferences["EnableSchemes"]);

        let ChunkSize = 5;
        ChunkSize = Util.IntTryParse(this.ImportChunkSize)
        if (ChunkSize < 1)
            ChunkSize = 5;

        if (this.IsInventoryVoucher && this.ImportCopyProductdata)
            this.iprodDics = new Dictionary<any>();
        if (this.IsInventoryVoucher && this.ImportCopyProductdata)
            this.ScreenObject.iprodRefDics = new Dictionary<any>();

        let Flag: boolean = true;
        for (let i = 0; i < this.ExcelTable.length; i++) {
            drGrid = null;
            if (i % ChunkSize == 0) {
                this.DisplayMessage = "Importing   " + (i + 1).toString() + " of " + this.ExcelTable.length;
                /***ImportStatus.ShowMessage(this.DisplayMessage);***/
                //IMPORT_STATUS
                // if (this.ExcelDataColumn.Contains("IMPORT_STATUS")) {
                if (this.ExcelDataColumn.Contains("IMPORT_STATUS")) {
                    this.ExcelTable[i]["xIMP_STATUSx"] = "PASS";
                    this.ExcelTable[i]["IMPORT_MESSAGE"] = "";
                }
            }
            for (let colindex = 0; colindex < this.DtImport.length; colindex++) {
                let row: any = this.DtImport[colindex];
                let index = this.ExcelDataColumn.indexOf(row.FieldName);
                //if (row[1].toString() == "" || row[1].toString() == "0")
                if (Util.IsEmpty(row["FeatureFieldName"]) || Util.String(row["FeatureFieldName"]) == "0")
                    continue;
                let col: DgColumn = null;
                if (row["FeatureFieldName"].toString() == "100" && this.ImportIsUpdate && drGrid == null) {
                    //this.ExcelTable[i][0].toString().Trim().Replace("'", "''") + "'";
                    drprds = this.ScreenObject.GridData.filter(x => x.DocSeqNo == Util.String(this.ExcelTable[i][index]).Trim().Replace("'", "''") + "'");
                    if (drprds.length > 0)
                        drGrid = drprds[0];
                }
                else
                    col = this.ScreenObject.ColumnSource.find(a => a.ID == row["FeatureFieldName"].toString());
                //CC
                if (col == null)
                    col = this.ScreenObject.ColumnSource.find(a => "-" + a.ID == row["FeatureFieldName"].toString());
                //CC
                if (col != null) {

                    if (!IsProductFromExcel && iDefProductID != 0) {
                        if (drGrid == null) {
                            if (this.ScreenObject.DocumentType == 81 && Flag) {
                                this.ScreenObject.GridDataObj.Clear();
                                Flag = false;
                            }
                            drGrid = this.ScreenObject.GridDataObj.NewRow();
                            this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPos);
                            RowPos++;

                            //if (drCL.length > 0 && Convert.ToString(drCL[0]["UserDefaultValue"]) != "")
                            //{
                            drGrid["ProductID_Key"] = iDefProductID;// drCL[0]["UserDefaultValue"];
                            //}
                            if (this.ScreenObject.DocumentType != 67 && this.ScreenObject.DocumentType != 68 && this.ScreenObject.DocumentType != 79
                                && this.ScreenObject.DocumentType != 81 && this.ScreenObject.DocumentType != 89 && this.ScreenObject.DocumentType != 90) {
                                drrows = dts[3].filter(x => x.ID == iDefProductID);
                                if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                    drGrid["ProductCode"] = drrows[0]["Code"];
                                if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                                    drGrid["ProductName"] = drrows[0]["name"];
                                this.ProdID = 0;
                                this.AddProductData(drGrid, false, true);
                            }
                        }
                    }
                    // if (this.ScreenObject.DocumentType == 67) {
                    //     if (drGrid == null) {
                    //         drGrid = this.ScreenObject.GridDataObj.NewRow();
                    //         this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPos);
                    //         RowPos++;

                    //         if (drCL.length > 0 && Util.StringValue(drCL[0]["UserDefaultValue"]) != "") {
                    //             drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                    //         }
                    //     }
                    // }

                    // if (this.ScreenObject.DocumentType == 81) {
                    //     if (drGrid == null) {
                    //         if (Flag) {
                    //             this.ScreenObject.GridDataObj.Clear();
                    //             Flag = false;
                    //         }
                    //         drGrid = this.ScreenObject.GridDataObj.NewRow();
                    //         this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPos);
                    //         RowPos++;

                    //         if (drCL.length > 0 && Util.StringValue(drCL[0]["UserDefaultValue"]) != "") {
                    //             drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                    //         }
                    //     }
                    // }
                    // if (this.ScreenObject.DocumentType == 89 || this.ScreenObject.DocumentType == 90 || this.ScreenObject.DocumentType == 68 || this.ScreenObject.DocumentType == 79) {
                    //     if (drGrid == null) {
                    //         drGrid = this.ScreenObject.GridDataObj.NewRow();
                    //         this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPos);
                    //         RowPos++;
                    //         if (drCL.length > 0 && Util.StringValue(drCL[0]["UserDefaultValue"]) != "") {
                    //             drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                    //         }
                    //     }
                    // }


                    if (col.DataType == "LISTBOX" && !Util.IsEmpty(dts.ContainsKey(col.CostCenterID)) && dts.ContainsKey(col.CostCenterID)) {
                        // if (col.DataType == "LISTBOX" && dts.Contains(col.CostCenterID) && !Util.IsEmpty(dts[col.CostCenterID])) {                        
                        let filter: string = '';

                        if (col.DisplayMember.toLowerCase().Contains("code")
                            || (BaseService.SessionManager.Preferences.ContainsKey("POSItemCodeDimension") && this.IsInventoryVoucher && col.CostCenterID.toString() == BaseService.SessionManager.Preferences["POSItemCodeDimension"]))
                            drrows = dts[col.CostCenterID].Tables[0].filter(x => Util.String(x.Code).toLowerCase() == Util.String(this.ExcelTable[i][index]).toLowerCase().Trim().Replace("'", "''"));
                        else
                            //filter = "x=>x.Name=='" + this.ExcelTable[i][0].toString().Trim().Replace("'", "''") + "'";
                            drrows = dts[col.CostCenterID].Tables[0].filter(x => Util.String(x.name).toLowerCase() == Util.String(this.ExcelTable[i][index]).toLowerCase().Trim().Replace("'", "''"));

                        if (dts[col.CostCenterID].Columns[0].Contains("dim"))//if (dts[col.CostCenterID].Contains("dim"))
                            //if (dts[col.CostCenterID].Columns.Contains("dim"))
                            //filter += " && x.dim==" + this.ExcelTable[i]["UniqDim"].toString();
                            drrows = drrows.filter(x => Util.String(x.dim).toLowerCase() == Util.String(this.ExcelTable[i]["UniqDim"]).toLowerCase());

                        if (col.CostCenterID == 11 && dts[col.CostCenterID].Columns[0].Contains("ProductID") && drGrid != null && !Util.IsEmpty(drGrid["ProductID_Key"]))
                            //  filter += " && x.ProductID==" + drGrid["ProductID_Key"].toString();
                            drrows = drrows.filter(x => x.ProductID == drGrid["ProductID_Key"])



                        if (drrows.length == 0 && col.CostCenterID == 3 && this.ImportIsBarcode && dts[col.CostCenterID].Columns.Contains("BARCODEID")) {
                            //filter = "BARCODEID='" + this.ExcelTable[i][index].toString().Trim().Replace("'", "''") + "'";
                            //drrows = dts[col.CostCenterID].Select(filter);

                            drrows = dts[col.CostCenterID].filter(x => x.BARCODEID == this.ExcelTable[i][index].toString().Trim().Replace("'", "''"));
                            if (drrows.length == 0) {
                                // filter = "Barcode='" + this.ExcelTable[i][index].toString().Trim().Replace("'", "''") + "'";
                                // drrows = dts[col.CostCenterID].Select(filter);
                                drrows = dts[col.CostCenterID].filter(x => x.Barcode == this.ExcelTable[i][index].toString().Trim().Replace("'", "''"));
                            }
                        }


                        //drrows = dts[1].Table.filter(filter);
                        //     drrows = dts[col.CostCenterID].filter(filter);
                        if (drrows.length == 0 && col.CostCenterID == 50051) {
                            // filter = "x=>x.Name=='" + this.ExcelTable[i][0].toString().Trim().Replace("'", "''") + "'";
                            drrows = dts[col.CostCenterID].Tables[0].filter(x => x.name.toLowerCase() == Util.String(this.ExcelTable[i][index]).toLowerCase().toString().Trim().Replace("'", "''"));
                            //  drrows = dts[col.CostCenterID].Select(filter);
                            //drrows = dts[1].Table.filter(filter);
                        }

                        if (drrows.length == 0 && col.CostCenterID == 11 && dts[col.CostCenterID].Columns[0].Contains("ProductID") && drGrid != null && drGrid["ProductID_Key"].toString() != "") {
                            //if (drrows.length == 0 && col.CostCenterID == 11 && dts[col.CostCenterID].Columns.Contains("ProductID") && drGrid != null && drGrid["ProductID_Key"].toString() != "") {
                            // filter = "x=>x.Name=='" + this.ExcelTable[i][0].toString().Trim().Replace("'", "''") + "'";
                            // drrows = dts[col.CostCenterID].filter(filter);
                            //drrows = dts[col.CostCenterID].Select(filter);
                            drrows = dts[col.CostCenterID].Tables[0].filter(x => Util.String(x.name).toLowerCase() == Util.String(this.ExcelTable[i][0]).toLowerCase().Trim().Replace("'", "''"));
                        }

                        if (drrows != null) {
                            if (drGrid == null) {
                                if (this.IsInventoryVoucher && col.CostCenterID == 3) {
                                    if (drrows.length > 0) {
                                        if (this.ImportIsUpdate) {
                                            if (!this.ImportUpdateSnoBased) {
                                                drprds = this.ScreenObject.GridData.filter(x => x.ProductID_Key == drrows[0]["ID"].toString());
                                                if (drprds.length > 0)
                                                    drGrid = drprds[0];
                                            }
                                        }
                                        else {
                                            drGrid = this.ScreenObject.GridDataObj.NewRow();
                                            this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPos);
                                            RowPos++;
                                            drGrid["ProductID_Key"] = drrows[0]["ID"];
                                            if (this.ScreenObject.GridDataColumns.Contains("ProductCode"))
                                                drGrid["ProductCode"] = drrows[0]["Code"];
                                            if (this.ScreenObject.GridDataColumns.Contains("ProductName"))
                                                drGrid["ProductName"] = drrows[0]["name"];
                                            this.ProdID = 0;
                                            this.AddProductData(drGrid, false, true);
                                            //this.AddProductData(ref drGrid, false, true);
                                        }
                                    }
                                    else {
                                        //let prodcol: any = this.ScreenObject.ColumnSource.filter(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "productid_key")
                                        let prodcol: any = this.ScreenObject.ColumnSource.find(a => a.ValueMember != null && a.ValueMember.toLowerCase() == "productid_key")
                                        let tlong: number;
                                        if (prodcol != null && prodcol.DefaultValue != null && prodcol.DefaultValue != "" && prodcol.DefaultValueText != null && Util.IntTryParse(prodcol.DefaultValue) > 0)   //&& parseInt(prodcol.DefaultValue) > 0
                                        {
                                            tlong = Util.IntTryParse(prodcol.DefaultValue);
                                            drGrid = this.ScreenObject.GridDataObj.NewRow();
                                            this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPos);
                                            RowPos++;
                                            let namecode: string[] = prodcol.DefaultValueText.split('\u0011');
                                            drGrid["ProductID_Key"] = prodcol.DefaultValue;
                                            if (this.ScreenObject.GridDataColumns.Contains("ProductCode") && namecode.length > 1)
                                                drGrid["ProductCode"] = namecode[1];
                                            if (this.ScreenObject.GridDataColumns.Contains("ProductName") && namecode.length > 0)
                                                drGrid["ProductName"] = namecode[0];
                                            this.ProdID = 0;
                                            this.AddProductData(drGrid, false, true);//this.AddProductData(ref drGrid, false, true);
                                        }
                                        else {
                                            if (col.DisplayMember.toLowerCase().Contains("code")) {
                                                let objFM = new FailureMessage();
                                                objFM.Name = " Product Code: " + Util.String(this.ExcelTable[i][index]).toString()
                                                objFM.Message = "Not Found";
                                                this.FailedRecourdList.push(objFM);
                                            }
                                            //IMPORT_STATUS
                                            //if (this.ExcelDataColumn.Contains("IMPORT_STATUS")) {
                                            if (this.ExcelDataColumn.Contains("IMPORT_STATUS")) {
                                                this.ExcelTable[i]["xIMP_STATUSx"] = "FAIL";
                                                this.ExcelTable[i]["IMPORT_MESSAGE"] = Util.String(this.ExcelTable[i][index]).toString() + " " + "Not Found";
                                            }
                                            //else
                                            //FailedRecourdList.push(new FailureMessage() { Name = " Product Name: " + ExcelTable[i][row[0].toString()].toString(), Message = "Not Found" });
                                        }
                                    }
                                }
                                else if (col.CostCenterID == 2 && !this.IsInventoryVoucher && drrows.length > 0) {
                                    if (this.ImportIsUpdate) {
                                        if (!this.ImportUpdateSnoBased) {
                                            drprds = this.ScreenObject.GridData.filter(x => x.ProductID_Key == drrows[0]["ID"].toString());
                                            if (drprds.length > 0)
                                                drGrid = drprds[0];
                                        }
                                    }
                                    else {
                                        drGrid = this.ScreenObject.GridDataObj.NewRow();
                                        this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPos);
                                        RowPos++;

                                        drGrid[col.ValueMember] = drrows[0]["ID"];
                                        if (col.DisplayMember.toLowerCase().Contains("code") && this.ScreenObject.GridDataColumns.Contains(col.DisplayMember))
                                            drGrid[col.DisplayMember] = drrows[0]["Code"];
                                        else if (this.ScreenObject.GridDataColumns.Contains(col.DisplayMember))
                                            drGrid[col.DisplayMember] = drrows[0]["Name"];
                                    }
                                }
                                else if (BaseService.SessionManager.Preferences.ContainsKey("POSItemCodeDimension") && this.IsInventoryVoucher && col.CostCenterID.toString() == BaseService.SessionManager.Preferences["POSItemCodeDimension"]) {
                                    if (drrows.length > 0) {
                                        drGrid = this.ScreenObject.GridDataObj.NewRow();
                                        this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPos);
                                        RowPos++;

                                        drGrid[col.ValueMember] = drrows[0]["ID"];
                                        drGrid[col.DisplayMember] = drrows[0]["Code"];

                                        if (this.ScreenObject.Preferences.ContainsKey("OnScan") && this.ScreenObject.Preferences["OnScan"].toLowerCase() != "") {
                                            this.GetProductByExternFunc(drGrid[col.DisplayMember].toString(), drGrid, RowPos);
                                        }
                                        else if (this.ScreenObject.Preferences.ContainsKey("PickStockRate") && this.ScreenObject.Preferences["PickStockRate"].toLowerCase() == "true") {
                                            this.GetProductByStockCode(drGrid[col.DisplayMember].toString(), drGrid, RowPos);
                                            if (drGrid["ProductID_Key"].toString() != "")
                                                this.FillScan(drGrid, RowPos);
                                        }
                                        else {
                                            this.AddProductData(drGrid, false, false, false, null, drGrid[col.DisplayMember].toString());
                                        }
                                    }
                                    else if (this.ExcelDataColumn.Contains("IMPORT_STATUS"))//IMPORT_STATUS
                                    {
                                        this.ExcelTable[i]["xIMP_STATUSx"] = "FAIL";
                                        this.ExcelTable[i]["IMPORT_MESSAGE"] = Util.String(this.ExcelTable[i][index]).toString() + " " + "Not Found";
                                    }
                                }
                                else if (this.IsInventoryVoucher && col.CostCenterID == 50051) {
                                    if (drrows.length > 0) {
                                        if (this.ImportIsUpdate) {
                                            if (!this.ImportUpdateSnoBased) {
                                                drprds = this.ScreenObject.GridData.filter(x => x.col.DisplayMember + "_Key" == drrows[0]["ID"].toString());
                                                if (drprds.length > 0)
                                                    drGrid = drprds[0];
                                            }
                                        }
                                        else {

                                            drGrid = this.ScreenObject.GridDataObj.NewRow();
                                            this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPos);
                                            RowPos++;

                                            // if (drCL.length > 0 && Util.StringValue(drCL[0]["UserDefaultValue"]) != "") {
                                            //     drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                                            // }
                                            if (!IsProductFromExcel && iDefProductID > 0)
                                                drGrid["ProductID_Key"] = iDefProductID;

                                            drGrid[col.ValueMember] = drrows[0]["ID"];
                                            if (col.DisplayMember.toLowerCase().Contains("code") && this.ScreenObject.GridDataColumns.Contains(col.DisplayMember)) {
                                                drGrid[col.DisplayMember] = drrows[0]["Code"];
                                                drGrid[col.DisplayMember.toLowerCase().Replace("code", "")] = drrows[0]["Name"];
                                            }
                                            else if (this.ScreenObject.GridDataColumns.Contains(col.DisplayMember))
                                                drGrid[col.DisplayMember] = drrows[0]["Name"];

                                        }
                                    }
                                    else if (this.ExcelDataColumn.Contains("IMPORT_STATUS"))//IMPORT_STATUS
                                    {
                                        this.ExcelTable[i]["xIMP_STATUSx"] = "FAIL";
                                        this.ExcelTable[i]["IMPORT_MESSAGE"] = Util.String(this.ExcelTable[i][index]).toString() + " " + "Not Found";
                                    }
                                }
                                if (this.ScreenObject.DocumentType == 67 || this.ScreenObject.DocumentType == 79) //Daily Attendance
                                {
                                    if (this.ScreenObject.DocumentType == 79)
                                        this.Celleditend(drGrid, col.DisplayMember, 0);
                                    else {
                                        if (col.DisplayMember == "dcCCNID51Code" || col.DisplayMember == "dcCCNID73") {
                                            if (col.DisplayMember == "dcCCNID51Code")
                                                this.FillDefaultValues(drGrid);
                                            this.DailyAttendanceCellEditEnd(drGrid, col.DisplayMember, col);
                                        }
                                    }
                                }
                                if (col.CostCenterID == 2 && !this.IsInventoryVoucher && drrows.length == 0) {
                                    //IMPORT_STATUS
                                    //if (this.ExcelDataColumn.Contains("IMPORT_STATUS")) {
                                    if (Object.keys(this.ExcelTable[0]).Contains("IMPORT_STATUS")) {
                                        this.ExcelTable[i]["xIMP_STATUSx"] = "FAIL";
                                        this.ExcelTable[i]["IMPORT_MESSAGE"] = Util.String(this.ExcelTable[i][index]).toString() + " " + "Not Found";
                                    }
                                }
                            }
                            else if (drGrid != null && (col.CostCenterID != 3 || (col.CostCenterID == 3 && col.DisplayMember.toLowerCase().Contains("dcalpha")))) {
                                if (drrows.length > 0) {
                                    drGrid[col.ValueMember] = drrows[0]["ID"];

                                    if (this.ScreenObject.GridDataColumns.Contains(col.DisplayMember)) {
                                        //CC
                                        if (col.DisplayMember.endsWith("Code")) {
                                            drGrid[col.DisplayMember] = drrows[0]["Code"];
                                            if (drGrid.Table.Columns.Contains(col.DisplayMember.Replace("Code", "")))
                                                drGrid[col.DisplayMember.Replace("Code", "")] = drrows[0]["Name"];
                                        }
                                        else {
                                            drGrid[col.DisplayMember] = drrows[0]["Name"];
                                        }
                                        if (this.ImportFillLocalReferences && col.CostCenterID > 0 && col.CostCenterID != 3)
                                            this.Celleditend(drGrid, col.DisplayMember, col.CostCenterID);
                                        //CC
                                    }
                                }
                                else if (this.ExcelDataColumn.Contains("IMPORT_STATUS"))//IMPORT_STATUS
                                {
                                    this.ExcelTable[i]["xIMP_STATUSx"] = "FAIL";
                                    this.ExcelTable[i]["IMPORT_MESSAGE"] = Util.String(this.ExcelTable[i][index]).toString() + " " + "Not Found";
                                }
                                if (this.CostCenterID == 11)
                                    this.OnProductUnitChange(drGrid);
                                if (this.ScreenObject.DocumentType == 67 || this.ScreenObject.DocumentType == 63 || this.ScreenObject.DocumentType == 79) //Daily Attendance
                                {
                                    if (this.ScreenObject.DocumentType == 67) {
                                        if (col.DisplayMember == "dcCCNID51Code" || col.DisplayMember == "dcCCNID73") {
                                            if (col.DisplayMember == "dcCCNID51Code")
                                                this.FillDefaultValues(drGrid);
                                            this.DailyAttendanceCellEditEnd(drGrid, col.DisplayMember, col);
                                        }
                                    }
                                    else
                                        this.Celleditend(drGrid, col.DisplayMember, 0);
                                }
                            }
                        }
                    }
                    else if (drGrid != null && col != null && col.DataType == "LINK" && col.DisplayMember.toLowerCase() == "refno" && dts.ContainsKey(400) && dts.ContainsKey(43)) {
                        //else if (drGrid != null && col != null && col.DataType == "LINK" && col.DisplayMember.toLowerCase() == "refno" && dts.ContainsKey(400) && dts.ContainsKey(43)) {
                        //
                        let Drow = this.DtImport.filter(x => x.FeatureFieldName == '-501');

                        if (Drow.length > 0 && this.ScreenObject.Preferences.ContainsKey("SnoBasedLinking") && this.ScreenObject.Preferences["SnoBasedLinking"] != "" && parseBoolean(this.ScreenObject.Preferences["SnoBasedLinking"])) {
                            // for (let t = 1; t < Object.keys(Drow[0]).length; t++) {
                            //     drrows = dts[400].filter(x => x.VoucherNO == this.ExcelTable[i][index] && x.DocSeqNo == this.ExcelTable[i][t]);
                            //     break;
                            // }
                            drrows = dts[400].filter(x => x.VoucherNO == this.ExcelTable[i][index] && x.DocSeqNo == this.ExcelTable[i][1]);
                        }
                        else
                            drrows = dts[400].filter(x => x.VoucherNO == "'" + Util.String(this.ExcelTable[i][index]).Trim() + "'" && x.ProductID == drGrid["ProductID_Key"].toString());
                        if (drrows.length > 0) {
                            drGrid[col.DisplayMember] = Util.String(this.ExcelTable[i][index]).Trim();
                            drGrid["LinkedInvDocDetailsID"] = drrows[0]["InvDocDetailsID"].toString();
                            drrows = dts[43].filter(x => x.CostCenterIDLinked == drrows[0]["CostCenterID"].toString());
                            if (drrows.length > 0)
                                drGrid["LinkedFieldName"] = drrows[0]["SysColumnName"].toString();
                            //ImportCopyLinkFields
                            if (this.ImportCopyLinkFields && dsLinkDeFID != null && dsLinkDeFID.Tables.length > 0) {
                                this.ScreenObject.LoadLinkFieldsData_3(dsLinkDeFID, null, []);
                                let rowind = 0;
                                var drrID = dsLinkDeFID.Tables[0].filter(x => x.InvDocDetailsID == drGrid["LinkedInvDocDetailsID"].toString());
                                if (drrID.length > 0)
                                    rowind = dsLinkDeFID.Tables[0].indexOf(drrID[0]);

                                for (let j = 0, ColumnNO = 0; j < this.ScreenObject.ColumnSource.length; j++, ColumnNO++) {
                                    if (this.ScreenObject.ColumnSource[j].DisplayMember == "DocDetailsID" || this.ScreenObject.ColumnSource[j].DisplayMember == "RefNo" || this.ScreenObject.ColumnSource[j].DisplayMember == "LinkedFieldName" || this.ScreenObject.ColumnSource[j].DisplayMember == "LinkedInvDocDetailsID")
                                        continue;
                                    if (this.ScreenObject.ColumnSource[j].ID.Contains(CCColIDs) || this.ScreenObject.ColumnSource[j].DisplayMember.Contains("ProductCode") || this.ScreenObject.ColumnSource[j].DisplayMember.Contains("ProductName"))
                                        continue;
                                    this.ScreenObject.SetLinkValues(dsLinkDeFID, this.ScreenObject.ColumnSource[j], rowind, drGrid, null, '');
                                }

                            }
                            //
                        }
                    }
                    else if (drGrid != null && col != null && col.DataType == "LINK" && col.DisplayMember.Contains("dcAlpha")) {

                        let addatt: AddAttachmentViewModel = new AddAttachmentViewModel();
                        addatt.AddAttachmentViewModel_2(this);
                        {
                            try {
                                /***  PactFile oFile = this.ExcelTable[i][row[0].toString()].toString().Trim();
                                  addatt.ActualFileName = oFile.ActualFileName;
                                  addatt.FileExtension = oFile.FileExtension;
                                  addatt.Guid = oFile.guid;
                                  addatt.FilePath = Util.GetPath(oFile.guid + "." + oFile.FileExtension);
                                  addatt.RelativeFileName = this.ExcelTable[i][row[0].toString()].toString().Trim();
                                  addatt.AllowInPrint = false;
                                  addatt.isfrmProduct = false;
                                  addatt.ColID = col.DisplayMember;
                                  addatt.RowID = drGrid;
                                  this.ViewAttachments.AttachmentsList.push(addatt); */

                            }
                            catch {
                            }
                        }
                    }
                    else if (drGrid != null && (col.DataType.toUpperCase() == "FLOAT" || col.DataType.toUpperCase() == "INT")) {
                        let tempDbl;
                        //this.ExcelTable[i][row[0].toString() Changing to this.ExcelTable[i][index]
                        if (Util.String(this.ExcelTable[i][index]).Trim() != "") {
                            drGrid[col.DisplayMember] = Util.String(Util.DoubleTryParse(Util.String(this.ExcelTable[i][index]).Trim()));
                        }
                        // while importing, if the "(this.ExcelTable[i][index]).Trim())" value is zero then value was not setting to drGrid[col.DisplayMember].
                        // if (Util.DoubleTryParse(Util.String(this.ExcelTable[i][index]).Trim()) > 0) 
                        //     drGrid[col.DisplayMember] = Util.String(this.ExcelTable[i][index]).toString().Trim();
                        if (this.ScreenObject.DocumentType == 67) //Daily Attendance
                        {
                            if (col.DisplayMember.toLowerCase() == "dcnum1" || col.DisplayMember.toLowerCase() == "dcnum4" || col.DisplayMember.toLowerCase() == "dcnum5" || col.DisplayMember.toLowerCase() == "dcnum7" || col.DisplayMember.toLowerCase() == "dcnum9" || col.DisplayMember.toLowerCase() == "dcnum11" || col.DisplayMember.toLowerCase() == "dcnum13")
                                this.DailyAttendanceCellEditEnd(drGrid, col.DisplayMember, col);
                        }
                    }
                    else if (drGrid != null && (col.DataType.toLowerCase() == "textblock" || col.DataType.toLowerCase() == "text" || col.DataType.toUpperCase() == "FLOAT" || col.DataType.toUpperCase() == "INT")) {
                        //drGrid[col.DisplayMember] = this.ExcelTable[i][0].toString().Trim();
                        if (Util.String(this.ExcelTable[i][index]).Trim().Contains('\n')) {
                            let fs = parseFloat(BaseService.SessionManager.Preferences["CtrlTFontSize"]) * (96 / 72)//(96f / 72f);
                            let strA = Util.String(this.ExcelTable[i][index]).toString().Trim().split('\n');
                            if (strA != null && strA.length > 0) {
                                let s1 = "\"";
                                //let sFD = "<FlowDocument xmlns=" + s1 + "http://schemas.microsoft.com/winfx/2006/xaml/presentation" + s1 + ">";
                                let sFD = "<FlowDocument FontFamily=" + s1 + BaseService.SessionManager.Preferences["CtrlTFontName"] + s1 + " FontSize=" + s1 + fs + s1 + " xmlns=" + s1 + "http://schemas.microsoft.com/winfx/2006/xaml/presentation" + s1 + ">";
                                for (let r = 0; r < strA.length; r++) {
                                    sFD += "<Paragraph>" + PactTextBoxData.GetValidTextXml(strA[r]) + "</Paragraph>";
                                }
                                sFD += "</FlowDocument>";
                                drGrid[col.DisplayMember] = sFD;
                            }
                        }
                        else {
                            drGrid[col.DisplayMember] = Util.String(this.ExcelTable[i][index]).toString().Trim();
                        }
                        if (this.ScreenObject.DocumentType == 67) //Daily Attendance
                        {
                            //this.Celleditend(drGrid, col.DisplayMember, 0);
                        }
                        //if (col.DataType.toUpperCase() == "FLOAT" || col.DataType.toUpperCase() == "INT")
                        //{
                        //    Celleditend(drGrid, col.DisplayMember, 0);
                        //}
                    }
                    else if (drGrid != null && (col.DataType.toLowerCase() == "date" || col.DataType.toLowerCase() == "datetime" || col.DataType.toLowerCase() == "time" || col.DataType.toLowerCase() == "time2")) {
                        let dttemp: any;
                        if (Util.isValidDate(Util.ParseDate(Util.String(this.ExcelTable[i][index])))) {
                            dttemp = Util.ParseDate(Util.String(this.ExcelTable[i][index]))
                            if (col.DataType.toLowerCase() == "date") {
                                drGrid[col.DisplayMember] = dttemp.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                drGrid[col.DisplayMember + "_Key"] = dttemp;

                                if (this.ScreenObject.DocumentType == 60 || this.ScreenObject.DocumentType == 63) //Assign & Topup Leaves
                                {
                                    this.Celleditend(drGrid, col.DisplayMember, 0);
                                }
                            }
                            else if (col.DataType.toLowerCase() == "datetime") {
                                drGrid[col.DisplayMember] = dttemp.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm:ss tt");
                                drGrid[col.DisplayMember + "_Key"] = dttemp;
                            }
                            else if (col.DataType.toLowerCase() == "time") {
                                drGrid[col.DisplayMember] = dttemp.ToString("hh:mm:ss tt");
                                drGrid[col.DisplayMember + "_Key"] = dttemp;
                            }
                            else if (col.DataType.toLowerCase() == "time2") {
                                drGrid[col.DisplayMember] = dttemp.ToString("HH:mm");
                                drGrid[col.DisplayMember + "_Key"] = dttemp.ToString("dd-MMM-yyyy HH:mm");

                                if (this.ScreenObject.DocumentType == 67) //Daily Attendance
                                {
                                    //this.Celleditend(drGrid, col.DisplayMember, 0);
                                }
                            }

                        }
                    }
                    else if (drGrid != null && col.DataType.toLowerCase() == "combobox") {
                        if (this.ScreenObject.DocumentType == 68 && (Util.String(this.ExcelTable[i][index]).Trim().toLowerCase().Contains("earning") || this.ExcelTable[i][row["FieldName"].toString()].toString().Trim().toLowerCase().Contains("deduction"))) {
                            //if (this.ScreenObject.DocumentType == 68 && (this.ExcelTable[i][row["FieldName"].toString()].toString().Trim().toLowerCase().Contains("earning") || this.ExcelTable[i][row["FieldName"].toString()].toString().Trim().toLowerCase().Contains("deduction"))) {
                            if (this.ExcelTable[i][row["FieldName"].toString()].toString().Trim().toLowerCase().Contains("earning"))
                                drGrid[col.ValueBinding] = 2;
                            if (this.ExcelTable[i][row["FieldName"].toString()].toString().Trim().toLowerCase().Contains("deduction"))
                                drGrid[col.ValueBinding] = 3;
                        }
                        else {
                            drGrid[col.ValueBinding] = Util.String(this.ExcelTable[i][index]).Trim();

                            let col1: any = this.ScreenObject.ColumnSource.filter(a => a.DisplayMember == "dcCCNID52");
                            if (col1 != null && !Util.IsEmpty(col1.Shortcut) && col1.Shortcut.toLowerCase() == "lostfocus" && this.ValidateData_Column(col1, drGrid, true))
                                this.ScreenObject.GetExternalFuncData(col1.Mode, col1.SPName, col1.IPParams, col1.OPParams, drGrid);
                        }
                        if (this.ScreenObject.DocumentType == 63) {
                            this.Celleditend(drGrid, col.ValueBinding, 0);
                        }
                    }
                    else if (drGrid != null && col.DataType.toLowerCase() == "pactcombobox") {
                        if (this.ScreenObject.DocumentType == 68) {
                            let drcCom: any[] = col.ComboDataTable.filter(x => x.NAME == Util.String(this.ExcelTable[i][index]).Trim());
                            if (drcCom != null && drcCom.length > 0) {
                                drGrid[col.ValueBinding] = drcCom[0]["NODEID"];
                                drGrid[col.ValueBinding + "_Key"] = drcCom[0]["NAME"];
                            }
                        }
                    }
                }
                else if (i == 0) {

                    let Docfld = this.ScreenObject._TextFields.find(a => a.DBColumnID.toString() == row["FeatureFieldName"].toString());
                    if (Docfld == null) {
                        Docfld = this.ScreenObject._CCFields.find(a => a.DBColumnID.toString() == row["FeatureFieldName"].toString());
                        //CC
                        if (Docfld == null)
                            Docfld = this.ScreenObject._CCFields.find(a => "-" + a.DBColumnID.toString() == row["FeatureFieldName"].toString());
                        //CC
                    }
                    if (Docfld == null)
                        Docfld = this.ScreenObject._StaticFields.find(a => a.DBColumnID.toString() == row["FeatureFieldName"].toString());
                    if (Docfld != null) {
                        if (Docfld instanceof PactControlData && (Docfld.DBColumnName.toLowerCase() == "docdate" && !Util.IsEmpty(this.ExcelTable[i][index])))
                            this.DocumentDate = Util.ParseDate(this.ExcelTable[i][0].toString());
                        else if (Docfld instanceof PactListBoxData && this.ExcelTable[i][index].toString().Trim().Replace("'", "''") != '') {
                            let dt: any = BaseService.document.GetCCValues("'" + Util.String(this.ExcelTable[i][index]).Trim().Replace("'", "''") + "'", Docfld.CCID, 0);
                            if (dt != null && dt.Tables.length > 0 && dt.Tables[0].length > 0 && dt.Columns[0].Contains("ID"))
                                this.ScreenObject.fillcontrolValue(Docfld, dt.Tables[0][0]["ID"].toString());
                        }
                        else if (Docfld instanceof PactCodeNameListBoxData && this.ExcelTable[i][index].toString().Trim().Replace("'", "''") != '') {
                            let dt: any = BaseService.document.GetCCValues("'" + Util.String(this.ExcelTable[i][index]).Trim().Replace("'", "''") + "'", Docfld.CCID, 0);
                            if (dt != null && dt.Tables.length > 0 && dt.Tables[0].length > 0 && dt.Columns[0].Contains("ID"))
                                this.ScreenObject.fillcontrolValue(Docfld, dt.Tables[0][0]["ID"].toString(), false, dt.Tables[0]);
                        }
                        else if (Docfld instanceof PactControlData) {
                            this.ScreenObject.fillcontrolValue(Docfld, Util.String(this.ExcelTable[i][index]));
                        }
                    }
                }
                //else if (row[1].toString() == "-500" && drGrid != null && drGrid["Type"].toString() == "5" && this.ExcelTable[i][0].toString() != "") {
                else if (Util.String(row[Object.keys(row)[1]]) == "-500" && drGrid != null && drGrid["Type"].toString() == "5" && !Util.IsEmpty(this.ExcelTable[i][0])) {
                    let div: number = 0; let loc: number = 0;
                    if (this.ScreenObject.LocationID > 0)
                        loc = this.ScreenObject.LocationID;
                    else
                        loc = BaseService.SessionManager.LocationID;
                    if (this.ScreenObject.DivisionID > 0)
                        div = this.ScreenObject.DivisionID;
                    else
                        div = BaseService.SessionManager.DivisionID;
                    let batch = new BatchNumberViewModel(this.ScreenObject.GridDataObj);
                    batch.BatchNumberViewModel_4(this, this.VoucherType, parseFloat(drGrid["Quantity"].toString()), null, parseInt(drGrid["ProductID_Key"].toString()), drGrid["ProductName"].toString(), loc, div, '')
                    {
                        let drbatchrows: any;
                        if (this.VoucherType == -1) {
                            drbatchrows = batch.GridData.filter(x => x.BATCHNUMBER == Util.String(this.ExcelTable[i][index]).toString());
                            if (drbatchrows.length > 0) {
                                if (drbatchrows[0]["BalQty"].toString() != "" && parseFloat(drbatchrows[0]["BalQty"].toString()) > parseFloat(drGrid["Quantity"].toString()))
                                    drbatchrows[0]["Quantity"] = drGrid["Quantity"].toString();
                                else
                                    drbatchrows[0]["Quantity"] = drbatchrows[0]["BalQty"];
                            }
                        }
                        else {
                            drbatchrows = batch.dsBatch.Tables[0].filter(x => x.BATCHNUMBER == Util.String(this.ExcelTable[i][index]).toString());
                            if (drbatchrows.length > 0) {
                                batch.GridData[0]["BatchID"] = drbatchrows[0]["BatchID"].toString();
                                batch.OnBatchSelected(batch.GridData[0], parseInt(drbatchrows[0]["BatchID"].toString()));
                                batch.GridData[0]["Quantity"] = drGrid["Quantity"].toString();
                            }
                        }
                        if (drbatchrows.length > 0)
                            batch.OnSave("AutoSave");
                    }

                }
                if (drGrid == null && col == null && this.ImportIsUpdate && this.ImportUpdateSnoBased) {
                    let Drw = this.DtImport.filter(x => x.FeatureFieldName == '-501');
                    if (Drw.length > 0) {

                        //for (let t = 1; t < Object.keys(Drw[0]).length; t++) {
                        //drrows = dts[400].filter(x => x.VoucherNO == this.ExcelTable[i][index] && x.DocSeqNo == this.ExcelTable[i][t]);
                        //drprds = this.ScreenObject.GridData.filter(x => x.DocSeqNo == this.ExcelTable[i][Drw[0][0].toString()].toString().Trim());
                        drprds = this.ScreenObject.GridData.filter(x => x.DocSeqNo == this.ExcelTable[i][index]);
                        // break;
                        //  }
                        if (drprds.length > 0)
                            drGrid = drprds[0];
                    }
                }
            }
            if (drGrid != null) {

                if (!this.IsInventoryVoucher && this.ImportNewRefBillwise) {
                    //Start: "OPB New Reference - Billwise"
                    ;
                    let sbbills = '';
                    if (this.ScreenObject.DocumentType == 16 && Util.Double(drGrid["AccountID_Key"]) != 0 && Util.Int(drGrid["AccountID_Key"]) > 0) {
                        let DSAccBillwise: any = BaseService.document.IsBillWiseAccount(Util.Int(drGrid["AccountID_Key"]));
                        if (DSAccBillwise != null && DSAccBillwise.Tables.length > 0 && DSAccBillwise.Tables[0].length > 0 && parseBoolean(DSAccBillwise.Tables[0][0]["IsBillwise"])) {
                            sbbills = "<BillWise><Row  ";
                            sbbills += "DocSeqNo=\"" + (i + 1).toString() + "\" ";
                            if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && Util.Double(drGrid["AccountID_Key"]) != 0 && Util.Int(drGrid["AccountID_Key"]) > 0
                                && Util.Double(drGrid["DebitAmount"]) != 0 && Util.Double(drGrid["DebitAmount"]) > 0) {
                                sbbills += "AmountFC=\"" + parseFloat(drGrid["DebitAmount"].toString()) + "\" ";
                                sbbills += "AdjAmount=\"" + parseFloat(drGrid["DebitAmount"].toString()) * parseFloat(this.Currency.ExchangeRate.Text) + "\" ";

                            }
                            else if (this.ScreenObject.GridDataColumns.Contains("AccountID_Key") && Util.Double(drGrid["AccountID_Key"]) != 0 && Util.Int(drGrid["AccountID_Key"]) > 0
                                && Util.Double(drGrid["CreditAmount"]) != 0 && Util.Double(drGrid["CreditAmount"]) > 0) {
                                sbbills += "AmountFC=\"" + "-" + parseFloat(drGrid["CreditAmount"].toString()) + "\" ";
                                sbbills += "AdjAmount=\"" + "-" + parseFloat(drGrid["CreditAmount"].toString()) * parseFloat(this.Currency.ExchangeRate.Text) + "\" ";
                            }
                            sbbills += "AccountID=\"" + drGrid["AccountID_Key"] + "\" ";
                            sbbills += "AdjCurrID=\"" + this.Currency.Currency.SelectedValue + "\" ";
                            sbbills += "AdjExchRT=\"" + this.Currency.ExchangeRate.Text + "\" ";
                            sbbills += "IsNewReference=\"" + "1" + "\" ";
                            sbbills += " IsDocPDC=\"0\" Narration=\"\" ></Row></BillWise>";
                            drGrid["ExtraXML"] = sbbills.toString();
                        }
                    }
                    //End: "OPB New Reference - Billwise"
                }

                if (this.IsInventoryVoucher)
                    this.CalculateTotals(drGrid, false, "Quantity", false);
                else
                    this.CalculateTotals(drGrid, false, "", false);

                if (schemes) {
                    if (drGrid["ProductID_Key"].toString() != "" && parseInt(drGrid["ProductID_Key"].toString()) > 0) {
                        let ds: any = this.ScreenObject.GetSchemes(this.DocumentDate, drGrid);
                        if (ds.Tables.length > 0 && ds.Columns[0].Contains("SchemeID"))
                            this.fillSchemevalues(this.DtTempSchemes, ds.Tables[0], drGrid);
                    }
                    this.ApplySchemes(drGrid);
                }
            }
        }
        if (this.ScreenObject.DocumentType == 63) {
            //Start: For checking the duplicate rows in grid (Fromdate and Todate)
            let index: number = 0;
            for (let k = 0; k < this.ScreenObject.GridData.length - 1; k++) {
                if (k >= 1)
                    index = k - 1;

                if (this.ScreenObject.GridData[k]["dcCCNID51_Key"] != null && this.ScreenObject.GridData[k]["dcCCNID52_Key"] != null) {
                    if (this.ScreenObject.GridData[k]["dcCCNID51_Key"] != null && this.ScreenObject.GridData[k]["dcCCNID52_Key"] != null
                        && this.ScreenObject.GridData[k]["dcAlpha4_Key"] != null && this.ScreenObject.GridData[k]["dcAlpha5_Key"] != null
                        && this.ScreenObject.GridData[index]["dcAlpha4_Key"] != null && this.ScreenObject.GridData[index]["dcAlpha5_Key"] != null) {
                        if (k != index && (parseInt(this.ScreenObject.GridData[k]["dcCCNID51_Key"]) == parseInt(this.ScreenObject.GridData[index]["dcCCNID51_Key"]))
                            && (parseInt(this.ScreenObject.GridData[k]["dcCCNID52_Key"]) == parseInt(this.ScreenObject.GridData[index]["dcCCNID52_Key"]))
                            && this.ScreenObject.GridData[k]["dcAlpha4_Key"] != null && this.ScreenObject.GridData[index]["dcAlpha4_Key"] != null && this.ScreenObject.GridData[index]["dcAlpha5_Key"] != null) {

                            if ((Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"]) &&
                                Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_Key"]))
                                ||
                                (Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) &&
                                    Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]))) {
                                this.DisplayMessage = "FromDate already exist";
                                this.ScreenObject.GridData[index]["dcAlpha7"] = 0;
                                break;
                            }
                        }
                        if (k != index && (parseInt(this.ScreenObject.GridData[k]["dcCCNID51_Key"]) == parseInt(this.ScreenObject.GridData[index]["dcCCNID51_Key"]))
                            && (parseInt(this.ScreenObject.GridData[k]["dcCCNID52_Key"]) == parseInt(this.ScreenObject.GridData[index]["dcCCNID52_Key"]))
                            && this.ScreenObject.GridData[k]["dcAlpha5_Key"] != null && this.ScreenObject.GridData[index]["dcAlpha5_Key"] != null && this.ScreenObject.GridData[index]["dcAlpha4_Key"] != null) {
                            if (k != index && (Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"]) &&
                                Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_Key"]))
                                ||
                                (Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_Key"]) >= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha4_Key"]) &&
                                    Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_Key"]) <= Util.ParseDate(this.ScreenObject.GridData[index]["dcAlpha5_Key"]))) {

                                this.DisplayMessage = "ToDate already exist";
                                this.ScreenObject.GridData[index]["dcAlpha7"] = 0;
                                break;
                            }
                            else {
                                if ((parseInt(this.ScreenObject.GridData[index]["dcCCNID51_Key"]) == parseInt(this.ScreenObject.GridData[k]["dcCCNID51_Key"])) && (parseInt(this.ScreenObject.GridData[index]["dcCCNID52_Key"]) == parseInt(this.ScreenObject.GridData[k]["dcCCNID52_Key"])) && (parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]) == parseFloat(this.ScreenObject.GridData[k]["dcAlpha3"]))) {
                                    if (parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]) >= parseFloat(this.ScreenObject.GridData[k]["dcAlpha3"]))
                                        this.ScreenObject.GridData[k]["dcAlpha3"] = parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]) - parseFloat(this.ScreenObject.GridData[k]["dcNum1"]);
                                    else if (parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]) < parseFloat(this.ScreenObject.GridData[k]["dcAlpha3"]))
                                        this.ScreenObject.GridData[k]["dcAlpha3"] = parseFloat(this.ScreenObject.GridData[k]["dcNum1"]) - parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]);
                                }
                                else if ((parseInt(this.ScreenObject.GridData[index]["dcCCNID51_Key"]) == parseInt(this.ScreenObject.GridData[k]["dcCCNID51_Key"])) && (parseInt(this.ScreenObject.GridData[index]["dcCCNID52_Key"]) == parseInt(this.ScreenObject.GridData[k]["dcCCNID52_Key"])) && (parseFloat(this.ScreenObject.GridData[index]["dcAlpha3"]) < parseFloat(this.ScreenObject.GridData[k]["dcAlpha3"]))) {
                                    this.ScreenObject.GridData[k]["dcAlpha3"] = parseFloat(this.ScreenObject.GridData[k]["dcAlpha3"]) - parseFloat(this.ScreenObject.GridData[index]["dcNum1"]);
                                }
                            }
                        }
                    }
                }
            }

            this.ScreenObject.GridDataObj.refreshDataView();

            //End: For checking the duplicate rows in grid (Fromdate and Todate)
        }
        this.DisplayMessage = '';

        this.RefreshGrid = true;

        if (this.ImportCopyLinkFields && dsLinkDeFID != null && dsLinkDeFID.Tables.length > 0)
            this.ScreenObject.FillListViews(false);

        this.ScreenObject.UpdateSequence();
        this.CalculateTotals(null, false);

        if (this.FailedRecourdList.length > 0) {
            this.ListVisbility = true;
        }
        else
            this.ListVisbility = false;

        try {
            if (!this.DoNotUpdateExcelSheet)
                this.UpdateExcelSheet();
        }
        catch (Exception) {
        }
    }
    UpdateExcelSheet() {
        /*** if (!ExcelDataColumn.Contains("IMPORT_STATUS"))
             return;
         object mv = System.Reflection.Missing.Value;
         Microsoft.Office.Interop.Excel.Application app = new Microsoft.Office.Interop.Excel.Application();
         Microsoft.Office.Interop.Excel.Workbook wk = app.Workbooks.Open(ImportFileName, 0, false, 5, "", "", false, Microsoft.Office.Interop.Excel.XlPlatform.xlWindows, "\t", true, false, 0, true, 1, 0);
         Microsoft.Office.Interop.Excel.Worksheet ws = (Microsoft.Office.Interop.Excel.Worksheet)wk.ActiveSheet;
         try
         {
             Microsoft.Office.Interop.Excel.Range r;
             int StausIndex = 0, MessageIndex = 0, EmtInd = 0;
             for (int i = 1; i < 150; i++)
             {
                 r = (Microsoft.Office.Interop.Excel.Range)ws.Cells[1, i];
                 if (r.Value2 != null && r.Value2.ToString() == "IMPORT_STATUS")
                 {
                     StausIndex = i;
                     if (MessageIndex > 0)
                         break;
                 }
                 else if (r.Value2 != null && r.Value2.ToString() == "IMPORT_MESSAGE")
                 {
                     MessageIndex = i;
                     if (StausIndex > 0)
                         break;
                 }
                 else if ((r.Value2 == null || r.Value2.ToString() == "") && EmtInd == 0)
                     EmtInd = i - 1;
             }

             if (StausIndex == 0)
             {
                 EmtInd++;
                 r = (Microsoft.Office.Interop.Excel.Range)ws.Cells[1, EmtInd];
                 r.Value2 = "IMPORT_STATUS";
                 r.EntireColumn.ColumnWidth = 17;
                 StausIndex = EmtInd;
                 r.Interior.Color = System.Drawing.Color.SteelBlue.ToArgb();
                 r.Font.Bold = true;
             }
             if (MessageIndex == 0)
             {
                 EmtInd++;
                 r = (Microsoft.Office.Interop.Excel.Range)ws.Cells[1, EmtInd];
                 r.EntireColumn.ColumnWidth = 40;
                 r.Value2 = "IMPORT_MESSAGE";
                 r.Interior.Color = System.Drawing.Color.SteelBlue.ToArgb();
                 r.Font.Bold = true;
                 MessageIndex = EmtInd;
             }

             for (int i = 0; i < ExcelTable.Rows.Count; i++)
             {
                 if (ExcelDataColumn.Contains("IsNewRow") && ExcelTable[i]["IsNewRow"].ToString() == "1")
                     continue;
                 r = (Microsoft.Office.Interop.Excel.Range)ws.Cells[i + 2, StausIndex];
                 if (r.Value2 == null || r.Value2.ToString() != "PASS")
                 {
                     r.Value2 = ExcelTable[i]["xIMP_STATUSx"].ToString();
                     r = (Microsoft.Office.Interop.Excel.Range)ws.Cells[i + 2, MessageIndex];
                     r.Value2 = ExcelTable[i]["IMPORT_MESSAGE"].ToString();
                 }
             }
         }
         catch (Exception ex)
         {
             Logger.ErrorLog("importuitlity", "Excel Status writing", ex.Message, ex);
         }
         finally
         {
             wk.Close(true, mv, mv);
             app.Quit();
             System.Runtime.InteropServices.Marshal.ReleaseComObject(ws);
             ws = null;
             System.Runtime.InteropServices.Marshal.ReleaseComObject(wk);
             wk = null;
             System.Runtime.InteropServices.Marshal.ReleaseComObject(app);
             app = null;
         } ***/
    }
    GetLeaveEncashAmount(Days: number, LeaveType: number): number {
        let Amount = 0;
        let dsEmpData = null;
        let dvStructure;
        let fldObj;
        let oEvalPayFormulas = new EvaluatePayrollFormulas();

        if (this.dsData != null) {
            dsEmpData = this.dsData;
        }
        else {
            this.DimensionSelectedvalueData();
            dsEmpData = this.dsData;
        }

        if (dsEmpData.Tables[1].length > 0) {

            oEvalPayFormulas.sEmpSeqNo = dsEmpData.Tables[0][0]["NodeID"].toString();
            let refObj = { PayrollMonth: oEvalPayFormulas.PayrollMonth, PayrollMonthStart: oEvalPayFormulas.PayrollMonthStart, PayrollMonthEnd: oEvalPayFormulas.PayrollMonthEnd }
            Util.SetPayrollDate(this.ScreenObject.DocDate.Date, refObj);
            oEvalPayFormulas.PayrollMonth = refObj.PayrollMonth;
            oEvalPayFormulas.PayrollMonthStart = refObj.PayrollMonthStart;
            oEvalPayFormulas.PayrollMonthEnd = refObj.PayrollMonthEnd;

            oEvalPayFormulas.arrLstCPFields[6].Clear();

            oEvalPayFormulas.Intialize();
            oEvalPayFormulas.othMPField.BasicMonthly = parseFloat(dsEmpData.Tables[2][0]["BasicMonthly"]);
            oEvalPayFormulas.ExecuteAllFormulas();

            let oCPF = new CPFields();

            dvStructure = dsEmpData.Tables[1].filter(x => x.ComponentID == LeaveType);
            if (dvStructure.length > 0) {
                oCPF.ComponentName = "EncashFormula";
                oCPF.Formula = dvStructure[0]["EncashFormula"].toString();
                oEvalPayFormulas.arrLstCPFields[6].push(oCPF);
            }

            fldObj = new MimizField("EncashDays", "");
            oEvalPayFormulas.fldDict.push("EncashDays", fldObj);
            oEvalPayFormulas.fldDict["EncashDays"].setFieldValue(Days);

            let temp1 = oEvalPayFormulas.fldDict;

            if (!Util.IsEmpty(oEvalPayFormulas.arrLstCPFields[6][0].Formula))
                Amount = parseFloat(BaseService.eval.EvaluateExpression(oEvalPayFormulas.arrLstCPFields[6][0].Formula.toString(), temp1));
        }
        return Amount;
    }

    //#region "Post Past Salary Details"
    FillEarnDeductDetails(Flag: number, Year: number) {
        Logger.InfoLog("AddEditDocumentViewModel::Entering FillEarningsandDeductions");
        try {
            let FieldType = [];
            let fldROD = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha1") as PactExtraFieldDateData;
            if (Flag == 0) {
                if (fldROD) {
                    let dtYear;
                    dtYear = new Date(parseInt(Util.ParseDate(BaseService.SessionManager.FinancialYearStartDate).ToString("yyyy")), BaseService.SessionManager.AccountingFromMonth - 1, 1);
                    fldROD.Date = Util.ParseDate(dtYear);
                    fldROD.CustomFormat = "yyyy";
                    this.SetMonthNames(dtYear.getFullYear());
                }
            }
            else {
                this.SetMonthNames(Year);
            }

            let dsData1 = this.ScreenObject.GetPayrollComponents(2, 1, 0, fldROD ? Util.ParseDate(fldROD.Date) : this.ScreenObject.DocDate.Date);
            if (dsData1.Tables.length > 0) {
                dsData1.Tables[0].sort((a, b) => a.ParentID - b.ParentID);
                let fldPSD = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha2");
                if (fldPSD) {
                    if (dsData1.Tables[0].length > 0) {
                        for (let i = 0; i <= dsData1.Tables[0].length - 1; i++) {
                            FieldType.push(ComboBoxItems.ComboBoxItems_2(dsData1.Tables[0][i]["NAME"].toString(), dsData1.Tables[0][i]["NODEID"].toString()));
                        }
                        fldPSD.DisplayMember = "Name";
                        fldPSD.ValueMember = "Value";
                        fldPSD.ComboData = FieldType;
                    }
                }
            }

            let drGrid = null;
            let RowPosition = 0;
            //DataSet dsData2 = this.ScreenObject.GetPayrollComponents(2, 1, 0);
            if (dsData1.Tables.length > 0) {
                if (dsData1.Tables[0].length > 0) {
                    drGrid = null;
                    this.ScreenObject.GridDataObj.Clear();
                    let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                    for (let k = 0; k < dsData1.Tables[0].length; k++) {
                        drGrid = this.ScreenObject.GridDataObj.NewRow();
                        this.ScreenObject.GridData.InsertAt(drGrid, RowPosition);
                        RowPosition++;
                        if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"]))
                            drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];

                        drGrid["dcAlpha2"] = dsData1.Tables[0][k]["NODEID"];
                        drGrid["dcAlpha15"] = parseInt(dsData1.Tables[0][k]["ParentID"]) == 2 ? "Earnings" : "Deductions";
                    }
                    if (dsData1.Tables[0].length > 0)
                        this.ScreenObject.GridDataObj.refreshDataView();
                }
            }
        }
        catch (error) {
            this.DisplayMessage = "Load Error";
            Logger.ErrorLog("AddEditDocumentViewModel:: FillEarningsandDeductions" + error.stack);
        }
    }

    SetMonthNames(Year: number) {
        Logger.InfoLog("AddEditDocumentViewModel::Entering SetMonthNames");
        try {
            let intFiscalyearStartMonth = 0, intMonthNo = 0, intRMonthNo = 0, intdcAlphastartno = 0, intFinyear = 0, Nextfinyear = 0;
            let year;

            //SET FISCAL YEAR
            intFinyear = Year;// BaseService.SessionManager.FinancialYearStartDate.getFullYear();
            year = intFinyear.toString();
            intFinyear = parseInt(year.substr(2, 2));
            Nextfinyear = intFinyear + 1;

            //SET FISCAL YEAR START MONTH
            intFiscalyearStartMonth = BaseService.SessionManager.AccountingFromMonth;
            intdcAlphastartno = intFiscalyearStartMonth;

            //START: SET MONTH NAMES
            let colPSD = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
            for (let i = 2; i < 14; i++) {
                if (intMonthNo == 12) {
                    intRMonthNo = (intMonthNo + 2) - i;
                    for (let j = 1; j <= intRMonthNo; j++) {
                        colPSD = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha" + (j + 2).toString());
                        if (colPSD) {
                            colPSD.Header = this.ScreenObject.GetMonthName(j, false) + "-" + Nextfinyear.toString();
                            colPSD.DisplayMember = "dcAlpha" + (j + 2).toString();
                        }
                        i = i + 1;
                    }
                }
                else {
                    colPSD = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha" + (i + intdcAlphastartno).toString());
                    if (colPSD) {
                        intMonthNo = intFiscalyearStartMonth + (i - 2);
                        colPSD.Header = this.ScreenObject.GetMonthName(intMonthNo, false) + "-" + intFinyear.toString();
                        colPSD.DisplayMember = "dcAlpha" + (i + intdcAlphastartno).toString();
                    }
                }
            }
            this.ScreenObject.GridDataObj.RefreshColumns();
            //END: SET MONTH NAMES
        }
        catch (error) {
            this.DisplayMessage = "Load Month Names Error";
            Logger.ErrorLog("AddEditDocumentViewModel:: SetMonthNames" + error.stack);

        }
    }

    PostSalaryDocResetColumns() {
        let colPSD = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
        for (let i = 1; i < 13; i++) {
            colPSD = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha" + (i + 2).toString());
            if (colPSD) {
                colPSD.IsVisible = true;
            }
        }
        this.ScreenObject.GridDataObj.RefreshColumns();
    }

    SetNoofMonths(ds: any) {
        Logger.InfoLog("AddEditDocumentViewModel::Entering SetNoofMonths");
        try {
            //START: SHOWING PAST MONTH NAMES
            if (parseInt(ds.Tables[0][0]["NoOfMonths"]) > 0) {
                let intNoofMonths = 0;
                intNoofMonths = parseInt(ds.Tables[0][0]["NoOfMonths"]);
                let colPSD = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");

                //FISCAL YEAR START JAN MONTH
                if (BaseService.SessionManager.AccountingFromMonth == 1) {
                    intNoofMonths = intNoofMonths + 1;
                    for (let i = intNoofMonths; i < 13; i++) {
                        colPSD = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha" + (i + 2).toString());
                        if (colPSD) {
                            colPSD.IsVisible = false;
                        }
                    }
                }

                //FISCAL YEAR START OTHER THAN JAN MONTH
                else {
                    intNoofMonths = intNoofMonths + 2;
                    this.ScreenObject.ColumnSource.forEach(item => {
                        for (let i = 1; i < 13; i++) {
                            if (item.DisplayMember != null && item.DisplayMember != "" && item.DisplayMember.toLowerCase() == "dcalpha" + (i + 2).toString()) {
                                item.IsVisible = false;
                            }
                        }
                    });
                    for (let i = 2; i < intNoofMonths; i++) {
                        colPSD = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha" + (BaseService.SessionManager.AccountingFromMonth + i).toString());
                        if (colPSD) {
                            colPSD.IsVisible = true;
                        }
                    }
                }
                this.ScreenObject.GridDataObj.RefreshColumns();
            }
            //END: SHOWING PAST MONTH NAMES
        }
        catch (error) {
            this.DisplayMessage = "Load NoofMonths Error";
            Logger.ErrorLog("AddEditDocumentViewModel:: SetNoofMonths" + error.stack);
        }
    }
    //#endregion

    static GetPrimarkyKey(CostCenterID: number, CCName: boolean = false): string {
        if (CostCenterID == 2)
            return "AccountID";
        else if (CostCenterID == 3)
            return "ProductID";
        else {
            if (CCName)
                return "CCNID" + (CostCenterID - 50000);
            else
                return "NodeID";
        }
    }
    /***
        bool OrganizationVisibility
        {
            get;
            set;
        }
        [JsonIgnore]
        ICampaignOrganizationViewModel CampaignOrganization
        {
            get;
            set;
    
        }
    ***/
    ViewOrganizationViewModel: any = null;// IViewOrganizationViewModel
    /***
        private bool _CasesContactVisibility;
        bool CasesContactVisibility
        {
            get
            {
                return _CasesContactVisibility;
            }
            set
            {
                if (value == _CasesContactVisibility)
                    return;
                _CasesContactVisibility = value;
    
                base.OnPropertyChanged("CasesContactVisibility");
            }
        }
    
        protected override OnDispose()
        {
            if (this.ScreenObject.IsRefLCTR)
                return;
            if (_ScreenObject != null)
            {
                PoleDisplayMessage(4, null);
                this.ScreenObject.LoadEditCallBack.UnSubscribe();
                this.ScreenObject.ReferenceCallBack = null;
                this.ScreenObject.ClearCallBack = null;
                this.ScreenObject.ShowQuickViewCallBack = null;
                this.ScreenObject.Dispose();
                ScreenObject = null;
            }
    
            SelectedCase = null;
            SelectedHistoryRow = null;
            SelectedRow = null;
            SelectionChanged = null;
    
    
            SaveCallBack = null;
            if (PoleDisplaytimer != null)
                PoleDisplaytimer.Stop();
            PoleDisplaytimer = null;
    
            if (timerDraft != null)
                timerDraft.Stop();
            timerDraft = null;
            if (t != null)
                t.Stop();
            t = null;
    
            base.OnDispose();
            //GC.Collect();
            //GC.WaitForPendingFinalizers();
            //GC.Collect();
        }
    ***/
    //#region License
    HideButtons(strKey: string) {
        if (strKey == "BarcodePrint") {
            if (BaseService.SessionManager.LicenseSettings.ContainsKey("Barcode") && BaseService.SessionManager.LicenseSettings["Barcode"].toUpperCase() == "FALSE")
                this.ButtonBarcode.Enable = this.ButtonBarcode.Visible = false;
            else if (BaseService.SessionManager.HideUnathorizedAccess)
                this.ButtonBarcode.Enable = this.ButtonBarcode.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "BarcodePrint");
            else
                this.ButtonBarcode.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "BarcodePrint");
        }
        else if (strKey == "Save&Barcode") {
            if (BaseService.SessionManager.LicenseSettings.ContainsKey("Barcode") && BaseService.SessionManager.LicenseSettings["Barcode"].toUpperCase() == "FALSE")
                this.ButtonSaveandBarcode.Enable = this.ButtonSaveandBarcode.Visible = false;
            else if (BaseService.SessionManager.HideUnathorizedAccess)
                this.ButtonSaveandBarcode.Enable = this.ButtonSaveandBarcode.Visible = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Barcode");
            else
                this.ButtonSaveandBarcode.Enable = BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Save&Barcode");
        }
    }
    //#endregion
    ShowPrintDialog: boolean = true;
    /***
        #region Print Methods
       
        public VoucherPrinter oPrint = null;
        MultiVoucherPrinter oMultiPrint = null;
        BarCodePrinter oBarcodePrint = null;
        System.Windows.Forms.PrintDialog oPrintPagesDialog;
        System.Windows.Forms.PrintPreviewDialog oPrintPreviewDialog;***/
    IsExportPrint = false;
    sXpsFileName = "";
    drSelPrintLayout = null;
    dsTotLayouts = null;
    iLayCnt = 0;
    IsForEMail = false;
    PrintCallBack
    PrintVoucher(IsPreview: boolean, SeqNoList: string, IsEditDocPrint: boolean, ParamsXML: string, iVersionNo: number = -1, drSelectedLayout: any = null, IsExport = false, sXpsFileName = "", IsForEMail: boolean = false, ParentObj = null, isBluetoothPrint = false): string {

        this.IsForEMail = IsForEMail;
        /**   oPrint = null;
           oMultiPrint = null; */
        let ViewModel: AddEditDocumentViewModel = this;
        ViewModel.DisplayMessage = "";
        let CostCenterID: number = ViewModel.CostCenterID;
        let IsInventoryVoucher: boolean = ViewModel.IsInventoryVoucher;
        if (!Util.IsEmpty(ParamsXML)) {
            let xDoc: XmlDocument = new XmlDocument();
            xDoc.LoadXml(ParamsXML);
            if (xDoc.DocumentElement.attributes["CostCenterID"] != null)
                CostCenterID = parseInt(xDoc.DocumentElement.attributes["CostCenterID"].value);
            if (xDoc.DocumentElement.attributes["IsInventoryVoucher"] != null)
                IsInventoryVoucher = xDoc.DocumentElement.attributes["IsInventoryVoucher"].value == "1" ? true : false;
        }
        if (!Util.IsEmpty(SeqNoList) && SeqNoList != "0") {
            if (IsEditDocPrint) {
                if (ViewModel.StatusID == 376 && !BaseService.SessionManager.IsActionAssigned(this.CostCenterID, "Print/Export Cancelled")) {
                    return "Documents is cancelled";

                }
                if (ViewModel.StatusID == 371 && ViewModel.DoNotPrintUnApprovedDocuments && !IsPreview)
                    return "Un-Approved Documents not allowed to print";

                if (ViewModel.LineWiseApproval) {
                    let IsUnApproved = false, IsRejected = false, IsApproved = false;
                    ViewModel.GRIDTABLE.forEach(dr => {
                        if (dr["DocDetailsID"] != null && parseInt(dr["DocDetailsID"]) > 0) {
                            switch (dr["StatusID"].toString()) {
                                case "371":
                                    IsUnApproved = true;
                                    break;
                                case "372":
                                    IsRejected = true;
                                    break;
                                case "441":
                                    IsApproved = true;
                                    break;
                            }
                        }
                    });
                    if (IsUnApproved && ViewModel.DoNotPrintUnApprovedDocuments && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Un-Approved"))
                        return "Un-Approved documents not allowed to print";

                    if (IsApproved && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Approved"))
                        return "Approved documents not allowed to print";

                    if (IsRejected && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Rejected"))
                        return "Rejected documents not allowed to print";
                }
                else {
                    if (ViewModel.StatusID == 371 && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Un-Approved"))
                        return "Un-Approved documents not allowed to print";

                    if (ViewModel.StatusID == 441 && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Approved"))
                        return "Approved documents not allowed to print";

                    if (ViewModel.StatusID == 372 && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Rejected"))
                        return "Rejected documents not allowed to print";
                }
            }

            let NodeNo = 0;
            let param = new Dictionary<any>();
            if (!SeqNoList.Contains(','))
                NodeNo = Util.Int(SeqNoList);
            let drPrintLayout: any = null;
            let dsLayout = VoucherExportExcel.GetLocationPrintLayouts(CostCenterID, 0, NodeNo);
            if (this.IsExportPrint) {
                drPrintLayout = drSelectedLayout;
            }
            else {
                if (ViewModel.CashDrwerPrintID != 0) {
                    for (let i = dsLayout.Tables[0].length - 1; i >= 0; i--) {
                        if (parseInt(dsLayout.Tables[0][i]["DocPrintLayoutID"]) != ViewModel.CashDrwerPrintID)
                            dsLayout.Tables[0].RemoveAt(i);
                    }
                }

                if (dsLayout == null || dsLayout.Tables[0].length == 0) {
                    return BaseService.GetResource("Err_PrintLayoutNotDefined");
                }

                let ShowCopies = false;
                if (dsLayout.Tables[0].length == 1 && dsLayout.Columns[0].Contains("Copies") && dsLayout.Tables[0][0]["Copies"] != null && ViewModel.CashDrwerPrintID == 0) {
                    if (parseInt(dsLayout.Tables[0][0]["Copies"]) > 0)
                        ShowCopies = true;
                }
                this.iLayCnt = dsLayout.Tables[0].length;
                if (this.ScreenObject.Preferences.ContainsKey("AskForVoucherPrintFormat") && this.ScreenObject.Preferences["AskForVoucherPrintFormat"].toUpperCase() != "TRUE")
                    drPrintLayout = dsLayout.Tables[0][0];
                else if (dsLayout.Tables[0].length > 1 || ShowCopies)//If More than one layout eixts
                {
                    this.bDSExists = false;
                    this.sDSCUserName = "";
                    this.oDSImg = null;

                    let oVoucherPrintDialog = new VPTDialogViewModel(dsLayout.Tables[0]);
                    // let DocID:any=this.DocID.toString();
                    let DocID: any = NodeNo > 0 ? NodeNo : this.DocID;
                    BaseService.page.ShowDialog(oVoucherPrintDialog, VPTDialogComponent, { ShowCenter: true }, () => {
                        if (oVoucherPrintDialog.IsOkClicked) {
                            // this.bDSExists = oVoucherPrintDialog.bDSExists;
                            this.sDSCUserName = oVoucherPrintDialog.sDSCUserName;
                            //this.oDSImg = oVoucherPrintDialog.oDSImg;
                            drPrintLayout = oVoucherPrintDialog.SelectedRow;
                        }
                        if (drPrintLayout != null) {
                            let ExportType = oVoucherPrintDialog.IsExcelChecked ? "EXCEL" : "PDF";
                            BaseService.report.ExportVPT(CostCenterID, DocID, parseInt(drPrintLayout["DocPrintLayoutID"]), ExportType, this.IsInventoryVoucher, param, ParamsXML).subscribe(
                                (response: any) => {
                                    if (ParentObj)
                                        ParentObj.DisplayMessage = "";
                                    console.log(response);
                                    //BaseService.SessionManager.Download(response.FileName, "abcd")

                                    if (isBluetoothPrint) {
                                        let url = BaseService.SessionManager.config.apiURL + "Attachments/" + response.FileName
                                        if (this.IsNativeMobile) {
                                            Browser.open({ url: 'pact-star-print://url=' + url, isPDF: false,isExport:false });

                                        } else {
                                            setTimeout(() => {
                                                window.open('pact-star-print://url=' + url, '_blank')
                                            });
                                        }
                                    } else {
                                        BaseService.SessionManager.printTab(response.FileName);
                                        if (Util.IsEmpty(response.Message) && !Util.IsEmpty(response.FileName))
                                            this.DisplayMessage = "Printed Sucessfully";
                                    }
                                    let AuditprintType: number;
                                    if (IsPreview)//1-Preview,2-Print,3-Export,4-ReportView
                                        AuditprintType = 1;
                                    else
                                        AuditprintType = 2;
                                    BaseService.common.setAuditPrint(5, this.CostCenterID, this.DocID, drPrintLayout["DocPrintLayoutID"], AuditprintType, "");
                                },
                                (error) => {
                                    if (ParentObj)
                                        ParentObj.DisplayMessage = "Error in Preview";

                                    if (error.error != undefined && !Util.IsEmpty(error.error.Message))
                                        this.DisplayMessage = error.error.Message;
                                    console.log(error);
                                }
                            );
                        }
                    });
                    /***   ShellWindowViewModel.Instance().PopViewModel = oVoucherPrintDialog;
                     if (oVoucherPrintDialog.IsOkClicked)
                        drPrintLayout = oVoucherPrintDialog.SelectedRow;***/
                }
                else {
                    drPrintLayout = dsLayout.Tables[0][0];
                }
            }

            this.dsTotLayouts = dsLayout;
            this.drSelPrintLayout = drPrintLayout;

            if (drPrintLayout != null) {
                BaseService.report.ExportVPT(this.CostCenterID, SeqNoList, parseInt(drPrintLayout["DocPrintLayoutID"]), "PDF", this.IsInventoryVoucher, param, ParamsXML).subscribe(
                    (response: any) => {
                        if (ParentObj)
                            ParentObj.DisplayMessage = "";

                        if (IsExport) {
                            BaseService.SessionManager.Download(response.FileName, "abcd")
                            if (Util.IsEmpty(response.Message) && !Util.IsEmpty(response.FileName))
                                this.DisplayMessage = "Exported Successfully";
                        }
                        else {
                            BaseService.SessionManager.printTab(response.FileName);
                            if (Util.IsEmpty(response.Message) && !Util.IsEmpty(response.FileName))
                                this.DisplayMessage = "Printed Successfully";
                        }

                        let AuditprintType: number;
                        if (IsPreview)//1-Preview,2-Print,3-Export,4-ReportView
                            AuditprintType = 1;
                        else
                            AuditprintType = 2;
                        BaseService.common.setAuditPrint(5, this.CostCenterID, this.DocID, drPrintLayout["DocPrintLayoutID"], AuditprintType, "");
                    },
                    (error: any) => {
                        if (ParentObj)
                            ParentObj.DisplayMessage = error;
                        if (error.error != undefined && !Util.IsEmpty(error.error.Message))
                            this.DisplayMessage = error.error.Message;
                        console.log(error);
                    }
                );
            }
               /***
            if (drPrintLayout != null)
            {
                this.ShowPrintDialog = true;
                let arrSeqNos:string[] = SeqNoList.split(',');

                let strTemp = "";
                let PrintList:any[] = [];
                let PrintContinue:any[] = [];
                PrintContinue.push(0);
                strTemp = drPrintLayout["DocPrintLayoutID"].toString();
              let DefaultView:any=[]
                if (dsLayout.Tables[1].length > 0)
                {
                    DefaultView=dsLayout.Tables[1].filter(x=>x.DocPrintLayoutID == drPrintLayout["DocPrintLayoutID"].toString());
                    DefaultView.forEach (drv=>
                    {
                        strTemp += "," + drv["PrintOtherVPT"].toString();
                        PrintContinue.push(parseInt(drv["PrintContinue"]));
                    });
                }

                let dsTemplates:any = VoucherPrinter.GetLayoutTemplates(strTemp, CostCenterID, 0);

                for(let i = 0; i < dsTemplates.Tables[0].length; i++)
                    PrintList.push(dsTemplates.Tables[0][i]);

                let iCopies = 0;
                let IsFirstDocument:boolean = true;
                System.Drawing.Printing.PrinterSettings firstPrinter = null;
                if (this.ScreenObject.Preferences.ContainsKey("PreviewFromReport"))
                {
                    IsFirstDocument = false;
                    ShowPrintDialog = false;
                }
                if (PrintList.length == 1)
                {
                    foreach (let SeqNo in arrSeqNos)
                    {
                        if (SeqNo != "0" && SeqNo != "-1")
                            oPrint = new VoucherPrinter(CostCenterID, IsInventoryVoucher, parseInt(SeqNo), PrintList[0], iVersionNo, IsForEMail);
                        else
                        {
                            oPrint = new VoucherPrinter(CostCenterID, IsInventoryVoucher, PrintList[0], GetTemporaryPrintData(ViewModel), true, IsForEMail);
                            oPrint.DocSeqNo = parseInt(SeqNo);
                            oPrint.LayoutID = parseInt(PrintList[0]["DocPrintLayoutID"]);
                        }

                        if (oPrint.ErrorMessage.length == 0)
                        {
                            if (IsPreview)//PREVIEW DOCUMENT
                            {
                                if (IsFirstDocument)
                                    ShowPrintDialog = oPrint.oBody.AskPrinter;

                                ShowPrintPreview();
                            }
                            else//PRINT DOCUMENT
                            {
                                if (IsFirstDocument)
                                {
                                    IsFirstDocument = false;
                                    ShowPrintDialog = oPrint.oBody.AskPrinter;
                                }

                                if (firstPrinter != null)//If default selected printer changed
                                    oPrint.Document.PrinterSettings = firstPrinter;
                                oPrint.CalculatePages();
                                tsBtnPrint_Click(null, null);
                                if (arrSeqNos.length > 1)
                                {
                                    firstPrinter = oPrint.Document.PrinterSettings;
                                    ShowPrintDialog = false;
                                }
                            }
                        }
                    }
                    return oPrint.ErrorMessage;
                }
                else
                {
                    /***
                    VPBody oBody = VPBody.FromXml(PrintList[0]["Preferences"]);
                    if (oBody.OtherVPTsSeperate)
                    {
                        string SelectPrinterName = "";
                        System.Drawing.Printing.PrinterSettings[] arrfirstPrinter = new System.Drawing.Printing.PrinterSettings[PrintList.length];
                        foreach (let SeqNo in arrSeqNos)
                        {
                            for(let l = 0; l < PrintList.length; l++)
                            {
                                oPrint = new VoucherPrinter(CostCenterID, IsInventoryVoucher, parseInt(SeqNo), PrintList[l], iVersionNo, IsForEMail);
                                if (oPrint.ErrorMessage.length == 0)
                                {
                                    if (IsPreview)//PREVIEW DOCUMENT
                                    {
                                        if (IsFirstDocument)
                                            ShowPrintDialog = oPrint.oBody.AskPrinter;

                                        if (SelectPrinterName.length > 0 && Util.IsEmpty(oPrint.oBody.DefaultPrinter))
                                            oPrint.Document.PrinterSettings.PrinterName = SelectPrinterName;

                                        if (!ShowPrintPreview())
                                            return "";

                                        if (IsFirstDocument && ShowPrintDialog)
                                            SelectPrinterName = oPrint.Document.PrinterSettings.PrinterName;
                                    }
                                    else//PRINT DOCUMENT
                                    {
                                        if (IsFirstDocument)
                                            ShowPrintDialog = oPrint.oBody.AskPrinter;

                                        if (arrfirstPrinter[l] != null)//If default selected printer changed
                                            oPrint.Document.PrinterSettings = arrfirstPrinter[l];
                                        else if (SelectPrinterName.length > 0 && Util.IsEmpty(oPrint.oBody.DefaultPrinter))
                                            oPrint.Document.PrinterSettings.PrinterName = SelectPrinterName;

                                        oPrint.CalculatePages();
                                        if (!tsBtnPrint_Click(null, null))
                                            return "";
                                        arrfirstPrinter[l] = oPrint.Document.PrinterSettings;
                                        if (IsFirstDocument && ShowPrintDialog)
                                            SelectPrinterName = oPrint.Document.PrinterSettings.PrinterName;
                                    }
                                }
                            }

                            if (IsFirstDocument)
                            {
                                IsFirstDocument = false;
                                ShowPrintDialog = false;
                            }
                        }
                    }
                    else
                    {
                        foreach (let SeqNo in arrSeqNos)
                        {
                            if (SeqNo != "0")
                                oMultiPrint = new MultiVoucherPrinter(CostCenterID, IsInventoryVoucher, parseInt(SeqNo), PrintList, PrintContinue, IsForEMail);

                            if (oMultiPrint != null && oMultiPrint.ErrorMessage.length == 0)
                            {
                                if (IsPreview)//PREVIEW DOCUMENT
                                {
                                    if (IsFirstDocument)
                                        ShowPrintDialog = oMultiPrint.VPT[0].oBody.AskPrinter;
                                    ShowPrintPreview();
                                }
                                else//PRINT DOCUMENT
                                {
                                    if (IsFirstDocument)
                                    {
                                        IsFirstDocument = false;
                                        ShowPrintDialog = oMultiPrint.VPT[0].oBody.AskPrinter;
                                    }
                                    oMultiPrint.CalculatePages();
                                    tsBtnPrint_Click(null, null);
                                    if (arrSeqNos.length > 1)
                                        ShowPrintDialog = false;
                                }
                            }
                        }
                    }
                    if (oMultiPrint != null)
                        return oMultiPrint.ErrorMessage;***
                }

            }
       ***/ }
        return "";
    }
    /***
        bool ShowPrintPreview()
        {
            if (oPrint != null)
                oPrint.CalculatePages();
            else
                oMultiPrint.CalculatePages();
    
            if (SetupThePrinting())
            {
                if (oPrintPreviewDialog == null)
                {
                    oPrintPreviewDialog = new System.Windows.Forms.PrintPreviewDialog();
                    oPrintPreviewDialog.PrintPreviewControl.AutoZoom = false;
                    oPrintPreviewDialog.PrintPreviewControl.Zoom = 1;

                    System.Windows.Forms.ToolStripButton tsBtnPreviewPrint = new System.Windows.Forms.ToolStripButton();
                    tsBtnPreviewPrint.DisplayStyle = System.Windows.Forms.ToolStripItemDisplayStyle.Image;
                    tsBtnPreviewPrint.Image = ((System.Windows.Forms.ToolStrip)(oPrintPreviewDialog.Controls[1])).Items["printToolStripButton"].Image;
                    tsBtnPreviewPrint.ImageTransparentColor = System.Drawing.Color.Magenta;
                    tsBtnPreviewPrint.Name = "Print";
                    tsBtnPreviewPrint.Text = "&Print";
                    tsBtnPreviewPrint.Click += new EventHandler(tsBtnPreviewPrint_Click);

                    if ((oPrintPreviewDialog.Controls.length > 0))
                    {
                        ((System.Windows.Forms.ToolStrip)oPrintPreviewDialog.Controls[1]).Items.Insert(0, tsBtnPreviewPrint);
                        ((System.Windows.Forms.ToolStrip)(oPrintPreviewDialog.Controls[1])).Items["printToolStripButton"].Visible = false;
                    }
                }
                if (oPrint != null)
                {
                    oPrint.IsPreview = false;
                    if (oPrint.mColumnPoints.length > 1)
                    {
                        int ActualPages = (oPrint.lstRowNos.length) / oPrint.mColumnPoints.length;
                        if (ActualPages == 0)
                            ActualPages = 1;
                        oPrint.mColumnPoint = (oPrint.Document.PrinterSettings.FromPage - 1) / ActualPages;
                    }
                    oPrintPreviewDialog.Document = oPrint.Document;
                }
                else
                {
                    oMultiPrint.currentVPT = 0;
                    oMultiPrint.IsPreview = false;
    
                    foreach (let vpt in oMultiPrint.VPT)
                    {
                        vpt.IsPreview = false;
                        if (vpt.mColumnPoints.length > 1)
                        {
                            int ActualPages = (vpt.lstRowNos.length) / vpt.mColumnPoints.length;
                            if (ActualPages == 0)
                                ActualPages = 1;
                            vpt.mColumnPoint = (oMultiPrint.Document.PrinterSettings.FromPage - 1) / ActualPages;
                        }
                    }
                    oPrintPreviewDialog.Document = oMultiPrint.Document;
                }
                oPrintPreviewDialog.WindowState = System.Windows.Forms.FormWindowState.Maximized;
                oPrintPreviewDialog.ShowDialog();
                return true;
            }
            else
            {
                return false;
            }
        }
    
        void tsBtnPreviewPrint_Click(object sender, EventArgs e)
        {
            int iCount = 1;
            if (oPrint != null)
            {
                oPrint.IsPreviewAudit = false;
                oPrint.IsPreview = false;

                if (IsExportPrint)
                {
                    if (sXpsFileName != "")
                        oPrint.sXpsFileName = sXpsFileName;

                    oPrint.IsExportPrint = true;
                }

                if (iCopies == 0)
                    iCopies = oPrint.Document.PrinterSettings.Copies;
                oPrint.Document.PrinterSettings.Copies = 1;
                while (iCount <= iCopies)
                {
                    oPrint.PrintDocument();
                    iCount++;
                }
            }
            else if (oMultiPrint != null)
            {
                if (IsExportPrint)
                {
                    if (sXpsFileName != "")
                        oMultiPrint.sXpsFileName = sXpsFileName;

                    oMultiPrint.IsExportPrint = true;
                }

                if (iCopies == 0)
                    iCopies = oMultiPrint.Document.PrinterSettings.Copies;
                oMultiPrint.Document.PrinterSettings.Copies = 1;
                while (iCount <= iCopies)
                {
                    oMultiPrint.PrintDocument();
                    iCount++;
                }
            }
        }

        int iCopies = 0;
        bool tsBtnPrint_Click(object sender, EventArgs e)
        {
            if (SetupThePrinting())
            {
                //if (!BaseService.SessionManager.IsActionAssigned(43, "Allow Re-Print") && oPrintPagesDialog.PrinterSettings.Copies > 1)
                //    oPrintPagesDialog.PrinterSettings.Copies = 1;
                int iCount = 1;
                if (oPrint != null)
                {
                    if (IsExportPrint)
                    {
                        if (sXpsFileName != "")
                            oPrint.sXpsFileName = sXpsFileName;

                        oPrint.IsExportPrint = true;
                    }
                    if (iCopies == 0)
                        iCopies = oPrint.Document.PrinterSettings.Copies;
                    oPrint.Document.PrinterSettings.Copies = 1;
                    while (iCount <= iCopies)
                    {
                        oPrint.PrintDocument();
                        iCount++;
                    }
                }
                else
                {
                    if (IsExportPrint)
                    {
                        if (sXpsFileName != "")
                            oMultiPrint.sXpsFileName = sXpsFileName;

                        oMultiPrint.IsExportPrint = true;
                    }
                    if (iCopies == 0)
                        iCopies = oMultiPrint.Document.PrinterSettings.Copies;
                    oMultiPrint.Document.PrinterSettings.Copies = 1;
                    while (iCount <= iCopies)
                    {
                        oMultiPrint.PrintDocument();
                        iCount++;
                    }
                }
                return true;
            }
            else
            {
                return false;
            }
        }
    
         bool SetupThePrinting()
        {
            if (oPrintPagesDialog == null)
                oPrintPagesDialog = new System.Windows.Forms.PrintDialog();// FrmPrintDialog(0, 0, oPrint.oBody.DefaultPrinter);

            if (oPrint != null)
            {
                oPrintPagesDialog.Document = oPrint.Document;
                oPrintPagesDialog.AllowSomePages = true;
            }
            else
            {
                oPrintPagesDialog.AllowSomePages = true;
                oPrintPagesDialog.Document = oMultiPrint.Document;
            }

            //string CurrentPrinter = oPrintPagesDialog.PrinterSettings.PrinterName;
            //int PaperSize = oPrintPagesDialog.PrinterSettings.DefaultPageSettings.PaperSize.Width;
            //int PaperHeight = oPrintPagesDialog.PrinterSettings.DefaultPageSettings.PaperSize.Height;

            if (IsExportPrint)
            {
                if (oPrint != null)
                {
                    if (sXpsFileName != "")
                        oPrint.sXpsFileName = sXpsFileName;

                    oPrint.IsExportPrint = true;

                    if (!oPrint.oBody.FitToPage)
                        oPrint.CalculatePages(true);
                }
                else
                {
                    oMultiPrint.CalculatePages(true);
                }
                return true;
            }
            else
            {
                if (ShowPrintDialog)
                {
                    if (oPrintPagesDialog.ShowDialog() != System.Windows.Forms.DialogResult.OK)
                        return false;
                    else
                    {
                        if (oPrint != null)
                        {
                            oPrint.sXpsFileName = "";

                            if (!oPrint.oBody.FitToPage)
                                oPrint.CalculatePages(true);
                        }
                        else
                            oMultiPrint.CalculatePages(true);
                    }
                }
                return true;
            }

            //CODE COMMENTED : If AskPrinter=flase, then no.of copies option not working
            //else
            //    oPrintPagesDialog.PrinterSettings.Copies = 1;

            //return true;
        }
    
        DataSet GetTemporaryPrintData(AddEditDocumentViewModel ViewModel)
        {
            let dsGrid = new DataSet();
            DataTable dtData = ViewModel.GRIDTABLE.Clone();
            if (ViewModel.CashDrwerPrintID != 0)
            {
                let drNew = dtData.NewRow();
                if (dtData.Columns.Contains("ProductName"))
                    drNew["ProductName"] = "CASH DRAWER PRINT";
                dtData.Rows.push(drNew);
            }
            else if (ViewModel.GRIDTABLE.Columns.Contains("ProductID_Key"))
            {
                foreach (let dr in ViewModel.GRIDTABLE.Rows)
                {
                    if (dr.RowState != DataRowState.Deleted && dr["ProductID_Key"] != System.null)
                    {
                        let drNew = dtData.NewRow();
                        for(let i = 0; i < dr.ItemArray.length; i++)
                        {
                            drNew[i] = dr[i];
                        }
                        dtData.Rows.push(drNew);
                    }
                }
            }
            dsGrid.Tables.push(dtData);
            return dsGrid;
        }
    
        //FOR BARCODE PRINT
        string PrintBarcode(string SeqNoList, string LineID)
        {
            AddEditDocumentViewModel ViewModel = this;
            if (SeqNoList != "0" && !Util.IsEmpty(SeqNoList))
            {
                let drBarcodeLayout = null;
                let dsLayout = BarCodePrinter.GetBarcodeLayouts(ViewModel.DocumentID, !ViewModel.IsPurchase);
                if (dsLayout == null || dsLayout.Tables[0].length == 0)
                {
                    return BaseService.GetResource("Err_PrintLayoutNotDefined");
                }
    
                if (dsLayout.Tables[0].length > 1)//If More than one layout eixts
                {
                    //if (dsLayout.Tables[0][0]["IsDefault"].toString() == "True")
                    //{
                    //    drBarcodeLayout = dsLayout.Tables[0][0];
                    //}
                    //else
                    {
                        VPTDialogViewModel oVoucherPrintDialog = new VPTDialogViewModel(dsLayout.Tables[0]);
                        ShellWindowViewModel.Instance().PopViewModel = oVoucherPrintDialog;
                        if (oVoucherPrintDialog.IsOkClicked)
                            drBarcodeLayout = oVoucherPrintDialog.SelectedRow;
                    }
                }
                else
                    drBarcodeLayout = dsLayout.Tables[0][0];
    
                if (drBarcodeLayout != null)
                {
                    ShowPrintDialog = true;
                    // let arrSeqNos = SeqNoList.split(',');
    
                    // if (arrSeqNos.length > 1)
                    //     ShowPrintDialog = false;
    
                    // foreach (let SeqNo in arrSeqNos)
                    // {
                    //     oBarcodePrint = new BarCodePrinter(drBarcodeLayout, SeqNo, false);
                    //     if (oBarcodePrint.ErrorMessage.length == 0)
                    //     {
                    //         oBarcodePrint.Print();
                    //         if (oBarcodePrint.ErrorMessage.length > 0)
                    //             return oBarcodePrint.ErrorMessage;
                    //     }
                    // }
    
                    oBarcodePrint = new BarCodePrinter(drBarcodeLayout, SeqNoList, LineID, false);
                    if (oBarcodePrint.ErrorMessage.length == 0)
                    {
                        oBarcodePrint.Print();
                        if (oBarcodePrint.ErrorMessage.length > 0)
                            return oBarcodePrint.ErrorMessage;
                    }
    
                    return oBarcodePrint.ErrorMessage;
                }
            }
            return "";
        }
    
        #endregion
        ***/

    public async ExportBarcode(SeqNoList, LineID) {
        if (SeqNoList != "0" && !Util.IsEmpty(SeqNoList)) {
            let drBarcodeLayout = null;
            let IsBarCodePrinter: boolean = false;
            let dsLayout = await BaseService.report.GetBarcodeLayouts(this.DocumentID, !this.IsPurchase);
            if (dsLayout == null || dsLayout.Tables[0].length == 0) {
                return BaseService.GetResource("Err_PrintLayoutNotDefined");
            }

            if (dsLayout.Tables[0].length > 1)//If More than one layout eixts
            {
                let oVoucherPrintDialog: VPTDialogViewModel = new VPTDialogViewModel(dsLayout.Tables[0]);
                await BaseService.page.openDialog(oVoucherPrintDialog, VPTDialogComponent, { ShowCenter: true, NoWidth: true });
                if (oVoucherPrintDialog.IsOkClicked) {
                    drBarcodeLayout = oVoucherPrintDialog.SelectedRow;
                }
            }
            else
                drBarcodeLayout = dsLayout.Tables[0][0];

            if (drBarcodeLayout != null) {
                BaseService.report.ExportBarcode(this.DocumentID, !this.IsPurchase, this.ScreenObject.DocID, parseInt(drBarcodeLayout["BarcodeLayoutID"])).subscribe(
                    (response: any) => {
                        console.log(response);
                        BaseService.SessionManager.printTab(response.FileName);
                        if (!Util.IsEmpty(response.Message) && !Util.IsEmpty(response.FileName))
                            this.DisplayMessage = "Error in Print";
                        else
                            this.DisplayMessage = response.Message;

                        // BaseService.SessionManager.Download(response.FileName, "Print")
                        // if (Util.IsEmpty(response.Message) && !Util.IsEmpty(response.FileName))
                        //     this.DisplayMessage = "Exported Successfully";
                    },
                    (error) => {
                        console.log(error);
                    }
                );
            }

        }
        return '';
    }

    //#region "MobilePDF Print"
    /***
            string sPDFPath = "";
            public string PrintVoucherMobile(bool IsPreview, string SeqNoList, bool IsEditDocPrint, string ParamsXML, string PDFPrintPath, int iVersionNo = -1, int DocPrintLayoutID = 0)
            {
                oPrint = null;
                oMultiPrint = null;
                Logger.DebugLog("PrintVoucherMobile : Start");
                AddEditDocumentViewModel ViewModel = this;
                ViewModel.DisplayMessage = '';
                int CostCenterID = ViewModel.CostCenterID;
                bool IsInventoryVoucher = ViewModel.IsInventoryVoucher;
                sPDFPath = PDFPrintPath;
                if (!Util.IsEmpty(ParamsXML))
                {
                    XmlDocument xDoc = new XmlDocument();
                    xDoc.LoadXml(ParamsXML);
                    if (xDoc.DocumentElement.attributes["CostCenterID"] != null)
                        CostCenterID = parseInt(xDoc.DocumentElement.attributes["CostCenterID"].Value);
                    if (xDoc.DocumentElement.attributes["IsInventoryVoucher"] != null)
                        IsInventoryVoucher = xDoc.DocumentElement.attributes["IsInventoryVoucher"].Value == "1" ? true : false;
                }
                if (!Util.IsEmpty(SeqNoList) && SeqNoList != "0")
                {
                    if (IsEditDocPrint)
                    {
                        if (ViewModel.StatusID == 376)
                        {
                            return "Documents is cancelled";
    
                        }
                        if (ViewModel.StatusID == 371 && ViewModel.DoNotPrintUnApprovedDocuments && !IsPreview)
                            return "Un-Approved Documents not allowed to print";
    
                        if (ViewModel.LineWiseApproval)
                        {
                            bool IsUnApproved = false, IsRejected = false, IsApproved = false;
                            foreach (DataRow dr in ViewModel.GRIDTABLE.Rows)
                            {
                                if (dr["DocDetailsID"] != null && parseInt(dr["DocDetailsID"]) > 0)
                                {
                                    switch (dr["StatusID"].toString())
                                    {
                                        case "371":
                                            IsUnApproved = true;
                                            break;
                                        case "372":
                                            IsRejected = true;
                                            break;
                                        case "441":
                                            IsApproved = true;
                                            break;
                                    }
                                }
                            }
                            if (IsUnApproved && ViewModel.DoNotPrintUnApprovedDocuments && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Un-Approved"))
                                return "Un-Approved documents not allowed to print";
    
                            if (IsApproved && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Approved"))
                                return "Approved documents not allowed to print";
    
                            if (IsRejected && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Rejected"))
                                return "Rejected documents not allowed to print";
                        }
                        else
                        {
                            if (ViewModel.StatusID == 371 && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Un-Approved"))
                                return "Un-Approved documents not allowed to print";
    
                            if (ViewModel.StatusID == 441 && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Approved"))
                                return "Approved documents not allowed to print";
    
                            if (ViewModel.StatusID == 372 && !IsPreview && !BaseService.SessionManager.IsActionAssigned(ViewModel.CostCenterID, "Print/Export Rejected"))
                                return "Rejected documents not allowed to print";
                        }
                    }
    
                    long NodeNo = 0;
                    if (!SeqNoList.Contains(','))
                        long.TryParse(SeqNoList, out NodeNo);
    
                    DataRow drPrintLayout = null;
                    DataSet dsLayout = VoucherPrinter.GetLocationPrintLayouts(CostCenterID, 0, NodeNo);
                    if (ViewModel.CashDrwerPrintID != 0)
                    {
                        for(let i = dsLayout.Tables[0].length - 1; i >= 0; i--)
                        {
                            if (parseInt(dsLayout.Tables[0][i]["DocPrintLayoutID"]) != ViewModel.CashDrwerPrintID)
                                dsLayout.Tables[0].Rows.RemoveAt(i);
                        }
                    }
    
                    if (dsLayout == null || dsLayout.Tables[0].length == 0)
                    {
                        return BaseService.GetResource("Err_PrintLayoutNotDefined");
                    }
    
                    bool ShowCopies = false;
                    if (dsLayout.Tables[0].length == 1 && dsLayout.Columns[0].Contains("Copies") && dsLayout.Tables[0][0]["Copies"] != null && ViewModel.CashDrwerPrintID == 0)
                    {
                        if (parseInt(dsLayout.Tables[0][0]["Copies"]) > 0)
                            ShowCopies = true;
                    }
    
                    if (ScreenObject.Preferences.ContainsKey("AskForVoucherPrintFormat") && ScreenObject.Preferences["AskForVoucherPrintFormat"].toUpperCase() != "TRUE")
                        drPrintLayout = dsLayout.Tables[0][0];
                    else if (dsLayout.Tables[0].length > 1 || ShowCopies)//If More than one layout eixts
                    {
                        for(let t = 0; t < dsLayout.Tables[0].length; t++)
                        {
                            if (parseInt(dsLayout.Tables[0][t]["DocPrintLayoutID"]) == DocPrintLayoutID)
                            {
                                drPrintLayout = dsLayout.Tables[0][t];
                                break;
                            }
                        }
                    }
                    else
                        drPrintLayout = dsLayout.Tables[0][0];
    
                          dsTotLayouts = dsLayout;
                    drSelPrintLayout = drPrintLayout
                    
                    Logger.DebugLog("VPT:: PrintVoucherMobile LayoutID : " + DocPrintLayoutID.toString());
                    if (drPrintLayout != null)
                    {
                        ShowPrintDialog = true;
                        string[] arrSeqNos = SeqNoList.split(',');
    
                        string strTemp = "";
                        Array<DataRow> PrintList = new Array<DataRow>();
                        Array<int> PrintContinue = new Array<int>();
                        PrintContinue.push(0);
                        strTemp = drPrintLayout["DocPrintLayoutID"].toString();
    
                        if (dsLayout.Tables[1].length > 0)
                        {
                            dsLayout.Tables[1].DefaultView.RowFilter = "DocPrintLayoutID=" + drPrintLayout["DocPrintLayoutID"].toString();
                            foreach (DataRowView drv in dsLayout.Tables[1].DefaultView)
                            {
                                strTemp += "," + drv["PrintOtherVPT"].toString();
                                PrintContinue.push(parseInt(drv["PrintContinue"]));
                            }
                        }
    
                        DataSet dsTemplates = VoucherPrinter.GetLayoutTemplates(strTemp, CostCenterID, 0);
    
                        for(let i = 0; i < dsTemplates.Tables[0].length; i++)
                            PrintList.push(dsTemplates.Tables[0][i]);
    
                        iCopies = 0;
                        bool IsFirstDocument = true;
                        System.Drawing.Printing.PrinterSettings firstPrinter = null;
                        if (PrintList.length == 1)
                        {
                            foreach (var SeqNo in arrSeqNos)
                            {
                                if (SeqNo != "0" && SeqNo != "-1")
                                    oPrint = new VoucherPrinter(CostCenterID, IsInventoryVoucher, parseInt(SeqNo), PrintList[0], iVersionNo);
                                else
                                {
                                    oPrint = new VoucherPrinter(CostCenterID, IsInventoryVoucher, PrintList[0], GetTemporaryPrintData(ViewModel), true);
                                    oPrint.DocSeqNo = parseInt(SeqNo);
                                    oPrint.LayoutID = parseInt(PrintList[0]["DocPrintLayoutID"]);
                                }
    
                                if (oPrint.ErrorMessage.length == 0ReturnFormulaValue)
                                {
                                    if (IsFirstDocument)
                                    {
                                        IsFirstDocument = false;
                                        ShowPrintDialog = oPrint.oBody.AskPrinter;
                                    }
    
                                    if (firstPrinter != null)//If default selected printer changed
                                        oPrint.Document.PrinterSettings = firstPrinter;
                                    oPrint.CalculatePages();
                                    tsBtnMobilePrint_Click(null, null);
                                    if (arrSeqNos.length > 1)
                                    {
                                        firstPrinter = oPrint.Document.PrinterSettings;
                                        ShowPrintDialog = false;
                                    }
                                }
                            }
                            if (!Util.IsEmpty(oPrint.ErrorMessage))
                            {
                                return oPrint.ErrorMessage;
                            }
                            else
                            {
                                return oPrint.Document.PrinterSettings.PrintFileName;
                            }
                        }
                        else
                        {
                            VPBody oBody = VPBody.FromXml(PrintList[0]["Preferences"].toString());
                            if (oBody.OtherVPTsSeperate)
                            {
                                string SelectPrinterName = "";
                                System.Drawing.Printing.PrinterSettings[] arrfirstPrinter = new System.Drawing.Printing.PrinterSettings[PrintList.length];
                                foreach (var SeqNo in arrSeqNos)
                                {
                                    for(let l = 0; l < PrintList.length; l++)
                                    {
                                        oPrint = new VoucherPrinter(CostCenterID, IsInventoryVoucher, parseInt(SeqNo), PrintList[l], iVersionNo);
                                        if (oPrint.ErrorMessage.length == 0)
                                        {
                                            if (IsFirstDocument)
                                                ShowPrintDialog = oPrint.oBody.AskPrinter;
    
                                            if (arrfirstPrinter[l] != null)//If default selected printer changed
                                                oPrint.Document.PrinterSettings = arrfirstPrinter[l];
                                            else if (SelectPrinterName.length > 0 && Util.IsEmpty(oPrint.oBody.DefaultPrinter))
                                                oPrint.Document.PrinterSettings.PrinterName = SelectPrinterName;
    
                                            oPrint.CalculatePages();
                                            if (!tsBtnMobilePrint_Click(null, null))
                                                return '';
                                            arrfirstPrinter[l] = oPrint.Document.PrinterSettings;
                                            if (IsFirstDocument && ShowPrintDialog)
                                                SelectPrinterName = oPrint.Document.PrinterSettings.PrinterName;
    
                                        }
                                    }
    
                                    if (IsFirstDocument)
                                    {
                                        IsFirstDocument = false;
                                        ShowPrintDialog = false;
                                    }
                                }
                            }
                            else
                            {
                                foreach (var SeqNo in arrSeqNos)
                                {
                                    if (SeqNo != "0")
                                        oMultiPrint = new MultiVoucherPrinter(CostCenterID, IsInventoryVoucher, parseInt(SeqNo), PrintList, PrintContinue);
    
                                    if (oMultiPrint != null && oMultiPrint.ErrorMessage.length == 0)
                                    {
                                        if (IsFirstDocument)
                                        {
                                            IsFirstDocument = false;
                                            ShowPrintDialog = oMultiPrint.VPT[0].oBody.AskPrinter;
                                        }
                                        oMultiPrint.CalculatePages();
                                        tsBtnMobilePrint_Click(null, null);
                                        if (arrSeqNos.length > 1)
                                            ShowPrintDialog = false;
    
                                    }
                                }
                            }
                            if (oMultiPrint != null)
                            {
                                if (!Util.IsEmpty(oMultiPrint.ErrorMessage))
                                {
                                    Logger.DebugLog("VPT:: Error Print FileName : " + oPrint.ErrorMessage.toString());
                                    return oMultiPrint.ErrorMessage;
                                }
                                else
                                {
                                    Logger.DebugLog("VPT:: Print FileName : " + oPrint.ErrorMessage.toString());
                                    return oMultiPrint.Document.PrinterSettings.PrintFileName;
                                }
                            }
                        }
    
                    }
                }
                return '';
            }
            bool tsBtnMobilePrint_Click(object sender, EventArgs e)
            {
                if (SetupTheMobilePrinting())
                {
                    int iCount = 1;
                    if (oPrint != null)
                    {
                        if (iCopies == 0)
                            iCopies = 1;// oPrint.Document.PrinterSettings.Copies;
                        oPrint.Document.PrinterSettings.Copies = 1;
                        while (iCount <= iCopies)
                        {
                            oPrint.PrintMobileDocument(sPDFPath);
                            iCount++;
                        }
                    }
                    else
                    {
                        if (iCopies == 0)
                            iCopies = 1;// oMultiPrint.Document.PrinterSettings.Copies;
                        oMultiPrint.Document.PrinterSettings.Copies = 1;
                        while (iCount <= iCopies)
                        {
                            oMultiPrint.PrintMobileDocument(sPDFPath);
                            iCount++;
                        }
                    }
                    return true;
                }
                else
                {
                    return false;
                }
            }
            bool SetupTheMobilePrinting()
            {
                if (oPrint != null)
                {
                    if (!oPrint.oBody.FitToPage)
                        oPrint.CalculatePages(true);
                }
                else
                    oMultiPrint.CalculatePages(true);
    
                return true;
            }
    ***/
    //#endregion

    //#region "API"
    GenerateAPIRequest(Mode: number) {
        try {

            let ds: any = BaseService.document.GetDocumentMapFieldsDetail(this.CostCenterID, Mode);

            if (ds != null && ds.Tables.length > 0 && ds.Tables[0].length > 0) {
                let sResponse = "";
                /***let objPost = new APIPostingViewModel();
                for(let i = 0; i < ds.Tables[0].length; i++)
                {
                    sResponse = this.APICallRequest(CostCenterID, DocID, Convert.ToInt32(ds.Tables[0][i]["MapID"]), ds.Tables[0][i]["APIType"].ToString());
                }***/
            }
        }
        catch (error) {
            Logger.ErrorLog("GenerateAPIRequest::EXCEPTION GenerateAPIRequest()" + error.StackTrace + " " + error.Message);
        }
    }

    public APICallRequest(CCID, DID, MapID, APIType) {
        /***APIPostingViewModel objPost = new APIPostingViewModel();
        objPost.dsAPIDetails = new Document().GetAPIPostingDetails(CCID, DID, MapID, APIType);
        return objPost.CallAPI(DocID);***/
    }
    //#endregion

    //#region "EInv"
    GetEInv() {
        try {
            /***DataSet dsUBL = new DataSet();
                UblEInvoice ubl = new UblEInvoice();
                this.DisplayMessage = ubl.Create(dsUBL);
                this.MessageVisibility = true;
                ***/
        }
        catch (ex) {

        }
    }
    //#endregion

    public static GetTotalMonthsFrom(dt1: Date, dt2: Date) {
        let ed: Date = (dt1.Date() > dt2.Date()) ? dt2.Date() : dt1.Date();
        let ld: Date = (dt1 > dt2.Date()) ? dt1.Date() : dt2.Date();
        let Monthdiff = 1;
        while (ed.AddMonths(Monthdiff) <= ld) {
            Monthdiff++;
        }
        return Monthdiff;
    }

    public UpdateContractTerminationDate(dtDate: Date): string {
        let ValidMsg = "";
        ValidMsg = BaseService.common.ExecuteQuery_ReturnString("DOC071", Util.ParseDate(dtDate).ToString("dd/MMM/yyyy") + "~" + this.ScreenObject.CostCenterID + "~" + this.ScreenObject.DocID.toString());
        return ValidMsg;
    }

    //#region PAYROLL-

    //#region Shift Assign
    private SaveShiftAssign(): boolean {
        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                for (let j = 0; j < this.ScreenObject.ColumnSource.length; j++) {
                    if (this.ScreenObject.ColumnSource[j].Mandatory) {
                        if (!this.MandaotryValidation(i, j))
                            return false;
                    }
                }
            }
        }

        ///////

        let WorkflowID = 0;
        if (!this.LineWiseApproval)
            WorkflowID = this.GetWorkFlow(false, null);

        let RetVal = 0;

        let ObjArray = [];
        ObjArray.push(this.ScreenObject.CostCenterID);
        ObjArray.push(this.ScreenObject.DocID);
        ObjArray.push(this.ScreenObject.DocPrefix.ComboBox.Text); //DocPrefix
        ObjArray.push(this.ScreenObject.DocPrefix.TextBox.Text);
        ObjArray.push(this.ScreenObject.DocDate.Date); //DocDate
        ObjArray.push(this.ScreenObject.DocDate.Date); //DueDate
        ObjArray.push(""); //BillNo
        ObjArray.push(this.GetShiftAssignDocumentXML()); //InvDocXML
        ObjArray.push(""); //BillWiseXML
        ObjArray.push(""); //NotesXML
        ObjArray.push(""); //AttachmentsXML
        ObjArray.push(""); //ActivityXML
        ObjArray.push("false"); //IsImport
        if (BaseService.SessionManager.Preferences.ContainsKey("EnableLocationWise") && BaseService.SessionManager.Preferences["EnableLocationWise"].toString() == "True") {
            if (BaseService.SessionManager.LocationID > 0)
                ObjArray.push(BaseService.SessionManager.LocationID);
            else
                ObjArray.push(1);
        }
        else
            ObjArray.push(0);
        if (BaseService.SessionManager.Preferences.ContainsKey("EnableDivisionWise") && BaseService.SessionManager.Preferences["EnableDivisionWise"].toString() == "True") {
            if (BaseService.SessionManager.DivisionID > 0)
                ObjArray.push(BaseService.SessionManager.DivisionID);
            else
                ObjArray.push(1);
        }
        else
            ObjArray.push(0);

        ObjArray.push(WorkflowID); //WID
        ObjArray.push(BaseService.SessionManager.RoleID);
        ObjArray.push(""); //DocAddress
        ObjArray.push(0); //RefCCID
        ObjArray.push(0); //RefNodeid
        ObjArray.push(BaseService.SessionManager.CompanyGUID);
        ObjArray.push(BaseService.SessionManager.UserName);
        ObjArray.push(BaseService.SessionManager.UserID);
        ObjArray.push(BaseService.SessionManager.LanguageID);
        ObjArray.push(BaseService.SessionManager.IsOffline);

        let message = "";
        BaseService.document.SetTempInvDocument(ObjArray).subscribe(
            (response: any) => {
                RetVal = response.obj
                let returnds = response
                if (returnds != null && returnds.Tables.length > 0 && returnds.Tables[returnds.Tables.length - 1].length > 0 && returnds.Columns[returnds.Tables.length - 1].Contains("ErrorMessage"))
                    message = returnds.Tables[returnds.Tables.length - 1][0]["ErrorMessage"].toString();
                else
                    message = "Problem in processing your request,Please contact administrator.";
                if (RetVal > 0) {
                    if (returnds != null && returnds.Tables.length > 0 && returnds.Tables[returnds.Tables.length - 1].length > 0 && returnds.Columns[returnds.Tables.length - 1].Contains("VoucherNo")) {
                        this.ScreenObject.VoucherNo = returnds.Tables[returnds.Tables.length - 1][0]["VoucherNo"].toString();
                    }
                    let ref_Ddate = { value: this._Ddate }
                    this.ScreenObject.OnDocPrefixChanged(this.ScreenObject.Prefix, 0, 0, ref_Ddate, false);
                    this._Ddate = ref_Ddate.value
                    this.clear(2);
                    this.commandprarameter = "";
                }
                else {
                    if (returnds != null && returnds.Tables.length > 0 && returnds.Tables[returnds.Tables.length - 1].length > 0 && returnds.Columns[returnds.Tables.length - 1].Contains("ServerMessage")) {
                        if (returnds.Tables[returnds.Tables.length - 1][0]["ServerMessage"].toString() == "-407")
                            RetVal = -407;
                        else
                            RetVal = -12345;
                    }
                }
                this.DisplayMessage = message;
                this.MessageVisibility = true;
            });
        return false;
    }

    private GetShiftAssignDocumentXML(): any {
        let sSABasedOn = "";
        if (BaseService.SessionManager.Preferences.ContainsKey("ShiftAssignBasedOn"))
            sSABasedOn = BaseService.SessionManager.Preferences["ShiftAssignBasedOn"];
        let sb = '';
        let sbTranCom = '';
        let sData = "", sDocDetailsID = "", sCrAccount = "", sDrAccount = "";
        let strDt = "";
        let drc: any[];

        if (BaseService.SessionManager.dtDocDefAccs != null) {
            drc = BaseService.SessionManager.dtDocDefAccs.filter(x => x.CostCenterID == 40092 && x.SysColumnName == 'CreditAccount');
            if (drc != null && drc.length > 0 && !Util.IsEmpty(drc[0]["UserDefaultValue"]) && drc[0]["UserDefaultValue"].toString().Trim() != "")
                sCrAccount = drc[0]["UserDefaultValue"].toString();

            drc = BaseService.SessionManager.dtDocDefAccs.filter(x => x.CostCenterID == 40092 && x.SysColumnName == 'DebitAccount');
            if (drc != null && drc.length > 0 && !Util.IsEmpty(drc[0]["UserDefaultValue"]) && drc[0]["UserDefaultValue"].toString().Trim() != "")
                sDrAccount = drc[0]["UserDefaultValue"].toString();
        }

        //#region Transaction Common Query

        sbTranCom += "\" ProductID=\"" + this.ScreenObject.GridData[0]["ProductID_Key"].toString() + "\" Quantity=\"" + 0
            + "\" Unit=\"" + 1 + "\" UOMConversion=\"" + 1 + "\" UOMConvertedQty=\"" + 0
            + "\" Rate=\"" + 0 + "\" Gross=\"" + 0 + "\" IsQtyIgnored=\"" + 1 + "\" AverageRate=\"" + 0
            + "\" StockValue=\"" + 0 + "\" StockValueFC=\"" + 0 + "\" RefNO=\"" + ""
            + "\" BillDate=\"" + this.ScreenObject.DocDate.Date.ToString("dd/MMM/yyyy")
            + "\" CurrencyID=\"" + 1 + "\" ExchangeRate=\"" + 1
            + "\" DebitAccount=\"" + sDrAccount + "\" CreditAccount=\"" + sCrAccount;

        var oFld = this.ScreenObject.HeaderFields.find(m => m.DBColumnName == "CommonNarration");
        if (oFld) {
            sbTranCom += "\" CommonNarration=\"" + Util.EncodeXML(this.ScreenObject.GetcontrolValue(oFld as PactControlData));
        }

        //#endregion

        let sAssgnType = "DayWise";
        var vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
        if (vFld)
            sAssgnType = (vFld as PactComboBoxData).SelectedValue;

        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (sAssgnType == "DayWise") {
                let isCondPassed = true;
                let sCol = "";
                for (let k = this.iDtColFrom; k <= this.iDtColUpto; k++) {
                    isCondPassed = true;
                    let sBA = sSABasedOn.split(',');
                    if (sBA != null && sBA.length > 0) {
                        for (let s = 0; s < sBA.length; s++) {
                            if (sBA[s] != null && sBA[s] != undefined && sBA[s] != "") {
                                if (sBA[s] == "-2")
                                    sCol = "dcCCNID51_Key";
                                else
                                    sCol = "dcCCNID" + (parseInt(sBA[s]) - 50000) + "_Key";

                                if (Util.IsEmpty(this.ScreenObject.GridData[i][sCol]))
                                    isCondPassed = false;
                            }
                        }
                    }

                    if (this.ScreenObject.GridDataColumns[k].endsWith("_Key") && isCondPassed) { //!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID51_Key"])) {
                        sb += "\u0011";
                        sb += "<Row>";
                        sb += "<AccountsXML></AccountsXML>";

                        //#region Transactions XML

                        sb += "<Transactions DocSeqNo=\"" + (i + 1) + "\" LinkedInvDocDetailsID=\"" + 0 + "\" LinkedFieldName=\"" + "" + "\" LineNarration=\"" + this.ScreenObject.GridData[i]["LineNarration"].toString();

                        sDocDetailsID = "";
                        //if (oCMP != null && oCMP.arrLstOthMPFields[0].dvPayProcessed.length > 0)
                        //{
                        //    drccc = oCMP.arrLstOthMPFields[0].dvPayProcessed.filter(x=>x.VoucherType==11);
                        //    if (drccc != null && drccc.length > 0)
                        //        sDocDetailsID = drccc[0]["InvDocDetailsID"].toString();
                        //}
                        if (sDocDetailsID.length > 0)
                            sb += "\" DocDetailsID=\"" + sDocDetailsID;
                        else
                            sb += "\" DocDetailsID=\"" + "";

                        sb += sbTranCom.toString() + "\" ></Transactions>";

                        //#endregion

                        //#region Numeric XML
                        sb += "<Numeric Query=\"";
                        sb += "\" ></Numeric>";

                        //#endregion

                        //#region Alpha XML

                        sData = "";
                        sb += "<Alpha Query=\"";
                        sb += " dcAlpha3='" + Util.ParseDate(this.ScreenObject.GridDataColumns[k].Replace("_Key", "")).ToString("dd/MMM/yyyy") + "',";

                        let sVal = "";
                        if (this.ScreenObject.CustomTab.Pages.length > 0) {
                            for (let t = 0; t < this.ScreenObject.CustomTab.Pages.length; t++) {
                                for (let j = 0; j < this.ScreenObject.CustomTab.Pages[t].Fields.length; j++) {
                                    if (this.ScreenObject.CustomTab.Pages[t].Fields[j] instanceof PactControlData &&
                                        this.ScreenObject.CustomTab.Pages[t].Fields[j].DBColumnName.startsWith("dcAlpha") &&
                                        this.ScreenObject.CustomTab.Pages[t].Fields[j].DBColumnName.toUpperCase() != "DCALPHA3"
                                    ) {
                                        sVal = this.ScreenObject.GetcontrolValue(this.ScreenObject.CustomTab.Pages[t].Fields[j]);
                                        sData += " " + (this.ScreenObject.CustomTab.Pages[t].Fields[j]).DBColumnName + "='" + Util.EncodeXML(sVal) + "',";
                                    }
                                }
                            }
                        }

                        for (let c = 0; c < this.ScreenObject.ColumnSource.length; c++) {
                            if (this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcAlpha") && this.ScreenObject.ColumnSource[c].DisplayMember.toUpperCase() != "DCALPHA3") {
                                if (this.ScreenObject.ColumnSource[c].DisplayMember.toUpperCase() == "DCALPHA5" || this.ScreenObject.ColumnSource[c].DisplayMember.toUpperCase() == "DCALPHA6") {
                                    sData += " " + this.ScreenObject.ColumnSource[c].DisplayMember + "='" + Util.ParseDate(this.ScreenObject.GridDataColumns[k].Replace("_Key", "")).ToString("dd/MMM/yyyy") + "',";
                                }
                                else {
                                    if (this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember] != null && this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember] != null)
                                        sData += " " + this.ScreenObject.ColumnSource[c].DisplayMember + "='" + Util.EncodeXML(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember].toString()) + "',";
                                }
                            }
                        }


                        sb += sData;
                        sb += "\" ></Alpha>";

                        //#endregion

                        //#region CostCenters XML

                        sData = "";
                        sb += "<CostCenters Query=\"";
                        sb += " dcCCNID51=" + this.ScreenObject.GridData[i]["dcCCNID51_Key"].toString() + ",";
                        sb += " dcCCNID73=" + this.ScreenObject.GridData[i][k].toString() + ",";

                        if (this.ScreenObject.CustomTab.Pages.length > 0) {
                            for (let t = 0; t < this.ScreenObject.CustomTab.Pages.length; t++) {
                                for (let j = 0; j < this.ScreenObject.CustomTab.Pages[t].Fields.length; j++) {
                                    if ((this.ScreenObject.CustomTab.Pages[t].Fields[j]).DBColumnName.startsWith("dcCCNID")) {
                                        sData += " " + (this.ScreenObject.CustomTab.Pages[t].Fields[j]).DBColumnName + "=" + (this.ScreenObject.CustomTab.Pages[t].Fields[j] as PactListBoxData).SelectedValue + ",";
                                    }
                                }
                            }
                        }

                        for (let c = 0; c < this.ScreenObject.ColumnSource.length; c++) {
                            if (this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcCCNID") &&
                                !this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcCCNID51") && !this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcCCNID73")
                            ) {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember + "_Key"]))
                                    sData += " " + this.ScreenObject.ColumnSource[c].DisplayMember + "='" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember + "_Key"].toString() + "',";
                            }
                        }

                        sb += sData;
                        sb += "\" ></CostCenters>";

                        //#endregion

                        sb += "<EXTRAXML></EXTRAXML>";
                        sb += "</Row>";
                    }
                }
            }
            else //Period wise
            {
                let isCondPassed = true;
                let sCol = "";
                let sBA = sSABasedOn.split(',');
                if (sBA != null && sBA.length > 0) {
                    for (let s = 0; s < sBA.length; s++) {
                        if (sBA[s] != null && sBA[s] != undefined && sBA[s] != "") {
                            if (sBA[s] == "-2")
                                sCol = "dcCCNID51_Key";
                            else
                                sCol = "dcCCNID" + (parseInt(sBA[s]) - 50000) + "_Key";

                            if (Util.IsEmpty(this.ScreenObject.GridData[i][sCol]))
                                isCondPassed = false;
                        }
                    }
                }

                //if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID51_Key"])) {
                if (isCondPassed) {
                    sb += "\u0011";
                    sb += "<Row>";
                    sb += "<AccountsXML></AccountsXML>";

                    //#region Transactions XML

                    sb += "<Transactions DocSeqNo=\"" + (i + 1) + "\" LinkedInvDocDetailsID=\"" + 0 + "\" LinkedFieldName=\"" + "" + "\" LineNarration=\"" + Util.String(this.ScreenObject.GridData[i]["LineNarration"]);

                    sDocDetailsID = "";
                    //if (oCMP != null && oCMP.arrLstOthMPFields[0].dvPayProcessed.length > 0)
                    //{
                    //    drccc = oCMP.arrLstOthMPFields[0].dvPayProcessed.filter(x=>x.VoucherType==11);
                    //    if (drccc != null && drccc.length > 0)
                    //        sDocDetailsID = drccc[0]["InvDocDetailsID"].toString();
                    //}
                    if (sDocDetailsID.length > 0)
                        sb += "\" DocDetailsID=\"" + sDocDetailsID;
                    else
                        sb += "\" DocDetailsID=\"" + "";

                    sb += sbTranCom.toString() + "\" ></Transactions>";

                    //#endregion

                    //#region Numeric XML
                    sb += "<Numeric Query=\"";
                    sb += "\" ></Numeric>";

                    //#endregion

                    //#region Alpha XML

                    sData = "";
                    sb += "<Alpha Query=\"";
                    //sb+=" dcAlpha3='" + Util.ParseDate(ScreenObject.GridDataColumns[k].Replace("_Key", "")).ToString("dd/MMM/yyyy") + "',";

                    let sVal = "";
                    if (this.ScreenObject.CustomTab.Pages.length > 0) {
                        for (let t = 0; t < this.ScreenObject.CustomTab.Pages.length; t++) {
                            for (let j = 0; j < this.ScreenObject.CustomTab.Pages[t].Fields.length; j++) {
                                if (this.ScreenObject.CustomTab.Pages[t].Fields[j] instanceof PactControlData &&
                                    this.ScreenObject.CustomTab.Pages[t].Fields[j].DBColumnName.startsWith("dcAlpha") &&
                                    this.ScreenObject.CustomTab.Pages[t].Fields[j].DBColumnName.toUpperCase() != "DCALPHA1" &&
                                    this.ScreenObject.CustomTab.Pages[t].Fields[j].DBColumnName.toUpperCase() != "DCALPHA2" &&
                                    this.ScreenObject.CustomTab.Pages[t].Fields[j].DBColumnName.toUpperCase() != "DCALPHA3"
                                ) {
                                    sVal = this.ScreenObject.GetcontrolValue(this.ScreenObject.CustomTab.Pages[t].Fields[j]);
                                    sData += " " + this.ScreenObject.CustomTab.Pages[t].Fields[j].DBColumnName + "='" + Util.EncodeXML(sVal) + "',";
                                }
                            }
                        }
                    }

                    for (let c = 0; c < this.ScreenObject.ColumnSource.length; c++) {
                        if (this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcAlpha") && this.ScreenObject.ColumnSource[c].DisplayMember.toUpperCase() != "DCALPHA1"
                            && this.ScreenObject.ColumnSource[c].DisplayMember.toUpperCase() != "DCALPHA2" && this.ScreenObject.ColumnSource[c].DisplayMember.toUpperCase() != "DCALPHA3"
                        ) {
                            if (this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember] != null && this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember] != null) {
                                if (this.ScreenObject.ColumnSource[c].DataType == "DATE")
                                    sData += " " + this.ScreenObject.ColumnSource[c].DisplayMember + "='" + Util.ParseDate(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember + "_Key"].toString()).ToString("dd/MMM/yyyy") + "',";
                                else
                                    sData += " " + this.ScreenObject.ColumnSource[c].DisplayMember + "='" + Util.EncodeXML(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember].toString()) + "',";
                            }
                        }
                    }


                    sb += sData;
                    sb += "\" ></Alpha>";

                    //#endregion

                    //#region CostCenters XML

                    sData = "";
                    sb += "<CostCenters Query=\"";
                    sb += " dcCCNID51=" + this.ScreenObject.GridData[i]["dcCCNID51_Key"].toString() + ",";
                    sb += " dcCCNID73=" + this.ScreenObject.GridData[i]["dcCCNID73_Key"].toString() + ",";

                    if (this.ScreenObject.CustomTab.Pages.length > 0) {
                        for (let t = 0; t < this.ScreenObject.CustomTab.Pages.length; t++) {
                            for (let j = 0; j < this.ScreenObject.CustomTab.Pages[t].Fields.length; j++) {
                                if (this.ScreenObject.CustomTab.Pages[t].Fields[j] instanceof PactListBoxData &&
                                    this.ScreenObject.CustomTab.Pages[t].Fields[j].DBColumnName.startsWith("dcCCNID") &&
                                    this.ScreenObject.CustomTab.Pages[t].Fields[j].DBColumnName.toUpperCase() != "DCCCNID51" &&
                                    this.ScreenObject.CustomTab.Pages[t].Fields[j].DBColumnName.toUpperCase() != "DCCCNID73"
                                ) {
                                    sData += " " + this.ScreenObject.CustomTab.Pages[t].Fields[j].DBColumnName + "=" + this.ScreenObject.CustomTab.Pages[t].Fields[j].SelectedValue + ",";
                                }
                            }
                        }
                    }

                    for (let c = 0; c < this.ScreenObject.ColumnSource.length; c++) {
                        if (this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcCCNID")
                            && !this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcCCNID51")
                            && !this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcCCNID73")
                        ) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember + "_Key"]))
                                sData += " " + this.ScreenObject.ColumnSource[c].DisplayMember + "='" + this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember + "_Key"].toString() + "',";
                        }
                    }

                    sb += sData;
                    sb += "\" ></CostCenters>";

                    //#endregion

                    sb += "<EXTRAXML></EXTRAXML>";
                    sb += "</Row>";
                }
            }
        }
        return sb.toString();
    }

    private LoadEditShiftAssign(ds: any) {
        let sSABasedOn = "";
        if (BaseService.SessionManager.Preferences.ContainsKey("ShiftAssignBasedOn"))
            sSABasedOn = BaseService.SessionManager.Preferences["ShiftAssignBasedOn"];
        let sBA = sSABasedOn.split(',');
        let sCol = "";

        let sAssgnType = "DayWise";
        var vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
        if (vFld instanceof PactComboBoxData)
            sAssgnType = vFld.SelectedValue;

        vFld.IsReadOnly = true;

        if (sAssgnType == "DayWise") {
            this.FillDates_Click();
            let dtDates: any[] = ds.Tables[3].ToTable(true, ["dcAlpha3"]);
            let sDate: string;
            let iInvDocDetID = 0;
            let drcD = null;
            let iRow = 0;
            for (let i = 0; i < ds.Tables[1].length; i += dtDates.length, iRow++) {
                if (this.ScreenObject.GridData.length - 1 <= iRow)
                    this.ScreenObject.GridDataObj.addEmptyRow();

                if (sBA != null && sBA != undefined && sBA.length > 0) {
                    for (let s = 0; s < sBA.length; s++) {
                        if (sBA[s] != null && sBA[s] != "") {
                            if (sBA[s] == "-2")
                                sCol = "dcCCNID51_Key";
                            else
                                sCol = "dcCCNID" + (parseInt(sBA[s]) - 50000) + "_Key";

                            this.ScreenObject.GridData[iRow][sCol] = ds.Tables[1][i][sCol.Replace("_Key", "")];
                        }
                    }
                    this.FillDefaultProd(this.ScreenObject.GridData[iRow], sCol.Replace("_Key", ""));
                    this.Celleditend(this.ScreenObject.GridData[iRow], sCol.Replace("_Key", ""), this.ScreenObject.GridDataColumns.indexOf(sCol.Replace("_Key", "")));
                }
                // this.ScreenObject.GridData[iRow]["dcCCNID51_Key"] = ds.Tables[1][i]["dcCCNID51"];
                // this.FillDefaultProd(this.ScreenObject.GridData[iRow], "dcCCNID51");
                // this.Celleditend(this.ScreenObject.GridData[iRow], "dcCCNID51", this.ScreenObject.GridDataColumns.indexOf("dcCCNID51"));

                //Filling Shifts Date Columns
                for (let j = 0; j < dtDates.length; j++) {
                    iInvDocDetID = parseInt(ds.Tables[1][i + j]["InvDocDetailsID"]);
                    sDate = dtDates[j]["dcAlpha3"].toString().Replace("/", "-");
                    let iDtCol = this.GetDgvColumnIndex(sDate);
                    drcD = ds.Tables[3].filter(x => x.InvDocDetailsID == iInvDocDetID);
                    if (drcD != null && drcD.length > 0) {
                        if (Util.ParseDate(sDate) == Util.ParseDate(drcD[0]["dcAlpha3"])) {
                            drcD = ds.Tables[1].filter(x => x.InvDocDetailsID == iInvDocDetID);
                            if (drcD != null && drcD.length > 0) {
                                this.ScreenObject.GridData[iRow][sDate + "_Key"] = drcD[0]["dcCCNID73"];
                                this.ScreenObject.GridData[iRow];//.AcceptChanges();
                                this.ScreenObject.GridDataObj.updateRow(this.ScreenObject.GridData[iRow]);
                                this.ScreenObject.GridDataObj.refreshDatawithIDs();
                            }
                        }

                    }

                }

                //Filling Other Body Columns
                for (let c = 0; c < this.ScreenObject.ColumnSource.length; c++) {
                    if (this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcAlpha")) {
                        if (this.ScreenObject.ColumnSource[c].DisplayMember.toLowerCase() != "dcalpha5" && this.ScreenObject.ColumnSource[c].DisplayMember.toLowerCase() != "dcalpha6") {
                            if (this.ScreenObject.ColumnSource[c].DataType.toUpperCase() == "DATE") {
                                if (!Util.IsEmpty(ds.Tables[3][i][this.ScreenObject.ColumnSource[c].DisplayMember])) {
                                    this.ScreenObject.GridData[iRow][this.ScreenObject.ColumnSource[c].DisplayMember] = Util.ParseDate(ds.Tables[3][i][this.ScreenObject.ColumnSource[c].DisplayMember]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                    this.ScreenObject.GridData[iRow][this.ScreenObject.ColumnSource[c].DisplayMember + "_key"] = Util.ParseDate(ds.Tables[3][i][this.ScreenObject.ColumnSource[c].DisplayMember]);
                                }
                            }
                            else {
                                this.ScreenObject.GridData[iRow][this.ScreenObject.ColumnSource[c].DisplayMember] = ds.Tables[3][i][this.ScreenObject.ColumnSource[c].DisplayMember];
                            }
                        }
                    }
                    else if (this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcCCNID") &&
                        !this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcCCNID51") && !this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcCCNID73")) {
                        this.ScreenObject.GridData[iRow][this.ScreenObject.ColumnSource[c].DisplayMember + "_Key"] = ds.Tables[1][i][this.ScreenObject.ColumnSource[c].DisplayMember];
                    }
                    else if (this.ScreenObject.ColumnSource[c].DisplayMember.toUpperCase() == "LINENARRATION") {
                        if (ds.Columns[0].Contains(this.ScreenObject.ColumnSource[c].DisplayMember))
                            this.ScreenObject.GridData[iRow][this.ScreenObject.ColumnSource[c].DisplayMember] = ds.Tables[0][i][this.ScreenObject.ColumnSource[c].DisplayMember];
                    }
                }
            }
        }
        else //Period Wise
        {
            this.ConsolidateLeaveMonth();
            for (let i = 0; i < ds.Tables[1].length; i++) {
                if (this.ScreenObject.GridData.length - 1 <= i)
                    this.ScreenObject.GridDataObj.addEmptyRow();

                if (sBA != null && sBA != undefined && sBA.length > 0) {
                    for (let s = 0; s < sBA.length; s++) {
                        if (sBA[s] != null && sBA[s] != "") {
                            if (sBA[s] == "-2")
                                sCol = "dcCCNID51_Key";
                            else
                                sCol = "dcCCNID" + (parseInt(sBA[s]) - 50000) + "_Key";

                            this.ScreenObject.GridData[i][sCol] = ds.Tables[1][i][sCol.Replace("_Key", "")];
                        }
                    }
                    // this.FillDefaultProd(this.ScreenObject.GridData[i], sCol.Replace("_Key", ""));
                    // this.Celleditend(this.ScreenObject.GridData[i], sCol.Replace("_Key", ""), this.ScreenObject.GridDataColumns.indexOf(sCol.Replace("_Key", "")));
                }
                // this.ScreenObject.GridData[i]["dcCCNID51_Key"] = ds.Tables[1][i]["dcCCNID51"];
                // this.FillDefaultProd(this.ScreenObject.GridData[i], "dcCCNID51");
                // this.Celleditend(this.ScreenObject.GridData[i], "dcCCNID51", this.ScreenObject.GridDataColumns.indexOf("dcCCNID51"));

                //Filling Other Body Columns
                for (let c = 0; c < this.ScreenObject.ColumnSource.length; c++) {
                    if (this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcAlpha")) {
                        if (this.ScreenObject.ColumnSource[c].DataType.toUpperCase() == "DATE") {
                            if (!Util.IsEmpty(ds.Tables[3][i][this.ScreenObject.ColumnSource[c].DisplayMember])) {
                                this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember] = Util.ParseDate(ds.Tables[3][i][this.ScreenObject.ColumnSource[c].DisplayMember]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember + "_key"] = Util.ParseDate(ds.Tables[3][i][this.ScreenObject.ColumnSource[c].DisplayMember]);
                            }
                        }
                        else {
                            this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember] = ds.Tables[3][i][this.ScreenObject.ColumnSource[c].DisplayMember];
                        }

                    }
                    else if (this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcCCNID") && !this.ScreenObject.ColumnSource[c].DisplayMember.startsWith("dcCCNID51")) {
                        this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember + "_Key"] = ds.Tables[1][i][this.ScreenObject.ColumnSource[c].DisplayMember];
                    }
                    else if (this.ScreenObject.ColumnSource[c].DisplayMember.toUpperCase() == "LINENARRATION") {
                        if (ds.Columns[0].Contains(this.ScreenObject.ColumnSource[c].DisplayMember))
                            this.ScreenObject.GridData[i][this.ScreenObject.ColumnSource[c].DisplayMember] = ds.Tables[0][i][this.ScreenObject.ColumnSource[c].DisplayMember];
                    }
                    else if (this.ScreenObject.ColumnSource[c].DisplayMember.toUpperCase() == "PRODUCTCODE") {
                        this.ScreenObject.GridData[i]["ProductID_key"] = this.ScreenObject.ColumnSource[c].DefaultValue;

                        let namecode: any = this.ScreenObject.ColumnSource[c].DefaultValueText.split('\u0011');
                        if (this.ScreenObject.GridDataColumns.Contains("ProductCode") && namecode.length > 1)
                            this.ScreenObject.GridData[i]["ProductCode"] = namecode[1];
                        if (this.ScreenObject.GridDataColumns.Contains("ProductName") && namecode.length > 0)
                            this.ScreenObject.GridData[i]["ProductName"] = namecode[0];
                    }
                }

            }
        }
        this.ScreenObject.UpdateSequence();
        this.RefreshGrid = true;

    }
    private GetDgvColumnIndex(sColName: string): number {
        let i;
        for (i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
            if (this.ScreenObject.ColumnSource[i].DisplayMember.toLowerCase() == sColName.toLowerCase())
                return i;
        }
        return i;
    }

    private LoadShiftAssignRotationData() {
        if (this.dtShiftAssRot != null && this.dtShiftAssRot.length > 0) {
            let vFld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
            if (vFld != undefined) {
                vFld.SelectedValue = "PeriodWise";
                vFld.IsReadOnly = true;
            }

            let sSABasedOn = "";
            if (BaseService.SessionManager.Preferences.ContainsKey("ShiftAssignBasedOn"))
                sSABasedOn = BaseService.SessionManager.Preferences["ShiftAssignBasedOn"];
            let sBA: any = sSABasedOn.split(',');
            let sCol = "";
            if (sBA != null && sBA != undefined && sBA.length > 0) {
                for (let s = 0; s < sBA.length; s++) {
                    if (sBA[s] != null && sBA[s] != "") {
                        if (sBA[s] == "-2")
                            sCol = "dcCCNID51_Key";
                        else
                            sCol = "dcCCNID" + (parseInt(sBA[s]) - 50000) + "_Key";
                    }
                }
            }

            let drGrid: any = null;
            let RowPosition = 0;
            if (this.ScreenObject.GridDataColumns.Contains(sCol)) {
                this.ScreenObject.GridData.Clear();
                let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                for (let c = 0; c < this.dtShiftAssRot.length; c++) {
                    drGrid = this.ScreenObject.GridDataObj.NewRow();
                    //this.ScreenObject.GridData.Rows.InsertAt(drGrid, RowPosition);
                    //RowPosition++;
                    if (drCL.length > 0 && Util.String(drCL[0]["UserDefaultValue"]) != "") {
                        drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                    }

                    drGrid[sCol] = this.dtShiftAssRot[c]["Employee_Key"];
                    drGrid[sCol.Replace("_Key", "")] = this.dtShiftAssRot[c]["Employee"];

                    drGrid["dcAlpha5_Key"] = Util.ParseDate(this.dtShiftAssRot[c]["From"]);
                    drGrid["dcAlpha5"] = Util.ParseDate(this.dtShiftAssRot[c]["From"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);

                    drGrid["dcAlpha6_Key"] = Util.ParseDate(this.dtShiftAssRot[c]["To"]);
                    drGrid["dcAlpha6"] = Util.ParseDate(this.dtShiftAssRot[c]["To"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);

                    //drGrid["dcAlpha5_Key"] = Util.ParseDate(dtShiftAssRot[c]["Date"]);
                    //drGrid["dcAlpha5"] = Util.ParseDate(dtShiftAssRot[c]["Date"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);

                    drGrid["dcCCNID73_Key"] = this.dtShiftAssRot[c]["Shift_Key"];
                    drGrid["dcCCNID73"] = this.dtShiftAssRot[c]["Shift"];

                    this.ScreenObject.GridDataObj.addRow(drGrid);
                }
                //this.ScreenObject.GridData.AcceptChanges();

                if (this.RefreshGrid)
                    this.RefreshGrid = false;
                else
                    this.RefreshGrid = true;
            }

        }
    }


    //#endregion

    //#region Time off Request

    private CalculateTotalTimeAvailed(dtReq: Date, dtComingIn: Date, dtGoingOut: Date): string {
        dtComingIn = new Date(dtReq.getFullYear(), dtReq.getMonth(), dtReq.getDate(), dtComingIn.getHours(), dtComingIn.getMinutes(), dtComingIn.getSeconds());
        dtGoingOut = new Date(dtReq.getFullYear(), dtReq.getMonth(), dtReq.getDate(), dtGoingOut.getHours(), dtGoingOut.getMinutes(), dtGoingOut.getSeconds());
        let ts: TimeSpan = dtComingIn.Subtract(dtGoingOut);
        if (ts.Hours < 0)
            ts = ts.add(TimeSpan.FromDays(1));
        return ts.Hours.PrefixZero(2) + "." + ts.Minutes.PrefixZero(2);
        return "";
    }

    CalculateTotalTime(dtFromDate: Date, dtFromTime: Date, dtToDate: Date, dtToTime: Date): string {
        dtFromTime = new Date(dtFromDate.getFullYear(), dtFromDate.getMonth(), dtFromDate.getDate(), dtFromTime.getHours(), dtFromTime.getMinutes(), dtFromTime.getSeconds());
        dtToTime = new Date(dtToDate.getFullYear(), dtToDate.getMonth(), dtToDate.getDate(), dtToTime.getHours(), dtToTime.getMinutes(), dtToTime.getSeconds());
        if (dtToTime < dtFromTime) {
            return "00.00";
        }
        let ts = dtToTime.Subtract(dtFromTime);
        if (ts.Hours < 0)
            ts = ts.add(TimeSpan.FromDays(1));
        return ((ts.Days * 24) + ts.Hours).PrefixZero(2) + "." + ts.Minutes.PrefixZero(2);
    }

    //#endregion

    //#region "Apply Vacation"
    ApplyVacationFrom(col: any) {
        this.dsVacationdays = null;
        if (!(col as PactExtraFieldDateData).Date)
            return;
        if ((col as PactExtraFieldDateData).SelectedDateChanged.IsSubscribed) {
            let SelectedEmpID = 0;
            let Dimfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");

            if (Dimfld != null && Dimfld != undefined && Dimfld instanceof PactListBoxData && Dimfld.SelectedValue > 0)
                SelectedEmpID = Dimfld.SelectedValue;
            else if (Dimfld != null && Dimfld instanceof PactCodeNameListBoxData && Dimfld.SelectedValue > 0)
                SelectedEmpID = Dimfld.SelectedValue;

            if (SelectedEmpID > 0) {

                this.dsData = this.ScreenObject.GetVacationDetails(SelectedEmpID, Util.ParseDate(this.ScreenObject.DocDate.Date), Util.ParseDate(col.Date));
                if (this.dsData.Tables.length > 0) {
                    //CLEAR ALL HEADER TEXT FIELDS
                    this.ScreenObject._TextFields.forEach(item => {
                        if (item.DBColumnName.startsWith("dcalpha") && parseInt(item.DBColumnName.Replace("dcalpha", "")) <= 50) {
                            if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase().Contains("dcalpha"))
                                item.Text = "";
                            if (item instanceof PactTextBoxData && item.DBColumnName.toLowerCase() == "dcalpha14")
                                item.IsReadOnly = true;
                        }
                    });

                    this.DisplayMessage = this.ApplyVacationValidationMsg(this.dsData);
                    if (this.DisplayMessage.toString() != "") {
                        this.MessageVisibility = true;
                        return;
                    }

                    //LOADING COMPONENTS
                    if (this.dsData.Tables[3].length > 0) {
                        let FieldType1 = [];
                        this.ScreenObject.GridDataObj.Clear();

                        var fldPSD2 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha21");
                        if (fldPSD2 != null && fldPSD2 != undefined) {
                            for (let i = 0; i <= this.dsData.Tables[3].length - 1; i++) {
                                FieldType1.push(ComboBoxItems.ComboBoxItems_2(this.dsData.Tables[3][i]["NAME"].toString(), this.dsData.Tables[3][i]["NODEID"].toString()));
                            }
                            fldPSD2.DisplayMember = "Name";
                            fldPSD2.ValueMember = "Value";
                            fldPSD2.ComboData = FieldType1;
                        }
                    }
                    if (this.dsData.Tables[4].length > 0) {
                        let FieldType: any = [];
                        let drGrid: any = null;
                        let drCL1: any = null;
                        let RowPosition = 0;
                        var fldPSD1 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha20");
                        if (fldPSD1 != null && fldPSD1 != undefined) {
                            for (let i = 0; i <= this.dsData.Tables[4].length - 1; i++) {
                                FieldType.push(ComboBoxItems.ComboBoxItems_2(this.dsData.Tables[4][i]["NAME"].toString(), this.dsData.Tables[4][i]["NODEID"].toString()));
                            }
                            fldPSD1.DisplayMember = "Name";
                            fldPSD1.ValueMember = "Value";
                            fldPSD1.ComboData = FieldType;
                        }

                        drGrid = null;
                        let drCL: any = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                        for (let k = 0; k < this.dsData.Tables[4].length; k++) {
                            drGrid = this.ScreenObject.GridDataObj.NewRow();

                            if (drCL.length > 0 && Util.String(drCL[0]["UserDefaultValue"]) != "")
                                drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];

                            drGrid["dcAlpha20"] = this.dsData.Tables[4][k]["NODEID"];
                            drCL1 = this.dsData.Tables[4].filter(x => x.NODEID == parseInt(drGrid["dcAlpha20"]));
                            drGrid["dcAlpha21"] = drCL1[0]["PARENTID"];
                            this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                            RowPosition++;
                        }
                    }

                    //ASSINGING OPVACATION DAYS AND OPVACATION SALARY
                    if (this.dsData.Tables[5].length > 0) {
                        let dtFromDate = new Date().OnlyDate();
                        let fldAPV3: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                        if (fldAPV3 != null && fldAPV3 != undefined && fldAPV3 instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV3.Date)) {
                            dtFromDate = fldAPV3.Date;
                        }

                        let dsVacdays = null;
                        let dRemDays = 0;
                        if (!Util.IsEmpty(this.dsData.Tables[5][0]["CalcCreditFromDOJ"]))
                            this.CalcCreditFromDOJ = this.dsData.Tables[5][0]["CalcCreditFromDOJ"].toString();
                        if (this.dsData.Tables[5][0]["CalcCreditFromDOJ"].toString().toUpperCase() == "NO") {
                            let dtVac: any = BaseService.common.GetDataTable("PAY083", SelectedEmpID.toString() + "~" + dtFromDate.ToString("dd/MMM/yyyy"));

                            if (dtVac != null && dtVac.length > 0) {
                                if (Util.ParseDate(dtVac[0]["REJOINDATE"]) <= Util.ParseDate(dtVac[0]["TODATE"])) {
                                    dsVacdays = this.ScreenObject.GetVacationDays(Util.ParseDate(dtVac[0]["FROMDATE"]), Util.ParseDate(dtVac[0]["REJOINDATE"]).AddDays(-1), SelectedEmpID, parseInt(dtVac[0]["DOCID"]), parseFloat(dtVac[0]["OpeningBalance"]), 0);

                                    if (dsVacdays != null && dsVacdays.Tables.length > 0) {
                                        dRemDays = parseFloat(dsVacdays.Tables[1][0]["REMAININGDAYS"]);

                                        if (dtVac[0]["IsEncashRemainingDays"] != null && dtVac[0]["IsEncashRemainingDays"] != null && dtVac[0]["IsEncashRemainingDays"].toString() == "Yes" &&
                                            dtVac[0]["EncashRemainingDays"] != null && dtVac[0]["EncashRemainingDays"] != null && parseFloat(dtVac[0]["EncashRemainingDays"]) > 0) {
                                            dRemDays = dRemDays - parseFloat(dtVac[0]["EncashRemainingDays"]);
                                        }

                                    }
                                }
                            }
                        }

                        var fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha22");
                        if (fldAPV != null && fldAPV instanceof PactTextBoxData) {
                            if (parseFloat(this.dsData.Tables[5][0]["OPVACATIONDAYS"]) < 0 && BaseService.SessionManager.Preferences.ContainsKey("DonotshownegitiveOPvacationdays") && parseBoolean(BaseService.SessionManager.Preferences["DonotshownegitiveOPvacationdays"] == "True"))
                                fldAPV.Text = (0).ToTime("00.00");
                            else {
                                if (dRemDays > 0)
                                    fldAPV.Text = dRemDays.ToString("0.00");
                                else
                                    fldAPV.Text = parseFloat(this.dsData.Tables[5][0]["OPVACATIONDAYS"]).ToTime("00.00")
                            }
                        }

                        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
                        if (fldAPV != null && fldAPV instanceof PactTextBoxData)
                            fldAPV.Text = parseFloat(this.dsData.Tables[5][0]["OPVACATIONSALARY"]).ToTime("00.00")

                        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                        if (fldAPV != null && fldAPV instanceof PactTextBoxData)
                            fldAPV.IsReadOnly = true;

                    }
                }
            }


            var fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
            if (fldAPV instanceof PactExtraFieldDateData && fldAPV.Date)
                this.ApplyVacation(fldAPV);
        }
    }
    dsVacationdays: any = null;
    isVacContractedit: boolean = false
    isVacPopup: boolean = false; ConsiderLoanswhilegoingonVacation: boolean = true;
    PrevVacFrom: Date; PrevVacTo: Date;
    CalcCreditFromDOJ: string = "";
    public ApplyVacation(col: any) {
        this.dsVacationdays = null;
        if (!(col as PactExtraFieldDateData).Date)
            return;

        if ((col as PactExtraFieldDateData).SelectedDateChanged.IsSubscribed) {
            let dtFromDate = new Date(), dtToDate = new Date();
            let lngEmpCode = 0;
            let dblOPVacDays = 0, dblVacationDays = 0, dblOPVacSalary = 0;
            var fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
            if (fldAPV instanceof PactExtraFieldDateData && fldAPV.Date) {
                dtFromDate = fldAPV.Date;
            }

            fldAPV = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (fldAPV instanceof PactListBoxData && fldAPV.SelectedValue > 0)
                lngEmpCode = fldAPV.SelectedValue;
            else if (fldAPV instanceof PactCodeNameListBoxData && fldAPV.SelectedValue > 0)
                lngEmpCode = fldAPV.SelectedValue;

            if (lngEmpCode == 0)
                return;

            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
            if (fldAPV instanceof PactExtraFieldDateData && fldAPV.Date) {
                dtToDate = fldAPV.Date;
                if (lngEmpCode > 0)
                    this.FillEarningsDeductions(lngEmpCode, Util.ParseDate(dtToDate));
            }

            if ((Util.ParseDate(dtFromDate) > Util.ParseDate(dtToDate))) {
                this.DisplayMessage = "Todate should be greater than Fromdate";
                this.MessageVisibility = true;
                return;
            }

            //fldAPV = ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            //if (fldAPV instanceof PactListBoxData && fldAPV.SelectedValue > 0)
            //{
            //    lngEmpCode = fldAPV.SelectedValue;
            //}

            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha22");
            if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                dblOPVacDays = parseFloat(fldAPV.Text);
            }

            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
            if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                dblOPVacSalary = parseFloat(fldAPV.Text);
            }
            //start:loading vacation related days
            let dtmpExDays = 0;
            this.dsVacationdays = this.ScreenObject.GetVacationDays(dtFromDate, dtToDate, lngEmpCode, this.DocID, dblOPVacDays, 0);


            let dtVacMang: any = BaseService.common.GetDataTable("PAY074", lngEmpCode.toString());
            let ConsiderVacationdayforExcessVacationDays = "";
            if (dtVacMang != null && dtVacMang.length > 0)
                ConsiderVacationdayforExcessVacationDays = dtVacMang[0]["ConsiderVacationdayforExcessVacationDays"] + '';

            if (ConsiderVacationdayforExcessVacationDays.length > 0) // Later will check By Preference
            {
                if (ConsiderVacationdayforExcessVacationDays == "No") {
                    if (this.dsVacationdays != null && this.dsVacationdays.Tables.length > 0 && this.dsVacationdays.Tables[1].length > 0 &&
                        this.dsVacationdays.Columns[1].Contains("ExcessDays") && parseFloat(this.dsVacationdays.Tables[1][0]["ExcessDays"]) > 0) {
                        let dActFD = dtFromDate;
                        let dActTD = dtToDate;
                        let dtmpTD = dtToDate.AddDays(-1);
                        let dVDays1 = parseFloat(this.dsVacationdays.Tables[1][0]["VacationDays"]);
                        let dVDays2 = 0;
                        let dsTmpVD: any;
                        while (dtFromDate <= dtmpTD) {
                            dsTmpVD = this.ScreenObject.GetVacationDays(dtFromDate, dtmpTD, lngEmpCode, this.DocID, dblOPVacDays, 0);
                            if (dsTmpVD != null && dsTmpVD.Tables.length > 0 && dsTmpVD.Tables[1].length > 0 &&
                                parseFloat(dsTmpVD.Tables[1][0]["ExcessDays"]) == 0) {
                                dVDays2 = parseFloat(dsTmpVD.Tables[1][0]["VacationDays"]);
                                break;
                            }
                            dtmpTD = dtmpTD.AddDays(-1);
                        }

                        dtmpExDays = (dVDays1 - dVDays2);
                    }
                }
            }

            ///////
            this.dsVacationdays = this.ScreenObject.GetVacationDays(dtFromDate, dtToDate, lngEmpCode, this.DocID, dblOPVacDays, dtmpExDays);
            if (this.dsVacationdays.Tables.length > 0) {
                if (this.dsVacationdays.Tables[0].length > 0 && !Util.IsEmpty(this.dsVacationdays.Tables[0][0]["ProbationPeriodMessage"])) {
                    this.DisplayMessage = this.dsVacationdays.Tables[0][0]["ProbationPeriodMessage"].toString();
                    this.MessageVisibility = true;
                    return;
                }
                if (this.dsVacationdays.Tables[1].length > 0 && Util.IsEmpty(this.dsVacationdays.Tables[1][0]["VacationDaysMessage"])) {
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                    if (fldAPV instanceof PactTextBoxData) {
                        fldAPV.Text = parseFloat(this.dsVacationdays.Tables[1][0]["VacationDays"]).ToTime("00.00")
                    }
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha8");
                    if (fldAPV instanceof PactTextBoxData) {
                        fldAPV.Text = parseFloat(this.dsVacationdays.Tables[1][0]["AppliedDays"]).ToTime("00.00")
                    }
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha9");
                    if (fldAPV instanceof PactTextBoxData) {
                        fldAPV.Text = parseFloat(this.dsVacationdays.Tables[1][0]["ApprovedDays"]).ToTime("00.00")
                    }
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha10");
                    if (fldAPV instanceof PactTextBoxData) {
                        if (parseFloat(this.dsVacationdays.Tables[1][0]["PaidDays"]) < 0) {
                            fldAPV.Text = "0.00";
                            dblVacationDays = 0;
                        }
                        else {
                            fldAPV.Text = parseFloat(this.dsVacationdays.Tables[1][0]["PaidDays"]).ToTime("0.00");
                            dblVacationDays = parseFloat(this.dsVacationdays.Tables[1][0]["PaidDays"]);
                        }
                    }
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha7");
                    if (fldAPV instanceof PactTextBoxData) {
                        fldAPV.Text = parseFloat(this.dsVacationdays.Tables[1][0]["CreditedDays"]).ToTime("00.00")
                    }
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha11");
                    if (fldAPV instanceof PactTextBoxData) {
                        fldAPV.Text = parseFloat(this.dsVacationdays.Tables[1][0]["ExcessDays"]).ToTime("00.00")
                    }
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha12");
                    if (fldAPV instanceof PactTextBoxData) {
                        fldAPV.Text = parseFloat(this.dsVacationdays.Tables[1][0]["RemainingDays"]).ToTime("00.00")
                    }
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha26");
                    if (fldAPV != undefined && fldAPV instanceof PactTextBoxData) {
                        fldAPV.Text = parseFloat(this.dsVacationdays.Tables[1][0]["FSEncashDays"]).ToTime("00.00")
                    }
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha27");
                    if (fldAPV != undefined && fldAPV instanceof PactTextBoxData) {
                        fldAPV.Text = parseFloat(this.dsVacationdays.Tables[1][0]["TotalTaken"]).ToTime("00.00")
                    }
                }
                else {
                    if (this.dsVacationdays.Tables[1].length > 0) {
                        this.DisplayMessage = this.dsVacationdays.Tables[1][0]["VacationDaysMessage"].toString();
                    }
                    this.MessageVisibility = true;
                    return;
                }
            }
            //end:loading vacation related days
            //start:loading vacation amount details
            //DataSet dsVactionAmount = null;
            let fldObj: MimizField;
            this.LEDict = new Dictionary<MimizField>();

            //dsVactionAmount = ScreenObject.GetVacationAmount(dtFromDate, dtToDate, lngEmpCode, DocID);

            this.oVac = new EvaluatePayrollFormulas();
            this.oVac.iDocID = this.ScreenObject.DocID;
            if (this.ScreenObject.Preferences.ContainsKey("ConsiderLoanswhilegoingonVacation") && !Util.IsEmpty(this.ScreenObject.Preferences["ConsiderLoanswhilegoingonVacation"]))
                this.ConsiderLoanswhilegoingonVacation = parseBoolean(this.ScreenObject.Preferences["ConsiderLoanswhilegoingonVacation"]);
            this.oVac.GetVacationAmountDetails(this.dsVacationdays, this.ConsiderLoanswhilegoingonVacation);//dtFromDate, dtToDate, lngEmpCode, DocID, 0);

            //if (oVac.arrLstVacAmountFields.length > 0)
            //{
            if (this.oVac.arrLstVacAmountFields.length > 0) {
                //FILLING COMPONENT TYPE DETAILS IN GRIDDATA
                let drGrid = null;
                let RowPosition = 0;
                let drCL1 = null;
                drGrid = null;
                let dblNETAMOUNT = 0, dblTotEarnings = 0, dblTotDeductions = 0;
                this.ScreenObject.GridDataObj.Clear();
                let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                for (let k = 0; k < this.oVac.arrLstVacAmountFields.length; k++) {
                    drGrid = this.ScreenObject.GridDataObj.NewRow();
                    this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                    RowPosition++;
                    if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"])) {
                        drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                    }
                    drGrid["dcAlpha20"] = this.oVac.arrLstVacAmountFields[k].ComponentID;
                    drGrid["dcAlpha21"] = this.oVac.arrLstVacAmountFields[k].TypeId;

                    if (parseFloat(this.oVac.arrLstVacAmountFields[k].TypeId) == 2) {
                        if (parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage) > 0) {
                            fldObj = new MimizField(this.oVac.arrLstVacAmountFields[k].ComponentName, "");
                            this.LEDict.push(this.oVac.arrLstVacAmountFields[k].ComponentName, fldObj);
                            this.LEDict[this.oVac.arrLstVacAmountFields[k].ComponentName].setFieldValue(this.oVac.arrLstVacAmountFields[k].PercActualAmount);
                            let temp1 = this.LEDict;
                            drGrid["dcNum1"] = (dblVacationDays) * parseFloat(BaseService.eval.EvaluateExpression(this.oVac.arrLstVacAmountFields[k].Formula, temp1));
                        }
                        else if (parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage) < 0) {
                            drGrid["dcNum1"] = parseFloat(this.oVac.arrLstVacAmountFields[k].ActualAmount);
                        }
                        else {
                            drGrid["dcNum1"] = 0;
                        }
                    }
                    else {
                        drGrid["dcNum1"] = parseFloat(this.oVac.arrLstVacAmountFields[k].ActualAmount);
                    }

                    drGrid["dcAlpha23"] = parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage);
                    //CALCULATING NET AMOUNT
                    if (drGrid["dcAlpha21"] != null) {
                        if (parseFloat(drGrid["dcAlpha21"]) == 2) {
                            if (drGrid["dcNum1"] != null && !isNaN(drGrid["dcNum1"])) {
                                dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum1"]);
                            }
                            if (drGrid["dcNum2"] != null && !isNaN(drGrid["dcNum2"])) {
                                dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum2"]);
                            }
                            if (drGrid["dcNum3"] != null && !isNaN(drGrid["dcNum3"])) {
                                dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum3"]);
                            }
                        }
                        else if (parseFloat(drGrid["dcAlpha21"]) != 2) {
                            if (drGrid["dcNum1"] != null) {
                                dblTotDeductions = dblTotDeductions + parseFloat(drGrid["dcNum1"]);
                            }
                        }
                    }

                    this.CalculateTotals(drGrid, false);
                }
                dblNETAMOUNT = (dblTotEarnings + dblOPVacSalary) - dblTotDeductions;
                fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha6");
                if (fldAPV instanceof PactTextBoxData) {
                    fldAPV.Text = dblNETAMOUNT.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]);
                }
                this.GridNetTotal = parseFloat(dblNETAMOUNT.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));
                this.RefreshNetAmount();
            }
            this.ShowVacationCreditDaysDetail(lngEmpCode, dtmpExDays);
            //}
            //end:loading vacation amount details

            if (!this.isVacContractedit && BaseService.SessionManager.Preferences.ContainsKey("VacationBasedOnContract") && parseInt(BaseService.SessionManager.Preferences["VacationBasedOnContract"]) > 0) {
                let dt = BaseService.common.GetDataTable("PAY089", lngEmpCode.toString() + "~" + parseInt(BaseService.SessionManager.Preferences["VacationBasedOnContract"]));
                if (dt != null && dt.length > 0) {
                    this.ApplyVacationContract();
                }
            }
        }
    }

    public ApplyVacationIsEncash(sender: string) {
        this.dsVacationdays = null;

        let dtFromDate = new Date(), dtToDate = new Date();
        let lngEmpCode = 0;
        let dblOPVacDays = 0, dblVacationDays = 0, dblCreditedDays = 0, dblDays = 0, dblEncashDays = 0, dblOPVacSalary = 0, dblTotalVacTaken = 0;

        let IsSelected = "", IsEncashRemaining = "";
        var fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha16");
        if (fldAPV instanceof PactComboBoxData && !Util.IsEmpty(fldAPV.SelectedValue)) {
            if (fldAPV.SelectionChangedCommand == null && !BaseService.SessionManager.IsWebApplication)
                return;

            IsSelected = fldAPV.SelectedValue.toString();
        }
        var fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha14") as PactTextBoxData;
        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha13");
        if (fldAPV instanceof PactComboBoxData && !Util.IsEmpty(fldAPV.SelectedValue)) {
            if (fldAPV.SelectionChangedCommand == null && Util.IsEmpty(fldAPV2.Text) && IsSelected != "Yes" && !BaseService.SessionManager.IsWebApplication)
                return;

            IsEncashRemaining = fldAPV.SelectedValue.toString();
        }

        fldAPV = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
        if (fldAPV instanceof PactListBoxData && fldAPV.SelectedValue > 0)
            lngEmpCode = fldAPV.SelectedValue;
        else if (fldAPV instanceof PactCodeNameListBoxData && fldAPV.SelectedValue > 0)
            lngEmpCode = fldAPV.SelectedValue;

        if (lngEmpCode == 0)
            return;

        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
        if (fldAPV instanceof PactExtraFieldDateData && fldAPV.Date) {
            dtFromDate = fldAPV.Date;
        }

        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
        if (fldAPV instanceof PactExtraFieldDateData && fldAPV.Date) {
            dtToDate = fldAPV.Date;
        }
        this.CalculateTotals(null, false);
        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha15");
        if (fldAPV instanceof PactComboBoxData) {
            fldAPV.SelectedValue = "No";
            fldAPV.IsReadOnly = true;
        }
        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha22");
        if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
            dblOPVacDays = parseFloat(fldAPV.Text);
        }

        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
        if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
            dblOPVacSalary = parseFloat(fldAPV.Text);
        }

        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha10");
        if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
            dblVacationDays = parseFloat(fldAPV.Text);
        }
        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha7");
        if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
            dblCreditedDays = parseFloat(fldAPV.Text);
        }
        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha27");
        if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
            dblTotalVacTaken = parseFloat(fldAPV.Text);
        }

        if (IsSelected == "Yes" || IsEncashRemaining == "Yes") {

            if (IsSelected == "Yes") {
                fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha13");
                if (fldAPV instanceof PactComboBoxData) {
                    fldAPV.SelectedValue = "Yes";
                    fldAPV.IsReadOnly = true;
                }

                fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                if (fldAPV instanceof PactExtraFieldDateData && fldAPV.Date) {
                    dtFromDate = fldAPV.Date;
                    fldAPV.IsReadOnly = true;
                }

                fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                if (fldAPV instanceof PactExtraFieldDateData && fldAPV.Date) {
                    //fldAPV.SelectedDateChanged = null;
                    fldAPV.Date = dtFromDate;
                    dtToDate = fldAPV.Date;
                    fldAPV.IsReadOnly = true;
                }
                //start:loading vacation related days
                fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                if (fldAPV instanceof PactTextBoxData) {
                    fldAPV.Text = dblDays.toString();
                }
                fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha8");
                if (fldAPV instanceof PactTextBoxData) {
                    fldAPV.Text = dblDays.toString();
                }
                fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha9");
                if (fldAPV instanceof PactTextBoxData) {
                    fldAPV.Text = dblDays.toString();
                }
                fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha10");
                if (fldAPV instanceof PactTextBoxData) {
                    fldAPV.Text = dblDays.toString();
                    dblVacationDays = parseFloat(fldAPV.Text.toString());
                }
                fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                if (fldAPV instanceof PactExtraFieldDateData) {
                    if (dblVacationDays == 0) {
                        fldAPV.Date = dtFromDate.AddDays(1);
                    }
                }
            }
            else if (IsSelected == "No" && IsEncashRemaining == "Yes" && sender == null && !Util.IsEmpty(fldAPV2.Text) && parseFloat(fldAPV2.Text.toString()) > 0) {
                fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha13");
                if (fldAPV instanceof PactComboBoxData) {
                    fldAPV.SelectedValue = "No";
                    fldAPV.IsReadOnly = false;
                    fldAPV2.IsReadOnly = true;
                    fldAPV2.Text = "0";
                    IsEncashRemaining = "No";
                }
            }

            if (IsEncashRemaining == "Yes" && sender == null) {
                fldAPV2.Text = "0";
                fldAPV2.IsReadOnly = false;
            }
            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha14");
            if (fldAPV instanceof PactTextBoxData) {
                var fldAPV1 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha12");
                if (sender != null && sender.toString() == "lostfoucs") {
                    if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                        dblEncashDays = parseFloat(fldAPV.Text);
                    }
                    if (fldAPV1 instanceof PactTextBoxData && !Util.IsEmpty(fldAPV1.Text)) {
                        if (!Util.IsEmpty(this.CalcCreditFromDOJ) && this.CalcCreditFromDOJ.toUpperCase() == "YES")
                            fldAPV1.Text = (((dblCreditedDays + dblOPVacDays) - dblTotalVacTaken) - dblVacationDays - dblEncashDays).toString();
                        else
                            fldAPV1.Text = ((dblCreditedDays + dblOPVacDays) - dblVacationDays - dblEncashDays).toString();
                    }
                    //remaining days
                    if (fldAPV1 instanceof PactTextBoxData) {
                        if (!Util.IsEmpty(this.CalcCreditFromDOJ) && this.CalcCreditFromDOJ.toUpperCase() == "YES") {
                            if (parseFloat((((dblCreditedDays + dblOPVacDays) - dblTotalVacTaken) - dblVacationDays).toString()) < parseFloat(fldAPV.Text)) {
                                // fldAPV.Text = fldAPV1.Text;
                                this.DisplayMessage = "Encash days should be less than or equal to remaining days";
                                this.MessageVisibility = true;
                                return;
                            }
                            else {
                                this.DisplayMessage = "";
                                this.MessageVisibility = false;
                                dblEncashDays = parseFloat(fldAPV.Text);
                            }
                        }
                        else {
                            if (parseFloat(((dblCreditedDays + dblOPVacDays) - dblVacationDays).toString()) < parseFloat(fldAPV.Text)) {
                                // fldAPV.Text = fldAPV1.Text;
                                this.DisplayMessage = "Encash days should be less than or equal to remaining days";
                                this.MessageVisibility = true;
                                return;
                            }
                            else {
                                this.DisplayMessage = "";
                                this.MessageVisibility = false;
                                dblEncashDays = parseFloat(fldAPV.Text);
                            }
                        }
                    }
                }
                else {
                    if (IsSelected == "No" && sender == null) {
                        fldAPV.Text = "0";
                        dblEncashDays = 0;
                        if (!Util.IsEmpty(this.CalcCreditFromDOJ) && this.CalcCreditFromDOJ.toUpperCase() == "YES")
                            (fldAPV1 as PactTextBoxData).Text = (((dblOPVacDays + dblCreditedDays) - dblTotalVacTaken) - dblVacationDays).toString();
                        else
                            (fldAPV1 as PactTextBoxData).Text = ((dblOPVacDays + dblCreditedDays) - dblVacationDays).toString();
                    }
                    else {
                        fldAPV.IsReadOnly = false;
                        if (!Util.IsEmpty(this.CalcCreditFromDOJ) && this.CalcCreditFromDOJ.toUpperCase() == "YES") {
                            fldAPV.Text = ((dblOPVacDays + dblCreditedDays) - dblTotalVacTaken).toString();
                            dblEncashDays = (dblOPVacDays + dblCreditedDays) - dblTotalVacTaken;
                        }
                        else {
                            fldAPV.Text = ((dblOPVacDays + dblCreditedDays) - dblTotalVacTaken).toString();
                            dblEncashDays = (dblOPVacDays + dblCreditedDays) - dblTotalVacTaken;
                        }
                        (fldAPV1 as PactTextBoxData).Text = "0";
                    }
                }
            }
        }
        else {
            fldAPV2.IsReadOnly = true;
            fldAPV2.Text = "0";
            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha22");
            if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                dblOPVacDays = parseFloat(fldAPV.Text);
            }
            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha7");
            if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                dblCreditedDays = parseFloat(fldAPV.Text);
            }

            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha10");
            if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                dblVacationDays = parseFloat(fldAPV.Text);
            }
            var fldAPV1 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha12");
            if (fldAPV1 instanceof PactTextBoxData && !Util.IsEmpty(fldAPV1.Text)) {
                fldAPV1.Text = ((dblCreditedDays + dblOPVacDays) - dblVacationDays).toString();
            }
        }
        //end:loading vacation related days
        //start:loading vacation amount details
        //DataSet dsVactionAmount = null;
        let fldObj: MimizField;
        this.LEDict = new Dictionary<MimizField>();

        this.dsVacationdays = this.ScreenObject.GetVacationDays(dtFromDate, dtToDate, lngEmpCode, this.DocID, dblOPVacDays, 0);

        this.oVac = new EvaluatePayrollFormulas();
        this.oVac.iDocID = this.ScreenObject.DocID;
        if (this.ScreenObject.Preferences.ContainsKey("ConsiderLoanswhilegoingonVacation") && !Util.IsEmpty(this.ScreenObject.Preferences["ConsiderLoanswhilegoingonVacation"]))
            this.ConsiderLoanswhilegoingonVacation = parseBoolean(this.ScreenObject.Preferences["ConsiderLoanswhilegoingonVacation"]);
        this.oVac.GetVacationAmountDetails(this.dsVacationdays, this.ConsiderLoanswhilegoingonVacation);


        let dtEnc: any = BaseService.common.GetDataTable("PAY075", lngEmpCode.toString() + "~" + dtFromDate.ToString("dd/MMM/yyyy"));

        let ConsiderEncashFormulaFromCustomization = false;
        let sEncashFormula = "";
        if (dtEnc != null && dtEnc.length > 0)
            sEncashFormula = dtEnc[0]["EncashFormula"].toString();

        if (BaseService.SessionManager.Preferences.ContainsKey("CalcVacEncAmtBsdOnCustPayEncFormula"))
            ConsiderEncashFormulaFromCustomization = parseBoolean(BaseService.SessionManager.Preferences["CalcVacEncAmtBsdOnCustPayEncFormula"]);

        //dsVactionAmount = ScreenObject.GetVacationAmount(dtFromDate, dtToDate, lngEmpCode, DocID);
        //if (oVac.arrLstVacAmountFields.length > 0)
        //{
        if (this.oVac != null && this.oVac.arrLstVacAmountFields.length > 0) {
            //FILLING COMPONENT TYPE DETAILS IN GRIDDATA
            let drGrid = null;
            let RowPosition = 0;
            let drCL1 = null;
            drGrid = null;
            let dblNETAMOUNT = 0, dblTotEarnings = 0, dblTotDeductions = 0, dEncAmt = 0;;
            //object temp1 = LEDict;
            this.ScreenObject.GridDataObj.Clear();
            let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
            for (let k = 0; k < this.oVac.arrLstVacAmountFields.length; k++) {
                drGrid = this.ScreenObject.GridDataObj.NewRow();
                this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                RowPosition++;
                if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"])) {
                    drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                }
                drGrid["dcAlpha20"] = this.oVac.arrLstVacAmountFields[k].ComponentID;
                //drCL1 = dsVactionAmount.Tables[0].Select("COMPONENTID=='" + parseInt(drGrid["dcAlpha20"]) + "'");
                drGrid["dcAlpha21"] = this.oVac.arrLstVacAmountFields[k].TypeId;

                if (parseFloat(this.oVac.arrLstVacAmountFields[k].TypeId) == 2) {
                    if (parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage) > 0 || this.oVac.arrLstVacAmountFields[k].ComponentName.toString() == "EMPLOYEE_BASIC") {
                        fldObj = new MimizField(this.oVac.arrLstVacAmountFields[k].ComponentName.toString(), "");
                        this.LEDict.push(this.oVac.arrLstVacAmountFields[k].ComponentName.toString(), fldObj);
                        this.LEDict[this.oVac.arrLstVacAmountFields[k].ComponentName.toString()].setFieldValue(this.oVac.arrLstVacAmountFields[k].PercActualAmount.toString());
                        let temp1 = this.LEDict;
                        if (this.oVac.arrLstVacAmountFields[k].ComponentName.toString() == "EMPLOYEE_BASIC" && IsSelected == "Yes") {
                            drGrid["dcNum1"] = 0;
                            if (ConsiderEncashFormulaFromCustomization) {
                                this.ScreenObject.GridData[0]["dcNum2"] = 0;
                                sEncashFormula = sEncashFormula.Replace("EncashDays", dblEncashDays.toString());
                                if (sEncashFormula.length > 0)
                                    this.ScreenObject.GridData[0]["dcNum2"] = this.ReturnFormulaValue(lngEmpCode, dtFromDate, sEncashFormula);
                                dEncAmt = parseFloat(this.ScreenObject.GridData[0]["dcNum2"]);
                            }
                            else
                                drGrid["dcNum2"] = (dblEncashDays) * parseFloat(BaseService.eval.EvaluateExpression(this.oVac.arrLstVacAmountFields[k].Formula.toString(), temp1));
                        }
                        else {
                            //drGrid["dcNum2"] = 0;
                            if (ConsiderEncashFormulaFromCustomization) {
                                this.ScreenObject.GridData[0]["dcNum2"] = 0;
                                sEncashFormula = sEncashFormula.Replace("EncashDays", dblEncashDays.toString());
                                if (sEncashFormula.length > 0)
                                    this.ScreenObject.GridData[0]["dcNum2"] = this.ReturnFormulaValue(lngEmpCode, dtFromDate, sEncashFormula);
                                dEncAmt = parseFloat(this.ScreenObject.GridData[0]["dcNum2"]);
                            }
                            else
                                drGrid["dcNum2"] = (dblEncashDays) * parseFloat(BaseService.eval.EvaluateExpression(this.oVac.arrLstVacAmountFields[k].Formula.toString(), temp1));
                            drGrid["dcNum1"] = (dblVacationDays) * parseFloat(BaseService.eval.EvaluateExpression(this.oVac.arrLstVacAmountFields[k].Formula.toString(), temp1));
                        }
                    }
                    else if (parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage) < 0) {
                        drGrid["dcNum2"] = 0;
                        drGrid["dcNum1"] = parseFloat(this.oVac.arrLstVacAmountFields[k].ActualAmount);
                    }
                }
                //else
                //{
                //    drGrid["dcNum1"] = parseFloat(oVac.arrLstVacAmountFields[k].ActualAmount);
                //}
                drGrid["dcAlpha23"] = parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage);
                //drGrid["dcAlpha23"] = parseFloat(-4);

                //CALCULATING NET AMOUNT
                if (drGrid["dcAlpha21"] != null) {
                    if (parseFloat(drGrid["dcAlpha21"]) == 2) {
                        if (drGrid["dcNum1"] != null) {
                            dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum1"]);
                        }
                        if (drGrid["dcNum2"] != null) {
                            dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum2"]);
                        }
                        if (drGrid["dcNum3"] != null) {
                            dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum3"]);
                        }
                    }
                    else if (parseFloat(drGrid["dcAlpha21"]) != 2) {
                        if (drGrid["dcNum1"] != null) {
                            dblTotDeductions = dblTotDeductions + parseFloat(drGrid["dcNum1"]);
                        }
                    }
                }
                this.CalculateTotals(drGrid, false);
            }
            //dblTotEarnings += dEncAmt;// commented Encash Amount is getting Doubled in net when % is given
            dblNETAMOUNT = (dblTotEarnings + dblOPVacSalary) - dblTotDeductions;
            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha6");
            if (fldAPV instanceof PactTextBoxData) {
                fldAPV.Text = dblNETAMOUNT.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]);
            }
            this.GridNetTotal = parseFloat(dblNETAMOUNT.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));
            this.RefreshNetAmount()
        }
        //}
        //end:loading vacation amount details
    }
    private ReturnFormulaValue(lEmpNode: number, dtFrom: Date, sFormula: string): string {
        let sRet = "0";

        let oEval: any = new EvaluatePayrollFormulas();
        oEval.sEmpSeqNo = lEmpNode.toString();
        let refObj = { PayrollMonth: oEval.PayrollMonth, PayrollMonthStart: oEval.PayrollMonthStart, PayrollMonthEnd: oEval.PayrollMonthEnd }
        //Util.SetPayrollDate(dtFrom.Date(), out oEval.PayrollMonth, out oEval.PayrollMonthStart, out oEval.PayrollMonthEnd);
        Util.SetPayrollDate(dtFrom.Date(), refObj);
        oEval.PayrollMonth = refObj.PayrollMonth;
        oEval.PayrollMonthStart = refObj.PayrollMonthStart;
        oEval.PayrollMonthEnd = refObj.PayrollMonthEnd;
        oEval.arrLstCPFields[6].Clear();

        let oCPF = new CPFields();
        oCPF.ComponentName = "RetFormulaValue";
        oCPF.SNo = 0;
        oCPF.Formula = sFormula;
        oEval.arrLstCPFields[6].push(oCPF);

        oEval.Intialize();
        oEval.ExecuteAllFormulas();

        sRet = oEval.arrLstCPFields[6][0].dEarned;
        return sRet;
    }
    public ApplyVacationIsTextEncash(sender: any) {
        this.ApplyVacationIsEncash("lostfoucs");
    }
    public ApplyVacationExcessdays(sender: string) {

        let IsSelected = "";
        var fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha15");
        if (fldAPV instanceof PactComboBoxData && !Util.IsEmpty(fldAPV.SelectedValue)) {
            if (fldAPV.SelectionChangedCommand == null && !BaseService.SessionManager.IsWebApplication)
                return;

            IsSelected = fldAPV.SelectedValue.toString();
        }
        if (IsSelected == "Yes") {
            this.CalculateTotals(null, false);

            let dtFromDate = new Date(), dtToDate = new Date();
            let lngEmpCode = 0;
            let dblOPVacDays = 0, dblVacationDays = 0, dblExcessDays = 0, dblOPVacSalary = 0;

            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha16");
            if (fldAPV instanceof PactComboBoxData) {
                fldAPV.SelectedValue = "No";
                fldAPV.IsReadOnly = true;
            }
            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha14");
            if (fldAPV instanceof PactTextBoxData) {
                fldAPV.Text = "";
                fldAPV.IsReadOnly = true;
            }

            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
            if (fldAPV instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV.Date)) {
                dtFromDate = fldAPV.Date;
            }

            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
            if (fldAPV instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV.Date)) {
                dtToDate = fldAPV.Date;
            }

            fldAPV = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (fldAPV instanceof PactListBoxData && fldAPV.SelectedValue > 0)
                lngEmpCode = fldAPV.SelectedValue;
            else if (fldAPV instanceof PactCodeNameListBoxData && fldAPV.SelectedValue > 0)
                lngEmpCode = fldAPV.SelectedValue;

            if (lngEmpCode == 0)
                return;

            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha22");
            if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                dblOPVacDays = parseFloat(fldAPV.Text);
            }

            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
            if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                dblOPVacSalary = parseFloat(fldAPV.Text);
            }

            //start:loading vacation related days
            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha10");
            if (fldAPV instanceof PactTextBoxData) {
                //fldAPV.Text = dsVacationdays.Tables[0][0]["PAIDDAYS"].toString();
                dblVacationDays = parseFloat(fldAPV.Text);
            }

            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha11");
            if (fldAPV instanceof PactTextBoxData) {
                dblExcessDays = parseFloat(fldAPV.Text);
            }

            if (dblExcessDays <= 0) {
                this.DisplayMessage = "No Excess days available";
                this.MessageVisibility = true;
                return;
            }

            // if (Util.ParseDate(dtFromDate) == Util.ParseDate(dtToDate)) {
            //     this.DisplayMessage = "Please select the date range";
            //     this.MessageVisibility = true;
            //     return;
            // }
            //end:loading vacation related days
            //start:loading vacation amount details
            //DataSet dsVactionAmount = null;
            let fldObj: MimizField;
            this.LEDict = new Dictionary<MimizField>();

            //dsVactionAmount = ScreenObject.GetVacationAmount(dtFromDate, dtToDate, lngEmpCode, DocID);
            //if (oVac.arrLstVacAmountFields.length > 0)
            //{
            if (this.oVac.arrLstVacAmountFields.length > 0) {
                //FILLING COMPONENT TYPE DETAILS IN GRIDDATA
                let drGrid = null;
                let RowPosition = 0;
                let drCL1 = null;
                drGrid = null;
                let dblNETAMOUNT = 0, dblTotEarnings = 0, dblTotDeductions = 0;
                //object temp1 = LEDict;
                this.ScreenObject.GridDataObj.Clear();
                let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                for (let k = 0; k < this.oVac.arrLstVacAmountFields.length; k++) {
                    drGrid = this.ScreenObject.GridDataObj.NewRow();
                    this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                    RowPosition++;
                    if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"])) {
                        drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                    }
                    drGrid["dcAlpha20"] = this.oVac.arrLstVacAmountFields[k].ComponentID;
                    //drCL1 = dsVactionAmount.Tables[0].Select("COMPONENTID='" + parseInt(drGrid["dcAlpha20"]) + "'");
                    drGrid["dcAlpha21"] = this.oVac.arrLstVacAmountFields[k].TypeId;

                    if (parseFloat(this.oVac.arrLstVacAmountFields[k].TypeId) == 2 && parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage) > 0) {
                        fldObj = new MimizField(this.oVac.arrLstVacAmountFields[k].ComponentName.toString(), "");
                        this.LEDict.push(this.oVac.arrLstVacAmountFields[k].ComponentName.toString(), fldObj);
                        this.LEDict[this.oVac.arrLstVacAmountFields[k].ComponentName.toString()].setFieldValue(this.oVac.arrLstVacAmountFields[k].PercActualAmount.toString());
                        let temp1 = this.LEDict;
                        if (this.oVac.arrLstVacAmountFields[k].ComponentName.toString() == "EMPLOYEE_BASIC") {
                            drGrid["dcNum2"] = 0;
                            drGrid["dcNum1"] = (dblVacationDays) * parseFloat(BaseService.eval.EvaluateExpression(this.oVac.arrLstVacAmountFields[k].Formula.toString(), temp1));
                            drGrid["dcNum3"] = (dblExcessDays) * parseFloat(BaseService.eval.EvaluateExpression(this.oVac.arrLstVacAmountFields[k].Formula.toString(), temp1));
                            drGrid["dcAlpha23"] = -4;
                        }
                        else {
                            drGrid["dcNum2"] = 0;
                            drGrid["dcNum3"] = (dblExcessDays) * parseFloat(BaseService.eval.EvaluateExpression(this.oVac.arrLstVacAmountFields[k].Formula.toString(), temp1));
                            drGrid["dcNum1"] = (dblVacationDays) * parseFloat(BaseService.eval.EvaluateExpression(this.oVac.arrLstVacAmountFields[k].Formula.toString(), temp1));
                        }
                    }
                    else if (parseFloat(this.oVac.arrLstVacAmountFields[k].TypeId) == 2 && parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage) < 0) {
                        drGrid["dcNum2"] = 0;
                        drGrid["dcNum1"] = parseFloat(this.oVac.arrLstVacAmountFields[k].ActualAmount);
                    }
                    //else
                    //{
                    //    drGrid["dcNum1"] = parseFloat(oVac.arrLstVacAmountFields[k].ActualAmount);
                    //}

                    //if (oVac.arrLstVacAmountFields[k].ComponentName.toString() != "EMPLOYEE_BASIC")
                    //{
                    drGrid["dcAlpha23"] = parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage);
                    //}
                    //CALCULATING NET AMOUNT
                    if (drGrid["dcAlpha21"] != null) {
                        if (parseFloat(drGrid["dcAlpha21"]) == 2) {
                            if (drGrid["dcNum1"] != null) {
                                dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum1"]);
                            }
                            if (drGrid["dcNum2"] != null) {
                                dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum2"]);
                            }
                            if (drGrid["dcNum3"] != null) {
                                dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum3"]);
                            }
                        }
                        else if (parseFloat(drGrid["dcAlpha21"]) != 2) {
                            if (drGrid["dcNum1"] != null) {
                                dblTotDeductions = dblTotDeductions + parseFloat(drGrid["dcNum1"]);
                            }
                        }
                    }
                    this.CalculateTotals(drGrid, false);
                }
                dblNETAMOUNT = (dblTotEarnings + dblOPVacSalary) - dblTotDeductions;
                fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha6");
                if (fldAPV instanceof PactTextBoxData) {
                    fldAPV.Text = dblNETAMOUNT.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]);
                }
                this.GridNetTotal = parseFloat(dblNETAMOUNT.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));;
                this.RefreshNetAmount()
            }
            //}
            //end:loading vacation amount details
        }
    }

    public async ApplyVacationContract() {
        let sEmpID = "1";
        let dblOPVacDays = 0, dblOPVacSalary = 0;
        let dtFromDate = new Date(), dtToDate = new Date();
        let vFld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
        if (vFld != undefined) {
            if (vFld instanceof PactListBoxData)
                sEmpID = vFld.SelectedValue.toString();
            else if (vFld instanceof PactCodeNameListBoxData)
                sEmpID = vFld.SelectedValue.toString();
        }

        let fldAPV: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
        if (fldAPV != undefined && fldAPV instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV.Date)) {
            dtFromDate = fldAPV.Date;
        }

        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
        if (fldAPV != undefined && fldAPV instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV.Date)) {
            dtToDate = fldAPV.Date;
        }

        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha22");
        if (fldAPV != undefined && fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
            dblOPVacDays = parseFloat(fldAPV.Text);
        }
        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
        if (fldAPV != undefined && fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
            dblOPVacSalary = parseFloat(fldAPV.Text);
        }

        if (parseInt(sEmpID) > 1 && (this.PrevVacFrom != dtFromDate || this.PrevVacTo != dtToDate)) {
            let dVacDays = 0, dVCExcessDays = 0, dVCPaidDays = 0;
            fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
            if (fldAPV != undefined && fldAPV instanceof PactTextBoxData) {
                dVacDays = parseFloat(fldAPV.Text);
            }

            this.PrevVacFrom = dtFromDate;
            this.PrevVacTo = dtToDate;
            const { VacationBasedOnContractViewModel } = await import('../../ess/VacationBasedOnContract/VacationBasedOnContractViewModel');
            const { VacationBasedOnContractComponent } = await import('../../ess/VacationBasedOnContract/Vacation.basedon.contract.compont');
            let objVDC = null;
            objVDC = new VacationBasedOnContractViewModel();
            objVDC.VacationBasedOnContractViewModel(this.DocID, sEmpID, dVacDays, this.dtVacContract, dtFromDate, dtToDate, this.isVacPopup);
            await BaseService.page.openDialog(objVDC, VacationBasedOnContractComponent, { ShowCenter: true });
            if (objVDC != null && objVDC.DialogResult) {
                this.dtVacContract = objVDC.dtVacationContract;
                this.isVacPopup = objVDC.TisVacPopup;
                if ((objVDC.dVacCDays < dVacDays && !this.isVacPopup) || (objVDC.dVacCDays <= dVacDays && this.ScreenObject.DocID > 0)) {
                    this.dsVacationdays = this.ScreenObject.GetVacationDays(dtFromDate, dtToDate, parseInt(sEmpID), this.DocID, dblOPVacDays, 0);

                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha10");
                    if (fldAPV != undefined && fldAPV instanceof PactTextBoxData) {
                        fldAPV.Text = parseFloat(objVDC.dVacCDays).ToString("0.00");
                        dVCPaidDays = parseFloat(objVDC.dVacCDays);
                    }
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha11");
                    if (fldAPV != undefined && fldAPV instanceof PactTextBoxData) {
                        fldAPV.Text = (dVacDays - dVCPaidDays).ToString("0.00");
                        dVCExcessDays = dVacDays - dVCPaidDays;
                    }
                    fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha12");
                    if (fldAPV != undefined && fldAPV instanceof PactTextBoxData) {
                        fldAPV.Text = ((dblOPVacDays + parseFloat(this.dsVacationdays.Tables[1][0]["CREDITEDDAYS"])) - dVCPaidDays).ToString("0.00");
                    }

                    //START :: GRID Calculation
                    let fldObj: MimizField = new MimizField();
                    this.LEDict = new Dictionary<MimizField>();

                    //dsVactionAmount = ScreenObject.GetVacationAmount(dtFromDate, dtToDate, lngEmpCode, DocID);

                    this.oVac = new EvaluatePayrollFormulas();
                    this.oVac.iDocID = this.ScreenObject.DocID;
                    if (this.ScreenObject.Preferences.ContainsKey("ConsiderLoanswhilegoingonVacation") && !Util.IsEmpty(this.ScreenObject.Preferences["ConsiderLoanswhilegoingonVacation"]))
                        this.ConsiderLoanswhilegoingonVacation = parseBoolean(this.ScreenObject.Preferences["ConsiderLoanswhilegoingonVacation"]);
                    this.oVac.GetVacationAmountDetails(this.dsVacationdays, this.ConsiderLoanswhilegoingonVacation);//dtFromDate, dtToDate, lngEmpCode, DocID, 0);

                    //if (oVac.arrLstVacAmountFields.length > 0)
                    //{
                    if (this.oVac.arrLstVacAmountFields.length > 0) {
                        //FILLING COMPONENT TYPE DETAILS IN GRIDDATA
                        let drGrid: any = null;
                        let RowPosition = 0;
                        let drCL1: any = null;
                        drGrid = null;
                        let dblNETAMOUNT = 0, dblTotEarnings = 0, dblTotDeductions = 0;
                        this.ScreenObject.GridData.Clear();
                        let drCL: any = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                        for (let k = 0; k < this.oVac.arrLstVacAmountFields.length; k++) {
                            drGrid = this.ScreenObject.GridDataObj.NewRow();
                            this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                            RowPosition++;
                            if (drCL.length > 0 && Util.String(drCL[0]["UserDefaultValue"]) != "") {
                                drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                            }
                            drGrid["dcAlpha20"] = this.oVac.arrLstVacAmountFields[k].ComponentID;
                            drGrid["dcAlpha21"] = this.oVac.arrLstVacAmountFields[k].TypeId;

                            if (parseFloat(this.oVac.arrLstVacAmountFields[k].TypeId) == 2) {
                                if (parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage) > 0) {
                                    fldObj = new MimizField(this.oVac.arrLstVacAmountFields[k].ComponentName, "");
                                    this.LEDict.push(this.oVac.arrLstVacAmountFields[k].ComponentName, fldObj);
                                    this.LEDict[this.oVac.arrLstVacAmountFields[k].ComponentName].setFieldValue(this.oVac.arrLstVacAmountFields[k].PercActualAmount);
                                    let temp1 = this.LEDict;
                                    drGrid["dcNum1"] = (dVCPaidDays) * parseFloat(BaseService.eval.EvaluateExpression(this.oVac.arrLstVacAmountFields[k].Formula, temp1));
                                }
                                else if (parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage) < 0) {
                                    drGrid["dcNum1"] = parseFloat(this.oVac.arrLstVacAmountFields[k].ActualAmount);
                                }
                                else {
                                    drGrid["dcNum1"] = 0;
                                }
                            }
                            else {
                                drGrid["dcNum1"] = parseFloat(this.oVac.arrLstVacAmountFields[k].ActualAmount);
                            }

                            drGrid["dcAlpha23"] = parseFloat(this.oVac.arrLstVacAmountFields[k].Percentage);
                            //CALCULATING NET AMOUNT
                            if (drGrid["dcAlpha21"] != null) {
                                if (parseFloat(drGrid["dcAlpha21"]) == 2) {
                                    if (drGrid["dcNum1"] != null) {
                                        dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum1"]);
                                    }
                                    if (drGrid["dcNum2"] != null) {
                                        dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum2"]);
                                    }
                                    if (drGrid["dcNum3"] != null) {
                                        dblTotEarnings = dblTotEarnings + parseFloat(drGrid["dcNum3"]);
                                    }
                                }
                                else if (parseFloat(drGrid["dcAlpha21"]) != 2) {
                                    if (drGrid["dcNum1"] != null) {
                                        dblTotDeductions = dblTotDeductions + parseFloat(drGrid["dcNum1"]);
                                    }
                                }
                            }
                            this.ScreenObject.GridDataObj.updateRow(drGrid);
                            this.CalculateTotals(drGrid, false);
                        }
                        dblNETAMOUNT = (dblTotEarnings + dblOPVacSalary) - dblTotDeductions;
                        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha6");
                        if (fldAPV != undefined && fldAPV instanceof PactTextBoxData) {
                            fldAPV.Text = dblNETAMOUNT.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]);
                        }
                        this.GridNetTotal = parseFloat(dblNETAMOUNT.ToString("N" + BaseService.SessionManager.Preferences["DecimalsinAmount"]));
                        //base.OnPropertyChanged("NetAmount");

                    }
                    //END :: GRID Calculation
                }
            }
        }
    }

    //#endregion

    //#region "Daily Attendance"

    dsAllEmployeeData: any = null;
    IsGetAllEmployees = false;
    //public sBioErrLogs = "";
    public sDAErrLogs = "";
    public sbBioErrLogs = "";

    public GetAllEmployees(Dailyattendancedate: Date, DocID: number, EmpList: string) {
        try {
            let dsAllEmployees: any = null;
            let drGrid = null;
            let TotalHours = "", strSort = "", sEmpIDs = "";;
            let RowPosition = 0;
            let ref_Ddate = { value: this._Ddate }
            this.ScreenObject.OnDocPrefixChanged(this.ScreenObject.Prefix, 0, 0, ref_Ddate, false);
            this._Ddate = ref_Ddate.value;
            var fldDat = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha14");
            if (fldDat instanceof PactComboBoxData && !Util.IsEmpty(fldDat.SelectedValue)) {
                if (fldDat.SelectedValue.toString() == "TreeView")
                    strSort = "lft";
                else
                    strSort = fldDat.SelectedValue.toString();
            }

            this.clear(1);
            this._Ddate = Dailyattendancedate;
            this.QuickInfoVisibility = false;
            this.DQuickInfoVisibility = false;
            this.ScreenObject.DocID = 0;
            this.StatusID = 0;
            this.WorkFlowDocLevel = 0;
            this.ScreenObject.VoucherNo = "";
            this.ScreenObject.guid = "";
            this.DocStatus = "[" + BaseService.GetResource("Doc_Draft") + "]";
            this.ScreenObject.DocPrefix.TextBox.Text = (parseInt(this.ScreenObject.DocPrefix.TextBox.Text)).toString();


            var txtDatefldEmp = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
            (txtDatefldEmp as PactExtraFieldDateData).Date = Dailyattendancedate;

            if (EmpList.toString().toLowerCase().Contains("nodeid"))
                dsAllEmployees = this.ScreenObject.GetAllEmployeesList(Dailyattendancedate, DocID, 0, 0, EmpList);
            else
                dsAllEmployees = this.ScreenObject.GetAllEmployeesList(Dailyattendancedate, DocID, 0, 0, "");

            if (dsAllEmployees.Tables.length > 0) {
                if (dsAllEmployees.Tables[0].length > 0) {
                    //Emp Sort
                    let dvEmpsort = dsAllEmployees.Tables[0];
                    //dvEmpsort.Sort = strSort.toString();
                    dvEmpsort.sort((a, b) => a[strSort] - b[strSort]);
                    if (fldDat instanceof PactComboBoxData && fldDat.SelectedItem != null)
                        fldDat.SelectedItem.Name = strSort;

                    drGrid = null;
                    this.ScreenObject.GridDataObj.Clear();
                    let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');

                    this.dsAllEmployeeData = null;

                    for (let i = 0; i < dvEmpsort.length; i++) {
                        if (sEmpIDs.length > 0)
                            sEmpIDs += ",";

                        sEmpIDs += dvEmpsort[i]["EMPNODE"].toString();
                    }

                    //#region All Documents Data for Daily Attendance


                    //#endregion


                    this.dsAllEmployeeData = BaseService.common.GetDataSet("PAY091", sEmpIDs);

                    this.IsGetAllEmployees = true;

                    if (this.objPayDayCheck == null)
                        this.objPayDayCheck = new PayDayCheck(this.ScreenObject);


                    for (let k = 0; k < dvEmpsort.length; k++) {
                        drGrid = this.ScreenObject.GridDataObj.NewRow();
                        this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                        RowPosition++;
                        if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"])) {
                            drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                        }

                        if (this.ScreenObject.GridDataColumns.Contains("dcCCNID51Code"))
                            drGrid["dcCCNID51Code"] = dvEmpsort[k]["EMPCODE"];

                        drGrid["dcCCNID51_Key"] = dvEmpsort[k]["EMPNODE"];
                        drGrid["dcCCNID51"] = dvEmpsort[k]["EMPNAME"];
                        drGrid["dcAlpha10"] = 1;
                        drGrid["dcAlpha11"] = 1;
                        drGrid["dcAlpha13"] = 1;

                        this.FillDefaultProd(drGrid, "dcCCNID51");
                        this.Celleditend(drGrid, "dcCCNID51", 0);
                        //Celleditend(drGrid, "ProductCode", ScreenObject.CostCenterID);

                        if (this.ScreenObject.GridDataColumns.Contains("dcAlpha2") && this.ScreenObject.GridDataColumns.Contains("dcAlpha3"))
                            this.FillGeneralTimings(dvEmpsort[k]["EMPNODE"].toString(), Util.ParseDate(Dailyattendancedate).ToString("dd/MMM/yyyy"), drGrid);

                        if (this.ScreenObject.GridDataColumns.Contains("dcAlpha4"))
                            this.DistributeTotalHours(dvEmpsort[k]["EMPNODE"].toString(), Util.ParseDate(Dailyattendancedate).ToString("dd/MMM/yyyy"), drGrid, "");

                        //if (ScreenObject.GridDataColumns.Contains("dcCCNID2"))
                        //    drGrid["dcCCNID2_Key"] = "1";

                        //if (ScreenObject.GridDataColumns.Contains("dcCCNID4"))
                        //    drGrid["dcCCNID4_Key"] = "1";

                        //Checking the Document is locked for selected month
                        this.IsDocValid = false;
                        //strValidationMessage = IsDocumentLocked(drGrid, 40077, "");
                        //if (strValidationMessage != "")
                        //{
                        //    IsDocValid = false;
                        //    DisplayMessage = strValidationMessage;
                        //    MessageVisibility = true;
                        //    return;
                        //}
                        //else
                        //{
                        //    IsDocValid = true;
                        //    MessageVisibility = false;
                        //}

                        //var col1 = ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcCCNID51");
                        //if (col1 && !Util.IsEmpty(col1.Shortcut) && col1.Shortcut.toLowerCase() == "lostfocus" && ValidateData(col1, drGrid, true))
                        //    ScreenObject.GetExternalFuncData(col1.Mode, col1.SPName, col1.IPParams, col1.OPParams, drGrid);


                        //if (drGrid["dcAlpha3_Key"] != null && drGrid["dcAlpha2_Key"] != null)
                        //{
                        //    TimeSpan Hrs = Util.ParseDate(drGrid["dcAlpha3_Key"]) - Util.ParseDate(drGrid["dcAlpha2_Key"]);
                        //    TotalHours = Hrs.Hours + "." + Hrs.Minutes;
                        //    drGrid["dcNum1"] = parseFloat(TotalHours);
                        //}
                        //drGrid["dcNum2"] = 0;

                        //col1 = ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcNum1");
                        //if (col1 && !Util.IsEmpty(col1.Shortcut) && col1.Shortcut.toLowerCase() == "lostfocus" && ValidateData(col1, drGrid, true))
                        //    ScreenObject.GetExternalFuncData(col1.Mode, col1.SPName, col1.IPParams, col1.OPParams, drGrid);

                        this.ScreenObject.GridDataObj.updateRow(drGrid);
                        this.CalculateTotals(drGrid, false);
                    }
                    this.IsGetAllEmployees = false;
                    this.dsAllEmployeeData = null;
                }
            }
        }
        catch (error) {
            this.DisplayMessage = "Load Error";
            Logger.ErrorLog("AddEditDocumentViewModel:: GetAllEmployees" + error.stack);
        }
    }

    iDgColFrom = -1; iDgColUpto = -1;
    iDtColFrom = -1; iDtColUpto = -1;

    public FillDates_Click() {
        if (this.ScreenObject.DocumentType == 67) {
            //#region For Daily Attendance Documents

            let sEmpID = "1";
            var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (vFld) {
                if (vFld instanceof PactListBoxData)
                    sEmpID = vFld.SelectedValue.toString();
                else if (vFld instanceof PactCodeNameListBoxData)
                    sEmpID = vFld.SelectedValue.toString();
            }
            if (parseInt(sEmpID) <= 1) {
                this.DisplayMessage = "Select any Employee";
                this.MessageVisibility = true;
                return;
            }

            // FILLING DATES ONLY WHEN THE DAILY ATTENDANCE DATE FIELD IS IN LINE WISE
            var fldDat2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
            if (fldDat2) {
                this.ScreenObject.GridDataObj.Clear();
                let dtF = BaseService.SessionManager.PayrollMonthStart;
                let dtT = BaseService.SessionManager.PayrollMonthEnd;
                let i = 0;
                let drnew;
                while (dtF <= dtT) {
                    if (this.ScreenObject.GridData.length - 1 <= i) {
                        drnew = this.ScreenObject.GridDataObj.NewRow();
                        drnew["DocSeqNo"] = this.ScreenObject.GridData.length + 1;
                        drnew["DocDetailsID"] = 0;
                        this.ScreenObject.GridDataObj.addRow(drnew);
                    }

                    this.ScreenObject.GridData[i]["dcAlpha1"] = dtF.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                    this.ScreenObject.GridData[i]["dcAlpha1_Key"] = dtF;

                    this.FillDefaultProd(this.ScreenObject.GridData[i], "dcAlpha1");
                    this.Celleditend(this.ScreenObject.GridData[i], "dcAlpha1", 0);

                    dtF = dtF.AddDays(1);
                    i += 1;
                }
            }
            //#endregion
        }
        else if (this.ScreenObject.DocumentType == 92) {
            //#region Shift Assign

            let FromDate, ToDate;
            FromDate = this.ScreenObject.CustomTab.Pages[0].Fields.find(x => x instanceof PactExtraFieldDateData && x.DBColumnName == "dcAlpha1") as PactExtraFieldDateData;
            ToDate = this.ScreenObject.CustomTab.Pages[0].Fields.find(x => x instanceof PactExtraFieldDateData && x.DBColumnName == "dcAlpha2") as PactExtraFieldDateData;

            if (!FromDate.Date || !ToDate.Date) {
                this.DisplayMessage = "Please select dates";
                this.MessageVisibility = true;
                return;
            }
            else if (FromDate.Date > ToDate.Date) {
                this.DisplayMessage = "Please select ToDate greater than FromDate";
                this.MessageVisibility = true;
                return;
            }

            var btn = this.GetButton("Fill Dates");
            if (this.ScreenObject.DocID > 0) {
                if (btn != null) btn.Visible = false;
                FromDate.Enable = ToDate.Enable = false;
            }
            else {
                if (btn != null) btn.Visible = true;
                FromDate.Enable = ToDate.Enable = true;
            }

            for (let i = this.ScreenObject.ColumnSource.length - 1; i >= 0; i--) {
                if (this.ScreenObject.ColumnSource[i].DrRefColName != null && this.ScreenObject.ColumnSource[i].DrRefColName != "" && this.ScreenObject.ColumnSource[i].DrRefColName == "Date") {
                    if (this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.ColumnSource[i].DisplayMember))
                        this.ScreenObject.GridDataColumns.Remove(this.ScreenObject.ColumnSource[i].DisplayMember);
                    if (this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.ColumnSource[i].DisplayMember + "_Key"))
                        this.ScreenObject.GridDataColumns.Remove(this.ScreenObject.ColumnSource[i].DisplayMember + "_Key");

                    this.ScreenObject.ColumnSource.RemoveAt(i);
                }

            }

            let iRemColIndex = -1;
            let shiftAssCols: DgColumn[] = [];
            for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
                if (this.ScreenObject.ColumnSource[i].DisplayMember == "LineNarration") {
                    iRemColIndex = i;
                    this.ScreenObject.ColumnSource[i].Width = 150;
                }

                if ((this.ScreenObject.ColumnSource[i].DrRefColName == null || this.ScreenObject.ColumnSource[i].DrRefColName == "") && this.ScreenObject.ColumnSource[i].DrRefColName != "Date")
                    shiftAssCols.push(this.ScreenObject.ColumnSource[i]);
            }

            if (iRemColIndex < 0)
                iRemColIndex = shiftAssCols.length;

            this.iDgColFrom = iRemColIndex;
            this.iDtColFrom = this.ScreenObject.GridDataColumns.length;
            let dtp: Date = FromDate.Date;
            let dgCol = null;
            let dtShifts = BaseService.common.GetDataTable("PAY001", "");

            while (dtp <= ToDate.Date) {
                dgCol = new DgColumn();
                dgCol.Header = dtp.ToString("dd'-'MMM'-'yyyy") + "\n (" + dtp.getDay().toString() + ")";
                dgCol.DisplayMember = dtp.ToString("dd'-'MMM'-'yyyy");
                dgCol.ID = dtShifts[0]["CostCenterColID"].toString();
                dgCol.DrRefColName = "Date";
                dgCol.DataType = "LISTBOX";
                dgCol.CostCenterID = 50073;
                dgCol.Mandatory = true;
                dgCol.TypeID = 1;
                dgCol.Width = 90;

                if (!this.ScreenObject.GridDataColumns.Contains(dgCol.DisplayMember))
                    this.ScreenObject.GridDataColumns.push(dgCol.DisplayMember);

                if (!this.ScreenObject.GridDataColumns.Contains(dgCol.DisplayMember + "_Key"))
                    this.ScreenObject.GridDataColumns.push(dgCol.DisplayMember + "_Key");

                shiftAssCols.Insert(iRemColIndex, dgCol);
                dtp = dtp.AddDays(1);
                iRemColIndex++;
            }
            this.iDgColUpto = iRemColIndex;
            this.iDtColUpto = this.ScreenObject.GridDataColumns.length - 1;

            this.ScreenObject.ColumnSource = shiftAssCols;
            this.ScreenObject.GridDataObj.RefreshColumns();

            //#endregion
        }
    }

    FillGeneralTimings_Click() {
        let sDailyAttDate = "", sEmpID = "1";
        var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
        if (vFld) {
            if (vFld instanceof PactListBoxData)
                sEmpID = vFld.SelectedValue.toString();
            else if (vFld instanceof PactCodeNameListBoxData)
                sEmpID = vFld.SelectedValue.toString();
        }
        if (parseInt(sEmpID) <= 1) {
            this.DisplayMessage = "Select any Employee";
            return;
        }

        var fldDat2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
        if (fldDat2) {
            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha1"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha1_Key"])) {
                    sDailyAttDate = Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha1_Key"]).ToString("dd/MMM/yyyy");


                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha2") && this.ScreenObject.GridDataColumns.Contains("dcAlpha3"))
                        this.FillGeneralTimings(sEmpID, sDailyAttDate, this.ScreenObject.GridData[i]);

                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha4"))
                        this.DistributeTotalHours(sEmpID, sDailyAttDate, this.ScreenObject.GridData[i], "");
                }
            }

        }

    }

    GetPreviousDay(Dailyattendancedate: Date) {
        try {
            let dtDailyAttendance = new Date();
            this.strValidationMessage = '';
            let TotalHours = "";
            let Prefixlength1 = 0;
            let ref_Ddate = { value: this._Ddate }
            this.ScreenObject.OnDocPrefixChanged(this.ScreenObject.Prefix, 0, 0, ref_Ddate, false);
            this._Ddate = ref_Ddate.value
            this.ScreenObject.Clear(ref_Ddate, 1);
            this._Ddate = ref_Ddate.value

            if (this.ScreenObject.DocPrefix.ComboBox.SelectedItem != null && !Util.IsEmpty(this.ScreenObject.DocPrefix.ComboBox.SelectedItem.Aliasname))
                Prefixlength1 = parseInt(this.ScreenObject.DocPrefix.ComboBox.SelectedItem.Aliasname);

            if (parseInt(this.ScreenObject.DocPrefix.TextBox.Text) > 1) {
                let number = (parseInt(this.ScreenObject.DocPrefix.TextBox.Text) - 1).toString();
                while (number.length < Prefixlength1) {
                    number = "0" + number;
                }
                this.ScreenObject.DocPrefix.TextBox.Text = number;

                if (this.intRecCount > 0)
                    dtDailyAttendance = Dailyattendancedate.AddDays(-(this.intRecCount + 1));
                else
                    dtDailyAttendance = Dailyattendancedate.AddDays(-1);

                this.intRecCount = this.intRecCount + 1;

                this.dsData = this.ScreenObject.GetEmployeePayrollInfo(0, 4, dtDailyAttendance, 0);
                if (this.dsData != null && this.dsData.Tables[0].length > 0) {
                    let ref_Ddate = { value: this._Ddate }
                    this.ScreenObject.OnDocPrefixChanged("lostFocus", 0, parseInt(this.dsData.Tables[0][0][0]), ref_Ddate, true);
                    this._Ddate = ref_Ddate.value;
                    this._Ddate = Date.Today();
                    this.QuickInfoVisibility = false;
                    this.DQuickInfoVisibility = false;
                    this.ScreenObject.DocID = 0;
                    this.StatusID = 0;
                    this.WorkFlowDocLevel = 0;
                    this.WfID = 0;
                    this.WFDocLevelList.Clear();
                    this.ScreenObject.VoucherNo = "";
                    this.ScreenObject.guid = "";
                    this.DocStatus = "[" + BaseService.GetResource("Doc_Draft") + "]";
                    this.ScreenObject.DocPrefix.TextBox.Text = (parseInt(number) + 1).toString();
                    var txtDatefldEmp = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                    (txtDatefldEmp as PactExtraFieldDateData).Date = Dailyattendancedate;

                    for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                        if (parseInt(this.ScreenObject.GridData[k]["DocDetailsID"]) > 0) {
                            this.IsDocValid = false;
                            //strValidationMessage = IsDocumentLocked(ScreenObject.GridData[k], 40077, "");
                            //if (strValidationMessage.toString() != "")
                            //{
                            //    IsDocValid = false;
                            //    DisplayMessage = strValidationMessage;
                            //    MessageVisibility = true;
                            //    return;
                            //}
                            //else
                            //{
                            //    IsDocValid = true;
                            //    MessageVisibility = false;
                            //}

                            this.ScreenObject.GridData[k]["DocDetailsID"] = 0;
                            this.ScreenObject.GridData[k]["dcAlpha2_Key"] = Util.ParseDate(Dailyattendancedate.ToString("dd/MMM/yyyy") + " " + this.ScreenObject.GridData[k]["dcAlpha2"]).ToString("dd/MMM/yyyy HH:mm");
                            if (Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha3_Key"]).ToString("dd/MMM/yyyy") == Dailyattendancedate.ToString("dd/MMM/yyyy"))
                                this.ScreenObject.GridData[k]["dcAlpha3_Key"] = Util.ParseDate(Dailyattendancedate.AddDays(1).ToString("dd/MMM/yyyy") + " " + this.ScreenObject.GridData[k]["dcAlpha3"]).ToString("dd/MMM/yyyy HH:mm");
                            else
                                this.ScreenObject.GridData[k]["dcAlpha3_Key"] = Util.ParseDate(Dailyattendancedate.ToString("dd/MMM/yyyy") + " " + this.ScreenObject.GridData[k]["dcAlpha3"]).ToString("dd/MMM/yyyy HH:mm");

                            var col1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcCCNID51");
                            if (col1 && !Util.IsEmpty(col1.Shortcut) && col1.Shortcut.toLowerCase() == "lostfocus" && this.ValidateData_Column(col1, this.ScreenObject.GridData[k], true))
                                this.ScreenObject.GetExternalFuncData(col1.Mode, col1.SPName, col1.IPParams, col1.OPParams, this.ScreenObject.GridData[k]);


                            if (this.ScreenObject.GridData[k]["dcAlpha3_Key"] != null && this.ScreenObject.GridData[k]["dcAlpha2_Key"] != null) {
                                let Hrs = Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha3_Key"]).Subtract(Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha2_Key"]));
                                TotalHours = Hrs.Hours + "." + Hrs.Minutes;
                                this.ScreenObject.GridData[k]["dcNum1"] = parseFloat(TotalHours);
                            }

                            col1 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcNum1");
                            if (col1 && !Util.IsEmpty(col1.Shortcut) && col1.Shortcut.toLowerCase() == "lostfocus" && this.ValidateData_Column(col1, this.ScreenObject.GridData[k], true))
                                this.ScreenObject.GetExternalFuncData(col1.Mode, col1.SPName, col1.IPParams, col1.OPParams, this.ScreenObject.GridData[k]);

                        }
                    }
                }
                else {
                    var txtDatefldEmp = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                    (txtDatefldEmp as PactExtraFieldDateData).Date = Dailyattendancedate;
                    this.DisplayMessage = "No Records exist with date '" + dtDailyAttendance.ToString(BaseService.SessionManager.Preferences["Date Format"]) + "'";
                    this.MessageVisibility = true;
                    return;
                }
            }
        }
        catch (error) {
            this.DisplayMessage = "Load Error";
            Logger.ErrorLog("AddEditDocumentViewModel:: GetPreviousDay" + error.stack);

        }
    }

    private CheckEmployeeShift(sEmpID: string, sDailyAttDate: string, drw: any) {
        if (!this.ScreenObject.GridDataColumns.Contains("dcCCNID73"))
            return;

        let sDimCond = "", sColNames = "";
        let sSABasedOn = "";
        if (BaseService.SessionManager.Preferences.ContainsKey("ShiftAssignBasedOn"))
            sSABasedOn = BaseService.SessionManager.Preferences["ShiftAssignBasedOn"];
        //#region Code Commented for filter
        // if (sSABasedOn == "-2") //Employee Master
        // {
        //     sDimCond = " dcCCNID51 IN(" + sEmpID + ",1) ";
        //     sColNames = "dcCCNID51";
        // }
        // else {
        //     let ObjArray = [];
        //     ObjArray.push(sDailyAttDate);
        //     ObjArray.push(" AND EmpSeqNo=" + sEmpID);
        //     ObjArray.push(0);
        //     ObjArray.push(BaseService.SessionManager.RoleID);
        //     ObjArray.push(BaseService.SessionManager.UserID);
        //     ObjArray.push(BaseService.SessionManager.LanguageID);

        //     let dtEmpCC = BaseService.common.GetDataSet_SP(ObjArray, "spPAY_GetEmpMasterCCDetails").Tables[0];

        //     if (dtEmpCC != null && dtEmpCC.length > 0) {
        //         let sCol = "";
        //         let sBA = sSABasedOn.split(',');
        //         if (sBA != null && sBA.length > 0) {
        //             for (let s = 0; s < sBA.length; s++) {
        //                 if (sBA[s] != null && sBA[s] != "") {
        //                     if (sBA[s] == "-2")
        //                         sCol = "CCNID51";
        //                     else
        //                         sCol = "CCNID" + (parseInt(sBA[s]) - 50000);

        //                     if (sColNames.length > 0)
        //                         sColNames += ",";
        //                     sColNames += "dc" + sCol;

        //                     if (sDimCond.length > 0)
        //                         sDimCond += " AND ";

        //                     sDimCond += "dc" + sCol + "=" + dtEmpCC[0][sCol];

        //                 }
        //             }
        //         }
        //     }
        // }
        //#endregion
        /////////////////////////

        let dtCES = null;

        if (this.IsGetAllEmployees) {
            // if (this.dsAllEmployeeData != null && this.dsAllEmployeeData.Tables.length > 2) {

            //     let dvTemp = this.dsAllEmployeeData.Tables[2];
            //     dvTemp.RowFilter = "FromDate <='" + Util.ParseDate(sDailyAttDate).ToString("dd/MMM/yyyy") + "' AND ToDate >='" + Util.ParseDate(sDailyAttDate).ToString("dd/MMM/yyyy") + "' AND " + sDimCond;
            //     dvTemp.Sort = "FromDate," + sColNames + " DESC";

            //     if (dvTemp != null && dvTemp.length > 0) {
            //         dtCES = dvTemp;
            //     }
            // }
            if (this.dsAllEmployeeData != null && this.dsAllEmployeeData.Tables.length > 2) {
                if (sSABasedOn == "-2") //Employee Master
                {
                    sDimCond = " dcCCNID51 IN(" + sEmpID + ",1) ";
                    sColNames = "dcCCNID51";


                    let dvTemp = this.dsAllEmployeeData.Tables[2];
                    dvTemp = dvTemp.filter(x => x.FromDate <= Util.ParseDate(sDailyAttDate).ToString("dd/MMM/yyyy") && x.ToDate >= Util.ParseDate(sDailyAttDate).ToString("dd/MMM/yyyy") && x.dcCCNID51 == sEmpID);
                    //dvTemp.Sort = "FromDate," + sColNames + " DESC";
                    dvTemp = dvTemp.sort((a, b) => a.FromDate > b.FromDate ? 1 : (a.FromDate == b.FromDate ? (a[sColNames] > b[sColNames] ? 1 : -1) : -1));
                    dvTemp = dvTemp.sort((a, b) => b.DocID - a.DocID);

                    if (dvTemp != null && dvTemp.length > 0) {
                        dtCES = dvTemp;
                    }
                }
                else {
                    let ObjArray = [];
                    ObjArray.push(sDailyAttDate);
                    ObjArray.push(" AND EmpSeqNo=" + sEmpID);
                    ObjArray.push(0);
                    ObjArray.push(BaseService.SessionManager.RoleID);
                    ObjArray.push(BaseService.SessionManager.UserID);
                    ObjArray.push(BaseService.SessionManager.LanguageID);

                    let dtEmpCC = BaseService.common.GetDataSet_SP(ObjArray, "spPAY_GetEmpMasterCCDetails").Tables[0];

                    if (dtEmpCC != null && dtEmpCC.length > 0) {
                        let sCol = "";
                        let sBA = sSABasedOn.split(',');
                        if (sBA != null && sBA.length > 0) {
                            let dvTemp = this.dsAllEmployeeData.Tables[2];

                            for (let s = 0; s < sBA.length; s++) {
                                if (sBA[s] != null && sBA[s] != "") {
                                    if (sBA[s] == "-2")
                                        sCol = "CCNID51";
                                    else
                                        sCol = "CCNID" + (parseInt(sBA[s]) - 50000);

                                    if (sColNames.length > 0)
                                        sColNames += ",";
                                    sColNames += "dc" + sCol;

                                    if (sDimCond.length > 0)
                                        sDimCond += " AND ";

                                    sDimCond += "dc" + sCol + "=" + dtEmpCC[0][sCol];
                                    dvTemp = dvTemp.filter(x => x.FromDate <= Util.ParseDate(sDailyAttDate).ToString("dd/MMM/yyyy") && x.ToDate >= Util.ParseDate(sDailyAttDate).ToString("dd/MMM/yyyy") && x["dc" + sCol] == dtEmpCC[0][sCol]);
                                }
                            }
                            //dvTemp.Sort = "FromDate," + sColNames + " DESC";
                            dvTemp = dvTemp.sort((a, b) => a.FromDate - b.FromDate);
                            if (dvTemp != null && dvTemp.length > 0) {
                                dtCES = dvTemp;
                            }
                        }
                    }

                }
            }
        }
        else {
            dtCES = BaseService.common.GetDataSet3("PAY005", sEmpID, sDailyAttDate).Tables[0];
        }
        if (dtCES != null && dtCES.length > 0) {
            drw["dcCCNID73_Key"] = dtCES[0]["dcCCNID73"];
            drw["dcCCNID73"] = dtCES[0]["Name"];
        }
        else {
            drw["dcCCNID73_Key"] = 1;
            drw["dcCCNID73"] = "";
        }

        this.ScreenObject.GridDataObj.updateRow(drw);
        if (this.RefreshGrid)
            this.RefreshGrid = false;
        else
            this.RefreshGrid = true;

        //if (this.ScreenObject.DocumentType != 99 && this.ScreenObject.DocumentType != 97)
        //    this.Celleditend(drw, "dcCCNID73", 0);
        if (this.ScreenObject.DocumentType == 67) {
            if (this.IsImport) {

                let col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "dcCCNID73");

                if (Util.IsEmpty(col))
                    col = this.ScreenObject.ColumnSource.find(a => a.DisplayMember == "Name" && a.ValueBinding == "dcCCNID73"); // and taking if Display member is Name then re assigning it col
                if (!Util.IsEmpty(col)) {
                    this.DailyAttendanceCellEditEnd(drw, "dcCCNID73", col);
                }
            }
            else
                this.Celleditend(drw, "dcCCNID73", 0);
        }
    }

    private FillGeneralTimings(sEmpID: string, sDailyAttDate: string, drw: any) {
        if (BaseService.SessionManager.Preferences.ContainsKey("GeneralTimingsBasedOn") && BaseService.SessionManager.Preferences["GeneralTimingsBasedOn"] != "") {
            let sArrBasedOn = BaseService.SessionManager.Preferences["GeneralTimingsBasedOn"].split(',');
            if (sArrBasedOn != null && sArrBasedOn.length > 0) {
                let sBasedOn = "", sColName = "";
                for (let i = 0; i < sArrBasedOn.length; i++) {
                    if (sArrBasedOn[i] != null && sArrBasedOn[i] != "") {
                        sColName = "dcCCNID" + (parseInt(sArrBasedOn[i]) - 50000);
                        if (!Util.IsEmpty(drw[sColName + "_Key"]))
                            sBasedOn += " AND ( " + sColName + "=" + drw[sColName + "_Key"].toString() + " OR " + sColName + "=1 )";
                        else
                            sBasedOn += " AND " + sColName + "=1";
                    }
                }
                if (sBasedOn.length > 0) {
                    let alParams = [];
                    alParams.push(sDailyAttDate);
                    alParams.push(sEmpID);
                    alParams.push(sBasedOn);
                    alParams.push(BaseService.SessionManager.UserID);
                    alParams.push(BaseService.SessionManager.LanguageID);
                    let dtTimings = BaseService.common.GetDataSet_SP(alParams, "spPAY_ExtGetTimings").Tables[0];
                    if (dtTimings.length > 0) {
                        let dt1 = Util.ParseDate(sDailyAttDate), dt2 = Util.ParseDate(sDailyAttDate).AddDays(1);

                        var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                        if (vFld2) {
                            drw[vFld2.DisplayMember] = Util.ParseDate(dtTimings[0]["STARTTIME"]).ToString("HH:mm");
                            drw[vFld2.DisplayMember + "_Key"] = Util.ParseDate(dt1)
                                .AddHours(Util.ParseDate(dtTimings[0]["STARTTIME"]).getHours())
                                .AddMinutes(Util.ParseDate(dtTimings[0]["STARTTIME"]).getMinutes()).ToString("dd/MMM/yyyy HH:mm");

                            //drw[vFld2.DisplayMember + "_Key"] = Util.ParseDate(dtTimings[0]["STARTTIME"]).ToString("dd/MMM/yyyy HH:mm");
                        }

                        vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                        if (vFld2) {
                            drw[vFld2.DisplayMember] = Util.ParseDate(dtTimings[0]["ENDTIME"]).ToString("HH:mm");
                            if (Util.ParseDate(dtTimings[0]["ENDTIME"]) < Util.ParseDate(dtTimings[0]["STARTTIME"]))
                                drw[vFld2.DisplayMember + "_Key"] = Util.ParseDate(dt2)
                                    .AddHours(Util.ParseDate(dtTimings[0]["ENDTIME"]).getHours())
                                    .AddMinutes(Util.ParseDate(dtTimings[0]["ENDTIME"]).getMinutes()).ToString("dd/MMM/yyyy HH:mm");
                            else
                                drw[vFld2.DisplayMember + "_Key"] = Util.ParseDate(dt1)
                                    .AddHours(Util.ParseDate(dtTimings[0]["ENDTIME"]).getHours())
                                    .AddMinutes(Util.ParseDate(dtTimings[0]["ENDTIME"]).getMinutes()).ToString("dd/MMM/yyyy HH:mm");

                            //drw[vFld2.DisplayMember + "_Key"] = Util.ParseDate(dtTimings[0]["ENDTIME"]).ToString("dd/MMM/yyyy HH:mm");
                        }

                        drw["dcAlpha5"] = dtTimings[0]["VALIDDAY"];
                        this.DistributeTotalHours(sEmpID, sDailyAttDate, drw, "");
                        this.ScreenObject.GridDataObj.updateRow(drw);
                    }

                }
            }
        }
    }


    dtEData: any[] = null;


    private DistributeTotalHours(sEmpID: string, sDailyAttDate: string, drw: any, strBindingPaths: string) {
        try {
            let IsAllowOT = false;

            if (this.dtEData == null)
                this.dtEData = BaseService.common.GetDataTable("PAY002", "");

            let drcE = this.dtEData.filter(x => x.NodeID == sEmpID);
            if (drcE != null && drcE.length > 0) {
                if (!Util.IsEmpty(drcE[0]["IsAllowOT"]))
                    IsAllowOT = (drcE[0]["IsAllowOT"].toString() == "Yes") ? true : false;
            }

            let dTotHrs = 0;
            let iShiftSeqNo = 1;
            let iMinOT1 = 0, iMinOT2 = 0, iMinOT3 = 0, iMinOT4 = 0, iMinOT5 = 0;

            if (!Util.IsEmpty(drw["dcAlpha3_Key"]) && !Util.IsEmpty(drw["dcAlpha2_Key"])) {
                let Hrs: TimeSpan = Util.ParseDate(drw["dcAlpha3_Key"]).Subtract(Util.ParseDate(drw["dcAlpha2_Key"]));
                if (Hrs.Hours > 0 || Hrs.Minutes > 0) {
                    if (Hrs.Minutes.toString().length == 1)
                        drw["dcNum1"] = Hrs.Hours + ".0" + Hrs.Minutes;
                    else
                        drw["dcNum1"] = Hrs.Hours + "." + Hrs.Minutes;
                }
                else {
                    drw["dcNum1"] = "0.00";
                }
            }
            else {
                drw["dcNum1"] = "0.00";
            }

            var vFld3 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "FLOAT" && a.DisplayMember.toLowerCase() == "dcnum1");
            if (vFld3 != null && !Util.IsEmpty(drw[vFld3.DisplayMember]))
                dTotHrs = parseFloat(drw[vFld3.DisplayMember]);

            if (BaseService.SessionManager.Preferences.ContainsKey("DonotallowAttendancebasedon") && BaseService.SessionManager.Preferences["DonotallowAttendancebasedon"] != "" &&
                BaseService.SessionManager.Preferences.ContainsKey("DonotallowAttendancebasedonid") && BaseService.SessionManager.Preferences["DonotallowAttendancebasedonid"] != ""
            ) {
                var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid" + (parseInt(BaseService.SessionManager.Preferences["DonotallowAttendancebasedon"]) - 50000) + "_key");
                if (vFld2 != undefined && vFld2 != null && !Util.IsEmpty(drw[vFld2.ValueMember]) && drw[vFld2.ValueMember].toString() == BaseService.SessionManager.Preferences["DonotallowAttendancebasedonid"]) {
                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha2")) {
                        drw["dcAlpha2"] = Util.ParseDate(sDailyAttDate).ToString("HH:mm");
                        drw["dcAlpha2_Key"] = Util.ParseDate(sDailyAttDate).ToString("dd/MMM/yyyy HH:mm");
                    }

                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha3")) {
                        drw["dcAlpha3"] = Util.ParseDate(sDailyAttDate).ToString("HH:mm");
                        drw["dcAlpha3_Key"] = Util.ParseDate(sDailyAttDate).ToString("dd/MMM/yyyy HH:mm");
                    }

                    dTotHrs = 0;
                    if (this.ScreenObject.GridDataColumns.Contains("dcNum1"))
                        drw["dcNum1"] = "0.00";
                }
            }
            if (this.objPayDayCheck == null)
                this.objPayDayCheck = new PayDayCheck(this.ScreenObject);
            this.objPayDayCheck.CheckIsHolidayDate(sEmpID, sDailyAttDate, drw, this.IsGetAllEmployees, this.dsAllEmployeeData);
            let dtHrsDef = this.GetHoursDefChart(sDailyAttDate, drw);
            if (dtHrsDef != null && dtHrsDef.length > 0) {
                let drc1 = null, drc2 = null;
                let dtdbl = Util.GetEmptyDate();
                let dtdbl1 = Util.GetEmptyDate();
                let dtdbl2 = Util.GetEmptyDate();
                let dtdbl3 = Util.GetEmptyDate();
                let dtTHrs = Util.GetEmptyDate();
                let dtRemBHrs = Util.GetEmptyDate();

                let sHrs = dTotHrs.ToTime("00.00").split('.');
                let dtRemHrs = Util.GetEmptyDate().AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));

                let dtHalfday = new Date();
                let sHalfdayHrs: any;
                if (!Util.IsEmpty(dtHrsDef[0]["MinBreakHrs"]))
                    sHalfdayHrs = parseFloat(dtHrsDef[0]["MinBreakHrs"]).ToTime("00.00").split('.');
                else
                    sHalfdayHrs = (0).ToTime("00.00").split('.');
                dtHalfday = dtHalfday.AddHours(parseFloat(sHalfdayHrs[0])).AddMinutes(parseFloat(sHalfdayHrs[1]));

                iMinOT1 = iMinOT2 = iMinOT3 = iMinOT4 = iMinOT5 = 0;
                let drcSh: any[];
                var VfldS = this.ScreenObject.ColumnSource.find(c => c.DisplayMember.toLowerCase() == "dcccnid73");
                if (VfldS != undefined && VfldS != null && !Util.IsEmpty(drw["dcCCNID73_Key"])) {
                    iShiftSeqNo = parseInt(drw["dcCCNID73_Key"]);
                    if (this.dtPayShifts != null && this.dtPayShifts.length > 0) {
                        drcSh = this.dtPayShifts.filter(x => x.NodeID == iShiftSeqNo);
                        if (drcSh != null && drcSh.length > 0) {
                            iMinOT1 = parseInt(drcSh[0]["MinOT1"]);
                            iMinOT2 = parseInt(drcSh[0]["MinOT2"]);
                            iMinOT3 = parseInt(drcSh[0]["MinOT3"]);
                            iMinOT4 = parseInt(drcSh[0]["MinOT4"]);
                            iMinOT5 = parseInt(drcSh[0]["MinOT5"]);
                        }
                    }
                }

                if (drw["PayrollType"].toString() == "WeeklyOff" || drw["PayrollType"].toString() == "Holiday") {
                    if (drw["PayrollType"].toString() == "WeeklyOff") {
                        //#region Hours Distribution On Weekly Off

                        //Normal Working Hours
                        var VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum2");
                        if (VfldC && (this.ScreenObject.GridDataColumns.Contains("dcNum2"))) {
                            if (!Util.IsEmpty(drw["dcNum2"]) && parseFloat(drw["dcNum2"]) != -1)
                                drw["dcNum2"] = (0).ToTime("00.00");
                        }

                        ////Break Hours
                        //VfldC = ScreenObject.ColumnSource.FirstOrDefault(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum4");
                        //if (VfldC != null && VfldC.IsVisible)
                        //    drw["dcNum4"] = (0).ToString("0.00");

                        //Break Hours
                        VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum4");
                        if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum4"))) {
                            if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                let sBHrs = parseFloat(drw["dcNum4"]).ToTime("00.00").split('.');
                                dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                    dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                else {
                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));
                                    dtRemBHrs = dtdbl1.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                }
                            }
                            else {
                                if (strBindingPaths.toLowerCase() == "dcnum4" && BaseService.SessionManager.Preferences.ContainsKey("BreakHoursImpactToOTS") && BaseService.SessionManager.Preferences["BreakHoursImpactToOTS"] == "True") {
                                    if (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0) {
                                        let sBHrs = parseFloat(drw["dcNum4"]).ToTime("00.00").split('.');
                                        dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                        drw["dcNum4"] = dtdbl.ToString("HH.mm");
                                        dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                    }
                                }
                                else if (this.ScreenObject.Preferences.ContainsKey("MinimumHourstoconsiderBreakHours") && this.ScreenObject.Preferences["MinimumHourstoconsiderBreakHours"] != "" && parseBoolean(this.ScreenObject.Preferences["MinimumHourstoconsiderBreakHours"])) {
                                    drw["dcNum4"] = (0).ToTime("0.00");
                                    if ((dtRemHrs.getHours() > 0 || dtRemHrs.getMonth() > 0) && dtRemHrs > dtHalfday) {
                                        dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum4");
                                        let dtdbl14 = new Date();
                                        dtdbl14 = dtRemHrs.AddHours(-dtHalfday.getHours()).AddMinutes(-dtHalfday.getMonth());
                                        if (dtdbl14 < dtdbl)
                                            dtdbl = dtdbl14;
                                        drw["dcNum4"] = dtdbl.ToString("HH.mm");
                                        dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMonth());
                                    }
                                }
                                else {
                                    drw["dcNum4"] = (0).ToTime("00.00");
                                    if (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0) {
                                        dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum4");
                                        if (dtRemHrs < dtdbl)
                                            dtdbl = dtRemHrs;
                                        drw["dcNum4"] = dtdbl.ToString("HH.mm");
                                        dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                    }
                                }
                            }
                        }

                        if (IsAllowOT) {
                            //#region Over Times

                            //OT1
                            VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum5");
                            if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum5"))) {
                                if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") &&
                                    BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                    let sBHrs = parseFloat(drw["dcNum5"]).ToTime("00.00").split('.');
                                    dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                        dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                    else {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayWeeklyOffOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                    let stHr1 = parseFloat(drw["dcNum5"]).ToTime("00.00").split('.');
                                                    dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                    dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum5");
                                                    dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                    if (dtRemBHrs < dtdbl2)
                                                        dtdbl2 = dtRemBHrs;
                                                    drw["dcNum5"] = dtdbl2.ToString("HH.mm");
                                                    dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    drw["dcNum5"] = (0).ToTime("00.00");
                                    if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT1) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayWeeklyOffOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum5");
                                                    if (dtRemHrs < dtdbl)
                                                        dtdbl = dtRemHrs;
                                                    drw["dcNum5"] = dtdbl.ToString("HH.mm");
                                                    dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            //OT2
                            VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum7");
                            if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum7"))) {
                                if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                    let sBHrs = parseFloat(drw["dcNum7"]).ToTime("00.00").split('.');
                                    dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                        dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                    else {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayWeeklyOffOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                    let stHr1 = parseFloat(drw["dcNum7"]).ToTime("00.00").split('.');
                                                    dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                    dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum7");
                                                    dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                    if (dtRemBHrs < dtdbl2)
                                                        dtdbl2 = dtRemBHrs;
                                                    drw["dcNum7"] = dtdbl2.ToString("HH.mm");
                                                    dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    drw["dcNum7"] = (0).ToTime("00.00");
                                    if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT2) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayWeeklyOffOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum7");
                                                    if (dtRemHrs < dtdbl)
                                                        dtdbl = dtRemHrs;
                                                    drw["dcNum7"] = dtdbl.ToString("HH.mm");
                                                    dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            //OT3
                            VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum9");
                            if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum9"))) {
                                if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                    let sBHrs = parseFloat(drw["dcNum9"]).ToTime("00.00").split('.');
                                    dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                        dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                    else {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayWeeklyOffOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                    let stHr1 = parseFloat(drw["dcNum9"]).ToTime("00.00").split('.');
                                                    dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                    dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum9");
                                                    dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                    if (dtRemBHrs < dtdbl2)
                                                        dtdbl2 = dtRemBHrs;
                                                    drw["dcNum9"] = dtdbl2.ToString("HH.mm");
                                                    dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    drw["dcNum9"] = (0).ToTime("00.00");
                                    if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT3) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayWeeklyOffOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum9");
                                                    if (dtRemHrs < dtdbl)
                                                        dtdbl = dtRemHrs;
                                                    drw["dcNum9"] = dtdbl.ToString("HH.mm");
                                                    dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            //OT4
                            VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum11");
                            if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum11"))) {
                                if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                    let sBHrs = parseFloat(drw["dcNum11"]).ToTime("00.00").split('.');
                                    dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                        dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                    else {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayWeeklyOffOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                    let stHr1 = parseFloat(drw["dcNum11"]).ToTime("00.00").split('.');
                                                    dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                    dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum11");
                                                    dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                    if (dtRemBHrs < dtdbl2)
                                                        dtdbl2 = dtRemBHrs;
                                                    drw["dcNum11"] = dtdbl2.ToString("HH.mm");
                                                    dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    drw["dcNum11"] = (0).ToTime("00.00");
                                    if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT4) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayWeeklyOffOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum11");
                                                    if (dtRemHrs < dtdbl)
                                                        dtdbl = dtRemHrs;
                                                    drw["dcNum11"] = dtdbl.ToString("HH.mm");
                                                    dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            //OT5
                            VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum13");
                            if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum13"))) {
                                if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                    let sBHrs = parseFloat(drw["dcNum13"]).ToTime("00.00").split('.');
                                    dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                        dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                    else {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayWeeklyOffOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                    let stHr1 = parseFloat(drw["dcNum13"]).ToTime("00.00").split('.');
                                                    dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                    dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum13");
                                                    dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                    if (dtRemBHrs < dtdbl2)
                                                        dtdbl2 = dtRemBHrs;
                                                    drw["dcNum13"] = dtdbl2.ToString("HH.mm");
                                                    dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    drw["dcNum13"] = (0).ToTime("00.00");
                                    if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT5) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"]);
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayWeeklyOffOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum13");
                                                    if (dtRemHrs < dtdbl)
                                                        dtdbl = dtRemHrs;
                                                    drw["dcNum13"] = dtdbl.ToString("HH.mm");
                                                    dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            //#endregion
                        }
                        else {
                            drw["dcNum5"] = (0).ToTime("00.00");
                            drw["dcNum7"] = (0).ToTime("00.00");
                            drw["dcNum9"] = (0).ToTime("00.00");
                            drw["dcNum11"] = (0).ToTime("00.00");
                            drw["dcNum13"] = (0).ToTime("00.00");
                        }
                        if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                            if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                drw["dcNum1"] = dtTHrs.ToString("HH.mm");
                        }
                        //#endregion
                    }
                    else //Holiday
                    {
                        //#region Hours Distribution On Holiday

                        //Normal Working Hours
                        var VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum2");
                        if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum2"))) {
                            if (!Util.IsEmpty(drw["dcNum2"]) && parseFloat(drw["dcNum2"]) != -2)
                                drw["dcNum2"] = (0).ToTime("00.00");
                        }

                        ////Break Hours
                        //VfldC = ScreenObject.ColumnSource.FirstOrDefault(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum4");
                        //if (VfldC != null && VfldC.IsVisible)
                        //    drw["dcNum4"] = (0).ToString("0.00");

                        //Break Hours
                        VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum4");
                        if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum4"))) {
                            if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                let sBHrs = parseFloat(drw["dcNum4"]).ToTime("00.00").split('.');
                                dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                    dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                else {
                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));
                                    dtRemBHrs = dtdbl1.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                }
                            }
                            else {
                                if (strBindingPaths.toLowerCase() == "dcnum4" && BaseService.SessionManager.Preferences.ContainsKey("BreakHoursImpactToOTS") && BaseService.SessionManager.Preferences["BreakHoursImpactToOTS"] == "True") {
                                    if (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0) {
                                        let sBHrs = parseFloat(drw["dcNum4"]).ToTime("00.00").split('.');
                                        dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                        drw["dcNum4"] = dtdbl.ToString("HH.mm");
                                        dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                    }
                                }
                                else if (this.ScreenObject.Preferences.ContainsKey("MinimumHourstoconsiderBreakHours") && this.ScreenObject.Preferences["MinimumHourstoconsiderBreakHours"] != "" && parseBoolean(this.ScreenObject.Preferences["MinimumHourstoconsiderBreakHours"])) {
                                    drw["dcNum4"] = (0).ToTime("0.00");
                                    if ((dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0) && dtRemHrs > dtHalfday) {
                                        dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum4");
                                        let dtdbl14 = new Date();
                                        dtdbl14 = dtRemHrs.AddHours(-dtHalfday.getHours()).AddMinutes(-dtHalfday.getMinutes());
                                        if (dtdbl14 < dtdbl)
                                            dtdbl = dtdbl14;
                                        drw["dcNum4"] = dtdbl.ToString("HH.mm");
                                        dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                    }
                                }
                                else {
                                    drw["dcNum4"] = (0).ToTime("00.00");
                                    if (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0) {
                                        dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum4");
                                        if (dtRemHrs < dtdbl)
                                            dtdbl = dtRemHrs;
                                        drw["dcNum4"] = dtdbl.ToString("HH.mm");
                                        dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                    }
                                }
                            }
                        }

                        if (IsAllowOT) {
                            //#region Over Times

                            //OT1
                            VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum5");
                            if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum5"))) {
                                if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                    let sBHrs = parseFloat(drw["dcNum5"]).ToTime("00.00").split('.');
                                    dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                        dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                    else {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayHolidayMastOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                    let stHr1 = parseFloat(drw["dcNum5"]).ToTime("00.00").split('.');
                                                    dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                    dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum5");
                                                    dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                    if (dtRemBHrs < dtdbl2)
                                                        dtdbl2 = dtRemBHrs;
                                                    drw["dcNum5"] = dtdbl2.ToString("HH.mm");
                                                    dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    drw["dcNum5"] = (0).ToTime("00.00");
                                    if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT1) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayHolidayMastOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum5");
                                                    if (dtRemHrs < dtdbl)
                                                        dtdbl = dtRemHrs;
                                                    drw["dcNum5"] = dtdbl.ToString("HH.mm");
                                                    dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            //OT2
                            VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum7");
                            if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum7"))) {
                                if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                    let sBHrs = parseFloat(drw["dcNum7"]).ToTime("00.00").split('.');
                                    dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                        dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                    else {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayHolidayMastOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                    let stHr1 = parseFloat(drw["dcNum7"]).ToTime("00.00").split('.');
                                                    dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                    dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum7");
                                                    dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                    if (dtRemBHrs < dtdbl2)
                                                        dtdbl2 = dtRemBHrs;
                                                    drw["dcNum7"] = dtdbl2.ToString("HH.mm");
                                                    dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    drw["dcNum7"] = (0).ToTime("00.00");
                                    if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT2) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayHolidayMastOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum7");
                                                    if (dtRemHrs < dtdbl)
                                                        dtdbl = dtRemHrs;
                                                    drw["dcNum7"] = dtdbl.ToString("HH.mm");
                                                    dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            //OT3
                            VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum9");
                            if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum9"))) {
                                if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                    let sBHrs = parseFloat(drw["dcNum9"]).ToTime("00.00").split('.');
                                    dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                        dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                    else {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayHolidayMastOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                    let stHr1 = parseFloat(drw["dcNum9"]).ToTime("00.00").split('.');
                                                    dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                    dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum9");
                                                    dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                    if (dtRemBHrs < dtdbl2)
                                                        dtdbl2 = dtRemBHrs;
                                                    drw["dcNum9"] = dtdbl2.ToString("HH.mm");
                                                    dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    drw["dcNum9"] = (0).ToTime("00.00");
                                    if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT3) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayHolidayMastOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum9");
                                                    if (dtRemHrs < dtdbl)
                                                        dtdbl = dtRemHrs;
                                                    drw["dcNum9"] = dtdbl.ToString("HH.mm");
                                                    dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            //OT4
                            VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum11");
                            if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum11"))) {
                                if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                    let sBHrs = parseFloat(drw["dcNum11"]).ToTime("00.00").split('.');
                                    dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                        dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                    else {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayHolidayMastOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                    let stHr1 = parseFloat(drw["dcNum11"]).ToTime("00.00").split('.');
                                                    dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                    dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum11");
                                                    dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                    if (dtRemBHrs < dtdbl2)
                                                        dtdbl2 = dtRemBHrs;
                                                    drw["dcNum11"] = dtdbl2.ToString("HH.mm");
                                                    dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    drw["dcNum11"] = (0).ToTime("00.00");
                                    if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT4) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayHolidayMastOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum11");
                                                    if (dtRemHrs < dtdbl)
                                                        dtdbl = dtRemHrs;
                                                    drw["dcNum11"] = dtdbl.ToString("HH.mm");
                                                    dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            //OT5
                            VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum13");
                            if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum13"))) {
                                if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                    let sBHrs = parseFloat(drw["dcNum13"]).ToTime("00.00").split('.');
                                    dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                    if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                        dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                    else {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayHolidayMastOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                    let stHr1 = parseFloat(drw["dcNum13"]).ToTime("00.00").split('.');
                                                    dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                    dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum13");
                                                    dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                    if (dtRemBHrs < dtdbl2)
                                                        dtdbl2 = dtRemBHrs;
                                                    drw["dcNum13"] = dtdbl2.ToString("HH.mm");
                                                    dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                                else {
                                    drw["dcNum13"] = (0).ToTime("00.00");
                                    if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT5) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                        drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                        if (drc1 != null && drc1.length > 0) {
                                            drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                            if (drc2 != null && drc2.length > 0) {
                                                if (drc2[0]["SysColumnName"].toString() == "PayHolidayMastOT" || drc2[0]["SysColumnName"].toString() == "PayHolidayOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                    dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum13");
                                                    if (dtRemHrs < dtdbl)
                                                        dtdbl = dtRemHrs;
                                                    drw["dcNum13"] = dtdbl.ToString("HH.mm");
                                                    dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                                }
                                            }
                                        }
                                    }
                                }
                            }

                            //#endregion
                        }
                        else {
                            drw["dcNum5"] = (0).ToTime("00.00");
                            drw["dcNum7"] = (0).ToTime("00.00");
                            drw["dcNum9"] = (0).ToTime("00.00");
                            drw["dcNum11"] = (0).ToTime("00.00");
                            drw["dcNum13"] = (0).ToTime("00.00");
                        }

                        if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                            if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                drw["dcNum1"] = dtTHrs.ToString("HH.mm");
                        }
                        //#endregion
                    }
                }
                else {
                    //#region Hours Distribution On Working Days

                    /*
                /////
                let sMinHalfHrs, sMinFullHrs, sBHrs;
                DateTime dtMinHalfHrs = new Date(), dtMinFullHrs = new Date(),dtBrHrs=new Date();
                sMinHalfHrs = parseFloat(dtHrsDef[0]["MinHalfHrs"]).ToTime("00.00").split('.');
                dtMinHalfHrs = dtMinHalfHrs.AddHours(parseFloat(sMinHalfHrs[0])).AddMinutes(parseFloat(sMinHalfHrs[1]));

                sMinFullHrs = parseFloat(dtHrsDef[0]["MinFullHrs"]).ToTime("00.00").split('.');
                dtMinFullHrs = dtMinFullHrs.AddHours(parseFloat(sMinFullHrs[0])).AddMinutes(parseFloat(sMinFullHrs[1]));

                sBHrs = parseFloat(dtHrsDef[0]["BreakHrs"]).ToTime("00.00").split('.');
                dtBrHrs = dtBrHrs.AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));

                if (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)
                {

                }
                ////
                */

                    //Normal Working Hours
                    var VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum2");
                    if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum2"))) {
                        drw["dcNum2"] = (0).ToTime("00.00");
                        if (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0) {

                            if (this.ScreenObject.Preferences.ContainsKey("MinimumHourstoconsiderBreakHours") && this.ScreenObject.Preferences["MinimumHourstoconsiderBreakHours"] != "" && parseBoolean(this.ScreenObject.Preferences["MinimumHourstoconsiderBreakHours"])) {
                                VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum4");
                                if (VfldC != undefined && (this.ScreenObject.GridDataColumns.Contains("dcNum4"))) {
                                    drw["dcNum4"] = (0).ToString("0.00");
                                    if ((dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0) && dtRemHrs > dtHalfday) {
                                        dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum4");
                                        let dtdbl14 = new Date();
                                        dtdbl14 = dtRemHrs.AddHours(-dtHalfday.getHours()).AddMinutes(-dtHalfday.getMinutes());
                                        if (dtdbl14 < dtdbl)
                                            dtdbl = dtdbl14;
                                        drw["dcNum4"] = dtdbl.ToString("HH.mm");
                                        dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                    }
                                }
                            }

                            dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum2");
                            if (dtRemHrs < dtdbl)
                                dtdbl = dtRemHrs;
                            drw["dcNum2"] = dtdbl.ToString("HH.mm");
                            dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                            dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                        }
                    }

                    //Break Hours
                    if (this.ScreenObject.Preferences.ContainsKey("MinimumHourstoconsiderBreakHours") && this.ScreenObject.Preferences["MinimumHourstoconsiderBreakHours"] != "" && !parseBoolean(this.ScreenObject.Preferences["MinimumHourstoconsiderBreakHours"])) {
                        VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum4");
                        if (VfldC != undefined && (this.ScreenObject.GridDataColumns.Contains("dcNum4"))) {
                            if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                let sBHrs: any = parseFloat(drw["dcNum4"]).ToTime("00.00").split('.');
                                dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                    dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                else {
                                    let stHr: any = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                    dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                    let stHr1: any = parseFloat(drw["dcNum2"]).ToTime("00.00").split('.');
                                    dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                    dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum2");
                                    dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());

                                    dtRemBHrs = dtdbl1.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());

                                    if (dtRemBHrs < dtdbl2)
                                        dtdbl2 = dtRemBHrs;
                                    drw["dcNum2"] = dtdbl2.ToString("HH.mm");
                                    dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                }
                            }
                            else {
                                if (strBindingPaths.toLowerCase() == "dcnum4" && BaseService.SessionManager.Preferences.ContainsKey("BreakHoursImpactToOTS") && BaseService.SessionManager.Preferences["BreakHoursImpactToOTS"] == "True") {
                                    if (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0) {
                                        let sBHrs: any = parseFloat(drw["dcNum4"]).ToTime("00.00").split('.');
                                        dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                        drw["dcNum4"] = dtdbl.ToString("HH.mm");
                                        dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                    }
                                }
                                else {
                                    drw["dcNum4"] = (0).ToString("0.00");
                                    if (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0) {
                                        dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum4");
                                        if (dtRemHrs < dtdbl)
                                            dtdbl = dtRemHrs;
                                        drw["dcNum4"] = dtdbl.ToString("HH.mm");
                                        dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                    }
                                }
                            }
                        }
                    }

                    if (IsAllowOT) {
                        //#region Over Times

                        //OT1
                        VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum5");
                        if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum5"))) {
                            if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                let sBHrs = parseFloat(drw["dcNum5"]).ToTime("00.00").split('.');
                                dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                    dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                else {
                                    drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                    if (drc1 != null && drc1.length > 0) {
                                        drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                        if (drc2 != null && drc2.length > 0) {
                                            if (drc2[0]["SysColumnName"].toString() == "PayNormalOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                let stHr1 = parseFloat(drw["dcNum5"]).ToTime("00.00").split('.');
                                                dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum5");
                                                dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                if (dtRemBHrs < dtdbl2)
                                                    dtdbl2 = dtRemBHrs;
                                                drw["dcNum5"] = dtdbl2.ToString("HH.mm");
                                                dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                            }
                                        }
                                    }
                                }
                            }
                            else {
                                drw["dcNum5"] = (0).ToTime("00.00");
                                if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT1) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                    drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                    if (drc1 != null && drc1.length > 0) {
                                        drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                        if (drc2 != null && drc2.length > 0) {
                                            if (drc2[0]["SysColumnName"].toString() == "PayNormalOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum5");
                                                if (dtRemHrs < dtdbl)
                                                    dtdbl = dtRemHrs;
                                                drw["dcNum5"] = dtdbl.ToString("HH.mm");
                                                dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        //OT2
                        VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum7");
                        if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum7"))) {
                            if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                let sBHrs = parseFloat(drw["dcNum7"]).ToTime("00.00").split('.');
                                dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                    dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                else {
                                    drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                    if (drc1 != null && drc1.length > 0) {
                                        drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                        if (drc2 != null && drc2.length > 0) {
                                            if (drc2[0]["SysColumnName"].toString() == "PayNormalOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                let stHr1 = parseFloat(drw["dcNum7"]).ToTime("00.00").split('.');
                                                dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum7");
                                                dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                if (dtRemBHrs < dtdbl2)
                                                    dtdbl2 = dtRemBHrs;
                                                drw["dcNum7"] = dtdbl2.ToString("HH.mm");
                                                dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                            }
                                        }
                                    }
                                }
                            }
                            else {
                                drw["dcNum7"] = (0).ToTime("00.00");
                                if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT2) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                    drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                    if (drc1 != null && drc1.length > 0) {
                                        drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                        if (drc2 != null && drc2.length > 0) {
                                            if (drc2[0]["SysColumnName"].toString() == "PayNormalOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum7");
                                                if (dtRemHrs < dtdbl)
                                                    dtdbl = dtRemHrs;
                                                drw["dcNum7"] = dtdbl.ToString("HH.mm");
                                                dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        //OT3
                        VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum9");
                        if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum9"))) {
                            if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                let sBHrs = parseFloat(drw["dcNum9"]).ToTime("00.00").split('.');
                                dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                    dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                else {
                                    drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                    if (drc1 != null && drc1.length > 0) {
                                        drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                        if (drc2 != null && drc2.length > 0) {
                                            if (drc2[0]["SysColumnName"].toString() == "PayNormalOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                let stHr1 = parseFloat(drw["dcNum9"]).ToTime("00.00").split('.');
                                                dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum9");
                                                dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                if (dtRemBHrs < dtdbl2)
                                                    dtdbl2 = dtRemBHrs;
                                                drw["dcNum9"] = dtdbl2.ToString("HH.mm");
                                                dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                            }
                                        }
                                    }
                                }
                            }
                            else {
                                drw["dcNum9"] = (0).ToTime("00.00");
                                if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT3) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                    drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                    if (drc1 != null && drc1.length > 0) {
                                        drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                        if (drc2 != null && drc2.length > 0) {
                                            if (drc2[0]["SysColumnName"].toString() == "PayNormalOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum9");
                                                if (dtRemHrs < dtdbl)
                                                    dtdbl = dtRemHrs;
                                                drw["dcNum9"] = dtdbl.ToString("HH.mm");
                                                dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        //OT4
                        VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum11");
                        if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum11"))) {
                            if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                let sBHrs = parseFloat(drw["dcNum11"]).ToTime("00.00").split('.');
                                dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                    dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                else {
                                    drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                    if (drc1 != null && drc1.length > 0) {
                                        drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                        if (drc2 != null && drc2.length > 0) {
                                            if (drc2[0]["SysColumnName"].toString() == "PayNormalOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                let stHr1 = parseFloat(drw["dcNum11"]).ToTime("00.00").split('.');
                                                dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum11");
                                                dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                if (dtRemBHrs < dtdbl2)
                                                    dtdbl2 = dtRemBHrs;
                                                drw["dcNum11"] = dtdbl2.ToString("HH.mm");
                                                dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                            }
                                        }
                                    }
                                }
                            }
                            else {
                                drw["dcNum11"] = (0).ToTime("00.00");
                                if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT4) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                    drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                    if (drc1 != null && drc1.length > 0) {
                                        drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                        if (drc2 != null && drc2.length > 0) {
                                            if (drc2[0]["SysColumnName"].toString() == "PayNormalOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum11");
                                                if (dtRemHrs < dtdbl)
                                                    dtdbl = dtRemHrs;
                                                drw["dcNum11"] = dtdbl.ToString("HH.mm");
                                                dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        //OT5
                        VfldC = this.ScreenObject.ColumnSource.find(c => c.DataType.toUpperCase() == "FLOAT" && c.DisplayMember.toLowerCase() == "dcnum13");
                        if (VfldC != undefined && VfldC != null && (this.ScreenObject.GridDataColumns.Contains("dcNum13"))) {
                            if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                                let sBHrs = parseFloat(drw["dcNum13"]).ToTime("00.00").split('.');
                                dtdbl = new Date(1, 1, 1, 0).AddHours(parseFloat(sBHrs[0])).AddMinutes(parseFloat(sBHrs[1]));
                                if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                                    dtTHrs = dtTHrs.AddHours(dtdbl.getHours()).AddMinutes(dtdbl.getMinutes());
                                else {
                                    drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == "'" + VfldC.DisplayMember + "'");
                                    if (drc1 != null && drc1.length > 0) {
                                        drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == Util.String(drc1[0]["LinkData"]));
                                        if (drc2 != null && drc2.length > 0) {
                                            if (drc2[0]["SysColumnName"].toString() == "PayNormalOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                let stHr = parseFloat(drw["dcNum1"]).ToTime("00.00").split('.');
                                                dtdbl1 = new Date().AddHours(parseFloat(stHr[0])).AddMinutes(parseFloat(stHr[1]));

                                                let stHr1 = parseFloat(drw["dcNum13"]).ToTime("00.00").split('.');
                                                dtdbl3 = new Date().AddHours(parseFloat(stHr1[0])).AddMinutes(parseFloat(stHr1[1]));

                                                dtdbl2 = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum13");
                                                dtdbl2 = dtdbl2.AddHours(dtdbl3.getHours()).AddMinutes(dtdbl3.getMinutes());


                                                if (dtRemBHrs < dtdbl2)
                                                    dtdbl2 = dtRemBHrs;
                                                drw["dcNum13"] = dtdbl2.ToString("HH.mm");
                                                dtRemBHrs = dtRemBHrs.AddHours(-dtdbl2.getHours()).AddMinutes(-dtdbl2.getMinutes());
                                            }
                                        }
                                    }
                                }
                            }
                            else {
                                drw["dcNum13"] = (0).ToTime("00.00");
                                if ((((dtRemHrs.getHours() * 60) + dtRemHrs.getMinutes()) >= iMinOT5) && (dtRemHrs.getHours() > 0 || dtRemHrs.getMinutes() > 0)) {
                                    drc1 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == VfldC.DisplayMember);
                                    if (drc1 != null && drc1.length > 0) {
                                        drc2 = this.dtOTTypes.filter(x => x.CostCenterColID == drc1[0]["LinkData"].toString());
                                        if (drc2 != null && drc2.length > 0) {
                                            if (drc2[0]["SysColumnName"].toString() == "PayNormalOT" || drc2[0]["SysColumnName"].toString() == "PayEveryDayOT") {
                                                dtdbl = this.GetMaxAvilableHrs(sEmpID, sDailyAttDate, dtHrsDef, "dcNum13");
                                                if (dtRemHrs < dtdbl)
                                                    dtdbl = dtRemHrs;
                                                drw["dcNum13"] = dtdbl.ToString("HH.mm");
                                                dtRemHrs = dtRemHrs.AddHours(-dtdbl.getHours()).AddMinutes(-dtdbl.getMinutes());
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        //#endregion
                    }
                    else {
                        if (this.ScreenObject.GridDataColumns.Contains("dcNum5"))
                            drw["dcNum5"] = (0).ToTime("00.00");
                        if (this.ScreenObject.GridDataColumns.Contains("dcNum7"))
                            drw["dcNum7"] = (0).ToTime("00.00");
                        if (this.ScreenObject.GridDataColumns.Contains("dcNum9"))
                            drw["dcNum9"] = (0).ToTime("00.00");
                        if (this.ScreenObject.GridDataColumns.Contains("dcNum11"))
                            drw["dcNum11"] = (0).ToTime("00.00");
                        if (this.ScreenObject.GridDataColumns.Contains("dcNum13"))
                            drw["dcNum13"] = (0).ToTime("00.00");
                    }
                    if ((strBindingPaths.toLowerCase() == "dcnum4" || strBindingPaths.toLowerCase() == "dcnum5" || strBindingPaths.toLowerCase() == "dcnum7" || strBindingPaths.toLowerCase() == "dcnum9" || strBindingPaths.toLowerCase() == "dcnum11" || strBindingPaths.toLowerCase() == "dcnum13") && BaseService.SessionManager.Preferences.ContainsKey("AllowManualHoursEntryInDailyAttendence") && BaseService.SessionManager.Preferences["AllowManualHoursEntryInDailyAttendence"] == "True") {
                        if (BaseService.SessionManager.Preferences.ContainsKey("DistributeHoursafterBreakHoursEntry") && BaseService.SessionManager.Preferences["DistributeHoursafterBreakHoursEntry"] == "False")
                            drw["dcNum1"] = dtTHrs.ToString("HH.mm");
                    }
                    //#endregion
                }
            }
            else {
                if (this.ScreenObject.GridDataColumns.Contains("dcNum2"))
                    drw["dcNum2"] = (0).ToTime("00.00");
                if (this.ScreenObject.GridDataColumns.Contains("dcNum4"))
                    drw["dcNum4"] = (0).ToTime("00.00");
                if (this.ScreenObject.GridDataColumns.Contains("dcNum5"))
                    drw["dcNum5"] = (0).ToTime("00.00");
                if (this.ScreenObject.GridDataColumns.Contains("dcNum7"))
                    drw["dcNum7"] = (0).ToTime("00.00");
                if (this.ScreenObject.GridDataColumns.Contains("dcNum9"))
                    drw["dcNum9"] = (0).ToTime("00.00");
                if (this.ScreenObject.GridDataColumns.Contains("dcNum11"))
                    drw["dcNum11"] = (0).ToTime("00.00");
                if (this.ScreenObject.GridDataColumns.Contains("dcNum13"))
                    drw["dcNum13"] = (0).ToTime("00.00");
            }

            //#region Calculating Total Cost

            if (BaseService.SessionManager.Preferences.ContainsKey("UseDailyAttRates")) {
                let dblTotalCost = 0, dblCurrColRate = 0;
                if (!Util.IsEmpty(drw["dcNum2"]) && !Util.IsEmpty(drw["dcNum3"]))
                    dblTotalCost = (this.ConvertHoursToMinutes(drw["dcNum2"].toString()) * (parseFloat(drw["dcNum3"]) / 60));
                for (let i = 5; i < 15; i++) {
                    dblCurrColRate = 0;
                    if (drw["dcNum" + i] != null && parseFloat(drw["dcNum" + i]) > 0) {
                        if (drw["dcNum" + i] != null && drw["dcNum" + i] != null && drw["dcNum" + i].toString() != "" && drw["dcNum" + (i + 1)] != null && drw["dcNum" + (i + 1)] != null && drw["dcNum" + (i + 1)].toString() != "") {
                            dblCurrColRate = (this.ConvertHoursToMinutes(drw["dcNum" + i].toString()) * (parseFloat(drw["dcNum" + (i + 1)]) / 60));
                            dblTotalCost += dblCurrColRate;
                        }
                    }
                    i = i + 1;
                }
                drw["dcNum15"] = dblTotalCost.ToString("0.00");
            }

            //#endregion


        }
        catch (error) {
            Logger.ErrorLog("AddEditDocumentsPayroll:: DistributeTotalHours() : " + error.stack);
        }
    }

    dsHrsDefDict = new Dictionary<any>();
    dsHrsDef: any = {}//new DataSet();
    private GetHoursDefChart(sDailyAttDate: string, drw: any): any[] {
        let dtHrsDef = null;
        if (BaseService.SessionManager.Preferences.ContainsKey("HoursDefChartBasedOn") && BaseService.SessionManager.Preferences["HoursDefChartBasedOn"] != "") {
            let sArrBasedOn = BaseService.SessionManager.Preferences["HoursDefChartBasedOn"].split(',');
            if (sArrBasedOn != null && sArrBasedOn.length > 0) {
                let sBasedOn = " 1=1 ", sColName = "";
                let dvTemp = [];
                if (this.IsGetAllEmployees) // ~*****~
                {
                    if (this.dsAllEmployeeData != null && this.dsAllEmployeeData.Tables.length > 1) {
                        dvTemp = this.dsAllEmployeeData.Tables[1];
                    }
                }
                for (let i = 0; i < sArrBasedOn.length; i++) {
                    if (sArrBasedOn[i] != null && sArrBasedOn[i] != "") {
                        sColName = "dcCCNID" + (parseInt(sArrBasedOn[i]) - 50000);
                        if (!Util.IsEmpty(drw[sColName + "_Key"]))
                            sBasedOn += " AND ( " + sColName + "=" + drw[sColName + "_Key"].toString() + " OR " + sColName + "=1 )";
                        else
                            sBasedOn += " AND " + sColName + "=1";

                        if (this.IsGetAllEmployees) {
                            if (this.dsAllEmployeeData != null && this.dsAllEmployeeData.Tables.length > 1) {
                                if (!Util.IsEmpty(drw[sColName + "_Key"]))
                                    dvTemp = dvTemp.filter(x => x[sColName] == drw[sColName + "_Key"].toString() || x[sColName] == 1);
                                else
                                    dvTemp = dvTemp.filter(x => x[sColName] == 1);
                            }
                        }
                    }
                }
                if (sBasedOn.length > 0) {
                    let stblName = Util.ParseDate(sDailyAttDate).ToString("ddMMMyyyy") + "_" + sBasedOn.Replace(" ", "");

                    let isFound = false;
                    if (this.IsGetAllEmployees) {
                        if (dvTemp != null && dvTemp.length > 1) {
                            // this line code written above ~*****~
                            // = dvTemp.filter(x=>x.WEF<= Util.ParseDate(sDailyAttDate).ToString("dd/MMM/yyyy")) //+ "' AND " + sBasedOn; sBasedOn condition already filted above.
                            //dvTemp = dvTemp.sort() "WEF DESC,DocID DESC," + sColNames + " DESC";

                            dvTemp = dvTemp.sort((a, b) => a.WEF > b.WEF ? 1 : (a.WEF == b.WEF ? (a.DocID > b.DocID ? 1 : -1) : -1));
                            //dvTemp = dvTemp.sort((a, b) => b.DocID - a.DocID);

                            if (dvTemp != null && dvTemp.length > 0) {
                                dtHrsDef = dvTemp;
                            }
                        }
                    }
                    else {

                        if (this.dsHrsDefDict != null && this.dsHrsDefDict.length > 0) {
                            if (this.dsHrsDefDict.ContainsKey(stblName))
                                isFound = true;
                        }

                        if (isFound)
                            dtHrsDef = this.dsHrsDefDict[stblName];
                        else {
                            let ds = BaseService.common.GetDataSet3("PAY004", sDailyAttDate, sBasedOn);
                            dtHrsDef = ds.Tables[0]
                            this.dsHrsDefDict.push(stblName, dtHrsDef);
                            //this.dsHrsDef.Tables[this.dsHrsDef.Tables.length - 1].TableName = stblName;
                        }
                    }
                }
            }
        }
        return dtHrsDef;
    }

    dsSaved: any = {}

    dsTotalHrsDict = new Dictionary<any>();
    private GetTotalEnteredHours(sEmpID: string, sDailyAttDate: string, sOTColName: string, refObj: any): Date {
        refObj.dtdblOld = Date.Today();
        let sHrs: any;
        let SeqNo = ""; refObj.VoucherNo = "";

        if (this.ScreenObject.GridData.length > 0) {
            let sTmpDailyAttDate = Date.Today().ToString("dd/MMM/yyyy"), sTmpEmpID = "1";
            let drw = null;

            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                    drw = this.ScreenObject.GridData[i];

                    var vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                    if (vFld)
                        sTmpDailyAttDate = (vFld as PactExtraFieldDateData).Date.ToString("dd/MMM/yyyy");
                    else {
                        var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                        if (vFld2 && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                            sTmpDailyAttDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");
                    }

                    vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if (vFld) {
                        if (vFld instanceof PactListBoxData)
                            sTmpEmpID = vFld.SelectedValue.toString();
                        else if (vFld instanceof PactCodeNameListBoxData)
                            sTmpEmpID = vFld.SelectedValue.toString();
                    }
                    else {
                        var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                        if (vFld2 && !Util.IsEmpty(drw[vFld2.ValueMember]))
                            sTmpEmpID = drw[vFld2.ValueMember].toString();
                    }

                    if (sEmpID == sTmpEmpID && sDailyAttDate == sTmpDailyAttDate) {
                        if (!Util.IsEmpty(drw[sOTColName])) {
                            if (sOTColName.toLowerCase() == "dcnum2") {
                                if (parseFloat(drw[sOTColName]) != -1 && parseFloat(drw[sOTColName]) != -2) // -1,-2 Hours on Weekly Offs/Holidays for Project costing
                                {
                                    sHrs = parseFloat(drw[sOTColName]).ToTime("00.00").split('.');
                                    refObj.dtdblOld = refObj.dtdblOld.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
                                }
                            }
                            else {
                                sHrs = parseFloat(drw[sOTColName]).ToTime("00.00").split('.');
                                refObj.dtdblOld = refObj.dtdblOld.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
                            }
                            if (SeqNo.length > 0)
                                SeqNo += ",";

                            SeqNo += drw["DocSeqNo"].toString();
                        }
                    }
                }
            }
            refObj.sVoucherNo = " @SeqNo - " + SeqNo;
            let sQ = "";
            let dtSaved = null;
            let stblName = Util.ParseDate(sDailyAttDate).ToString("ddMMMyyyy") + "_" + sEmpID;
            let isFound = false;


            if (this.IsGetAllEmployees) {
                if (this.dsAllEmployeeData != null && this.dsAllEmployeeData.Tables.length > 0) {
                    let dvTemp = this.dsAllEmployeeData.Tables[0];
                    dvTemp = dvTemp.filter(x => x.EmpSeqNo == sEmpID && x.DailyAttendanceDate == Util.ParseDate(sDailyAttDate).ToString("dd MMM yyyy"));

                    if (dvTemp != null && dvTemp.length > 0) {
                        dtSaved = dvTemp.ToTable();
                    }
                }
            }
            else {
                // if (this.dsSaved != null && this.dsSaved.Tables.length > 0)
                // {
                //     if (this.dsSaved.Tables.Contains(stblName))
                //         isFound = true;
                // }
                if (this.dsTotalHrsDict != null && this.dsTotalHrsDict.length > 0) {
                    if (this.dsTotalHrsDict.ContainsKey(stblName))
                        isFound = true;
                }
                if (isFound)
                    dtSaved = this.dsTotalHrsDict[stblName];// this.dsSaved.Tables[stblName];
                else {
                    let ds = BaseService.common.GetDataSet3("PAY003", sDailyAttDate, sEmpID, this.ScreenObject.IsDocEdit ? this.ScreenObject.DocID.toString() : "0");
                    dtSaved = ds.Tables[0]
                    this.dsTotalHrsDict.push(stblName, dtSaved);
                    // this.dsSaved.Tables.push(dtSaved.Copy());
                    // this.dsSaved.Tables[this.dsSaved.Tables.length - 1].TableName = stblName;

                }
            }
            if (dtSaved != null && dtSaved.length > 0) {
                SeqNo = "";
                for (let i = 0; i < dtSaved.length; i++) {
                    if (!Util.IsEmpty(dtSaved[i][sOTColName])) {
                        if (sOTColName.toLowerCase() == "dcnum2") {
                            if (parseFloat(dtSaved[i][sOTColName]) != -1 && parseFloat(dtSaved[sOTColName]) != -2) // -1,-2 Hours on Weekly Offs/Holidays for Project costing
                            {
                                sHrs = parseFloat(dtSaved[i][sOTColName]).ToTime("00.00").split('.');
                                refObj.dtdblOld = refObj.dtdblOld.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
                            }
                        }
                        else {
                            sHrs = parseFloat(dtSaved[i][sOTColName]).ToTime("00.00").split('.');
                            refObj.dtdblOld = refObj.dtdblOld.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
                        }
                        refObj.sVoucherNo += " @VoucherNo - " + dtSaved[i]["VoucherNo"].toString() + " @SeqNo - " + dtSaved[i]["DocSeqNo"].toString();
                    }
                }
            }
        }
        return refObj.dtdblOld;
    }

    private GetMaxAvilableHrs(sEmpID: string, sDailyAttDate: string, dtHrsDef: any[], sOTColName: string): Date {
        let dtdbl = new Date(1, 1, 1, 0), dtdblOld = new Date(1, 1, 1, 0);
        let sHrs;
        let sVoucherNo = "";
        let refObjdt = { dtdblOld: dtdblOld, sVoucherNo: sVoucherNo };
        this.GetTotalEnteredHours(sEmpID, sDailyAttDate, sOTColName, refObjdt);
        dtdblOld = refObjdt.dtdblOld;
        sVoucherNo = refObjdt.sVoucherNo;

        if (sOTColName == "dcNum1") //Total Hours
        {
            sHrs = parseFloat(dtHrsDef[0]["MaxHrsPerDay"]).ToTime("00.00").split('.');
            dtdbl = dtdbl.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
            dtdbl = dtdbl.AddHours(-dtdblOld.getHours()).AddMinutes(-dtdblOld.getMinutes());
        }
        else if (sOTColName == "dcNum2") //Normal Working Hours
        {
            sHrs = parseFloat(dtHrsDef[0]["NormalHrs"]).ToTime("00.00").split('.');
            dtdbl = dtdbl.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
            dtdbl = dtdbl.AddHours(-dtdblOld.getHours()).AddMinutes(-dtdblOld.getMinutes());
        }
        else if (sOTColName == "dcNum4") //Break Hours
        {
            sHrs = parseFloat(dtHrsDef[0]["BreakHrs"]).ToTime("00.00").split('.');
            dtdbl = dtdbl.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
            dtdbl = dtdbl.AddHours(-dtdblOld.getHours()).AddMinutes(-dtdblOld.getMinutes());

        }
        else if (sOTColName == "dcNum5") //OT1
        {
            sHrs = parseFloat(dtHrsDef[0]["OT1"]).ToTime("00.00").split('.');
            dtdbl = dtdbl.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
            dtdbl = dtdbl.AddHours(-dtdblOld.getHours()).AddMinutes(-dtdblOld.getMinutes());
        }
        else if (sOTColName == "dcNum7") //OT2
        {
            sHrs = parseFloat(dtHrsDef[0]["OT2"]).ToTime("00.00").split('.');
            dtdbl = dtdbl.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
            dtdbl = dtdbl.AddHours(-dtdblOld.getHours()).AddMinutes(-dtdblOld.getMinutes());
        }
        else if (sOTColName == "dcNum9") //OT3
        {
            sHrs = parseFloat(dtHrsDef[0]["OT3"]).ToTime("00.00").split('.');
            dtdbl = dtdbl.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
            dtdbl = dtdbl.AddHours(-dtdblOld.getHours()).AddMinutes(-dtdblOld.getMinutes());
        }
        else if (sOTColName == "dcNum11") //OT4
        {
            sHrs = parseFloat(dtHrsDef[0]["OT4"]).ToTime("00.00").split('.');
            dtdbl = dtdbl.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
            dtdbl = dtdbl.AddHours(-dtdblOld.getHours()).AddMinutes(-dtdblOld.getMinutes());
        }
        else if (sOTColName == "dcNum13") //OT5
        {
            sHrs = parseFloat(dtHrsDef[0]["OT5"]).ToTime("00.00").split('.');
            dtdbl = dtdbl.AddHours(parseFloat(sHrs[0])).AddMinutes(parseFloat(sHrs[1]));
            dtdbl = dtdbl.AddHours(-dtdblOld.getHours()).AddMinutes(-dtdblOld.getMinutes());
        }
        return dtdbl;
    }

    private GetDuplicateTimingsOfEmployeeTimeSheet(sCheckInDate: string, sEmpID: string, iRowId: number, iDocType: number): string {
        let sRet = "";
        let dtChkDateTime;
        let sTmpChkInDate = Date.Today().ToString("dd/MMM/yyyy"), sTmpEmpID = "1";
        let drw;

        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (i == iRowId)
                continue;

            if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                sTmpChkInDate = ""; sTmpEmpID = "1";
                drw = this.ScreenObject.GridData[i];
                if (iDocType == 103) {
                    var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                    if (vFld2 != null && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                        sTmpChkInDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");
                }
                else {
                    var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                    if (vFld2 && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                        sTmpChkInDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");
                }

                var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld) {
                    if (vFld instanceof PactListBoxData)
                        sTmpEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sTmpEmpID = vFld.SelectedValue.toString();
                }
                else {
                    let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                    if (vFld2 && !Util.IsEmpty(drw[vFld2.ValueMember]))
                        sTmpEmpID = drw[vFld2.ValueMember].toString();
                }

                if (sEmpID == sTmpEmpID && sCheckInDate == sTmpChkInDate) {
                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha2_Key") && !Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"])) {
                        dtChkDateTime = Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]);
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha2_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha4_Key"])) {
                            if (dtChkDateTime >= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]) && dtChkDateTime < Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha4_Key"])) {
                                sRet = (i + 1).toString();
                                break;
                            }
                        }
                    }
                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha4_Key") && !Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"])) {
                        dtChkDateTime = Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"]);
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha2_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha4_Key"])) {
                            if (dtChkDateTime > Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]) && dtChkDateTime < Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha4_Key"])) {
                                sRet = (i + 1).toString();
                                break;
                            }
                        }
                    }
                    ////
                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha2_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha2_Key"])) {
                        dtChkDateTime = Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]);
                        if (!Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"])) {
                            if (dtChkDateTime >= Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]) && dtChkDateTime < Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"])) {
                                sRet = (i + 1).toString();
                                break;
                            }
                        }
                    }
                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha4_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha4_Key"])) {
                        dtChkDateTime = Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha4_Key"]);
                        if (!Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"])) {
                            if (dtChkDateTime > Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]) && dtChkDateTime < Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"])) {
                                sRet = (i + 1).toString();
                                break;
                            }
                        }
                    }

                }
            }
        }

        if (this.ScreenObject.GridDataColumns.Contains("dcAlpha2_Key") && !Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]) &&
            this.ScreenObject.GridDataColumns.Contains("dcAlpha4_Key") && !Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"])) {
            //Check in Saved Documents
            let sQ = "";
            let qCode = "PAY006"
            if (iDocType == 103) {
                qCode = "PAY006-A";
                sQ = `d.tDocumentType=` + iDocType + ` and a.StatusID=369
                AND ISDATE(d.dcAlpha2)=1 AND ISDATE(d.dcAlpha3)=1 AND ISDATE(d.dcAlpha4)=1  
                AND a.DOCID<>` + this.ScreenObject.DocID + ` AND b.dcCCNID51=` + sEmpID + ` 
                --AND CONVERT(DATETIME,d.dcAlpha1)=CONVERT(DATETIME,'` + sCheckInDate + `')
                AND (
                ( CONVERT(DATETIME,d.dcAlpha2) >= CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') AND CONVERT(DATETIME,d.dcAlpha2) <= CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') ) OR
                ( CONVERT(DATETIME,d.dcAlpha4) > CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') AND CONVERT(DATETIME,d.dcAlpha4) < CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') ) OR
                ( CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') >= CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') <= CONVERT(DATETIME,d.dcAlpha4)) OR
                ( CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') > CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') < CONVERT(DATETIME,d.dcAlpha4))
                ) `;

            }
            else {
                sQ = "d.tDocumentType=" + iDocType + " and a.StatusID=369 AND ISDATE(d.dcAlpha1)=1 AND ISDATE(d.dcAlpha2)=1 AND ISDATE(d.dcAlpha3)=1 AND ISDATE(d.dcAlpha4)=1 AND a.DOCID<>" + this.ScreenObject.DocID
                    + " AND b.dcCCNID51=" + sEmpID + ` 
AND (
( CONVERT(DATETIME,d.dcAlpha2) >= CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') AND CONVERT(DATETIME,d.dcAlpha2) < CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') ) OR
( CONVERT(DATETIME,d.dcAlpha4) > CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') AND CONVERT(DATETIME,d.dcAlpha4) < CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') ) OR
( CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') >= CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') < CONVERT(DATETIME,d.dcAlpha4)) OR
( CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') > CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha4_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') < CONVERT(DATETIME,d.dcAlpha4))
)`;
            }
            let dtChk: any[] = BaseService.common.GetDataSet(qCode, JSON.stringify(sQ));
            if (dtChk != null && dtChk.length > 0)
                sRet = dtChk[0]["VoucherNo"].toString();
        }
        return sRet;
    }

    private GetDuplicateTimingsOfEmployee(sDailyAttDate: string, sEmpID: string, iRowId: number) {
        let sRet = "";
        let dtChkDateTime;
        let sTmpDailyAttDate = Date.Today().ToString("dd/MMM/yyyy"), sTmpEmpID = "1";
        let drw;

        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
            if (i == iRowId)
                continue;

            if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                sTmpDailyAttDate = ""; sTmpEmpID = "1";
                drw = this.ScreenObject.GridData[i];

                var vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                if (vFld)
                    sTmpDailyAttDate = (vFld as PactExtraFieldDateData).Date.ToString("dd/MMM/yyyy");
                else {
                    var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                    if (vFld2 && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                        sTmpDailyAttDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");
                }

                vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld) {
                    if (vFld instanceof PactListBoxData)
                        sTmpEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sTmpEmpID = vFld.SelectedValue.toString();
                }
                else {
                    var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                    if (vFld2 && !Util.IsEmpty(drw[vFld2.ValueMember]))
                        sTmpEmpID = drw[vFld2.ValueMember].toString();
                }

                if (sEmpID == sTmpEmpID && sDailyAttDate == sTmpDailyAttDate) {
                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha2_Key") && !Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"])) {
                        dtChkDateTime = Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]);
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha2_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha3_Key"])) {

                            if (this.ScreenObject.Preferences.ContainsKey("SnoBasedLinking") && this.ScreenObject.Preferences["SnoBasedLinking"] != "" && parseBoolean(this.ScreenObject.Preferences["SnoBasedLinking"])) {
                                if (dtChkDateTime >= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]) && dtChkDateTime < Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha3_Key"])) {
                                    sRet = (i + 1).toString();
                                    break;
                                }
                            }
                            else {
                                if (dtChkDateTime >= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]) && dtChkDateTime <= Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha3_Key"])) {
                                    sRet = (i + 1).toString();
                                    break;
                                }
                            }
                        }
                    }
                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha3_Key") && !Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"])) {
                        dtChkDateTime = Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"]);
                        if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha2_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha3_Key"])) {
                            if (dtChkDateTime > Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]) && dtChkDateTime < Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha3_Key"])) {
                                sRet = (i + 1).toString();
                                break;
                            }
                        }
                    }
                    ////
                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha2_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha2_Key"])) {
                        dtChkDateTime = Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]);
                        if (!Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"])) {
                            if (dtChkDateTime >= Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]) && dtChkDateTime < Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"])) {
                                sRet = (i + 1).toString();
                                break;
                            }
                        }
                    }
                    if (this.ScreenObject.GridDataColumns.Contains("dcAlpha3_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcAlpha3_Key"])) {
                        dtChkDateTime = Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha3_Key"]);
                        if (!Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]) && !Util.IsEmpty(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"])) {
                            if (dtChkDateTime > Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]) && dtChkDateTime < Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"])) {
                                sRet = (i + 1).toString();
                                break;
                            }
                        }
                    }

                }
            }
        }

        //Check in Saved Documents
        //a.CostCenterID=40067
        let sQ = `d.tDocumentType=67 and a.StatusID=369
AND ISDATE(d.dcAlpha1)=1 AND ISDATE(d.dcAlpha2)=1 AND ISDATE(d.dcAlpha3)=1  
AND a.DOCID<>` + this.ScreenObject.DocID + ` AND b.dcCCNID51=` + sEmpID + ` 
--AND CONVERT(DATETIME,d.dcAlpha1)=CONVERT(DATETIME,'` + sDailyAttDate + `')`;

        if (this.ScreenObject.Preferences.ContainsKey("AllowEndTimeSameAsStartTime") && this.ScreenObject.Preferences["AllowEndTimeSameAsStartTime"] != "" && parseBoolean(this.ScreenObject.Preferences["AllowEndTimeSameAsStartTime"])) {
            sQ += `
AND (
( CONVERT(DATETIME,d.dcAlpha2) >= CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') AND CONVERT(DATETIME,d.dcAlpha2) < CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') ) OR
( CONVERT(DATETIME,d.dcAlpha3) > CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') AND CONVERT(DATETIME,d.dcAlpha3) < CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') ) OR
( CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') >= CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') < CONVERT(DATETIME,d.dcAlpha3)) OR
( CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') > CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') < CONVERT(DATETIME,d.dcAlpha3))
) `;
        }
        else {
            sQ += `
    AND (
    ( CONVERT(DATETIME,d.dcAlpha2) >= CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') AND CONVERT(DATETIME,d.dcAlpha2) <= CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') ) OR
    ( CONVERT(DATETIME,d.dcAlpha3) > CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') AND CONVERT(DATETIME,d.dcAlpha3) < CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') ) OR
    ( CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') >= CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') <= CONVERT(DATETIME,d.dcAlpha3)) OR
    ( CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') > CONVERT(DATETIME,d.dcAlpha2) AND CONVERT(DATETIME,'` + Util.ParseDate(this.ScreenObject.GridData[iRowId]["dcAlpha3_Key"]).ToString("dd/MMM/yyyy HH:mm:ss") + `') < CONVERT(DATETIME,d.dcAlpha3))
    ) `;
        }
        let dtChk: any[] = BaseService.common.GetDataSet("PAY007", JSON.stringify(sQ)).Tables[0];
        if (dtChk != null && dtChk.length > 0)
            sRet = dtChk[0]["VoucherNo"].toString();

        return sRet;
    }

    //#endregion

    //#region Regularization of Attendance

    private LoadDailyAttendanceDocuments() {
        this.ScreenObject.GridDataObj.Clear();

        let sEmpSeqNo = "";
        let dtF = Util.GetEmptyDate();
        let dtT = Util.GetEmptyDate();
        let dtTempF = Util.GetEmptyDate();
        let dtTempT = Util.GetEmptyDate();
        var fld1 = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
        if (fld1 != undefined && fld1 != null && fld1 instanceof PactListBoxData)
            sEmpSeqNo = fld1.SelectedValue.toString();
        else if (fld1 != undefined && fld1 != null && fld1 instanceof PactCodeNameListBoxData)
            sEmpSeqNo = fld1.SelectedValue.toString();

        if (sEmpSeqNo == "" || parseInt(sEmpSeqNo) == 0) {
            this.DisplayMessage = "Select any Employee";
            this.MessageVisibility = true;
            return;
        }

        var fld2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha10");
        if (fld2 != undefined && fld2 != null && fld2 instanceof PactExtraFieldDateData) {
            if (!Util.IsEmpty(fld2.Date))
                dtF = Util.ParseDate(fld2.Date);
        }


        var fld3 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha11");
        if (fld3 != undefined && fld3 != null && fld3 instanceof PactExtraFieldDateData) {
            if (!Util.IsEmpty(fld3.Date))
                dtT = Util.ParseDate(fld3.Date);
        }


        if (dtF.getFullYear() == 1 || dtT.getFullYear() == 1) {
            this.DisplayMessage = "Enter From / To Date.";
            this.MessageVisibility = true;
            return;
        }

        dtTempF = dtF;
        dtTempT = dtT;

        let dtLate: any = this.CheckIsLateCheckInOrEarlyCheckOut(sEmpSeqNo);
        //if (strInvDocIDs.length == 0)
        //{
        //    DisplayMessage = "No data found between the Dates.";
        //    MessageVisibility = true;
        //    return;
        //}
        let strInvDocIDs = "";
        if (dtLate != null && dtLate.length > 0) {
            for (let i = 0; i < dtLate.length; i++) {
                if (strInvDocIDs.length > 0)
                    strInvDocIDs += ",";

                strInvDocIDs += dtLate[i]["sInvDocIDs"];
            }
        }

        let drCL2 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'dcAlpha12');

        if (strInvDocIDs.length > 0) {
            let dtDA = BaseService.common.GetDataTable("DOC056", sEmpSeqNo + "~" + dtF.ToString("dd/MMM/yyyy") + "~" + dtT.ToString("dd/MMM/yyyy") + "~" + strInvDocIDs);


            if (dtDA != null && dtDA.length > 0) {
                let drGrid: any = null;
                let RowPosition = 0;

                let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');

                for (let c = 0; c < dtDA.length; c++) {
                    drGrid = this.ScreenObject.GridDataObj.NewRow();
                    //ScreenObject.GridData.Rows.InsertAt(drGrid, RowPosition);
                    RowPosition++;

                    //if (drCL.length > 0 && Util.String(drCL[0]["UserDefaultValue"]) != "")
                    //{
                    //    drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                    //}

                    drGrid["dcAlpha1"] = dtDA[c]["VoucherNo"];
                    drGrid["dcAlpha2"] = dtDA[c]["DocSeqNo"];

                    drGrid["dcAlpha3"] = Util.ParseDate(dtDA[c]["DailyAttDate"]).ToString(BaseService.SessionManager.Preferences["Date Format"]);
                    drGrid["dcAlpha3_Key"] = Util.ParseDate(dtDA[c]["DailyAttDate"]);

                    drGrid["dcAlpha4"] = Util.ParseDate(dtDA[c]["StartTime"]).ToString("HH:mm");
                    drGrid["dcAlpha4_Key"] = Util.ParseDate(dtDA[c]["StartTime"]);

                    drGrid["dcAlpha5"] = Util.ParseDate(dtDA[c]["EndTime"]).ToString("HH:mm");
                    drGrid["dcAlpha5_Key"] = Util.ParseDate(dtDA[c]["EndTime"]);

                    drGrid["dcCCNID73"] = dtDA[c]["ShiftName"];
                    drGrid["dcCCNID73_Key"] = dtDA[c]["ShiftSeqNo"];

                    drGrid["dcAlpha6"] = Util.ParseDate(dtDA[c]["ShiftStartTime"]).ToString("HH:mm");
                    drGrid["dcAlpha7"] = Util.ParseDate(dtDA[c]["ShiftEndTime"]).ToString("HH:mm");

                    if (this.ScreenObject.Preferences.ContainsKey("SetUpdatedStartEndTimeToShiftTime") && this.ScreenObject.Preferences["SetUpdatedStartEndTimeToShiftTime"] != "" && parseBoolean(this.ScreenObject.Preferences["SetUpdatedStartEndTimeToShiftTime"])) {
                        drGrid["dcAlpha8"] = Util.ParseDate(dtDA[c]["ShiftStartTime"]).ToString("HH:mm");
                        drGrid["dcAlpha8_Key"] = Util.ParseDate(dtDA[c]["ShiftStartTime"]);

                        drGrid["dcAlpha9"] = Util.ParseDate(dtDA[c]["ShiftEndTime"]).ToString("HH:mm");
                        drGrid["dcAlpha9_Key"] = Util.ParseDate(dtDA[c]["ShiftEndTime"]);

                        //drGrid["dcAlpha12"] = "YES";
                    }
                    else {
                        drGrid["dcAlpha8"] = Util.ParseDate(dtDA[c]["StartTime"]).ToString("HH:mm");
                        drGrid["dcAlpha8_Key"] = Util.ParseDate(dtDA[c]["StartTime"]);

                        drGrid["dcAlpha9"] = Util.ParseDate(dtDA[c]["EndTime"]).ToString("HH:mm");
                        drGrid["dcAlpha9_Key"] = Util.ParseDate(dtDA[c]["EndTime"]);

                        //drGrid["dcAlpha12"] = "NO";
                    }

                    if (drCL2 != null && drCL2.length > 0)
                        drGrid["dcAlpha12"] = drCL2[0]["UserDefaultValue"];

                    let dr: any = dtLate.filter(x => x.sInvDocIDs == dtDA[c]["InvDocDetailsID"]);
                    if (dr != null && dr.length > 0) {
                        let st = "";
                        for (let i = 0; i < dr.length; i++) {
                            if (st.length > 0)
                                st += ",";

                            st += dr[i]["LateType"].toString();
                        }
                        drGrid["dcAlpha13"] = st;
                    }


                    this.FillDefaultProd(drGrid, "dcAlpha1");
                    this.Celleditend(drGrid, "dcAlpha1", 0);
                    this.ScreenObject.GridDataObj.addRow(drGrid);

                }
                //this.ScreenObject.GridData.AcceptChanges();

                if (this.RefreshGrid)
                    this.RefreshGrid = false;
                else
                    this.RefreshGrid = true;
            }
        }


        let dt1: any = BaseService.common.GetDataTable("DOC060", sEmpSeqNo + "~" + dtTempF.ToString("dd MMM yyyy") + "~" + dtTempT.ToString("dd MMM yyyy"));
        let dr1;
        let sFilter = "";
        let dvCCData: any = null;

        sFilter += "  AND EmpSeqNo IN (" + sEmpSeqNo + ")";

        let ObjArray1 = [];
        ObjArray1.push(dtT.ToString("dd MMM yyyy"));
        ObjArray1.push(sFilter);
        ObjArray1.push(0);
        ObjArray1.push(BaseService.SessionManager.RoleID);
        ObjArray1.push(BaseService.SessionManager.UserID);
        ObjArray1.push(BaseService.SessionManager.LanguageID);

        let dsData = BaseService.common.GetDataSet_SP(ObjArray1, "spPAY_GetEmpMasterCCDetails");
        let drccData: any = null;
        let dtcc: any;
        if (dsData != null && dsData.Tables.length > 0) {
            dtcc = dsData.Tables[0];
            for (let index = 0; index < dsData.Columns.length; index++) {
                const dc = dsData.Columns[index];
                if (!dc.Contains("CCNID") || dc.Contains("Name"))
                    continue;
                // dtcc.Columns.push("dc" + dc.ColumnName, typeof(System.String));
                // dtcc.Columns.push("dc" + dc.ColumnName + "_Key", typeof(System.Int64));
                dtcc.forEach(row => {
                    //row["dc" + dc] = "";
                    row["dc" + dc + "_Key"] = row[dc];
                });
            }
            // foreach (DataColumn dc in dsData.Columns[0])
            // {
            //     if (!dc.ColumnName.Contains("CCNID") || dc.ColumnName.Contains("Name"))
            //         continue;
            //     dtcc.Columns.push("dc" + dc.ColumnName, typeof(System.String));
            //     dtcc.Columns.push("dc" + dc.ColumnName + "_Key", typeof(System.Int64));
            //     foreach (DataRow row in dtcc.Rows)
            //     {
            //         row["dc" + dc.ColumnName + "_Key"] = row[dc.ColumnName];
            //     }
            // }

            // if (!dtcc.Columns.Contains("dcCCNID51")) 
            //     dtcc.Columns.push("dcCCNID51", typeof(System.String));
            // if (!dtcc.Columns.Contains("dcCCNID51_Key"))
            //     dtcc.Columns.push("dcCCNID51_Key", typeof(System.Int64));

            // dtcc.Columns.push("dcCCNID73", typeof(System.String));
            // dtcc.Columns.push("dcCCNID73_Key", typeof(System.Int64));

            dtcc.forEach(row => {
                row["dcCCNID51_Key"] = row["EmpSeqNo"];
            });
            // foreach (DataRow row in dtcc.Rows)
            // {
            //     row["dcCCNID51_Key"] = row["EmpSeqNo"];
            // }

            //dtcc.Columns.push("PayrollType", typeof(System.String));
            drccData = dtcc.filter(x => x.EmpSeqNo == sEmpSeqNo);
        }

        while (dtTempF <= dtTempT) {
            if (dt1 != null && dt1.length > 0) {
                //dr1 = dt1.Select("(FromDate>='" + dtTempF.ToString("dd MMM yyyy") + "' AND ToDate<='" + dtTempF.ToString("dd MMM yyyy") + "') OR (FromDate<='" + dtTempF.ToString("dd MMM yyyy") + "' AND ToDate>='" + dtTempF.ToString("dd MMM yyyy") + "')");
                dr1 = dt1.filter(x => (x.FromDate >= dtTempF.ToString("dd MMM yyyy") && x.ToDate <= dtTempF.ToString("dd MMM yyyy")) || (x.FromDate <= x.dtTempF.ToString("dd MMM yyyy") && x.ToDate >= dtTempF.ToString("dd MMM yyyy")));

                if (dr1 != null && dr1.length > 0) {
                    dtTempF = dtTempF.AddDays(1);
                    continue;
                }
            }

            if (drccData != null && drccData.length > 0) {

                this.CheckEmployeeShift(sEmpSeqNo, dtTempF.ToString("dd MMM yyyy"), drccData[0]);

                if (this.objPayDayCheck == null)
                    this.objPayDayCheck = new PayDayCheck(this.ScreenObject);

                drccData[0]["PayrollType"] = "";
                this.objPayDayCheck.CheckIsHolidayDate(sEmpSeqNo, dtTempF.ToString("dd MMM yyyy"), drccData[0]);

                if (!Util.IsEmpty(drccData[0]["PayrollType"])) {
                    dtTempF = dtTempF.AddDays(1);
                    continue;
                }
            }

            let drGrid: any = null;
            let RowPosition = this.ScreenObject.GridData.length + 1;

            drGrid = this.ScreenObject.GridDataObj.NewRow();
            //this.ScreenObject.GridData.Rows.InsertAt(drGrid, RowPosition);
            RowPosition++;

            //if (drCL.length > 0 && Util.String(drCL[0]["UserDefaultValue"]) != "")
            //{
            //    drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
            //}

            drGrid["dcAlpha1"] = "";
            drGrid["dcAlpha2"] = "";

            drGrid["dcAlpha3"] = dtTempF.ToString(BaseService.SessionManager.Preferences["Date Format"]);
            drGrid["dcAlpha3_Key"] = dtTempF.ToString("dd MMM yyyy");

            drGrid["dcAlpha4"] = "00:00";
            drGrid["dcAlpha5"] = "00:00";

            drGrid["dcCCNID73"] = "";
            drGrid["dcCCNID73_Key"] = 1;

            drGrid["dcAlpha6"] = "00:00";
            drGrid["dcAlpha7"] = "00:00";

            drGrid["dcAlpha8"] = "00:00";
            drGrid["dcAlpha8_Key"] = "00:00";

            drGrid["dcAlpha9"] = "00:00";
            drGrid["dcAlpha9_Key"] = "00:00";

            drGrid["dcAlpha13"] = "Absent";


            if (drCL2 != null && drCL2.length > 0)
                drGrid["dcAlpha12"] = drCL2[0]["UserDefaultValue"];

            this.FillDefaultProd(drGrid, "dcAlpha1");
            this.Celleditend(drGrid, "dcAlpha1", 0);

            dtTempF = dtTempF.AddDays(1);
            this.ScreenObject.GridDataObj.addRow(drGrid);
        }
        //this.ScreenObject.GridData.AcceptChanges();

        if (this.RefreshGrid)
            this.RefreshGrid = false;
        else
            this.RefreshGrid = true;



    }

    //#endregion

    //#region On Duty

    private async LoadODData(sEmpSeqNo: string) {
        let dtTempF = new Date(), dtTempT = new Date(), dtODST = new Date(), dtODET = new Date();
        let sSession = "Both";
        const { OnDutyGenerateViewModel } = await import('../../ess/on-duty/OnDutyGenerateViewModel');
        const { OnDutyComponent } = await import('../../ess/on-duty/on-duty.component');
        let objOD = new OnDutyGenerateViewModel();
        BaseService.page.ShowDialog(objOD, OnDutyComponent, { ShowCenter: true, Title: "On Duty - Generate" }).subscribe(() => {
            if (objOD.DialogResult) {
                this.ScreenObject.GridDataObj.Clear();

                dtTempF = objOD.ODStartDate;
                dtTempT = objOD.ODEndDate;
                dtODST = objOD.ODStartTime;
                dtODET = objOD.ODEndTime;
                sSession = objOD.sSession;
                let sFilter = "";

                sFilter += "  AND EmpSeqNo IN (" + sEmpSeqNo + ")";

                let ObjArray1 = [];
                ObjArray1.push(dtTempT.ToString("dd MMM yyyy"));
                ObjArray1.push(sFilter);
                ObjArray1.push(0);
                ObjArray1.push(BaseService.SessionManager.RoleID);
                ObjArray1.push(BaseService.SessionManager.UserID);
                ObjArray1.push(BaseService.SessionManager.LanguageID);

                let dsData = BaseService.common.GetDataSet_SP(ObjArray1, "spPAY_GetEmpMasterCCDetails");
                let drccData: any = null;
                let dtcc: any;
                if (dsData != null && dsData.Tables.length > 0) {
                    dtcc = dsData.Tables[0].Copy();

                    for (let i = 0; i < dsData.Columns[0].length; i++) {
                        const dc = dsData.Columns[0][i];
                        if (!dc.Contains("CCNID") || dc.Contains("Name"))
                            continue;

                        // dtcc.Columns.push("dc" + dc.ColumnName, typeof(System.String));
                        // dtcc.Columns.push("dc" + dc.ColumnName + "_Key", typeof(System.Int64));

                        for (let j = 0; j < dtcc.length; j++) {
                            const row = dtcc[j];
                            row["dc" + dc + "_Key"] = row[dc];
                        }

                        // foreach (DataRow row in dtcc.Rows)
                        // {
                        //     row["dc" + dc.ColumnName + "_Key"] = row[dc.ColumnName];
                        // }
                    }


                    // if (!dtcc.Columns.Contains("dcCCNID51"))
                    //     dtcc.Columns.push("dcCCNID51", typeof(System.String));
                    // if (!dtcc.Columns.Contains("dcCCNID51_Key"))
                    //     dtcc.Columns.push("dcCCNID51_Key", typeof(System.Int64));

                    // dtcc.Columns.push("dcCCNID73", typeof(System.String));
                    // dtcc.Columns.push("dcCCNID73_Key", typeof(System.Int64));
                    for (let i = 0; i < dtcc.length; i++) {
                        const row = dtcc[i];
                        row["dcCCNID51_Key"] = row["EmpSeqNo"];

                    }

                    //dtcc.Columns.push("PayrollType", typeof(System.String));
                    drccData = dtcc.filter(x => x.EmpSeqNo == sEmpSeqNo);
                }

                let sOnDutyIncludeorExclude = "";
                if (BaseService.SessionManager.Preferences.ContainsKey("OnDutyIncludeorExclude") && !Util.IsEmpty(BaseService.SessionManager.Preferences["OnDutyIncludeorExclude"]))
                    sOnDutyIncludeorExclude = BaseService.SessionManager.Preferences["OnDutyIncludeorExclude"].toString();

                while (dtTempF <= dtTempT) {
                    if (drccData != null && drccData.length > 0) {

                        this.CheckEmployeeShift(sEmpSeqNo, dtTempF.ToString("dd MMM yyyy"), drccData[0]);

                        if (this.objPayDayCheck == null)
                            this.objPayDayCheck = new PayDayCheck(this.ScreenObject);

                        drccData[0]["PayrollType"] = "";

                        this.objPayDayCheck.CheckIsHolidayDate(sEmpSeqNo, dtTempF.ToString("dd MMM yyyy"), drccData[0]);

                        if (Util.String(drccData[0]["PayrollType"]) != "") {
                            if (sOnDutyIncludeorExclude != null && sOnDutyIncludeorExclude.length > 0) {
                                if ((sOnDutyIncludeorExclude == "IncludeWeeklyOffs" || sOnDutyIncludeorExclude == "ExcludeHolidays") && drccData[0]["PayrollType"].toString() == "Holiday") {
                                    dtTempF = dtTempF.AddDays(1);
                                    continue;
                                }
                                else if ((sOnDutyIncludeorExclude == "IncludeHolidays" || sOnDutyIncludeorExclude == "ExcludeWeeklyOffs") && drccData[0]["PayrollType"].toString() == "WeeklyOff") {
                                    dtTempF = dtTempF.AddDays(1);
                                    continue;
                                }
                                else if (sOnDutyIncludeorExclude == "ExcludeBoth") {
                                    dtTempF = dtTempF.AddDays(1);
                                    continue;
                                }
                            }
                        }
                    }

                    let drGrid = null;
                    let RowPosition = this.ScreenObject.GridData.length + 1;

                    drGrid = this.ScreenObject.GridDataObj.NewRow();
                    this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                    RowPosition++;

                    drGrid["dcAlpha2"] = dtTempF.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                    drGrid["dcAlpha2_Key"] = dtTempF.ToString("dd MMM yyyy");

                    drGrid["dcAlpha3"] = dtODST.ToString("HH:mm");
                    drGrid["dcAlpha3_Key"] = new Date(dtODST);

                    drGrid["dcAlpha4"] = dtTempF.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                    drGrid["dcAlpha4_Key"] = dtTempF.ToString("dd MMM yyyy");

                    drGrid["dcAlpha5"] = dtODET.ToString("HH:mm");
                    drGrid["dcAlpha5_Key"] = new Date(dtODET);

                    drGrid["dcAlpha6"] = sSession;

                    this.FillDefaultProd(drGrid, "dcAlpha6");
                    this.Celleditend(drGrid, "dcAlpha6", 0);

                    dtTempF = dtTempF.AddDays(1);
                    this.ScreenObject.GridDataObj.updateRow(drGrid);
                }
                //this.ScreenObject.GridData.AcceptChanges();

                if (this.RefreshGrid)
                    this.RefreshGrid = false;
                else
                    this.RefreshGrid = true;

            }
        });
    }

    //#endregion

    VacCrDaysScreen: any[] = []; //ViewModelBase[] = []

    objPayDayCheck: PayDayCheck = null;

    public GetLOPLeaveDocuments(iEmpSeqNo: number, iLeaveType: number, dtDocDate: Date): any {
        let dsD = BaseService.common.GetDataSet3("PAY008", iEmpSeqNo.toString(), iLeaveType.toString(), dtDocDate.ToString("dd/MMM/yyyy"));
        return dsD;
    }

    FillEarningsDeductions(EmpNode: number, dtDate: Date) {
        try {
            let FieldType: any[] = [];
            let FieldType1: any[] = [];
            //LOADING COMPONENT TYPES AND COMPONENT NAME IN COMBOBOX
            let dsData1 = this.ScreenObject.GetPayrollComponents(3, 1, EmpNode, Util.ParseDate(dtDate));
            if (dsData1.Tables.length > 0) {
                var fldPSD1 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha20");
                if (fldPSD1) {
                    if (dsData1.Tables[1].length > 0) {
                        for (let i = 0; i <= dsData1.Tables[1].length - 1; i++) {
                            FieldType.push(ComboBoxItems.ComboBoxItems_2(dsData1.Tables[1][i]["NAME"].toString(), dsData1.Tables[1][i]["NODEID"].toString()));
                        }
                        fldPSD1.DisplayMember = "Name";
                        fldPSD1.ValueMember = "Value";
                        fldPSD1.ComboData = FieldType;
                    }
                }

                var fldPSD2 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha21");
                if (fldPSD2) {
                    if (dsData1.Tables[0].length > 0) {
                        for (let i = 0; i <= dsData1.Tables[0].length - 1; i++) {
                            FieldType1.push(ComboBoxItems.ComboBoxItems_2(dsData1.Tables[0][i]["NAME"].toString(), dsData1.Tables[0][i]["NODEID"].toString()));
                        }
                        fldPSD2.DisplayMember = "Name";
                        fldPSD2.ValueMember = "Value";
                        fldPSD2.ComboData = FieldType1;
                    }
                }
            }

            //FILLING COMPONENT TYPE DETAILS IN GRIDDATA
            let drGrid = null;
            let RowPosition = 0;
            let drCL1 = null;
            if (dsData1.Tables.length > 0) {
                if (dsData1.Tables[1].length > 0) {
                    drGrid = null;
                    this.ScreenObject.GridDataObj.Clear();
                    let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                    for (let k = 0; k < dsData1.Tables[1].length; k++) {
                        drGrid = this.ScreenObject.GridDataObj.NewRow();
                        this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                        RowPosition++;
                        if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"]))
                            drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];

                        drGrid["dcAlpha20"] = dsData1.Tables[1][k]["NODEID"];
                        drCL1 = dsData1.Tables[1].filter(x => x.NODEID == parseInt(drGrid["dcAlpha20"]));
                        drGrid["dcAlpha21"] = drCL1[0]["PARENTID"];
                    }
                    this.ScreenObject.GridDataObj.refreshDataView();
                    this.RefreshGrid = true;
                }
            }

            if (BaseService.SessionManager.Preferences.ContainsKey("DonotConsiderVacationdaysasLeave") && parseBoolean(BaseService.SessionManager.Preferences["DonotConsiderVacationdaysasLeave"] == "True")) {
                var fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha17");
                if (fldAPV instanceof PactComboBoxData && !Util.IsEmpty(fldAPV.SelectedValue))
                    fldAPV.SelectedValue = "Yes";

            }
            else {
                var fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha17");
                if (fldAPV instanceof PactComboBoxData && !Util.IsEmpty(fldAPV.SelectedValue))
                    fldAPV.SelectedValue = "No";

            }

        }
        catch (error) {
            this.DisplayMessage = "Load Error";
            Logger.ErrorLog("AddEditDocumentViewModel:: FillEarningsDeductions" + error.stack);
        }
    }

    FillVacationManagementComponents() {
        Logger.InfoLog("AddEditDocumentViewModel::Entering FillVacationManagementComponents");
        try {
            let FieldType1 = [];
            //LOADING COMPONENT TYPES AND COMPONENT NAME IN COMBOBOX
            let dsData1 = this.ScreenObject.GetPayrollComponents(4, 1, 0, this.DocumentDate);
            if (dsData1.Tables.length > 0) {
                var fldPSD2 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha17");
                if (fldPSD2) {
                    if (dsData1.Tables[0].length > 0) {
                        for (let i = 0; i <= dsData1.Tables[0].length - 1; i++) {
                            FieldType1.push(ComboBoxItems.ComboBoxItems_2(dsData1.Tables[0][i]["NAME"].toString(), dsData1.Tables[0][i]["NODEID"].toString()));
                        }
                        fldPSD2.DisplayMember = "Name";
                        fldPSD2.ValueMember = "Value";
                        fldPSD2.ComboData = FieldType1;
                    }
                }
            }
        }
        catch (error) {
            this.DisplayMessage = "Load Error";
            Logger.ErrorLog("AddEditDocumentViewModel:: FillVacationManagementComponents" + error.stack);
        }
    }

    FillForm12BALookupDetails() {
        Logger.InfoLog("AddEditDocumentViewModel::Entering FillForm12BALookupDetails");
        try {
            let FieldType = [];
            let drGrid = null;
            let RowPosition = 0, intdsRecordcount = 0;
            let dsData12 = this.ScreenObject.GetPayrollComponents(5, 0, 0, this.DocumentDate);
            if (dsData12.Tables.length > 0) {
                if (dsData12.Tables[0].length > 0) {

                    intdsRecordcount = dsData12.Tables[0].length;

                    intdsRecordcount = intdsRecordcount + 1;
                    let drPQE = {};//dsData12.Tables[0].NewRow();
                    drPQE["NAME"] = "Total Value of Perquisites";
                    drPQE["NODEID"] = intdsRecordcount;
                    dsData12.Tables[0].push(drPQE);

                    intdsRecordcount = intdsRecordcount + 1;
                    drPQE = {}//dsData12.Tables[0].NewRow();
                    drPQE["NAME"] = "Total Value of Profits in lieu of salary as per section 17(3)";
                    drPQE["NODEID"] = intdsRecordcount;
                    dsData12.Tables[0].push(drPQE);

                    var fldPQE = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha2");
                    if (fldPQE) {
                        for (let i = 0; i <= dsData12.Tables[0].length - 1; i++) {
                            FieldType.push(ComboBoxItems.ComboBoxItems_2(dsData12.Tables[0][i]["NAME"].toString(), dsData12.Tables[0][i]["NODEID"].toString()));
                        }
                        fldPQE.DisplayMember = "Name";
                        fldPQE.ValueMember = "Value";
                        fldPQE.ComboData = FieldType;
                    }

                    drGrid = null;
                    this.ScreenObject.GridDataObj.Clear();
                    let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                    for (let k = 0; k < dsData12.Tables[0].length; k++) {
                        drGrid = this.ScreenObject.GridDataObj.NewRow();
                        this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                        RowPosition++;
                        if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"])) {
                            drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                        }
                        drGrid["dcAlpha2"] = dsData12.Tables[0][k]["NODEID"];
                        if (dsData12.Tables[0][k]["NAME"].toString() == "Total Value of Perquisites") {
                            drGrid["dcAlpha3"] = -1;
                        }
                        else if (dsData12.Tables[0][k]["NAME"].toString() == "Total Value of Profits in lieu of salary as per section 17(3)") {
                            drGrid["dcAlpha3"] = -2;
                        }
                        else {
                            drGrid["dcAlpha3"] = 0;
                        }
                    }
                    this.ScreenObject.GridDataObj.refreshDataView();

                }
            }
            this.ScreenObject.GridDataObj.CanUserAddRows = false;
            this.ScreenObject.GridDataObj.CanUserDeleteRows = false;
        }
        catch (error) {
            this.DisplayMessage = "Load Error";
            Logger.ErrorLog("AddEditDocumentViewModel:: FillForm12BALookupDetails" + error.stack);
        }
    }

    GetITSlabValidation(flag: number, datarow: any = null): string {
        let strSlabValidationMessage = '';
        let dvitSlab: any[] = null;

        if (flag == 0)
            dvitSlab = datarow.Table.Copy();
        else if (flag == 1)
            dvitSlab = this.ScreenObject.GridData.Copy();

        dvitSlab.sort((a, b) => b.dcAlpha8 - a.dcAlpha8)// DESC

        for (let i = 1; i < dvitSlab.length - 1; i++) {
            if (dvitSlab[i]["dcAlpha8"] != null && dvitSlab[i]["dcNum1"] != null && dvitSlab[i]["dcNum2"] != null) {
                if (dvitSlab[i]["dcAlpha8"].toString() == dvitSlab[i - 1]["dcAlpha8"].toString() && parseFloat(dvitSlab[i]["dcNum1"]) <= parseFloat(dvitSlab[i - 1]["dcNum2"])) {
                    strSlabValidationMessage = "From Slab should be greater than To Slab for gender '" + dvitSlab[i]["dcAlpha8"].toString() + "'\r\n";
                    break;
                }
                if (dvitSlab[i]["dcAlpha8"].toString() == dvitSlab[i]["dcAlpha8"].toString() && parseFloat(dvitSlab[i]["dcNum2"]) <= parseFloat(dvitSlab[i]["dcNum1"])) {
                    strSlabValidationMessage = "To Slab should be greater than From Slab for gender '" + dvitSlab[i]["dcAlpha8"].toString() + "'\r\n";
                    break;
                }
            }
        }
        return strSlabValidationMessage;
    }

    FillGratuitySettingsExpDetails() {
        Logger.InfoLog("AddEditDocumentViewModel::Entering FillGratuitySettingsExpDetails");
        try {
            let FieldType = [];
            let FieldType1 = [];
            let drGrid = null;
            let RowPosition = 0;
            let dsDataGts = this.ScreenObject.GetPayrollComponents(6, 0, 0, this.DocumentDate);
            if (dsDataGts.Tables.length > 0) {
                if (dsDataGts.Tables[0].length > 0) {
                    var fldGts = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha5");
                    if (fldGts) {
                        for (let i = 0; i <= dsDataGts.Tables[0].length - 1; i++) {
                            FieldType.push(ComboBoxItems.ComboBoxItems_2(dsDataGts.Tables[0][i]["NAME"].toString(), dsDataGts.Tables[0][i]["NODEID"].toString()));
                        }
                        fldGts.DisplayMember = "Name";
                        fldGts.ValueMember = "Value";
                        fldGts.ComboData = FieldType;
                    }

                    fldGts = this.ScreenObject.ColumnSource.find(a => a.ValueBinding == "dcAlpha9");
                    if (fldGts) {
                        for (let i = 0; i <= dsDataGts.Tables[0].length - 1; i++) {
                            FieldType1.push(ComboBoxItems.ComboBoxItems_2(dsDataGts.Tables[0][i]["NAME"].toString(), dsDataGts.Tables[0][i]["NODEID"].toString()));
                        }
                        fldGts.DisplayMember = "Name";
                        fldGts.ValueMember = "Value";
                        fldGts.ComboData = FieldType1;
                    }

                    drGrid = null;
                    this.ScreenObject.GridDataObj.Clear();
                    let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                    for (let k = 0; k < dsDataGts.Tables[0].length; k++) {
                        drGrid = this.ScreenObject.GridDataObj.NewRow();
                        this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                        RowPosition++;
                        if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"])) {
                            drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                        }
                        drGrid["dcAlpha5"] = dsDataGts.Tables[0][k]["NODEID"];
                        drGrid["dcAlpha6"] = 0;
                        drGrid["dcAlpha9"] = dsDataGts.Tables[0][k]["NODEID"];
                        drGrid["dcAlpha10"] = 0;
                        drGrid["dcAlpha17"] = dsDataGts.Tables[0][k]["NODEID"];
                        drGrid["dcAlpha18"] = 0;
                    }
                    this.ScreenObject.GridDataObj.refreshDataView();
                }
            }
            this.ScreenObject.GridDataObj.CanUserAddRows = false;
            this.ScreenObject.GridDataObj.CanUserDeleteRows = false;
        }
        catch (error) {
            this.DisplayMessage = "Load Error";
            Logger.ErrorLog("AddEditDocumentViewModel:: FillGratuitySettingsExpDetails" + error.stack);
        }
    }

    FillTdsMonthlyandQuarterlyDetails(Flag: number, FromDate: Date, Empcode: number, Year: number) {
        try {
            let FieldType = [];
            let drGrid = null;
            let RowPosition = 0;
            let dtFrom = new Date(Year, BaseService.SessionManager.AccountingFromMonth - 1, 1);
            let dsData12 = this.ScreenObject.GetTDSMonthlyandQuarterlyDetails(Empcode, Year, dtFrom);
            if (dsData12.Tables.length > 0) {
                if (dsData12.Tables[0].length > 0) {
                    drGrid = null;
                    this.ScreenObject.GridDataObj.Clear();
                    let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                    for (let k = 0; k < dsData12.Tables[0].length; k++) {
                        drGrid = this.ScreenObject.GridDataObj.NewRow();
                        this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                        RowPosition++;
                        if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"])) {
                            drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                        }

                        drGrid["dcAlpha2"] = dsData12.Tables[0][k]["TDSTYPE"];

                        if (parseInt(dsData12.Tables[0][k]["QUARTERNO"]) > 0) {
                            drGrid["dcAlpha3"] = Util.ParseDate(dsData12.Tables[0][k]["PayrollDate"]).ToString("MMM'-'yyyy");// ScreenObject.GetMonthName(parseInt(dsData12.Tables[0][k]["NODEID"]), false) + "-" + Util.String(dsData12.Tables[0][k]["YEARNO"]);
                            drGrid["dcNum5"] = parseFloat(dsData12.Tables[0][k]["AMOUNT"]);
                            drGrid["dcNum6"] = 0;
                        }
                        else {
                            drGrid["dcAlpha3"] = dsData12.Tables[0][k]["MONTHTEXT"];
                            drGrid["dcNum6"] = parseFloat(dsData12.Tables[0][k]["AMOUNT"]);
                            drGrid["dcNum5"] = 0;
                        }

                        drGrid["dcAlpha10"] = dsData12.Tables[0][k]["QUARTERNO"];
                        drGrid["dcNum1"] = parseFloat(dsData12.Tables[0][k]["TDS"]);
                        drGrid["dcNum2"] = parseFloat(dsData12.Tables[0][k]["SURCHARGE"]);
                        drGrid["dcNum3"] = parseFloat(dsData12.Tables[0][k]["EDUCATIONCESS"]);
                        drGrid["dcNum4"] = parseFloat(dsData12.Tables[0][k]["SECANDHIGHEDUCESS"]);
                    }
                }
            }
        }
        catch (error) {
            this.DisplayMessage = "Load Error";
            Logger.ErrorLog("AddEditDocumentViewModel:: FillTdsMonthlyandQuarterlyDetails" + error.stack);
        }
    }

    FilterEmployees(): string {
        let strWhere = '';
        try {
            Logger.InfoLog("AddEditDocumentViewModel::Entering FilterEmployees()");
            if (this.DocumentType == 69 || this.DocumentType == 57)
                strWhere = " ( a.StatusID=250) ";
            else
                strWhere = " ( a.StatusID=250 AND DATEDIFF(DAY,GETDATE(),ISNULL(CONVERT(DATETIME,a.DORelieve),'01-Jan-9000'))>=0) ";

            if (BaseService.SessionManager.LocationID > 0 && BaseService.SessionManager.Preferences.ContainsKey("LocationWiseDimension") && BaseService.SessionManager.Preferences["LocationWiseDimension"].split(',').Contains("50051"))
                strWhere = strWhere + " AND a.NodeID IN ( Select NodeID From Com_CCCCData with(nolock) where CostCenterID=50051 and CCNID2=" + BaseService.SessionManager.LocationID + ")";

            //if (ScreenObject.LocationID > 0 && BaseService.SessionManager.Preferences.ContainsKey("LocationWiseDimension") && BaseService.SessionManager.Preferences["LocationWiseDimension"].split(',').Contains("50051"))
            //    strWhere += @" AND a.NodeID IN ( Select 1 as NodeID UNION ALL Select NodeID From Com_CCCCData with(nolock) where CostCenterID=50051 and CCNID2=" + ScreenObject.LocationID + ")";

            if (this.DocumentType == 67) {
                //strWhere = "";
                if (!Util.IsEmpty(BaseService.SessionManager.sWHEmpFilteredEmpSeqNos))
                    strWhere += " AND ( a.NodeID IN (" + BaseService.SessionManager.sWHEmpFilteredEmpSeqNos + "))";
            }
            Logger.InfoLog("AddEditDocumentViewModel::Exiting FilterEmployees()");
        }
        catch (error) {
            Logger.ErrorLog("AddEditDocumentViewModel::EXCEPTION FilterEmployees()" + error.stack);
        }
        return strWhere;
    }

    FilterLeaveTypes(Flag: number): string {
        let strLeaveTypeWhere = '';
        try {
            if (Flag == 0) {
                // strLeaveTypeWhere = " (  a.IsGroup=0 AND a.ParentID=5 and a.NodeID IN (Select ComponentID from Com_CC50054  with(nolock) where Type=4 And Convert(Datetime,Payrolldate)=(Select Max(Convert(Datetime,Payrolldate)) from Com_CC50054 with(nolock))) ) ";
                strLeaveTypeWhere = " ( a.ParentID=5 and Convert(Varchar,a.NodeId)  NOT IN (Select Isnull(TD.dcAlpha1,'0') From Com_DocTextData TD with(nolock),Inv_DocDetails ID with(nolock) Where ID.InvDocDetailsID=TD.InvDocDetailsID And ID.CostCenterID=40061)) ";
                if (BaseService.SessionManager.IsEmpUser) {
                    strLeaveTypeWhere += " AND (a.NodeID in (Select ComponentID from Com_CC50054  with(nolock) where  GradeID=1 AND Type=4 and ShowInESS='Yes' And Convert(Datetime,Payrolldate)=(Select Max(Convert(Datetime,Payrolldate)) from Com_CC50054 with(nolock) WHERE GradeID=1)))";
                }
            }
            else if (Flag == 1) {
                //strLeaveTypeWhere = " ( a.IsGroup=0 AND a.ParentID=5 and a.NodeID NOT IN (Select ComponentID from Com_CC50054  with(nolock) where Type=4 And Convert(Datetime,Payrolldate)=(Select Max(Convert(Datetime,Payrolldate)) from Com_CC50054 with(nolock))) ) ";
                strLeaveTypeWhere = " ( a.ParentID=5 and a.NodeId  NOT IN (Select Isnull(CC.dcCCnid52,'0') From Com_DocCCData CC with(nolock),Inv_DocDetails ID with(nolock) Where ID.InvDocDetailsID=CC.InvDocDetailsID And ID.CostCenterID IN(40060,40081))) ";
            }
            else if (Flag == 2) {
                strLeaveTypeWhere = ` 1=1
                AND
                (
                a.NodeID IN(Select ComponentID FROM COM_CC50054 
                WHERE GradeID=1 AND TYPE=4 
                AND PayrollDate=(SELECT MAX(PayrollDate) FROM COM_CC50054 )
                AND LeaveOthFeatures LIKE '%#REJOIN#%' )
                OR a.NodeID IN(Select DISTINCT CONVERT(INT,Isnull(TD.dcAlpha1,'0')) From Com_DocTextData TD with(nolock),Inv_DocDetails ID with(nolock) 
                Where TD.tCostCenterID=40061 AND ISNUMERIC(TD.dcAlpha1)=1 AND ID.InvDocDetailsID=TD.InvDocDetailsID )
                )`;
            }
            else if (Flag == 3) //LOP Type of Leaves
            {
                if (BaseService.SessionManager.Preferences.ContainsKey("ConsiderLOPBasedOn") && BaseService.SessionManager.Preferences["ConsiderLOPBasedOn"].toString() != "")
                    strLeaveTypeWhere = " 1=1 AND ( a.NodeID IN(" + BaseService.SessionManager.Preferences["ConsiderLOPBasedOn"].toString() + ") )";
                else
                    strLeaveTypeWhere = " 1<>1 ";
            }
        }
        catch (error) {
            Logger.ErrorLog("AddEditDocumentViewModel::EXCEPTION FilterLeaveTypes()" + error.stack);
        }
        return strLeaveTypeWhere;
    }
    strWhere = '';
    sFilter = '';
    sNodes = "";
    PopupEmployeesFilter(Type: string, CallBackType: string = ''): string {
        if (this.srcDocument != null && (this.srcDocument.toString() == "Biometric" || this.srcDocument.toString() == "PostAttTimeSheet"))
            return "";
        let fromDT: any = Type.split('~')[1];
        Type = Type.split('~')[0];

        this.strWhere = '';
        this.sFilter = "", this.sNodes = "";
        try {
            if (this.ScreenObject.DocumentType == 67 && BaseService.SessionManager.Preferences.ContainsKey("DailyAttendanceFilter") && parseInt(BaseService.SessionManager.Preferences["DailyAttendanceFilter"]) > 0) {
                if (this.oEmpFilter == null)
                    this.oEmpFilter = new EmpTreeFilterViewModel("", 0, 5);
                else {
                    if (this.oEmpFilter.CostCenterFilters.length > 0) {
                        this.oEmpFilter.CostCenters.SelectedValue = this.oEmpFilter.CostCenterFilters[0].CostCenterID.toString();
                    }
                    else {
                        this.oEmpFilter.Filter = 5;
                        this.oEmpFilter.InitControls();
                    }
                    this.oEmpFilter.CostCenters.Enable = true;
                }
                BaseService.page.ShowDialog(this.oEmpFilter, EmpTreeFilterComponent, { ShowCenter: true, HideHeader: true }).subscribe(() => {
                    this.empFilterTemp();
                    this.PopupEmpFilterCallBack(CallBackType, Type);

                });
            }
            else if (this.ScreenObject.DocumentType == 85) {
                if (this.oEmpFilter == null)
                    this.oEmpFilter = new EmpTreeFilterViewModel("", 0, 85);
                else {
                    if (this.oEmpFilter.CostCenterFilters.length > 0) {
                        this.oEmpFilter.CostCenters.SelectedValue = this.oEmpFilter.CostCenterFilters[0].CostCenterID.toString();
                    }
                    else {
                        this.oEmpFilter.Filter = 85;
                        this.oEmpFilter.InitControls();
                    }
                    this.oEmpFilter.CostCenters.Enable = true;
                }
                BaseService.page.ShowDialog(this.oEmpFilter, EmpTreeFilterComponent, { ShowCenter: true, HideHeader: true }).subscribe(() => {
                    this.empFilterTemp();
                    this.PopupEmpFilterCallBack(CallBackType, Type);
                });
            }
            else {
                if (this.oEmpFilter == null)
                    this.oEmpFilter = new EmpTreeFilterViewModel("", 0, this.ScreenObject.DocumentType == 81 && Type.toString() == "GradeWise" ? 6 : 7);
                else {
                    if (this.ScreenObject.DocumentType == 81 && (Type.toString() == "GradeWise" || Type.toString() == "GradeWiseCopy"))
                        this.oEmpFilter.Filter = 6;
                    else if (this.ScreenObject.DocumentType == 81 && Type.toString() == "EmployeeWise")
                        this.oEmpFilter.Filter = 7;
                    //oEmpFilter.Filter = ScreenObject.DocumentType == 81 && Type.toString() == "GradeWise" ? 6 : 7;
                    this.oEmpFilter.InitControls();
                }
            }

            if (this.ScreenObject.DocumentType == 81) {
                this.oEmpFilter.CostCenters.Enable = false;
                if (Type.toString() != "GradeWiseCopy")
                    BaseService.page.ShowDialog(this.oEmpFilter, EmpTreeFilterComponent, { ShowCenter: true, HideHeader: true }).subscribe(() => {
                        this.empFilterTemp();
                        this.PopupEmpFilterCallBack(CallBackType, Type + "~" + fromDT);
                    });
            }

            Logger.InfoLog("AddEditDocumentViewModel::Exiting PopupEmployeesFilter()");
        }
        catch (error) {
            Logger.ErrorLog("AddEditDocumentViewModel::EXCEPTION PopupEmployeesFilter()" + error.stack);
        }

        return this.strWhere;
    }
    empFilterTemp() {
        this.DialogResult = this.oEmpFilter.IsCompleted;
        if (this.oEmpFilter.IsCompleted) {
            if (this.oEmpFilter.CostCenterFilters.length > 0) {
                let RootID = 1;
                let strPK = '';
                let DimensionColumn = '';
                let sbDimWhere = '';

                for (let f = 0; f < this.oEmpFilter.CostCenterFilters.length; f++) {
                    let ccFilter = this.oEmpFilter.CostCenterFilters[f]
                    if (ccFilter.CostCenterID > 50000) {
                        RootID = 2;
                        strPK = "NodeID";
                        if (ccFilter.CostCenterID == 50051)
                            DimensionColumn = "EmpSeqNo";
                        else
                            DimensionColumn = "CCNID" + (ccFilter.CostCenterID - 50000);
                    }

                    if (ccFilter.SelectedNodes.length > 0) {
                        if (ccFilter.SelectedNodes.length == 1) {
                            sbDimWhere += " AND ";
                            sbDimWhere += DimensionColumn + "=" + ccFilter.SelectedNodes[0].Id;
                        }
                        else {
                            //To check root node selected or not
                            var root = ccFilter.SelectedNodes.find(x => x.Id == RootID && x.IsGroup);
                            if (!root) {
                                sbDimWhere += " AND ";
                                //If groups selected
                                if (IPrefetchFilter.IsGroupTree(ccFilter)) {
                                    let sbNodes = '';
                                    for (let k = 0; k < ccFilter.SelectedNodes.length; k++) {
                                        if (ccFilter.SelectedNodes[k].Parent == null || !ccFilter.SelectedNodes[k].Parent.IsSelected) {
                                            if (sbNodes.length > 0)
                                                sbNodes += ",";
                                            sbNodes += ccFilter.SelectedNodes[k].Id;

                                        }
                                    }
                                    if (sbNodes.length == 0)
                                        sbNodes += -12912;

                                    sbDimWhere += DimensionColumn + " IN ";
                                    sbDimWhere += " (select T." + strPK + " GTID from "
                                        + AddEditDocumentViewModel.GetTagTableName(ccFilter.CostCenterID) + " T with(nolock),"
                                        + AddEditDocumentViewModel.GetTagTableName(ccFilter.CostCenterID) + " GTP with(nolock) where T.lft BETWEEN GTP.lft AND GTP.rgt AND GTP." + strPK + " IN (";
                                    sbDimWhere += sbNodes.toString() + ")  group by T." + strPK + ")";
                                }
                                else {
                                    sbDimWhere += DimensionColumn + " IN (";
                                    for (let k = 0; k < ccFilter.SelectedNodes.length; k++) {
                                        if (k > 0)
                                            sbDimWhere += ",";
                                        sbDimWhere += ccFilter.SelectedNodes[k].Id;
                                    }
                                    sbDimWhere += ")";
                                }
                            }
                            else if (this.ScreenObject.DocumentType == 81) {
                                if (BaseService.SessionManager.Preferences.ContainsKey("ConsiderGlobalPreferencesBasedOnGrade") && BaseService.SessionManager.Preferences["ConsiderGlobalPreferencesBasedOnGrade"] == "True") {
                                    let isFound: boolean = false;
                                    isFound = this.Leaveyear("");

                                    if (isFound)
                                        return this.strWhere = "Different LeaveYear";

                                }
                            }
                        }
                    }
                    else if (!ccFilter.DeleteButtonVisibility) {
                        sbDimWhere += " AND ";
                        sbDimWhere += DimensionColumn + "=-12912";
                    }
                }
                this.sFilter = sbDimWhere.toString();

                if (this.ScreenObject.DocumentType == 81) {
                    if (BaseService.SessionManager.Preferences.ContainsKey("ConsiderGlobalPreferencesBasedOnGrade") && BaseService.SessionManager.Preferences["ConsiderGlobalPreferencesBasedOnGrade"] == "True") {
                        let isFound: boolean = false;
                        let iLeaveYear: number = 0;
                        if (this.sFilter != null && this.sFilter != "") {
                            let sf: string = this.sFilter;

                            let dsa: any = BaseService.common.GetDataSet3("PAY120", sf, BaseService.SessionManager.PayrollMonth.ToString("dd MMM yyyy"), BaseService.SessionManager.PayrollMonth.ToString("dd MMM yyyy"));
                            if (dsa != null && dsa.Tables.length > 0 && dsa.Tables[0].length > 0) {
                                for (let i = 0; i < dsa.Tables[0].length; i++) {
                                    for (let j = 0; j < dsa.Tables[0].length; j++) {
                                        if (i == j)
                                            continue;

                                        if (dsa.Tables[0][i]["Value"].toString() != dsa.Tables[0][j]["Value"].toString()) {
                                            isFound = true;
                                            break;
                                        }
                                    }
                                }
                                iLeaveYear = parseInt(dsa.Tables[0][0]["Value"].toString());
                            }
                        }

                        if (isFound)
                            return this.strWhere = "Different LeaveYear";

                        var ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                        if (ALfld && ALfld instanceof PactComboBoxData && Util.IsEmpty(ALfld.SelectedValue)) {
                            let dtLeaveYear: Date = new Date(parseInt((ALfld as PactComboBoxData).SelectedValue), iLeaveYear, 1);
                            this.sFilter += " AND ( CONVERT(DATETIME,EMP.DOJ) <='" + dtLeaveYear.ToString("dd MMM yyyy") + "' AND CONVERT(DATETIME,EMP.DORelieve) >='" + dtLeaveYear.ToString("dd MMM yyyy") + "' ) ";
                        }
                        else
                            this.sFilter += " AND ( CONVERT(DATETIME,EMP.DOJ) <='" + BaseService.SessionManager.PayrollMonthEnd.ToString("dd MMM yyyy") + "' AND CONVERT(DATETIME,EMP.DORelieve) >='" + BaseService.SessionManager.PayrollMonthStart.ToString("dd MMM yyyy") + "' ) ";

                        var ALfld1 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                        if (ALfld1 && ALfld1 instanceof PactComboBoxData && Util.IsEmpty(ALfld1.SelectedValue) && iLeaveYear > 0) {
                            let strALPrefDate = new Date(parseInt((ALfld1 as PactComboBoxData).SelectedValue), iLeaveYear, 1);

                            let ALfld2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                            if (ALfld2 && ALfld2 instanceof PactExtraFieldDateData)
                                ALfld2.Date = Util.ParseDate(strALPrefDate.ToString("dd/MMM/yyyy"));

                            strALPrefDate = strALPrefDate.AddMonths(12);
                            strALPrefDate = strALPrefDate.AddDays(-(strALPrefDate.getDate()));
                            ALfld2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                            if (ALfld2 && ALfld2 instanceof PactExtraFieldDateData)
                                ALfld2.Date = Util.ParseDate(strALPrefDate.ToString("dd/MMM/yyyy"));
                        }
                    }
                    else {
                        let ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                        if (ALfld && ALfld instanceof PactComboBoxData && !Util.IsEmpty(ALfld.SelectedValue)) {

                            let dtLeaveYear = new Date(parseInt((ALfld as PactComboBoxData).SelectedValue), parseInt(BaseService.SessionManager.Preferences["LeaveYear"]), 1);

                            this.sFilter += " AND ( CONVERT(DATETIME,EMP.DOJ) <='" + dtLeaveYear.ToString("dd MMM yyyy") + "' AND CONVERT(DATETIME,EMP.DORelieve) >='" + dtLeaveYear.ToString("dd MMM yyyy") + "' ) ";
                        }
                        else
                            this.sFilter += " AND ( CONVERT(DATETIME,EMP.DOJ) <='" + BaseService.SessionManager.PayrollMonthEnd.ToString("dd MMM yyyy") + "' AND CONVERT(DATETIME,EMP.DORelieve) >='" + BaseService.SessionManager.PayrollMonthStart.ToString("dd MMM yyyy") + "' ) ";
                    }
                }
                else
                    this.sFilter += " AND ( CONVERT(DATETIME,EMP.DOJ) <='" + BaseService.SessionManager.PayrollMonthEnd.ToString("dd MMM yyyy") + "' AND CONVERT(DATETIME,EMP.DORelieve) >='" + BaseService.SessionManager.PayrollMonthStart.ToString("dd MMM yyyy") + "' ) ";

                if (BaseService.SessionManager.Preferences.ContainsKey("NPDontAllowPayrollProcessing") && BaseService.SessionManager.Preferences["NPDontAllowPayrollProcessing"] == "True") {
                    this.sFilter += " AND EmpSeqNo NOT IN ( Select NodeID From COM_CC50051 WITH(NOLOCK) Where ResignStatus='Posted' AND DateDiff(day,ISNULL(CONVERT(DATETIME,DORelieve),'01-Jan-9000'),'" + BaseService.SessionManager.PayrollMonthStart.ToString("dd MMM yyyy")
                        + "')<=0 AND DateDiff(day,CONVERT(DATETIME,CONVERT(DATETIME,('01-'+CONVERT(NVARCHAR(3),DATENAME(MONTH,ISNULL(CONVERT(DATETIME,DOResign),'01-Jan-9000')))+'-'+CONVERT(NVARCHAR,YEAR(ISNULL(CONVERT(DATETIME,DOResign),'01-Jan-9000'))))) ),'" + BaseService.SessionManager.PayrollMonthStart.ToString("dd MMM yyyy") + "')>=0 )";
                }
                if (BaseService.SessionManager.LocationID > 0 && BaseService.SessionManager.Preferences.ContainsKey("LocationWiseDimension") && BaseService.SessionManager.Preferences["LocationWiseDimension"].split(',').Contains("50051"))
                    this.sFilter += " AND EmpSeqNo IN ( Select NodeID From Com_CCCCData with(nolock) where CostCenterID=50051 and CCNID2=" + BaseService.SessionManager.LocationID + ")";

                if (!Util.IsEmpty(BaseService.SessionManager.sWHEmpFilteredEmpSeqNos))
                    this.sFilter += "  AND EmpSeqNo IN (" + BaseService.SessionManager.sWHEmpFilteredEmpSeqNos + ")";

                let ObjArray = [];
                ObjArray.push(BaseService.SessionManager.PayrollMonthEnd.ToString("dd MMM yyyy"));
                ObjArray.push(this.sFilter);
                ObjArray.push(0);
                ObjArray.push(BaseService.SessionManager.RoleID);
                ObjArray.push(BaseService.SessionManager.UserID);
                ObjArray.push(BaseService.SessionManager.LanguageID);

                this.dsData = BaseService.common.GetDataSet_SP(ObjArray, "spPAY_GetEmpMasterCCDetails");
                if (this.dsData.Tables.length > 0) {
                    if (this.dsData.Tables[0].length > 0) {
                        for (let i = 0; i < this.dsData.Tables[0].length; i++) {
                            this.sNodes = this.sNodes + this.dsData.Tables[0][i]["EmpSeqNo"].toString() + ",";
                        }

                        if (this.sNodes != "") {
                            this.sNodes = this.sNodes.substr(0, this.sNodes.length - 1)//this.sNodes.Remove(this.sNodes.length - 1, 1);
                            this.strWhere = " ( a.NodeId IN (" + this.sNodes + "))";
                        }
                    }
                    else {
                        this.strWhere = " ( a.NodeId = 0)";
                    }
                }
            }
            else {
                if (this.ScreenObject.DocumentType == 81) {
                    let isFound: boolean = false;
                    isFound = this.Leaveyear("");

                    if (isFound)
                        return this.strWhere = "Different LeaveYear";

                    this.strWhere = "";
                }
                else {
                    if (this.oEmpFilter.Filter > 0)
                        this.strWhere = this.FilterEmployees();
                }
            }
        }
        else if (this.ScreenObject.DocumentType == 81) {
            if (BaseService.SessionManager.Preferences.ContainsKey("ConsiderGlobalPreferencesBasedOnGrade") && BaseService.SessionManager.Preferences["ConsiderGlobalPreferencesBasedOnGrade"] == "True") {
                let isFound: boolean = false;
                isFound = this.Leaveyear("");

                if (isFound)
                    return this.strWhere = "Different LeaveYear";

            }
        }
        return ''
    }

    Leaveyear(sFilter: string): boolean {
        let bisD: boolean = false;
        if (sFilter != null && sFilter != "") {
            let sf: string = sFilter;

            if (sf.Contains("AND CCNID53"))
                sf = sf.Replace("AND CCNID53", "NodeID");

            let dsa: any = BaseService.common.GetDataSet("PAY119", sf);

            if (dsa != null && dsa.Tables.length > 0 && dsa.Tables[0].length > 0) {
                for (let i = 0; i < dsa.Tables[0].length; i++) {
                    for (let j = 0; j < dsa.Tables[0].length; j++) {
                        if (i == j)
                            continue;

                        if (dsa.Tables[0][i]["Value"].toString() != dsa.Tables[0][j]["Value"].toString()) {
                            bisD = true;
                            return bisD;
                        }
                    }
                }
            }

        }
        else {
            if (this.dtPayLeaveYear != null && this.dtPayLeaveYear.length > 0) {
                for (let i = 0; i < this.dtPayLeaveYear.length; i++) {
                    for (let j = 0; j < this.dtPayLeaveYear.length; j++) {
                        if (i == j)
                            continue;

                        if (this.dtPayLeaveYear[i]["Value"].toString() != this.dtPayLeaveYear[j]["Value"].toString()) {
                            bisD = true;
                            return bisD;
                        }
                    }
                }
            }
        }
        return bisD;
    }

    DailyAttendanceFilterTemp() {
        this.strEmpFilter = this.strWhere;
        let DimEmpfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
        if (DimEmpfld && DimEmpfld instanceof PactListBoxData)
            DimEmpfld.CustomWhere = this.strEmpFilter;
        else if (DimEmpfld && DimEmpfld instanceof PactCodeNameListBoxData)
            DimEmpfld.Code.CustomWhere = DimEmpfld.Name.CustomWhere = this.strEmpFilter;
        else {
            DimEmpfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
            if (DimEmpfld && DimEmpfld instanceof PactListBoxData && DimEmpfld.CCID == 50051)
                DimEmpfld.CustomWhere = this.strEmpFilter;
            else if (DimEmpfld && DimEmpfld instanceof PactCodeNameListBoxData && DimEmpfld.CCID == 50051)
                DimEmpfld.Name.CustomWhere = DimEmpfld.Code.CustomWhere = this.strEmpFilter;
            else {
                //let DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50051);
                //if (DimEmpBodyfld && DimEmpBodyfld instanceof DgColumn)
                //    DimEmpBodyfld.FilterCondition = strEmpFilter;

                let DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50051 && a.DisplayMember == "dcCCNID51");
                if (DimEmpBodyfld && DimEmpBodyfld instanceof DgColumn)
                    DimEmpBodyfld.FilterCondition = this.strEmpFilter;

                if (this.ScreenObject.GridDataColumns.Contains("dcCCNID51Code")) {
                    DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcccnid51code");
                    if (DimEmpBodyfld && DimEmpBodyfld instanceof DgColumn)
                        DimEmpBodyfld.FilterCondition = this.strEmpFilter;
                }

            }
        }
        this.ScreenObject.ColumnSource.sort((a, b) => a.DisplayIndex - b.DisplayIndex);
        this.ScreenObject.GridDataObj.RefreshColumns();
    }
    LoadGradeDataTemp(strWhr: string, TypeSplit: string) {
        let Type = TypeSplit.split('~')[0];
        let FromDate = Util.ParseDate(TypeSplit.split('~')[1])
        let AssingLeavesDt;
        AssingLeavesDt = [];
        let dtALMain = [];
        let ObjArray = [];
        let dsData;

        let DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50051);
        let DimGrdBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50053);

        if (BaseService.SessionManager.Preferences.ContainsKey("AssignLeavesFilter") && BaseService.SessionManager.Preferences["AssignLeavesFilter"].toString() == "True") {
            if (strWhr != null && strWhr.length > 0 && strWhr.toString() == "Different LeaveYear") {
                this.DisplayMessage = "Selected Grades have Different LeaveYear";
                this.MessageVisibility = true;
                return;
            }
        }

        if (strWhr.trim().length == 0)
            strWhr = " 1=1 ";

        if (BaseService.SessionManager.LocationID > 0 && BaseService.SessionManager.Preferences.ContainsKey("LocationWiseDimension") && BaseService.SessionManager.Preferences["LocationWiseDimension"].split(',').Contains("50051"))
            strWhr += " AND a.NodeID IN ( Select 1 as NodeID UNION ALL Select NodeID From Com_CCCCData with(nolock) where CostCenterID=50051 and CCNID2=" + BaseService.SessionManager.LocationID + ")";

        //if (this.ScreenObject.LocationID > 0 && BaseService.SessionManager.Preferences.ContainsKey("LocationWiseDimension") && BaseService.SessionManager.Preferences["LocationWiseDimension"].split(',').Contains("50051"))
        //    strWhr += @" AND a.NodeID IN ( Select 1 as NodeID UNION ALL Select NodeID From Com_CCCCData with(nolock) where CostCenterID=50051 and CCNID2=" + this.ScreenObject.LocationID + ")";

        if (!Util.IsEmpty(BaseService.SessionManager.sWHEmpFilteredEmpSeqNos))
            strWhr += " AND ( a.NodeID IN (" + BaseService.SessionManager.sWHEmpFilteredEmpSeqNos + "))";

        ObjArray.push("GradeWise");
        ObjArray.push(strWhr);
        ObjArray.push(Util.ParseDate(FromDate.ToString("dd/MMM/yyyy")));
        ObjArray.push(BaseService.SessionManager.UserID);
        ObjArray.push(BaseService.SessionManager.LanguageID);
        dsData = BaseService.empService.GetAssignLeaves(ObjArray);

        if (dsData != null && dsData.Tables.length > 0 && dsData.Tables[0].length > 0 && !dsData.Columns[0].Contains("ErrorMessage")) {
            let AssingLeavesDtTable = dsData.Tables[0];
            for (let c = 0; c < this.ScreenObject._CCFields.length; c++) {
                let cc = this.ScreenObject._CCFields[c] as PactListBoxData;
                if (cc instanceof PactListBoxData && cc.CCID == 50002) {
                    if (cc.SelectedValue > 0) {
                        dtALMain = dsData.Tables[0];
                        AssingLeavesDtTable = dtALMain.filter(x => x.Location == 0 || x.Location == cc.SelectedValue);
                        break;
                    }
                }
            }
            AssingLeavesDt = AssingLeavesDtTable;
            if (Type == "GradeWise") {
                if (DimEmpBodyfld && DimEmpBodyfld instanceof DgColumn) {
                    DimEmpBodyfld.IsVisible = false;
                }
                if (DimGrdBodyfld && DimGrdBodyfld instanceof DgColumn) {
                    DimGrdBodyfld.IsVisible = true;
                }

                AssingLeavesDt = AssingLeavesDtTable.filter(x => x.dcCCNID51_Key != 1);//Employee list
                AssingLeavesDt.sort((a, b) => a.dcCCNID51_Key > b.dcCCNID51_Key ? 1 : (a.dcCCNID51_Key == b.dcCCNID51_Key ? (a.dcCCNID52_Key > b.dcCCNID52_Key ? 1 : -1) : -1));
                this.dtData = AssingLeavesDt.Copy();

                AssingLeavesDt = AssingLeavesDtTable.filter(x => x.dcCCNID51_Key == 1);//Grade list
                AssingLeavesDt.sort((a, b) => a.dcCCNID53_Key > b.dcCCNID53_Key ? 1 : (a.dcCCNID53_Key == b.dcCCNID53_Key ? (a.dcCCNID52_Key > b.dcCCNID52_Key ? 1 : -1) : -1));
                AssingLeavesDt = AssingLeavesDt.Copy();
            }
            else if (Type == "EmployeeWise") {
                if (DimEmpBodyfld && DimEmpBodyfld instanceof DgColumn) {
                    DimEmpBodyfld.IsVisible = true;
                }
                if (DimGrdBodyfld && DimGrdBodyfld instanceof DgColumn) {
                    DimGrdBodyfld.IsVisible = false;
                }

                AssingLeavesDt = AssingLeavesDtTable.filter(x => x.dcCCNID51_Key == 1);//Grade list
                AssingLeavesDt.sort((a, b) => (a.dcCCNID53_Key > b.dcCCNID53_Key) ? 1 : (a.dcCCNID53_Key == b.dcCCNID53_Key) ? ((a.dcCCNID52_Key > b.dcCCNID52_Key) ? 1 : -1) : -1)
                this.dtData = AssingLeavesDt.Copy();

                AssingLeavesDt = AssingLeavesDtTable.filter(x => x.dcCCNID51_Key != 1);//Employee list
                AssingLeavesDt.sort((a, b) => (a.dcCCNID51_Key > b.dcCCNID51_Key) ? 1 : (a.dcCCNID51_Key == b.dcCCNID51_Key) ? ((a.dcCCNID52_Key > b.dcCCNID52_Key) ? 1 : -1) : -1)
                AssingLeavesDt = AssingLeavesDt.Copy();
            }

            this.ScreenObject.GridDataObj.Clear();
            this.ScreenObject.GridDataObj.ClearFilters();
            if (AssingLeavesDt.length > 0) {
                for (let i = 0; i < AssingLeavesDt.length; i++) {
                    let drGrid = this.ScreenObject.GridDataObj.NewRow();
                    this.ScreenObject.GridData.InsertAt(drGrid, i);
                    drGrid["ProductID_Key"] = parseInt(BaseService.SessionManager.Preferences["PayrollProduct"]);
                    drGrid["dcCCNID51_Key"] = AssingLeavesDt[i]["dcCCNID51_Key"].toString();
                    drGrid["dcCCNID52_Key"] = AssingLeavesDt[i]["dcCCNID52_Key"].toString();
                    drGrid["dcCCNID53_Key"] = AssingLeavesDt[i]["dcCCNID53_Key"].toString();
                    drGrid["dcNum3"] = 0;
                }
                //this.ScreenObject.GridDataObj.refreshDataView();
            }
            else {
                for (let i = 0; i < 12; i++) {
                    let drnew = this.ScreenObject.GridDataObj.NewRow();
                    drnew["DocSeqNo"] = this.ScreenObject.GridData.length + 1;
                    drnew["DocDetailsID"] = 0;
                    this.ScreenObject.GridData.push(drnew);
                }
            }
            Logger.InfoLog("AssignLeavesViewModel::End Binding Grade data to grid");
        }
        this.ScreenObject.GridDataObj.refreshDataView();
        this.ScreenObject.UpdateSequence();
        this.RefreshGrid = true;
        this.ScreenObject.GridDataObj.RefreshColumns();
    }
    PopupEmpFilterCallBack(CallBackType: string, Type: string) {
        if (CallBackType == "DailyAttendanceFilter") {
            this.DailyAttendanceFilterTemp();
        }
        else if (CallBackType == "SetNewDocFields") {
            let strWhr = this.strEmpFilter = this.strWhere;
            if (Util.IsEmpty(strWhr))
                strWhr = this.FilterEmployees();

            this.SetNewDocFieldsTemp(strWhr)
        }
        else if (CallBackType == "LoadGradeData") {
            let strWhr = this.strEmpFilter = this.strWhere;
            this.LoadGradeDataTemp(strWhr, Type);
        }
    }
    static GetTagTableName(CostCenterID: number): string {
        if (CostCenterID == 2)
            return "ACC_Accounts";
        else if (CostCenterID == 3)
            return "INV_Product";
        else if (CostCenterID == 7)
            return "ADM_Users";
        else if (CostCenterID == 50001)
            return "COM_Division";
        else if (CostCenterID == 50002)
            return "COM_Location";
        else if (CostCenterID == 50003)
            return "COM_Branch";
        else if (CostCenterID == 50004)
            return "COM_Department";
        else if (CostCenterID == 50005)
            return "COM_Salesman";
        else if (CostCenterID == 50006)
            return "COM_Category";
        else if (CostCenterID == 50007)
            return "COM_Area";
        else if (CostCenterID == 50008)
            return "COM_Teritory";
        else
            return "COM_CC" + CostCenterID;
    }

    IsLeaveTypeValid(EmpNode: number, LeaveType: number, drw: any, outObjValid: any): string {
        outObjValid.IfFormulaExistsNoOfDays = false;
        let strIsValid = '';
        this.strValidationMessage = '';
        try {
            let dsEmpData = null;
            let dvStructure;

            dsEmpData = this.ScreenObject.GetEmployeePayrollInfo(EmpNode, 0, this.DocumentDate, 0);

            if (dsEmpData.Tables.length > 0 && dsEmpData.Tables[1].length > 0) {


                dvStructure = dsEmpData.Tables[1].filter(x => x.Type == 4 && x.LeaveOthFeatures.Contains('%#REJOIN#%'));
                if (dvStructure.length > 0) {
                    for (let i = 0; i < dvStructure.length; i++) {
                        let dtC: any = BaseService.common.GetDataSet3("PAY010", EmpNode.toString(), dvStructure[i]["ComponentID"].toString(), this.ScreenObject.DocID.toString()).Tables[0];
                        if (dtC != null && dtC.length > 0) {
                            this.strValidationMessage = "Please enter Rejoining date of this Employee to the Leave Type : " + dvStructure[i]["ComponentName"].toString();
                            return this.strValidationMessage;
                        }
                    }
                }

                if (this.DocumentType == 62) {
                    let oEvalPayFormulas: any = new EvaluatePayrollFormulas();
                    oEvalPayFormulas.sEmpSeqNo = EmpNode.toString();
                    let refObj = { PayrollMonth: oEvalPayFormulas.PayrollMonth, PayrollMonthStart: oEvalPayFormulas.PayrollMonthStart, PayrollMonthEnd: oEvalPayFormulas.PayrollMonthEnd }
                    Util.SetPayrollDate(this.DocumentDate, refObj);
                    oEvalPayFormulas.PayrollMonth = refObj.PayrollMonth
                    oEvalPayFormulas.PayrollMonthStart = refObj.PayrollMonthStart
                    oEvalPayFormulas.PayrollMonthEnd = refObj.PayrollMonthEnd
                    oEvalPayFormulas.arrLstCPFields[6].Clear();

                    let dvStructureData = dsEmpData.Tables[2].filter(x => x.Type == 4 && Util.String(x.formula) != '' && x.ComponentID == LeaveType);
                    let dvStructure = dsEmpData.Tables[1].filter(x => x.Type == 4 && x.formula != '' && x.ComponentID == LeaveType);
                    let oCPF = new CPFields();

                    if (dvStructure.length > 0) {
                        for (let i = 0; i < dvStructure.length; i++) {
                            oCPF.ComponentName = dvStructure[i]["LeaveErrorMessage"].toString();
                            oCPF.SNo = parseInt(dvStructure[i]["SNo"].toString());
                            oCPF.Formula = dvStructure[i]["Formula"].toString();
                            oEvalPayFormulas.arrLstCPFields[6].push(oCPF);
                        }
                        oEvalPayFormulas.Intialize();
                        oEvalPayFormulas.ExecuteAllFormulas();

                        let dtLFDate = this.DocumentDate;
                        if (oEvalPayFormulas.fldDict.ContainsKey("LeaveFromDate")) {
                            if (!Util.IsEmpty(drw["dcAlpha4_Key"])) {
                                oEvalPayFormulas.fldDict["LeaveFromDate"].setFieldValue(Util.ParseDate(drw["dcAlpha4_Key"]));
                                dtLFDate = Util.ParseDate(drw["dcAlpha4_Key"]);
                            }
                            else {
                                oEvalPayFormulas.fldDict["LeaveFromDate"].setFieldValue(this.DocumentDate);
                            }
                        }

                        if (oEvalPayFormulas.fldDict.ContainsKey("LeaveNoOfDays")) {
                            if (!Util.IsEmpty(drw["dcAlpha7"]))
                                oEvalPayFormulas.fldDict["LeaveNoOfDays"].setFieldValue(drw["dcAlpha7"].toString());
                            else
                                oEvalPayFormulas.fldDict["LeaveNoOfDays"].setFieldValue(0);
                        }

                        let temp1 = oEvalPayFormulas.fldDict;
                        for (let l = 0; l < oEvalPayFormulas.arrLstCPFields[6].length; l++) {
                            for (let j = 0; j < oEvalPayFormulas.arrLstCPFields[5].length; j++) {
                                if (oEvalPayFormulas.arrLstCPFields[6][l].Formula != null &&
                                    oEvalPayFormulas.arrLstCPFields[6][l].Formula.Contains(oEvalPayFormulas.arrLstCPFields[5][j].ComponentName + "_Bal") &&
                                    oEvalPayFormulas.fldDict.ContainsKey(oEvalPayFormulas.arrLstCPFields[5][j].ComponentName + "_Bal")
                                ) {
                                    let dtL: any[] = BaseService.common.GetDataSet3("PAY044", oEvalPayFormulas.sEmpSeqNo.toString(), oEvalPayFormulas.arrLstCPFields[5][j].ComponentID, dtLFDate.ToString("dd/MMM/yyyy"));
                                    if (dtL != null && dtL.length > 0) {
                                        oEvalPayFormulas.fldDict[oEvalPayFormulas.arrLstCPFields[5][j].ComponentName + "_Bal"].setFieldValue(dtL[0]["AvailableLeaves"].toString());
                                    }
                                }

                            }
                            if (oEvalPayFormulas.arrLstCPFields[6][l].Formula != null && (oEvalPayFormulas.arrLstCPFields[6][l].Formula.Contains("LeaveFromDate") || oEvalPayFormulas.arrLstCPFields[6][l].Formula.Contains("LeaveNoOfDays")))
                                outObjValid.IfFormulaExistsNoOfDays = true;

                            strIsValid = Util.String(BaseService.eval.EvaluateExpression(oEvalPayFormulas.arrLstCPFields[6][l].Formula.toString(), temp1));
                            if (strIsValid == "0")
                                this.strValidationMessage = oEvalPayFormulas.arrLstCPFields[6][l].ComponentName.toString();
                            break;
                        }
                    }
                    else
                        this.strValidationMessage = "";
                }
            }
            else
                this.strValidationMessage = "Please check the payroll structure";

            Logger.InfoLog("AddEditDocumentViewModel::Exiting IsLeaveTypeValid()");
        }
        catch (error) {
            Logger.ErrorLog("AddEditDocumentViewModel::EXCEPTION IsLeaveTypeValid()" + error.stack);
        }
        return this.strValidationMessage;
    }

    IsDateValid(datarow: any, strBindingPath: string): string {
        try {
            Logger.InfoLog("AddEditDocumentViewModel::Entering IsDateValid()");
            let dsEmpData = null;
            let EmpID = 0;
            let dtDate = Date.Today();
            this.strValidationMessage = '';

            var DimEmpfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (DimEmpfld && DimEmpfld instanceof PactListBoxData)
                EmpID = DimEmpfld.SelectedValue;
            else if (DimEmpfld && DimEmpfld instanceof PactCodeNameListBoxData)
                EmpID = DimEmpfld.SelectedValue;
            else {
                DimEmpfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
                if (DimEmpfld && DimEmpfld instanceof PactListBoxData && DimEmpfld.CCID == 50051)
                    EmpID = DimEmpfld.SelectedValue;
                else if (DimEmpfld && DimEmpfld instanceof PactCodeNameListBoxData && DimEmpfld.CCID == 50051)
                    EmpID = DimEmpfld.SelectedValue;
                else {
                    var DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50051);
                    if (DimEmpBodyfld instanceof DgColumn && !Util.IsEmpty(datarow[DimEmpBodyfld.ValueMember]))
                        EmpID = parseInt(datarow[DimEmpBodyfld.ValueMember]);
                }
            }

            let strDateColumnName = '';
            if (this.ScreenObject.CostCenterID == 40055 && strBindingPath.toLowerCase() == "dcalpha1" && !Util.IsEmpty(datarow["dcAlpha1"]))
                strDateColumnName = "dcalpha1";
            else if (this.ScreenObject.CostCenterID == 40056)
                strDateColumnName = "dcalpha5";
            else if (this.ScreenObject.CostCenterID == 40057 && strBindingPath.toLowerCase() == "dcalpha5" && !Util.IsEmpty(datarow["dcAlpha5"]))
                strDateColumnName = "dcalpha5";
            else if (this.ScreenObject.CostCenterID == 40057 && strBindingPath.toLowerCase() == "dcalpha4" && !Util.IsEmpty(datarow["dcAlpha4"]))
                strDateColumnName = "dcalpha4";
            else if (this.ScreenObject.CostCenterID == 40069)
                strDateColumnName = strBindingPath.toLowerCase();

            DimEmpfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == strDateColumnName);
            if (DimEmpfld instanceof PactExtraFieldDateData)
                dtDate = Util.ParseDate(DimEmpfld.Date);
            else {
                var DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == strDateColumnName);
                if (DimEmpBodyfld instanceof DgColumn)
                    dtDate = Util.ParseDate(datarow[DimEmpBodyfld.DisplayMember + "_key"]);
            }

            dsEmpData = this.ScreenObject.GetEmployeePayrollInfo(EmpID, 3, dtDate, 0);

            if (dsEmpData.Tables.length > 0 && dsEmpData.Tables[0].length > 0)
                this.strValidationMessage = Util.String(dsEmpData.Tables[0][0][0]);

            Logger.InfoLog("AddEditDocumentViewModel::Exiting IsDateValid()");
        }
        catch (error) {
            Logger.ErrorLog("AddEditDocumentViewModel::EXCEPTION IsDateValid()" + error.stack);
        }
        return this.strValidationMessage;
    }

    IsDocumentLocked(datarow: any, CostCenterID: number, strBindingPath: string): string {
        try {
            let EmpID = 0;
            let dtDate = Date.Today();
            this.strValidationMessage = '';

            var DimEmpfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (DimEmpfld && DimEmpfld instanceof PactListBoxData)
                EmpID = DimEmpfld.SelectedValue;
            else if (DimEmpfld && DimEmpfld instanceof PactCodeNameListBoxData)
                EmpID = DimEmpfld.SelectedValue;
            else {
                DimEmpfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha5");
                if (DimEmpfld && DimEmpfld instanceof PactListBoxData && DimEmpfld.CCID == 50051)
                    EmpID = DimEmpfld.SelectedValue;
                else if (DimEmpfld && DimEmpfld instanceof PactCodeNameListBoxData && DimEmpfld.CCID == 50051)
                    EmpID = DimEmpfld.SelectedValue;
                else {
                    var DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50051);
                    if (DimEmpBodyfld != null && DimEmpBodyfld instanceof DgColumn)
                        EmpID = parseInt(datarow[DimEmpBodyfld.ValueMember]);
                }
            }

            DimEmpfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
            if (DimEmpfld instanceof PactExtraFieldDateData)
                dtDate = Util.ParseDate(DimEmpfld.Date);
            else {
                var DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                if (DimEmpBodyfld != null && DimEmpBodyfld instanceof DgColumn) {
                    if (!Util.IsEmpty(datarow[DimEmpBodyfld.DisplayMember + "_key"]))
                        dtDate = Util.ParseDate(datarow[DimEmpBodyfld.DisplayMember + "_key"]);
                    else
                        dtDate = Date.Today();
                }
            }

            this.dsData = this.ScreenObject.GetEmpDimensionDetails(EmpID, CostCenterID, dtDate);
            if (this.dsData.Tables.length > 0) {
                if (this.dsData.Tables[0].length > 0) {
                    this.strValidationMessage = "Payroll Month Locked";
                    datarow["dcAlpha2"] = datarow["dcAlpha2_Key"] = datarow["dcAlpha3"] = datarow["dcAlpha3_Key"] = "";
                    for (let i = 1; i < 16; i++) {
                        datarow["dcNum" + i] = 0;
                    }
                    this.ScreenObject.GridDataObj.updateRow(datarow);
                }
            }
            Logger.InfoLog("AddEditDocumentViewModel::Exiting IsDocumentLocked()");
        }
        catch (error) {
            Logger.ErrorLog("AddEditDocumentViewModel::EXCEPTION IsDocumentLocked()" + error.stack);
        }
        return this.strValidationMessage;
    }

    //#region "Assign Leaves"
    OnYearSelected(sender: string) {
        try {
            Logger.InfoLog("AddEditDocumentViewModel::Entering OnYearSelected()");
            var ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
            if (ALfld != null && ALfld instanceof PactComboBoxData && !Util.IsEmpty(ALfld.SelectedValue)) {
                this.LoadLeaveyearDates(parseInt(ALfld.SelectedValue));

                ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                if (ALfld != null && ALfld instanceof PactExtraFieldDateData && ALfld.Date) {
                    var ALfld1 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                    if (ALfld1 != null && ALfld1 instanceof PactComboBoxData && !Util.IsEmpty(ALfld1.SelectedValue)) {
                        if (this.IsNewAssignLeave)
                            this.LoadGradeDataNew(0, Util.ParseDate(ALfld.Date), ALfld1.SelectedValue.toString(), null);
                        else
                            this.LoadGradeData(0, Util.ParseDate(ALfld.Date), ALfld1.SelectedValue.toString());
                    }
                }
            }
            Logger.InfoLog("AddEditDocumentViewModel::Exiting OnYearSelected()");
        }
        catch (error) {
            Logger.ErrorLog("AddEditDocumentViewModel::EXCEPTION OnYearSelected()" + error.stack);
        }
    }

    LeavesBasedon(sender: string) {
        let strBasedon = '';
        var DimLTfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
        if (DimLTfld != null && DimLTfld instanceof PactComboBoxData && !Util.IsEmpty(DimLTfld.SelectedValue))
            strBasedon = DimLTfld.SelectedValue;

        if (!Util.IsEmpty(strBasedon)) {
            var ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
            if (ALfld != null && ALfld instanceof PactExtraFieldDateData && ALfld.Date) {
                if (this.IsNewAssignLeave)
                    this.LoadGradeDataNew(this.DocID > 0 ? 1 : 0, Util.ParseDate(ALfld.Date), strBasedon, null);
                else
                    this.LoadGradeData(this.DocID > 0 ? 1 : 0, Util.ParseDate(ALfld.Date), strBasedon);
            }
            else {
                if (this.IsNewAssignLeave)
                    this.LoadGradeDataNew(this.DocID > 0 ? 1 : 0, new Date(), strBasedon, null);
                else
                    this.LoadGradeData(this.DocID > 0 ? 1 : 0, new Date(), strBasedon);
            }
        }
    }
    //#endregion


    //#region New Assign Leaves
    IsNewAssignLeave = false;
    dtALeaveComp = [];//new DataTable();
    public FillComponent(dtcomp: any) {
        for (let i = this.ScreenObject.ColumnSource.length - 1; i >= 0; i--) {
            if (this.ScreenObject.ColumnSource[i].DisplayMember != null && this.ScreenObject.ColumnSource[i].DisplayMember != "" && (this.ScreenObject.ColumnSource[i].DisplayMember == "dcCCNID52" || this.ScreenObject.ColumnSource[i].DrRefColName == "LeaveComp")) {
                if (this.ScreenObject.ColumnSource[i].DisplayMember == "dcCCNID52") {
                    if (this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.ColumnSource[i].DisplayMember))
                        this.ScreenObject.GridDataColumns.Remove(this.ScreenObject.ColumnSource[i].DisplayMember);
                    if (this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.ColumnSource[i].DisplayMember + "_Key"))
                        this.ScreenObject.GridDataColumns.Remove(this.ScreenObject.ColumnSource[i].DisplayMember + "_Key");
                }
                else {
                    if (this.ScreenObject.GridDataColumns.Contains(this.ScreenObject.ColumnSource[i].DisplayMember))
                        this.ScreenObject.GridDataColumns.Remove(this.ScreenObject.ColumnSource[i].DisplayMember);
                }
                this.ScreenObject.ColumnSource.RemoveAt(i);
            }

        }

        let iRemColIndex = -1;
        let ALeaveCols = [];//new ObservableCollection<DgColumn>();
        for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
            if (this.ScreenObject.ColumnSource[i].DisplayMember == "LineNarration") {
                iRemColIndex = i;
                this.ScreenObject.ColumnSource[i].Width = 150;
            }

            if ((this.ScreenObject.ColumnSource[i].DrRefColName == null || this.ScreenObject.ColumnSource[i].DrRefColName == "") && this.ScreenObject.ColumnSource[i].DrRefColName != "LeaveComp")
                ALeaveCols.push(this.ScreenObject.ColumnSource[i]);
        }

        if (iRemColIndex < 0)
            iRemColIndex = ALeaveCols.length;

        let dgCol: DgColumn = null;


        for (let i = 0; i < dtcomp.length; i++) {
            dgCol = new DgColumn();
            dgCol.Header = dtcomp[i]["Name"].toString();
            dgCol.DisplayMember = "dcNum" + dtcomp[i]["SNo"].toString();
            dgCol.ID = dtcomp[i]["SNo"].toString();
            dgCol.DrRefColName = "LeaveComp";
            dgCol.DataType = "FLOAT";
            //dgCol.CostCenterID = 0;
            //dgCol.ShowTotal = true;
            dgCol.IsCalculated = 1;
            dgCol.IsColumnUserDefined = true;
            //dgCol.DecimalPoints = "1";
            //dgCol.DefaultValue = "0.0";
            dgCol.Width = 90;

            if (!this.ScreenObject.GridDataColumns.Contains(dgCol.DisplayMember))
                this.ScreenObject.GridDataColumns.push(dgCol.DisplayMember);
            if (!this.ScreenObject.GridDataColumns.Contains("dcCalc" + dgCol.DisplayMember))
                this.ScreenObject.GridDataColumns.push("dcCalc" + dgCol.DisplayMember);
            if (!this.ScreenObject.GridDataColumns.Contains("default" + dgCol.DisplayMember))
                this.ScreenObject.GridDataColumns.push("default" + dgCol.DisplayMember);

            ALeaveCols.Insert(iRemColIndex, dgCol);
            iRemColIndex++;
        }

        this.ScreenObject.ColumnSource = ALeaveCols;
        //OnPropertyChanged("ColumnSource");
    }

    public LoadGradeDataNew(Flag: number, FromDate: Date, Type: string, ds: any) {
        let AssingLeavesDt: any;
        let strWhr = '';
        if (Flag == 0 || Flag == 2)//New
        {
            AssingLeavesDt = [];//new DataTable();
            let dtALMain = [];//new DataTable();
            this.dtData = null;
            if (this.ScreenObject == null)
                return;

            if (this.DocID > 0)
                return;

            if (Type.toString() == "")
                return;

            Logger.InfoLog("AssignLeavesViewModel::Start Loading Grade data");
            let ObjArray = [];
            this.dsData = [];//new DataSet();

            let DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50051);
            let DimGrdBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50053);

            if (BaseService.SessionManager.Preferences.ContainsKey("AssignLeavesFilter") && BaseService.SessionManager.Preferences["AssignLeavesFilter"].toString() == "True") {
                strWhr = this.PopupEmployeesFilter(Type);
            }

            if (strWhr.Trim().length == 0)
                strWhr = " 1=1 ";

            if (BaseService.SessionManager.LocationID > 0 && BaseService.SessionManager.Preferences.ContainsKey("LocationWiseDimension") && BaseService.SessionManager.Preferences["LocationWiseDimension"].split(',').Contains("50051"))
                strWhr += " AND a.NodeID IN ( Select 1 as NodeID UNION ALL Select NodeID From Com_CCCCData with(nolock) where CostCenterID=50051 and CCNID2=" + BaseService.SessionManager.LocationID + ")";

            //if (ScreenObject.LocationID > 0 && BaseService.SessionManager.Preferences.ContainsKey("LocationWiseDimension") && BaseService.SessionManager.Preferences["LocationWiseDimension"].split(',').Contains("50051"))
            //    strWhr += @" AND a.NodeID IN ( Select 1 as NodeID UNION ALL Select NodeID From Com_CCCCData with(nolock) where CostCenterID=50051 and CCNID2=" + ScreenObject.LocationID + ")";

            if (!Util.IsEmpty(BaseService.SessionManager.sWHEmpFilteredEmpSeqNos))
                strWhr += " AND ( a.NodeID IN (" + BaseService.SessionManager.sWHEmpFilteredEmpSeqNos + "))";

            ObjArray.push("GradeWise");
            ObjArray.push(strWhr);
            ObjArray.push(Util.ParseDate(FromDate.ToString("dd/MMM/yyyy")));
            ObjArray.push(BaseService.SessionManager.UserID);
            ObjArray.push(BaseService.SessionManager.LanguageID);

            this.dsData = BaseService.empService.GetAssignLeaves(ObjArray);
            Logger.InfoLog("AssignLeavesViewModel::End Loading Grade data");

            if (this.dsData != null && this.dsData.Tables.length > 0 && this.dsData.Tables[0].length > 0 && !this.dsData.Columns[0].Contains("ErrorMessage")) {
                Logger.InfoLog("AssignLeavesViewModel::Start Binding data to grid");
                let AssingLeavesDtTable = this.dsData.Tables[0];
                for (let c = 0; c < this.ScreenObject._CCFields.length; c++) {
                    let cc = this.ScreenObject._CCFields[c] as PactListBoxData;
                    if (cc instanceof PactListBoxData && cc.CCID == 50002) {
                        if (cc.SelectedValue > 0) {
                            dtALMain = this.dsData.Tables[0];
                            AssingLeavesDtTable = dtALMain.filter(x => x.Location == 0 || x.Location == cc.SelectedValue);
                            break;
                        }
                    }
                }

                //AssingLeavesDt.DefaultView.RowFilter = "";
                AssingLeavesDt = AssingLeavesDtTable;
                if (Type == "GradeWise") {
                    if (DimEmpBodyfld != null && DimEmpBodyfld instanceof DgColumn) {
                        DimEmpBodyfld.IsVisible = false;
                    }
                    if (DimGrdBodyfld != null && DimGrdBodyfld instanceof DgColumn) {
                        DimGrdBodyfld.IsVisible = true;
                    }

                    AssingLeavesDt = AssingLeavesDtTable.filter(x => x.dcCCNID51_Key != 1);//Employee list
                    AssingLeavesDt.sort((a, b) => a.dcCCNID51_Key - b.dcCCNID51_Key);
                    this.dtData = AssingLeavesDt.Copy();

                    AssingLeavesDt = AssingLeavesDtTable.filter(x => x.dcCCNID51_Key == 1);//Employee list
                    AssingLeavesDt.sort((a, b) => a.dcCCNID53_Key - b.dcCCNID53_Key);
                    AssingLeavesDt = AssingLeavesDt.ToTable(true, ["dcCCNID51_Key", "dcCCNID53_Key"]);
                }
                else if (Type == "EmployeeWise") {
                    if (DimEmpBodyfld != null && DimEmpBodyfld instanceof DgColumn) {
                        DimEmpBodyfld.IsVisible = true;
                    }
                    if (DimGrdBodyfld != null && DimGrdBodyfld instanceof DgColumn) {
                        DimGrdBodyfld.IsVisible = false;
                    }

                    AssingLeavesDt = AssingLeavesDtTable.filter(x => x.dcCCNID51_Key == 1);//Grade list
                    AssingLeavesDt.sort((a, b) => (a.dcCCNID53_Key - b.dcCCNID53_Key))
                    this.dtData = AssingLeavesDt.ToTable();

                    AssingLeavesDt = AssingLeavesDtTable.filter(x => x.dcCCNID51_Key != 1);//Employee list
                    AssingLeavesDt.sort((a, b) => (a.dcCCNID51_Key - b.dcCCNID51_Key))
                    AssingLeavesDt = AssingLeavesDt.ToTable(true, ["dcCCNID51_Key", "dcCCNID53_Key"]);
                }

                this.ScreenObject.GridDataObj.Clear();
                this.ScreenObject.GridDataObj.ClearFilters();//.DefaultView.RowFilter = '';
                if (AssingLeavesDt.length > 0) {
                    for (let i = 0; i < AssingLeavesDt.length; i++) {
                        let drGrid = this.ScreenObject.GridDataObj.NewRow();
                        this.ScreenObject.GridDataObj.insertRowAt(drGrid, i);
                        drGrid["ProductID_Key"] = parseInt(BaseService.SessionManager.Preferences["PayrollProduct"]);
                        drGrid["dcCCNID51_Key"] = AssingLeavesDt[i]["dcCCNID51_Key"].toString();
                        drGrid["dcCCNID53_Key"] = AssingLeavesDt[i]["dcCCNID53_Key"].toString();
                        for (let c = 0; c < this.ScreenObject.ColumnSource.length; c++) {
                            if (this.ScreenObject.ColumnSource[c].DrRefColName != null && this.ScreenObject.ColumnSource[c].DrRefColName != "" && this.ScreenObject.ColumnSource[c].DrRefColName.startsWith("LeaveComp")) {
                                drGrid[this.ScreenObject.ColumnSource[c].DisplayMember] = "0.0";
                            }
                        }
                        this.ScreenObject.GridDataObj.updateRow(drGrid);
                    }
                }
                else {
                    for (let i = 0; i < 12; i++) {
                        let drnew = this.ScreenObject.GridDataObj.NewRow();
                        drnew["DocSeqNo"] = this.ScreenObject.GridData.length + 1;
                        drnew["DocDetailsID"] = 0;
                        this.ScreenObject.GridDataObj.addRow(drnew);
                    }
                }
                Logger.InfoLog("AssignLeavesViewModel::End Binding Grade data to grid");
            }
            //this.ScreenObject.GridData.AcceptChanges();
            this.ScreenObject.UpdateSequence();
            this.RefreshGrid = true;
        }
        else if (Flag == 1)//Edit
        {
            if (Type.toString() == "")
                return;
            let AssingLeavesDt1 = [];//new DataTable();

            var ALfld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
            if (ALfld != null && ALfld instanceof PactComboBoxData)
                ALfld.IsReadOnly = true;

            ALfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid2");
            if (ALfld != null && ALfld instanceof PactListBoxData)
                ALfld.Enable = false;

            var DimEmpBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50051);
            var DimGrdBodyfld = this.ScreenObject.ColumnSource.find(a => a.CostCenterID == 50053);
            if (DimEmpBodyfld != null && DimEmpBodyfld instanceof DgColumn) {
                if (Type == "EmployeeWise") {
                    DimEmpBodyfld.IsVisible = true;
                    DimGrdBodyfld.IsVisible = false;
                }
                else {
                    DimGrdBodyfld.IsVisible = true;
                    DimEmpBodyfld.IsVisible = false;
                }
            }

            AssingLeavesDt1 = this.ScreenObject.GridData;
            if (this.dtData != null && this.dtData.length > 0)
                AssingLeavesDt1.AddRange(this.dtData);

            //AssingLeavesDt1.DefaultView.RowFilter = "";
            if (Type == "GradeWise") {
                AssingLeavesDt1 = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key != 1);//Employee list
                this.dtData = AssingLeavesDt1.Copy();

                AssingLeavesDt1 = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key == 1);//Grade list
                AssingLeavesDt1 = AssingLeavesDt1.Copy();
            }
            else if (Type == "EmployeeWise") {
                AssingLeavesDt1 = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key == 1);//Employee list
                this.dtData = AssingLeavesDt1.Copy();

                AssingLeavesDt1 = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key != 1);//Grade list
                AssingLeavesDt1 = AssingLeavesDt1.Copy();
            }
            if (AssingLeavesDt1.length > 0) {
                this.ScreenObject.GridDataObj.Clear();
                this.ScreenObject.GridDataObj.ClearFilters();
                this.ScreenObject.GridData.AddRange(AssingLeavesDt1);
                //this.ScreenObject.GridData.AcceptChanges();
            }
            this.ScreenObject.UpdateSequence();
            this.RefreshGrid = true;
        }
        let AssignLeavesCols = [];//new ObservableCollection<DgColumn>();
        for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
            AssignLeavesCols.push(this.ScreenObject.ColumnSource[i]);
        }
        this.ScreenObject.ColumnSource = AssignLeavesCols;
        //OnPropertyChanged("ColumnSource");
    }

    //#endregion


    CheckDocumentValidations(ValidationMessage: string): string {
        ValidationMessage = '';
        let IsValidDays = 0;
        let dblIsValidDays = 0;
        try {
            if (this.ScreenObject.DocumentType == 97) //Lates Processing
            {
                var fldROD = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha16");
                if (fldROD) {
                    if ((fldROD as PactExtraFieldDateData).Date.OnlyDate() != this.dtPayMon.OnlyDate()) {
                        ValidationMessage = "Payroll Month value changed, Filter and Process again.";
                        return ValidationMessage;
                    }
                }

                if (this.IsLatesProcessTimingsUpdated) {
                    return "Timings are updated, Filter and Process again.";
                }

                // Checking whether the Employee is Processed in Multiple Documents or Not?

                let sES = "", sVNos = "";
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (Util.IsEmpty(this.ScreenObject.GridData[k]["dcCCNID51_Key"]))
                        break;

                    if (sES.length > 0)
                        sES += ",";

                    sES += this.ScreenObject.GridData[k]["dcCCNID51_Key"].toString();
                }
                if (sES.Trim() == "") {
                    ValidationMessage = "No Employees found to Process.";
                    return ValidationMessage;
                }

                let dtChk: any[] = BaseService.common.GetDataSet3("PAY011", this.DocID.toString(), sES, (fldROD as PactExtraFieldDateData).Date.ToString("dd/MMM/yyyy")).Tables[0];
                if (dtChk != null && dtChk.length > 0) {
                    sES = sVNos = "";
                    for (let i = 0; i < dtChk.length; i++) {
                        sES += dtChk[i]["EmpCode"].toString() + ",";
                        if (!sVNos.Contains(dtChk[i]["VoucherNo"].toString() + ","))
                            sVNos += dtChk[i]["VoucherNo"].toString() + ",";
                    }
                    ValidationMessage += "Lates are already Processed to the Employee Codes : " + sES.Trim(',') + " in the Following Documents " + sVNos.Trim(',');
                    return ValidationMessage;
                }

                let fldROD1: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toString() == "dcAlpha33");
                if (fldROD1 != null) {
                    for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcCCNID51_Key"])) {
                            if (this.CheckIsPayrollProcessed(Util.ParseDate((fldROD as PactExtraFieldDateData).Date).ToString("dd/MMM/yyyy"), this.ScreenObject.GridData[k]["dcCCNID51_Key"].toString())) {
                                ValidationMessage += "Cannot save the record, Payroll processed for the Employee - " + this.ScreenObject.GridData[k]["dcCCNID51Code"].toString();
                                return ValidationMessage;
                            }
                        }
                    }
                }

            }
            else if (this.ScreenObject.DocumentType == 96) //Lates Configuration
            {
                let iEntCnt = 0;
                if (this.ScreenObject.GridData.length > 0) {
                    for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha2"])) {
                            iEntCnt++;
                            break;
                        }
                    }
                }
                if (iEntCnt == 0) {
                    ValidationMessage = "Enter atleast one row.";
                    return ValidationMessage;
                }

                let dtLT: any[] = BaseService.common.GetDataSet("PAY012", "").Tables[0];

                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha2"]) && !Util.IsEmpty(this.ScreenObject.GridData[k]["dcNum1"])) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha5"])) {
                            if (this.ScreenObject.GridData[k]["dcAlpha5"].toString() == "Leaves") {
                                var fldLT = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha6");
                                if (fldLT instanceof PactTextBoxData && fldLT.Text.Trim() == "") {
                                    ValidationMessage = "Enter Leave Types Deduction Order @ Header";
                                    return ValidationMessage;
                                }
                                else {
                                    let sLT = (fldLT as PactTextBoxData).Text.Trim();
                                    let strLT = sLT.split(';');
                                    let drcL;
                                    if (sLT.length > 0 && dtLT.length == 0) {
                                        ValidationMessage = "No Leave Types found. Define Leave Types at Customize Payroll";
                                        return ValidationMessage;
                                    }
                                    if (strLT != null && strLT.length > 0) {
                                        for (let l = 0; l < strLT.length; l++) {
                                            if (strLT[l] != null && strLT[l].Trim() != "") {
                                                drcL = dtLT.filter(x => x.ComponentName == strLT[l].Trim());
                                                if (drcL == null || drcL.length == 0) {
                                                    ValidationMessage = "Leave Type : " + strLT[l].Trim() + " not found. Check @ Leave Types Deduction Order";
                                                    return ValidationMessage;
                                                }
                                            }

                                        }
                                    }
                                }
                            }

                        }
                    }
                    if (Util.Int(this.ScreenObject.GridData[k]["dcNum3"]) > 0) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha9"])) {
                            if (this.ScreenObject.GridData[k]["dcAlpha9"].toString() == "Leaves") {
                                var fldLT = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha6");
                                if (fldLT && fldLT instanceof PactTextBoxData && fldLT.Text.Trim() == "") {
                                    ValidationMessage = "Enter Leave Types Deduction Order @ Header";
                                    return ValidationMessage;
                                }
                                else {
                                    let sLT = (fldLT as PactTextBoxData).Text.Trim();
                                    let strLT = sLT.split(';');
                                    let drcL;
                                    if (sLT.length > 0 && dtLT.length == 0) {
                                        ValidationMessage = "No Leave Types found. Define Leave Types at Customize Payroll";
                                        return ValidationMessage;
                                    }
                                    if (strLT != null && strLT.length > 0) {
                                        for (let l = 0; l < strLT.length; l++) {
                                            if (strLT[l] != null && strLT[l].Trim() != "") {
                                                drcL = dtLT.filter(x => x.ComponentName == strLT[l].Trim());
                                                if (drcL == null || drcL.length == 0) {
                                                    ValidationMessage = "Leave Type : " + strLT[l].Trim() + " not found. Check @ Leave Types Deduction Order";
                                                    return ValidationMessage;
                                                }
                                            }

                                        }
                                    }
                                }

                            }
                        }
                    }
                }

                if (this.DocID > 0) {
                    let dtChk: any[] = BaseService.common.GetDataSet("PAY013", this.DocID.toString()).Tables[0];
                    if (dtChk != null && dtChk.length > 0) {
                        ValidationMessage = "Cannot save the record,Lates processed in Document @" + dtChk[0]["VoucherNo"].toString();
                        return ValidationMessage;
                    }
                }

            }
            else if (this.ScreenObject.DocumentType == 94) //Consider LOP to Service Days
            {
                let sEmpID = "0", sLID = "";

                var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld) {
                    if (vFld instanceof PactListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                }
                if (sEmpID == "0") {
                    ValidationMessage = "Select any Employee";
                    return ValidationMessage;
                }
                vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
                if (vFld) {
                    if (vFld instanceof PactListBoxData)
                        sLID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sLID = vFld.SelectedValue.toString();
                }
                if (sLID == "0") {
                    ValidationMessage = "Select any Leave Type";
                    return ValidationMessage;
                }

                /////
                let iEntCnt = 0;
                if (this.ScreenObject.GridData.length > 0) {
                    for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha1"])) {
                            iEntCnt++;
                        }
                    }
                }
                if (this.ScreenObject.GridData.length == 0 || iEntCnt == 0) {
                    ValidationMessage = "No LOP Leave documents found.";
                    return ValidationMessage;
                }
                /////
                iEntCnt = 0;
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha1"])) {
                        if (parseBoolean(this.ScreenObject.GridData[k]["dcAlpha5"])) {
                            iEntCnt++;
                        }
                    }
                }
                if (iEntCnt == 0) {
                    ValidationMessage = "Consider atleast one LOP Leave document to Post";
                    return ValidationMessage;
                }
                /////
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha1"])) {
                        if (parseBoolean(this.ScreenObject.GridData[k]["dcAlpha5"])) {
                            if (Util.IsEmptySpace(this.ScreenObject.GridData[k]["dcAlpha7"])) {
                                ValidationMessage = "Enter 'Current Adjustment Days' at Row No. " + (k + 1).toString();
                                return ValidationMessage;
                            }
                        }
                    }
                }
                /////
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha1"])) {
                        if (parseBoolean(this.ScreenObject.GridData[k]["dcAlpha5"])) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha7"])) {
                                if (parseFloat(this.ScreenObject.GridData[k]["dcAlpha7"]) <= 0 || parseFloat(this.ScreenObject.GridData[k]["dcAlpha7"]) > parseFloat(this.ScreenObject.GridData[k]["dcAlpha4"])) {
                                    ValidationMessage = "''Current Adjustment Days' should be Grater than '0' and less than or equal to 'No. of days'";
                                    return ValidationMessage;
                                }

                            }
                        }
                    }
                }
                /////
                this.dsData = this.GetLOPLeaveDocuments(parseInt(sEmpID), parseInt(sLID), this.DocumentDate);
                if (this.dsData != null && this.dsData.Tables.length > 0) {
                    if (this.dsData.Tables[0].length > 0 && this.dsData.Columns[0].Contains("ErrorMessage")) {
                        ValidationMessage = this.dsData.Tables[0][0]["ErrorMessage"].toString();
                        return ValidationMessage;
                    }

                    if (this.dsData.Tables[0].length > 0) {
                        let sLeaveVNo = "";
                        let dLN = 0, dCA = 0;
                        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                            if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                                sLeaveVNo = this.ScreenObject.GridData[i]["dcAlpha1"].toString();
                                dLN = parseFloat(this.ScreenObject.GridData[i]["dcAlpha4"]);
                                let dVal = Util.DTComputeSUM(this.dsData.Tables[1].filter(x => x.LOPLeaveDocVoucherNo == sLeaveVNo && x.DocID != this.DocID), "CurAdjDays", false);
                                dCA = Util.Double(this.ScreenObject.GridData[i]["dcAlpha7"]);
                                if (dVal + dCA > dLN) {
                                    ValidationMessage = "You can not adjust more than " + (dLN - dVal) + " days, previously adjusted in other documents";
                                    return ValidationMessage;
                                }
                            }
                        }
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 60) //Assign Leaves
            {
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (this.ScreenObject.GridData[k]["dcCCNID51_Key"] != null) {
                        IsValidDays = IsValidDays + parseInt(this.ScreenObject.GridData[k]["dcNum6"]);
                    }
                }
                if (IsValidDays > 0)
                    ValidationMessage = "Please check the dates";
            }
            else if (this.ScreenObject.DocumentType == 69) //Apply Resignation
            {
                let sEmpID: string = "0", sRelievingDate: string = "";
                let vFld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld) {
                    if (vFld instanceof PactListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                }

                let dtRes: any[] = BaseService.common.GetDataSet3("PAY014", this.DocID.toString(), sEmpID.toString()).Tables[0];
                if (dtRes != null && dtRes.length > 0) {
                    this.DisplayMessage = "Employee Resignation document already exists, Check Document @ " + dtRes[0]["VoucherNo"].toString();
                    this.MessageVisibility = true;
                    return this.DisplayMessage;
                }

                //#region Check whether Employee is on Leave/Vacation
                if (this.ScreenObject.Preferences.ContainsKey("AllowResignationifEmployeeonLeaveorVacation") && this.ScreenObject.Preferences["AllowResignationifEmployeeonLeaveorVacation"] == "False") {
                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        sRelievingDate = ""; sEmpID = "1";

                        vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                        if (vFld != undefined)
                            sRelievingDate = vFld.Date.ToString("dd/MMM/yyyy");

                        vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (vFld != undefined) {
                            if (vFld instanceof PactListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                        }

                        if (sRelievingDate != "" && parseInt(sEmpID) > 1) {

                            let dtE: any[] = BaseService.common.GetDataSet3("PAY084", sEmpID, sRelievingDate).Tables[0];
                            if (dtE != null && dtE.length > 0) {
                                if (Util.String(dtE[0]["LeaveMessage"]) != "") {
                                    this.DisplayMessage = dtE[0]["LeaveMessage"].toString();
                                    this.MessageVisibility = true;
                                    return this.DisplayMessage;
                                }
                            }

                        }
                    }
                }

                //#endregion
            }
            else if (this.ScreenObject.DocumentType == 89) //Attendance
            {
                //Check Duplicate Check-in Dates
                let dtCheckInDate = null, dtCheckInTime = null, dtCheckOutDate = null, dtCheckOutTime = null;
                let sEmpID = "0", sChecInDate = "", sChecOutDate = "";

                var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld) {
                    if (vFld instanceof PactListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                }


                var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                if (vFld2 && !Util.IsEmpty(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]))
                    dtCheckInDate = Util.ParseDate(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]);

                vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                if (vFld2 && !Util.IsEmpty(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]))
                    dtCheckInTime = Util.ParseDate(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]);

                vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                if (vFld2 && !Util.IsEmpty(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]))
                    dtCheckOutDate = Util.ParseDate(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]);

                vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha4");
                if (vFld2 && !Util.IsEmpty(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]))
                    dtCheckOutTime = Util.ParseDate(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]);

                if (dtCheckInDate == null && dtCheckOutDate == null) {
                    ValidationMessage = "Select atleast one Check-in/out Date.";
                    return ValidationMessage;
                }
                if (dtCheckInDate && dtCheckOutDate) {
                    dtCheckInDate = new Date(dtCheckInDate.getFullYear(), dtCheckInDate.getMonth(), dtCheckInDate.getDate(), dtCheckInTime.getHours(), dtCheckInTime.getMinutes(), dtCheckInTime.getSeconds());
                    dtCheckOutDate = new Date(dtCheckOutDate.getFullYear(), dtCheckOutDate.getMonth(), dtCheckOutDate.getDate(), dtCheckOutTime.getHours(), dtCheckOutTime.getMinutes(), dtCheckOutTime.getSeconds());

                    if (dtCheckOutDate < dtCheckInDate) {
                        ValidationMessage = "Check-in date should be less then or equal to Check-out date";
                        return ValidationMessage;
                    }
                }


                //#region Validating duplicate Timings of Employees

                let drw;
                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                        sChecInDate = ""; sEmpID = "1";
                        drw = this.ScreenObject.GridData[i];

                        vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                        if (vFld2 && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                            sChecInDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");

                        vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                        if (vFld2 != null && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                            sChecOutDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");

                        vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (vFld) {
                            if (vFld instanceof PactListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                        }
                        else {
                            vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                            if (vFld2 && !Util.IsEmpty(drw[vFld2.ValueMember]))
                                sEmpID = drw[vFld2.ValueMember].toString();
                        }

                        // #region Check Payroll Locked
                        if (this.ScreenObject.Preferences.ContainsKey("CheckPayrollLocked") && this.ScreenObject.Preferences["CheckPayrollLocked"] == "True") {
                            if (sChecInDate != "" && parseInt(sEmpID) > 1) {
                                ValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(sChecInDate), Util.ParseDate(sChecInDate), this.ScreenObject.DocumentType);
                            }
                            else if (sChecOutDate != "" && parseInt(sEmpID) > 1) {
                                ValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(sChecOutDate), Util.ParseDate(sChecOutDate), this.ScreenObject.DocumentType);
                            }

                            if (ValidationMessage != "")
                                return ValidationMessage;
                        }

                        if (parseInt(sEmpID) > 1 && (this.ScreenObject.Preferences.ContainsKey("ConsiderNightShift") && this.ScreenObject.Preferences["ConsiderNightShift"] == "False")) {
                            let sChk = "";
                            if (sChecInDate != "")
                                sChk = sChecInDate;
                            else if (sChecOutDate != "")
                                sChk = sChecOutDate;

                            if (sChk != "") {
                                let dtChk = BaseService.common.GetDataSet3("PAY105", sEmpID, sChk, this.DocID.toString()).Tables[0];
                                if (dtChk != null && dtChk.length > 0) {
                                    ValidationMessage = "Employee Attendance already exists on Voucher No : " + dtChk[0]["VoucherNo"].toString();
                                    return ValidationMessage;
                                }
                            }
                        }

                        if (sChecInDate != "" && parseInt(sEmpID) > 1) {


                            let dtChk: any[] = BaseService.common.GetDataSet3("PAY015", sEmpID, sChecInDate, this.DocID.toString()).Tables[0];
                            if (dtChk != null && dtChk.length > 0) {
                                ValidationMessage = "Employee Attendance already exists on Voucher No : " + dtChk[0]["VoucherNo"].toString();
                                return ValidationMessage;
                            }

                            let dtChk1: any[] = BaseService.common.GetDataSet3("PAY102", sEmpID, sChecInDate, this.DocID.toString()).Tables[0];
                            if (dtChk1 != null && dtChk1.length > 0) {
                                ValidationMessage = "Employee is on Leave, Cannot save the record - Voucher No : " + dtChk1[0]["VoucherNo"].toString();
                                return ValidationMessage;
                            }

                            let dtChk2: any[] = BaseService.common.GetDataTable("PAY107-A", sEmpID + "~" + sChecInDate);
                            if (dtChk2 != null && dtChk2.length > 0) {
                                ValidationMessage = "On Duty Already Applied, Cannot save the record - Voucher No : " + dtChk2[0]["VoucherNo"].toString();
                                return ValidationMessage;
                            }


                            this.drcc1 = this.dtPayEmps.filter(x => x.NodeID == sEmpID);
                            let sVoucherNo = this.GetDuplicateTimingsOfEmployeeTimeSheet(sChecInDate, sEmpID, i, this.ScreenObject.DocumentType);
                            if (sVoucherNo != "") {
                                try {
                                    parseInt(sVoucherNo);
                                    this.DisplayMessage = "Employee has already worked on these timings, can't allow same timings. Check Timings of the Employee - " + this.drcc1[0]["Code"].toString() + " @ Row No - " + parseInt(sVoucherNo);
                                }
                                catch {
                                    this.DisplayMessage = "Employee has already worked on these timings, can't allow same timings. Check Timings of the Employee - " + this.drcc1[0]["Code"].toString() + " @ Voucher No - " + sVoucherNo;
                                }
                                this.MessageVisibility = true;
                                return this.DisplayMessage;
                            }
                        }
                    }
                }

                //#endregion
            }
            else if (this.ScreenObject.DocumentType == 90) //Time Sheet
            {
                //Check Duplicate Check-in Dates
                let dtCheckInDate = null, dtCheckInTime = null, dtCheckOutDate = null, dtCheckOutTime = null;
                let sEmpID = "0", sChecInDate = "", sChecOutDate = "";

                var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld) {
                    if (vFld instanceof PactListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                }

                var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                if (vFld2 && !Util.IsEmpty(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]))
                    dtCheckInDate = Util.ParseDate(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]);

                vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                if (vFld2 && !Util.IsEmpty(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]))
                    dtCheckInTime = Util.ParseDate(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]);

                vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                if (vFld2 && !Util.IsEmpty(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]))
                    dtCheckOutDate = Util.ParseDate(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]);

                vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha4");
                if (vFld2 && !Util.IsEmpty(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]))
                    dtCheckOutTime = Util.ParseDate(this.ScreenObject.GridData[0][vFld2.DisplayMember + "_Key"]);


                if (dtCheckInDate == null && dtCheckOutDate == null) {
                    ValidationMessage = "Select atleast one Check-in/out Date.";
                    return ValidationMessage;
                }

                if (dtCheckInDate && dtCheckOutDate) {
                    dtCheckInDate = new Date(dtCheckInDate.getFullYear(), dtCheckInDate.getMonth(), dtCheckInDate.getDate(), dtCheckInTime.getHours(), dtCheckInTime.getMinutes(), dtCheckInTime.getSeconds());
                    dtCheckOutDate = new Date(dtCheckOutDate.getFullYear(), dtCheckOutDate.getMonth(), dtCheckOutDate.getDate(), dtCheckOutTime.getHours(), dtCheckOutTime.getMinutes(), dtCheckOutTime.getSeconds());

                    if (dtCheckOutDate < dtCheckInDate) {
                        ValidationMessage = "Check-in date should be less then or equal to Check-out date";
                        return ValidationMessage;
                    }
                }

                //#region Check Payroll Locked
                if (this.ScreenObject.Preferences.ContainsKey("CheckPayrollLocked") && this.ScreenObject.Preferences["CheckPayrollLocked"] == "True") {
                    let drw;
                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                            sChecInDate = ""; sEmpID = "1"; sChecOutDate = "";
                            drw = this.ScreenObject.GridData[i];

                            vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                            if (vFld2 != null && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                                sChecInDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");

                            vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                            if (vFld2 != null && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                                sChecOutDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");

                            vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                            if (vFld) {
                                if (vFld instanceof PactListBoxData)
                                    sEmpID = vFld.SelectedValue.ToString();
                                else if (vFld instanceof PactCodeNameListBoxData)
                                    sEmpID = vFld.SelectedValue.ToString();
                            }
                            else {
                                vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                                if (vFld2 != null && Util.IsEmpty(drw[vFld2.ValueMember]))
                                    sEmpID = drw[vFld2.ValueMember].ToString();
                            }

                            if (sChecInDate != "" && parseInt(sEmpID) > 1) {
                                ValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(sChecInDate), Util.ParseDate(sChecInDate), this.ScreenObject.DocumentType);
                            }
                            else if (sChecOutDate != "" && parseInt(sEmpID) > 1) {
                                ValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(sChecOutDate), Util.ParseDate(sChecOutDate), this.ScreenObject.DocumentType);
                            }

                            if (ValidationMessage != "")
                                return ValidationMessage;
                        }
                    }
                }


                if (BaseService.SessionManager.Preferences.ContainsKey("AllowMultipleTimeSheetsOnSameDay") && BaseService.SessionManager.Preferences["AllowMultipleTimeSheetsOnSameDay"].toString().toUpperCase() == "FALSE") {
                    if (parseInt(sEmpID) > 1 && dtCheckInDate != null) {
                        let dtChk: any[] = BaseService.common.GetDataSet3("PAY016", sEmpID, dtCheckInDate.ToString("dd MMM yyyy"), this.DocID.toString()).Tables[0];
                        if (dtChk != null && dtChk.length > 0) {
                            ValidationMessage = "Employee Time Sheet already exists on Voucher No : " + dtChk[0]["VoucherNo"].toString();
                            return ValidationMessage;
                        }
                    }
                }

                if (BaseService.SessionManager.Preferences.ContainsKey("AllowOverlapTimeInTimeSheet") && BaseService.SessionManager.Preferences["AllowOverlapTimeInTimeSheet"].toString().toUpperCase() == "FALSE") {
                    //#region Validating duplicate Timings of Employees

                    let drw;
                    for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                        if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                            sChecInDate = ""; sEmpID = "1";
                            drw = this.ScreenObject.GridData[i];

                            vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                            if (vFld2 && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                                sChecInDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");

                            vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                            if (vFld) {
                                if (vFld instanceof PactListBoxData)
                                    sEmpID = vFld.SelectedValue.toString();
                                else if (vFld instanceof PactCodeNameListBoxData)
                                    sEmpID = vFld.SelectedValue.toString();
                            }
                            else {
                                vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                                if (vFld2 && !Util.IsEmpty(drw[vFld2.ValueMember]))
                                    sEmpID = drw[vFld2.ValueMember].toString();
                            }

                            if (sChecInDate != "" && parseInt(sEmpID) > 1) {
                                this.drcc1 = this.dtPayEmps.filter(x => x.NodeID == sEmpID);
                                let sVoucherNo = this.GetDuplicateTimingsOfEmployeeTimeSheet(sChecInDate, sEmpID, i, this.ScreenObject.DocumentType);
                                if (sVoucherNo != "") {
                                    try {
                                        parseInt(sVoucherNo);
                                        this.DisplayMessage = "Employee has already worked on these timings, can't allow same timings. Check Timings of the Employee - " + this.drcc1[0]["Code"].toString() + " @ Row No - " + parseInt(sVoucherNo);
                                    }
                                    catch {
                                        this.DisplayMessage = "Employee has already worked on these timings, can't allow same timings. Check Timings of the Employee - " + this.drcc1[0]["Code"].toString() + " @ Voucher No - " + sVoucherNo;
                                    }
                                    this.MessageVisibility = true;
                                    return this.DisplayMessage;
                                }
                            }
                        }
                    }

                    //#endregion
                }
            }
            else if (this.ScreenObject.DocumentType == 79) //Attendance Dimension Wise
            {
                let sEmpID = "0", sPayrollMonth = "";
                var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld) {
                    if (vFld instanceof PactListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                }

                vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                if (vFld)
                    sPayrollMonth = (vFld as PactExtraFieldDateData).Date.ToString("dd/MMM/yyyy");

                if (sPayrollMonth != "" && parseInt(sEmpID) > 1) {
                    let dtChk: any[] = BaseService.common.GetDataSet3("PAY017", this.DocID.toString(), sEmpID, sPayrollMonth);
                    if (dtChk != null && dtChk.length > 0) {
                        ValidationMessage = "Attendance Dimension Wise already exists on Voucher No : " + dtChk[0]["VoucherNo"].toString();
                        return ValidationMessage;
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 58) //Leave Encashment
            {
                let iEntCnt = 0;
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (this.ScreenObject.GridData[k]["dcCCNID52_Key"] != null) {
                        iEntCnt++;

                        if (Util.Double(this.ScreenObject.GridData[k]["dcAlpha3"]) <= 0) {
                            ValidationMessage = "Enter Valid Applied Days ";
                            break;
                        }

                        IsValidDays = parseInt(this.ScreenObject.GridData[k]["dcAlpha5"]);
                        if (IsValidDays == -1) {
                            ValidationMessage = "Applied days should be less than or equal to available days";
                            break;
                        }
                        else if (IsValidDays == -2) {
                            ValidationMessage = "Total applied days should be less than or equal to max encash days";
                            break;
                        }
                    }
                }
                if (iEntCnt == 0) {
                    ValidationMessage = "Encash atleast one Leave Type";
                    return ValidationMessage;
                }

                let sEmpID = "";

                var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld) {
                    if (vFld instanceof PactListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                }

                var fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha9");
                if (fldAPV2 != null && fldAPV2 instanceof PactComboBoxData && !Util.IsEmpty(fldAPV2.SelectedValue)) {
                    if (fldAPV2.SelectedValue.toString() == "Yes") {
                        fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha10");
                        if (fldAPV2 != null && fldAPV2 instanceof PactExtraFieldDateData && fldAPV2.Date && Util.Int(sEmpID) > 0) {
                            if (this.CheckIsPayrollProcessed(Util.ParseDate(fldAPV2.Date).ToString("dd/MMM/yyyy"), sEmpID)) {
                                ValidationMessage += "Cannot save the record, Payroll processed for the selected month";
                                return ValidationMessage;
                            }
                        }
                    }
                }
            }

            else if (this.ScreenObject.DocumentType == 59) //Compensatory Leaves
            {
                if (BaseService.SessionManager.Preferences.ContainsKey("CompensatoryLeaveType") && BaseService.SessionManager.Preferences["CompensatoryLeaveType"].toString() == "") {
                    ValidationMessage = "Please set the compensatory leave type preference";
                }
                else {
                    for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                        if (this.ScreenObject.GridData[k]["dcCCNID51_Key"] != null) {
                            if (this.ScreenObject.GridData[k]["dcAlpha1_Key"] != null) {
                                if (Util.ParseDate(this.DocumentDate) > Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha1_Key"]) && this.ScreenObject.Preferences.ContainsKey("IgnoreDocumentDateValidation") && !parseBoolean(this.ScreenObject.Preferences["IgnoreDocumentDateValidation"])) {
                                    ValidationMessage = "Document Date should be less than or equal to Selected Date";
                                    break;
                                }
                            }

                            IsValidDays = parseInt(this.ScreenObject.GridData[k]["dcNum1"]);
                            if (IsValidDays == 0) {
                                ValidationMessage = "Selected date should be Weeklyoff or Holiday";
                                break;
                            }
                        }
                    }
                }
            }

            else if (this.ScreenObject.DocumentType == 62) //Apply Leaves
            {
                //var fldAR = ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha16");
                //if (fldAR != null && fldAR instanceof PactTextBoxData && ((PactTextBoxData)fldAR).Text != null && ((PactTextBoxData)fldAR).Text == "LatesProcessing")
                //{
                //    DisplayMessage = "You can't save this document, beacause its posted from Lates Processing Document";
                //    MessageVisibility = true;
                //    return DisplayMessage;
                //}

                let sEmpID = "";
                let dtEmp = BaseService.common.GetDataSet("PAY019", "").Tables[0];

                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if (vFld) {
                        if (vFld instanceof PactListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                        else if (vFld instanceof PactCodeNameListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                    }
                    else {
                        var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                        if (vFld2 && !Util.IsEmpty(this.ScreenObject.GridData[k][vFld2.ValueMember]))
                            sEmpID = this.ScreenObject.GridData[k][vFld2.ValueMember].toString();
                    }
                    if (dtEmp != null && dtEmp.length > 0 && !Util.IsEmpty(sEmpID) && parseInt(sEmpID) > 0) {
                        if (this.ScreenObject.GridData[k]["dcAlpha4_Key"] != null) {
                            let drr1 = dtEmp.filter(x => x.NodeId == sEmpID);
                            if (drr1 != null && drr1.length > 0) {
                                if (Util.ParseDate(drr1[0]["DateOfJoining"].toString()) > Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"].toString())) {
                                    this.DisplayMessage = "Please Check The Employee Dependency With date Of joining ";
                                    this.MessageVisibility = true;
                                    return this.DisplayMessage;
                                }
                            }
                        }
                    }
                    if (this.ScreenObject.Preferences.ContainsKey("DonotallowLeaveduringNoticePeriod") && this.ScreenObject.Preferences["DonotallowLeaveduringNoticePeriod"] != "" && parseBoolean(this.ScreenObject.Preferences["DonotallowLeaveduringNoticePeriod"])) {
                        if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha5_key"])) {
                            let dt = BaseService.report.GetDataTable("AEDDALeave", sEmpID, Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_key"]).ToString("dd/MMM/yyyy"));
                            if (dt != null && dt.length > 0) {
                                ValidationMessage += "Employee is on Notice Period,Cannot Apply Leave";
                                break;
                            }
                        }
                    }
                    if (BaseService.SessionManager.Preferences.ContainsKey("DonotAllowLeaveIfAttendencePosted") && parseBoolean(BaseService.SessionManager.Preferences["DonotAllowLeaveIfAttendencePosted"] == "True")) {
                        //if ((this.ScreenObject.GridData[k]["dcAlpha4_Key"] != null) && (this.ScreenObject.GridData[k]["dcAlpha5_Key"] != null)) {
                        if ((this.ScreenObject.GridData[k]["dcAlpha4_key"] != null) && (this.ScreenObject.GridData[k]["dcAlpha5_key"] != null) && !Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha6"]) && this.ScreenObject.GridData[k]["dcAlpha6"].toString().toUpperCase() == "BOTH") {
                            let dtE: any[] = BaseService.common.GetDataSet3("PAY018", sEmpID, Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"]).ToString("dd/MMM/yyyy"), Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_Key"]).ToString("dd/MMM/yyyy")).Tables[0];
                            if (dtE != null && dtE.length > 0) {
                                ValidationMessage = "Daily Attendence Already Posted";
                                break;
                            }
                        }
                    }

                    if ((this.ScreenObject.GridData[k]["dcAlpha4_key"] != null) && (this.ScreenObject.GridData[k]["dcAlpha5_key"] != null) && this.ScreenObject.GridData[k]["dcAlpha6"] != null && this.ScreenObject.GridData[k]["dcAlpha6"].ToString() != null && this.ScreenObject.GridData[k]["dcAlpha6"].toString() != "" && this.ScreenObject.GridData[k]["dcAlpha6"].toString().toUpperCase() == "BOTH") {
                        let dtE: any[] = BaseService.common.GetDataSet3("PAY103", sEmpID, Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"]).ToString("dd/MMM/yyyy"), Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_Key"]).ToString("dd/MMM/yyyy")).Tables[0];
                        if (dtE != null && dtE.length > 0) {
                            ValidationMessage = "Attendence Already Posted, Cannot save the record - Voucher No : " + dtE[0]["VoucherNo"].toString();
                            break;
                        }
                    }


                    if ((!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha4_key"])) && (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha5_key"])) && !Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha6"])) {
                        let dtE: any[] = BaseService.common.GetDataSet3("PAY108", sEmpID, Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"]).ToString("dd/MMM/yyyy"), Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_Key"]).ToString("dd/MMM/yyyy")).Tables[0];
                        if (dtE != null && dtE.length > 0) {
                            if (this.ScreenObject.GridData[k]["dcAlpha6"].toString().toUpperCase() == "BOTH" || dtE[0]["Session"].toString().toUpperCase() == "BOTH") {
                                ValidationMessage = "OnDuty Already Posted, Cannot save the record - Voucher No : " + dtE[0]["VoucherNo"].toString();
                                break;
                            }
                        }
                    }


                    if (this.ScreenObject.GridData[k]["dcCCNID52_Key"] != null) {
                        let outrefobj = { IfFormulaExistsNoOfDays: false }
                        ValidationMessage = this.IsLeaveTypeValid(parseInt(sEmpID), parseInt(this.ScreenObject.GridData[k]["dcCCNID52_Key"]), this.ScreenObject.GridData[k], outrefobj);
                        if (ValidationMessage != "")
                            break;

                        //Checking Whether the Employee has rejoined from Vacation or not.?
                        let dtC = BaseService.common.GetDataSet3("PAY009", sEmpID, Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"].toString()).ToString("dd/MMM/yyyy")).Tables[0];
                        if (dtC != null && dtC.length > 0) {
                            ValidationMessage = "Please enter Rejoining date of this Employee to the Last Vacation";
                            break;
                        }


                        if (this.ScreenObject.GridData[k]["dcCCNID52_key"] != null) {
                            let strLeaveLOPBasedOn = BaseService.SessionManager.Preferences["ConsiderLOPBasedOn"].toString();
                            let strLOPBasedOn: any = null;
                            if (strLeaveLOPBasedOn.length > 0)
                                strLOPBasedOn = strLeaveLOPBasedOn.split(',');

                            if (strLOPBasedOn != null && strLOPBasedOn.Contains(this.ScreenObject.GridData[k]["dcCCNID52_key"].toString())) {
                                if (this.ScreenObject.Preferences.ContainsKey("DontAllowLopLeaveifVacationTakenforfuturedays") && this.ScreenObject.Preferences["DontAllowLopLeaveifVacationTakenforfuturedays"] != "" && parseBoolean(this.ScreenObject.Preferences["DontAllowLopLeaveifVacationTakenforfuturedays"])) {
                                    if ((this.ScreenObject.GridData[k]["dcAlpha4_key"] != null) && (this.ScreenObject.GridData[k]["dcAlpha5_key"] != null)) {
                                        let dt1: any = BaseService.common.GetDataTable("PAY106", sEmpID + "~" + Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_key"]).ToString("dd/MMM/yyyy"));
                                        if (dt1 != null && dt1.length > 0) {
                                            ValidationMessage += "Cannot Apply Lop Leave,Employee has Already applied Vacation in future Date";
                                            break;
                                        }
                                    }
                                }

                                if (this.ScreenObject.Preferences.ContainsKey("DontAllowLopLeaveifVacationBalanceAvailable") && this.ScreenObject.Preferences["DontAllowLopLeaveifVacationBalanceAvailable"] != "" && parseBoolean(this.ScreenObject.Preferences["DontAllowLopLeaveifVacationBalanceAvailable"])) {
                                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha4_key"])) {
                                        let ObjArray = [];

                                        ObjArray.push(Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_key"]).ToString("dd/MMM/yyyy"));
                                        ObjArray.push(sEmpID);
                                        ObjArray.push(2);
                                        ObjArray.push(BaseService.SessionManager.UserID);
                                        ObjArray.push(BaseService.SessionManager.LanguageID);
                                        let DS = BaseService.common.GetDataSet_SP(ObjArray, "spPAY_GetRemainingVacationDays");
                                        if (DS != null && DS.Tables.length > 0 && DS.Tables[0].length > 0) {
                                            if (parseFloat(DS.Tables[0][0]["AvlblDays"]) >= 1) {
                                                ValidationMessage = "Cannot Apply Lop Leave,Employee has Vacation Balance Available";
                                                break;
                                            }
                                        }

                                    }
                                }
                            }
                        }


                        if (this.ScreenObject.GridData[k]["dcAlpha4_Key"] != null) {
                            if (Util.ParseDate(this.DocumentDate) > Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"]) && this.ScreenObject.Preferences.ContainsKey("IgnoreDocumentDateValidation") && !parseBoolean(this.ScreenObject.Preferences["IgnoreDocumentDateValidation"])) {
                                ValidationMessage = "Document Date should be less than or equal to From Date";
                                break;
                            }
                        }
                        if (this.ScreenObject.GridData[k]["dcAlpha7"] != null) {
                            dblIsValidDays = parseFloat(this.ScreenObject.GridData[k]["dcAlpha7"]);
                            if (dblIsValidDays <= 0) {
                                ValidationMessage = "Dates already applied | Selected dates between holidays or weeklyoffs dates";
                                break;
                            }
                        }

                        if (this.ScreenObject.GridData[k]["dcAlpha9"] != null && (parseInt(this.ScreenObject.GridData[k]["dcAlpha9"]) >= 0 || parseInt(this.ScreenObject.GridData[k]["dcAlpha9"]) == -4)) {
                            if (this.ScreenObject.GridData[k]["dcAlpha3"] != null) {
                                dblIsValidDays = parseFloat(this.ScreenObject.GridData[k]["dcAlpha3"]);
                                if (dblIsValidDays <= 0) {
                                    ValidationMessage = "Please check the Payroll structure/Available leaves for the selected month";
                                    break;
                                }
                            }
                            if (this.ScreenObject.GridData[k]["dcAlpha3"] != null && this.ScreenObject.GridData[k]["dcAlpha7"] != null && this.ScreenObject.GridData[k]["dcAlpha9"] != null) {
                                if (parseInt(this.ScreenObject.GridData[k]["dcAlpha9"]) != -4) {
                                    if (parseFloat(this.ScreenObject.GridData[k]["dcAlpha7"]) > parseFloat(this.ScreenObject.GridData[k]["dcAlpha3"])) {
                                        ValidationMessage = "Cannot apply leaves more than Available leaves";
                                        break;
                                    }
                                }
                            }
                        }

                        if (Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha6"]) || Util.String(this.ScreenObject.GridData[k]["dcAlpha6"]) == "1" || Util.String(this.ScreenObject.GridData[k]["dcAlpha6"]) == "2" || Util.String(this.ScreenObject.GridData[k]["dcAlpha6"]) == "3") {
                            ValidationMessage = "Please select the session type";
                            break;
                        }
                        if (BaseService.SessionManager.Preferences.ContainsKey("AllowLeavesifPayrollProcessedorLocked") && parseBoolean(BaseService.SessionManager.Preferences["AllowLeavesifPayrollProcessedorLocked"] == "False")) {
                            if (this.ScreenObject.GridData[k]["dcAlpha4_key"] != null && this.ScreenObject.GridData[k]["dcAlpha5_key"] != null) {
                                ValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_key"]), Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_key"]), this.ScreenObject.DocumentType);
                                if (ValidationMessage != "")
                                    break;
                            }
                        }
                    }
                }
            }

            else if (this.ScreenObject.DocumentType == 65) //Join From Vacation
            {
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (this.ScreenObject.GridData[k]["dcAlpha1"] != null)// && ScreenObject.GridData[k]["dcAlpha4"] != null)
                    {
                        if (Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha3_Key"])) {
                            ValidationMessage = "Please enter the Re-join date";
                            break;
                        }
                        else {
                            if ((Util.ParseDate(this.DocumentDate) > Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha3_Key"])) && this.ScreenObject.Preferences.ContainsKey("IgnoreDocumentDateValidation") && !parseBoolean(this.ScreenObject.Preferences["IgnoreDocumentDateValidation"])) {
                                ValidationMessage = "Document Date should be less than or equal to Re-join date";
                                break;
                            }

                            IsValidDays = parseInt(this.ScreenObject.GridData[k]["dcAlpha4"]);
                            if (IsValidDays > 0) {
                                ValidationMessage = "Please check the Re-join date";
                                break;
                            }
                            if (this.ScreenObject.Preferences.ContainsKey("DonotAllowtochangerejoiniffuturevacationtaken") && !Util.IsEmpty(this.ScreenObject.Preferences["DonotAllowtochangerejoiniffuturevacationtaken"]) && parseBoolean(this.ScreenObject.Preferences["DonotAllowtochangerejoiniffuturevacationtaken"])) {
                                let sEmpID = "";
                                let vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                                if (vFld != undefined) {
                                    if (vFld instanceof PactListBoxData)
                                        sEmpID = vFld.SelectedValue.toString();
                                    else if (vFld instanceof PactCodeNameListBoxData)
                                        sEmpID = vFld.SelectedValue.toString();
                                }
                                else {
                                    let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                                    if (vFld2 != undefined && this.ScreenObject.GridData[k][vFld2.ValueMember] != null && this.ScreenObject.GridData[k][vFld2.ValueMember].toString() != "")
                                        sEmpID = this.ScreenObject.GridData[k][vFld2.ValueMember].toString();
                                }
                                if (!Util.IsEmpty(sEmpID) && parseInt(sEmpID) > 0) {

                                    let dt1: any = BaseService.common.GetDataTable("DOC075", sEmpID + "~" + new Date(this.ScreenObject.GridData[k]["dcAlpha3_key"]).ToString("dd MMM yyyy"));

                                    if (dt1 != null && dt1.length > 0) {
                                        ValidationMessage = "Cannot Change Re-join, Future Vacation is Posted for Employee";
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 68 || this.ScreenObject.DocumentType == 69 || this.ScreenObject.DocumentType == 70 || this.ScreenObject.DocumentType == 80) {
                var fldRod = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (fldRod != null && (fldRod instanceof PactListBoxData && Util.IsEmpty(fldRod.Text) || fldRod instanceof PactCodeNameListBoxData && Util.IsEmpty(fldRod.Text)))
                    ValidationMessage = "Please select the employee";

                if (this.ScreenObject.DocumentType == 69) //Apply Resignation
                {
                    var fldAR = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                    if (fldAR instanceof PactExtraFieldDateData && fldAR.Date) {
                        if (Util.ParseDate(this.DocumentDate) > Util.ParseDate(fldAR.Date) && this.ScreenObject.Preferences.ContainsKey("IgnoreDocumentDateValidation") && !parseBoolean(this.ScreenObject.Preferences["IgnoreDocumentDateValidation"])) {
                            ValidationMessage = ValidationMessage + " Document Date should be less than or equal to Release Date";
                        }
                    }
                    for (let c = 0; c < this.ScreenObject._TextFields.length; c++) {
                        let item = this.ScreenObject._TextFields[c]
                        if (item instanceof PactExtraFieldDateData && item.DBColumnName.toLowerCase().Contains("dcalpha")) {
                            if (item.Date) {
                                ValidationMessage = ValidationMessage + this.IsDateValid(null, item.DBColumnName);
                                break;
                            }
                        }
                    }
                }
                else if (this.ScreenObject.DocumentType == 70) //Checklist
                {
                    for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                        if (this.ScreenObject.GridData[k]["dcAlpha4_Key"] != null && this.ScreenObject.GridData[k]["dcAlpha5_Key"] != null) {
                            if (Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_Key"]) < Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"])) {
                                ValidationMessage = "Expected completed date should be greater than start date";
                                break;
                            }
                        }
                        if (this.ScreenObject.GridData[k]["dcAlpha4_Key"] != null && this.ScreenObject.GridData[k]["dcAlpha6_Key"] != null) {
                            if (Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha6_Key"]) < Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"])) {
                                ValidationMessage = "Completed date should be greater than start date";
                                break;
                            }
                        }
                        if (this.ScreenObject.GridData[k]["dcAlpha5_Key"] != null && this.ScreenObject.GridData[k]["dcAlpha6_Key"] != null) {
                            if (Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha6_Key"]) < Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_Key"])) {
                                ValidationMessage = "Completed date should be greater than Expected completed date";
                                break;
                            }
                        }
                        if (this.ScreenObject.GridData[k]["dcAlpha4_Key"] != null) {
                            if (Util.ParseDate(this.DocumentDate) > Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"]) && this.ScreenObject.Preferences.ContainsKey("IgnoreDocumentDateValidation") && !parseBoolean(this.ScreenObject.Preferences["IgnoreDocumentDateValidation"])) {
                                ValidationMessage = "Document Date should be less than or equal to Start Date";
                                break;
                            }
                        }

                    }
                }
                else if (this.ScreenObject.DocumentType == 68) {
                    let dtFromDate = new Date().OnlyDate(), dtToDate = new Date().OnlyDate();//DateTime.Now;
                    let sEmpID = "";
                    for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                        if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && this.ScreenObject.GridData[k]["ProductID_Key"] != null && this.ScreenObject.GridData[k]["ProductID_Key"] != null && this.ScreenObject.GridData[k]["ProductID_Key"].toString() != "") {
                            let vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                            if (vFld != undefined) {
                                if (vFld instanceof PactListBoxData)
                                    sEmpID = vFld.SelectedValue.toString();
                                else if (vFld instanceof PactCodeNameListBoxData)
                                    sEmpID = vFld.SelectedValue.toString();
                            }
                            else {
                                let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                                if (vFld2 != undefined && !Util.IsEmpty(this.ScreenObject.GridData[k][vFld2.ValueMember]))
                                    sEmpID = this.ScreenObject.GridData[k][vFld2.ValueMember].toString();
                            }

                            let fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                            if (fldAPV2 != undefined && fldAPV2 instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV2.Date))
                                dtFromDate = fldAPV2.Date;

                            fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                            if (fldAPV2 != undefined && fldAPV2 instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV2.Date))
                                dtToDate = new Date(fldAPV2.Date.getFullYear(), fldAPV2.Date.iMonth(), 1);

                            let dtp: any = BaseService.common.GetDataTable("PAY092", sEmpID + "~" + dtToDate.AddMonths(1));
                            if (dtp != null && dtp.length > 0) {
                                ValidationMessage = "Cannot save the record, Payroll processed for the selected month";
                                break;
                            }

                            ValidationMessage = this.IsDocLocked(sEmpID, dtToDate.AddMonths(1), dtToDate.AddMonths(1), this.ScreenObject.DocumentType);
                            if (ValidationMessage != "")
                                break;
                        }
                    }
                }
                else if (this.ScreenObject.DocumentType == 80) {
                    let dtFromDate = new Date().OnlyDate(), dtToDate = new Date().OnlyDate();
                    let sEmpID = "";
                    let vFld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if (vFld != undefined) {
                        if (vFld instanceof PactListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                        else if (vFld instanceof PactCodeNameListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                    }

                    let fldAPV2: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                    if (fldAPV2 != undefined && fldAPV2 instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV2.Date))
                        dtFromDate = fldAPV2.Date;
                    dtToDate = dtFromDate;

                    ValidationMessage = this.IsDocLocked(sEmpID, dtFromDate, dtToDate, this.ScreenObject.DocumentType);
                }

            }
            else if (this.ScreenObject.DocumentType == 72) //Apply Vacation
            {
                let dtFromDate = new Date(), dtToDate = new Date();

                let sEmpID = "";
                let dtEmp = BaseService.common.GetDataSet("PAY019", "").Tables[0];

                var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld) {
                    if (vFld instanceof PactListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                }
                if (dtEmp != null && dtEmp.length > 0 && !Util.IsEmpty(sEmpID) && parseInt(sEmpID) > 0) {
                    var fldAPV: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                    if (fldAPV) {
                        let drr1 = dtEmp.filter(x => x.NodeId == sEmpID);
                        if (drr1 != null && drr1.length > 0) {
                            if (Util.ParseDate(drr1[0]["DateOfJoining"].toString()) > Util.ParseDate(fldAPV.Date)) {
                                this.DisplayMessage = "Please Check The Employee Dependency With date Of joining ";
                                this.MessageVisibility = true;
                                return this.DisplayMessage;
                            }
                        }
                    }
                }


                let fldAPV2: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (fldAPV2 != undefined && fldAPV2 instanceof PactListBoxData && fldAPV2.SelectedValue > 0 && this.DocID == 0) {
                    var fldAPV: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                    var fldAPV1: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                    if (fldAPV != undefined && fldAPV instanceof PactExtraFieldDateData && Util.String(fldAPV.Date) != "") {
                        if (fldAPV1 != undefined && fldAPV1 instanceof PactExtraFieldDateData && fldAPV1.Date.toString() != "") {
                            let dsCheckDocValidation: any = this.ScreenObject.GetVacationDetails((fldAPV2.SelectedValue), Util.ParseDate(fldAPV.Date), Util.ParseDate(fldAPV1.Date));
                            if (dsCheckDocValidation.Tables.length > 0)
                                ValidationMessage = this.ApplyVacationValidationMsg(dsCheckDocValidation);

                            if (BaseService.SessionManager.Preferences.ContainsKey("DonotAllowVacationDuringProbationPeriod") && BaseService.SessionManager.Preferences["DonotAllowVacationDuringProbationPeriod"].toString() == "True") {
                                if (Util.ParseDate(dtFromDate) <= Util.ParseDate(dsCheckDocValidation.Tables[6][0]["ConfirmationDate"]))
                                    ValidationMessage = ValidationMessage + " Employee is in probation period, cannot apply the vacation" + "\r\n";;
                            }
                        }
                    }
                }
                else if (fldAPV2 != null && fldAPV2 instanceof PactCodeNameListBoxData && fldAPV2.SelectedValue > 0 && this.DocID == 0) {
                    var fldAPV: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                    var fldAPV1: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                    if (fldAPV != undefined && fldAPV instanceof PactExtraFieldDateData && Util.String(fldAPV.Date) != "") {
                        if (fldAPV1 != undefined && fldAPV1 instanceof PactExtraFieldDateData && Util.String(fldAPV1.Date) != "") {
                            let dsCheckDocValidation: any = this.ScreenObject.GetVacationDetails((fldAPV2.SelectedValue), Util.ParseDate(fldAPV.Date), Util.ParseDate(fldAPV1.Date));
                            if (dsCheckDocValidation.Tables.length > 0)
                                ValidationMessage = this.ApplyVacationValidationMsg(dsCheckDocValidation);

                            if (BaseService.SessionManager.Preferences.ContainsKey("DonotAllowVacationDuringProbationPeriod") && BaseService.SessionManager.Preferences["DonotAllowVacationDuringProbationPeriod"].toString() == "True") {
                                if (Util.ParseDate(dtFromDate) <= Util.ParseDate(dsCheckDocValidation.Tables[6][0]["ConfirmationDate"]))
                                    ValidationMessage = ValidationMessage + " Employee is in probation period, cannot apply the vacation" + "\r\n";;
                            }
                        }
                    }
                }


                fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha16");
                if (fldAPV2 != null && fldAPV2 instanceof PactComboBoxData && !Util.IsEmpty(fldAPV2.SelectedValue) && fldAPV2.SelectedValue == "Yes") {
                    var fldAPV3: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha14");
                    if (fldAPV3 instanceof PactTextBoxData) {
                        let opening = 0, crediteddays = 0, vacdays = 0;
                        let fldAPV: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha22");
                        if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                            opening = parseFloat(fldAPV.Text);
                        }
                        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha10");
                        if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                            vacdays = parseFloat(fldAPV.Text);
                        }
                        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha7");
                        if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text)) {
                            crediteddays = parseFloat(fldAPV.Text);
                        }
                        //remaining days
                        if (((opening + crediteddays) - vacdays) < parseFloat(fldAPV.Text))
                            ValidationMessage = ValidationMessage + "Encash days should be less than or equal to remaining days" + "\r\n";;

                    }
                }

                fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha16");
                if (fldAPV2 != null && fldAPV2 instanceof PactComboBoxData && !Util.IsEmpty(fldAPV2.SelectedValue)) {
                    if (fldAPV2.SelectedValue.toString() != "Yes") {
                        fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                        if (fldAPV2 != null && fldAPV2 instanceof PactTextBoxData && ((fldAPV2.Text.toString()) == "" || (fldAPV2.Text.toString()) == "0.00"))
                            ValidationMessage = ValidationMessage + "Please check the vacation days" + "\r\n";
                    }
                }

                fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha18");
                if (fldAPV2 != null && fldAPV2 instanceof PactExtraFieldDateData && fldAPV2.Date) {
                    if (Util.ParseDate(fldAPV2.Date) < Util.ParseDate(this.DocumentDate))
                        ValidationMessage = ValidationMessage + "Exit rentry date should be greater than doc date" + "\r\n";
                }

                fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha19");
                if (fldAPV2 != null && fldAPV2 instanceof PactExtraFieldDateData && fldAPV2.Date) {
                    if (Util.ParseDate(fldAPV2.Date) < Util.ParseDate(this.DocumentDate))
                        ValidationMessage = ValidationMessage + "Approved date should be greater than doc date" + "\r\n";
                }


                fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                if (fldAPV2 != null && fldAPV2 instanceof PactExtraFieldDateData && fldAPV2.Date)
                    dtFromDate = fldAPV2.Date;

                fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                if (fldAPV2 != null && fldAPV2 instanceof PactExtraFieldDateData && fldAPV2.Date)
                    dtToDate = fldAPV2.Date;

                if ((Util.ParseDate(dtFromDate) > Util.ParseDate(dtToDate)))
                    ValidationMessage = ValidationMessage + "Todate should be greater than Fromdate" + "\r\n";

                if ((Util.ParseDate(this.DocumentDate) > Util.ParseDate(dtFromDate)) && this.ScreenObject.Preferences.ContainsKey("IgnoreDocumentDateValidation") && !parseBoolean(this.ScreenObject.Preferences["IgnoreDocumentDateValidation"]))
                    ValidationMessage = ValidationMessage + "Document Date should be less than or equal to From Date";

                if (this.ScreenObject.Preferences.ContainsKey("DontAllowExcessVacationDays") && this.ScreenObject.Preferences["DontAllowExcessVacationDays"] != "" && parseBoolean(this.ScreenObject.Preferences["DontAllowExcessVacationDays"])) {
                    fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha11");
                    if (fldAPV2 != null && fldAPV2 instanceof PactTextBoxData) {
                        if (parseFloat(fldAPV2.Text) > 0) {
                            ValidationMessage = ValidationMessage + "Excess Vacation Days Cannot be Taken";
                        }
                    }
                }

                if (ValidationMessage != "")
                    return ValidationMessage;

                if (BaseService.SessionManager.Preferences.ContainsKey("AllowVacationifPayrollProcessedorLocked") && parseBoolean(BaseService.SessionManager.Preferences["AllowVacationifPayrollProcessedorLocked"] == "False")) {
                    ValidationMessage = this.IsDocLocked(sEmpID, dtFromDate, dtToDate, this.ScreenObject.DocumentType);
                }
                //Checking for Rejoining Dates for Leaves
                let dtC;
                let dtS: any = BaseService.common.GetDataSet("PAY020", "").Tables[0];
                if (dtS != null && dtS.length > 0) {
                    for (let i = 0; i < dtS.length; i++) {
                        dtC = BaseService.common.GetDataSet3("PAY021", sEmpID, dtS[i]["ComponentID"].toString()).Tables[0];
                        if (dtC != null && dtC.length > 0) {
                            ValidationMessage += "Please enter Rejoining date of this Employee to the Leave Type : " + dtS[i]["ComponentName"].toString();
                        }
                    }
                }

                if (!this.strVacXml.Contains("LAV")) {
                    let dtL: any = BaseService.report.GetDataTable("RPT059", sEmpID, dtFromDate.ToString("dd MMM yyyy"), dtToDate.ToString("dd MMM yyyy"));
                    if (dtL != null && dtL.length > 0) {
                        ValidationMessage += "Employee on leave for same period, Cannot save the record @VoucherNo - " + dtL[0]["VoucherNo"].toString();
                        return ValidationMessage;
                    }
                }

                fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha24");
                if (fldAPV2 != null && fldAPV2 instanceof PactComboBoxData && !Util.IsEmpty(fldAPV2.SelectedValue)) {
                    if (fldAPV2.SelectedValue.toString() == "Yes") {
                        fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha25");
                        if (fldAPV2 != null && fldAPV2 instanceof PactExtraFieldDateData && fldAPV2.Date && Util.Int(sEmpID) > 0) {
                            if (this.CheckIsPayrollProcessed(Util.ParseDate(fldAPV2.Date).ToString("dd/MMM/yyyy"), sEmpID)) {
                                ValidationMessage += "Cannot save the record, Payroll processed for the selected month";
                            }
                        }
                    }
                }
                if (!Util.IsEmpty(sEmpID) && parseInt(sEmpID) > 0) {
                    let dtPM = new Date(dtFromDate.getFullYear(), dtFromDate.getMonth(), 1);
                    let dt1 = BaseService.report.GetDataTable("AEDVACLeave", sEmpID, dtPM.ToString("dd/MMM/yyyy"));

                    if (dt1 != null && dt1.length > 0) {
                        let dt = BaseService.report.GetDataTable("AEDVACLeave01", sEmpID, dtToDate.ToString("dd MMM yyyy"));
                        if (dt != null && dt.length > 0) {
                            ValidationMessage += "Employee is on Notice Period,Cannot Apply Vacation";
                            return ValidationMessage;
                        }
                    }
                }
                if ((BaseService.SessionManager.Preferences.ContainsKey("VacationBasedOnContract") && parseInt(BaseService.SessionManager.Preferences["VacationBasedOnContract"]) > 0) ||
                    (this.ScreenObject.Preferences.ContainsKey("DontAllowVacationifVacationTakenforfuturedays") && this.ScreenObject.Preferences["DontAllowVacationifVacationTakenforfuturedays"] != "" && parseBoolean(this.ScreenObject.Preferences["DontAllowVacationifVacationTakenforfuturedays"]))) {
                    let fldAPV4: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                    if (fldAPV4 != undefined && fldAPV4 instanceof PactExtraFieldDateData && Util.IsEmpty(fldAPV4.Date)) {
                        let dt1 = BaseService.common.GetDataTable("DOC058", sEmpID + "~" + fldAPV4.Date.ToString("dd/MMM/yyyy") + "~" + this.ScreenObject.DocID);
                        if (dt1 != null && dt1.length > 0) {
                            ValidationMessage += "Cannot Apply Vacation, Employee has Already applied Vacation in future Date";
                        }
                    }
                }

            }
            else if (this.ScreenObject.DocumentType == 73) //Leave Adjustment as Vacation
            {
                let iSelCnt = 0;
                if (this.ScreenObject.GridData.length > 0) {
                    for (let s = 0; s < this.ScreenObject.GridData.length; s++) {
                        if (this.ScreenObject.GridData[s]["dcAlpha4"] != null && this.ScreenObject.GridData[s]["dcAlpha4"] != null && this.ScreenObject.GridData[s]["dcAlpha4"].toString().toUpperCase() == "YES")
                            iSelCnt++;
                    }
                }
                if (iSelCnt != 1) {
                    ValidationMessage = "Select only one document to adjust.";
                    return ValidationMessage;
                }
            }
            else if (this.ScreenObject.DocumentType == 74) //Incometax Definitions
            {
                ValidationMessage = this.GetITSlabValidation(1, null);
            }
            else if (this.ScreenObject.DocumentType == 57) //Recording Of Data
            {
                if (this.ScreenObject.Link.VouchersList.length == 0) {
                    ValidationMessage = ValidationMessage + "No loan link document available for the loan repayment";
                }
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (this.ScreenObject.GridData[k]["Rate"] != null && parseInt(this.ScreenObject.GridData[k]["Rate"]) < 0) {
                        ValidationMessage = ValidationMessage + "Please check the date for Paid On / Month ";
                        break;
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 55) //Loan Opening Balance
            {
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (this.ScreenObject.GridData[k]["Rate"] != null && parseInt(this.ScreenObject.GridData[k]["Rate"]) < 0) {
                        ValidationMessage = "Please check the deduction month";
                        break;
                    }
                    else if (this.ScreenObject.GridData[k]["dcCCnid51_Key"] != null && this.ScreenObject.GridData[k]["dcAlpha1_Key"] == null) {
                        ValidationMessage = "Please enter the deduction month";
                        break;
                    }
                    if (this.ScreenObject.GridData[k]["dcNum1"] != null && this.ScreenObject.GridData[k]["dcNum2"] != null) {
                        if (parseFloat(this.ScreenObject.GridData[k]["dcNum2"]) > parseFloat(this.ScreenObject.GridData[k]["dcNum1"])) {
                            ValidationMessage = "Opening balance amount should be less than loan amount";
                            break;
                        }
                        else if (this.ScreenObject.GridData[k]["dcNum3"] != null) {
                            if (parseFloat(this.ScreenObject.GridData[k]["dcNum3"]) == 0) {
                                ValidationMessage = "Please enter the installment amount";
                                break;
                            }
                            else if (parseFloat(this.ScreenObject.GridData[k]["dcNum3"]) > parseFloat(this.ScreenObject.GridData[k]["dcNum1"])) {
                                ValidationMessage = "Installment amount should be less than loan amount";
                                break;
                            }
                            else if (parseFloat(this.ScreenObject.GridData[k]["dcNum3"]) > parseFloat(this.ScreenObject.GridData[k]["dcNum2"])) {
                                ValidationMessage = "Installment amount should be less than opening balance amount";
                                break;
                            }

                        }

                    }
                }
                if (this.DocID > 0) {
                    let ds = this.ScreenObject.CheckLoanRepayAmountDetails(this.DocID);
                    if (ds.Tables.length > 0) {
                        if (ds.Tables[0].length > 0 && parseFloat(ds.Tables[0][0][0]) > 0)
                            ValidationMessage = "Can't update the linked document";
                    }
                }

            }
            else if (this.ScreenObject.DocumentType == 56) //Apply Loan
            {
                if (!BaseService.SessionManager.IsWebApplication) {
                    var fldAPL = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if (fldAPL && fldAPL instanceof PactListBoxData && Util.IsEmpty(fldAPL.Text))
                        ValidationMessage = "Please select the employee" + "\r\n";
                    else if (fldAPL && fldAPL instanceof PactCodeNameListBoxData && Util.IsEmpty(fldAPL.Text))
                        ValidationMessage = "Please select the employee" + "\r\n";

                    fldAPL = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
                    if (fldAPL && fldAPL instanceof PactListBoxData && Util.IsEmpty(fldAPL.Text))
                        ValidationMessage = ValidationMessage + "Please select the loan type" + "\r\n";

                    fldAPL = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                    if (fldAPL && fldAPL instanceof PactTextBoxData && ((fldAPL.Text.toString()) == "" || (fldAPL.Text.toString()) == "0"))
                        ValidationMessage = ValidationMessage + "Please enter the loan amount" + "\r\n";

                    ValidationMessage = ValidationMessage + this.IsDateValid(null, "");
                }

                let sEmpID = "0";

                var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld) {
                    if (vFld instanceof PactListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                }
                if (sEmpID == "0") {
                    ValidationMessage = "Select any Employee";
                }

                if (BaseService.SessionManager.Preferences.ContainsKey("DonotAllowApplyLoanDuringProbationPeriod") && parseBoolean(BaseService.SessionManager.Preferences["DonotAllowApplyLoanDuringProbationPeriod"])) {
                    let dtChk = BaseService.common.GetDataSet3("PAY022", this.ScreenObject.DocDate.Date.ToString("dd/MMM/yyyy"), sEmpID).Tables[0];
                    if (dtChk != null && dtChk.length > 0 && dtChk[0]["Valid"] != null && dtChk[0]["Valid"] != null && dtChk[0]["Valid"].toString() == "1") {
                        ValidationMessage = ValidationMessage + " Employee is in probation period, can not apply the Loan";
                    }
                }

            }
            else if (this.ScreenObject.DocumentType == 66) //Hours Chart
            {
                let dblTHrs = 24;
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (!Util.IsEmpty(ValidationMessage))
                        break;

                    for (let i = 1; i <= 12; i++) {
                        if (i == 6)
                            i = 8;

                        if (this.ScreenObject.GridData[k]["dcAlpha" + i] != null && parseFloat(this.ScreenObject.GridData[k]["dcAlpha" + i]) > 0 && (parseFloat(this.ScreenObject.GridData[k]["dcAlpha" + i]) > dblTHrs)) {
                            ValidationMessage = "Hours should be less than or equal to 24 hours at row no : " + this.ScreenObject.GridData[k]["DocSeqNo"].toString() + "\r\n";
                            break;
                        }
                    }
                    if (this.ScreenObject.GridData[k]["dcAlpha3"] != null && this.ScreenObject.GridData[k]["dcAlpha4"] != null) {
                        if (parseFloat(this.ScreenObject.GridData[k]["dcAlpha3"]) >= parseFloat(this.ScreenObject.GridData[k]["dcAlpha4"])) {
                            ValidationMessage = ValidationMessage + "Minimum hours half day should be less than minimum hours full day at row no : " + this.ScreenObject.GridData[k]["DocSeqNo"].toString() + "\r\n";
                            break;
                        }
                    }
                    if (this.ScreenObject.GridData[k]["dcAlpha4"] != null && this.ScreenObject.GridData[k]["dcAlpha5"] != null) {
                        if (parseFloat(this.ScreenObject.GridData[k]["dcAlpha4"]) >= parseFloat(this.ScreenObject.GridData[k]["dcAlpha5"])) {
                            ValidationMessage = ValidationMessage + "Minimum hours full day should be less than maximum hours per day at row no : " + this.ScreenObject.GridData[k]["DocSeqNo"].toString() + "\r\n";
                            break;
                        }
                    }
                    if (this.ScreenObject.GridData[k]["dcAlpha6_Key"] != null) {
                        if (Util.ParseDate(this.DocumentDate) > Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha6_Key"]) && this.ScreenObject.Preferences.ContainsKey("IgnoreDocumentDateValidation") && !parseBoolean(this.ScreenObject.Preferences["IgnoreDocumentDateValidation"])) {
                            ValidationMessage = "Document Date should be less than or equal to WEF Date";
                            break;
                        }
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 52) //General Timings
            {
                var fldGT = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                if (fldGT != null && fldGT instanceof PactExtraFieldDateData && fldGT.Date) {
                    if (Util.ParseDate(this.DocumentDate) > fldGT.Date.OnlyDate() && this.ScreenObject.Preferences.ContainsKey("IgnoreDocumentDateValidation") && !parseBoolean(this.ScreenObject.Preferences["IgnoreDocumentDateValidation"]))
                        ValidationMessage = "Document Date should be less than or equal to WEF Date";
                }

            }
            else if (this.ScreenObject.DocumentType == 53) //Weekly Offs
            {
                if (this.ScreenObject.DueDate.Date == null) {
                    ValidationMessage = "Please enter the  " + this.ScreenObject.DueDate.Label + "\r\n";
                }
                else {
                    if (Util.ParseDate(this.DocumentDate) > Util.ParseDate(this.ScreenObject.DueDate.Date) && this.ScreenObject.Preferences.ContainsKey("IgnoreDocumentDateValidation") && !parseBoolean(this.ScreenObject.Preferences["IgnoreDocumentDateValidation"])) {
                        ValidationMessage = "Document Date should be less than or equal to W.E.F Date";
                    }
                }
            }
            else if (this.ScreenObject.DocumentType == 63) //Consolidated Leaves
            {
                let dtSelectedmonth = new Date();
                var fldCSL = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                if (fldCSL != null && fldCSL instanceof PactExtraFieldDateData && fldCSL.Date) {
                    dtSelectedmonth = fldCSL.Date;
                }
                else {
                    this.DisplayMessage = "Please select the payroll month";
                    this.MessageVisibility = true;
                    return this.DisplayMessage;
                }

                this.lstLastLeaveDate = new Dictionary<any>();
                let sEmpID = "", sEmpIDs = "";

                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && this.ScreenObject.GridData[i]["ProductID_Key"] != null && this.ScreenObject.GridData[i]["ProductID_Key"] != null && this.ScreenObject.GridData[i]["ProductID_Key"].toString() != "") {
                        sEmpID = "";

                        vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (vFld != undefined) {
                            if (vFld instanceof PactListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                        }
                        else {
                            var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                            if (vFld2 != undefined && this.ScreenObject.GridData[i][vFld2.ValueMember] != null && this.ScreenObject.GridData[i][vFld2.ValueMember] != null && this.ScreenObject.GridData[i][vFld2.ValueMember].toString() != "")
                                sEmpID = this.ScreenObject.GridData[i][vFld2.ValueMember].toString();
                        }
                        if (sEmpIDs.length > 0)
                            sEmpIDs += ",";

                        sEmpIDs += sEmpID;

                    }
                }
                let dsCCData = null;
                let dsEmpInfo = null;
                if (!Util.IsEmpty(sEmpIDs) && sEmpIDs.length > 0 && this.ScreenObject.Preferences.ContainsKey("PickFromandToDateAutomatically") && this.ScreenObject.Preferences["PickFromandToDateAutomatically"] != "" && parseBoolean(this.ScreenObject.Preferences["PickFromandToDateAutomatically"])) {
                    let sFilter = "";

                    sFilter += "  AND EmpSeqNo IN (" + sEmpIDs + ")";

                    let ObjArray = [];
                    ObjArray.push(dtSelectedmonth.ToString("dd MMM yyyy"));
                    ObjArray.push(sFilter);
                    ObjArray.push(0);
                    ObjArray.push(BaseService.SessionManager.RoleID);
                    ObjArray.push(BaseService.SessionManager.UserID);
                    ObjArray.push(BaseService.SessionManager.LanguageID);

                    dsCCData = BaseService.common.GetDataSet_SP(ObjArray, "spPAY_GetEmpMasterCCDetails");

                    let dtPM: Date = new Date(), dtPMS = new Date(), dtPME = new Date();
                    dtPM = dtSelectedmonth;
                    let refObj = { PayrollMonth: dtPM, PayrollMonthStart: dtPMS, PayrollMonthEnd: dtPME }
                    Util.SetPayrollDate(dtPM, refObj);
                    dtPM = refObj.PayrollMonth
                    dtPMS = refObj.PayrollMonthStart
                    dtPME = refObj.PayrollMonthEnd
                    dsEmpInfo = BaseService.common.GetDataSet3("PAY115", sEmpIDs, "" + dtPM.ToString("dd/MMM/yyyy") + "~" + dtPMS.ToString("dd/MMM/yyyy") + "~" + dtPME.ToString("dd/MMM/yyyy") + "");
                }

                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[k]["ProductID_Key"])) {
                        sEmpID = "";
                        let sLeaveTypeID: string = "";
                        vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (vFld != undefined) {
                            if (vFld instanceof PactListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                        }
                        else {
                            var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                            if (vFld2 != undefined && this.ScreenObject.GridData[k][vFld2.ValueMember] != null && this.ScreenObject.GridData[k][vFld2.ValueMember] != null && this.ScreenObject.GridData[k][vFld2.ValueMember].toString() != "")
                                sEmpID = this.ScreenObject.GridData[k][vFld2.ValueMember].toString();
                        }

                        vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid52");
                        if (vFld != undefined) {
                            if (vFld instanceof PactListBoxData)
                                sLeaveTypeID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sLeaveTypeID = vFld.SelectedValue.toString();
                        }
                        else {
                            var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid52_key");
                            if (vFld2 != undefined && this.ScreenObject.GridData[k][vFld2.ValueMember] != null && this.ScreenObject.GridData[k][vFld2.ValueMember] != null && this.ScreenObject.GridData[k][vFld2.ValueMember].toString() != "")
                                sLeaveTypeID = this.ScreenObject.GridData[k][vFld2.ValueMember].toString();
                        }


                        if (!Util.IsEmpty(sEmpIDs) && sEmpIDs.length > 0 && this.ScreenObject.Preferences.ContainsKey("PickFromandToDateAutomatically") && this.ScreenObject.Preferences["PickFromandToDateAutomatically"] != "" && parseBoolean(this.ScreenObject.Preferences["PickFromandToDateAutomatically"])) {

                            let dtColData = BaseService.common.GetDataSet3("PAY116", (dtSelectedmonth.getMonth() + 1).ToString(), dtSelectedmonth.getFullYear().ToString());

                            if (dtColData != null && dtColData.Tables[0].length > 0) {
                                ValidationMessage = "Cannot Allow more than one document for same month";
                                break;
                            }
                            this.ConsolidatedLeavesAddDates(k, dtSelectedmonth, sEmpID, dsCCData, parseInt(sLeaveTypeID), dsEmpInfo);

                        }


                        if (this.ScreenObject.GridData[k]["dcCCNID51_Key"] != null && this.ScreenObject.GridData[k]["dcCCNID52_Key"] != null) {
                            if (this.ScreenObject.GridData[k]["dcAlpha4_Key"] != null) {
                                if (Util.ParseDate(this.DocumentDate) > Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"]) && this.ScreenObject.Preferences.ContainsKey("IgnoreDocumentDateValidation") && !parseBoolean(this.ScreenObject.Preferences["IgnoreDocumentDateValidation"])) {
                                    ValidationMessage = "Document Date should be less than or equal to From Date";
                                    break;
                                }
                            }
                            if (this.ScreenObject.GridData[k]["dcAlpha7"] != null) {
                                dblIsValidDays = parseFloat(this.ScreenObject.GridData[k]["dcAlpha7"]);
                                if (dblIsValidDays <= 0) {
                                    ValidationMessage = "Dates already applied | Selected dates between holidays or weeklyoffs dates(Employee - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID51"]) + ",LeaveType - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID52"]) + ",@RowNo - " + Util.String(this.ScreenObject.GridData[k]["DocSeqNo"]) + ")";
                                    break;
                                }
                            }

                            if (this.ScreenObject.GridData[k]["dcNum1"] != null && this.ScreenObject.GridData[k]["dcAlpha4_key"] != null && this.ScreenObject.GridData[k]["dcAlpha5_key"] != null) {
                                if (parseFloat(this.ScreenObject.GridData[k]["dcNum1"]) <= 0) {
                                    ValidationMessage = "Dates already applied | Selected dates between Holidays/Weeklyoffs(Employee - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID51"]) + ",LeaveType - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID52"]) + ",@RowNo - " + Util.String(this.ScreenObject.GridData[k]["DocSeqNo"]) + ")";
                                    break;
                                }
                            }

                            if (this.ScreenObject.GridData[k]["dcAlpha8"] != null && (parseInt(this.ScreenObject.GridData[k]["dcAlpha8"]) >= 0 || parseInt(this.ScreenObject.GridData[k]["dcAlpha8"]) == -4)) {
                                if (this.ScreenObject.GridData[k]["dcAlpha3"] != null) {
                                    dblIsValidDays = parseFloat(this.ScreenObject.GridData[k]["dcAlpha3"]);
                                    if (dblIsValidDays <= 0) {
                                        ValidationMessage = "Please check the Payroll structure/Available leaves for the selected month";
                                        ValidationMessage = "Please check the Payroll structure/Available leaves for the selected month(Employee - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID51"]) + ",LeaveType - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID52"]) + ",@RowNo - " + Util.String(this.ScreenObject.GridData[k]["DocSeqNo"]) + ")";
                                        break;
                                    }
                                }
                                if (this.ScreenObject.GridData[k]["dcNum1"] != null && this.ScreenObject.GridData[k]["dcAlpha7"] != null) {
                                    if (parseFloat(this.ScreenObject.GridData[k]["dcNum1"]) > parseFloat(this.ScreenObject.GridData[k]["dcAlpha3"])) {
                                        ValidationMessage = "Cannot apply leaves more than Available leaves(Employee - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID51"]) + ",LeaveType - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID52"]) + ",@RowNo - " + Util.String(this.ScreenObject.GridData[k]["DocSeqNo"]) + ")";
                                        break;
                                    }
                                }
                            }

                            if (Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha6"]) || Util.String(this.ScreenObject.GridData[k]["dcAlpha6"]) == "1" || Util.String(this.ScreenObject.GridData[k]["dcAlpha6"]) == "2" || Util.String(this.ScreenObject.GridData[k]["dcAlpha6"]) == "3") {
                                ValidationMessage = "Please select the session type(Employee - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID51"]) + ",LeaveType - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID52"]) + ",@RowNo - " + Util.String(this.ScreenObject.GridData[k]["DocSeqNo"]) + ")";
                                break;
                            }
                            if (this.ScreenObject.GridData[k]["dcAlpha4_Key"] != null && this.ScreenObject.GridData[k]["dcAlpha5_Key"] != null) {
                                if (Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_Key"]).ToString("MMM/yyyy") != Util.ParseDate(dtSelectedmonth).ToString("MMM/yyyy")) {
                                    ValidationMessage = "From date should be from payroll month(Employee - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID51"]) + ",LeaveType - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID52"]) + ",@RowNo - " + Util.String(this.ScreenObject.GridData[k]["DocSeqNo"]) + ")";
                                    break;
                                }
                                else if (Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_Key"]).ToString("MMM/yyyy") != Util.ParseDate(dtSelectedmonth).ToString("MMM/yyyy")) {
                                    ValidationMessage = "To date should be from payroll month(Employee - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID51"]) + ",LeaveType - " + Util.String(this.ScreenObject.GridData[k]["dcCCNID52"]) + ",@RowNo - " + Util.String(this.ScreenObject.GridData[k]["DocSeqNo"]) + ")";
                                    break;
                                }
                            }
                        }
                    }
                }

            }


            //Start : For checking the total NoofDays for each leavetype with available, AtAtime and Maxleaves
            if (this.ScreenObject.DocumentType == 62 && this.ScreenObject.GridData.length > 0) {
                let strApplyLeavesMsg = "";
                let drr;
                let dblLeavesTaken = 0, dblTotalLeaves = 0, dblDocLeaves = 0, dblAtATime = 0;

                let arrTemp = this.ScreenObject.GridData.filter(x => !Util.IsEmpty(x.dcCCNID52))
                let ApplyLeaveResult = []
                for (let l = 0; l < arrTemp.length; l++) {
                    let dr = ApplyLeaveResult.find(x => x.LQLeaveType == arrTemp[l].dcCCNID52);
                    if (!dr) {
                        let obj = {
                            "LQLeaveType": arrTemp[l].dcCCNID52,
                            "LQTotNoofDays": Util.Double(arrTemp[l]["dcAlpha7"]),
                            "LQAssignedDays": Util.Double(arrTemp[l]["dcAlpha2"]),
                            "LQAvlblDays": Util.Double(arrTemp[l]["dcAlpha3"]),
                            "LQAtATime": Util.Double(arrTemp[l]["dcAlpha8"]),
                            "LQMaxLeaves": Util.Double(arrTemp[l]["dcAlpha9"])
                        }
                        ApplyLeaveResult.push(obj);
                    }
                    else {
                        dr["LQTotNoofDays"] = Util.Double(dr["LQTotNoofDays"]) + Util.Double(arrTemp[l]["dcAlpha7"])
                    }
                }

                for (let m = 0; m < ApplyLeaveResult.length; m++) {
                    let row = ApplyLeaveResult[m]
                    dblLeavesTaken = dblTotalLeaves = dblDocLeaves = 0;
                    dblAtATime = Math.abs(parseFloat(row.LQAtATime));
                    //-1 LOP (No AtATime days validation) / -5 LOP, -3 Entire Service only once, -4 Leaves should be less than assigned leaves - (AtATime days validation)/
                    //if (row.LQMaxLeaves != -1) {
                    if (row.LQAtATime < 0) {
                        if (row.LQTotNoofDays < dblAtATime)
                            strApplyLeavesMsg = strApplyLeavesMsg + "Apply minimum " + dblAtATime + " days for this Leave Type" + "\r\n";
                    }
                    else {
                        if (row.LQTotNoofDays > dblAtATime)
                            strApplyLeavesMsg = strApplyLeavesMsg + "Can't Apply leaves more than AtATime leaves(" + row.LQAtATime + ") for leave type '" + row.LQLeaveType + "'\r\n";
                    }
                    //}
                    if (row.LQTotNoofDays <= 0)
                        strApplyLeavesMsg = strApplyLeavesMsg + "Please check the NoOfDays for leave type '" + row.LQLeaveType + "'\r\n";

                    if (row.LQMaxLeaves >= 0) {
                        if (row.LQTotNoofDays > row.LQAvlblDays)
                            strApplyLeavesMsg = strApplyLeavesMsg + "Can't Apply leaves more than available leaves(" + row.LQAvlblDays + ") for leave type '" + row.LQLeaveType + "'\r\n";
                    }
                    else if (row.LQMaxLeaves == -3)//Entire Service Days
                    {
                        var fldApl = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (fldApl && ((fldApl instanceof PactListBoxData && !Util.IsEmpty(fldApl.Text)) || (fldApl instanceof PactCodeNameListBoxData && !Util.IsEmpty(fldApl.Text)))) {
                            let sQ = ""
                            if (fldApl instanceof PactListBoxData)
                                sQ = sQ + " AND CC.dccCNID51= " + fldApl.SelectedValue + "";
                            else if (fldApl instanceof PactCodeNameListBoxData)
                                sQ = sQ + " AND CC.dccCNID51= " + fldApl.SelectedValue + "";

                            drr = this.ScreenObject.GridData.filter(x => x.dccCNID52 == row.LQLeaveType.toString() && x.dcAlpha9 == row.LQMaxLeaves);
                            if (drr.length > 0)
                                sQ = sQ + " AND CC.dccCNID52= " + parseInt(drr[0]["dccCNID52_Key"]) + "";

                            let dsApl = BaseService.common.GetDataSet3("PAY023", this.DocID.toString(), sQ);
                            if (dsApl != null && dsApl.Tables[0].length > 0 && parseInt(dsApl.Tables[0][0][0]) > 0)
                                strApplyLeavesMsg = strApplyLeavesMsg + "Can't apply morethan once in your Service for this Leave type";
                        }
                    }
                    else if (row.LQMaxLeaves == -4)//Lessthan Assigned Leaves
                    {
                        drr = this.ScreenObject.GridData.filter(x => x.dccCNID52 == row.LQLeaveType.toString() && x.dcAlpha9 == row.LQMaxLeaves);
                        if (drr.length > 0) {
                            let LeaveYearStartmonth = new Date(parseInt(Util.ParseDate(drr[0]["dcAlpha4_Key"]).ToString("yyyy")), parseInt(BaseService.SessionManager.Preferences["LeaveYear"].toString()), 1);
                            let LeaveYearEndmonth = LeaveYearStartmonth.AddMonths(12).AddDays(-1);
                            var fldApl = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                            if (fldApl && (fldApl instanceof PactListBoxData && !Util.IsEmpty(fldApl.Text) || fldApl instanceof PactCodeNameListBoxData && !Util.IsEmpty(fldApl.Text))) {
                                let ObjArray = [];
                                ObjArray.push(LeaveYearStartmonth.ToString("dd/MMM/yyyy"));
                                ObjArray.push(LeaveYearEndmonth.ToString("dd/MMM/yyyy"));
                                if (fldApl instanceof PactListBoxData)
                                    ObjArray.push(fldApl.SelectedValue);
                                else if (fldApl instanceof PactCodeNameListBoxData)
                                    ObjArray.push(fldApl.SelectedValue);
                                ObjArray.push(parseInt(drr[0]["dccCNID52_Key"]));
                                ObjArray.push("Both");
                                ObjArray.push(BaseService.SessionManager.UserID);
                                ObjArray.push(BaseService.SessionManager.LanguageID);
                                let DS = BaseService.common.GetDataSet_SP(ObjArray, "spPAY_ExtGetAvlblNoofDays");
                                if (DS != null && DS.Tables.length > 0 && DS.Tables[0].length > 0) {
                                    if (!Util.IsEmpty(DS.Tables[0][0]["LeavesTaken"]))
                                        dblLeavesTaken = parseFloat(DS.Tables[0][0]["LeavesTaken"]);
                                    if (this.DocID > 0) {
                                        let sQ = ""
                                        if (fldApl instanceof PactListBoxData)
                                            sQ = sQ + " AND CC.dccCNID51= " + fldApl.SelectedValue + "";
                                        else if (fldApl instanceof PactCodeNameListBoxData)
                                            sQ = sQ + " AND CC.dccCNID51= " + fldApl.SelectedValue + "";

                                        if (drr.length > 0)
                                            sQ = sQ + " AND CC.dccCNID52= " + parseInt(drr[0]["dccCNID52_Key"]) + "";

                                        let dsApl = BaseService.common.GetDataSet3("PAY024", this.DocID.toString(), sQ);
                                        if (dsApl != null && dsApl.Tables[0].length > 0 && parseInt(dsApl.Tables[0][0][0]) > 0)
                                            dblDocLeaves = parseFloat(dsApl.Tables[0][0]["NoofDays"]);
                                    }

                                    dblLeavesTaken = dblLeavesTaken - dblDocLeaves;
                                    dblTotalLeaves = dblLeavesTaken + parseFloat(row.LQTotNoofDays);
                                }
                                if (dblTotalLeaves > row.LQAssignedDays)
                                    strApplyLeavesMsg = strApplyLeavesMsg + "Can't Apply leaves more than Assigned leaves(" + row.LQAssignedDays + ") for leave type '" + row.LQLeaveType + "'\r\n";
                            }
                        }
                    }
                }

                if (strApplyLeavesMsg != "") {
                    this.DisplayMessage = strApplyLeavesMsg;
                    this.MessageVisibility = true;
                    return strApplyLeavesMsg;
                }
            }
            //End : For checking the total NoofDays for each leavetype with available, AtAtime and Maxleaves Dec2016
            //Start: Apply loan
            if (this.ScreenObject.DocumentType == 56 && (this.strEmpIsMgr.toString() != "No")) {// && !BaseService.SessionManager.IsWebApplication)) {
                let txtfld:any = this.ScreenObject._TextFields.filter(a => a instanceof PactTextBoxData).find(a => a.DBColumnName.toLowerCase() == "dcalpha4"); //No of installments from header
                if (txtfld) {
                    if (parseFloat((txtfld as PactTextBoxData).Text) == 0) {
                        this.DisplayMessage = "Please Distribute Installments. No of Installments should be Grater Than 0";
                        this.MessageVisibility = true;
                        return this.DisplayMessage;
                    }

                    if (this.ScreenObject.GridData.length > 0) {
                        let strApplyLoanMsg = "";
                        let dblLoanAmount, dblApprovedloanamount, dblTotalLoanPaidAmount, dblInstAmount;
                        dblLoanAmount = dblApprovedloanamount = dblTotalLoanPaidAmount = dblInstAmount = 0;

                        let dtHeadDedMonth = new Date(), dtLineDedMonth = new Date();

                        let sEmpID = "0";

                        var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (vFld) {
                            if (vFld instanceof PactListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                        }

                        txtfld = this.ScreenObject._TextFields.filter(a => a instanceof PactExtraFieldDateData).find(a => a.DBColumnName.toLowerCase() == "dcalpha5") as PactExtraFieldDateData; //Header wise Deduction Month
                        if (txtfld)
                            dtHeadDedMonth = Util.ParseDate((txtfld as PactExtraFieldDateData).Date);

                        if (this.ScreenObject.GridDataColumns.Contains("dcAlpha6_Key") && this.ScreenObject.GridData.length > 0) //Line wise Deduction Month
                        {
                            if (this.ScreenObject.GridData[0]["dcAlpha6_Key"] != null && this.ScreenObject.GridData[0]["dcAlpha6_Key"] != null && this.ScreenObject.GridData[0]["dcAlpha6_Key"].toString().Trim() != "") {
                                dtLineDedMonth = Util.ParseDate(this.ScreenObject.GridData[0]["dcAlpha6_Key"]);
                            }
                        }

                        if (dtHeadDedMonth.getMonth() != dtLineDedMonth.getMonth() || dtHeadDedMonth.getFullYear() != dtLineDedMonth.getFullYear()) {
                            strApplyLoanMsg = "Distribute Installments, Deduction Month should be same in Header and Line wise. " + "\r\n";
                            this.DisplayMessage = strApplyLoanMsg;
                            this.MessageVisibility = true;
                            return strApplyLoanMsg;
                        }

                        txtfld = this.ScreenObject._TextFields.filter(a => a instanceof PactTextBoxData).find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                        if (txtfld)
                            dblLoanAmount = parseFloat((txtfld as PactTextBoxData).Text);

                        txtfld = this.ScreenObject._TextFields.filter(a => a instanceof PactTextBoxData).find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                        if (txtfld)
                            dblApprovedloanamount = parseFloat((txtfld as PactTextBoxData).Text);

                        txtfld = this.ScreenObject._TextFields.filter(a => a instanceof PactTextBoxData).find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                        if (txtfld)
                            dblInstAmount = parseFloat((txtfld as PactTextBoxData).Text);

                        if (dblApprovedloanamount > dblLoanAmount) {
                            strApplyLoanMsg = "Approved loan amount should be less than or equal to Loan Amount" + "\r\n";
                            this.DisplayMessage = strApplyLoanMsg;
                            this.MessageVisibility = true;
                            return strApplyLoanMsg;
                        }
                        if (parseFloat(this.ScreenObject.GridData.Compute("sum", "dcNum2")) != parseFloat(dblApprovedloanamount.ToString("N2"))) {
                            strApplyLoanMsg = strApplyLoanMsg + "Total Installment(s) amount should be equal to Approved Amount" + "\r\n";
                            this.DisplayMessage = strApplyLoanMsg;
                            this.MessageVisibility = true;
                            return strApplyLoanMsg;
                        }
                        if (dblInstAmount > dblApprovedloanamount) {
                            strApplyLoanMsg = strApplyLoanMsg + "Installment amount should be less than or equal to approved amount" + "\r\n";
                            this.DisplayMessage = strApplyLoanMsg;
                            this.MessageVisibility = true;
                            return strApplyLoanMsg;
                        }

                        for (let l = 0; l < this.ScreenObject.GridData.length; l++) {
                            if (this.ScreenObject.GridData[l]["dcAlpha6_Key"] != null && this.ScreenObject.GridData[l]["dcAlpha6_Key"] != null && this.ScreenObject.GridData[l]["dcAlpha6_Key"].toString().Trim() != "") {
                                ValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(this.ScreenObject.GridData[l]["dcAlpha6_Key"]), Util.ParseDate(this.ScreenObject.GridData[l]["dcAlpha6_Key"]), this.ScreenObject.DocumentType);
                                if (ValidationMessage != "")
                                    break;
                                if (this.DocID > 0) {
                                    this.dsData = this.ScreenObject.CheckLoanRepayAmountDetails(this.DocID);
                                    let dvApplyLoan = this.dsData.Tables[1].filter(x => x.LinkedInvDocDetailsID == parseInt(this.ScreenObject.GridData[l]["DocDetailsID"]));

                                    if (dvApplyLoan.length == 0 && this.CheckIsPayrollProcessed(Util.ParseDate(this.ScreenObject.GridData[l]["dcAlpha6_Key"]).ToString("dd/MMM/yyyy"), sEmpID)) {
                                        strApplyLoanMsg = strApplyLoanMsg + "Payroll already processed for the Month : " + Util.ParseDate(this.ScreenObject.GridData[l]["dcAlpha6_Key"]).ToString("MMM/yyyy") + " to this Employee " + "\r\n";
                                        break;
                                    }
                                }
                                else {
                                    if (this.CheckIsPayrollProcessed(Util.ParseDate(this.ScreenObject.GridData[l]["dcAlpha6_Key"]).ToString("dd/MMM/yyyy"), sEmpID)) {
                                        strApplyLoanMsg = strApplyLoanMsg + "Payroll already processed for the Month : " + Util.ParseDate(this.ScreenObject.GridData[l]["dcAlpha6_Key"]).ToString("MMM/yyyy") + " to this Employee " + "\r\n";
                                        break;
                                    }
                                }

                            }
                        }

                        if (this.DocID > 0) {
                            let ds = this.ScreenObject.CheckLoanRepayAmountDetails(this.DocID);
                            if (ds.Tables.length > 0) {
                                if (ds.Tables[0].length > 0) {
                                    dblTotalLoanPaidAmount = parseFloat(ds.Tables[0][0][0]);
                                    if (dblTotalLoanPaidAmount > 0 && dblApprovedloanamount < dblTotalLoanPaidAmount) {
                                        strApplyLoanMsg = strApplyLoanMsg + "Can't change the approved loan amount of linked document" + "\r\n";
                                    }
                                }
                            }
                        }

                        if (strApplyLoanMsg != "") {
                            this.DisplayMessage = strApplyLoanMsg;
                            this.MessageVisibility = true;
                            return strApplyLoanMsg;
                        }
                    }
                }
            }
            //End: Apply loan

            //Start : For checking the MaxEncashdays
            if (this.ScreenObject.DocumentType == 58 && this.ScreenObject.GridData.length > 0) {

                let strLeavesencashMsg = "";
                let arrTemp = this.ScreenObject.GridData.filter(x => !Util.IsEmpty(x.dcCCNID52))
                let LeavesEncashResult = []
                for (let l = 0; l < arrTemp.length; l++) {
                    let dr = LeavesEncashResult.find(x => x.LQLeaveType == arrTemp[l].dcCCNID52);
                    if (!dr) {
                        let obj = {
                            "LQLeaveType": arrTemp[l].dcCCNID52,
                            "LQTotAppliedDays": Util.Double(arrTemp[l]["dcAlpha3"]),
                            "LQAvlblDays": Util.Double(arrTemp[l]["dcAlpha1"]),
                            "LQMaxEncash": Util.Double(arrTemp[l]["dcAlpha2"]),
                            "LQAppliedDays": Util.Double(arrTemp[l]["dcAlpha5"]),
                            "LQThresholdLimit": Util.Double(arrTemp[l]["dcAdcAlpha8lpha9"])
                        }
                        LeavesEncashResult.push(obj);
                    }
                    else {
                        dr["LQTotAppliedDays"] = Util.Double(dr["LQTotAppliedDays"]) + Util.Double(arrTemp[l]["dcAlpha3"])
                    }
                }


                /***var LeavesEncashResult = from LeaveEncash in this.ScreenObject.GridData.AsEnumerable()
                                         where LeaveEncash.Field<string>("dcCCNID52") != null && LeaveEncash.Field<string>("dcCCNID52").toString() != ""
                                         group LeaveEncash by LeaveEncash.Field<string>("dcCCNID52") into LeaveTypeGrp

                                         select new
                                         {
                                             LQLeaveType = LeaveTypeGrp.Key,
                                             LQTotAppliedDays = LeaveTypeGrp.Sum(r => r.Field<Double?>("dcAlpha3")),
                                             LQAvlblDays = LeaveTypeGrp.FirstOrDefault().Field<Double?>("dcAlpha1"),
                                             LQMaxEncash = LeaveTypeGrp.FirstOrDefault().Field<Double?>("dcAlpha2"),
                                             LQAppliedDays = LeaveTypeGrp.FirstOrDefault().Field<Double?>("dcAlpha5"),
                                             LQThresholdLimit = LeaveTypeGrp.FirstOrDefault().Field<Double?>("dcAlpha8")

                                         };
***/
                for (let n = 0; n < LeavesEncashResult.length; n++) {
                    let row = LeavesEncashResult[n]
                    if (row.LQAppliedDays < 0) {
                        strLeavesencashMsg = strLeavesencashMsg + "Please check the applied days for leave type '" + row.LQLeaveType + "'\r\n";
                    }

                    let dME = 0;
                    dME = (row.LQAvlblDays - row.LQThresholdLimit);
                    if (dME < 0) dME = 0;
                    if (dME > row.LQMaxEncash)
                        dME = row.LQMaxEncash;

                    if (row.LQTotAppliedDays > dME)
                        strLeavesencashMsg = strLeavesencashMsg + "You can not Encash more than ( " + dME + " ) Days for leave type '" + row.LQLeaveType + "'\r\n";

                    //if (row.LQTotAppliedDays > row.LQAvlblDays)
                    //{
                    //    strLeavesencashMsg = strLeavesencashMsg + "Encash days should be less than available days(" + row.LQAvlblDays + ") for leave type '" + row.LQLeaveType + "'\r\n";
                    //}
                    //if (row.LQTotAppliedDays > row.LQMaxEncash)
                    //{
                    //    strLeavesencashMsg = strLeavesencashMsg + "Encash days should be less than maxencash days(" + row.LQMaxEncash + ") for leave type '" + row.LQLeaveType + "'\r\n";
                    //}
                }


                if (strLeavesencashMsg != "") {
                    this.DisplayMessage = strLeavesencashMsg;
                    this.MessageVisibility = true;
                    return strLeavesencashMsg;
                }
            }
            //End : For checking the MaxEncashdays

            //#region Daily Attendance

            if (this.ScreenObject.DocumentType == 67) {
                let sDailyAttDate = "", sEmpID = "1";
                let drw = null;


                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && this.ScreenObject.GridData[i]["ProductID_Key"] != null && this.ScreenObject.GridData[i]["ProductID_Key"] != null && this.ScreenObject.GridData[i]["ProductID_Key"].toString() != "") {
                        sDailyAttDate = ""; sEmpID = "1";
                        drw = this.ScreenObject.GridData[i];

                        let vFld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                        if (vFld != undefined)
                            sDailyAttDate = vFld.Date.ToString("dd/MMM/yyyy");
                        else {
                            var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                            if (vFld2 != undefined && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                                sDailyAttDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");
                        }

                        vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (vFld != undefined) {
                            if (vFld instanceof PactListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                        }
                        else {
                            var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                            if (vFld2 != undefined && drw[vFld2.ValueMember] != null && drw[vFld2.ValueMember] != null && drw[vFld2.ValueMember].toString() != "")
                                sEmpID = drw[vFld2.ValueMember].toString();
                        }

                        this.drcc1 = this.dtPayEmps.filter(x => x.NodeID == sEmpID);

                        if (sDailyAttDate != "" && parseInt(sEmpID) > 1) {
                            //#region Check Payroll Month Locked or Not.?

                            ValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(sDailyAttDate), Util.ParseDate(sDailyAttDate), this.ScreenObject.DocumentType);
                            if (ValidationMessage != "") {
                                if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && !Util.IsEmpty(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"]) && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                    this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + ValidationMessage + "\"></Row>";
                                    //this.sBioErrLogs += "\r\n " + ValidationMessage + "\r\n ";
                                    this.ScreenObject.GridDataObj.removeRowAt(i);
                                    i--;
                                    continue;
                                }
                                else if (this.isDAValidate) {
                                    this.sDAErrLogs += "\r\n " + ValidationMessage + "\r\n ";
                                    ValidationMessage = "";
                                    continue;
                                }
                                else
                                    break;
                            }


                            //#endregion

                            //#region Validating Hours based on Hours Def. Chart

                            let dtHrsDef: any = null;
                            dtHrsDef = this.GetHoursDefChart(sDailyAttDate, drw);
                            if (dtHrsDef != null && dtHrsDef.length > 0) {
                                let dtdbl = Date.Today(), dtdblOld = Date.Today();
                                let ts1, ts2;
                                this.drcc1 = this.dtPayEmps.filter(x => x.NodeID == sEmpID);
                                let sVoucherNo = "";
                                let refObjdt = { dtdblOld: dtdblOld, sVoucherNo: sVoucherNo };
                                //Total Hours
                                this.GetTotalEnteredHours(sEmpID, sDailyAttDate, "dcNum1", refObjdt);
                                dtdblOld = refObjdt.dtdblOld;
                                sVoucherNo = refObjdt.sVoucherNo;
                                this.sHrs = parseFloat(dtHrsDef[0]["MaxHrsPerDay"]).ToTime("00.00").split('.');
                                dtdbl = dtdbl.AddHours(parseFloat(this.sHrs[0])).AddMinutes(parseFloat(this.sHrs[1]));
                                ts1 = new TimeSpan(dtdbl.ToNumber());
                                ts2 = new TimeSpan(dtdblOld.ToNumber());
                                if (ts2.TotalHours > ts1.TotalHours) {
                                    if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                        this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + "'Total Hours' per day Exceeded for an Employee - " + Util.String(this.drcc1[0]["Code"]) + sVoucherNo + "\"></Row>";
                                        //this.sBioErrLogs += "\r\n " + "'Total Hours' per day Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        this.ScreenObject.GridDataObj.removeRowAt(i);
                                        i--;
                                        continue;
                                    }
                                    else if (this.isDAValidate) {
                                        this.sDAErrLogs += "\r\n " + "'Total Hours' per day Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        continue;
                                    }
                                    else {
                                        this.DisplayMessage = "'Total Hours' per day Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo;
                                        this.MessageVisibility = true;
                                        return this.DisplayMessage;
                                    }
                                }

                                //Normal Working Hours
                                dtdbl = Date.Today();
                                refObjdt = { dtdblOld: dtdblOld, sVoucherNo: sVoucherNo };
                                this.GetTotalEnteredHours(sEmpID, sDailyAttDate, "dcNum2", refObjdt);
                                dtdblOld = refObjdt.dtdblOld;
                                sVoucherNo = refObjdt.sVoucherNo;
                                this.sHrs = parseFloat(dtHrsDef[0]["NormalHrs"]).ToTime("00.00").split('.');
                                dtdbl = dtdbl.AddHours(parseFloat(this.sHrs[0])).AddMinutes(parseFloat(this.sHrs[1]));
                                ts1 = new TimeSpan(dtdbl.valueOf());
                                ts2 = new TimeSpan(dtdblOld.valueOf());

                                //Logger.DebugLog("dtdbl=" + dtdbl.toString() + " :: dtdblOld=" + dtdblOld.toString());
                                //Logger.DebugLog("dtdbl.ToNumber()=" + dtdbl.ToNumber() + " :: dtdblOld.ToNumber()=" + dtdblOld.ToNumber());
                                //Logger.DebugLog("ts2.TotalHours=" + ts2.TotalHours + " :: ts1.TotalHours=" + ts1.TotalHours);
                                //Logger.DebugLog((ts2.TotalHours > ts1.TotalHours).toString());
                                //Logger.DebugLog((parseFloat(ts2.TotalHours) > parseFloat(ts1.TotalHours)).toString());

                                if (parseFloat(ts2.TotalHours) > parseFloat(ts1.TotalHours)) {
                                    if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                        this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + "'Normal Working Hours' Exceeded for an Employe - " + Util.String(this.drcc1[0]["Code"]) + sVoucherNo + "\"></Row>";
                                        //this.sBioErrLogs += "\r\n " + "'Normal Working Hours' Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        this.ScreenObject.GridDataObj.removeRowAt(i);
                                        i--;
                                        continue;
                                    }
                                    else if (this.isDAValidate) {
                                        this.sDAErrLogs += "\r\n " + "'Normal Working Hours' Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        continue;
                                    }
                                    else {
                                        Logger.DebugLog("Entered into the TRUE Block");
                                        this.DisplayMessage = "'Normal Working Hours' Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo;
                                        this.MessageVisibility = true;
                                        return this.DisplayMessage;
                                    }
                                }
                                else {
                                    Logger.DebugLog("Entered into the FLASE Block");
                                }

                                //Break Hours
                                dtdbl = Date.Today();
                                refObjdt = { dtdblOld: dtdblOld, sVoucherNo: sVoucherNo };
                                this.GetTotalEnteredHours(sEmpID, sDailyAttDate, "dcNum4", refObjdt);
                                dtdblOld = refObjdt.dtdblOld;
                                sVoucherNo = refObjdt.sVoucherNo;

                                this.sHrs = parseFloat(dtHrsDef[0]["BreakHrs"]).ToTime("00.00").split('.');
                                dtdbl = dtdbl.AddHours(parseFloat(this.sHrs[0])).AddMinutes(parseFloat(this.sHrs[1]));
                                ts1 = new TimeSpan(dtdbl.ToNumber());
                                ts2 = new TimeSpan(dtdblOld.ToNumber());
                                if (ts2.TotalHours > ts1.TotalHours) {
                                    if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                        this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + "'Break Hours' Exceeded for an Employe - " + Util.String(this.drcc1[0]["Code"]) + sVoucherNo + "\"></Row>";
                                        //this.sBioErrLogs += "\r\n " + "'Break Hours' Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        this.ScreenObject.GridDataObj.removeRowAt(i);
                                        i--;
                                        continue;
                                    }
                                    else if (this.isDAValidate) {
                                        this.sDAErrLogs += "\r\n " + "'Break Hours' Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        continue;
                                    }
                                    else {
                                        this.DisplayMessage = "'Break Hours' Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo;
                                        this.MessageVisibility = true;
                                        return this.DisplayMessage;
                                    }
                                }

                                //OT1 Hours
                                dtdbl = Date.Today();
                                refObjdt = { dtdblOld: dtdblOld, sVoucherNo: sVoucherNo };
                                this.GetTotalEnteredHours(sEmpID, sDailyAttDate, "dcNum5", refObjdt);
                                dtdblOld = refObjdt.dtdblOld;
                                sVoucherNo = refObjdt.sVoucherNo;
                                this.sHrs = parseFloat(dtHrsDef[0]["OT1"]).ToTime("00.00").split('.');
                                dtdbl = dtdbl.AddHours(parseFloat(this.sHrs[0])).AddMinutes(parseFloat(this.sHrs[1]));
                                ts1 = new TimeSpan(dtdbl.ToNumber());
                                ts2 = new TimeSpan(dtdblOld.ToNumber());
                                if (ts2.TotalHours > ts1.TotalHours) {
                                    this.drcc2 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'dcNum5');
                                    if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                        this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + "'" + Util.String(this.drcc2[0]["UserColumnName"]) + "' Hours Exceeded for an Employe - " + Util.String(this.drcc1[0]["Code"]) + sVoucherNo + "\"></Row>";
                                        //this.sBioErrLogs += "\r\n " + "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        this.ScreenObject.GridDataObj.removeRowAt(i);
                                        i--;
                                        continue;
                                    }
                                    else if (this.isDAValidate) {
                                        this.sDAErrLogs += "\r\n " + "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        continue;
                                    }
                                    else {
                                        this.DisplayMessage = "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo;
                                        this.MessageVisibility = true;
                                        return this.DisplayMessage;
                                    }
                                }

                                //OT2 Hours
                                dtdbl = Date.Today();
                                refObjdt = { dtdblOld: dtdblOld, sVoucherNo: sVoucherNo };
                                this.GetTotalEnteredHours(sEmpID, sDailyAttDate, "dcNum7", refObjdt);
                                dtdblOld = refObjdt.dtdblOld;
                                sVoucherNo = refObjdt.sVoucherNo;
                                this.sHrs = parseFloat(dtHrsDef[0]["OT2"]).ToTime("00.00").split('.');
                                dtdbl = dtdbl.AddHours(parseFloat(this.sHrs[0])).AddMinutes(parseFloat(this.sHrs[1]));
                                ts1 = new TimeSpan(dtdbl.ToNumber());
                                ts2 = new TimeSpan(dtdblOld.ToNumber());
                                if (ts2.TotalHours > ts1.TotalHours) {
                                    this.drcc2 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'dcNum7');
                                    if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                        this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + "'" + Util.String(this.drcc2[0]["UserColumnName"]) + "' Hours Exceeded for an Employe - " + Util.String(this.drcc1[0]["Code"]) + sVoucherNo + "\"></Row>";
                                        //this.sBioErrLogs += "\r\n " + "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        this.ScreenObject.GridDataObj.removeRowAt(i);
                                        i--;
                                        continue;
                                    }
                                    else if (this.isDAValidate) {
                                        this.sDAErrLogs += "\r\n " + "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        continue;
                                    }
                                    else {
                                        this.DisplayMessage = "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo;
                                        this.MessageVisibility = true;
                                        return this.DisplayMessage;
                                    }
                                }

                                //OT3 Hours
                                dtdbl = Date.Today();
                                refObjdt = { dtdblOld: dtdblOld, sVoucherNo: sVoucherNo };
                                this.GetTotalEnteredHours(sEmpID, sDailyAttDate, "dcNum9", refObjdt);
                                dtdblOld = refObjdt.dtdblOld;
                                sVoucherNo = refObjdt.sVoucherNo;
                                this.sHrs = parseFloat(dtHrsDef[0]["OT3"]).ToTime("00.00").split('.');
                                dtdbl = dtdbl.AddHours(parseFloat(this.sHrs[0])).AddMinutes(parseFloat(this.sHrs[1]));
                                ts1 = new TimeSpan(dtdbl.ToNumber());
                                ts2 = new TimeSpan(dtdblOld.ToNumber());
                                if (ts2.TotalHours > ts1.TotalHours) {
                                    this.drcc2 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'dcNum9');
                                    if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                        this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + "'" + Util.String(this.drcc2[0]["UserColumnName"]) + "' Hours Exceeded for an Employe - " + Util.String(this.drcc1[0]["Code"]) + sVoucherNo + "\"></Row>";
                                        //this.sBioErrLogs += "\r\n " + "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        this.ScreenObject.GridDataObj.removeRowAt(i);
                                        i--;
                                        continue;
                                    }
                                    else if (this.isDAValidate) {
                                        this.sDAErrLogs += "\r\n " + "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        continue;
                                    }
                                    else {
                                        this.DisplayMessage = "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo;
                                        this.MessageVisibility = true;
                                        return this.DisplayMessage;
                                    }
                                }

                                //OT4 Hours
                                dtdbl = Date.Today();
                                refObjdt = { dtdblOld: dtdblOld, sVoucherNo: sVoucherNo };
                                this.GetTotalEnteredHours(sEmpID, sDailyAttDate, "dcNum11", refObjdt);
                                dtdblOld = refObjdt.dtdblOld;
                                sVoucherNo = refObjdt.sVoucherNo;
                                this.sHrs = parseFloat(dtHrsDef[0]["OT4"]).ToTime("00.00").split('.');
                                dtdbl = dtdbl.AddHours(parseFloat(this.sHrs[0])).AddMinutes(parseFloat(this.sHrs[1]));
                                ts1 = new TimeSpan(dtdbl.ToNumber());
                                ts2 = new TimeSpan(dtdblOld.ToNumber());
                                if (ts2.TotalHours > ts1.TotalHours) {
                                    this.drcc2 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'dcNum11');
                                    if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                        this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + "'" + Util.String(this.drcc2[0]["UserColumnName"]) + "' Hours Exceeded for an Employee - " + Util.String(this.drcc1[0]["Code"]) + sVoucherNo + "\"></Row>";
                                        //this.sBioErrLogs += "\r\n " + "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        this.ScreenObject.GridDataObj.removeRowAt(i);
                                        i--;
                                        continue;
                                    }
                                    else if (this.isDAValidate) {
                                        this.sDAErrLogs += "\r\n " + "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        continue;
                                    }
                                    else {
                                        this.DisplayMessage = "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo;
                                        this.MessageVisibility = true;
                                        return this.DisplayMessage;
                                    }
                                }

                                //O5 Hours
                                dtdbl = Date.Today();
                                refObjdt = { dtdblOld: dtdblOld, sVoucherNo: sVoucherNo };
                                this.GetTotalEnteredHours(sEmpID, sDailyAttDate, "dcNum13", refObjdt);
                                dtdblOld = refObjdt.dtdblOld;
                                sVoucherNo = refObjdt.sVoucherNo;
                                this.sHrs = parseFloat(dtHrsDef[0]["OT5"]).ToTime("00.00").split('.');
                                dtdbl = dtdbl.AddHours(parseFloat(this.sHrs[0])).AddMinutes(parseFloat(this.sHrs[1]));
                                ts1 = new TimeSpan(dtdbl.ToNumber());
                                ts2 = new TimeSpan(dtdblOld.ToNumber());
                                if (ts2.TotalHours > ts1.TotalHours) {
                                    this.drcc2 = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'dcNum13');
                                    if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                        this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + "'" + Util.String(this.drcc2[0]["UserColumnName"]) + "' Hours Exceeded for an Employe - " + Util.String(this.drcc1[0]["Code"]) + sVoucherNo + "\"></Row>";
                                        //this.sBioErrLogs += "\r\n " + "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        this.ScreenObject.GridDataObj.removeRowAt(i);
                                        i--;
                                        continue;
                                    }
                                    else if (this.isDAValidate) {
                                        this.sDAErrLogs += "\r\n " + "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo + "\r\n ";
                                        continue;
                                    }
                                    else {
                                        this.DisplayMessage = "'" + this.drcc2[0]["UserColumnName"].toString() + "' Hours Exceeded for an Employee - " + this.drcc1[0]["Code"].toString() + sVoucherNo;
                                        this.MessageVisibility = true;
                                        return this.DisplayMessage;
                                    }
                                }

                            }
                            //#endregion

                            //#region validating dailyattdt with dateofjoining
                            let drr1;
                            if (sDailyAttDate != "" && parseInt(sEmpID) > 1 && this.dtPayEmps != null && this.dtPayEmps.length > 0) {
                                drr1 = this.dtPayEmps.filter(x => x.NodeId == sEmpID && x.DOJ > Util.ParseDate(sDailyAttDate.toString()));
                                if (drr1 != null && drr1.length > 0) {
                                    if (Util.ParseDate(drr1[0]["DOJ"].toString()) > Util.ParseDate(sDailyAttDate.toString())) {
                                        if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                            this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + "Please Check The Employee Dependency With date Of joining " + "\"></Row>";
                                            //this.sBioErrLogs += "\r\n " + "Please Check The Employee Dependency With date Of joining " + drr1[0]["Code"].toString() + "\r\n ";
                                            this.ScreenObject.GridDataObj.removeRowAt(i);
                                            i--;
                                            continue;
                                        }
                                        else if (this.isDAValidate) {
                                            this.sDAErrLogs += "\r\n " + "Please Check The Employee Dependency With date Of joining " + drr1[0]["Code"].toString() + "\r\n ";
                                            continue;
                                        }
                                        else {
                                            this.DisplayMessage = "Please Check The Employee Dependency With date Of joining " + drr1[0]["Code"].toString() + "";
                                            this.MessageVisibility = true;
                                            return this.DisplayMessage;
                                        }
                                    }
                                }
                            }

                            //#endregion

                            //#region Checking DailyPayrollDate and Start Time Equal or Not

                            let dt1 = Util.ParseDate(sDailyAttDate), dt2 = Util.ParseDate(sDailyAttDate).AddDays(1);
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcalpha2"]) &&
                                !Util.IsEmpty(this.ScreenObject.GridData[i]["dcalpha2_Key"]) &&
                                !Util.IsEmpty(this.ScreenObject.GridData[i]["dcalpha3"]) &&
                                !Util.IsEmpty(this.ScreenObject.GridData[i]["dcalpha3_Key"])) {
                                if (Util.ParseDate(sDailyAttDate).ToString("dd/MMM/yyyy") != Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]).ToString("dd/MMM/yyyy")) {
                                    this.ScreenObject.GridData[i]["dcAlpha2_Key"] = Util.ParseDate(sDailyAttDate)
                                        .AddHours(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]).getHours())
                                        .AddMinutes(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha2_Key"]).getMinutes()).ToString("dd/MMM/yyyy HH:mm");


                                    if (Util.ParseDate(this.ScreenObject.GridData[i]["dcalpha2"]) > Util.ParseDate(this.ScreenObject.GridData[i]["dcalpha3"])) {
                                        this.ScreenObject.GridData[i]["dcAlpha3_Key"] = Util.ParseDate(dt2)
                                            .AddHours(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha3_Key"]).getHours())
                                            .AddMinutes(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha3_Key"]).getMinutes()).ToString("dd/MMM/yyyy HH:mm");

                                    }
                                    else {
                                        this.ScreenObject.GridData[i]["dcAlpha3_Key"] = Util.ParseDate(dt1)
                                            .AddHours(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha3_Key"]).getHours())
                                            .AddMinutes(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha3_Key"]).getMinutes()).ToString("dd/MMM/yyyy HH:mm");
                                    }
                                }
                            }

                            //#endregion

                            //#region Validating duplicate Timings of Employees

                            let vFld3 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                            let vFld4 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                            if (vFld3 != null && vFld3.IsVisible) {
                                if (vFld4 != null && vFld4.IsVisible) {
                                    this.drcc1 = this.dtPayEmps.filter(x => x.NodeID == sEmpID);
                                    let sVoucherNo = this.GetDuplicateTimingsOfEmployee(sDailyAttDate, sEmpID, i);
                                    if (sVoucherNo != "") {
                                        try {
                                            parseInt(sVoucherNo);
                                            ValidationMessage = "Employee has already worked on these timings, can't allow same timings. Check Timings of the Employee - " + this.drcc1[0]["Code"].toString() + " @ Row No - " + parseInt(sVoucherNo);
                                        }
                                        catch {
                                            ValidationMessage = "Employee has already worked on these timings, can't allow same timings. Check Timings of the Employee - " + this.drcc1[0]["Code"].toString() + " @ Voucher No - " + sVoucherNo;
                                        }

                                        if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                            this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + ValidationMessage + "\"></Row>";
                                            //this.sBioErrLogs += "\r\n " + ValidationMessage + "\r\n ";
                                            ValidationMessage = "";
                                            this.ScreenObject.GridDataObj.removeRowAt(i);
                                            i--;
                                            continue;
                                        }
                                        else if (this.isDAValidate) {
                                            this.sDAErrLogs += "\r\n " + ValidationMessage + "\r\n ";
                                            ValidationMessage = "";
                                            continue;
                                        }
                                        else {
                                            break;
                                        }
                                    }
                                }
                            }

                            //#endregion

                            //#region Check whether Employee is on Leave/Vacation

                            if (BaseService.SessionManager.Preferences.ContainsKey("AllowDailyPayrollEntryforEmpOnleave") && parseBoolean(BaseService.SessionManager.Preferences["AllowDailyPayrollEntryforEmpOnleave"] == "False")) {
                                this.drcc1 = this.dtPayEmps.filter(x => x.NodeID == sEmpID);

                                let dtE = BaseService.common.GetDataSet3("PAY025", sEmpID, sDailyAttDate).Tables[0];
                                if (dtE != null && dtE.length > 0) {
                                    if (Util.String(dtE[0]["LeaveMessage"]) != "") {
                                        if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                            this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + dtE[0]["LeaveMessage"].toString() + " Check for the Employee - " + this.drcc1[0]["Code"].toString() + "\"></Row>";
                                            //this.sBioErrLogs += "\r\n " + dtE[0]["LeaveMessage"].toString() + " Check for the Employee - " + this.drcc1[0]["Code"].toString() + "\r\n ";
                                            this.ScreenObject.GridDataObj.removeRowAt(i);
                                            i--;
                                            continue;
                                        }
                                        else if (this.isDAValidate) {
                                            this.sDAErrLogs += "\r\n " + dtE[0]["LeaveMessage"].toString() + " Check for the Employee - " + this.drcc1[0]["Code"].toString() + "\r\n ";
                                            continue;
                                        }
                                        else {
                                            this.DisplayMessage = dtE[0]["LeaveMessage"].toString() + " Check for the Employee - " + this.drcc1[0]["Code"].toString() + " @ Row No - " + (i + 1);
                                            this.MessageVisibility = true;
                                            return this.DisplayMessage;
                                        }
                                    }
                                }
                            }

                            //#endregion

                            //#region Lates Validation

                            this.drcc1 = this.dtPayEmps.filter(x => x.NodeID == sEmpID);

                            let dtE1 = BaseService.common.GetDataSet3("PAY026", sEmpID, sDailyAttDate).Tables[0];;
                            if (dtE1 != null && dtE1.length > 0) {
                                if (this.ScreenObject.ParentFlagName == "PostingFromBiometric" && this.ScreenObject.Preferences.ContainsKey("SkipEmployeesWhoGetErrorsWhileSaving") && this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"] != "" && parseBoolean(this.ScreenObject.Preferences["SkipEmployeesWhoGetErrorsWhileSaving"])) {
                                    this.sbBioErrLogs += "<Row DADate='" + sDailyAttDate + "' Code=\"" + Util.String(this.drcc1[0]["Code"]) + "\" Name=\"" + Util.String(this.drcc1[0]["Name"]) + "\" Error=\"" + "Lates Processed For Employee - " + Util.String(this.drcc1[0]["Code"]) + " @ Voucher No - " + Util.String(dtE1[0]["VoucherNo"]) + "\"></Row>";
                                    //this.sBioErrLogs += "\r\n " + "Lates Processed For Employee - " + this.drcc1[0]["Code"].toString() + " @ Voucher No - " + dtE1[0]["VoucherNo"] + "\r\n ";
                                    this.ScreenObject.GridDataObj.removeRowAt(i);
                                    i--;
                                    continue;
                                }
                                else if (this.isDAValidate) {
                                    this.sDAErrLogs += "\r\n " + "Lates Processed For Employee - " + this.drcc1[0]["Code"].toString() + " @ Voucher No - " + dtE1[0]["VoucherNo"] + "\r\n ";
                                    continue;
                                }
                                else {
                                    this.DisplayMessage = "Lates Processed For Employee - " + this.drcc1[0]["Code"].toString() + "@ Row No - " + (i + 1) + " @ Voucher No - " + dtE1[0]["VoucherNo"];
                                    this.MessageVisibility = true;
                                    return this.DisplayMessage;
                                }
                            }

                            //#endregion
                        }

                    }
                }

            }
            //#endregion

            //Start: Activity Xml for applying the vacation

            //#region Payroll - Shift Assign

            if (this.ScreenObject.DocumentType == 92) {
                let sAssgnType = "DayWise";
                var vFld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                if (vFld instanceof PactComboBoxData)
                    sAssgnType = vFld.SelectedValue;

                let sQ = "";
                let dtChk = null;
                let drr1, drr, drERows;

                if (sAssgnType == "DayWise") {
                    let iDtCnt = 0;
                    for (let i = 0; i < this.ScreenObject.ColumnSource.length; i++) {
                        if (this.ScreenObject.ColumnSource[i].DrRefColName != null && this.ScreenObject.ColumnSource[i].DrRefColName != "" && this.ScreenObject.ColumnSource[i].DrRefColName == "Date") {
                            iDtCnt++;
                            break;
                        }
                    }
                    if (iDtCnt == 0) {
                        ValidationMessage = "No dates found. Assign atlest for one day.";
                        return ValidationMessage;
                    }
                    else {
                        let FromDate, ToDate;
                        FromDate = this.ScreenObject.CustomTab.Pages[0].Fields.find(x => x instanceof PactExtraFieldDateData && x.DBColumnName == "dcAlpha1") as PactExtraFieldDateData;
                        ToDate = this.ScreenObject.CustomTab.Pages[0].Fields.find(x => x instanceof PactExtraFieldDateData && x.DBColumnName == "dcAlpha2") as PactExtraFieldDateData;

                        if (Util.ParseDate(this.ScreenObject.GridDataColumns[this.iDtColFrom].Replace("_Key", "")).OnlyDate() != FromDate.Date) {
                            this.DisplayMessage = "Dates should be in between From Date and To Date";
                            this.MessageVisibility = true;
                            return this.DisplayMessage;
                        }
                        if (Util.ParseDate(this.ScreenObject.GridDataColumns[this.iDtColUpto].Replace("_Key", "")).Date() != ToDate.Date) {
                            this.DisplayMessage = "Dates should be in between From Date and To Date";
                            this.MessageVisibility = true;
                            return this.DisplayMessage;
                        }


                        if (this.ScreenObject.GridData.length > 0) {
                            let sEmpSeqNo = "", sDate = "";

                            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID51_Key"])) {
                                    sEmpSeqNo = this.ScreenObject.GridData[i]["dcCCNID51_Key"].toString();
                                    dtChk = BaseService.common.GetDataSet("PAY027", sEmpSeqNo).Tables[0];
                                    if (dtChk != null && dtChk.length > 0) {
                                        if (FromDate.Date < Util.ParseDate(dtChk[0]["DateOfJoining"]).Date) {
                                            this.DisplayMessage = "From Date should be Grater than or Equal to the Date of Joining of the Employee : " + this.ScreenObject.GridData[i]["dcCCNID51Code"].toString();
                                            this.MessageVisibility = true;
                                            return this.DisplayMessage;
                                        }
                                    }
                                }
                            }

                            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                                if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID51_Key"])) {
                                    sEmpSeqNo = this.ScreenObject.GridData[i]["dcCCNID51_Key"].toString();
                                    for (let j = 0; j < this.ScreenObject.GridData.length; j++) {
                                        if (i != j) {
                                            if (Util.String(this.ScreenObject.GridData[j]["dcCCNID51_Key"]) == sEmpSeqNo) {
                                                this.DisplayMessage = "Shifts already asssigned for the Employee : " + this.ScreenObject.GridData[i]["dcCCNID51Code"].toString() + ", check at Row : " + (j + 1);
                                                this.MessageVisibility = true;
                                                return this.DisplayMessage;
                                            }
                                        }
                                    }
                                }
                            }

                            if (this.ScreenObject.Preferences.ContainsKey("AllowMultipleShiftAssignonsameday") && !Util.IsEmpty(this.ScreenObject.Preferences["AllowMultipleShiftAssignonsameday"]) && this.ScreenObject.Preferences["AllowMultipleShiftAssignonsameday"] == "False") {
                                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                                    for (let k = this.iDtColFrom; k <= this.iDtColUpto; k++) {
                                        if (this.ScreenObject.GridDataColumns[k].endsWith("_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID51_Key"])) {
                                            sEmpSeqNo = this.ScreenObject.GridData[i]["dcCCNID51_Key"].toString();
                                            sDate = this.ScreenObject.GridDataColumns[k].Replace("_Key", "");
                                            dtChk = BaseService.common.GetDataSet3("PAY028", sEmpSeqNo, Util.ParseDate(sDate).ToString("dd/MMM/yyyy"), this.ScreenObject.DocID.toString()).Tables[0];
                                            if (dtChk != null && dtChk.length > 0) {
                                                this.DisplayMessage = "Shifts already asssigned for the Employee : " + this.ScreenObject.GridData[i]["dcCCNID51Code"].toString() + ", Dated : " + sDate + ", check at Voucher No : " + dtChk[0]["VoucherNo"].toString();
                                                this.MessageVisibility = true;
                                                return this.DisplayMessage;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                else // PeriodWise
                {
                    if (this.ScreenObject.GridDataColumns.Contains("dcCCNID51_Key")) {
                        let iEntCnt = 0;
                        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID51_Key"])) {
                                iEntCnt++;
                                break;
                            }
                        }
                        if (iEntCnt == 0) {
                            ValidationMessage = "No dates found. Assign atlest for one day.";
                            return ValidationMessage;
                        }

                        let sEmpSeqNo = "", sFromDate = "", sToDate = "", sFromDate1 = "", sToDate1 = "";

                        dtChk = BaseService.common.GetDataTable("PAY097", this.ScreenObject.DocID.toString());
                        for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                            if (!Util.IsEmpty(this.ScreenObject.GridData[i]["dcCCNID51_Key"])) {
                                drr1 = null; drr = null; drERows = null;
                                sEmpSeqNo = this.ScreenObject.GridData[i]["dcCCNID51_Key"].toString();
                                sFromDate = Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha5_Key"]).ToString("dd MMM yyyy");
                                sToDate = Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha6_Key"]).ToString("dd MMM yyyy");
                                if (Util.ParseDate(sFromDate).Date > Util.ParseDate(sToDate).Date) {
                                    ValidationMessage = "AssignFrom Date should be lessthan or equal to AssignUpto Date @ Row No. " + (i + 1).toString();
                                    return ValidationMessage;
                                }

                                drr1 = this.dtPayEmps.filter(x => x.NodeId == sEmpSeqNo);
                                if (drr1 != null && drr1.length > 0) {
                                    if (parseInt(sEmpSeqNo) > 1 && Util.ParseDate(sFromDate).Date < Util.ParseDate(drr1[0]["DOJ"]).Date) {
                                        this.DisplayMessage = "AssignFrom Date should be Grater than or Equal to the Date of Joining of the Employee : " + this.ScreenObject.GridData[i]["dcCCNID51"].toString() + " @ Row No. " + (i + 1).toString();
                                        return this.DisplayMessage;
                                    }
                                }

                                drERows = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key == sEmpSeqNo && x.DocSeqNo != (i + 1) && ((x.dcAlpha5_Key <= sFromDate && x.dcAlpha6_Key >= sFromDate) || (x.dcAlpha5_Key <= sToDate && x.dcAlpha6_Key >= sToDate) || (x.dcAlpha5_Key >= sFromDate && x.dcAlpha6_Key <= sToDate)));
                                if (drERows != null && drERows.length > 0) {
                                    this.DisplayMessage = "Shifts already asssigned for the Employee : " + this.ScreenObject.GridData[i]["dcccnid51"].toString() + ", check at Row : " + (drERows[0]["DocSeqNo"]);
                                    this.MessageVisibility = true;
                                    return this.DisplayMessage;
                                }
                                //for(let j = 0; j < ScreenObject.GridData.length; j++)
                                //{
                                //    if (ScreenObject.GridData[j]["dcccnid51_Key"] != null && ScreenObject.GridData[j]["dcccnid51_Key"] != null && ScreenObject.GridData[j]["dcccnid51_Key"].toString() != "")
                                //    {
                                //        if (ScreenObject.GridData[j]["dcccnid51_Key"].toString() != sEmpSeqNo)
                                //            continue;
                                //        if (i != j)
                                //        {
                                //            sFromDate1 = Util.ParseDate(ScreenObject.GridData[j]["dcalpha5_key"]).ToString("dd MMM yyyy");
                                //            sToDate1 = Util.ParseDate(ScreenObject.GridData[j]["dcalpha6_key"]).ToString("dd MMM yyyy");

                                //            if (ScreenObject.GridData[j]["dcccnid51_Key"] != null && ScreenObject.GridData[j]["dcccnid51_Key"] != null &&
                                //                ScreenObject.GridData[j]["dcccnid51_Key"].toString() == sEmpSeqNo &&
                                //                ((Util.ParseDate(sFromDate).Date >= Util.ParseDate(sFromDate1).Date && Util.ParseDate(sFromDate).Date <= Util.ParseDate(sToDate1).Date) ||
                                //                  (Util.ParseDate(sToDate).Date >= Util.ParseDate(sFromDate1).Date && Util.ParseDate(sToDate).Date <= Util.ParseDate(sToDate1).Date) ||
                                //                  (Util.ParseDate(sFromDate1).Date >= Util.ParseDate(sFromDate).Date && Util.ParseDate(sFromDate1).Date <= Util.ParseDate(sToDate).Date) ||
                                //                  (Util.ParseDate(sToDate1).Date >= Util.ParseDate(sFromDate).Date && Util.ParseDate(sToDate1).Date <= Util.ParseDate(sToDate).Date)
                                //                )
                                //               )
                                //            {
                                //                DisplayMessage = "Shifts already asssigned for the Employee : " + ScreenObject.GridData[i]["dcccnid51"].toString() + ", check at Row : " + (j + 1);
                                //                MessageVisibility = true;
                                //                return DisplayMessage;
                                //            }
                                //        }
                                //    }
                                //}
                                if (this.ScreenObject.Preferences.ContainsKey("AllowMultipleShiftAssignonsameday") && !Util.IsEmpty(this.ScreenObject.Preferences["AllowMultipleShiftAssignonsameday"]) && this.ScreenObject.Preferences["AllowMultipleShiftAssignonsameday"] == "False") {
                                    if (dtChk != null && dtChk.length > 0) {
                                        drr = dtChk.filter(x => x.dcCCNID51 == sEmpSeqNo && ((x.dcAlpha5 <= sFromDate && x.dcAlpha6 >= sFromDate) || (x.dcAlpha5 <= sToDate && x.dcAlpha6 >= sToDate) || (x.dcAlpha5 >= sFromDate && x.dcAlpha6 <= sToDate)));
                                        if (drr != null && drr.length > 0) {
                                            this.DisplayMessage = "Shifts already asssigned for the Employee : " + this.ScreenObject.GridData[i]["dcccnid51"].toString() + ",  @ Row No. : " + (i + 1) + ", check at Voucher No : " + drr[0]["VoucherNo"].toString();
                                            this.MessageVisibility = true;
                                            return this.DisplayMessage;
                                        }
                                    }
                                }

                            }
                        }
                    }
                }
            }

            //#endregion

            if (this.ScreenObject.DocumentType == 98) //Delegation
            {
                var fld1 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toUpperCase() == "DCALPHA1");
                if (fld1 instanceof PactListBoxData && fld1.SelectedValue > 0) {
                    var fld2 = this.ScreenObject._CCFields.find(a => a.DBColumnName.toUpperCase() == "DCCCNID51");
                    if (fld2 instanceof PactListBoxData) {
                        if (fld1.SelectedValue == fld2.SelectedValue) {
                            return "Delegator and Delegatee should not be same.";
                        }
                    }
                }

                var fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toUpperCase() == "DCALPHA3");
                if (fld instanceof PactComboBoxData && fld.SelectedValue != null && fld.SelectedValue == "Temporary") {
                    var fldDt = this.ScreenObject._TextFields.find(a => a.DBColumnName.toUpperCase() == "DCALPHA4");
                    if (fldDt instanceof PactExtraFieldDateData && !fldDt.Date) {
                        return "'Period From' and 'Period Upto' is Mandatory when the Type is 'Temporary'";
                    }

                    fldDt = this.ScreenObject._TextFields.find(a => a.DBColumnName.toUpperCase() == "DCALPHA5");
                    if (fldDt instanceof PactExtraFieldDateData && !fldDt.Date) {
                        return "'Period From' and 'Period Upto' is Mandatory when the Type is 'Temporary'";
                    }
                }
                else {
                    var fldDt = this.ScreenObject._TextFields.find(a => a.DBColumnName.toUpperCase() == "DCALPHA4");
                    if (fldDt != null && fldDt instanceof PactExtraFieldDateData && !fldDt.Date) {
                        return "'Period From' is Mandatory when the Type is 'Permanent'";
                    }

                    if (!confirm("Do you want to update the Delegatee at Employee Level.?"))
                        return "Cancelled by the User.";
                }

            }


            //#region Gratuity 

            if (this.ScreenObject.DocumentType == 75) {

                let dt = BaseService.common.GetDataSet("PAY067", this.ScreenObject.DocID.toString()).Tables[0];
                if (dt != null && dt.length > 0) {
                    this.DisplayMessage = "Final Settlement Already Posted For This Grade";
                    this.MessageVisibility = true;
                    return this.DisplayMessage;
                }


            }
            //#endregion

            //#region PayrollLock 

            if (this.ScreenObject.DocumentType == 77) {
                let iDim = 0;
                let LockDim = "", sExp1 = "";
                let dsData2 = BaseService.common.GetDataSet("PAY068", "")
                if (dsData2 != null && dsData2.Tables.length > 0) {
                    if (dsData2.Tables[0] != null && dsData2.Tables[0].length > 0) {
                        for (let i = 0; i < dsData2.Tables[0].length; i++) {
                            LockDim = dsData2.Tables[0][i]["SysColumnName"].toString();

                            let fld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == LockDim.toLowerCase());
                            if (fld != undefined && fld != null) {
                                if (fld instanceof PactListBoxData)
                                    iDim = fld.SelectedValue;
                                else if (fld instanceof PactCodeNameListBoxData)
                                    iDim = fld.SelectedValue;
                            }

                            sExp1 += " AND " + LockDim + "=" + iDim;
                        }

                        let dsData3 = BaseService.common.GetDataSet3("PAY069", JSON.stringify(sExp1), this.DocID.toString(), "").Tables[0];
                        if (dsData3 != null && dsData3.length > 0) {
                            this.DisplayMessage = "Data Already Available for this Dimensions on Document No. - " + dsData3[0]["VoucherNo"] + "";
                            this.MessageVisibility = true;
                            return this.DisplayMessage;
                        }
                    }
                }
            }

            //#endregion

            //#region Regularization of Attendance

            if (this.ScreenObject.DocumentType == 99) {

                //#region Checking DailyPayrollDate and Start Time Equal or Not

                let sDailyAttDate = "", sEmpID = "1";
                let drw = null;

                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                        sDailyAttDate = ""; sEmpID = "1";
                        drw = this.ScreenObject.GridData[i];

                        let vFld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcAlpha3");
                        if (vFld != undefined)
                            sDailyAttDate = vFld.Date.ToString("dd/MMM/yyyy");
                        else {
                            let vFld2: any = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                            if (vFld2 != undefined && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                                sDailyAttDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");
                        }

                        vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (vFld != undefined) {
                            if (vFld instanceof PactListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                        }
                        else {
                            let vFld2: any = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                            if (vFld2 != undefined && !Util.IsEmpty(drw[vFld2.ValueMember]))
                                sEmpID = drw[vFld2.ValueMember].toString();
                        }

                        if (sDailyAttDate != "" && parseInt(sEmpID) > 1) {
                            let dt1 = Util.ParseDate(sDailyAttDate), dt2 = Util.ParseDate(sDailyAttDate).AddDays(1);
                            if (this.ScreenObject.GridData[i]["dcAlpha8"] != null && this.ScreenObject.GridData[i]["dcAlpha8"] != null && this.ScreenObject.GridData[i]["dcAlpha8"].toString() != "" &&
                                this.ScreenObject.GridData[i]["dcAlpha8_Key"] != null && this.ScreenObject.GridData[i]["dcAlpha8_Key"] != null && this.ScreenObject.GridData[i]["dcAlpha8_Key"].toString() != "" &&
                                this.ScreenObject.GridData[i]["dcAlpha9"] != null && this.ScreenObject.GridData[i]["dcAlpha9"] != null && this.ScreenObject.GridData[i]["dcAlpha9"].toString() != "" &&
                                this.ScreenObject.GridData[i]["dcAlpha9_Key"] != null && this.ScreenObject.GridData[i]["dcAlpha9_Key"] != null && this.ScreenObject.GridData[i]["dcAlpha9_Key"].toString() != "") {

                                this.ScreenObject.GridData[i]["dcAlpha8_Key"] = Util.ParseDate(sDailyAttDate)
                                    .AddHours(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha8_Key"]).getHours())
                                    .AddMinutes(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha8_Key"]).getMinutes()).ToString("dd/MMM/yyyy HH:mm");


                                if (Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha8"]) > Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha9"])) {
                                    this.ScreenObject.GridData[i]["dcAlpha9_Key"] = Util.ParseDate(dt2)
                                        .AddHours(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha9_Key"]).getHours())
                                        .AddMinutes(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha9_Key"]).getMinutes()).ToString("dd/MMM/yyyy HH:mm");

                                }
                                else {
                                    this.ScreenObject.GridData[i]["dcAlpha9_Key"] = Util.ParseDate(dt1)
                                        .AddHours(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha9_Key"]).getHours())
                                        .AddMinutes(Util.ParseDate(this.ScreenObject.GridData[i]["dcAlpha9_Key"]).getMinutes()).ToString("dd/MMM/yyyy HH:mm");
                                }
                            }

                        }
                    }
                    this.ScreenObject.GridDataObj.updateRow(this.ScreenObject.GridData[i]);
                }
                //#endregion

                if (BaseService.SessionManager.Preferences.ContainsKey("MaxAllowedMinToRegularizeDocument") && !Util.IsEmpty(BaseService.SessionManager.Preferences["MaxAllowedMinToRegularizeDocument"])) {
                    let sRet = this.ValidateMaxAllowedAbsenseMinutes(sEmpID);
                    if (sRet.length > 0)
                        ValidationMessage = sRet;
                }
            }

            //#endregion


            //#region On Duty

            if (this.ScreenObject.DocumentType == 103) {
                let dtCheckInDate: Date = null, dtCheckInTime: Date = null, dtCheckOutDate: Date = null, dtCheckOutTime: Date = null;
                let session = "", sEmpID = "1";

                let drw: any;
                for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                    if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                        sEmpID = "1";
                        drw = this.ScreenObject.GridData[i];

                        var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                        if (vFld2 != undefined && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                            dtCheckInDate = new Date(drw[vFld2.DisplayMember + "_Key"]);

                        vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha3");
                        if (vFld2 != undefined && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"])) {
                            dtCheckInTime = new Date(drw[vFld2.DisplayMember + "_Key"]);
                        }

                        vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha4");
                        if (vFld2 != undefined && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                            dtCheckOutDate = new Date(drw[vFld2.DisplayMember + "_Key"]);

                        vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha5");
                        if (vFld2 != undefined && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"])) {
                            dtCheckOutTime = new Date(drw[vFld2.DisplayMember + "_Key"]);
                        }

                        vFld2 = this.ScreenObject.ColumnSource.find(a => a.ValueBinding != null && a.ValueBinding.toLowerCase() == "dcalpha6");
                        if (vFld2 != undefined && !Util.IsEmpty(drw[vFld2.ValueBinding]))
                            this.session = drw[vFld2.ValueBinding].toString();

                        var vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                        if (vFld != undefined) {
                            if (vFld instanceof PactListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                            else if (vFld instanceof PactCodeNameListBoxData)
                                sEmpID = vFld.SelectedValue.toString();
                        }
                        else {
                            vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                            if (vFld2 != undefined && !Util.IsEmpty(drw[vFld2.ValueMember]))
                                sEmpID = drw[vFld2.ValueMember].toString();
                        }

                        if (dtCheckInDate == null) {
                            ValidationMessage = "Select CheckInDate @RowNo - " + (i + 1);
                            return ValidationMessage;
                        }
                        if (dtCheckInTime == null) {
                            ValidationMessage = "Select dtCheckInTime @RowNo - " + (i + 1);
                            return ValidationMessage;
                        }
                        if (dtCheckOutDate == null) {
                            ValidationMessage = "Select dtCheckOutDate @RowNo - " + (i + 1);
                            return ValidationMessage;
                        }
                        if (dtCheckOutTime == null) {
                            ValidationMessage = "Select dtCheckOutTime @RowNo - " + (i + 1);
                            return ValidationMessage;
                        }
                        if (this.session == null) {
                            ValidationMessage = "Select Session @RowNo - " + (i + 1);
                            return ValidationMessage;
                        }

                        if (dtCheckOutDate < dtCheckInDate) {
                            ValidationMessage = "EndDate should be greater than or equal to StartDate @RowNo - " + (i + 1);
                            return ValidationMessage;
                        }


                        if (!Util.IsEmpty(dtCheckInDate) && !Util.IsEmpty(dtCheckOutDate) && dtCheckInDate.toString() != dtCheckOutDate.toString()) {//dtCheckInDate != dtCheckOutDate) {
                            ValidationMessage = "Cannot Apply more than one day @RowNo - " + (i + 1);
                            return ValidationMessage;
                        }

                        if (parseInt(sEmpID) > 1) {

                            //#region Check Payroll Locked
                            if (this.ScreenObject.Preferences.ContainsKey("CheckPayrollLocked") && this.ScreenObject.Preferences["CheckPayrollLocked"] == "True") {
                                if (dtCheckInDate != null) {
                                    ValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(dtCheckInDate), Util.ParseDate(dtCheckInDate), this.ScreenObject.DocumentType);
                                }
                                else if (dtCheckOutDate != null) {
                                    ValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(dtCheckOutDate), Util.ParseDate(dtCheckOutDate), this.ScreenObject.DocumentType);
                                }
                                if (ValidationMessage != "")
                                    return ValidationMessage;
                            }


                            //#region Check whether Employee is on Leave

                            let dtChk1 = BaseService.common.GetDataTable("PAY109", sEmpID + "~" + Util.ParseDate(dtCheckInDate).ToString("dd MMM yyyy"));
                            if (dtChk1 != null && dtChk1.length > 0) {
                                if (Util.String(dtChk1[0]["Session"]).toUpperCase() == "BOTH" || session.toUpperCase() == "BOTH") {
                                    ValidationMessage = "Employee is on Leave, Cannot save the record - Voucher No : " + dtChk1[0]["VoucherNo"].toString();
                                    return ValidationMessage;
                                }
                            }

                            //#endregion

                            //#region Check Duplicate Timings In Attendance Doc.

                            if (session.toUpperCase() == "BOTH") {
                                let dtE = BaseService.common.GetDataTable("PAY110", sEmpID + "~" + Util.ParseDate(dtCheckInDate).ToString("dd MMM yyyy") + "~" + Util.ParseDate(dtCheckOutDate).ToString("dd MMM yyyy"));
                                if (dtE != null && dtE.length > 0) {
                                    ValidationMessage = "Attendence Already Posted, Cannot save the record - Voucher No : " + dtE[0]["VoucherNo"].toString();
                                    break;
                                }
                            }

                            //#endregion

                            //#region Validating duplicate Timings of Employees
                            this.drcc1 = this.dtPayEmps.filter(x => x.NodeID == sEmpID);
                            let sVoucherNo = this.GetDuplicateTimingsOfEmployeeTimeSheet(new Date(dtCheckInDate).ToString("dd/MMM/yyyy"), sEmpID, i, this.ScreenObject.DocumentType);
                            if (sVoucherNo != "") {
                                try {
                                    parseInt(sVoucherNo);
                                    this.DisplayMessage = "Employee has already worked on these timings, can't allow same timings. Check Timings of the Employee - " + this.drcc1[0]["Code"].toString() + " @ Row No - " + parseInt(sVoucherNo);
                                }
                                catch {
                                    this.DisplayMessage = "Employee has already worked on these timings, can't allow same timings. Check Timings of the Employee - " + this.drcc1[0]["Code"].toString() + " @ Voucher No - " + sVoucherNo;
                                }
                                this.MessageVisibility = true;
                                return this.DisplayMessage;
                            }
                            //#endregion
                        }
                    }
                }
            }

            //#endregion


            Logger.InfoLog("AddEditDocumentViewModel::Exiting CheckDocumentValidationsOnSave");
        }
        catch (error) {
            ValidationMessage = "Problem processing your request please contact administrator";
            Logger.ErrorLog("AddEditDocumentViewModel:: CheckDocumentValidationsOnSave" + error.stack);

        }
        return ValidationMessage;
    }
    lstLastLeaveDate: Dictionary<any>;
    private ConsolidatedLeavesAddDates(iRowID: number, LeaveMonth: Date, sEmpSeqNo: string, dsCCData: any, LeaveTypeID: number, dsEmpInfo: any) {
        let dtFrom, dtTo, dtPM, dtPMSt, dtPMEnd, dtnew;
        let dDays = 0, iDays = 0;
        dDays = parseFloat(this.ScreenObject.GridData[iRowID]["dcNum1"]);


        let refObj = { PayrollMonth: dtPM, PayrollMonthStart: dtPMSt, PayrollMonthEnd: dtPMEnd }
        Util.SetPayrollDate(LeaveMonth.Date(), refObj);
        dtPM = refObj.PayrollMonth
        dtPMSt = refObj.PayrollMonthStart
        dtPMEnd = refObj.PayrollMonthEnd

        if (dDays > 0) {
            dtFrom = new Date(); dtTo = new Date(); dtnew = new Date();
            iDays = 0;

            if (!Util.IsEmpty(this.lstLastLeaveDate) && this.lstLastLeaveDate.ContainsKey(sEmpSeqNo)) {
                dtPMSt = this.lstLastLeaveDate[parseInt(sEmpSeqNo)];
                dtPMSt = dtPMSt.AddDays(1);
            }

            if (dDays >= 1) {
                while (dtPMSt <= dtPMEnd) {
                    if (this.IsValidDate(dtPMSt, sEmpSeqNo, dsCCData, LeaveTypeID, dsEmpInfo)) {
                        iDays++;
                        if (dtFrom.ToString("dd MMM yyyy") == dtnew.ToString("dd MMM yyyy")) {
                            dtFrom = dtPMSt;
                        }
                        if (Math.trunc(dDays) == iDays) {
                            dtTo = dtPMSt;
                            dtPMSt = dtPMSt.AddDays(1);
                            break;
                        }
                    }
                    dtPMSt = dtPMSt.AddDays(1);
                }
            }
            if (dDays > Math.trunc(dDays)) {
                while (dtPMSt <= dtPMEnd) {
                    if (this.IsValidDate(dtPMSt, sEmpSeqNo, dsCCData, LeaveTypeID, dsEmpInfo)) {
                        break;
                    }
                    dtPMSt = dtPMSt.AddDays(1);
                }
                dtFrom = dtPMSt;
                dtTo = dtPMSt;
            }

            if (Util.IsEmpty(this.lstLastLeaveDate) || !this.lstLastLeaveDate.ContainsKey(sEmpSeqNo))
                this.lstLastLeaveDate.push(sEmpSeqNo, dtTo);
            else
                this.lstLastLeaveDate[parseInt(sEmpSeqNo)] = dtTo;

            this.ScreenObject.GridData[iRowID]["dcAlpha4"] = Util.ParseDate(dtFrom).ToString(BaseService.SessionManager.Preferences["Date Format"]);
            this.ScreenObject.GridData[iRowID]["dcAlpha4_Key"] = Util.ParseDate(dtFrom)
            this.ScreenObject.GridData[iRowID]["dcAlpha5"] = Util.ParseDate(dtTo).ToString(BaseService.SessionManager.Preferences["Date Format"]);
            this.ScreenObject.GridData[iRowID]["dcAlpha5_Key"] = Util.ParseDate(dtTo);

            if (dDays >= 1)
                this.ScreenObject.GridData[iRowID]["dcAlpha6"] = "Both";
            else
                this.ScreenObject.GridData[iRowID]["dcAlpha6"] = "Session1";
        }
    }

    private IsValidDate(dtCheck: Date, sEmpSeqNo: string, dsData: any, LeaveTypeID: number, dsEmpInfo: any): boolean {

        let drccData = null;
        let dtcc: any;
        if (dsData != null && dsData.Tables.length > 0) {
            dtcc = dsData.Tables[0];
            for (let index = 0; index < dsData.Columns.length; index++) {
                const dc = dsData.Columns[index];
                if (!dc.Contains("CCNID") || dc.Contains("Name"))
                    continue;
                dtcc.forEach(row => {
                    row["dc" + dc + "_Key"] = row[dc];
                });
            }


            dtcc.forEach(row => {
                row["dcCCNID51_Key"] = row["EmpSeqNo"];
            });

            drccData = dtcc.filter(x => x.EmpSeqNo == sEmpSeqNo);
        }
        if (this.objPayDayCheck == null)
            this.objPayDayCheck = new PayDayCheck(this.ScreenObject);

        drccData[0]["PayrollType"] = "";
        this.objPayDayCheck.CheckIsHolidayDate(sEmpSeqNo, dtCheck.ToString("dd MMM yyyy"), drccData[0]);

        if (drccData[0]["PayrollType"] != "") {

            let sGradeID: string = "", sIncludeorExclude: string = "";
            if (dsEmpInfo != null && dsEmpInfo.Tables.length > 0) {
                if (dsEmpInfo.Tables.length > 1 && dsEmpInfo.Tables[1].length > 0) {
                    let dr = dsEmpInfo.Tables[1].filter(x => x.EmpSeqNo == sEmpSeqNo);
                    if (dr != null && dr.Length > 0)
                        sGradeID = dr[0]["GradeID"].ToString();
                }

                if (dsEmpInfo.Tables[0].length > 0 && !Util.IsEmpty(sGradeID)) {
                    let dr = dsEmpInfo.Tables[0].filter(x => x.GradeID == sGradeID && x.ComponentID == LeaveTypeID);
                    if (dr != null && dr.Length > 0)
                        sIncludeorExclude = dr[0]["IncludeRExclude"].ToString();
                }
            }

            if (sIncludeorExclude != null && sIncludeorExclude.length > 0) {
                if ((sIncludeorExclude == "IncludeWeeklyOffs" || sIncludeorExclude == "ExcludeHolidays") && drccData[0]["PayrollType"].toString() == "Holiday")
                    return false;
                else if ((sIncludeorExclude == "IncludeHolidays" || sIncludeorExclude == "ExcludeWeeklyOffs") && drccData[0]["PayrollType"].toString() == "WeeklyOff")
                    return false;
                else if (sIncludeorExclude == "ExcludeBoth")
                    return false;
            }
        }

        return true;
    }

    public ValidateMaxAllowedAbsenseMinutes(sEmpSeqNo: string): string {
        let sRet = "";

        if (this.ScreenObject.GridData.length > 0) {
            let dtFrom, dtTo, dtPM, dtPMS, dtPME;
            let lstPM = new Array<Date>();

            let obj1: any = this.ScreenObject.GridData.Compute("min", "dcAlpha3_Key");
            let obj2: any = this.ScreenObject.GridData.Compute("max", "dcAlpha3_Key");
            let dtMinDate = new Date(), dtMaxDate = new Date();
            if (obj1 != null)
                dtMinDate = Util.ParseDate(obj1);

            if (obj2 != null)
                dtMaxDate = Util.ParseDate(obj2);

            let refObj = { dtPM: dtPM, dtFrom: dtFrom, dtTo: dtTo }
            Util.SetPayrollDate(dtMinDate.Date(), refObj);
            dtPM = refObj.dtPM
            dtFrom = refObj.dtFrom
            dtTo = refObj.dtTo

            lstPM.push(dtPM);

            refObj = { dtPM: dtPM, dtFrom: dtFrom, dtTo: dtTo }
            Util.SetPayrollDate(dtMaxDate.Date(), refObj);
            dtPM = refObj.dtPM
            dtFrom = refObj.dtFrom
            dtTo = refObj.dtTo
            if (!lstPM.Contains(dtPM))
                lstPM.push(dtPM);

            let dsS = BaseService.common.GetDataSet3("PAY093", dtFrom.Date.ToString("dd MMM yyyy") + "~" + dtTo.Date.ToString("dd MMM yyyy"), this.ScreenObject.DocID + "~" + sEmpSeqNo, BaseService.SessionManager.Preferences["MaxAllowedMinToRegularizeDocument"]);
            let dtS = dsS.Tables[0];


            let drc1;
            let dMins = 0, dMaxMins = 0;
            let dtAson = new Date();
            let ovar: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toUpperCase() == "DCALPHA10");
            if (ovar != undefined) {
                dtAson = ovar.Date;
            }

            let ObjArray = [];
            ObjArray.push(dtAson.Date().ToString("dd MMM yyyy"));
            ObjArray.push(" AND EmpSeqNo=" + sEmpSeqNo);
            ObjArray.push(0);
            ObjArray.push(BaseService.SessionManager.RoleID);
            ObjArray.push(BaseService.SessionManager.UserID);
            ObjArray.push(BaseService.SessionManager.LanguageID);

            let dsEmps = BaseService.common.GetDataSet_SP(ObjArray, "spPAY_GetEmpMasterCCDetails");

            let iDim = 0;
            let LockDim = "", sExp1 = "";

            if (dsS.Tables[1] != null && dsS.Tables[1].length > 0) {
                for (let i = 0; i < dsS.Tables[1].length; i++) {
                    LockDim = dsS.Tables[1][i]["SysColumnName"].toString();
                    let drc = dsEmps.Tables[0].filter(x => x.EmpSeqNo == sEmpSeqNo);
                    if (drc != null && drc.length > 0) {
                        iDim = parseInt(drc[0]["CCNID" + LockDim.Replace("dcCCNID", "")]);
                    }

                    if (sExp1.length > 0)
                        sExp1 += " AND ";

                    sExp1 += LockDim + "=" + iDim;
                }
            }

            // if (sExp1.length > 0)
            //     sQ += " AND " + sExp1;


            let dtM = BaseService.common.GetDataTable("PAY094", BaseService.SessionManager.Preferences["MaxAllowedMinToRegularizeDocument"] + "~" + sExp1);
            if (dtM.length > 0)
                dMaxMins = parseFloat(dtM[0]["MaxMinutes"]);

            if (dMaxMins > 0) {
                let m = 0;
                let dtmp = lstPM[0];
                while (lstPM.length > m && dtmp <= lstPM[m]) {
                    dMins = 0;
                    let refObj1 = { dtPM: dtPM, dtPMS: dtPMS, dtPME: dtPME }
                    Util.SetPayrollDate(dtmp.Date(), refObj1);
                    dtPM = refObj1.dtPM
                    dtPMS = refObj1.dtPMS
                    dtPME = refObj1.dtPME
                    if (dtS != null && dtS.length > 0) {
                        drc1 = dtS.filter(x => x.DADate >= dtPMS.ToString("dd MMM yyyy") && x.DADate <= dtPME.ToString("dd MMM yyyy"));
                        if (drc1 != null && drc1.length > 0) {
                            for (let j = 0; j < drc1.length; j++) {
                                if (!Util.IsEmpty(drc1[j]["AdjChkInMins"]))
                                    dMins += parseFloat(drc1[j]["AdjChkInMins"]);

                                if (!Util.IsEmpty(drc1[j]["AdjChkOutMins"]))
                                    dMins += parseFloat(drc1[j]["AdjChkOutMins"]);

                                if (dMins > dMaxMins) {
                                    sRet = "Maximum Allowed Absense minutes exceeded for the Payroll Month : " + dtPM.ToString("MMM, yyyy");
                                    return sRet;
                                }
                            }
                        }
                    }

                    if (dMins > dMaxMins) {
                        sRet = "Maximum Allowed Absense minutes exceeded for the Payroll Month : " + dtPM.ToString("MMM, yyyy");
                        return sRet;
                    }
                    ////////

                    drc1 = this.ScreenObject.GridData.filter(x => x.dcAlpha3_Key >= dtPMS.ToString("dd MMM yyyy") && x.dcAlpha3_Key <= dtPME.ToString("dd MMM yyyy") && x.dcAlpha12 == 'True');
                    if (drc1 != null && drc1.length > 0) {
                        let dAdjChkInMins = 0, dAdjChkOutMins = 0;
                        for (let j = 0; j < drc1.length; j++) {
                            if (parseBoolean(drc1[j]["dcAlpha12"])) {
                                dAdjChkInMins = Util.ParseDate(drc1[j]["dcAlpha4_Key"]).Subtract(Util.ParseDate(drc1[j]["dcAlpha8_Key"])).TotalMinutes;
                                dAdjChkOutMins = Util.ParseDate(drc1[j]["dcAlpha9_Key"]).Subtract(Util.ParseDate(drc1[j]["dcAlpha5_Key"])).TotalMinutes;

                                dMins += dAdjChkInMins;
                                dMins += dAdjChkOutMins;

                                if (dMins > dMaxMins) {
                                    sRet = "Maximum Allowed Absense minutes exceeded for the Payroll Month : " + dtPM.ToString("MMM, yyyy");
                                    return sRet;
                                }
                            }
                        }
                        if (dMins > dMaxMins) {
                            sRet = "Maximum Allowed Absense minutes exceeded for the Payroll Month : " + dtPM.ToString("MMM, yyyy");
                            return sRet;
                        }
                    }

                    m++;
                    dtmp = dtmp.AddMonths(1);
                }
            }
        }
        return sRet;
    }


    private CheckIsPayrollProcessed(sPayrollMonth: string, EmpSeqNo: string): boolean {
        let dtC = BaseService.common.GetDataSet3("PAY030", EmpSeqNo, sPayrollMonth).Tables[0];
        if (dtC != null && dtC.length > 0)
            return true;
        else
            return false;
    }

    FillPostPastSalEarningDeductionDtls(col: any) {
        if (!(col as PactExtraFieldDateData))
            return;

        if ((col as PactExtraFieldDateData).SelectedDateChanged != null || BaseService.SessionManager.IsWebApplication) {
            this.FillEarnDeductDetails(1, parseInt(Util.ParseDate((col as PactExtraFieldDateData).Date).ToString("yyyy")));
            this.DimensionSelectedvalueData();
        }
    }

    //#region Bulk Appraisals

    private dtpBulkApprEffectFrom_SelectedDateChanged(sender: any) {
        if ((sender as PactExtraFieldDateData).Date == null)
            return;
        if ((sender as PactExtraFieldDateData).SelectedDateChanged.IsSubscribed && (sender as PactExtraFieldDateData).Date) {
            let dtTmp = (sender as PactExtraFieldDateData).Date;
            sender.Date = new Date(dtTmp.getFullYear(), dtTmp.getMonth(), 1);
            var fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
            if (fld != null && fld instanceof PactExtraFieldDateData) {
                fld.Date = sender.Date;
            }

        }
    }

    FillComponentsBasedOnGradeSlabs(iEmpSeqNo: number, sComPar: string) {
        //#region Validate Grade wise Salary Slabs

        if (BaseService.SessionManager.Preferences.ContainsKey("ConsiderGradeWiseSalarySlabs") && BaseService.SessionManager.Preferences["ConsiderGradeWiseSalarySlabs"] == "True") {
            let sGradeID = "0";

            let vFld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid53");
            if (vFld != undefined) {
                if (vFld instanceof PactListBoxData)
                    sGradeID = vFld.SelectedValue.toString();
                else if (vFld instanceof PactCodeNameListBoxData)
                    sGradeID = vFld.SelectedValue.toString();
            }
            // query written in api document controller --- DOC054
            let dtGrSalSalbs = BaseService.common.GetDataTable("DOC054", sGradeID + "~" + iEmpSeqNo);

            if (dtGrSalSalbs != null && dtGrSalSalbs.length > 0) {
                //dtGrSalSalbs.Columns.Contains("ComponentID")
                if (!Util.IsEmpty(dtGrSalSalbs[0]["ComponentID"]) && parseInt(dtGrSalSalbs[0]["ComponentID"]) > 0) {
                    let drGrid: any = null;
                    let RowPosition = 0;
                    this.ScreenObject.GridDataObj.Clear();
                    let drCL: any = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                    for (let c = 0; c < dtGrSalSalbs.length; c++) {
                        if (this.ValidateGradeWiseSalarySlabsApplicableFormula(dtGrSalSalbs[c], iEmpSeqNo)) {
                            drGrid = this.ScreenObject.GridDataObj.NewRow();
                            this.ScreenObject.GridDataObj.insertRowAt(drGrid, RowPosition);
                            RowPosition++;
                            if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"])) {
                                drGrid["ProductID_Key"] = drCL[0]["UserDefaultValue"];
                            }

                            drGrid["dcCCNID52_Key"] = dtGrSalSalbs[c]["ComponentID"];
                            drGrid["dcCCNID52"] = dtGrSalSalbs[c]["ComponentName"];

                            let dMinVal = 0, dMaxVal = 0;
                            dMinVal = Util.Double(dtGrSalSalbs[c]["MinAmount"]);
                            dMaxVal = Util.Double(dtGrSalSalbs[c]["MaxAmount"]);

                            if (sComPar == "PickMin")
                                drGrid["dcNum1"] = dMinVal.toString();
                            else
                                drGrid["dcNum1"] = dMaxVal.toString();
                        }
                    }
                }
                else {
                    this.DisplayMessage = "Employee Already has same Grade,Please Change the Grade  ";
                    this.MessageVisibility = true;
                    return;
                }

            }
        }

        //#endregion
    }

    private ValidateGradeWiseSalarySlabsApplicableFormula(drcGV: any, iempseqno: number): boolean {
        if (drcGV != null && drcGV["ApplicableFormula"] != null && drcGV["ApplicableFormula"] != null && drcGV["ApplicableFormula"].toString().Trim() != "") {
            let oEvalPayFormulas: EvaluatePayrollFormulas = new EvaluatePayrollFormulas();
            oEvalPayFormulas.sEmpSeqNo = iempseqno.toString();

            let refObj = { PayrollMonth: oEvalPayFormulas.PayrollMonth, PayrollMonthStart: oEvalPayFormulas.PayrollMonthStart, PayrollMonthEnd: oEvalPayFormulas.PayrollMonthEnd }
            Util.SetPayrollDate(new Date(), refObj);
            oEvalPayFormulas.PayrollMonth = refObj.PayrollMonth
            oEvalPayFormulas.PayrollMonthStart = refObj.PayrollMonthStart
            oEvalPayFormulas.PayrollMonthEnd = refObj.PayrollMonthEnd
            //Util.SetPayrollDate(DateTime.Now.Date, out oEvalPayFormulas.PayrollMonth, out oEvalPayFormulas.PayrollMonthStart, out oEvalPayFormulas.PayrollMonthEnd);
            oEvalPayFormulas.arrLstCPFields[6].Clear();

            let oCPF: CPFields = new CPFields();
            oCPF.ComponentName = "GrdWiseSalSlabsFormula";
            oCPF.SNo = 1;
            oCPF.Formula = drcGV["ApplicableFormula"].toString();
            oCPF.dEarned = oCPF.dActual = "0";
            oEvalPayFormulas.arrLstCPFields[6].push(oCPF);

            oEvalPayFormulas.Intialize();
            oEvalPayFormulas.othMPField.BasicMonthly = 0;
            oEvalPayFormulas.othMPField.TotalLeaves = 0;
            oEvalPayFormulas.othMPField.DaysAttended = oEvalPayFormulas.othMPField.TotalDays;

            let dtEffectFrom = new Date();

            var fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
            if (fld != undefined && fld != null && fld instanceof PactExtraFieldDateData)
                dtEffectFrom = fld.Date;
            oEvalPayFormulas.isValidBulkAppraisal = true;
            oEvalPayFormulas.EffectFrom = dtEffectFrom;

            oEvalPayFormulas.ExecuteAllFormulas();

            if (oEvalPayFormulas.arrLstCPFields[6][0].ComponentName == "GrdWiseSalSlabsFormula") {
                if (parseFloat(oEvalPayFormulas.arrLstCPFields[6][0].dEarned) == 0)
                    return false;
                else
                    return true;
            }

        }
        return true;
    }

    private BulkAppraisalsInsert(): boolean {
        let dtBA: any = this.ScreenObject.GridData;
        if (dtBA != null && dtBA.length > 0) {
            let objAppr = null;//AddEditAppraisalViewModel //
            let lEmpID = 0, lCompID = 0, lEditSeqNo = 0;
            let dAmt = 0;
            let isFound = false;
            let sQ = "", sRemarks = "", sReason = "";
            let dtEffectFrom = Date.Today(), dtApplyFrom = Date.Today(), dtNextAppraisal = Date.Today();

            let isEmpOnBody = false;
            if (!Util.IsEmpty(dtBA[0]["dcCCNID51_Key"]))
                isEmpOnBody = true;

            if (isEmpOnBody) // Emp on Body
            {
                let dtDist: any = dtBA.ToTable(true, ["dcCCNID51_Key"]);
                let drc1: any;
                if (dtDist != null && dtDist.length > 0) {
                    for (let i = 0; i < dtDist.length; i++) {
                        if (Util.IsEmpty(dtDist[i]["dcCCNID51_Key"]))
                            continue;

                        lEmpID = parseInt(dtDist[i]["dcCCNID51_Key"]);
                        drc1 = dtBA.filter(x => x.dcCCNID51_Key == lEmpID);
                        if (drc1 != null && drc1.length > 0) {
                            let fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                            if (fld != undefined && fld != null && fld instanceof PactExtraFieldDateData)
                                dtEffectFrom = fld.Date;
                            else {
                                let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                                if (vFld2 != undefined && vFld2 != null && !Util.IsEmpty(drc1[0][vFld2.DisplayMember + "_Key"]))
                                    dtEffectFrom = Util.ParseDate(drc1[0][vFld2.DisplayMember + "_Key"]);
                            }

                            fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2")
                            if (fld != undefined && fld != null && fld instanceof PactExtraFieldDateData)
                                dtApplyFrom = fld.Date;
                            else {
                                let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha2");
                                if (vFld2 != undefined && vFld2 != null && !Util.IsEmpty(drc1[0][vFld2.DisplayMember + "_Key"]))
                                    dtApplyFrom = Util.ParseDate(drc1[0][vFld2.DisplayMember + "_Key"]);
                            }

                            fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                            if (fld != undefined && fld != null && fld instanceof PactExtraFieldDateData)
                                dtNextAppraisal = fld.Date;
                            else {
                                var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha4");
                                if (vFld2 != undefined && vFld2 != null && !Util.String(drc1[0][vFld2.DisplayMember + "_Key"]))
                                    dtNextAppraisal = Util.ParseDate(drc1[0][vFld2.DisplayMember + "_Key"]);
                            }

                            fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha6");
                            if (fld != undefined && fld != null && fld instanceof PactTextBoxData && !Util.String(fld.Text))
                                sReason = fld.Text;

                            fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha7");
                            if (fld != undefined && fld != null && fld instanceof PactTextBoxData && !Util.String(fld.Text))
                                sRemarks = fld.Text;


                            let dtA = BaseService.common.GetDataSet3("PAY031", lEmpID.toString(), dtEffectFrom.ToString("dd/MMM/yyyy")).Tables[0];
                            if (dtA != null && dtA.length > 0)
                                lEditSeqNo = parseInt(dtA[0]["SeqNo"]);
                            else
                                lEditSeqNo = 0;

                            objAppr = new AddEditAppraisalViewModel(null, lEmpID, new Date(), lEditSeqNo);
                            objAppr.isFromBulkAppraisals = true;
                            objAppr.EffectFrom.Date = dtEffectFrom;
                            objAppr.ActAppraisalFrom.Date = dtApplyFrom;
                            objAppr.NextAppraisal.Date = dtNextAppraisal;
                            objAppr.Remarks.Text = sRemarks;
                            objAppr.Reason.Text = sReason;

                            for (let j = 0; j < drc1.length; j++) {
                                lCompID = parseInt(drc1[j]["dcCCNID52_Key"]);
                                dAmt = parseFloat(drc1[j]["dcNum1"]);
                                isFound = false;

                                if (this.ScreenObject.Preferences.ContainsKey("BasicMonthlyFld") && !Util.IsEmpty(this.ScreenObject.Preferences["BasicMonthlyFld"]) && parseInt(this.ScreenObject.Preferences["BasicMonthlyFld"]) > 0) {
                                    if (lCompID == parseInt(this.ScreenObject.Preferences["BasicMonthlyFld"])) {
                                        objAppr.BasicMonthly.Text = dAmt.toString();
                                        isFound = true;
                                    }
                                }

                                if (this.ScreenObject.Preferences.ContainsKey("AnnualCTCFld") && !Util.IsEmpty(this.ScreenObject.Preferences["AnnualCTCFld"]) && parseInt(this.ScreenObject.Preferences["AnnualCTCFld"]) > 0) {
                                    if (lCompID == parseInt(this.ScreenObject.Preferences["AnnualCTCFld"])) {
                                        objAppr.AnnualCTC.Text = dAmt.toString();
                                        isFound = true;
                                    }
                                }

                                for (let e = 0; e < objAppr.dgvEarnings.Table.length; e++) {
                                    if (objAppr.dgvEarnings.Table[e]["EarComponentID"].toString() == lCompID.toString()) {
                                        objAppr.dgvEarnings.Table[e]["EarValue"] = dAmt;
                                        isFound = true;
                                        break;
                                    }
                                }
                                if (!isFound) {
                                    for (let e = 0; e < objAppr.dgvDeductions.Table.length; e++) {
                                        if (objAppr.dgvDeductions.Table[e]["DedComponentID"].toString() == lCompID.toString()) {
                                            objAppr.dgvDeductions.Table[e]["DedValue"] = dAmt;
                                            break;
                                        }
                                    }
                                }
                            }
                            objAppr.ExecuteFormulas();
                            objAppr.OnButtonClick("Save");
                            if (objAppr.DisplayMessage != null && objAppr.DisplayMessage.length > 0) {
                                this.DisplayMessage = objAppr.DisplayMessage;
                                return false;
                            }
                            else {
                                this.sApprUpdate += objAppr.strUpdate;
                            }

                        }

                    }
                }
            }
            else // Emp on Header
            {
                ////
                let ofld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName == "dcCCNID51");
                if (ofld != undefined) {
                    if (ofld.SelectedValue == null || Util.String(ofld.SelectedValue) == "") {
                        this.DisplayMessage = "Select Employee";
                        return false;
                    }
                    lEmpID = ofld.SelectedValue;
                }

                let sGradeID = "0";

                if (this.ScreenObject.Preferences.ContainsKey("UpdateGradeandAppraisalData") && this.ScreenObject.Preferences["UpdateGradeandAppraisalData"] == "True") {
                    let vFld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid53");
                    if (vFld != undefined) {
                        if (vFld instanceof PactListBoxData)
                            sGradeID = vFld.SelectedValue.toString();
                        else if (vFld instanceof PactCodeNameListBoxData)
                            sGradeID = vFld.SelectedValue.toString();
                    }
                }

                let fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                if (fld != undefined && fld != null && fld instanceof PactExtraFieldDateData)
                    dtEffectFrom = fld.Date;

                fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                if (fld != undefined && fld != null && fld instanceof PactExtraFieldDateData)
                    dtApplyFrom = fld.Date;

                fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                if (fld != undefined && fld != null && fld instanceof PactExtraFieldDateData)
                    dtNextAppraisal = fld.Date;

                fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha6");
                if (fld != undefined && fld != null && fld instanceof PactTextBoxData && !Util.IsEmpty(fld.Text))
                    sReason = fld.Text;

                fld = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha7");
                if (fld != undefined && fld != null && fld instanceof PactTextBoxData && !Util.IsEmpty(fld.Text))
                    sRemarks = fld.Text;


                let dtA = BaseService.common.GetDataSet3("PAY031", lEmpID.toString(), dtEffectFrom.ToString("dd/MMM/yyyy")).Tables[0];
                if (dtA != null && dtA.length > 0)
                    lEditSeqNo = parseInt(dtA[0]["SeqNo"]);
                else
                    lEditSeqNo = 0;

                objAppr = new AddEditAppraisalViewModel(null, lEmpID, new Date(), lEditSeqNo);
                objAppr.isFromBulkAppraisals = true;
                objAppr.EffectFrom.Date = dtEffectFrom;
                objAppr.ActAppraisalFrom.Date = dtApplyFrom;
                objAppr.NextAppraisal.Date = dtNextAppraisal;
                objAppr.Remarks.Text = sRemarks;
                objAppr.Reason.Text = sReason;
                objAppr.sBulkAppraisalGrade = sGradeID;

                for (let j = 0; j < dtBA.length; j++) {
                    if (!Util.IsEmpty(dtBA[j]["dcCCNID52_Key"])) {
                        lCompID = parseInt(dtBA[j]["dcCCNID52_Key"]);
                        dAmt = parseFloat(dtBA[j]["dcNum1"]);
                        isFound = false;

                        if (this.ScreenObject.Preferences.ContainsKey("BasicMonthlyFld") && !Util.IsEmpty(this.ScreenObject.Preferences["BasicMonthlyFld"]) && parseInt(this.ScreenObject.Preferences["BasicMonthlyFld"]) > 0) {
                            if (lCompID == parseInt(this.ScreenObject.Preferences["BasicMonthlyFld"])) {
                                objAppr.BasicMonthly.Text = dAmt.toString();
                                isFound = true;
                            }
                        }

                        if (this.ScreenObject.Preferences.ContainsKey("AnnualCTCFld") && !Util.IsEmpty(this.ScreenObject.Preferences["AnnualCTCFld"]) && parseInt(this.ScreenObject.Preferences["AnnualCTCFld"]) > 0) {
                            if (lCompID == parseInt(this.ScreenObject.Preferences["AnnualCTCFld"])) {
                                objAppr.AnnualCTC.Text = dAmt.toString();
                                isFound = true;
                            }
                        }

                        for (let e = 0; e < objAppr.dgvEarnings.Table.length; e++) {
                            if (objAppr.dgvEarnings.Table[e]["EarComponentID"].toString() == lCompID.toString()) {
                                objAppr.dgvEarnings.Table[e]["EarValue"] = dAmt;
                                isFound = true;
                                break;
                            }
                        }
                        if (!isFound) {
                            for (let e = 0; e < objAppr.dgvDeductions.Table.length; e++) {
                                if (objAppr.dgvDeductions.Table[e]["DedComponentID"].toString() == lCompID.toString()) {
                                    objAppr.dgvDeductions.Table[e]["DedValue"] = dAmt;
                                    break;
                                }
                            }
                        }
                    }

                }
                objAppr.ExecuteFormulas();
                objAppr.OnButtonClick("Save");
                if (objAppr.DisplayMessage != null && objAppr.DisplayMessage.length > 0) {
                    this.DisplayMessage = objAppr.DisplayMessage;
                    return false;
                }
                else {
                    this.sApprUpdate += objAppr.strUpdate;
                }


                ////
            }


            // for (let i = 0; i < dtBA.length; i++) {
            //     if (dtBA[i]["dcCCNID51_Key"] != null && dtBA[i]["dcCCNID51_Key"] != null && dtBA[i]["dcCCNID52_Key"] != null && dtBA[i]["dcCCNID52_Key"] != null) {
            //         lEmpID = parseInt(dtBA[i]["dcCCNID51_Key"]);
            //         lCompID = parseInt(dtBA[i]["dcCCNID52_Key"]);
            //         dAmt = parseFloat(dtBA[i]["dcNum1"]);
            //         isFound = false;

            //         let dtA = BaseService.common.GetDataSet3("PAY031", lEmpID.toString(), dtEffectFrom.ToString("dd/MMM/yyyy")).Tables[0];
            //         if (dtA != null && dtA.length > 0)
            //             lEditSeqNo = parseInt(dtA[0]["SeqNo"]);
            //         else
            //             lEditSeqNo = 0;

            //         objAppr = new AddEditAppraisalViewModel(null, lEmpID, Date.Today(), lEditSeqNo);
            //         objAppr.isFromBulkAppraisals = true;
            //         objAppr.EffectFrom.Date = dtEffectFrom;
            //         objAppr.ActAppraisalFrom.Date = dtApplyFrom;


            //         for (let e = 0; e < objAppr.dgvEarnings.Table.length; e++) {
            //             if (objAppr.dgvEarnings.Table[e]["EarComponentID"].toString() == lCompID.toString()) {
            //                 objAppr.dgvEarnings.Table[e]["EarValue"] = dAmt;
            //                 isFound = true;
            //                 break;
            //             }
            //         }
            //         if (!isFound) {
            //             for (let e = 0; e < objAppr.dgvDeductions.Table.length; e++) {
            //                 if (objAppr.dgvDeductions.Table[e]["DedComponentID"].toString() == lCompID.toString()) {
            //                     objAppr.dgvDeductions.Table[e]["DedValue"] = dAmt;
            //                     break;
            //                 }
            //             }
            //         }
            //         objAppr.ExecuteFormulas();
            //         objAppr.OnButtonClick("Save");
            //         if (objAppr.DisplayMessage != null && objAppr.DisplayMessage.length > 0) {
            //             this.DisplayMessage = objAppr.DisplayMessage;
            //             return false;
            //         }
            //         else {
            //             this.sApprUpdate += objAppr.strUpdate;
            //         }
            //     }
            // }
            if ((this.DisplayMessage == null || this.DisplayMessage.length == 0) && this.sApprUpdate.length > 0) {
                return true;
            }
        }
        return false;
    }


    //#endregion

    async ShowVacationCreditDaysDetail(iEmpSeqNo: number, dExDays: number = 0) {

        if (this.ScreenObject.Preferences.ContainsKey("ShowVacationCreditDaysDetail") && !Util.IsEmpty(this.ScreenObject.Preferences["ShowVacationCreditDaysDetail"]) && parseBoolean(this.ScreenObject.Preferences["ShowVacationCreditDaysDetail"])) {
            this.SetVisibiltiFalse();
            this.VacCrDaysVisibility = true;

            //this.VacCrDaysScreen.Clear();
        }

        if (iEmpSeqNo == 0)
            return;


        let dtFromDate = new Date(), dtToDate = new Date();
        let dblOPVacDays = 0;

        var fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
        if (fldAPV instanceof PactExtraFieldDateData && fldAPV.Date)
            dtFromDate = fldAPV.Date;

        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
        if (fldAPV instanceof PactExtraFieldDateData && fldAPV.Date)
            dtToDate = fldAPV.Date;

        fldAPV = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha22");
        if (fldAPV instanceof PactTextBoxData && !Util.IsEmpty(fldAPV.Text))
            dblOPVacDays = parseFloat(fldAPV.Text);

        if (BaseService.SessionManager.Preferences.ContainsKey("CalcVacDaysuptolastmonth") && parseBoolean(BaseService.SessionManager.Preferences["CalcVacDaysuptolastmonth"])) {
            dtFromDate = dtFromDate.AddDays(-(dtFromDate.getDate() - 1));
        }

        let dsVacDays = this.ScreenObject.GetVacationDays(dtFromDate, dtToDate, iEmpSeqNo, this.DocID, dblOPVacDays, 0);

        if (this.VacCrDaysScreen.length == 0 && dsVacDays != null && dsVacDays.Tables.length > 0) {
            if (this.ScreenObject.Preferences.ContainsKey("ShowVacationCreditDaysDetail") && !Util.IsEmpty(this.ScreenObject.Preferences["ShowVacationCreditDaysDetail"]) && parseBoolean(this.ScreenObject.Preferences["ShowVacationCreditDaysDetail"])) {
                let VacCrDaysDetail = new VacationCreditedDaysDetailViewModel(iEmpSeqNo, dsVacDays.Tables[5]);
                this.VacCrDaysScreen.push(VacCrDaysDetail);
                //BaseService.page.ShowDialog(this.VacCrDaysScreen[0], VacationCreditedDaysDetailComponent, { Title: "Vacation Credit Days Details" });
            }
        }
        else if (dsVacDays != null && dsVacDays.Tables.length > 0) {
            if (this.ScreenObject.Preferences.ContainsKey("ShowVacationCreditDaysDetail") && !Util.IsEmpty(this.ScreenObject.Preferences["ShowVacationCreditDaysDetail"]) && parseBoolean(this.ScreenObject.Preferences["ShowVacationCreditDaysDetail"])) {
                const ObjVac = this.VacCrDaysScreen[0];
                ObjVac.dgv.Clear();
                ObjVac.BindGrid(iEmpSeqNo, dsVacDays.Tables[5]);
                //BaseService.page.ShowDialog(this.VacCrDaysScreen[0], VacationCreditedDaysDetailComponent, { Title: "Vacation Credit Days Details" });
            }
        }

        if (this.VacCrDaysVisibility && this.VacCrDaysScreen.length > 0) {
            const { VacationCreditedDaysDetailComponent } = await import('../../ess/vacation-credited-days-detail/vacation-credited-days-detail.component')

            //BaseService.page.ShowDialog(this.VacCrDaysScreen[0], VacationCreditedDaysDetailComponent, { ShowCenter: true, HideClose: false, NoWidth: true, CloseOnOutsideClick: true, Title: 'Vacation Credit Days Details' });
        }
    }

    async onShowVacation() {
        if (this.VacCrDaysVisibility && this.VacCrDaysScreen.length > 0) {
            const { VacationCreditedDaysDetailComponent } = await import('../../ess/vacation-credited-days-detail/vacation-credited-days-detail.component')

            BaseService.page.ShowDialog(this.VacCrDaysScreen[0], VacationCreditedDaysDetailComponent, { ShowCenter: true, HideClose: false, NoWidth: true, CloseOnOutsideClick: true, Title: 'Vacation Credit Days Details' });
        }
    }


    private PayrollMonthTypeOfField_SelectedDateChanged(sender: any) {
        if (sender instanceof PactExtraFieldDateData) {
            if (sender.Date) {
                let dtTmp = sender.Date;
                sender.Date = new Date(dtTmp.getFullYear(), dtTmp.getMonth(), 1);
            }
        }
    }


    //#region Payroll Employees Filter Popup

    objEmpFilter: any;//EmpTreeFilterViewModel//
    sEmpFilter = "";

    async EmpFilter_Click(dtCCsAsOnDate: Date): Promise<string> {
        this.sEmpFilter = "";

        if (this.objEmpFilter == null)
            this.objEmpFilter = new EmpTreeFilterViewModel("", 0, 12);
        else {
            this.objEmpFilter.Filter = 12;
            this.objEmpFilter.InitControls();
        }

        if (this.objEmpFilter.Filter > 0) {
            await BaseService.page.openDialog(this.objEmpFilter, EmpTreeFilterComponent, { ShowCenter: true })
        }
        this.DialogResult = this.objEmpFilter.IsCompleted;
        if (this.objEmpFilter.IsCompleted) {
            if (this.objEmpFilter.CostCenterFilters.length > 0) {
                let RootID = 1;
                let strPK = '';
                let DimensionColumn = '';
                let sbDimWhere = '';

                for (let c = 0; c < this.objEmpFilter.CostCenterFilters.length; c++) {
                    let ccFilter = this.objEmpFilter.CostCenterFilters[c]
                    if (ccFilter.CostCenterID > 50000) {
                        RootID = 2;
                        strPK = "NodeID";
                        if (ccFilter.CostCenterID == 50051) {
                            DimensionColumn = "EmpSeqNo";
                        }
                        else {
                            DimensionColumn = "CCNID" + (ccFilter.CostCenterID - 50000);
                        }
                    }

                    if (ccFilter.SelectedNodes.length > 0) {
                        if (ccFilter.SelectedNodes.length == 1) {
                            sbDimWhere += " AND ";
                            sbDimWhere += DimensionColumn + "=" + ccFilter.SelectedNodes[0].Id;
                        }
                        else {
                            //To check root node selected or not
                            var root = ccFilter.SelectedNodes.find(x => x.Id == RootID && x.IsGroup);
                            if (!root) {
                                sbDimWhere += " AND ";
                                //If groups selected
                                if (IPrefetchFilter.IsGroupTree(ccFilter)) {
                                    let sbNodes = '';
                                    for (let k = 0; k < ccFilter.SelectedNodes.length; k++) {
                                        if (ccFilter.SelectedNodes[k].Parent == null || !ccFilter.SelectedNodes[k].Parent.IsSelected) {
                                            if (sbNodes.length > 0)
                                                sbNodes += ",";
                                            sbNodes += ccFilter.SelectedNodes[k].Id;
                                        }
                                    }
                                    if (sbNodes.length == 0)
                                        sbNodes += -12912;

                                    sbDimWhere += DimensionColumn + " IN ";
                                    sbDimWhere += " (select T." + strPK + " GTID from "
                                        + AddEditDocumentViewModel.GetTagTableName(ccFilter.CostCenterID) + " T with(nolock),"
                                        + AddEditDocumentViewModel.GetTagTableName(ccFilter.CostCenterID) + " GTP with(nolock) where T.lft BETWEEN GTP.lft AND GTP.rgt AND GTP." + strPK + " IN (";
                                    sbDimWhere += sbNodes.toString() + ")  group by T." + strPK + ")";
                                }
                                else {
                                    sbDimWhere += DimensionColumn + " IN (";
                                    for (let k = 0; k < ccFilter.SelectedNodes.length; k++) {
                                        if (k > 0)
                                            sbDimWhere += ",";
                                        sbDimWhere += ccFilter.SelectedNodes[k].Id;
                                    }
                                    sbDimWhere += ")";
                                }
                            }
                        }
                    }
                    else if (!ccFilter.DeleteButtonVisibility) {
                        sbDimWhere += " AND ";
                        sbDimWhere += DimensionColumn + "=-12912";
                    }
                }
                this.sEmpFilter = sbDimWhere.toString();
            }
            let sEmpSeqNos = this.FilterPayEmployees(dtCCsAsOnDate);
            return sEmpSeqNos;
        }
        Logger.InfoLog("AddEditDocumentsPayroll::Exiting EmpFilter_Click()");
        return "";
    }

    private FilterPayEmployees(dtCCsAsOnDate: Date): string {
        let sEmpSeqNos = "";
        try {
            if (BaseService.SessionManager.LocationID > 0 && BaseService.SessionManager.Preferences.ContainsKey("LocationWiseDimension") && BaseService.SessionManager.Preferences["LocationWiseDimension"].split(',').Contains("50051"))
                this.sEmpFilter += " AND EmpSeqNo IN ( Select NodeID From Com_CCCCData with(nolock) where CostCenterID=50051 and CCNID2=" + BaseService.SessionManager.LocationID + ")";

            if (!Util.IsEmpty(BaseService.SessionManager.sWHEmpFilteredEmpSeqNos))
                this.sEmpFilter += "  AND EmpSeqNo IN (" + BaseService.SessionManager.sWHEmpFilteredEmpSeqNos + ")";



            let ObjArray = [];
            ObjArray.push(dtCCsAsOnDate.ToString("dd MMM yyyy"));
            ObjArray.push(this.sEmpFilter);
            ObjArray.push(0);
            ObjArray.push(BaseService.SessionManager.RoleID);
            ObjArray.push(BaseService.SessionManager.UserID);
            ObjArray.push(BaseService.SessionManager.LanguageID);
            let dsEmps = BaseService.common.GetDataSet_SP(ObjArray, "spPAY_GetEmpMasterCCDetails");

            if (dsEmps != null && dsEmps.Tables.length > 0 && dsEmps.Tables[0].length > 0) {
                for (let i = 0; i < dsEmps.Tables[0].length; i++) {
                    if (sEmpSeqNos.Trim().length > 0)
                        sEmpSeqNos += ",";

                    sEmpSeqNos += dsEmps.Tables[0][i]["EmpSeqNo"].toString();
                }

                if (sEmpSeqNos.length > 0)
                    return sEmpSeqNos;
                else {
                    this.DisplayMessage = "No data found for the selected Criteria.";
                    this.MessageVisibility = true;
                    return "";
                }
            }
            Logger.InfoLog("AddEditDocumentsPayroll::Exiting FilterPayEmployees()");
            return "";
        }
        catch (error) {
            Logger.ErrorLog("AddEditDocumentsPayroll::EXCEPTION FilterPayEmployees()" + error.stack);
            return "";
        }
    }

    //#endregion


    //#region Lates Processing

    dtPayMon = new Date(); dtPayMonStart = new Date(); dtPayMonEnd = new Date(); dtLatesMonth = new Date(); dtLatesMonthStart = new Date(); dtLatesMonthEnd = new Date();

    private DoLateConsiderations(sEmpSeqNos: string) {
        if (BaseService.SessionManager.Preferences.ContainsKey("ConsiderLatesConfig") && BaseService.SessionManager.Preferences["ConsiderLatesConfig"] == "True" &&
            BaseService.SessionManager.Preferences.ContainsKey("LatesConfigBasedOn") && BaseService.SessionManager.Preferences["LatesConfigBasedOn"].toString().Trim() != "") {

            let IsShiftWise = false;
            let ssA = BaseService.SessionManager.Preferences["LatesConfigBasedOn"];
            if (ssA == "50073")
                IsShiftWise = true;

            let sArrBasedOn = ssA.split(',');


            let sArrEmpSeqNos = sEmpSeqNos.split(',');
            if (sArrEmpSeqNos.length > 0 && sArrBasedOn.length > 0) {
                var txtDatefld1 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha16") as PactExtraFieldDateData;
                if (txtDatefld1 instanceof PactExtraFieldDateData && !txtDatefld1.Date) {
                    this.DisplayMessage = "Select Payroll Month";
                    this.MessageVisibility = true;
                    txtDatefld1.SetFocus = true;
                    return;
                }
                let dtPM = new Date(txtDatefld1.Date.getFullYear(), txtDatefld1.Date.getMonth(), 1);
                let refObj = {
                    PayrollMonth: this.dtPayMon, PayrollMonthStart: this.dtPayMonStart, PayrollMonthEnd: this.dtPayMonEnd,
                    LatesMonth: this.dtLatesMonth, LatesMonthStart: this.dtLatesMonthStart, LatesMonthEnd: this.dtLatesMonthEnd
                }
                Util.SetPayrollDate(dtPM, refObj);
                this.dtPayMon = refObj.PayrollMonth
                this.dtPayMonStart = refObj.PayrollMonthStart
                this.dtPayMonEnd = refObj.PayrollMonthEnd

                this.dtLatesMonth = refObj.LatesMonth
                this.dtLatesMonthStart = refObj.LatesMonthStart
                this.dtLatesMonthEnd = refObj.LatesMonthEnd

                //#region Query
                let dsDATData = BaseService.common.GetDataSet3("PAY032", sEmpSeqNos, this.dtLatesMonth.ToString("dd/MMM/yyyy"), this.dtLatesMonthStart.ToString("dd/MMM/yyyy") + "," + this.dtLatesMonthEnd.ToString("dd/MMM/yyyy"));

                let al = [];
                al.push(BaseService.SessionManager.PayrollMonthEnd.ToString("dd/MMM/yyyy"));
                al.push(" a.IsGroup=0 AND a.NodeID IN(" + sEmpSeqNos + ")");
                al.push("");
                let dtEmpDim = BaseService.common.GetDataSet_SP(al, "spPAY_GetEmpDimensionsAsOnDate").Tables[0];

                let dt1: any = BaseService.common.GetDataTable("PAY095", sEmpSeqNos + "~" + this.dtLatesMonthStart.ToString("dd MMM yyyy") + "~" + this.dtLatesMonthEnd.ToString("dd MMM yyyy"));

                let dtShifts: any = BaseService.common.GetDataTable("PAY096", "");
                //#endregion


                let DefProdID = 0;
                let drCL = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                if (drCL.length > 0 && !Util.IsEmpty(drCL[0]["UserDefaultValue"]))
                    DefProdID = parseInt(drCL[0]["UserDefaultValue"]);

                let dicDISTDev: Dictionary<number>;
                let sColName = "", sLCIncludeRExclude = "", sDADayType = "";
                let sESeqNo = "";
                let dvDATData: any[], dvLatesConf: any[], dvEmpDistDA: any[];
                let drc;
                let dtDADate = new Date(), dtDev = new Date(), dtDASTime = new Date(),
                    dtDAShSTime = new Date(), dtDASTimeWD = new Date();
                let dLateMins = 0, dActBrkMins = 0, dBrkMins, dDevBrkMins = 0;
                let iCnt = 0, iDocID = 0;
                let dtEmpDistDA = null;
                let drw = null;
                let drwc;


                for (let e = 0; e < sArrEmpSeqNos.length; e++) {
                    dicDISTDev = new Dictionary<number>();
                    if (dsDATData != null && dsDATData.Tables.length > 0) {
                        if (dsDATData.Tables[1].length > 0) {
                            for (let d = 0; d < dsDATData.Tables[1].length; d++) {
                                if (!dicDISTDev.ContainsKey(dsDATData.Tables[1][d]["DISTDeviation"].toString() + "_NDMT")) {
                                    dicDISTDev.push(dsDATData.Tables[1][d]["DISTDeviation"].toString() + "_NDMT", 0);
                                    dicDISTDev.push(dsDATData.Tables[1][d]["DISTDeviation"].toString() + "_FENDMT", 0);
                                    dicDISTDev.push(dsDATData.Tables[1][d]["DISTDeviation"].toString() + "_IsNDMTDone", 0);
                                }
                            }
                        }
                    }

                    sESeqNo = sArrEmpSeqNos[e];
                    drc = dtEmpDim.filter(x => x.EmpSeqNo == sESeqNo);
                    if (drc != null && drc.length > 0) {
                        iCnt = 0;
                        let dtLC: any;
                        if (sArrBasedOn.filter(x => x.length > 1).length > 0) {
                            dvLatesConf = this.DoLate_Filter(dsDATData.Tables[1], drc[0]).filter(x => x.WEF <= this.dtLatesMonthEnd.Date());
                            dvLatesConf.sort((a, b) => a.WEF < b.WEF ? 1 : a.WEF > b.WEF ? -1 : 0)//"WEF DESC";

                            if (!IsShiftWise) {
                                if (dvLatesConf.length > 0) {
                                    iDocID = parseInt(dvLatesConf[0]["DocID"]);
                                    dvLatesConf = dsDATData.Tables[1].filter(x => x.DocID == iDocID);
                                    if (dvLatesConf.length > 0) {
                                        dtLC = dvLatesConf;
                                        dvLatesConf = dtLC;
                                        sLCIncludeRExclude = dvLatesConf[0]["IncludeRExclude"].toString();
                                    }
                                }
                            }

                            //if (dvLatesConf.length > 0) 
                            {
                                //iDocID = parseInt(dvLatesConf[0]["DocID"]);
                                //dvLatesConf = dsDATData.Tables[1].filter(x => x.DocID == iDocID);
                                //if (dvLatesConf.length > 0) 
                                {
                                    //let dtLC = dvLatesConf.Copy();
                                    //dvLatesConf = dtLC;
                                    //sLCIncludeRExclude = dvLatesConf[0]["IncludeRExclude"].toString();

                                    dvDATData = dsDATData.Tables[0].filter(x => x.EmpSeqNo == sESeqNo);
                                    dvDATData.sort((a, b) => (a.DailyAttDate > b.DailyAttDate) ? 1 : (a.DailyAttDate == b.DailyAttDate) ? ((a.StartTime > b.StartTime) ? 1 : -1) : -1)
                                    if (dvDATData.length > 0) {
                                        dtEmpDistDA = [];
                                        dtEmpDistDA = dvDATData.ToTable(true, ["DailyAttDate"]);
                                        for (let dd = 0; dd < dtEmpDistDA.length; dd++) {
                                            dtDADate = Util.ParseDate(dtEmpDistDA[dd]["DailyAttDate"]);

                                            dvEmpDistDA = dsDATData.Tables[0].filter(x => x.EmpSeqNo == sESeqNo && Util.ParseDate(x.DailyAttDate).ToString("dd MMM yyyy") == Util.ParseDate(dtDADate).ToString("dd MMM yyyy"));
                                            dvEmpDistDA.sort((a, b) => (a.DailyAttDate > b.DailyAttDate) ? 1 : (a.DailyAttDate == b.DailyAttDate) ? ((a.StartTime > b.StartTime) ? 1 : -1) : -1)

                                            if (dvEmpDistDA.length > 0) {

                                                if (IsShiftWise) {
                                                    // sBasedOn = "dcCCNID73=" + dvEmpDistDA[0]["ShiftSeqNo"];
                                                    // dvLatesConf = dsDATData.Tables[1].AsDataView();
                                                    // dvLatesConf.RowFilter = sBasedOn + " AND WEF<=#" + dtPayMonEnd.ToString("dd/MMM/yyyy") + "#";
                                                    // dvLatesConf.Sort = "WEF DESC";

                                                    dvLatesConf = dsDATData.Tables[1];
                                                    dvLatesConf = dvLatesConf.filter(x => x.dcCCNID73 == dvEmpDistDA[0]["ShiftSeqNo"] && x.WEF <= this.dtLatesMonthEnd.ToString("dd/MMM/yyyy"));
                                                    dvLatesConf.sort((a, b) => a.WEF < b.WEF ? 1 : a.WEF > b.WEF ? -1 : 0)//"WEF DESC";

                                                    if (dvLatesConf.length > 0) {
                                                        iDocID = parseInt(dvLatesConf[0]["DocID"]);
                                                        dvLatesConf = dvLatesConf.filter(x => x.DocID == iDocID);
                                                        if (dvLatesConf.length > 0) {
                                                            dtLC = dvLatesConf;//.ToTable();
                                                            dvLatesConf = dtLC;
                                                            sLCIncludeRExclude = dvLatesConf[0]["IncludeRExclude"].toString();
                                                        }
                                                    }
                                                    else
                                                        continue;
                                                }

                                                sDADayType = dvEmpDistDA[0]["DADayType"].toString();
                                                if (sDADayType != "") {
                                                    if (sDADayType == "WeeklyOff" && (sLCIncludeRExclude == "ExcludeBoth" || sLCIncludeRExclude == "ExcludeWeeklyOffs"))
                                                        continue;

                                                    else if (sDADayType == "Holiday" && (sLCIncludeRExclude == "ExcludeBoth" || sLCIncludeRExclude == "ExcludeHolidays"))
                                                        continue;
                                                }
                                            }

                                            let isRowAdded = false;
                                            let dChLateMins = 0
                                            for (let da = 0; da < dvEmpDistDA.length; da++) {
                                                drw = null;
                                                isRowAdded = false;

                                                if (da == 0) //Day First Check-in
                                                {
                                                    //#region Check-In
                                                    dvLatesConf = this.DoLate_Filter(dtLC, drc[0]).filter(x => x.DeviationWhen == 'Check-in is late By');
                                                    dvLatesConf.sort((a, b) => a.DevHours < b.DevHours ? 1 : -1)//"DevHours DESC";
                                                    if (dvLatesConf.length > 0) {
                                                        for (let lc = 0; lc < dvLatesConf.length; lc++) {
                                                            if (dvEmpDistDA[da]["ShiftType"].toString() == "Flexible" && dvEmpDistDA[da]["ConsiderStartandEndTimelimits"].toString().toUpperCase() == "NO")
                                                                continue;

                                                            dtDev = Util.ParseDate(dvLatesConf[lc]["DevHours"]);
                                                            dtDASTime = Util.ParseDate(dvEmpDistDA[da]["StartTime"]);

                                                            if ((Util.ParseDate(dvEmpDistDA[da]["StartTime"]) == Util.ParseDate(dvEmpDistDA[da]["EndTime"])) ||
                                                                (Util.ParseDate(dvEmpDistDA[da]["StartTime"]) > Util.ParseDate(dvEmpDistDA[da]["DADateShiftEndTime"]) && Util.ParseDate(dvEmpDistDA[da]["EndTime"]) > Util.ParseDate(dvEmpDistDA[da]["DADateShiftEndTime"]))) {
                                                                if (Util.ParseDate(dvEmpDistDA[da]["EndTime"]) > Util.ParseDate(dvEmpDistDA[da]["DADateShiftEndTime"]))
                                                                    dtDASTime = Util.ParseDate(dvEmpDistDA[da]["DADateShiftEndTime"]);
                                                            }

                                                            dtDAShSTime = Util.ParseDate(dvEmpDistDA[da]["DADateShiftStartTime"]);

                                                            if (dt1 != null && dt1.length > 0 && Util.ParseDate(dvEmpDistDA[da]["Session1StartTime"]) != Util.ParseDate(dvEmpDistDA[da]["Session1EndTime"])) {
                                                                let dr2 = dt1.filter(x => x.EmpSeqNo == sESeqNo && x.tDOCUMENTTYPE == 62 && x.SESSION != 'Both' && ((Util.ParseDate(x.FromDate).ToString("dd MMM yyyy") >= dtDASTime.ToString("dd MMM yyyy") && Util.ParseDate(x.ToDate).ToString("dd MMM yyyy") <= dtDASTime.ToString("dd MMM yyyy")) || (Util.ParseDate(x.FromDate).ToString("dd MMM yyyy") <= dtDASTime.ToString("dd MMM yyyy") && Util.ParseDate(x.ToDate).ToString("dd MMM yyyy") >= dtDASTime.ToString("dd MMM yyyy"))));

                                                                if (dr2 != null && dr2.length > 0) {
                                                                    if (dr2[0]["session"].toString().toLowerCase() == "session1") {
                                                                        dtDASTimeWD = Util.ParseDate(dvEmpDistDA[da]["DASession2StartTime"]).AddHours(dtDev.getHours()).AddMinutes(dtDev.getMinutes());
                                                                        dtDAShSTime = Util.ParseDate(dvEmpDistDA[da]["DASession2StartTime"]);
                                                                    }
                                                                    else {
                                                                        dtDASTimeWD = Util.ParseDate(dvEmpDistDA[da]["DASession1StartTime"]).AddHours(dtDev.getHours()).AddMinutes(dtDev.getMinutes());
                                                                        dtDAShSTime = Util.ParseDate(dvEmpDistDA[da]["DASession1StartTime"]);
                                                                    }
                                                                }
                                                                else
                                                                    dtDASTimeWD = Util.ParseDate(dvEmpDistDA[da]["DADateShiftStartTime"]).AddHours(dtDev.getHours()).AddMinutes(dtDev.getMinutes());
                                                            }
                                                            else
                                                                dtDASTimeWD = Util.ParseDate(dvEmpDistDA[da]["DADateShiftStartTime"]).AddHours(dtDev.getHours()).AddMinutes(dtDev.getMinutes());
                                                            if (dtDASTime > dtDASTimeWD) //Means Day-Check-in Late
                                                            {
                                                                dLateMins = dtDASTime.Subtract(dtDAShSTime).TotalMinutes;
                                                                dChLateMins = dLateMins;
                                                                ////Adding Row
                                                                drw = this.ScreenObject.GridDataObj.NewRow();
                                                                drw["DocSeqNo"] = this.ScreenObject.GridData.length + 1;
                                                                drw["ProductID_Key"] = DefProdID;
                                                                drw["LinkedInvDocDetailsID"] = dvLatesConf[lc]["InvDocDetailsID"];
                                                                drw["dcCCNID51_Key"] = sESeqNo;
                                                                drw["dcCCNID51Code"] = drc[0]["EmpCode"].toString();
                                                                drw["dcCCNID51"] = drc[0]["EmpName"].toString();
                                                                drw["dcAlpha1"] = dvEmpDistDA[da]["VoucherNo"];
                                                                drw["dcAlpha2"] = dvEmpDistDA[da]["DocSeqNo"];
                                                                drw["dcAlpha3"] = dtDADate.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                                drw["dcAlpha3_Key"] = dtDADate;
                                                                drw["dcAlpha4"] = Util.ParseDate(dvEmpDistDA[da]["StartTime"]).ToString("HH:mm");
                                                                drw["dcAlpha5"] = Util.ParseDate(dvEmpDistDA[da]["EndTime"]).ToString("HH:mm");
                                                                drw["dcCCNID73_Key"] = dvEmpDistDA[da]["ShiftSeqNo"].toString();
                                                                drw["dcCCNID73"] = dvEmpDistDA[da]["ShiftName"].toString();
                                                                drw["dcAlpha6"] = Util.ParseDate(dvEmpDistDA[da]["ShiftStartTime"]).ToString("HH:mm");
                                                                drw["dcAlpha7"] = Util.ParseDate(dvEmpDistDA[da]["ShiftEndTime"]).ToString("HH:mm");

                                                                drw["dcAlpha8"] = dLateMins;

                                                                ////END
                                                                drw["dcAlpha15"] = "";
                                                                if (dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_IsNDMTDone"] == 0) {
                                                                    iCnt = parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"]);
                                                                    dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"] = (iCnt + 1);
                                                                    if (parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"]) > parseInt(dvLatesConf[lc]["NDMT"])) {
                                                                        if (drw["dcAlpha15"] != null && drw["dcAlpha15"] != null && drw["dcAlpha15"].toString().length > 0)
                                                                            drw["dcAlpha15"] += ";Deduct - " + dvLatesConf[lc]["NDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["NDMTDeduct"];
                                                                        else
                                                                            drw["dcAlpha15"] = "Deduct - " + dvLatesConf[lc]["NDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["NDMTDeduct"];

                                                                        if (dvLatesConf[lc]["NDMTDeduct"].toString() == "Leaves") {
                                                                            if (dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null && dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null)
                                                                                drw["dcAlpha28"] = dvLatesConf[lc]["LeaveTypesDeductionOrder"];
                                                                        }

                                                                        dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"] = 0;
                                                                        dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_IsNDMTDone"] = 1;
                                                                    }
                                                                }
                                                                else //For Every Next 
                                                                {
                                                                    iCnt = parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"]);
                                                                    dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"] = (iCnt + 1);
                                                                    if (parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"]) > parseInt(dvLatesConf[lc]["FENDMT"])) {
                                                                        if (drw["dcAlpha15"] != null && drw["dcAlpha15"] != null && drw["dcAlpha15"].toString().length > 0)
                                                                            drw["dcAlpha15"] += ";Deduct - " + dvLatesConf[lc]["FENDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["FENDMTDeduct"];
                                                                        else
                                                                            drw["dcAlpha15"] = "Deduct - " + dvLatesConf[lc]["FENDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["FENDMTDeduct"];

                                                                        if (dvLatesConf[lc]["FENDMTDeduct"].toString() == "Leaves") {
                                                                            if (dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null && dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null)
                                                                                drw["dcAlpha28"] = dvLatesConf[lc]["LeaveTypesDeductionOrder"];
                                                                        }

                                                                        dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"] = 0;
                                                                    }
                                                                }
                                                                this.ScreenObject.GridDataObj.addRow(drw);
                                                                isRowAdded = true;
                                                                break;
                                                            }

                                                        }
                                                    }
                                                    //#endregion
                                                }

                                                if (da == dvEmpDistDA.length - 1) //Day Last Check-out
                                                {
                                                    //#region Check-Out
                                                    dvLatesConf = this.DoLate_Filter(dtLC, drc[0]).filter(x => x.DeviationWhen == 'Check-out is early By');
                                                    dvLatesConf.sort((a, b) => (a.DevHours < b.DevHours) ? 1 : -1)//"DevHours DESC";
                                                    if (dvLatesConf.length > 0) {
                                                        for (let lc = 0; lc < dvLatesConf.length; lc++) {
                                                            if (dvEmpDistDA[da]["ShiftType"].toString() == "Flexible" && dvEmpDistDA[da]["ConsiderStartandEndTimelimits"].toString().toUpperCase() == "NO")
                                                                continue;

                                                            dtDev = Util.ParseDate(dvLatesConf[lc]["DevHours"]);
                                                            dtDASTime = Util.ParseDate(dvEmpDistDA[da]["EndTime"]);

                                                            if ((Util.ParseDate(dvEmpDistDA[da]["StartTime"]) == Util.ParseDate(dvEmpDistDA[da]["EndTime"])) ||
                                                                (Util.ParseDate(dvEmpDistDA[da]["StartTime"]) < Util.ParseDate(dvEmpDistDA[da]["DADateShiftStartTime"]) && Util.ParseDate(dvEmpDistDA[da]["EndTime"]) < Util.ParseDate(dvEmpDistDA[da]["DADateShiftStartTime"]))) {
                                                                if (Util.ParseDate(dvEmpDistDA[da]["StartTime"]) < Util.ParseDate(dvEmpDistDA[da]["DADateShiftStartTime"]))
                                                                    dtDASTime = Util.ParseDate(dvEmpDistDA[da]["DADateShiftStartTime"]);
                                                            }

                                                            dtDAShSTime = Util.ParseDate(dvEmpDistDA[da]["DADateShiftEndTime"]);

                                                            if (dt1 != null && dt1.length > 0 && Util.ParseDate(dvEmpDistDA[da]["Session1StartTime"]) != Util.ParseDate(dvEmpDistDA[da]["Session1EndTime"])) {
                                                                let dr2 = dt1.filter(x => x.EmpSeqNo == sESeqNo && x.tDOCUMENTTYPE == 62 && x.SESSION != 'Both' && ((Util.ParseDate(x.FromDate).ToString("dd MMM yyyy") >= dtDASTime.ToString("dd MMM yyyy") && Util.ParseDate(x.ToDate).ToString("dd MMM yyyy") <= dtDASTime.ToString("dd MMM yyyy")) || (Util.ParseDate(x.FromDate).ToString("dd MMM yyyy") <= dtDASTime.ToString("dd MMM yyyy") && Util.ParseDate(x.ToDate).ToString("dd MMM yyyy") >= dtDASTime.ToString("dd MMM yyyy"))));

                                                                if (dr2 != null && dr2.length > 0) {
                                                                    if (dr2[0]["session"].toString().toLowerCase() == "session1") {
                                                                        dtDASTimeWD = Util.ParseDate(dvEmpDistDA[da]["DASession2EndTime"]).AddHours(dtDev.getHours()).AddMinutes(dtDev.getMinutes());
                                                                        dtDAShSTime = Util.ParseDate(dvEmpDistDA[da]["DASession2EndTime"]);
                                                                    }
                                                                    else {
                                                                        dtDASTimeWD = Util.ParseDate(dvEmpDistDA[da]["DASession1EndTime"]).AddHours(dtDev.getHours()).AddMinutes(dtDev.getMinutes());
                                                                        dtDAShSTime = Util.ParseDate(dvEmpDistDA[da]["DASession1EndTime"]);
                                                                    }
                                                                }
                                                                else
                                                                    dtDASTimeWD = Util.ParseDate(dvEmpDistDA[da]["DADateShiftStartTime"]).AddHours(dtDev.getHours()).AddMinutes(dtDev.getMinutes());
                                                            }
                                                            else
                                                                dtDASTimeWD = Util.ParseDate(dvEmpDistDA[da]["DADateShiftEndTime"]).AddHours(-dtDev.getHours()).AddMinutes(-dtDev.getMinutes());
                                                            if (dtDASTime < dtDASTimeWD) //Means Day-Check-out early
                                                            {
                                                                dLateMins = dtDAShSTime.Subtract(dtDASTime).TotalMinutes;
                                                                dChLateMins += dLateMins;

                                                                drwc = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key == sESeqNo && Util.ParseDate(x.dcAlpha3_Key).ToString("dd MMM yyyy") == Util.ParseDate(dtDADate.Date()).ToString("dd MMM yyyy"));
                                                                if (drwc != null && drwc.length > 0) {
                                                                    drw = drwc[0];
                                                                    isRowAdded = true;
                                                                }
                                                                else {
                                                                    drw = this.ScreenObject.GridDataObj.NewRow();
                                                                    drw["DocSeqNo"] = this.ScreenObject.GridData.length + 1;
                                                                    drw["ProductID_Key"] = DefProdID;
                                                                    drw["LinkedInvDocDetailsID"] = dvLatesConf[lc]["InvDocDetailsID"];
                                                                    drw["dcCCNID51_Key"] = sESeqNo;
                                                                    drw["dcCCNID51Code"] = drc[0]["EmpCode"].toString();
                                                                    drw["dcCCNID51"] = drc[0]["EmpName"].toString();
                                                                    drw["dcAlpha1"] = dvEmpDistDA[da]["VoucherNo"];
                                                                    drw["dcAlpha2"] = dvEmpDistDA[da]["DocSeqNo"];
                                                                    drw["dcAlpha3"] = dtDADate.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                                    drw["dcAlpha3_Key"] = dtDADate;
                                                                    drw["dcAlpha4"] = Util.ParseDate(dvEmpDistDA[da]["StartTime"]).ToString("HH:mm");
                                                                    drw["dcAlpha5"] = Util.ParseDate(dvEmpDistDA[da]["EndTime"]).ToString("HH:mm");
                                                                    drw["dcCCNID73_Key"] = dvEmpDistDA[da]["ShiftSeqNo"].toString();
                                                                    drw["dcCCNID73"] = dvEmpDistDA[da]["ShiftName"].toString();
                                                                    drw["dcAlpha6"] = Util.ParseDate(dvEmpDistDA[da]["ShiftStartTime"]).ToString("HH:mm");
                                                                    drw["dcAlpha7"] = Util.ParseDate(dvEmpDistDA[da]["ShiftEndTime"]).ToString("HH:mm");
                                                                }

                                                                drw["dcAlpha9"] = dLateMins;
                                                                drw["dcAlpha15"] = "";
                                                                if (dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_IsNDMTDone"] == 0) {
                                                                    iCnt = parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"]);
                                                                    dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"] = (iCnt + 1);
                                                                    if (parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"]) > parseInt(dvLatesConf[lc]["NDMT"])) {
                                                                        if (drw["dcAlpha15"] != null && drw["dcAlpha15"] != null && drw["dcAlpha15"].toString().length > 0)
                                                                            drw["dcAlpha15"] += ";Deduct - " + dvLatesConf[lc]["NDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["NDMTDeduct"];
                                                                        else
                                                                            drw["dcAlpha15"] = "Deduct - " + dvLatesConf[lc]["NDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["NDMTDeduct"];

                                                                        if (dvLatesConf[lc]["NDMTDeduct"].toString() == "Leaves") {
                                                                            if (dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null && dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null)
                                                                                drw["dcAlpha28"] = dvLatesConf[lc]["LeaveTypesDeductionOrder"];
                                                                        }

                                                                        dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"] = 0;
                                                                        dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_IsNDMTDone"] = 1;
                                                                    }
                                                                }
                                                                else //For Every Next 
                                                                {
                                                                    iCnt = parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"]);
                                                                    dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"] = (iCnt + 1);
                                                                    if (parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"]) > parseInt(dvLatesConf[lc]["FENDMT"])) {
                                                                        if (drw["dcAlpha15"] != null && drw["dcAlpha15"] != null && drw["dcAlpha15"].toString().length > 0)
                                                                            drw["dcAlpha15"] += ";Deduct - " + dvLatesConf[lc]["FENDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["FENDMTDeduct"];
                                                                        else
                                                                            drw["dcAlpha15"] = "Deduct - " + dvLatesConf[lc]["FENDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["FENDMTDeduct"];

                                                                        if (dvLatesConf[lc]["FENDMTDeduct"].toString() == "Leaves") {
                                                                            if (dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null && dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null)
                                                                                drw["dcAlpha28"] = dvLatesConf[lc]["LeaveTypesDeductionOrder"];
                                                                        }

                                                                        dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"] = 0;
                                                                    }
                                                                }

                                                                if (!isRowAdded && drw != null)
                                                                    this.ScreenObject.GridDataObj.addRow(drw);

                                                                isRowAdded = true;

                                                                break;
                                                            }

                                                        }
                                                    }

                                                    //#endregion
                                                }

                                                if (dvEmpDistDA.length > 1) //Day Breaks
                                                {
                                                    //#region Breaks
                                                    dvLatesConf = this.DoLate_Filter(dtLC, drc[0]).filter(x => x.DeviationWhen == "Break" + (da + 1) + " hours is more by");
                                                    dvLatesConf.sort((a, b) => (a.DevHours < b.DevHours) ? 1 : -1)//"DevHours DESC";
                                                    if (dvLatesConf.length > 0) {
                                                        for (let lc = 0; lc < dvLatesConf.length; lc++) {
                                                            if (dvEmpDistDA[da]["ShiftType"].toString() == "Flexible" && dvEmpDistDA[da]["ConsiderStartandEndTimelimits"].toString().toUpperCase() == "NO")
                                                                continue;

                                                            dtDev = Util.ParseDate(dvLatesConf[lc]["DevHours"]);
                                                            dtDASTime = Util.ParseDate(dvEmpDistDA[da]["EndTime"]);
                                                            if (dvEmpDistDA.length > (da + 1)) {
                                                                dtDAShSTime = Util.ParseDate(dvEmpDistDA[da + 1]["StartTime"]);
                                                                dActBrkMins = dtDAShSTime.Subtract(dtDASTime).TotalMinutes;
                                                                dBrkMins = parseFloat(dvEmpDistDA[da]["Break" + (da + 1) + "Mins"]);
                                                                dDevBrkMins = dBrkMins + (dtDev.getHours() * 60) + dtDev.getMinutes();

                                                                if (dActBrkMins > dDevBrkMins) //Means Break Late
                                                                {
                                                                    dLateMins = dActBrkMins - dBrkMins;
                                                                    drwc = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key == sESeqNo && x.dcAlpha3_Key == dtDADate.Date());
                                                                    if (drwc != null && drwc.length > 0) {
                                                                        drw = drwc[0];
                                                                        isRowAdded = true;
                                                                    }
                                                                    else {
                                                                        drw = this.ScreenObject.GridDataObj.NewRow();
                                                                        drw["DocSeqNo"] = this.ScreenObject.GridData.length + 1;
                                                                        drw["ProductID_Key"] = DefProdID;
                                                                        drw["LinkedInvDocDetailsID"] = dvLatesConf[lc]["InvDocDetailsID"];
                                                                        drw["dcCCNID51_Key"] = sESeqNo;
                                                                        drw["dcCCNID51Code"] = drc[0]["EmpCode"].toString();
                                                                        drw["dcCCNID51"] = drc[0]["EmpName"].toString();
                                                                        drw["dcAlpha1"] = dvEmpDistDA[da]["VoucherNo"];
                                                                        drw["dcAlpha2"] = dvEmpDistDA[da]["DocSeqNo"];
                                                                        drw["dcAlpha3"] = dtDADate.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                                        drw["dcAlpha3_Key"] = dtDADate;
                                                                        drw["dcAlpha4"] = Util.ParseDate(dvEmpDistDA[da]["StartTime"]).ToString("HH:mm");
                                                                        drw["dcAlpha5"] = Util.ParseDate(dvEmpDistDA[da]["EndTime"]).ToString("HH:mm");
                                                                        drw["dcCCNID73_Key"] = dvEmpDistDA[da]["ShiftSeqNo"].toString();
                                                                        drw["dcCCNID73"] = dvEmpDistDA[da]["ShiftName"].toString();
                                                                        drw["dcAlpha6"] = Util.ParseDate(dvEmpDistDA[da]["ShiftStartTime"]).ToString("HH:mm");
                                                                        drw["dcAlpha7"] = Util.ParseDate(dvEmpDistDA[da]["ShiftEndTime"]).ToString("HH:mm");
                                                                    }
                                                                    drw["dcAlpha" + (9 + da + 1)] = dLateMins;

                                                                    // drw["Break" + (da + 1) + "MoreMins"] = dLateMins;

                                                                    ////END
                                                                    drw["dcAlpha15"] = "";
                                                                    if (dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_IsNDMTDone"] == 0) {
                                                                        iCnt = parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"]);
                                                                        dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"] = (iCnt + 1);
                                                                        if (parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"]) > parseInt(dvLatesConf[lc]["NDMT"])) {
                                                                            if (drw["dcAlpha15"] != null && drw["dcAlpha15"] != null && drw["dcAlpha15"].toString().length > 0)
                                                                                drw["dcAlpha15"] += ";Deduct - " + dvLatesConf[lc]["NDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["NDMTDeduct"];
                                                                            else
                                                                                drw["dcAlpha15"] = "Deduct - " + dvLatesConf[lc]["NDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["NDMTDeduct"];

                                                                            if (dvLatesConf[lc]["NDMTDeduct"].toString() == "Leaves") {
                                                                                if (dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null && dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null)
                                                                                    drw["dcAlpha28"] = dvLatesConf[lc]["LeaveTypesDeductionOrder"];
                                                                            }

                                                                            dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"] = 0;
                                                                            dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_IsNDMTDone"] = 1;
                                                                        }
                                                                    }
                                                                    else //For Every Next 
                                                                    {
                                                                        iCnt = parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"]);
                                                                        dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"] = (iCnt + 1);
                                                                        if (parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"]) > parseInt(dvLatesConf[lc]["FENDMT"])) {
                                                                            if (drw["dcAlpha15"] != null && drw["dcAlpha15"] != null && drw["dcAlpha15"].toString().length > 0)
                                                                                drw["dcAlpha15"] += ";Deduct - " + dvLatesConf[lc]["FENDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["FENDMTDeduct"];
                                                                            else
                                                                                drw["dcAlpha15"] = "Deduct - " + dvLatesConf[lc]["FENDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["FENDMTDeduct"];

                                                                            if (dvLatesConf[lc]["FENDMTDeduct"].toString() == "Leaves") {
                                                                                if (dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null && dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null)
                                                                                    drw["dcAlpha28"] = dvLatesConf[lc]["LeaveTypesDeductionOrder"];
                                                                            }

                                                                            dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"] = 0;
                                                                        }
                                                                    }
                                                                    if (!isRowAdded && drw != null)
                                                                        this.ScreenObject.GridDataObj.addRow(drw);

                                                                    isRowAdded = true;
                                                                    break;
                                                                }
                                                            }

                                                        }
                                                    }

                                                    //#endregion
                                                }

                                                if (!isRowAdded && drw != null)
                                                    this.ScreenObject.GridDataObj.addRow(drw);

                                                isRowAdded = true;
                                            }

                                            //#region Working Hours is Less By

                                            if (dvEmpDistDA.length > 0) {
                                                //dvLatesConf.RowFilter = sBasedOn + " AND DeviationWhen='Working hours is less by'";
                                                dvLatesConf = this.DoLate_Filter(dtLC, drc[0]).filter(x => x.DeviationWhen == 'Working hours is less by');
                                                dvLatesConf.sort((a, b) => (a.DevHours < b.DevHours) ? 1 : -1)//"DevHours";
                                                if (dvLatesConf.length > 0) {
                                                    for (let lc = 0; lc < dvLatesConf.length; lc++) {
                                                        let sDevHrs = dvLatesConf[lc]["DeviationHours"].toString().substr(0, 5).Replace(":", ".");
                                                        let sDevMin: any = sDevHrs.split('.');
                                                        let dH = parseInt(sDevMin[0]) * 60 + parseInt(sDevMin[1]);

                                                        let sWorTH = this.CalculateTotalHoursBasedOnStartEndTime(dvEmpDistDA);
                                                        //string sWorTH = Util.DTComputeSUM(dvEmpDistDA.ToTable(), "TotalHours", "", true).ToString("00.00");
                                                        let sWorMin: any = sWorTH.split('.');
                                                        let dWorTH = parseInt(sWorMin[0]) * 60 + parseInt(sWorMin[1]);

                                                        if (dWorTH < dH) {
                                                            dLateMins = dH - dWorTH;
                                                            dLateMins -= dChLateMins;
                                                            if (dLateMins <= 0)
                                                                continue;

                                                            ////Adding Row
                                                            drw = this.ScreenObject.GridDataObj.NewRow();
                                                            drw["DocSeqNo"] = this.ScreenObject.GridData.length + 1;
                                                            drw["ProductID_Key"] = DefProdID;
                                                            drw["LinkedInvDocDetailsID"] = dvLatesConf[lc]["InvDocDetailsID"];
                                                            drw["dcCCNID51_Key"] = sESeqNo;
                                                            drw["dcCCNID51Code"] = drc[0]["EmpCode"].toString();
                                                            drw["dcCCNID51"] = drc[0]["EmpName"].toString();
                                                            drw["dcAlpha1"] = dvEmpDistDA[0]["VoucherNo"];
                                                            drw["dcAlpha2"] = dvEmpDistDA[0]["DocSeqNo"];
                                                            drw["dcAlpha3"] = dtDADate.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                                            drw["dcAlpha3_Key"] = dtDADate;
                                                            drw["dcAlpha4"] = Util.ParseDate(dvEmpDistDA[0]["StartTime"]).ToString("HH:mm");
                                                            drw["dcAlpha5"] = Util.ParseDate(dvEmpDistDA[0]["EndTime"]).ToString("HH:mm");
                                                            drw["dcCCNID73_Key"] = dvEmpDistDA[0]["ShiftSeqNo"].toString();
                                                            drw["dcCCNID73"] = dvEmpDistDA[0]["ShiftName"].toString();
                                                            drw["dcAlpha6"] = Util.ParseDate(dvEmpDistDA[0]["ShiftStartTime"]).ToString("HH:mm");
                                                            drw["dcAlpha7"] = Util.ParseDate(dvEmpDistDA[0]["ShiftEndTime"]).ToString("HH:mm");

                                                            drw["dcAlpha29"] = dLateMins;

                                                            ////END
                                                            drw["dcAlpha15"] = "";
                                                            if (dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_IsNDMTDone"] == 0) {
                                                                iCnt = parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"]);
                                                                dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"] = (iCnt + 1);
                                                                if (parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"]) > parseInt(dvLatesConf[lc]["NDMT"])) {
                                                                    if (!Util.IsEmpty(drw["dcAlpha15"]) && Util.String(drw["dcAlpha15"]).length > 0)
                                                                        drw["dcAlpha15"] += ";Deduct - " + dvLatesConf[lc]["NDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["NDMTDeduct"];
                                                                    else
                                                                        drw["dcAlpha15"] = "Deduct - " + dvLatesConf[lc]["NDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["NDMTDeduct"];

                                                                    if (dvLatesConf[lc]["NDMTDeduct"].toString() == "Leaves") {
                                                                        if (dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null && dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null)
                                                                            drw["dcAlpha28"] = dvLatesConf[lc]["LeaveTypesDeductionOrder"];
                                                                    }

                                                                    dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_NDMT"] = 0;
                                                                    dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_IsNDMTDone"] = 1;
                                                                }
                                                            }
                                                            else //For Every Next 
                                                            {
                                                                iCnt = parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"]);
                                                                dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"] = (iCnt + 1);
                                                                if (parseInt(dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"]) > parseInt(dvLatesConf[lc]["FENDMT"])) {
                                                                    if (!Util.IsEmpty(drw["dcAlpha15"]) && Util.String(drw["dcAlpha15"]).length > 0)
                                                                        drw["dcAlpha15"] += ";Deduct - " + dvLatesConf[lc]["FENDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["FENDMTDeduct"];
                                                                    else
                                                                        drw["dcAlpha15"] = "Deduct - " + dvLatesConf[lc]["FENDMTNoOfHoursOrDays"] + " - " + dvLatesConf[lc]["FENDMTDeduct"];

                                                                    if (dvLatesConf[lc]["FENDMTDeduct"].toString() == "Leaves") {
                                                                        if (dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null && dvLatesConf[lc]["LeaveTypesDeductionOrder"] != null)
                                                                            drw["dcAlpha28"] = dvLatesConf[lc]["LeaveTypesDeductionOrder"];
                                                                    }

                                                                    dicDISTDev[dvLatesConf[lc]["DISTDeviation"].toString() + "_FENDMT"] = 0;
                                                                }
                                                            }
                                                            this.ScreenObject.GridDataObj.addRow(drw);
                                                            isRowAdded = true;
                                                            break;
                                                        }

                                                    }
                                                }
                                            }

                                            //#endregion
                                        }
                                    }
                                }
                            }

                            //#region Absent Days


                            let dtTempF = new Date(), dtTempT = new Date(), dtAbsentST = new Date(), dtAbsentET = new Date();
                            let dr1, drccData = null;
                            let dAbsentMins = 0;
                            let dtcc: any[];

                            let dvEmpDim = dtEmpDim;
                            dvEmpDim = dvEmpDim.filter(x => x.EmpSeqNo == sESeqNo);
                            if (dvEmpDim != null && dvEmpDim.length > 0) {
                                //dtcc = dvEmpDim.Copy();
                                dtcc = [];
                                dtcc = dvEmpDim.map(u => Object.assign({}, u, {}));

                                for (let d = 0; d < Object.keys(dvEmpDim[0]).length; d++) {
                                    const dc = Object.keys(dvEmpDim[0])[d];
                                    if (!dc.Contains("CCNID") || dc.Contains("Name"))
                                        continue;

                                    // dtcc.Columns.push("dc" + dc.ColumnName, typeof(System.String));
                                    // dtcc.Columns.push("dc" + dc.ColumnName + "_Key", typeof(System.Int64));
                                    dtcc.forEach(row => {
                                        row["dc" + dc + "_Key"] = row[dc];
                                    });

                                }



                                // if (!dtcc.Columns.Contains("dcCCNID51"))
                                //     dtcc.Columns.push("dcCCNID51", typeof(System.String));
                                // if (!dtcc.Columns.Contains("dcCCNID51_Key"))
                                //     dtcc.Columns.push("dcCCNID51_Key", typeof(System.Int64));

                                // dtcc.Columns.push("dcCCNID73", typeof(System.String));
                                // dtcc.Columns.push("dcCCNID73_Key", typeof(System.Int64));
                                dtcc.forEach(row => {
                                    row["dcCCNID51_Key"] = row["EmpSeqNo"];
                                });


                                //dtcc.Columns.push("PayrollType", typeof(System.String));
                                drccData = dtcc.filter(x => x.EmpSeqNo == sESeqNo);
                            }

                            dtTempF = this.dtLatesMonthStart;
                            dtTempT = this.dtLatesMonthEnd;

                            while (dtTempF <= dtTempT) {
                                if (dt1 != null && dt1.length > 0) {
                                    dr1 = dt1.filter(x => x.EmpSeqNo == sESeqNo && ((x.FromDate >= dtTempF.ToString("dd MMM yyyy") && x.ToDate <= dtTempF.ToString("dd MMM yyyy")) || (x.FromDate <= dtTempF.ToString("dd MMM yyyy") && x.ToDate >= dtTempF.ToString("dd MMM yyyy"))));

                                    if (dr1 != null && dr1.length > 0) {
                                        dtTempF = dtTempF.AddDays(1);
                                        continue;
                                    }
                                }

                                if ((drccData != null && drccData.length > 0)) {

                                    this.CheckEmployeeShift(sESeqNo, dtTempF.ToString("dd MMM yyyy"), drccData[0]);

                                    if (IsShiftWise) {
                                        //sBasedOn = "dcCCNID73=" + drccData[0]["dcCCNID73_Key"];
                                        dvLatesConf = dsDATData.Tables[1];
                                        dvLatesConf = dvLatesConf.filter(x => x.dcCCNID73 == drccData[0]["dcCCNID73_Key"] && x.WEF <= "#" + this.dtLatesMonthEnd.ToString("dd/MMM/yyyy") + "#" && x.ConsiderAbsentDays == 'Yes');
                                        dvLatesConf.sort((a, b) => (a.WEF < b.WEF) ? 1 : -1)//"WEF DESC";

                                        if (dvLatesConf.length > 0) {
                                            iDocID = parseInt(dvLatesConf[0]["DocID"]);
                                            dvLatesConf = dvLatesConf.filter(x => x.DocID == iDocID);
                                            if (dvLatesConf.length > 0) {
                                                dtLC = dvLatesConf;
                                                dvLatesConf = dtLC;
                                                sLCIncludeRExclude = dvLatesConf[0]["IncludeRExclude"].toString();
                                            }
                                        }
                                        else {
                                            dtTempF = dtTempF.AddDays(1);
                                            continue;
                                        }
                                    }

                                    if (this.objPayDayCheck == null)
                                        this.objPayDayCheck = new PayDayCheck(this.ScreenObject);

                                    drccData[0]["PayrollType"] = "";
                                    this.objPayDayCheck.CheckIsHolidayDate(sESeqNo, dtTempF.ToString("dd MMM yyyy"), drccData[0]);

                                    if (drccData[0]["PayrollType"] != "") {
                                        dtTempF = dtTempF.AddDays(1);
                                        continue;
                                    }
                                }

                                let drshift: any = dtShifts.filter(x => x.NodeID == drccData[0]["dcCCNID73_Key"]);

                                dtAbsentST = dtTempF.AddHours(Util.ParseDate(drshift[0]["ShiftStartTime"]).getHours())
                                    .AddMinutes(Util.ParseDate(drshift[0]["ShiftStartTime"]).getHours());
                                dtAbsentET = dtTempF.AddHours(Util.ParseDate(drshift[0]["ShiftEndTime"]).getHours())
                                    .AddMinutes(Util.ParseDate(drshift[0]["ShiftEndTime"]).getHours());

                                dAbsentMins = dtAbsentET.Subtract(dtAbsentST).TotalMinutes;
                                drw = null;
                                ////Adding Row
                                drw = this.ScreenObject.GridDataObj.NewRow();
                                drw["DocSeqNo"] = this.ScreenObject.GridData.length + 1;
                                drw["ProductID_Key"] = DefProdID;
                                drw["LinkedInvDocDetailsID"] = "0";
                                drw["dcCCNID51_Key"] = sESeqNo;
                                drw["dcCCNID51Code"] = drc[0]["EmpCode"].toString();
                                drw["dcCCNID51"] = drc[0]["EmpName"].toString();
                                drw["dcAlpha1"] = "";
                                drw["dcAlpha2"] = "";
                                drw["dcAlpha3"] = dtTempF.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                                drw["dcAlpha3_Key"] = dtTempF;
                                drw["dcAlpha4"] = "00:00";
                                drw["dcAlpha5"] = "00:00";
                                drw["dcCCNID73_Key"] = drccData[0]["dcCCNID73_Key"];
                                if (drshift != null) {
                                    drw["dcCCNID73"] = drshift[0]["NAME"].toString();
                                    drw["dcAlpha6"] = Util.ParseDate(drshift[0]["ShiftStartTime"]).ToString("HH:mm");
                                    drw["dcAlpha7"] = Util.ParseDate(drshift[0]["ShiftEndTime"]).ToString("HH:mm");
                                }

                                drw["dcAlpha31"] = dAbsentMins;

                                ////END

                                this.ScreenObject.GridDataObj.addRow(drw);

                                dtTempF = dtTempF.AddDays(1);
                            }
                            //this.ScreenObject.GridData.AcceptChanges();

                            if (this.RefreshGrid)
                                this.RefreshGrid = false;
                            else
                                this.RefreshGrid = true;


                            //#endregion


                        }

                    }

                    // SUMS
                    let dvE = this.ScreenObject.GridData.filter(x => x.dcCCNID51_Key == sESeqNo);
                    if (dvE.length > 0) {
                        let dvEFil = dvE.filter(x => x.dcCCNID51_Key == sESeqNo && Util.String(x.dcAlpha15) != "");
                        this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]["dcAlpha19"] = Util.DTComputeSUM(dvEFil, "dcAlpha8", false);
                        this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]["dcAlpha20"] = Util.DTComputeSUM(dvEFil, "dcAlpha9", false);

                        this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]["dcAlpha21"] = Util.DTComputeSUM(dvEFil, "dcAlpha10", false);
                        this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]["dcAlpha22"] = Util.DTComputeSUM(dvEFil, "dcAlpha11", false);
                        this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]["dcAlpha23"] = Util.DTComputeSUM(dvEFil, "dcAlpha12", false);
                        this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]["dcAlpha24"] = Util.DTComputeSUM(dvEFil, "dcAlpha13", false);
                        this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]["dcAlpha25"] = Util.DTComputeSUM(dvEFil, "dcAlpha14", false);

                        //ex = "dcCCNID51_Key=" + sESeqNo;
                        dvEFil = dvE.filter(x => x.dcCCNID51_Key == sESeqNo);

                        this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]["dcAlpha32"] = Util.DTComputeSUM(dvEFil, "dcAlpha31", false);

                        //TotLateHrsToDeduct,TotLateLeavesToDeduct
                        let dDedHrsVal = 0, dDedLeavesVal = 0;
                        let sLTypes = "";
                        for (let j = 0; j < dvE.length; j++) {
                            if (!Util.IsEmpty(dvE[j]["dcAlpha15"])) {
                                let sArr = dvE[j]["dcAlpha15"].toString().split(';');
                                if (sArr != null && sArr.length > 0) {
                                    for (let a = 0; a < sArr.length; a++) {
                                        if (sArr[a] != null && sArr[a] != "") {
                                            if (sArr[a].endsWith("Hours")) {
                                                dDedHrsVal += parseFloat(sArr[a].Replace("Deduct - ", "").Replace(" - Hours", ""));
                                            }
                                            else if (sArr[a].endsWith("Leaves")) {
                                                dDedLeavesVal += parseFloat(sArr[a].Replace("Deduct - ", "").Replace(" - Leaves", ""));
                                                sLTypes = dvE[j]["dcAlpha28"].toString();
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]["dcAlpha26"] = dDedHrsVal;
                        this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]["dcAlpha27"] = dDedLeavesVal;
                        this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]["dcAlpha28"] = sLTypes;
                    }
                }
            }
        }
    }
    private DoLate_Filter(arr: any[], drc: any) {
        let sArrBasedOn = BaseService.SessionManager.Preferences["LatesConfigBasedOn"].split(',');
        for (let i = 0; i < sArrBasedOn.length; i++) {
            if (!Util.IsEmpty(sArrBasedOn[i])) {
                let sColName = "CCNID" + (parseInt(sArrBasedOn[i]) - 50000);
                if (Object.keys(drc).Contains(sColName) && !Util.IsEmpty(drc[sColName]))
                    arr = arr.filter(x => (x["dc" + sColName] == drc[sColName]) || (x["dc" + sColName] == 1));
                else
                    arr = arr.filter(x => x["dc" + sColName] == 1);
            }
        }
        return arr;
    }


    private CalculateTotalHoursBasedOnStartEndTime(dtDA: any): string {
        let dval = 0;
        let sPrev = "00.00", sCur = "";
        for (let j = 0; j < dtDA.length; j++) {
            let dtDADate: Date = Util.ParseDate(dtDA[j]["DailyAttDate"]);
            let dt1: Date = dtDADate.AddHours(Util.ParseDate(dtDA[j]["StartTime"]).getHours())
                .AddMinutes(Util.ParseDate(dtDA[j]["StartTime"]).getMinutes());
            let dt2: Date = dtDADate.AddHours(Util.ParseDate(dtDA[j]["EndTime"]).getHours())
                .AddMinutes(Util.ParseDate(dtDA[j]["EndTime"]).getMinutes());
            if (dt2 < dt1)
                dt2 = dt2.AddDays(1);

            sCur = this.CalculateTotalTime(dt1, dt1, dt2, dt2);
            dval = Util.SUMHoursAndMinutes(sPrev, sCur);
            sPrev = dval.ToString("00.00");
        }

        return dval.ToString("00.00");
    }

    private CheckIsLateCheckInOrEarlyCheckOut(sEmpSeqNos: string) {
        let sInvDocIDs = "";
        let drr: any;
        let dtlates: any = []; //= new DataTable();

        // dtlates.Columns.push("sInvDocIDs", typeof(System.String));
        // dtlates.Columns.push("LateType", typeof(System.String));

        if (BaseService.SessionManager.Preferences.ContainsKey("ConsiderLatesConfig") && BaseService.SessionManager.Preferences["ConsiderLatesConfig"] == "True" &&
            BaseService.SessionManager.Preferences.ContainsKey("LatesConfigBasedOn") && BaseService.SessionManager.Preferences["LatesConfigBasedOn"].toString().Trim() != "") {
            let IsShiftWise = false;
            let ssA = BaseService.SessionManager.Preferences["LatesConfigBasedOn"];
            if (ssA == "50073")
                IsShiftWise = true;

            let sArrBasedOn = ssA.split(',');

            let sArrEmpSeqNos = sEmpSeqNos.split(',');
            if (sArrEmpSeqNos.length > 0 && sArrBasedOn.length > 0) {
                let txtDatefld1: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha10");
                if (txtDatefld1 != undefined && txtDatefld1 instanceof PactExtraFieldDateData && txtDatefld1.Date.toString() == "") {
                    this.DisplayMessage = "Select From Date";
                    this.MessageVisibility = true;
                    txtDatefld1.SetFocus = true;
                    return dtlates;
                }

                let txtDatefld2: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha11");
                if (txtDatefld2 != null && txtDatefld2 instanceof PactExtraFieldDateData && txtDatefld2.Date.toString() == "") {
                    this.DisplayMessage = "Select To Date";
                    this.MessageVisibility = true;
                    txtDatefld2.SetFocus = true;
                    return dtlates;
                }

                let dtPayMonStart1: any = txtDatefld1.Date;
                let dtPayMonEnd1: any = txtDatefld2.Date;

                //#region Query


                let dsDATData: any = BaseService.common.GetDataSet3("PAY077", sEmpSeqNos, dtPayMonStart1.ToString("dd/MMM/yyyy"), dtPayMonEnd1.ToString("dd/MMM/yyyy"))

                let al = [];
                al.push(BaseService.SessionManager.PayrollMonthEnd.ToString("dd/MMM/yyyy"));
                al.push(" a.IsGroup=0 AND a.NodeID IN(" + sEmpSeqNos + ")");
                al.push("");

                let dtEmpDim: any = BaseService.common.GetDataSet_SP(al, "spPAY_GetEmpDimensionsAsOnDate").Tables[0];

                //#endregion

                let DefProdID = 0;
                let drCL: any = this.ScreenObject.Data.Tables[0].filter(x => x.SysColumnName == 'ProductID');
                if (drCL.length > 0 && Util.String(drCL[0]["UserDefaultValue"]) != "")
                    DefProdID = parseInt(drCL[0]["UserDefaultValue"]);

                //Dictionary<string, int> dicDISTDev;
                let dicDISTDev: Dictionary<any>;
                let sBasedOn = "", sColName = "", sLCIncludeRExclude = "", sDADayType = "";
                let sESeqNo = "";
                let dvDATData: any = [], dvLatesConf: any = [], dvEmpDistDA: any = [];
                let drc: any;
                let dtDADate = new Date(), dtDev = new Date(), dtDASTime = new Date(),
                    dtDAShSTime = new Date(), dtDASTimeWD = new Date();
                let dLateMins = 0, dActBrkMins = 0, dBrkMins, dDevBrkMins = 0;
                let iDocID = 0;
                let dtEmpDistDA: any = null;

                for (let e = 0; e < sArrEmpSeqNos.length; e++) {
                    dicDISTDev = new Dictionary<any>();//new Dictionary<string, int>();
                    if (dsDATData != null && dsDATData.Tables.length > 0) {
                        if (dsDATData.Tables[1].length > 0) {
                            for (let d = 0; d < dsDATData.Tables[1].length; d++) {
                                if (!dicDISTDev.ContainsKey(dsDATData.Tables[1][d]["DISTDeviation"].toString() + "_NDMT")) {
                                    dicDISTDev.push(dsDATData.Tables[1][d]["DISTDeviation"].toString() + "_NDMT", 0);
                                    dicDISTDev.push(dsDATData.Tables[1][d]["DISTDeviation"].toString() + "_FENDMT", 0);
                                    dicDISTDev.push(dsDATData.Tables[1][d]["DISTDeviation"].toString() + "_IsNDMTDone", 0);
                                }
                            }
                        }
                    }

                    sESeqNo = sArrEmpSeqNos[e];
                    drc = dtEmpDim.filter(x => x.EmpSeqNo == sESeqNo);
                    let dtLC: any;
                    if (drc != null && drc.length > 0) {
                        if (sArrBasedOn.filter(x => x.length > 1).length > 0) {
                            dvLatesConf = this.DoLate_Filter(dsDATData.Tables[1], drc[0]).filter(x => x.WEF <= this.dtPayMonEnd.Date());
                            dvLatesConf.sort((a, b) => a.WEF < b.WEF ? 1 : a.WEF > b.WEF ? -1 : 0)//"WEF DESC";


                            if (!IsShiftWise) {
                                if (dvLatesConf.length > 0) {
                                    iDocID = parseInt(dvLatesConf[0]["DocID"]);
                                    dvLatesConf = dsDATData.Tables[1].filter(x => x.DocID == iDocID);
                                    if (dvLatesConf.length > 0) {
                                        dtLC = dvLatesConf;
                                        dvLatesConf = dtLC;
                                        sLCIncludeRExclude = dvLatesConf[0]["IncludeRExclude"].toString();
                                    }
                                }
                            }

                            //if (dvLatesConf.length > 0)
                            {
                                //iDocID = parseInt(dvLatesConf[0]["DocID"]);
                                //dvLatesConf = dsDATData.Tables[1].filter(x => x.DocID == iDocID);
                                //if (dvLatesConf.length > 0)
                                {
                                    //let dtLC = dvLatesConf;
                                    //dvLatesConf = dtLC;
                                    //sLCIncludeRExclude = dvLatesConf[0]["IncludeRExclude"].toString();

                                    dvDATData = dsDATData.Tables[0](x => x.EmpSeqNo == sESeqNo);
                                    dvDATData.sort((a, b) => (a.DailyAttDate > b.DailyAttDate) ? 1 : (a.DailyAttDate == b.DailyAttDate) ? ((a.StartTime > b.StartTime) ? 1 : -1) : -1)
                                    if (dvDATData.length > 0) {
                                        dtEmpDistDA = [];// new DataTable();
                                        dtEmpDistDA = dvDATData.ToTable(true, ["DailyAttDate"]);
                                        for (let dd = 0; dd < dtEmpDistDA.length; dd++) {
                                            dtDADate = Util.ParseDate(dtEmpDistDA[dd]["DailyAttDate"]);

                                            dvEmpDistDA = dsDATData.Tables[0](x => x.EmpSeqNo == sESeqNo && x.DailyAttDate == dtDADate.OnlyDate());
                                            dvEmpDistDA.sort((a, b) => (a.DailyAttDate > b.DailyAttDate) ? 1 : (a.DailyAttDate == b.DailyAttDate) ? ((a.StartTime > b.StartTime) ? 1 : -1) : -1)


                                            if (dvEmpDistDA.length > 0) {
                                                if (IsShiftWise) {
                                                    // sBasedOn = "dcCCNID73=" + dvEmpDistDA[0]["ShiftSeqNo"];
                                                    // dvLatesConf = dsDATData.Tables[1].AsDataView();
                                                    // dvLatesConf.RowFilter = sBasedOn + " AND WEF<=#" + dtPayMonEnd.ToString("dd/MMM/yyyy") + "#";
                                                    // dvLatesConf.Sort = "WEF DESC";
                                                    dvLatesConf = dsDATData.Tables[1];
                                                    dvLatesConf = dvLatesConf.filter(x => x.dcCCNID73 == dvEmpDistDA[0]["ShiftSeqNo"] && x.WEF <= this.dtPayMonEnd.ToString("dd/MMM/yyyy"));
                                                    dvLatesConf.sort((a, b) => a.WEF < b.WEF ? 1 : a.WEF > b.WEF ? -1 : 0)//"WEF DESC";

                                                    if (dvLatesConf.length > 0) {
                                                        iDocID = parseInt(dvLatesConf[0]["DocID"]);
                                                        dvLatesConf = dvLatesConf.filter(x => x.DocID == iDocID);
                                                        if (dvLatesConf.length > 0) {
                                                            dtLC = dvLatesConf;
                                                            dvLatesConf = dtLC;
                                                            sLCIncludeRExclude = dvLatesConf[0]["IncludeRExclude"].toString();
                                                        }
                                                    }
                                                    else
                                                        continue;
                                                }

                                                sDADayType = dvEmpDistDA[0]["DADayType"].toString();
                                                if (sDADayType != "") {
                                                    if (sDADayType == "WeeklyOff" && (sLCIncludeRExclude == "ExcludeBoth" || sLCIncludeRExclude == "ExcludeWeeklyOffs"))
                                                        continue;

                                                    else if (sDADayType == "Holiday" && (sLCIncludeRExclude == "ExcludeBoth" || sLCIncludeRExclude == "ExcludeHolidays"))
                                                        continue;
                                                }
                                            }

                                            for (let da = 0; da < dvEmpDistDA.length; da++) {
                                                if (da == 0) //Day First Check-in
                                                {
                                                    //#region Check-In

                                                    dvLatesConf = this.DoLate_Filter(dtLC, drc[0]).filter(x => x.DeviationWhen == 'Check-in is late By');
                                                    dvLatesConf.sort((a, b) => a.DevHours < b.DevHours ? 1 : -1)//"DevHours DESC";
                                                    if (dvLatesConf.length > 0) {
                                                        for (let lc = 0; lc < dvLatesConf.length; lc++) {
                                                            if (dvEmpDistDA[da]["ShiftType"].toString() == "Flexible" && dvEmpDistDA[da]["ConsiderStartandEndTimelimits"].toString().toUpperCase() == "NO")
                                                                continue;

                                                            dtDev = Util.ParseDate(dvLatesConf[lc]["DevHours"]);
                                                            dtDASTime = Util.ParseDate(dvEmpDistDA[da]["StartTime"]);
                                                            dtDAShSTime = Util.ParseDate(dvEmpDistDA[da]["DADateShiftStartTime"]);
                                                            dtDASTimeWD = Util.ParseDate(dvEmpDistDA[da]["DADateShiftStartTime"]).AddHours(dtDev.getHours()).AddMinutes(dtDev.getMinutes());
                                                            if (dtDASTime > dtDASTimeWD) //Means Day-Check-in Late
                                                            {
                                                                dLateMins = dtDASTime.Subtract(dtDAShSTime).TotalMinutes;
                                                                // if (sInvDocIDs.length > 0)
                                                                //     sInvDocIDs += ",";
                                                                // sInvDocIDs += dvEmpDistDA[da]["InvDocDetailsID"].toString();

                                                                drr = {};
                                                                drr["sInvDocIDs"] = dvEmpDistDA[da]["InvDocDetailsID"].toString();
                                                                drr["LateType"] = "Check-In Late";
                                                                dtlates.push(drr);
                                                            }

                                                        }
                                                    }

                                                    //#endregion
                                                }

                                                if (da == dvEmpDistDA.length - 1) //Day Last Check-out
                                                {
                                                    //#region Check-Out

                                                    dvLatesConf = this.DoLate_Filter(dtLC, drc[0]).filter(x => x.DeviationWhen == 'Check-out is early By');
                                                    dvLatesConf.sort((a, b) => (a.DevHours < b.DevHours) ? 1 : -1)//"DevHours DESC";
                                                    if (dvLatesConf.length > 0) {
                                                        for (let lc = 0; lc < dvLatesConf.length; lc++) {
                                                            if (dvEmpDistDA[da]["ShiftType"].toString() == "Flexible" && dvEmpDistDA[da]["ConsiderStartandEndTimelimits"].toString().toUpperCase() == "NO")
                                                                continue;

                                                            dtDev = Util.ParseDate(dvLatesConf[lc]["DevHours"]);
                                                            dtDASTime = Util.ParseDate(dvEmpDistDA[da]["EndTime"]);
                                                            dtDAShSTime = Util.ParseDate(dvEmpDistDA[da]["DADateShiftEndTime"]);
                                                            dtDASTimeWD = Util.ParseDate(dvEmpDistDA[da]["DADateShiftEndTime"]).AddHours(-dtDev.getHours).AddMinutes(-dtDev.getMinutes());
                                                            if (dtDASTime < dtDASTimeWD) //Means Day-Check-out early
                                                            {
                                                                dLateMins = dtDAShSTime.Subtract(dtDASTime).TotalMinutes;

                                                                // if (sInvDocIDs.length > 0)
                                                                //     sInvDocIDs += ",";
                                                                // sInvDocIDs += dvEmpDistDA[da]["InvDocDetailsID"].toString();

                                                                drr = {};
                                                                drr["sInvDocIDs"] = dvEmpDistDA[da]["InvDocDetailsID"].toString();
                                                                drr["LateType"] = "Check-Out Early";
                                                                dtlates.push(drr);
                                                            }

                                                        }
                                                    }

                                                    //#endregion
                                                }

                                                if (dvEmpDistDA.length > 1) //Day Breaks
                                                {
                                                    //#region Breaks

                                                    dvLatesConf = this.DoLate_Filter(dtLC, drc[0]).filter(x => x.DeviationWhen == "Break" + (da + 1) + " hours is more by");
                                                    dvLatesConf.sort((a, b) => (a.DevHours < b.DevHours) ? 1 : -1)//"DevHours DESC";
                                                    if (dvLatesConf.length > 0) {
                                                        for (let lc = 0; lc < dvLatesConf.length; lc++) {
                                                            if (dvEmpDistDA[da]["ShiftType"].toString() == "Flexible" && dvEmpDistDA[da]["ConsiderStartandEndTimelimits"].toString().toUpperCase() == "NO")
                                                                continue;

                                                            dtDev = Util.ParseDate(dvLatesConf[lc]["DevHours"]);
                                                            dtDASTime = Util.ParseDate(dvEmpDistDA[da]["EndTime"]);
                                                            if (dvEmpDistDA.length > (da + 1)) {
                                                                dtDAShSTime = Util.ParseDate(dvEmpDistDA[da + 1]["StartTime"]);
                                                                dActBrkMins = dtDAShSTime.Subtract(dtDASTime).TotalMinutes;
                                                                dBrkMins = parseFloat(dvEmpDistDA[da]["Break" + (da + 1) + "Mins"]);
                                                                dDevBrkMins = dBrkMins + (dtDev.getHours() * 60) + dtDev.getMinutes();

                                                                if (dActBrkMins > dDevBrkMins) //Means Break Late
                                                                {
                                                                    dLateMins = dActBrkMins - dBrkMins;

                                                                    // if (sInvDocIDs.length > 0)
                                                                    //     sInvDocIDs += ",";
                                                                    // sInvDocIDs += dvEmpDistDA[da]["InvDocDetailsID"].toString();

                                                                    drr = {};
                                                                    drr["sInvDocIDs"] = dvEmpDistDA[da]["InvDocDetailsID"].toString();
                                                                    drr["LateType"] = "Break Late";
                                                                    dtlates.push(drr);
                                                                }
                                                            }

                                                        }
                                                    }

                                                    //#endregion
                                                }
                                            }

                                            //#region Working Hours is Less By

                                            if (dvEmpDistDA.length > 0) {
                                                //dvLatesConf.RowFilter = sBasedOn + " AND DeviationWhen='Working hours is less by'";
                                                dvLatesConf = this.DoLate_Filter(dtLC, drc[0]).filter(x => x.DeviationWhen == 'Working hours is less by');
                                                dvLatesConf.sort((a, b) => (a.DevHours < b.DevHours) ? 1 : -1)//"DevHours";
                                                if (dvLatesConf.length > 0) {
                                                    for (let lc = 0; lc < dvLatesConf.length; lc++) {
                                                        let sDevHrs = dvLatesConf[lc]["DeviationHours"].toString().substr(0, 5).Replace(":", ".");
                                                        let sDevMin: any = sDevHrs.split('.');
                                                        let dH = parseInt(sDevMin[0]) * 60 + parseInt(sDevMin[1]);

                                                        let sWorTH = this.CalculateTotalHoursBasedOnStartEndTime(dvEmpDistDA);
                                                        //string sWorTH = Util.DTComputeSUM(dvEmpDistDA.ToTable(), "TotalHours", "", true).ToString("00.00");
                                                        let sWorMin = sWorTH.split('.');
                                                        let dWorTH = parseInt(sWorMin[0]) * 60 + parseInt(sWorMin[1]);

                                                        if (dWorTH < dH) {
                                                            dLateMins = dH - dWorTH;
                                                            drr = {};//dtlates.NewRow();
                                                            drr["sInvDocIDs"] = dvEmpDistDA[0]["InvDocDetailsID"].toString();
                                                            drr["LateType"] = "Less Working Hours";
                                                            dtlates.push(drr);
                                                        }

                                                    }
                                                }
                                            }

                                            //#endregion

                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        return dtlates;
    }


    public IsDocLocked(sEmpID: string, dt1: Date, dt2: Date, DocumentType: number) {

        this.strValidationMessage = '';

        let ObjArray = [];
        ObjArray.push(dt1.ToString("dd MMM yyyy"));
        ObjArray.push(this.sEmpFilter);
        ObjArray.push(0);
        ObjArray.push(BaseService.SessionManager.RoleID);
        ObjArray.push(BaseService.SessionManager.UserID);
        ObjArray.push(BaseService.SessionManager.LanguageID);


        let dsEmps = BaseService.common.GetDataSet_SP(ObjArray, "spPAY_GetEmpMasterCCDetails")

        if (dsEmps != null && dsEmps.Tables.length > 0 && dsEmps.Tables[0].length > 0) {

            let iDim = 0;
            let LockDim = "", sExp1 = "";
            let dsData2: any = BaseService.common.GetDataSet("PAY085", "");
            if (dsData2 != null && dsData2.Tables.length > 0) {
                if (dsData2.Tables[0] != null && dsData2.Tables[0].length > 0) {
                    // for(let i = 0; i < dsData2.Tables[0].length; i++)
                    // {
                    //     LockDim = dsData2.Tables[0][i]["SysColumnName"].toString();

                    //     let drc:any = dsEmps.Tables[0].filter(x=>x.EmpSeqNo == sEmpID);
                    //     if (drc != null && drc.length > 0)
                    //     {
                    //         iDim = parseInt(drc[0]["CCNID" + LockDim.Replace("dcCCNID", "")]);
                    //     }

                    //     if (sExp1.length > 0)
                    //         sExp1 += " AND ";

                    //     sExp1 += "" + LockDim + "=" + iDim + "";
                    // }

                    let dsPayrollLock: any = BaseService.common.GetDataSet3("PAY086", dt1.ToString("dd/MMM/yyyy"), dt2.ToString("dd/MMM/yyyy"));
                    if (dsPayrollLock != null && dsPayrollLock.Tables.length > 0) {
                        if (dsPayrollLock.Tables[0] != null && dsPayrollLock.Tables[0].length > 0) {

                            let dv1 = dsPayrollLock.Tables[0];

                            for (let i = 0; i < dsData2.Tables[0].length; i++) {
                                LockDim = dsData2.Tables[0][i]["SysColumnName"].toString();

                                let drc: any = dsEmps.Tables[0].filter(x => x.EmpSeqNo == sEmpID);
                                if (drc != null && drc.length > 0) {
                                    iDim = parseInt(drc[0]["CCNID" + LockDim.Replace("dcCCNID", "")]);
                                }

                                // if (sExp1.length > 0)
                                //     sExp1 += " AND ";

                                // sExp1 += "" + LockDim + "=" + iDim + "";
                                dv1 = dv1.filter(x => x[LockDim] == iDim);
                            }

                            //dv1.RowFilter = sExp1;
                            if (dv1 != null && dv1.length > 0) {
                                for (let j = 0; j < dv1.length; j++) {
                                    if (!Util.IsEmpty(dv1[j]["MPLockStatus"]) && dv1[j]["MPLockStatus"].toString() == "Locked") {
                                        this.strValidationMessage = "Payroll Locked";
                                    }
                                    else if (this.strValidationMessage == "" && DocumentType == 67) {
                                        if (!Util.IsEmpty(dv1[j]["DALockStatus"]) && dv1[j]["DALockStatus"].toString() == "Locked") {
                                            this.strValidationMessage = "Daily Attendance Locked";
                                        }
                                    }
                                }
                            }

                        }
                    }
                }
            }
        }

        return this.strValidationMessage;
    }

    public DocLock(DocumentType: number) {
        let dtFromDate = new Date().OnlyDate(), dtToDate = new Date().OnlyDate();
        let sEmpID = "", sDailyAttDate = "";
        if (DocumentType == 68) {
            for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                let vFld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld != undefined) {
                    if (vFld instanceof PactListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                }
                else {
                    let vFld2: any = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                    if (vFld2 != undefined && !Util.IsEmpty(this.ScreenObject.GridData[k][vFld2.ValueMember]))
                        sEmpID = this.ScreenObject.GridData[k][vFld2.ValueMember].toString();
                }

                let fldAPV2: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                if (fldAPV2 != null && fldAPV2 instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV2.Date))
                    dtFromDate = fldAPV2.Date;

                fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha4");
                if (fldAPV2 != undefined && fldAPV2 instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV2.Date))
                    dtToDate = fldAPV2.Date;

                this.strValidationMessage = this.IsDocLocked(sEmpID, dtFromDate, dtToDate, DocumentType);
                if (this.strValidationMessage != "")
                    break;
            }
        }
        else if (this.ScreenObject.DocumentType == 67) {
            for (let i = 0; i < this.ScreenObject.GridData.length; i++) {
                if (this.ScreenObject.GridDataColumns.Contains("ProductID_Key") && !Util.IsEmpty(this.ScreenObject.GridData[i]["ProductID_Key"])) {
                    sDailyAttDate = ""; sEmpID = "";
                    let drw: any = this.ScreenObject.GridData[i];

                    var vFld: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha1");
                    if (vFld != undefined)
                        sDailyAttDate = vFld.Date.ToString("dd/MMM/yyyy");
                    else {
                        var vFld2 = this.ScreenObject.ColumnSource.find(a => a.DisplayMember.toLowerCase() == "dcalpha1");
                        if (vFld2 != null && !Util.IsEmpty(drw[vFld2.DisplayMember + "_Key"]))
                            sDailyAttDate = Util.ParseDate(drw[vFld2.DisplayMember + "_Key"]).ToString("dd/MMM/yyyy");
                    }

                    vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if (vFld != undefined) {
                        if (vFld instanceof PactListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                        else if (vFld instanceof PactCodeNameListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                    }
                    else {
                        let vFld2 = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                        if (vFld2 != undefined && !Util.IsEmpty(drw[vFld2.ValueMember]))
                            sEmpID = drw[vFld2.ValueMember].toString();
                    }

                    if (sDailyAttDate != "" && parseInt(sEmpID) > 1) {
                        this.strValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(sDailyAttDate), Util.ParseDate(sDailyAttDate), DocumentType);
                        if (this.strValidationMessage != "")
                            break;
                    }
                }
            }
        }
        else if (this.ScreenObject.DocumentType == 80) {
            let vFld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (vFld != undefined) {
                if (vFld instanceof PactListBoxData)
                    sEmpID = vFld.SelectedValue.toString();
                else if (vFld instanceof PactCodeNameListBoxData)
                    sEmpID = vFld.SelectedValue.toString();
            }

            let fldAPV2: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
            if (fldAPV2 != undefined && fldAPV2 instanceof PactExtraFieldDateData && fldAPV2.Date.toString() != "")
                dtFromDate = fldAPV2.Date;
            dtToDate = dtFromDate;

            this.strValidationMessage = this.IsDocLocked(sEmpID, dtFromDate, dtToDate, DocumentType);
        }
        else if (this.ScreenObject.DocumentType == 62) {
            if (BaseService.SessionManager.Preferences.ContainsKey("AllowLeavesifPayrollProcessedorLocked") && parseBoolean(BaseService.SessionManager.Preferences["AllowLeavesifPayrollProcessedorLocked"] == "False")) {
                for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                    let vFld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                    if (vFld != undefined) {
                        if (vFld instanceof PactListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                        else if (vFld instanceof PactCodeNameListBoxData)
                            sEmpID = vFld.SelectedValue.toString();
                    }
                    else {
                        let vFld2: any = this.ScreenObject.ColumnSource.find(a => a.DataType.toUpperCase() == "LISTBOX" && a.ValueMember.toLowerCase() == "dcccnid51_key");
                        if (vFld2 != undefined && !Util.IsEmpty(this.ScreenObject.GridData[k][vFld2.ValueMember]))
                            sEmpID = this.ScreenObject.GridData[k][vFld2.ValueMember].toString();
                    }

                    if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha4_key"]) && !Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha5_key"])) {
                        this.strValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha4_key"]), Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha5_key"]), DocumentType);
                        if (this.strValidationMessage != "")
                            break;
                    }
                }
            }
        }
        else if (this.ScreenObject.DocumentType == 72) {
            if (BaseService.SessionManager.Preferences.ContainsKey("AllowVacationifPayrollProcessedorLocked") && parseBoolean(BaseService.SessionManager.Preferences["AllowVacationifPayrollProcessedorLocked"] == "False")) {
                let vFld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld != undefined) {
                    if (vFld instanceof PactListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                }

                let fldAPV2: any = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha2");
                if (fldAPV2 != undefined && fldAPV2 instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV2.Date))
                    dtFromDate = fldAPV2.Date;
                fldAPV2 = this.ScreenObject._TextFields.find(a => a.DBColumnName.toLowerCase() == "dcalpha3");
                if (fldAPV2 != undefined && fldAPV2 instanceof PactExtraFieldDateData && !Util.IsEmpty(fldAPV2.Date))
                    dtToDate = fldAPV2.Date;

                this.strValidationMessage = this.IsDocLocked(sEmpID, dtFromDate, dtToDate, DocumentType);
            }
        }
        else if (this.ScreenObject.DocumentType == 56) {
            for (let k = 0; k < this.ScreenObject.GridData.length; k++) {
                let vFld: any = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
                if (vFld != undefined) {
                    if (vFld instanceof PactListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                    else if (vFld instanceof PactCodeNameListBoxData)
                        sEmpID = vFld.SelectedValue.toString();
                }

                if (!Util.IsEmpty(this.ScreenObject.GridData[k]["dcAlpha6_Key"])) {
                    this.strValidationMessage = this.IsDocLocked(sEmpID, Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha6_Key"]), Util.ParseDate(this.ScreenObject.GridData[k]["dcAlpha6_Key"]), DocumentType);
                    if (this.strValidationMessage != "")
                        break;
                }

            }
        }
        return this.strValidationMessage;
    }

    xldata: [][];
    file: File;
    arrayBuffer: any
    filelist: any
    ExcelData: any = [];
    ExcelDataColumn: any = [];
    OpenFile(e) {
        // const target:DataTransfer=<DataTransfer>(e.target);
        if (e.target.files.length !== 1) throw new Error("Cannot use multiple files");
        const reader = new FileReader();
        const file = e.target.files[0];
        reader.onload = (event) => {
            const data = reader.result;
            const bstr: any = reader.result;
            const wb: XLSX.WorkBook = XLSX.read(bstr, { type: 'binary' });
            const wsname: string = wb.SheetNames[0];
            const ws: XLSX.WorkSheet = wb.Sheets[wsname];
            this.ExcelData = XLSX.utils.sheet_to_json(ws, { header: 1 });
            this.ExcelTable = this.ExcelData;



            try {
                let dsexcel: any// = new DataSet();                      
                this.ActualFileName = e.target.value;  // fileDialog.SafeFileName;`
                this.DtImport.Clear();
                for (let i = 0; i < this.ExcelData[0].length; i++) {
                    let dr = this.DtImportObj.NewRow();
                    this.DtImportObj.addRow(dr);
                    dr["FieldName"] = this.ExcelData[0][i];
                    this.DtImportObj.updateRow(dr);
                }
                if (this.ExcelTable.length > 0) {
                    this.ExcelDataColumn = this.ExcelTable[0];
                    this.ExcelTable.splice(0, 1);
                }
                console.log(this.DtImport);
                console.log("DTImport");
                if (!Util.IsEmpty(this.ImportCols[1].DefaultValueText)) {
                    let xmlDoc = new XmlDocument();
                    xmlDoc.LoadXml(this.ImportCols[1].DefaultValueText);
                    if (xmlDoc != null) {
                        xmlDoc.DocumentElement.children[0].childNodes.forEach(XNode => {

                            for (let i = 0; i < this.DtImport.length; i++) {
                                //if ((i + 1).toString() == XNode.attributes.Item(0).value.toString())
                                //  this.DtImport[i]["FeatureFieldName"] = XNode.attributes.Item(2).value.toString();
                                if ((i + 1).toString() == XNode["0"].value.toString())
                                    this.DtImport[i]["FeatureFieldName"] = XNode["2"].value.toString();
                            }
                        });
                    }
                }
            }
            catch (error) {
                this.DisplayMessage = error.Message;
                return;
            }
        }
        reader.readAsBinaryString(file);

        //     this.file= e.target.files[0];
        //     let fileReader = new FileReader();
        //     fileReader.readAsArrayBuffer(this.file);
        //     fileReader.onload = (e) => {
        //         this.arrayBuffer = fileReader.result;
        //         var data = new Uint8Array(this.arrayBuffer);
        //         var arr = new Array();
        //         ;
        //         for(var i = 0; i != data.length; ++i) arr[i] = String.fromCharCode(data[i]);
        //         var bstr = arr.join("");
        //         var workbook = XLSX.read(bstr, {type:"binary"});
        //         var first_sheet_name = workbook.SheetNames[0];
        //         var worksheet = workbook.Sheets[first_sheet_name];
        //         
        //         var header =XLSX.utils.sheet_to_json(worksheet, { header: 1 })
        //         console.log(header[0]);
        //         console.log('asdasd');
        //         // I want to get top row only.
        //         console.log(XLSX.utils.decode_row('A1'));
        //         

        //         console.log(XLSX.utils.sheet_to_json(worksheet,{raw:true}));
        //           var arraylist = XLSX.utils.sheet_to_json(worksheet,{raw:true});
        //               this.filelist = [];
        //               console.log(this.filelist)


        //   }    
        // Microsoft.Win32.OpenFileDialog fileDialog = new Microsoft.Win32.OpenFileDialog();
        //             fileDialog.CheckFileExists = true;
        //             fileDialog.Filter = "Excel files (*.xls, *.xlsx)|*.xls;*.xlsx|All files (*.*)|*.*";
        //             if ((bool)fileDialog.ShowDialog())
        //             {
        //                 if (!Util.IsEmpty(ImportCols[1].DefaultValue) && fileDialog.SafeFileName != ImportCols[1].DefaultValue)
        //                 {
        //                     DisplayMessage = "File name mismatch, select file name (" + ImportCols[1].DefaultValue + ") ";

        //                     return;
        //                 }

        /**  try
          {
              let dsexcel: any// = new DataSet();                      
              this.ActualFileName =e.target.value;  // fileDialog.SafeFileName;`


              // setTimeout(() => {
              //     readXlsxFile(e.target.files[0],this.ImportCols).then((data) =>{   
              //         console.log("Hi"); 
              //         console.log(data);
              //         this.ExcelTable=data.rows;                        
              //       });
              // }, 1000);
            
              // string str = "Provider=Microsoft.ACE.OLEDB.12.0; Data Source=" + fileDialog.FileName.toString() + "; Extended Properties='Excel 12.0;HDR=YES;IMEX=1'";
              // string DBAdapterAccess = System.Configuration.ConfigurationManager.AppSettings["DBAdapterAccess"];
              // System.Data.OleDb.OleDbConnection oCon = new System.Data.OleDb.OleDbConnection(str);
              // oCon.Open();
              // System.Data.OleDb.OleDbDataAdapter da = new System.Data.OleDb.OleDbDataAdapter("SELECT * FROM [" + this.ActualFileName.split('.')[0] + "$]", oCon);
              // da.Fill(dsexcel);
             // this.ExcelTable = dsexcel.Tables[0];
              //oCon.Close();


              this.DtImport.Clear();
              for(let i = 0; i < this.ExcelDataColumn.length; i++)
              {
                  let dr = this.DtImportObj.NewRow();
                  dr[0] = this.ExcelDataColumn[i].ColumnName;
                  this.DtImportObj.addRow(dr);
              }

              if (!Util.IsEmpty(this.ImportCols[1].DefaultValueText))
              {
                  let xmlDoc = new XmlDocument();
                  xmlDoc.LoadXml(this.ImportCols[1].DefaultValueText);
                  if (xmlDoc != null)
                  {
                      xmlDoc.DocumentElement.children[0].childNodes.forEach(XNode => {
                         
                          for(let i = 0; i < this.DtImport.length; i++)
                          {
                              //if ((i + 1).toString() == XNode.attributes.Item(0).value.toString())
                                //  this.DtImport[i]["FeatureFieldName"] = XNode.attributes.Item(2).value.toString();
                                if ((i + 1).toString() ==  XNode["0"].value.toString())
                                this.DtImport[i]["FeatureFieldName"] =XNode["2"].value.toString();

                          }   
                      });
                     
                  }
              }
          }
          catch(error)
          {
              this.DisplayMessage = error.Message;                        
              return;
          }
          ***/
    }



    prepareLineItemsToForm() {
        this.leaveTab.Enable = false;
        this.leaveTab.Visible = false;

        this.displayLineItems = true

        if (this.DocumentType == 62) {

            this.displayAgGrid = false
            this.BodyVisible = false

            this.displayLineItems = false

            if (BaseService.IsMobile) {
                this.BodyVisible = false;
            }

            // this.displayLineItems = false

            this.ScreenObject.GridDataObj.refreshUI();

            this.leaveTab = new PactTabData();
            this.leaveTab.Enable = true;
            this.leaveTab.Visible = true;
            this.leaveTab.Header = "Details"
            this.leaveTab.Name = "Details"
            // this.leaveTab.Fields = Object.assign([], this.ScreenObject.LineItemFields)
            this.leaveTab.Fields = this.ScreenObject.LineItemFields



            this.assignedLeaves = this.leaveTab.Fields.filter(x => x.DBColumnName == 'dcAlpha2')[0] as PactTextBoxData
            this.availableLeaves = this.leaveTab.Fields.filter(x => x.DBColumnName == 'dcAlpha3')[0] as PactTextBoxData
            this.noOfDays = this.leaveTab.Fields.filter(x => x.DBColumnName == 'dcAlpha7')[0] as PactTextBoxData

            this.fromDate = this.leaveTab.Fields.filter(x => x.DBColumnName == 'dcAlpha4')[0] as PactDatePickerData
            this.toDate = this.leaveTab.Fields.filter(x => x.DBColumnName == 'dcAlpha5')[0] as PactDatePickerData
            this.session = this.leaveTab.Fields.filter(x => x.DBColumnName == 'dcAlpha6')[0] as PactComboBoxData
            this.session.Text = ''
            this.session.SelectedValue = ''

            this.leaveTab.Fields.forEach(element => {
                if (element instanceof PactListBoxData) {
                    let col = this.ScreenObject.ColumnSource.find(x => x.CostCenterID == element.CCID);
                    element.TypeID = col.TypeID;
                    element.CustomWhere = col.FilterCondition;
                    element.LocationID = col.LocationID;
                    element.DivisionId = col.DivisionID;
                    element.ExcludeFilter = col.ExcludeFilter;
                    element.onFocusCommand.Subscribe(this, "onLeaveEdit");
                    element.OnPactListBoxValueChanged.Subscribe(this, "onLineItemsChange");
                } else if (element instanceof PactDatePickerData || element instanceof PactDateTimeData || element instanceof PactExtraFieldDateData) {

                    element.SelectedDateChanged.Subscribe(this, "onLineItemsChange");

                } else if (element instanceof PactComboBoxData) {

                    element.SelectionChangedCommand.Subscribe(this, "onLineItemsChange");

                } else if (element instanceof PactTextBoxData) {

                    element.LostFocusCommand.Subscribe(this, "onLineItemsChange");

                }
            });


        }
    }

    onLeaveEdit() {
        if (this.ScreenObject.DocumentType == 62 && BaseService.SessionManager.IsEmpUser) {
            let strLeaveTypeWhere: string = "";
            let sEmpID: string = "";
            let vFld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
            if (vFld != undefined) {
                if (vFld instanceof PactListBoxData)
                    sEmpID = vFld.SelectedValue.toString();
                else if (vFld instanceof PactCodeNameListBoxData)
                    sEmpID = vFld.SelectedValue.toString();
            }
            else {
                if (this.leaveTab != null && this.leaveTab.Fields.find(x => x.DBColumnName.toLowerCase() == "dcccnid51")) {
                    let oControl = this.leaveTab.Fields.find(x => x.DBColumnName.toLowerCase() == "dcccnid51");
                    sEmpID = oControl.SelectedValue.toString()
                }
            }
            if (!Util.IsEmpty(sEmpID) && parseInt(sEmpID) > 0) {
                strLeaveTypeWhere = " ( a.ParentID=5 and Convert(Varchar,a.NodeId)  NOT IN (Select Isnull(TD.dcAlpha1,'0') From Com_DocTextData TD with(nolock),Inv_DocDetails ID with(nolock) Where ID.InvDocDetailsID=TD.InvDocDetailsID And ID.CostCenterID=40061)) ";
                strLeaveTypeWhere += " AND (a.NodeID in (Select ComponentID from Com_CC50054  with(nolock) where  GradeID=(SELECT TOP 1 CCNID53 FROM COM_CC50051 C51 WITH(NOLOCK) JOIN COM_CCCCData CCN WITH(NOLOCK) ON CCN.NodeID=C51.NodeID AND CCN.CostCenterID=50051 WHERE C51.NodeID IN(" + sEmpID + ")) AND Type=4 and ShowInESS='Yes' And Convert(Datetime,Payrolldate)=(Select Max(Convert(Datetime,Payrolldate)) from Com_CC50054 with(nolock) WHERE GradeID=(SELECT TOP 1 CCNID53 FROM COM_CC50051 C51 WITH(NOLOCK) JOIN COM_CCCCData CCN WITH(NOLOCK) ON CCN.NodeID=C51.NodeID AND CCN.CostCenterID=50051 WHERE C51.NodeID IN(" + sEmpID + "))))) ";

                if (this.leaveTab != null && this.leaveTab.Fields.find(x => x.DBColumnName.toLowerCase() == "dcccnid52")) {
                    let oControl = this.leaveTab.Fields.find(x => x.DBColumnName.toLowerCase() == "dcccnid52");
                    oControl.CustomWhere = strLeaveTypeWhere;
                }
            }
        }
    }

    //For Apply Leave removed body and added line items to this property
    leaveTab = new PactTabData();
    //For Getting regular day data for the session selection of grid
    LeaveData: any = [
    ];


    refresh(params: any): boolean {
        return false
    }

    onLineItemsChange(element: any, dr: any) {
        var isFromComponent = dr != null
        if (element instanceof PactTextBoxData && dr != null) {//For remarks and text fields to ignore dr variable
            isFromComponent = false;
        }
        var col = element

        if (!isFromComponent) {
            dr = this.ScreenObject.GridData[0]

            if (element instanceof PactListBoxData) {

                if (col.SelectedItem != null) {
                    dr[element.DBColumnName] = col.SelectedItem.Name
                    dr[element.DBColumnName + '_Key'] = col.SelectedItem.NodeID
                } else {
                    return
                }

            } else if (element instanceof PactDateTimeData) {

                if (element.DBColumnName == "dcAlpha4") {
                    if (this.toDate != null) {
                        if (this.fromDate.Date > this.toDate.Date)
                            this.toDate.Date = this.fromDate.Date
                    }
                }

                if (col.Date != null) {
                    if (isNaN(col.Date)) {
                        return
                    }
                    // if (col.Date.ToString(Util.IsEmpty(element.CustomFormat) ? element.CustomFormat : "HH:mm") == dr[element.DBColumnName] && !Util.IsEmpty(dr['dcAlpha7'])) {
                    //     return
                    // }
                    if (col.Date.ToString(Util.IsEmpty(element.CustomFormat) ? element.CustomFormat : "HH:mm") != dr[element.DBColumnName]) {
                        dr[element.DBColumnName] = col.Date.ToString(Util.IsEmpty(element.CustomFormat) ? element.CustomFormat : "HH:mm");
                        dr[element.DBColumnName + "_Key"] = col.Date;
                    }
                } else {
                    return
                }

            } else if (element instanceof PactDatePickerData || element instanceof PactExtraFieldDateData) {

                if (element.DBColumnName == "dcAlpha4") {
                    if (this.toDate != null) {
                        if (this.fromDate.Date > this.toDate.Date) {
                            this.toDate.Date = this.fromDate.Date
                            dr["dcAlpha5"] = this.toDate.Date.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                            dr["dcAlpha5_Key"] = this.toDate.Date
                        }
                    }
                }

                if (col.Date != null) {
                    if (isNaN(col.Date)) {
                        return
                    }
                    // if (col.Date.ToString(BaseService.SessionManager.Preferences["Date Format"]) == dr[element.DBColumnName] && !Util.IsEmpty(dr['dcAlpha7'])) {
                    //     return
                    // }
                    if (col.Date.ToString(BaseService.SessionManager.Preferences["Date Format"]) != dr[element.DBColumnName]) {
                        dr[element.DBColumnName] = col.Date.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        dr[element.DBColumnName + "_Key"] = col.Date;
                    }
                } else {
                    return
                }

            } else if (element instanceof PactComboBoxData) {

                dr[element.DBColumnName] = col._SelectedValue

            } else if (element instanceof PactTextBoxData) {

                dr[element.DBColumnName] = col.Text
                this.ScreenObject.GridDataObj.updateRow(this.ScreenObject.GridData[0]);
                return
            }
            this.ScreenObject.GridDataObj.updateRow(this.ScreenObject.GridData[0]);
        }

        if (!(element instanceof PactTextBoxData)) {
            if (this.ScreenObject.GridDataColumns.Contains(element.DBColumnName) && !Util.IsEmpty(dr[element.DBColumnName]))
                this.FillDefaultProd(dr, element.DBColumnName);

            this.Celleditend(dr, element.DBColumnName, element.CCID != undefined ? element.CCID : 0);
            if (this.DisplayMessage != "" && this.MessageVisibility) {
                this.onBindLeaveAssignDetails()
                return
            }
            this.ScreenObject.GridDataObj.updateRow(dr)
            this.PoleDisplayMessage(2, dr);
            this.CalculateTotals(dr, false, element.DBColumnName);

            if (!isFromComponent)
                this.onPrepareDatesGrid();
        }

        this.onBindLeaveAssignDetails()

    }

    onBindLeaveAssignDetails() {
        let lastRow = this.ScreenObject.GridData[this.ScreenObject.GridData.length - 1]
        if (lastRow['dcAlpha3'] == undefined && lastRow['dcAlpha2'] == undefined) {
            if (this.ScreenObject.GridData[this.ScreenObject.GridData.length - 2] != undefined) {
                lastRow = this.ScreenObject.GridData[this.ScreenObject.GridData.length - 2]
            }
        }
        if (lastRow != undefined) {
            this.assignedLeaves.Text = lastRow['dcAlpha2']
            this.availableLeaves.Text = lastRow['dcAlpha3']

            var callDateRefAPI = false;

            this.leaveTab.Fields.forEach(element => {
                if (element instanceof PactListBoxData) {

                    element.OnPactListBoxValueChanged = new Delegate();

                } else if (element instanceof PactDatePickerData || element instanceof PactDateTimeData || element instanceof PactExtraFieldDateData) {

                    element.SelectedDateChanged = new Delegate();

                } else if (element instanceof PactComboBoxData) {

                    element.SelectionChangedCommand = new Delegate();

                } else if (element instanceof PactTextBoxData) {

                    element.LostFocusCommand = new Delegate();

                }
            });

            this.leaveTab.Fields.forEach(oControl => {

                if (oControl instanceof PactTextBoxData) {
                    oControl.Text = Util.String(lastRow[oControl.DBColumnName]);
                }
                else if (oControl instanceof PactTextAreaData) {
                    oControl.Text = Util.String(lastRow[oControl.DBColumnName]);;
                }
                else if (oControl instanceof PactSelectionBoxData) {
                    oControl.Text = Util.String(lastRow[oControl.DBColumnName]);;
                }
                else if (oControl instanceof PactComboBoxData) {
                    oControl.SelectedValue = Util.String(lastRow[oControl.DBColumnName]);
                }/* Separate Date conditions because of IOS and other date parsing not working in IOS except this */
                else if (oControl instanceof PactDateTimeData) {
                    if (Util.isValidDate(lastRow[oControl.DBColumnName + "_Key"])) {
                        oControl.Date = Util.ParseDate(lastRow[oControl.DBColumnName + "_Key"].ToString("dd-MMM-yyyy"));
                    } else if (!Util.IsEmpty(lastRow[oControl.DBColumnName])) {
                        oControl.Date = Util.ParseDate(lastRow[oControl.DBColumnName + "_Key"].ToString("dd-MMM-yyyy"));
                        lastRow[oControl.DBColumnName + "_Key"] = oControl.Date
                    }
                    else
                        oControl.Date = null;
                }
                else if (oControl instanceof PactExtraFieldDateData) {
                    if ((oControl.DBColumnName == "dcAlpha4" || oControl.DBColumnName == "dcAlpha5") && oControl.Date == null) {
                        callDateRefAPI = true;
                    }
                    if (Util.isValidDate(lastRow[oControl.DBColumnName + "_Key"])) {

                        if (oControl.Date == null || oControl.Date.ToString(BaseService.SessionManager.Preferences["Date Format"]) != lastRow[oControl.DBColumnName]) {

                            oControl.Date = Util.ParseDate(lastRow[oControl.DBColumnName + "_Key"].ToString("dd-MMM-yyyy"));
                            lastRow[oControl.DBColumnName] = oControl.Date.ToString(BaseService.SessionManager.Preferences["Date Format"]);
                        }
                    }
                    else
                        oControl.Date = null;
                }
                else if (oControl instanceof PactDateTimeData) {
                    if (Util.isValidDate(lastRow[oControl.DBColumnName + "_Key"]))
                        oControl.Date = Util.ParseDate(lastRow[oControl.DBColumnName + "_Key"].ToString("dd-MMM-yyyy"));
                    else
                        oControl.Date = null;
                }
                else if (oControl instanceof PactDatePickerData) {
                    if ((oControl.DBColumnName == "dcAlpha4" || oControl.DBColumnName == "dcAlpha5") && oControl.Date == null) {
                        callDateRefAPI = true;
                    }
                    if (Util.isValidDate(lastRow[oControl.DBColumnName + "_Key"]))
                        oControl.Date = Util.ParseDate(lastRow[oControl.DBColumnName + "_Key"].ToString("dd-MMM-yyyy"));
                }

            });

            setTimeout(() => {
                this.leaveTab.Fields.forEach(element => {
                    if (element instanceof PactListBoxData) {

                        element.OnPactListBoxValueChanged.Subscribe(this, "onLineItemsChange");

                    } else if (element instanceof PactDatePickerData || element instanceof PactDateTimeData || element instanceof PactExtraFieldDateData) {

                        element.SelectedDateChanged.Subscribe(this, "onLineItemsChange");

                    } else if (element instanceof PactComboBoxData) {

                        element.SelectionChangedCommand.Subscribe(this, "onLineItemsChange");

                    } else if (element instanceof PactTextBoxData) {

                        element.LostFocusCommand.Subscribe(this, "onLineItemsChange");

                    }
                });
            }, 70);

            if (callDateRefAPI) {
                this.onLineItemsChange(this.toDate, null);
            }


        }
        let days = this.ScreenObject.GridData.reduce((sum, current) => sum + (current.dcAlpha7 != undefined ? parseFloat(current.dcAlpha7) : 0), 0)
        this.noOfDays.Text = isNaN(days) ? 0 : days

        if (this.DisplayMessage != '' && this.MessageVisibility) {
            return
        }
        let strValidationMsg = ""

        if (lastRow["dcAlpha7"] != null) {
            if (parseFloat(lastRow["dcAlpha7"]) <= 0)
                strValidationMsg = "Dates already applied | Selected dates between Holidays/Weeklyoffs" + "\r\n";
        }
        if (strValidationMsg != "") {
            this.MessageVisibility = true;
            this.DisplayMessage = strValidationMsg;

            return;
        }
        else {
            this.DisplayMessage = "";
            this.MessageVisibility = false;
        }
    }

    OnSesionGridDataChanged = new Delegate();

    assignedLeaves = new PactTextBoxData();
    availableLeaves = new PactTextBoxData();
    noOfDays = new PactTextBoxData();

    fromDate = new PactDatePickerData();
    toDate = new PactDatePickerData();
    session = new PactComboBoxData();

    displayAgGrid = false
    displayLineItems = false

    onPrepareDatesGrid() {

        if (this.fromDate.Date == null || this.toDate.Date == null) {
            return
        }

        if (this.session._SelectedValue == "Both" || this.session._SelectedValue == null || this.session._SelectedValue == "") {
            if (!BaseService.IsMobile) {
                this.BodyVisible = false
            }
            this.displayAgGrid = false;
            this.ScreenObject.GridDataObj.Table.forEach(dr => {
                if (dr['dcAlpha1'] != undefined) {
                    dr["dcAlpha6"] = 'Both';

                    this.Celleditend(dr, 'Name', 0);
                    this.ScreenObject.GridDataObj.updateRow(dr)
                    this.PoleDisplayMessage(2, dr);
                }
            });
            return
        }
        this.displayAgGrid = true;
        if (!BaseService.IsMobile) {
            this.BodyVisible = true
        }

        let SelectedEmpID = 0
        let DimLTfld = this.ScreenObject._CCFields.find(a => a.DBColumnName.toLowerCase() == "dcccnid51");
        if (DimLTfld && DimLTfld instanceof PactListBoxData && DimLTfld.SelectedValue > 0)
            SelectedEmpID = DimLTfld.SelectedValue;
        else if (DimLTfld && DimLTfld instanceof PactCodeNameListBoxData && DimLTfld.SelectedValue > 0)
            SelectedEmpID = DimLTfld.SelectedValue;

        let dtDetails: any = BaseService.mcommon.GetAttendanceDetails(this.fromDate.Date.ToString("dd/MMM/yyyy"), this.toDate.Date.ToString("dd/MMM/yyyy"), SelectedEmpID);

        this.LeaveData = [];

        for (let k = 0; k < dtDetails.length; k++) {
            let row = dtDetails[k]
            var model = { Date: row.AttDate, Type: row.AttendanceType, Morning: false, Afternoon: false, Full: true };
            this.LeaveData.push(model);
        }

        var lastRow = Object.assign({}, this.ScreenObject.GridDataObj.Table[0])
        this.ScreenObject.GridDataObj.Clear()

        this.LeaveData.forEach(element => {
            if (element.Type == 'Weekly Off' || element.Type == 'Holidays' || element.Type == 'OnLeave') {
                return
            }
            let dr = Object.assign({}, lastRow)

            let date = Util.ParseDate(element.Date.replaceAll('/', '-'))
            // let date = Util.ParseDate(element.Date.split('/')[1] + '/' + element.Date.split('/')[0] + '/' + element.Date.split('/')[2])
            let dateVal = date.ToString(BaseService.SessionManager.Preferences["Date Format"])

            element.FDate = dateVal

            if (this.ScreenObject.GridDataObj.Table.filter(x => x.dcAlpha4 == dateVal).length == 0) {
                dr['DocSeqNo'] = this.ScreenObject.GridDataObj.Table.length + 1
                dr['SNo'] = this.ScreenObject.GridDataObj.Table.length + 1
                dr['id'] = dr['SNo']

                dr["dcAlpha4"] = dateVal;
                dr["dcAlpha4" + "_Key"] = date;

                dr["dcAlpha5"] = dateVal;
                dr["dcAlpha5" + "_Key"] = date;

                dr["dcAlpha6"] = 'Both';
                this.ScreenObject.GridDataObj.addRow(dr)
                // this.Celleditend(dr, 'dcCCNID52', 50052);
                this.Celleditend(dr, 'Name', 0);
                this.ScreenObject.GridDataObj.updateRow(dr)
                this.PoleDisplayMessage(2, dr);
            }
        });

        this.OnSesionGridDataChanged.Call();
        // this.agGrid.api.setRowData(this.LeaveData)
        this.ScreenObject.GridDataObj.refreshDataView();
    }

    onEditLeaveData(ds: any, IsCopy: boolean) {
        this.leaveTab.Fields.forEach(element => {
            if (element instanceof PactListBoxData) {

                element.OnPactListBoxValueChanged = new Delegate();

            } else if (element instanceof PactDatePickerData || element instanceof PactDateTimeData || element instanceof PactExtraFieldDateData) {

                element.SelectedDateChanged = new Delegate();

            } else if (element instanceof PactComboBoxData) {

                element.SelectionChangedCommand = new Delegate();

            } else if (element instanceof PactTextBoxData) {

                element.LostFocusCommand = new Delegate();

            }
        });

        this.ScreenObject.LoadFieldsData(ds.Tables[0], this.ScreenObject.LineItemFields, IsCopy, ds.Columns[0]);
        this.ScreenObject.LoadFieldsData(ds.Tables[1], this.ScreenObject.LineItemFields, IsCopy, ds.Columns[1]);
        this.ScreenObject.LoadFieldsData(ds.Tables[3], this.ScreenObject.LineItemFields, IsCopy, ds.Columns[3]);
        if (this.toDate != null) {
            let txt = ds.Tables[3][ds.Tables[3].length - 1]['dcAlpha5']
            if (Util.isValidDate(txt)) {
                if (BaseService.IsMac) {//IOS Conversion issue
                    this.toDate.Date = Util.ParseDate(txt.replaceAll('/', '-'));
                } else {
                    this.toDate.Date = Util.ParseDate(txt);
                }
            }
        }

        this.onPrepareDatesGrid();

        setTimeout(() => {
            let isBothSession = true

            ds.Tables[3].forEach(element => {
                if (element['dcAlpha6'] != 'Both') {
                    isBothSession = false;
                }

                let item = this.LeaveData.filter(x => x.Date == element['dcAlpha4'])
                if (item.length != 0) {
                    if (element['dcAlpha6'] == 'Session1') {
                        item[0].Full = false;
                        item[0].Morning = true;
                        item[0].Afternoon = false;

                    } else if (element['dcAlpha6'] == 'Session2') {
                        item[0].Full = false;
                        item[0].Morning = false;
                        item[0].Afternoon = true;

                    } else {
                        item[0].Full = true;
                        item[0].Morning = false;
                        item[0].Afternoon = false;

                    }

                }

            });
            if (isBothSession) {
                this.displayAgGrid = false
                this.BodyVisible = false
            } else {
                this.displayAgGrid = true
                this.BodyVisible = true
            }
            this.OnSesionGridDataChanged.Call()

            // this.onBindLeaveAssignDetails()

            this.leaveTab.Fields.forEach(element => {
                if (element instanceof PactListBoxData) {

                    element.OnPactListBoxValueChanged.Subscribe(this, "onLineItemsChange");

                } else if (element instanceof PactDatePickerData || element instanceof PactDateTimeData || element instanceof PactExtraFieldDateData) {

                    element.SelectedDateChanged.Subscribe(this, "onLineItemsChange");

                } else if (element instanceof PactComboBoxData) {

                    element.SelectionChangedCommand.Subscribe(this, "onLineItemsChange");

                } else if (element instanceof PactTextBoxData) {

                    element.LostFocusCommand.Subscribe(this, "onLineItemsChange");

                }
            });

        }, 40);
    }

    EmpAccessibility(NodeId: any, CurrUserLat: any, CurrUserLong: any, ObjResponse): boolean {
        let ObjArray = [];
        let AccessAnyWhere: string = "";
        let MobileAccessRange: number = 0;
        let StrsysLat: string = "";
        let StrsysLong: string = "";
        let strCatSetType: string = "";
        let StrDimNodes: string = "";
        let strAllowChkinOut: string = "";
        let dsEmpCheck: any = null;
        console.log("EmpAccessibility Inside");
        try {
            ObjArray.push(BaseService.SessionManager.CompanyIndex);
            ObjArray.push(BaseService.SessionManager.iEmployee);
            dsEmpCheck = BaseService.empService.ExecuteQuery_SP(ObjArray, "spPAY_GetGeoLocation");
            if (!Util.IsEmpty(dsEmpCheck) && dsEmpCheck.Tables.length > 0) {
                if (dsEmpCheck.Tables[0].length > 0 && dsEmpCheck.Tables[1].length > 0) {
                    StrsysLat = Util.String(dsEmpCheck.Tables[0][0]["Latitude"]);
                    StrsysLong = Util.String(dsEmpCheck.Tables[0][0]["Longitude"]);
                    strAllowChkinOut = Util.String(dsEmpCheck.Tables[1][0]["CheckInOutDevice"]);
                    AccessAnyWhere = Util.String(dsEmpCheck.Tables[1][0]["AccessAnyWhere"]);
                    MobileAccessRange = parseInt(dsEmpCheck.Tables[1][0]["CheckInOutMobileRange"] || 250);
                    strCatSetType = Util.String(dsEmpCheck.Tables[1][0]["AttSetType"]);
                    StrDimNodes = Util.String(dsEmpCheck.Tables[1][0]["AttSetDimNodes"]);
                }
                else {
                    ObjResponse.Flag = "404";
                    ObjResponse.Msg = "No records found please contact your system administrator!";
                    console.log(ObjResponse.Msg);
                    return false;
                }
                //AccessAnyWhere
                if (AccessAnyWhere == "True") {
                    ObjResponse.Flag = "200";
                    ObjResponse.Msg = "Allowed";
                    return true;
                }
                let ApiRangeValue: any;
                if (strCatSetType == "Company") {

                    ApiRangeValue = Util.haversineDistance({ latitude: CurrUserLat, longitude: CurrUserLong },
                        { latitude: StrsysLat, longitude: StrsysLong });
                    console.log("ApiRangeValue KM  " + ApiRangeValue);
                    ApiRangeValue = ApiRangeValue * 1000;//Calculation In Meter
                    console.log("ApiRangeValue Meter only  " + ApiRangeValue);
                    console.log("strCatSetType  " + strCatSetType);
                    if ((MobileAccessRange > 0 && ApiRangeValue <= MobileAccessRange)) {
                        ObjResponse.Flag = "200";
                        ObjResponse.Msg = " Allowed";
                        console.log(ObjResponse.Msg);
                        return true;
                    }
                    else {
                        ObjResponse.Flag = "404";
                        ObjResponse.Msg = " Not Allow for this location to check-in/check-out, out of range";
                        console.log(ObjResponse.Msg);
                        return false;
                    }
                }
                else if (strCatSetType == "Dimension") {

                    console.log("strCatSetType" + strCatSetType)
                    if (StrDimNodes.length > 0) {
                        let arrNodes: any[] = StrDimNodes.split(',');
                        if (arrNodes.length > 0) {
                            let blnExists: boolean = false;
                            for (let index = 0; index < arrNodes.length; index++) {
                                const sglNode: number = arrNodes[index];
                                let strNodeLat: string;
                                let strNodeLon: string;
                                if (dsEmpCheck.Tables[0].length > 0) {
                                    let objLatlong = dsEmpCheck.Tables[0].find(x => x.NodeID == sglNode);
                                    strNodeLon = !Util.IsEmpty(objLatlong["Longitude"]) ? objLatlong["Longitude"] : 0.00000;
                                    strNodeLat = !Util.IsEmpty(objLatlong["Latitude"]) ? objLatlong["Latitude"] : 0.00000;
                                    console.log("CurrUserLat" + CurrUserLat + "CurrUserLong" + CurrUserLong);
                                    console.log("strNodeLat" + strNodeLat + "strNodeLon" + strNodeLon);
                                    ApiRangeValue = Util.haversineDistance({ latitude: CurrUserLat, longitude: CurrUserLong },
                                        { latitude: strNodeLat, longitude: strNodeLon });
                                    console.log("ApiRangeValue KM" + ApiRangeValue + "index" + index);
                                    ApiRangeValue = (ApiRangeValue * 1000);//Calculation In Meter
                                    console.log("ApiRangeValue Meter" + ApiRangeValue + "index" + index);
                                    if ((MobileAccessRange > 0 && ApiRangeValue <= MobileAccessRange)) {
                                        ObjResponse.Flag = "200";
                                        ObjResponse.Msg = " Allowed";
                                        blnExists = true;
                                        return false;
                                    }
                                }

                            }
                            if (blnExists) {
                                ObjResponse.Flag = "200";
                                ObjResponse.Msg = " Allowed";
                                return true;
                            }
                            else {
                                ObjResponse.Flag = "404";
                                ObjResponse.Msg = " You are not allowed to check-in/check-out, out of range from this location";
                                console.log(ObjResponse.Msg);
                                return false;
                            }
                        }
                    }
                    else {
                        ObjResponse.Flag = "500";
                        ObjResponse.Msg = " No location is assigned";
                        console.log(ObjResponse.Msg);
                        return false;
                    }
                }
            }
            else {
                ObjResponse.Flag = "404";
                ObjResponse.Msg = "No records found please contact your system administrator!";
                console.log(ObjResponse.Msg);
                return true;
            }

        }
        catch (error) {
            console.log("catch (error) " + error);
            console.log("Excetion EmpAccessibility" + error);


        }
        return false;
    }

    CalculateGroupPhaseDates(dr:any)
    {
        let minStartDate:Date = null;
        let maxEndDate:Date = null;

        let ccid:number = 0;
        let groupRow = null;
        if (BaseService.SessionManager.Preferences.ContainsKey("PMLevel1Dimension") && Util.IntTryParse(BaseService.SessionManager.Preferences["PMLevel1Dimension"]) > 0)
        {
            ccid =  Util.IntTryParse(BaseService.SessionManager.Preferences["PMLevel1Dimension"])
            this.ScreenObject.GridData.forEach(row =>
            {
                if (Util.String(row["ProductID_Key"]) != "" && Util.hasprop(row,"dcCCNID" + (ccid - 50000) + "_Key") && this.ScreenObject.GridDataObj.TableColumns.Contains("UserID_Key") && Util.String(row["UserID_Key"]) !="" && Util.String(row["dcCCNID" + (ccid - 50000) + "_Key"]) == Util.String(dr["dcCCNID" + (ccid - 50000) + "_Key"]))
                {
                    let UserID = parseInt(row["UserID_Key"]);

                    if (UserID == 1)
                    {
                        groupRow = row;
                    }
                    else
                    {
                        if (this.ScreenObject.GridDataObj.TableColumns.Contains("dcAlpha15_Key") && !Util.IsEmpty(row["dcAlpha15_Key"])   && this.ScreenObject.GridDataObj.TableColumns.Contains("dcAlpha16_Key") && !Util.IsEmpty(row["dcAlpha16_Key"]))
                        {
                            let StartDate:Date =new Date(row["dcAlpha15_Key"]);
                            let endDate:Date = new Date(row["dcAlpha16_Key"]);
                            if (!minStartDate || StartDate < minStartDate)
                            {
                                minStartDate = StartDate;
                            }
                            if (!maxEndDate || endDate > maxEndDate)
                            {
                                maxEndDate = endDate;
                            }
                        }
                    }
                }
            });
            if (groupRow != null)
            {
                if (minStartDate)
                {
                    groupRow["dcAlpha15"] = minStartDate.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm tt");
                    groupRow["dcAlpha15_Key"] = minStartDate;
                }

                if (maxEndDate)
                {
                    groupRow["dcAlpha16"] = maxEndDate.ToString(BaseService.SessionManager.Preferences["Date Format"] + " hh:mm tt");
                    groupRow["dcAlpha16_Key"] = maxEndDate;
                }
            }
        }
    }
    ProjDimsDic: Dictionary<string> = null;
    generateDynamicQuery(startDate: Date, endDate: Date, UserIds: string) {

        if (this.ProjDimsDic == null) {
            this.ProjDimsDic = new Dictionary<string>();
            if (BaseService.SessionManager.Preferences.ContainsKey("ProjPlanDim") && Util.IntTryParse(BaseService.SessionManager.Preferences["ProjPlanDim"]) > 0)
                this.ProjDimsDic.push("ProjPlanDim", BaseService.SessionManager.Preferences["ProjPlanDim"]);
            if (BaseService.SessionManager.Preferences.ContainsKey("PMLevel1Dimension") && Util.IntTryParse(BaseService.SessionManager.Preferences["PMLevel1Dimension"]) > 0)
                this.ProjDimsDic.push("PMLevel1Dimension", BaseService.SessionManager.Preferences["PMLevel1Dimension"]);
            if (BaseService.SessionManager.Preferences.ContainsKey("PMLevel2Dimension") && Util.IntTryParse(BaseService.SessionManager.Preferences["PMLevel2Dimension"]) > 0)
                this.ProjDimsDic.push("PMLevel2Dimension", BaseService.SessionManager.Preferences["PMLevel2Dimension"]);
            if (BaseService.SessionManager.Preferences.ContainsKey("PMLevel3Dimension") && Util.IntTryParse(BaseService.SessionManager.Preferences["PMLevel3Dimension"]) > 0)
                this.ProjDimsDic.push("PMLevel3Dimension", BaseService.SessionManager.Preferences["PMLevel3Dimension"]);
            if (BaseService.SessionManager.Preferences.ContainsKey("PMTaskDimension") && Util.IntTryParse(BaseService.SessionManager.Preferences["PMTaskDimension"]) > 0)
                this.ProjDimsDic.push("PMTaskDimension", BaseService.SessionManager.Preferences["PMTaskDimension"]);
        }


        let joinClause = `left join COM_DocCCData TDCC with(nolock) on INV.InvDocDetailsID=TDCC.InvDocDetailsID
        left join Adm_Users U With(NoLock) on U.UserID = TDCC.UserID
        left join COM_DocTextData T3 with(nolock) on INV.INVDOCDETAILSID=T3.INVDOCDETAILSID`;
        let selectClause = `SELECT U.UserName,U.UserID UserID,T3.dcAlpha1 as ProjectStartDate,T3.dcAlpha2 as ProjectEndDate,INV.InvDocDetailsID as TaskSeqID,T3.dcAlpha33 TaskHours ,T3.dcAlpha11 WBSID,T3.dcAlpha20 Status,T3.dcAlpha13 AssignedUsers,case when isdate(T3.dcAlpha16)=1 and isNumeric(T3.dcAlpha16)=0 then CONVERT(DATETIME,T3.dcAlpha16) else null end endDate,case when isdate(T3.dcAlpha15)=1 and isNumeric(T3.dcAlpha15)=0 then CONVERT(DATETIME,T3.dcAlpha15) else null end startDate, INV.VoucherNo VoucherNo,INV.VersionNo ,T3.dcAlpha12 ,T3.dcAlpha25 ProjectColor,INV.DocID DocID`;

        this.ProjDimsDic.keys.forEach((key, index) => {
            const dimension = parseInt(this.ProjDimsDic[key]);
            const dynamicTableName = this.ScreenObject.GetTableName(dimension);
            const tableAlias = `T${index + 5}`;
            joinClause += ` LEFT JOIN ${dynamicTableName} ${tableAlias} ON TDCC.dcCCNID${dimension - 50000} = ${tableAlias}.NodeID`

            if (key == "PMTaskDimension") {
                selectClause += ` , ${tableAlias}.Name as TaskName , ${tableAlias}.NodeID as TaskID`;
            }
            else if (key == "PMLevel1Dimension") {
                selectClause += ` , ${tableAlias}.Name as PhaseName , ${tableAlias}.NodeID as PhaseID`;
            }
            else if (key == "ProjPlanDim") {
                selectClause += ` ,${tableAlias}.Name as ProjectName , ${tableAlias}.NodeID as ProjectID , ${tableAlias}.StatusID ProjectStatus`;
            }
            else
                selectClause += ` , ${tableAlias}.Name as Name_L${index + 1} , ${tableAlias}.NodeID as ID_L${index + 1}`;
        });
        let query = selectClause + `
        FROM INV_DocDetails INV with(nolock) ` + joinClause + ` WHERE (INV.CostCenterID=40046) AND (CONVERT(DATETIME,T3.dcAlpha15) <= '` + endDate.ToString("dd/MMM/yyyy hh:mm:ss a") + `' AND CONVERT(DATETIME,T3.dcAlpha16) >= '` + startDate.ToString("dd/MMM/yyyy hh:mm:ss a") + `')  AND T3.dcAlpha20='Open' and T3.dcAlpha13 Is Not Null and TDCC.UserId In (${UserIds}) Order By INV.DocDate DESC `

        return query;
    }

    async validateTaskForUsers(startDate: Date, endDate: Date, Users: any[], standardHours: number, ActualHours: number, UserIds: string, IsNew: boolean = true) {
        let sQ = this.generateDynamicQuery(startDate, endDate, UserIds);
        let ds = await BaseService.common.GetDataSetQuery(sQ);

        const conflicts: { [key: number]: string } = {};

        Users.forEach((user) => {

            const userTasks = ds.Tables[0].filter(task => task.UserID === user.Value && (IsNew ? true : task.DocID != this.DocID));

            if (!IsNew) {
                let currentTasks = this.ScreenObject.GridData.filter(x => x["UserID_Key"] == user.Value);
                if (currentTasks.length > 0) {
                    userTasks.concat(currentTasks.map(x => { startDate: x["dcAlpha15_Key"]; endDate: x["dcAlpha16_Key"]; TaskHours: x["dcAlpha31"] }))
                }
            }
            const taskDays = this.getWorkingDays(startDate, endDate);

            const task = userTasks.find(existingTask =>
                this.getWorkingDays(existingTask.startDate, existingTask.endDate).some(day =>
                    taskDays.some(newDay => newDay.getTime() === day.getTime()) &&
                    this.isTimeOverlap(Util.convertTime12to24(new Date(existingTask.startDate).ToString("hh:mm a")), Util.convertTime12to24(new Date(existingTask.endDate).ToString("hh:mm a")), Util.convertTime12to24(startDate.ToString("hh:mm a")), Util.convertTime12to24(endDate.ToString("hh:mm a")))
                )
            );

            if (task) {
                conflicts[user.Value] = `Task already assigned to User ${user.Name} in this time slot. Document - ${task.ProjectName} : ${task.VoucherNo}`;
            }

            const totalHours = taskDays.reduce((sum, day) => {
                const dailyTasks = userTasks.filter(task =>
                    new Date(task.startDate) <= day &&
                    new Date(task.endDate) >= day &&
                    this.isWorkingDay(day)
                );
                const dailyHours = dailyTasks.reduce((daySum, task) => daySum + parseFloat(task.TaskHours), 0);
                return parseFloat(sum.toString()) + dailyHours;
            }, ActualHours);

            if (totalHours > parseFloat(standardHours.ToString())) {
                conflicts[user.Value] = `Standard hours exceeded for User ${user.Name} on working days within the selected date range.`;
            }
        });
        return conflicts; // No conflict
    }

    isTimeOverlap(start1: string, end1: string, start2: string, end2: string): boolean {
        const start1Time = this.convertToMinutes(start1);
        const end1Time = this.convertToMinutes(end1);
        const start2Time = this.convertToMinutes(start2);
        const end2Time = this.convertToMinutes(end2);
        return (start1Time < end2Time && start2Time < end1Time);
    }

    convertToMinutes(time: string): number {
        const [hours, minutes] = time.split(':').map(Number);
        return hours * 60 + minutes;
    }

    isWorkingDay(date: Date): boolean {
        const holidays = []//[new Date(2024, 10, 12), new Date(2024, 10, 13)]; // Example holidays
        const weeklyOffs = [];//[0, 6]; // Sunday and Saturday
        return !holidays.some(holiday => holiday.getTime() === date.getTime()) &&
            !weeklyOffs.includes(date.getDay());
    }

    getWorkingDays(start: Date, end: Date): Date[] {
        const workingDays: Date[] = [];
        const currentDate = new Date(start);

        while (currentDate <= new Date(end)) {
            if (this.isWorkingDay(currentDate)) {
                workingDays.push(new Date(currentDate));
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return workingDays;
    }
}

export class ShowActivityViewModel extends ViewModelBase {
    parent: AddEditDocumentViewModel
    get MxHt() {
        return (window.innerHeight - 200).toString();
    }


    get MxWidth() {
        return (window.innerWidth - 200).toString();
    }
    public constructor(par: AddEditDocumentViewModel) {
        super()
        this.parent = par;
    }
}
export interface Coordinates {
    latitude: number;
    longitude: number;
}
export class FailureMessage {
    Name: string = '';
    Message: string = '';

}
